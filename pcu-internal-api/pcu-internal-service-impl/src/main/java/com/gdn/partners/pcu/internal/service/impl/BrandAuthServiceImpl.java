package com.gdn.partners.pcu.internal.service.impl;import static com.gdn.common.base.GdnPreconditions.checkArgument;import java.util.ArrayList;import java.util.Arrays;import java.util.List;import java.util.Map;import java.util.Objects;import java.util.Set;import java.util.stream.Collectors;import com.gdn.mta.bulk.dto.BulkBrandAuthUploadModel;import com.gdn.mta.bulk.dto.product.constant.DomainEventName;import com.gdn.partners.pcu.internal.client.model.request.BrandAuthDeleteRequest;import com.gdn.partners.pcu.internal.model.Constants;import com.gdn.partners.pcu.internal.service.BPService;import com.gdn.partners.pcu.internal.service.FileStorageService;import com.gdn.partners.pcu.internal.service.impl.config.KafkaPublisher;import com.gdn.partners.pcu.internal.service.impl.util.BeanUtils;import com.gdn.partners.pcu.internal.client.model.request.BrandAuthFilterRequest;import com.gdn.partners.pcu.internal.client.model.response.BrandAuthFilterResponse;import com.gdn.x.businesspartner.dto.ProfileResponse;import com.gdn.x.businesspartner.v2.dto.businesspartner.BusinessPartnerFilterRequest;import org.apache.commons.collections.CollectionUtils;import org.apache.commons.lang3.StringUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.data.domain.Page;import org.springframework.data.domain.PageImpl;import org.springframework.data.domain.PageRequest;import org.springframework.stereotype.Service;import org.springframework.web.multipart.MultipartFile;import com.gdn.common.enums.ErrorCategory;import com.gdn.common.exception.ApplicationRuntimeException;import com.gdn.common.web.wrapper.response.GdnBaseRestResponse;import com.gdn.common.web.wrapper.response.GdnRestListResponse;import com.gdn.common.web.wrapper.response.GdnRestSingleResponse;import com.gdn.partners.core.exception.ApplicationException;import com.gdn.partners.pcu.internal.client.feign.PCBFeign;import com.gdn.partners.pcu.internal.model.ErrorMessages;import com.gdn.partners.pcu.internal.properties.SystemParameterProperties;import com.gdn.partners.pcu.internal.service.BrandAuthorisationService;import com.gdn.partners.pcu.internal.service.BusinessPartnerService;import com.gdn.partners.pcu.internal.service.impl.helper.RequestHelper;import com.gdn.partners.pcu.internal.service.impl.helper.ResponseHelper;import com.gdn.partners.pcu.internal.web.model.request.BrandAuthWebRequest;import com.gdn.partners.pcu.internal.web.model.response.BrandAuthCreateWebResponse;import com.gdn.partners.pcu.internal.web.model.response.BrandAuthFilterWebResponse;import com.gdn.partners.pcu.internal.web.model.response.BrandAuthorisationDetailWebResponse;import com.gdn.x.productcategorybase.ErrorMessage;import com.gdn.x.productcategorybase.dto.brand.BrandAuthCreateRequest;import com.gdn.x.productcategorybase.dto.brand.BrandAuthCreateResponse;import com.gdn.x.productcategorybase.dto.brand.BrandAuthHistoryRequest;import com.gdn.x.productcategorybase.dto.brand.BrandAuthHistoryResponse;import com.gdn.x.productcategorybase.dto.request.BrandAuthUpdateRequest;import com.gdn.x.productcategorybase.dto.response.BrandAuthorisationDetailResponse;import lombok.extern.slf4j.Slf4j;@Service@Slf4jpublic class BrandAuthServiceImpl implements BrandAuthorisationService {  @Autowired  private PCBFeign pcbFeign;  @Autowired  private BusinessPartnerService businessPartnerService;  @Autowired  private SystemParameterProperties systemParameterProperties;  @Autowired  private FileStorageService fileStorageService;  @Autowired  private KafkaPublisher kafkaProducer;  @Autowired  private BPService bpService;  private static final String SLASH_SEPARATOR = "/";  private static final String DASH = "-";  private static final String COMMA = ",";  private static final String DOT = ".";  @Override  public BrandAuthorisationDetailWebResponse getBrandAuthDetailBySellerCodeAndBrandCode(    String storeId, String sellerCode, String brandCode) throws Exception {    BrandAuthorisationDetailWebResponse webResponse = new BrandAuthorisationDetailWebResponse();    GdnRestSingleResponse<BrandAuthorisationDetailResponse> brandAuthorisationDetail =      pcbFeign.getBrandAuthorisationDetailByCode(storeId, sellerCode, brandCode);    ResponseHelper.validateResponse(brandAuthorisationDetail);    log.info("BrandAuthorisationDetail for Seller Code : {} was : {} ", sellerCode,      brandAuthorisationDetail.getValue());    String sellerName = businessPartnerService.getBusinessPartnerNameByCode(sellerCode);    if (Objects.nonNull(sellerName)) {      log.info("Seller Name fetch from BP was success for Seller : {} , name : {} ", sellerCode,        sellerName);      brandAuthorisationDetail.getValue().setSellerName(sellerName);    } else {      log.error("Seller Name fetch failed for Seller Code : {} ", sellerCode);      throw new ApplicationRuntimeException(ErrorCategory.DATA_NOT_FOUND);    }    BeanUtils.copyProperties(brandAuthorisationDetail.getValue(),webResponse);    return webResponse;  }  @Override  public void delete(String storeId, String username, List<BrandAuthDeleteRequest> brandAuthDeleteRequestList)      throws Exception {    try {      GdnBaseRestResponse response = pcbFeign.delete(storeId, username, brandAuthDeleteRequestList);      ResponseHelper.validateResponse(response);    } catch (ApplicationRuntimeException e) {      log.error("Error Encountered for Brand Auth delete request for brandAuthDeleteRequestList : {} , error :  ",          brandAuthDeleteRequestList.toString(), e);      throw e;    }  }  @Override  public Page<BrandAuthFilterWebResponse> getAuthorisations(BrandAuthWebRequest brandAuthWebRequest, int page, int size) {    BrandAuthFilterRequest filterRequest = new BrandAuthFilterRequest();    BeanUtils.copyProperties(brandAuthWebRequest, filterRequest);    GdnRestListResponse<BrandAuthFilterResponse> response = pcbFeign.getAuthorisations(filterRequest, page, size);    ResponseHelper.validateResponse(response);    Set<String> distinctBusinessPartnerCodes =      response.getContent().stream().map(BrandAuthFilterResponse::getSellerCode)        .filter(sellerCode -> sellerCode != null && !sellerCode.isEmpty())        .collect(Collectors.toSet());    BusinessPartnerFilterRequest businessPartnerFilterRequest = new BusinessPartnerFilterRequest();    businessPartnerFilterRequest.setBusinessPartnerCodes(distinctBusinessPartnerCodes);    Map<String, ProfileResponse> profileResponseMap =      bpService.getProfileResponseMap(new ArrayList<>(distinctBusinessPartnerCodes));    List<BrandAuthFilterWebResponse> brandAuthFilterWebResponses =        ResponseHelper.toBrandAuthFilterWebResponseList(response.getContent(), profileResponseMap,            brandAuthWebRequest.isBrandAuthorise());    return new PageImpl<>(brandAuthFilterWebResponses, PageRequest.of(page, size),        response.getPageMetaData().getTotalRecords());  }  @Override  public GdnRestListResponse<BrandAuthHistoryResponse> getBrandAuthHistory(String storeId,    String requestId, String username, BrandAuthHistoryRequest brandAuthHistoryRequest, int page,    int size) {    GdnRestListResponse<BrandAuthHistoryResponse> response = pcbFeign      .getBrandAuthHistory(storeId, requestId, username, brandAuthHistoryRequest, page, size);    ResponseHelper.validateResponse(response);    return response;  }  @Override  public void uploadBrandAuthDoc(String fileName, String brandCode, String sellerCode,    byte[] multipartFile) throws Exception {    validateImageType(fileName);    fileStorageService.uploadBrandAuthDoc(fileName, brandCode, sellerCode, multipartFile);  }  @Override  public void saveBulkBrandAuthFile(MultipartFile request, String processType, String requestId, String storeId,      String username) throws Exception {    String baseDirPath = fileStorageService.uploadFilePath(request, requestId, processType);    BulkBrandAuthUploadModel bulkBrandAuthUploadModel = RequestHelper.toBulkBrandAuthUploadModel(storeId,        new StringBuilder(baseDirPath).append(request.getOriginalFilename()).toString(), processType, requestId,        username);    kafkaProducer.send(DomainEventName.BULK_BRAND_AUTH_UPLOAD_EVENT, bulkBrandAuthUploadModel.getBulkProcessCode(),        bulkBrandAuthUploadModel);    log.info("event = {} got published having bulkProcessCode = {} bulkBrandAuthUploadModel = {} ",        DomainEventName.BULK_BRAND_AUTH_UPLOAD_EVENT, bulkBrandAuthUploadModel.getBulkProcessCode(),        bulkBrandAuthUploadModel);  }  public void validateImageType(String fileName) {    List<String> listOfValidExtensions = Arrays.asList(      systemParameterProperties.getBrandAuthDocTypes().split(Constants.COMMA_SEPARATOR));    if (!listOfValidExtensions.contains(fileName.substring(fileName.lastIndexOf(DOT)))) {      throw new ApplicationException(ErrorMessages.INVALID_EXTENSION + fileName);    }  }  @Override  public BrandAuthCreateWebResponse create(String storeId, String username, String requestId,    BrandAuthCreateRequest createRequest) {    BrandAuthCreateWebResponse response = new BrandAuthCreateWebResponse();    validateDocumentLinks(createRequest.getDocumentLinks(), createRequest.getSellerCode(),        createRequest.getBrandCode());    GdnRestSingleResponse<BrandAuthCreateResponse> brandAuthCreateResponse =      pcbFeign.createBrandAuthorisation(storeId, requestId, username, createRequest);    ResponseHelper.validateResponse(brandAuthCreateResponse);    log.info("New Brand Auth created for brand code : {} ",      brandAuthCreateResponse.getValue().getBrandCode());    BeanUtils.copyProperties(brandAuthCreateResponse.getValue(), response);    return response;  }  @Override  public void update(String storeId, String username, String requestId,      BrandAuthUpdateRequest request) {    validateDocumentLinks(request.getDocumentLinks(), request.getSellerCode(), request.getBrandCode());    GdnBaseRestResponse updateBrandAuthorisation =        pcbFeign.updateBrandAuthorisation(storeId, requestId, username, request);    ResponseHelper.validateResponse(updateBrandAuthorisation);  }  @Override  public void brandAuthDownloadAll(String username, BrandAuthWebRequest brandAuthWebRequest) {    kafkaProducer.send(DomainEventName.BULK_DOWNLOAD_ALL_EVENT, username,        RequestHelper.toBulkBrandAuthDownloadRequest(username, brandAuthWebRequest));  }  private void validateDocumentLinks(List<String> documents, String sellerCode, String brandCode) {    if (CollectionUtils.isNotEmpty(documents)) {      checkArgument(documents.stream().noneMatch(StringUtils::isEmpty),          ErrorMessage.FILE_NAME_SHOULD_NOT_BE_NULL_OR_EMPTY.getMessage());      validateAuthDocument(documents, brandCode, sellerCode);    }  }  private void validateAuthDocument(List<String> documentList, String brandCode,    String sellerCode) {    for (String fileName : documentList) {      fileStorageService.checkIfFileExisting(fileName, brandCode, sellerCode);    }  }}