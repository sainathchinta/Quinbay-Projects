package com.gdn.mta.product.service;

import static com.gdn.mta.product.util.GdnBaseLookup.INVENTORY_FULFILLMENT_BLIBLI;
import static com.gdn.mta.product.util.GdnBaseLookup.PRODUCT_TYPE_BOPIS;
import static com.gdn.mta.product.util.GdnBaseLookup.PRODUCT_TYPE_REGULAR;
import static com.gdn.partners.pbp.commons.constants.Constants.ACTIVE;
import static com.gdn.partners.pbp.commons.constants.Constants.CATEGORY_CODE;
import static com.gdn.partners.pbp.commons.constants.Constants.CM_MERCHANT;
import static com.gdn.partners.pbp.commons.constants.Constants.DEFAULT_STORE_ID;
import static com.gdn.partners.pbp.commons.constants.Constants.INACTIVE;
import static com.gdn.partners.pbp.commons.constants.Constants.MINIMUM_STOCK;
import static com.gdn.partners.pbp.commons.constants.Constants.PRODUCT_CODE;
import static com.gdn.partners.pbp.commons.constants.Constants.PRODUCT_NAME;
import static com.gdn.partners.pbp.commons.constants.Constants.SKU_CODE;
import static com.gdn.partners.pbp.commons.constants.Constants.UPC_CODE;
import static com.gdn.partners.pbp.commons.constants.Constants.URL_VIDEO_EDITED;
import static com.gdn.partners.pbp.commons.constants.Constants.WEB_CHANNEL_ID;
import static com.gdn.partners.pbp.commons.constants.SystemParameterConstants.CHECK_PRODUCT_FOR_REVIEW;
import static com.gdn.partners.pbp.commons.constants.SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE;
import static com.gdn.partners.product.pricing.model.PromoFieldNames.MERCHANT_CODE;
import static com.gdn.partners.product.pricing.model.PromoFieldNames.NAME;
import static com.gdn.partners.product.pricing.model.PromoFieldNames.PRODUCT_SKU;
import static com.gdn.partners.product.pricing.model.PromoFieldNames.PROMO_BUNDLING_CODE;
import static com.gdn.partners.product.pricing.model.PromoFieldNames.PROMO_BUNDLING_NAME;
import static com.gdn.partners.product.pricing.model.PromoFieldNames.PROMO_LISTING;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.catchThrowable;
import static org.mockito.ArgumentMatchers.anyInt;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyBoolean;
import static org.mockito.ArgumentMatchers.anyList;
import static org.mockito.ArgumentMatchers.anyMap;
import static org.mockito.ArgumentMatchers.anySet;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.doNothing;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.verifyNoMoreInteractions;
import static org.mockito.Mockito.when;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.UUID;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import com.gda.mta.product.dto.ItemImageUpdateRequestPCB;
import com.gda.mta.product.dto.NeedCorrectionProductActivationRequest;
import com.gda.mta.product.dto.ProductDetailEditDTO;

import com.gda.mta.product.dto.response.InProgressProductsBySizeChartCodeResponse;
import com.gdn.mta.product.entity.VideoAddEditRequest;
import com.gdn.mta.product.service.config.PreOrderConfig;
import com.gdn.partners.pbp.dao.UpdatePoDateByL3RequestDTO;
import com.gdn.x.productcategorybase.dto.VideoDTO;
import org.apache.commons.beanutils.BeanUtils;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.collections4.MapUtils;
import org.apache.commons.lang3.StringUtils;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.mockito.Captor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.MockitoAnnotations;
import org.mockito.verification.VerificationMode;
import org.slf4j.MDC;
import org.springframework.context.ApplicationContext;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.redis.core.BoundValueOperations;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.orm.ObjectOptimisticLockingFailureException;
import org.springframework.test.util.ReflectionTestUtils;

import com.gdn.mta.product.service.config.KafkaPublisher;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.gda.mta.product.dto.BulkDownloadProductLevel3Response;
import com.gda.mta.product.dto.CopyImageEditRequest;
import com.gda.mta.product.dto.DimensionRequest;
import com.gda.mta.product.dto.EditProductResponse;
import com.gda.mta.product.dto.EditedResizeAndImagesUpdateStatusResponse;
import com.gda.mta.product.dto.EditedResizeImagesResponse;
import com.gda.mta.product.dto.ItemImageEditRequest;
import com.gda.mta.product.dto.ItemNotesDto;
import com.gda.mta.product.dto.ItemPickupPointRequest;
import com.gda.mta.product.dto.ItemSkuPickupPointSyncStockDto;
import com.gda.mta.product.dto.PickupPointDeleteRequest;
import com.gda.mta.product.dto.PickupPointRequest;
import com.gda.mta.product.dto.PickupPointUpdateRequest;
import com.gda.mta.product.dto.PickupPointUpdateResponse;
import com.gda.mta.product.dto.PreOrderRequest;
import com.gda.mta.product.dto.ProductEditValidationDTO;
import com.gda.mta.product.dto.ProductImageEditRequest;
import com.gda.mta.product.dto.ProductItemLogisticsRequest;
import com.gda.mta.product.dto.ProductItemWholesalePriceRequest;
import com.gda.mta.product.dto.ProductItemsImageUpdateRequest;
import com.gda.mta.product.dto.ProductL3SummaryRequest;
import com.gda.mta.product.dto.ProductL3UpdateRequest;
import com.gda.mta.product.dto.ProductLevel3DTO;
import com.gda.mta.product.dto.ProductLevel3PriceRequest;
import com.gda.mta.product.dto.ProductLevel3QuickEditRequest;
import com.gda.mta.product.dto.ProductLevel3Request;
import com.gda.mta.product.dto.ProductLevel3SummaryDetailsImageRequest;
import com.gda.mta.product.dto.ProductLevel3UpdateRequest;
import com.gda.mta.product.dto.ProductLevel3ViewConfigRequest;
import com.gda.mta.product.dto.ProductLevel3ViewConfigStockRequest;
import com.gda.mta.product.dto.ProductPriceAndWholesaleRequest;
import com.gda.mta.product.dto.ProductPriceStockAndImagesRequest;
import com.gda.mta.product.dto.ProductVariantPriceStockAndImagesRequest;
import com.gda.mta.product.dto.ProductVariantUpdateRequest;
import com.gda.mta.product.dto.QuickEditRequest;
import com.gda.mta.product.dto.RestrictedKeywordsByField;
import com.gda.mta.product.dto.RestrictedKeywordsByFieldAndActionType;
import com.gda.mta.product.dto.SummaryFilterRequest;
import com.gda.mta.product.dto.SuspensionProductRequest;
import com.gda.mta.product.dto.UpdateItemsPriceStockImagesRequest;
import com.gda.mta.product.dto.UpdateProductLevel3InfoRequest;
import com.gda.mta.product.dto.VendorNotesRequest;
import com.gda.mta.product.dto.response.AgpSimpleQueryResponse;
import com.gda.mta.product.dto.response.AuditTrailListRequest;
import com.gda.mta.product.dto.response.CogsValueResponse;
import com.gda.mta.product.dto.response.HitsResponse;
import com.gda.mta.product.dto.response.InProgressProductsByPickupPointCodeResponse;
import com.gda.mta.product.dto.response.InternalProductHistoryEventModel;
import com.gda.mta.product.dto.response.ItemBulkArchiveResponse;
import com.gda.mta.product.dto.response.ItemsPriceStockImagesUpdateResponse;
import com.gda.mta.product.dto.response.ProductBusinessPartnerAndItemViewConfigDto;
import com.gda.mta.product.dto.response.ProductItemNameResponse;
import com.gda.mta.product.dto.response.ProductL3SummaryResponse;
import com.gda.mta.product.dto.response.ProductLevel3DetailResponse;
import com.gda.mta.product.dto.response.ProductSuspensionHistoryResponse;
import com.gda.mta.product.dto.response.SuspensionProductResponse;
import com.gda.mta.product.dto.response.VariantsErrorListResponse;
import com.gda.mta.product.dto.response.VendorNotesResponse;
import com.gdn.common.enums.ErrorCategory;
import com.gdn.common.exception.ApplicationException;
import com.gdn.common.exception.ApplicationRuntimeException;
import com.gdn.common.web.param.MandatoryRequestParam;
import com.gdn.common.web.wrapper.response.GdnRestListResponse;
import com.gdn.common.web.wrapper.response.GdnRestSingleResponse;
import com.gdn.common.web.wrapper.response.PageMetaData;
import com.gdn.micro.graphics.web.model.ImageRequest;
import com.gdn.mta.domain.event.config.DomainEventName;
import com.gdn.mta.domain.event.modal.AddEditedProductToPDTEvent;
import com.gdn.mta.domain.event.modal.AddProductToVendorCombinedEventModel;
import com.gdn.mta.domain.event.modal.EditedImageResizeEvent;
import com.gdn.mta.product.commons.constant.ProductLevel3InactiveSummaryCriteria;
import com.gdn.mta.product.commons.constant.ProductLevel3SummaryCriteria;
import com.gdn.mta.product.commons.constant.UpdateProductAccessChannel;
import com.gdn.mta.product.commons.constant.UpdateProductActivity;
import com.gdn.mta.product.config.ApplicationProperties;
import com.gdn.mta.product.entity.Cogs;
import com.gdn.mta.product.entity.PbpStockAlert;
import com.gdn.mta.product.entity.PickupPointCodeResponse;
import com.gdn.mta.product.entity.ProductBusinessPartner;
import com.gdn.mta.product.entity.ProductBusinessPartnerAttribute;
import com.gdn.mta.product.entity.ProductCollection;
import com.gdn.mta.product.entity.ProductImageQcProcessingResponse;
import com.gdn.mta.product.entity.ProductItemBusinessPartner;
import com.gdn.mta.product.entity.ProductItemLevel3;
import com.gdn.mta.product.entity.ProductItemWholesalePrice;
import com.gdn.mta.product.entity.ProductLevel3;
import com.gdn.mta.product.entity.ProductLevel3Attribute;
import com.gdn.mta.product.entity.ProductLevel3Image;
import com.gdn.mta.product.entity.ProductLevel3Logistics;
import com.gdn.mta.product.entity.ProductLevel3Order;
import com.gdn.mta.product.entity.ProductLevel3Price;
import com.gdn.mta.product.entity.ProductLevel3Summary;
import com.gdn.mta.product.entity.ProductLevel3SummaryDetails;
import com.gdn.mta.product.entity.ProductLevel3UpdateSummary;
import com.gdn.mta.product.entity.ProductLevel3ViewConfig;
import com.gdn.mta.product.entity.ProductSuspensionHistory;
import com.gdn.mta.product.entity.ProductSystemParameter;
import com.gdn.mta.product.entity.ProductWarehouse;
import com.gdn.mta.product.entity.UniquePickupPointCodeResponse;
import com.gdn.mta.product.enums.ApiErrorCode;
import com.gdn.mta.product.enums.AutoApprovalType;
import com.gdn.mta.product.enums.ProductLevel3Status;
import com.gdn.mta.product.enums.RestrictedKeywordActionType;
import com.gdn.mta.product.enums.SuspensionStatus;
import com.gdn.mta.product.repository.AttributeRepository;
import com.gdn.mta.product.repository.BusinessPartnerRepository;
import com.gdn.mta.product.repository.CategoryRepository;
import com.gdn.mta.product.repository.PickupPointRepository;
import com.gdn.mta.product.repository.ProductBusinessPartnerRepository;
import com.gdn.mta.product.repository.ProductCollectionRepository;
import com.gdn.mta.product.repository.ProductItemBusinessPartnerRepository;
import com.gdn.mta.product.repository.ProductItemWholesalePriceRepository;
import com.gdn.mta.product.repository.ProductLevel3Repository;
import com.gdn.mta.product.repository.ProductRepository;
import com.gdn.mta.product.repository.ProductStockAlertRepository;
import com.gdn.mta.product.repository.ProductSuspensionHistoryRepository;
import com.gdn.mta.product.repository.SolrActiveProductCollectionRepository;
import com.gdn.mta.product.service.config.KafkaTopicProperties;
import com.gdn.mta.product.service.converter.UpdateProductItemLevel3ModelConverter;
import com.gdn.mta.product.service.exception.ApiIncorrectInputDataException;
import com.gdn.mta.product.service.exception.ProductInNeedCorrectionException;
import com.gdn.mta.product.service.exception.ProductInReviewException;
import com.gdn.mta.product.service.exception.ProductRejectedException;
import com.gdn.mta.product.service.generator.GeneratorService;
import com.gdn.mta.product.service.solr.SolrActiveProductCollectionServiceBean;
import com.gdn.mta.product.service.util.MapperUtil;
import com.gdn.mta.product.service.util.WholesaleValidationUtil;
import com.gdn.mta.product.util.GdnBaseLookup;
import com.gdn.mta.product.util.GdnMandatoryRequestParameterUtil;
import com.gdn.mta.product.valueobject.EstimateItemPriceDTO;
import com.gdn.mta.product.valueobject.ProductLevel3SummaryFilter;
import com.gdn.mta.product.valueobject.ProductLevel3SummaryFilterDetails;
import com.gdn.mta.product.valueobject.SimpleMasterProductUpdateRequestDTO;
import com.gdn.mta.product.valueobject.SortOrder;
import com.gdn.mta.product.valueobject.UpdateProductItemLevel3Model;
import com.gdn.partners.pbp.calendar.CalendarService;
import com.gdn.partners.pbp.commons.constants.Constants;
import com.gdn.partners.pbp.commons.constants.EditedReviewTypeConstants;
import com.gdn.partners.pbp.commons.constants.SystemParameterConstants;
import com.gdn.partners.pbp.distributiontask.PredefinedAttributeAllowedValueServiceBean;
import com.gdn.partners.pbp.dto.offlineitem.UpsertOfflineItemFailedResponse;
import com.gdn.partners.pbp.dto.productlevel3.CountProductLevel3InactiveResponse;
import com.gdn.partners.pbp.dto.productlevel3.ProductItemWholesalePriceResponse;
import com.gdn.partners.pbp.dto.productlevel3.SuspensionItemResponse;
import com.gdn.partners.pbp.entity.mailEvent.ProductMailEventsEnum;
import com.gdn.partners.pbp.entity.productlevel3.ProductLevel3Aggregator;
import com.gdn.partners.pbp.entity.productlevel3.ProductLevel3Aggregator.ProductLevel3AggregatorState;
import com.gdn.partners.pbp.model.offlineitem.UpsertOfflineItem;
import com.gdn.partners.pbp.model.productlevel3.ProductLevel3Inventory;
import com.gdn.partners.pbp.outbound.AGPQuery.AGPQueryFeign;
import com.gdn.partners.pbp.outbound.campaign.CampaignOutbound;
import com.gdn.partners.pbp.outbound.inventory.InventoryOutbound;
import com.gdn.partners.pbp.outbound.pickuppoint.PickupPointOutbound;
import com.gdn.partners.pbp.outbound.product.ProductOutbound;
import com.gdn.partners.pbp.outbound.product.feign.PCBFeign;
import com.gdn.partners.pbp.outbound.productAnalytics.ProductAnalyticsOutbound;
import com.gdn.partners.pbp.outbound.productPricing.ProductPricingOutbound;
import com.gdn.partners.pbp.outbound.sap.SapOutbound;
import com.gdn.partners.pbp.outbound.xProduct.XProductOutbound;
import com.gdn.partners.pbp.service.notification.ProductNotificationService;
import com.gdn.partners.pbp.service.productlevel3.BulkProductLevel3AggregatorServiceBean;
import com.gdn.partners.pbp.service.productlevel3.ProductItemWholesalePriceService;
import com.gdn.partners.pbp.service.productlevel3.ProductLevel3AggregatorService;
import com.gdn.partners.pbp.service.productlevel3.ProductLevel3AggregatorServiceOld;
import com.gdn.partners.pbp.service.productlevel3.ProductLevel3Converter;
import com.gdn.partners.pbp.service.productlevel3.ProductLevel3Helper;
import com.gdn.partners.pbp.service.productlevel3.ProductLevel3InventoryService;
import com.gdn.partners.pbp.service.productlevel3.ProductLevel3LogisticsService;
import com.gdn.partners.pbp.service.sysparam.SystemParameterService;
import com.gdn.partners.product.analytics.web.model.SellerDetailResponse;
import com.gdn.partners.product.pricing.model.enums.PromoBundlingStatus;
import com.gdn.partners.product.pricing.model.enums.PromoBundlingType;
import com.gdn.partners.product.pricing.web.model.dto.ItemInfoDto;
import com.gdn.partners.product.pricing.web.model.dto.WholeSalePriceSkuStatusDto;
import com.gdn.partners.pbp.dto.promo.request.PromoBundlingPricingSummaryRequest;
import com.gdn.partners.product.pricing.web.model.promo.bundling.response.PromoBundlingSummaryResponse;
import com.gdn.partners.product.pricing.web.model.request.WholesalePriceRequest;
import com.gdn.partners.product.pricing.web.model.response.BulkActivateDeactivateResponse;
import com.gdn.partners.product.pricing.web.model.response.WholesalePriceBulkUpdateResponse;
import com.gdn.partners.product.pricing.web.model.response.WholesalePriceSkuResponse;
import com.gdn.x.businesspartner.commons.enums.MerchantStatus;
import com.gdn.x.businesspartner.dto.CompanyDTO;
import com.gdn.x.businesspartner.dto.GeolocationDTO;
import com.gdn.x.businesspartner.dto.PickupPointDTO;
import com.gdn.x.businesspartner.dto.PickupPointResponse;
import com.gdn.x.businesspartner.dto.ProfileResponse;
import com.gdn.x.businesspartner.v2.dto.pickuppoint.PickupPointFilterRequest;
import com.gdn.x.campaign.rest.web.model.dto.UpdateDiscountDTO;
import com.gdn.x.campaign.rest.web.model.request.CampaignPriceRequest;
import com.gdn.x.campaign.rest.web.model.request.CampaignPriceSkuRequest;
import com.gdn.x.campaign.rest.web.model.request.CampaignUpdateDiscountRequest;
import com.gdn.x.campaign.rest.web.model.response.CampaignPriceResponse;
import com.gdn.x.campaign.rest.web.model.response.CampaignPriceSkuResponse;
import com.gdn.x.campaign.rest.web.model.response.CampaignUpdateDiscountResponse;
import com.gdn.x.inventory.v2.rest.web.model.transaction.request.ListRequestDTO;
import com.gdn.x.inventory.v2.rest.web.model.transaction.request.WebInventoryDeleteByWebItemSkuAndPickupPointCodeDTO;
import com.gdn.x.inventory.v2.rest.web.model.transaction.request.WebInventoryUpdatePickupPointRequestDTO;
import com.gdn.x.inventory.v2.rest.web.model.transaction.response.WebInventoryBulkUpdatePickupPointCodeResponseDTO;
import com.gdn.x.inventory.v2.rest.web.model.transaction.response.WebInventoryUpdatePickupPointResponseDTO;
import com.gdn.x.product.domain.event.config.ProductDomainEventName;
import com.gdn.x.product.enums.ChannelName;
import com.gdn.x.product.enums.MasterDataAttributeType;
import com.gdn.x.product.enums.ProductType;
import com.gdn.x.product.enums.SolrConstants;
import com.gdn.x.product.model.entity.ItemViewConfig;
import com.gdn.x.product.model.vo.B2bFieldsVo;
import com.gdn.x.product.rest.web.model.ActivateNeedRevisionResponse;
import com.gdn.x.product.rest.web.model.dto.CategoryDTO;
import com.gdn.x.product.rest.web.model.dto.DiscountPriceDTO;
import com.gdn.x.product.rest.web.model.dto.ItemBuyableScheduleDTO;
import com.gdn.x.product.rest.web.model.dto.ItemCatalogDTO;
import com.gdn.x.product.rest.web.model.dto.ItemDiscoverableScheduleDTO;
import com.gdn.x.product.rest.web.model.dto.ItemSummaryResponse;
import com.gdn.x.product.rest.web.model.dto.ItemViewConfigDTO;
import com.gdn.x.product.rest.web.model.dto.MasterCatalogDTO;
import com.gdn.x.product.rest.web.model.dto.MasterDataAttributeDTO;
import com.gdn.x.product.rest.web.model.dto.MasterDataItemAttributeValueDTO;
import com.gdn.x.product.rest.web.model.dto.MasterDataItemDTO;
import com.gdn.x.product.rest.web.model.dto.MasterDataItemImageDTO;
import com.gdn.x.product.rest.web.model.dto.MasterDataProductAttributeDTO;
import com.gdn.x.product.rest.web.model.dto.MasterDataProductAttributeValueDTO;
import com.gdn.x.product.rest.web.model.dto.MasterDataProductDTO;
import com.gdn.x.product.rest.web.model.dto.MasterDataProductImageDTO;
import com.gdn.x.product.rest.web.model.dto.PreOrderDTO;
import com.gdn.x.product.rest.web.model.dto.PriceDTO;
import com.gdn.x.product.rest.web.model.dto.PristineDataItemDto;
import com.gdn.x.product.rest.web.model.dto.ProductAttributeDTO;
import com.gdn.x.product.rest.web.model.dto.ProductAttributeDetailDTO;
import com.gdn.x.product.rest.web.model.dto.ProductSpecialAttributeDTO;
import com.gdn.x.product.rest.web.model.dto.SalesCatalogDTO;
import com.gdn.x.product.rest.web.model.dto.SalesCategorySequenceDTO;
import com.gdn.x.product.rest.web.model.request.ItemRequest;
import com.gdn.x.product.rest.web.model.request.ItemRequestV2;
import com.gdn.x.product.rest.web.model.request.ItemSummaryRequest;
import com.gdn.x.product.rest.web.model.request.ItemViewConfigAndItemSkuRequest;
import com.gdn.x.product.rest.web.model.request.ItemViewConfigRequest;
import com.gdn.x.product.rest.web.model.request.ItemsSummaryDetailRequest;
import com.gdn.x.product.rest.web.model.request.PriceRequest;
import com.gdn.x.product.rest.web.model.request.ProductAndItemActivationRequest;
import com.gdn.x.product.rest.web.model.request.ProductAndItemsRequest;
import com.gdn.x.product.rest.web.model.request.ProductEditRequest;
import com.gdn.x.product.rest.web.model.request.ProductRequest;
import com.gdn.x.product.rest.web.model.request.ProductSkuSummaryRequest;
import com.gdn.x.product.rest.web.model.request.QuickEditUpdateRequest;
import com.gdn.x.product.rest.web.model.request.SimpleListStringRequest;
import com.gdn.x.product.rest.web.model.request.UpdateItemSummaryRequest;
import com.gdn.x.product.rest.web.model.response.ActiveProductResponse;
import com.gdn.x.product.rest.web.model.response.AddProductAndItemsResponse;
import com.gdn.x.product.rest.web.model.response.BundleItemResponse;
import com.gdn.x.product.rest.web.model.response.ItemBasicDetailV2Response;
import com.gdn.x.product.rest.web.model.response.ItemLevel5Response;
import com.gdn.x.product.rest.web.model.response.ItemPickupPointCodeResponse;
import com.gdn.x.product.rest.web.model.response.ItemPickupPointListingResponse;
import com.gdn.x.product.rest.web.model.response.ItemPriceResponse;
import com.gdn.x.product.rest.web.model.response.ItemResponse;
import com.gdn.x.product.rest.web.model.response.ItemResponseV2;
import com.gdn.x.product.rest.web.model.response.ItemSummaryDetailResponse;
import com.gdn.x.product.rest.web.model.response.PickupPointDetailResponse;
import com.gdn.x.product.rest.web.model.response.PriceResponse;
import com.gdn.x.product.rest.web.model.response.ProductAndItemsResponse;
import com.gdn.x.product.rest.web.model.response.ProductL3Response;
import com.gdn.x.product.rest.web.model.response.ProductResponse;
import com.gdn.x.product.rest.web.model.response.ProductScoreResponse;
import com.gdn.x.product.rest.web.model.response.ProductSkuSummaryResponse;
import com.gdn.x.product.rest.web.model.response.SimpleBooleanResponse;
import com.gdn.x.product.rest.web.model.response.SimpleMapStringResponse;
import com.gdn.x.product.rest.web.model.response.ViewConfigResponse;
import com.gdn.x.productcategorybase.AttributeType;
import com.gdn.x.productcategorybase.dto.CatalogType;
import com.gdn.x.productcategorybase.dto.ConfigurationStatusRequest;
import com.gdn.x.productcategorybase.dto.ConfigurationStatusResponse;
import com.gdn.x.productcategorybase.dto.Image;
import com.gdn.x.productcategorybase.dto.LocationPathAndCommonImage;
import com.gdn.x.productcategorybase.dto.allowedvalue.AllowedAttributeValueRequest;
import com.gdn.x.productcategorybase.dto.allowedvalue.AllowedValueResponse;
import com.gdn.x.productcategorybase.dto.request.CategoryCodeRequest;
import com.gdn.x.productcategorybase.dto.request.ProductItemImageUpdateRequest;
import com.gdn.x.productcategorybase.dto.request.SkuCodesRequest;
import com.gdn.x.productcategorybase.dto.response.AllowedAttributeValueResponse;
import com.gdn.x.productcategorybase.dto.response.AttributeResponse;
import com.gdn.x.productcategorybase.dto.response.CatalogResponse;
import com.gdn.x.productcategorybase.dto.response.CategoryAttributeResponse;
import com.gdn.x.productcategorybase.dto.response.CategoryDetailResponse;
import com.gdn.x.productcategorybase.dto.response.CategoryHierarchyResponse;
import com.gdn.x.productcategorybase.dto.response.CategoryResponse;
import com.gdn.x.productcategorybase.dto.response.CategoryRestrictedKeywordResponse;
import com.gdn.x.productcategorybase.dto.response.MinWholesaleDiscountResponse;
import com.gdn.x.productcategorybase.dto.response.PredefinedAllowedAttributeValueResponse;
import com.gdn.x.productcategorybase.dto.response.ProductAttributeResponse;
import com.gdn.x.productcategorybase.dto.response.ProductAttributeValueResponse;
import com.gdn.x.productcategorybase.dto.response.ProductCategoryResponse;
import com.gdn.x.productcategorybase.dto.response.ProductDetailResponse;
import com.gdn.x.productcategorybase.dto.response.ProductItemResponse;
import com.gdn.x.productcategorybase.dto.response.SimpleMasterProductUpdateResponse;
import com.gdn.x.productcategorybase.dto.response.SingleObjectResponse;
import com.gdn.x.productcategorybase.dto.response.WholesaleConfigResponse;
import com.gdn.x.productcategorybase.dto.response.WholesaleMappingResponse;
import com.gdn.x.productcategorybase.entity.Attribute;
import com.gdn.x.productcategorybase.entity.Category;
import com.gdn.x.productcategorybase.entity.PredefinedAllowedAttributeValue;
import com.gdn.x.productcategorybase.entity.Product;
import com.gdn.x.productcategorybase.entity.ProductAttribute;
import com.gdn.x.productcategorybase.entity.ProductAttributeValue;
import com.gdn.x.productcategorybase.entity.ProductCategory;
import com.gdn.x.productcategorybase.entity.ProductImage;
import com.gdn.x.productcategorybase.entity.ProductItem;
import com.gdn.x.productcategorybase.entity.ProductItemImage;
import com.google.common.collect.ImmutableMap;

@SuppressWarnings("deprecation")
public class ProductLevel3ServiceBeanTest {

  private static final String DEFAULT_GDN_SKU = "BLI-00001-00001-00001";
  private static final String DEFAULT_GDN_SKU_2 = "BLI-00001-00001-00002";
  private static final String DEFAULT_GDN_SKU_4 = "BLI-00001-00001-00004";
  private static final String DEFAULT_SKU_CODE = "MTA-0000001-00001";
  private static final String DEFAULT_SKU_CODE_2 = "MTA-000000F1-00002";
  private static final String DEFAULT_SKU_CODE_3 = "MTA-0000001-00003";
  private static final String DEFAULT_PRODUCT_CODE = "MTA-0000001";
  private static final String DEFAULT_SETTLEMENT_TYPE = "REGULAR";
  private static final String DEFAULT_CATENTRY_ID = "10000001";
  private static final String DEFAULT_CATEGORY_CODE = "CAT-0000001";
  private static final String DEFAULT_PRODUCT_SKU = "BLI-00001-00001";
  private static final String DEFAULT_PRODUCT_SKU_2 = "BLI-00001-00002";
  private static final String PRODUCT_ITEM_ID = "PRODUCT_ITEM_ID";
  private static final String DEFAULT_MERCHANT_SKU = "MSKU-00001";
  private static final String DEFAULT_MERCHANT_SKU_2 = "MSKU-00002";
  private static final String DEFAULT_MERCHANT_SKU_3 = "MSKU-00003";
  private static final String DEFAULT_CATENTRYITEM_ID = "100000001";

  private static final String DEFAULT_PICKUP_POINT_CODE = "PP-0000001";
  private static final String PICKUP_POINT_CODE = "pickupPo[intCode";
  private static final String PICKUP_POINT_CODE_2 = "pickupPointCode2";
  private static final String PRISTINE_ID = "PRI-009050-00";
  private static final String ITEM_SKU = "TOT-15014-0001-0001";
  private static final String ITEM_SKU_1 = "TOT-15014-0001-0001";
  private static final String ITEM_SKU_2 = "TOT-15014-0001-0001";
  private static final String ITEM_SKU_3 = "TOT-15014-0001-0003";
  private static final String DEFAULT_REQUEST_ID = UUID.randomUUID().toString();
  private static final String DEFAULT_REQUEST_ID_1 = "DEFAULT_REQUEST_ID";
  private static final String DEFAULT_USER_NAME = "username";
  private static final VerificationMode NEVER_CALLED = Mockito.times(0);
  private static final Pageable pageable = PageRequest.of(0, 10);
  private static final Pageable DEFAULT_PAGEABLE = PageRequest.of(0, 10);
  private static final PageRequest DEFAULT_PAGE_REQUEST = PageRequest.of(0, 10);
  private static final String DEFAULT_ATTRIBUTE_ID = UUID.randomUUID().toString();
  private static final String DEFAULT_ATTRIBUTE_CODE = "AT-0000001";
  private static final String DEFAULT_ATTRIBUTE_CODE_2 = "AT-0000002";
  private static final String DEFAULT_ATTRIBUTE_CODE_3 = "AT-0000003";
  private static final String DEFAULT_ATTRIBUTE_CODE_4 = "AT-0000004";
  private static final String DEFAULT_ATTRIBUTE_CODE_5 = "AT-0000005";
  private static final String DEFAULT_ATTRIBUTE_CODE_6 = "AT-0000006";
  private static final String DEFAULT_ATTRIBUTE_NAME = "Attribute Name";
  private static final String DEFAULT_PRODUCT_NAME = "TEST";
  private static final Integer DEFAULT_PRODUCT_TYPE = 1;
  private static final String DEFAULT_CATEGORY_NAME = "TEST";
  private static final String DEFAULT_CATEGORY_HIERARCHY = "TEST";
  private static final String DEFAULT_BRAND = "TEST";
  private static final String DEFAULT_DESCRIPTION = "TEST";
  private static final String DEFAULT_REASON = "TEST_REASON";
  private static final String DEFAULT_INTERNAL_REASON = "Internal mistake";
  private static final String DEFAULT_SPECIFICATION = "TEST";
  private static final String DEFAULT_UNIQUE_SELLING_POINT = "TEST";
  private static final String DEFAULT_PRODUCT_STORY = "TEST";
  private static final String DEFAULT_ATTRIBUTE_TYPE =
    MasterDataAttributeType.DEFINING_ATTRIBUTE.name();
  private static final String DEFAULT_ITEM_SKU = "SKU-1000";
  private static final String DEFAULT_UPC_CODE = "UPC-1000";
  private static final String DEFAULT_UPC_CODE_1 = "UPC-1000-1";
  private static final String DEFAULT_ITEM_NAME = "TEST";
  private static final Double DEFAULT_LENGTH = 10.0;
  private static final Double DEFAULT_WIDTH = 10.0;
  private static final Double DEFAULT_HEIGHT = 10.0;
  private static final Double DEFAULT_WEIGHT = 10.0;
  private static final Double DEFAULT_SHIPPING_WEIGHT = 10.0;
  private static final Integer DEFAULT_DANGEROUS_LEVEL = 1;
  private static final Boolean DEFAULT_LATE_FULLFILLMENT = true;
  private static final String DEFAULT_PICKUP_POINT_NAME = "TEST";
  private static final Integer STOCK_AVAILABLE_0 = 0;
  private static final Integer STOCK_AVAILABLE_1 = 10;
  private static final Integer STOCK_RESERVED_1 = 10;
  private static final Integer STOCK_AVAILABLE_2 = 10;
  private static final Integer STOCK_RESERVED_2 = 10;
  private static final Integer MIN_STOCK = 5;
  private static final Boolean DEFAULT_SYNCHRONIZE = false;
  private static final String DEFAULT_CHANNEL_ID = "TEST";
  private static final Double DEFAULT_PRICE = 100000.0;
  private static final Double DEFAULT_SALE_PRICE = 100000.0;
  private static final Double DEFAULT_DISCOUNT = 10.0;
  private static final Date DISCOUNT_START = new Date();
  private static final Date DISCOUNT_END = new Date();
  private static final String PROMOTION_NAME = "TEST";
  private static final Boolean DEFAULT_DISPLAY = true;
  private static final Boolean DEFAULT_BUYABLE = true;
  private static final Boolean DEFAULT_MAIN_IMAGE = false;
  private static final Integer DEFAULT_SEQUENCE = 1;
  private static final String DEFAULT_LOCATION_PATH = "TEST";
  private static final String DEFAULT_ATTRIBUTE_TYPE_2 =
    MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE.name();
  private static final String DEFAULT_ATTRIBUTE_TYPE_3 =
    MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name();
  private static final VerificationMode FOUR_TIMES = Mockito.times(4);
  private static final String DEFAULT_BUSINESS_PARTNER_CODE_2 = "BLI-00002";
  private static final VerificationMode TWO_TIMES = Mockito.times(2);
  private static final String DEFAULT_BUSINESS_PARTNER_CODE_3 = "BLI-00003";
  private static final VerificationMode THREE_TIMES = Mockito.times(3);
  private static final String REASON = "Reason";
  private static final String NOTES = "Notes";
  private static final String SUSPEND_ACTION = "SUSPEND";
  private static final String REACTIVATE_ACTION = "REACTIVATE";
  private static final String DETAIL_LINK = "DETAIL_LINK";
  private static final String ITEM_DETAIL_LINK = "DETAIL_LINK-SKU.html";
  private static final String STOREID = "storeId";
  private static final String CHANNELID = "channelId";
  private static final String CLIENTID = "clientId";
  private static final String REQUESTID = "requestId";
  private static final String USERNAME = "username";
  private static final String BUSINESS_PARTNER_ID = "businessPartnerId";
  private static final String WAREHOUSE_MERCHANT_CODE = "warehouseItemSku";
  private static final String WAREHOUSE_ITEM_SKU = "warehouseItemSku";
  private static final String WEB_MERCHANT_CODE = "webMerchantCode";
  private static final String WEB_ITEM_SKU = "webItemSku";
  private static final Boolean DO_ARCHIVE_TRUE = Boolean.TRUE;
  private static final Boolean DO_ARCHIVE_FALSE = Boolean.FALSE;
  private static final String BRAND = "brand";
  private static final String MERCHANT_CODE_1 = "merchantCode1";
  private static final String ITEM_CODE = "itemCode";
  private static final int FIRST = 0;
  private static final double PRICE_COEFFICIENT = 1.5d;
  private static final int MAX_INVENTORY_COUNT = 3;
  private static final String ORDER_BY_ITEM_SKU = "itemSku";
  private static final String CATALOG_CODE = "Catalog_code";
  private static final String IDR_CURRENCY = "IDR";
  private static final String CREATED_DATE = "createdDate";
  private static final String DESC = "desc";
  private static final String DEFAULT_CATEGORY_ID = "categoryId";
  private static final String UPDATING_REJECTED_ITEM = "Item Sku is rejected";
  private static final Long VERSION = Long.valueOf(2);
  private static final String WHOLESALE_RULE_1 = "[{\"quantity\":3,\"wholesaleDiscount\":30.0]";
  private static final int QUANTITY = 5;
  private static final int QUANTITY_1 = 10;
  private static final double WHOLESALE_DISCOUNT = 10.0;
  private static final double WHOLESALE_DISCOUNT_1 = 10.0;
  private static final long NORMAL_PRICE = 1000;
  private static final long SALE_PRICE = 2000;
  private static final String ACTIVE_STATUS = "ACTIVE";
  private static final String INACTIVE_STATUS = "INACTIVE";
  private static final String PRODUCT_HISTORY = "product-history";
  private static final String PICKUP = "PICKUP";
  private static final String PICKUP_1 = "PICKUP_1";
  private static final String PRODUCT_NAME1 = "PRODUCT_NAME1";
  private static final String PRODUCT_NAME2 = "PRODUCT_NAME2";
  private static final String PRODUCT_DESCRIPTION1 = "PRODUCT_DESCRIPTION1";
  private static final String PRODUCT_DESCRIPTION2 = "PRODUCT_DESCRIPTION2";
  private static final String PRODUCT_USP1 = "PRODUCT_USP1";
  private static final String PRODUCT_USP2 = "PRODUCT_USP2";
  private static final Integer DEFAULT_DELTA_STOCK = 2;
  private static final String UPDATE = "update";
  private static final String NEW = "new";
  private static final String ID = "ID";
  private static final Pageable PAGEABLE = PageRequest.of(0, 10);
  private static final Pageable PAGEABLE_1 = PageRequest.of(0, 1);
  private static final SortOrder SORT = new SortOrder("", "");
  private static final String POST_REVIEW_TYPE = "Post-live";
  private static final String PRE_REVIEW_TYPE = "Pre-live";
  private static final String PREORDER_TYPE = "DAYS";
  private static final String PREORDER_TYPE_WEEK = "WEEK";
  private static final String PREORDER_TYPE_DATE = "DATE";
  private static final Integer PREORDER_VALUE = 10;
  private static final int PAGE = 0;
  private static final int SIZE = 10;
  private static final String CATEGORY_NAME = "categoryName";
  private static final String BRAND_NAME = "Brand";
  private static final String STORE_ID = "10001";
  private static final String DEFAULT = "DEFAULT";
  private static final String PREORDER_OLD_VALUE =
    "(isPreOrder=true, preOrderType=WEEK, preOrderValue=10, preOrderDate=null)";
  public static final String ITEM_NAME = "itemName";
  private static final String DEFAULT_ATTRIBUTE_VALUE = "attributeValue";
  private static final String YOUTUBE_URL = "youtube_url";
  private static final String PRODUCT_DESCRIPTION1_BASE64 = "UFJPRFVDVF9ERVNDUklQVElPTjE=";
  private static final String PRODUCT_DESCRIPTION2_BASE64 = "UFJPRFVDVF9ERVNDUklQVElPTjI=";
  private static final String PRODUCT_USP1_BASE64 = "UFJPRFVDVF9VU1Ax";
  private static final String PRODUCT_USP2_BASE64 = "UFJPRFVDVF9VU1Ay";
  private static final String CATEGORY_RESTRICTED_ID = "catResId";
  private static final String PBP = "pbp";
  private static final String PICKUP_POINT_NAME = "pickupPointName";
  private static final String VENDOR_NOTES = "vendor notes";
  private static final String RANDOM_SKU = "random-sku";
  private static final String RANDOM_CODE = "random-code";
  private static final String DEFAULT_BUSINESS_PARTNER_CODE = "BP-12345";
  private static final String SIZE_CHART_CODE = "size-chart-code";

  Map<String, Set<String>> map = new HashMap();
  Map<String, String> itemSkuAndPickupCodeMap = new HashMap<>();

  private static final VerificationMode CALLED_THREE_TIMES = Mockito.times(3);
  private static final String DEFAULT_ORIGIN_ID = "originId";

  private PredefinedAllowedAttributeValueResponse predefinedAllowedAttributeValueResponse;
  private List<PredefinedAllowedAttributeValueResponse> predefinedAllowedAttributeValueResponses;

  private ProfileResponse businessPartnerData;

  private RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType;
  private ItemViewConfigRequest itemViewConfigRequest = new ItemViewConfigRequest();
  private Page<ItemSummaryResponse> itemSummaryResponsePage;
  private ProductImageQcProcessingResponse productImageQcProcessingResponse;
  private ItemPickupPointListingResponse itemPickupPointListingResponse =
    new ItemPickupPointListingResponse();

  private ProductSystemParameter productSystemParameter;
  private ProductSystemParameter productSystemParameter1 = new ProductSystemParameter();
  private ProductPriceAndWholesaleRequest productPriceAndWholesaleRequest =
    new ProductPriceAndWholesaleRequest();
  private ProductItemWholesalePriceRequest productItemWholesalePriceRequest =
    new ProductItemWholesalePriceRequest();
  private ProductItemWholesalePriceRequest productItemWholesalePriceRequest1 =
    new ProductItemWholesalePriceRequest();
  private List<ProductItemWholesalePriceRequest> productItemWholesalePriceRequestList =
    new ArrayList<>();
  private List<ItemLevel5Response> itemLevel5ResponseList = new ArrayList<>();
  private WholesalePriceSkuResponse wholesalePriceSkuResponse;
  private WholesaleMappingResponse wholesaleMappingResponse;
  private ProductPriceStockAndImagesRequest productPriceStockAndImagesRequest;
  private ConfigurationStatusResponse configurationStatusResponse =
    new ConfigurationStatusResponse();
  private PreOrderDTO preOrderDTO;
  private AttributeResponse attribute;
  private PreOrderRequest preOrderRequest;
  private CampaignUpdateDiscountRequest campaignUpdateDiscountRequest;
  private CampaignUpdateDiscountResponse campaignUpdateDiscountResponse;
  private ProductSuspensionHistory productSuspensionHistory = new ProductSuspensionHistory();
  private Map<String, ItemSummaryResponse> itemSummaryResponseMap = new HashMap<>();
  private ItemsSummaryDetailRequest itemFilterRequest;
  private List<CategoryResponse> categoryResponses = new ArrayList<>();
  private ItemResponseV2 itemResponseV2 = new ItemResponseV2();
  private ProfileResponse profileResponse = new ProfileResponse();

  @Captor
  private ArgumentCaptor<SortOrder> sortOrderArgumentCaptor;

  @Captor
  private ArgumentCaptor<ProductRequest> productRequestArgumentCaptor;

  @Captor
  private ArgumentCaptor<WholesalePriceRequest> wholesalePriceRequestArgumentCaptor;

  @Captor
  private ArgumentCaptor<ProductLevel3SummaryFilter> productLevel3SummaryFilterArgumentCaptor;

  @Captor
  private ArgumentCaptor<CampaignUpdateDiscountRequest> campaignUpdateDiscountRequestArgumentCaptor;

  @Captor
  ArgumentCaptor<SimpleMasterProductUpdateRequestDTO>
    simpleMasterProductUpdateRequestDTOArgumentCaptor;

  @Captor
  ArgumentCaptor<AddEditedProductToPDTEvent> addEditedProductToPDTEventArgumentCaptor;

  @Captor
  ArgumentCaptor<AddProductToVendorCombinedEventModel>
    addProductToVendorCombinedEventModelArgumentCaptor;

  @Captor
  private ArgumentCaptor<ProductBusinessPartner> productBusinessPartnerArgumentCaptor;

  @InjectMocks
  private ProductLevel3ServiceBean productLevel3ServiceBean;

  @Mock
  private PreOrderConfig preOrderConfig;

  @Mock
  private ProductLevel3Repository productLevel3Repository;

  @Mock
  private CategoryRepository categoryRepository;

  @Mock
  private PickupPointRepository pickupPointRepository;

  @Mock
  private AttributeRepository attributeRepository;

  @Mock
  private ProductPublisherService productPublisherService;

  @Mock
  private BusinessPartnerRepository businessPartnerRepository;
  @Mock
  private ProductAnalyticsOutbound productAnalyticsOutbound;

  @Mock
  private ProductInventoryService productInventoryService;

  @Mock
  private ProductBusinessPartnerService productBusinessPartnerService;

  @Mock
  private UpdatedProductHistoryService updatedProductHistoryService;

  @Mock
  private PickupPointOutbound pickupPointOutbound;

  @Mock
  private UpdateProductItemLevel3ModelConverter updateProductItemLevel3ModelConverter;

  @Mock
  private ProductLevel3InventoryService productLevel3InventoryService;

  @Mock
  private ProductLevel3Converter productLevel3Converter;

  @Mock
  private SystemParameterService systemParameterService;

  @Mock
  private ProductLevel3AggregatorServiceOld productLevel3DirectAggregatorService;

  @Mock
  private ProductLevel3AggregatorServiceOld productLevel3MaterializedViewAggregatorService;

  @Mock
  private ProductLevel3AggregatorService productLevel3AggregatorService;

  @Mock
  private ProductOutbound productOutbound;

  @Mock
  private ProductStockAlertService productStockAlertService;

  @Mock
  private ProductStockAlertRepository productStockAlertRepository;

  @Mock
  private ProductBusinessPartnerRepository productBusinessPartnerRepository;

  @Mock
  private RedisTemplate<String, Object> redisTemplate;

  @Mock
  private BoundValueOperations<String, Object> boundValueOperations;

  @Mock
  private SolrActiveProductCollectionServiceBean solrActiveProductCollectionServiceBean;

  @Mock
  private ProductCollectionRepository productCollectionRepository;

  @Mock
  private ProductRepository productRepository;

  @Mock
  private ProductSuspensionHistoryRepository productSuspensionHistoryRepository;

  @Mock
  private ApplicationProperties applicationProperties;

  @Mock
  private ApplicationContext applicationContext;

  @Mock
  private ProductMailEventService productMailEventService;

  @Mock
  private XProductOutbound xProductOutbound;

  @Mock
  private SapOutbound sapOutbound;

  @Mock
  private ProductImageQcProcessingResponseService productImageQcProcessingResponseService;

  @Mock
  private ProductSystemParameterService productSystemParameterService;

  @Mock
  private ProductItemBusinessPartnerService productItemBusinessPartnerService;

  @Mock
  private CalendarService calendarService;

  @Mock
  private KafkaTopicProperties kafkaTopicProperties;

  @Captor
  private ArgumentCaptor<ProductAndItemsRequest> productAndItemsRequestArgumentCaptor;

  @Captor
  private ArgumentCaptor<NeedCorrectionProductActivationRequest> needCorrectionArgumentCaptor;

  @Mock
  private ProductItemWholesalePriceService productItemWholesalePriceService;

  @Mock
  private MapperUtil mapperUtil;

  @Mock
  private ProductPricingOutbound productPricingOutbound;

  @Mock
  private WholesaleValidationUtil wholesaleValidationUtil;

  @Mock
  private PCBFeign pcbFeign;

  @Mock
  private ProductLevel3LogisticsService productLevel3LogisticsService;

  @Mock
  private VariantEditValidationService variantEditValidationService;

  @Mock
  private ProductItemBusinessPartnerRepository productItemBusinessPartnerRepository;

  @Mock
  private ProductItemWholesalePriceRepository productItemWholesalePriceRepository;

  @Mock
  private InventoryOutbound inventoryOutbound;

  @Mock
  private ProductLevel3Converter modelConverter;

  @Captor
  private ArgumentCaptor<WholesalePriceSkuResponse> priceSkuResponseArgumentCaptor;

  @Captor
  private ArgumentCaptor<ItemRequest> itemArgumentCaptor;

  @Captor
  private ArgumentCaptor<PickupPointFilterRequest> pickupPointFilterRequestArgumentCaptor;

  @Mock
  private CampaignOutbound campaignOutbound;

  @Mock
  private KafkaPublisher kafkaProducer;

  @Mock
  private ProductLevel3Helper productLevel3Helper;

  @Mock
  private ProductService productService;

  @Mock
  private BulkProductLevel3AggregatorServiceBean bulkProductLevel3AggregatorService;

  @Mock
  private ProductNotificationService productNotificationService;

  @Mock
  private SolrActiveProductCollectionRepository solrActiveProductCollectionRepository;

  @Mock
  private ProductServiceWrapper productServiceWrapper;

  @Mock
  private ObjectMapper objectMapper;

  @Mock
  private GeneratorService generatorService;

  @Mock
  private AGPQueryFeign agpQueryFeign;

  @Mock
  private PredefinedAttributeAllowedValueServiceBean predefinedAttributeAllowedValueService;

  @Mock
  private ProductLevel3V2Service productLevel3V2Service;


  @Mock
  private FileStorageService fileStorageService;

  @Captor
  private ArgumentCaptor<EditedImageResizeEvent> imageResizeEventArgumentCaptor;

  @Captor
  private ArgumentCaptor<ProductPriceStockAndImagesRequest>
    productPriceStockAndImagesRequestArgumentCaptor;

  @Captor
  private ArgumentCaptor<ItemSummaryRequest> itemSummaryRequestArgumentCaptor;

  @Captor
  private ArgumentCaptor<PageRequest> pageRequestArgumentCaptor;

  @Captor
  private ArgumentCaptor<Pageable> pageableArgumentCaptor;

  @Captor
  private ArgumentCaptor<List<ItemViewConfigAndItemSkuRequest>> itemViewConfigRequestArgumentCaptor;

  @Captor
  private ArgumentCaptor<Boolean> booleanArgumentCaptor;

  @Captor
  private ArgumentCaptor<List<QuickEditUpdateRequest>> quickEditListArgumentCaptor;

  @Captor
  private ArgumentCaptor<List<ProductLevel3Inventory>> argumentCaptorProductLevel3InventoryList;

  @Captor
  private ArgumentCaptor<ProductAndItemActivationRequest>
    productAndItemActivationRequestArgumentCaptor;

  @Captor
  private ArgumentCaptor<ListRequestDTO<WebInventoryUpdatePickupPointRequestDTO>>
    listRequestDTOArgumentCaptor;

  @Captor
  private ArgumentCaptor<List<WebInventoryDeleteByWebItemSkuAndPickupPointCodeDTO>> deleteL5Captor;

  private MandatoryRequestParam mandatoryRequestParam;

  private List<ItemSummaryResponse> productItemSummaryDatas;

  private List<ProductLevel3Inventory> productLevel3InventoryList;
  private ProductLevel3Inventory productLevel3Inventory;
  private ProductLevel3Inventory productLevel3Inventory2;
  private ProductLevel3Inventory productLevel3Inventory3;
  private PickupPointResponse pickupPointData;
  private PickupPointResponse pickupPointResponse;
  private List<PickupPointResponse> pickupPointResponseList;
  private List<CategoryResponse> categoriesData;
  private List<ProductLevel3Inventory> inventoryByGdnSkuMap;
  private List<ItemPriceResponse> itemPriceResponses;
  private ProductAndItemsResponse productAndItemsResponse;
  private ProductAndItemsResponse productAndItemsResponse1;
  private ProductL3Response productL3Response;
  private SuspensionProductRequest suspensionProductRequest;
  private ProductLevel3SummaryFilter filterRequest;
  private SortOrder sortOrder;
  private SellerDetailResponse sellerDetailResponse;

  private List<PbpStockAlert> listPbpStockAlert;
  private List<PbpStockAlert> listPbpStockAlert2;
  private List<String> listProductStockAlert;
  private PbpStockAlert pbpStockAlert;
  private PbpStockAlert pbpStockAlert2;
  private GdnRestSingleResponse<SingleObjectResponse> categoryCodeResponse;
  private ActiveProductResponse activeProductResponse;
  private SummaryFilterRequest summaryFilterRequest;
  private SummaryFilterRequest summaryFilterRequest1;
  private CatalogResponse catalogResponse;
  private ItemSummaryResponse itemSummaryResponse;
  private ItemSummaryDetailResponse itemSummaryDetailResponse;
  private ProductCollection productCollection;
  private ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
  private ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
  private ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
  private ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
  private List<String> itemSkus;
  private ProductLevel3UpdateRequest productLevel3UpdateRequest;
  private PickupPointUpdateRequest pickupPointUpdateRequest;
  private WebInventoryBulkUpdatePickupPointCodeResponseDTO
    webInventoryBulkUpdatePickupPointCodeResponseDTO;
  private WebInventoryUpdatePickupPointResponseDTO updatePickupPointResponse;
  private ConfigurationStatusRequest configurationStatusRequest;
  private List<ConfigurationStatusResponse> configurationStatusResponseList;
  private AddEditedProductToPDTEvent addEditedProductToPDTEvent;
  private ProductL3SummaryRequest productL3SummaryRequest = new ProductL3SummaryRequest();
  private ProductSkuSummaryResponse productSkuSummaryResponse;
  private CategoryHierarchyResponse categoryHierarchyResponse = new CategoryHierarchyResponse();
  private CategoryResponse categoryResponse = new CategoryResponse();
  private ProductLevel3QuickEditRequest productLevel3QuickEditRequest;
  private QuickEditRequest quickEditRequest;
  private UpdateProductLevel3InfoRequest updateProductLevel3InfoRequest;
  private AgpSimpleQueryResponse agpSimpleQueryResponse;
  private CategoryDetailResponse categoryDetailResponse;
  private ProductL3UpdateRequest productL3UpdateRequest;
  private ProductItemsImageUpdateRequest productItemsImageUpdateRequest;
  private ProductVariantUpdateRequest productVariantUpdateRequest;
  private ProductVariantPriceStockAndImagesRequest productVariantPriceStockAndImagesRequest;
  private List<ProductPriceStockAndImagesRequest> variantList = new ArrayList<>();
  private List<ProductLevel3SummaryDetailsImageRequest> copyToAllVariantImages = new ArrayList();
  private List<ProductVariantPriceStockAndImagesRequest> stockAndImagesRequestsList =
    new ArrayList<>();
  private List<ProductLevel3SummaryDetailsImageRequest> images = new ArrayList<>();
  private ItemBasicDetailV2Response itemBasicDetailV2Response = new ItemBasicDetailV2Response();

  @Test
  public void archiveItemFalseTest() throws Exception {
    Mockito.doNothing().when(getProductLevel3Repository())
      .toggleArchiveItem(Mockito.any(), Mockito.anyBoolean());
    Mockito.when(productLevel3Repository.findSummaryByArchivedGdnSku(DEFAULT_ITEM_SKU))
      .thenReturn(new ItemSummaryResponse());
    this.productLevel3ServiceBean.toggleArchiveItem(DEFAULT_ITEM_SKU, DO_ARCHIVE_FALSE);
    verify(productLevel3Repository).findSummaryByArchivedGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3Repository).toggleArchiveItem(DEFAULT_ITEM_SKU, DO_ARCHIVE_FALSE);
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(productLevel3AggregatorService).updateState(DEFAULT_ITEM_SKU, null,
      ProductLevel3AggregatorState.ACTIVE);
  }

  @Test
  public void archiveItemFalseAggrregateFalseTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "skipProductLevel3AggregatorCreation",
      true);
    Mockito.doNothing().when(getProductLevel3Repository())
      .toggleArchiveItem(Mockito.any(), Mockito.anyBoolean());
    Mockito.when(productLevel3Repository.findSummaryByArchivedGdnSku(DEFAULT_ITEM_SKU))
      .thenReturn(new ItemSummaryResponse());
    this.productLevel3ServiceBean.toggleArchiveItem(DEFAULT_ITEM_SKU, DO_ARCHIVE_FALSE);
    verify(productLevel3Repository).findSummaryByArchivedGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3Repository).toggleArchiveItem(DEFAULT_ITEM_SKU, DO_ARCHIVE_FALSE);
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
  }

  @Test
  public void archiveItemTrueTest() throws Exception {
    Mockito.doNothing().when(getProductLevel3Repository())
      .toggleArchiveItem(Mockito.any(), Mockito.anyBoolean());
    this.productLevel3ServiceBean.toggleArchiveItem(DEFAULT_ITEM_SKU, DO_ARCHIVE_TRUE);
    verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3Repository).toggleArchiveItem(DEFAULT_ITEM_SKU, DO_ARCHIVE_TRUE);
    verify(updatedProductHistoryService, THREE_TIMES).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(productLevel3AggregatorService).updateState(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ARCHIVED);
  }

  @Test
  public void archiveItemTrueForceReviewTest() throws Exception {
    ItemSummaryResponse itemSummaryResponse = new ItemSummaryResponse();
    itemSummaryResponse.setForceReview(true);
    Mockito.when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU))
      .thenReturn(itemSummaryResponse);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.toggleArchiveItem(DEFAULT_ITEM_SKU, DO_ARCHIVE_TRUE);
      });
    } finally {
      verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    }
  }

  @Test
  public void archiveItemTrueTest_buyableAndDiscoverableFalse() throws Exception {
    ItemSummaryResponse itemSummaryResponse = generateItemSummaryData();
    itemSummaryResponse.getItemViewConfigs().stream().forEach(itemView -> {
      itemView.setBuyable(false);
      itemView.setDiscoverable(false);
    });
    Mockito.when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU))
      .thenReturn(itemSummaryResponse);
    Mockito.doNothing().when(getProductLevel3Repository())
      .toggleArchiveItem(Mockito.any(), Mockito.anyBoolean());
    this.productLevel3ServiceBean.toggleArchiveItem(DEFAULT_ITEM_SKU, DO_ARCHIVE_TRUE);
    verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3Repository).toggleArchiveItem(DEFAULT_ITEM_SKU, DO_ARCHIVE_TRUE);
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(productLevel3AggregatorService).updateState(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ARCHIVED);
  }

  @Test
  public void checkPickupPointCodeUsedTest() throws Exception {
    this.productLevel3ServiceBean.checkPickupPointCodeUsed(DEFAULT_PICKUP_POINT_CODE);
    verify(getProductLevel3Repository()).checkPickupPointCodeUsed(DEFAULT_PICKUP_POINT_CODE);
  }

  @Test
  public void createRegularTest() throws Exception {
    Product product = generateProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(product);
    productBusinessPartner.getProductItemBusinessPartners().get(0).setProductType(1);
    this.productLevel3ServiceBean.create(DEFAULT_BUSINESS_PARTNER_CODE, product,
      productBusinessPartner);
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void createRegular_checkCncTest() throws Exception {
    Product product = generateProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(product);
    productBusinessPartner.getProductItemBusinessPartners().get(0).setProductType(1);
    this.productLevel3ServiceBean.create(DEFAULT_BUSINESS_PARTNER_CODE, product,
        productBusinessPartner);
    Mockito.verify(xProductOutbound)
        .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            productAndItemActivationRequestArgumentCaptor.capture());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
        DEFAULT_PRODUCT_CODE);
    ItemViewConfigRequest itemViewConfigRequest =
        productAndItemActivationRequestArgumentCaptor.getValue().getItems().get(0).getItemPickupPoints().get(0)
            .getItemViewConfigs().stream().filter(
                itemViewConfigRequest1 -> Constants.CNC_CHANNEL.equalsIgnoreCase(itemViewConfigRequest1.getChannel()))
            .findFirst().orElse(new ItemViewConfigRequest());
    Assertions.assertFalse(itemViewConfigRequest.isBuyable() && itemViewConfigRequest.isDiscoverable());
  }

  @Test
  public void createBigProductTest() throws Exception {
    Product product = generateProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(product);
    productBusinessPartner.getProductItemBusinessPartners().get(0).setProductType(2);
    this.productLevel3ServiceBean.create(DEFAULT_BUSINESS_PARTNER_CODE, product,
      productBusinessPartner);
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void createBopisTest() throws Exception {
    Product product = generateProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(product);
    productBusinessPartner.getProductItemBusinessPartners().get(0).setProductType(3);
    productBusinessPartner.getProductItemBusinessPartners().get(0).setProductItemId("itemId");
    productBusinessPartner.getProductBusinessPartnerAttributes().get(0)
      .setAttributeId("attributeId");
    productImageQcProcessingResponse.setForceReview(true);

    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productImageQcProcessingResponse);
    this.productLevel3ServiceBean.create(DEFAULT_BUSINESS_PARTNER_CODE, product,
      productBusinessPartner);
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void createForceReviewTest() throws Exception {
    Product product = generateProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(product);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productImageQcProcessingResponse);
    this.productLevel3ServiceBean.create(DEFAULT_BUSINESS_PARTNER_CODE, product,
      productBusinessPartner);
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        productAndItemActivationRequestArgumentCaptor.capture());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    Assertions.assertFalse(productAndItemActivationRequestArgumentCaptor.getValue().getItems().get(0)
      .getItemPickupPoints().get(0).getItemViewConfigs().iterator().next().isBuyable());
    Assertions.assertFalse(productAndItemActivationRequestArgumentCaptor.getValue().getItems().get(0)
      .getItemPickupPoints().get(0).getItemViewConfigs().iterator().next().isDiscoverable());
  }

  private ProductBusinessPartner getProductBusinessPartner(Product product) throws Exception {
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductItemId(product.getProductItems().get(0).getId());
    productBusinessPartner.getProductItemBusinessPartners().get(1)
      .setProductItemId(product.getProductItems().get(1).getId());
    productBusinessPartner.getProductItemBusinessPartners().get(2)
      .setProductItemId(product.getProductItems().get(2).getId());
    return productBusinessPartner;
  }

  @Test
  public void createTest_1() throws Exception {
    Product product = generateProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(product);
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    this.productLevel3ServiceBean.create(DEFAULT_BUSINESS_PARTNER_CODE, product,
      productBusinessPartner);
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void createTest_2() throws Exception {
    Product product = generateProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(product);
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BOPIS);
    productBusinessPartner.setProductBusinessPartnerAttributes(
      new ArrayList<ProductBusinessPartnerAttribute>());
    this.productLevel3ServiceBean.create(DEFAULT_BUSINESS_PARTNER_CODE, product,
      productBusinessPartner);
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository, NEVER_CALLED).findOne(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void createTestBusinessPartnerwithNoProductItem() throws Exception {
    Product product = generateProduct();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    this.productLevel3ServiceBean.create(DEFAULT_BUSINESS_PARTNER_CODE, product,
      productBusinessPartner);
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void createWithInventoryLevel2_2Test() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      argumentCaptorProductLevel3InventoryList.capture());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU,
      argumentCaptorProductLevel3InventoryList.getValue().get(0).getProductSku());
      Assertions.assertEquals(10,
          argumentCaptorProductLevel3InventoryList.getValue().get(0).getInitialPreOrderQuota());
  }

  @Test
  public void createWithInventoryLevel2_2SyncStockAtL5LevelTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "inventoryL5SyncStockEnabled", true);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setFbbActivated(true);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    when(pickupPointOutbound.getByPickupPointCodes(Mockito.any(), Mockito.anyList())).thenReturn(
      Arrays.asList(pickupPointResponse));
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      argumentCaptorProductLevel3InventoryList.capture());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(pickupPointOutbound).getByPickupPointCodes(Mockito.any(), Mockito.anyList());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU,
      argumentCaptorProductLevel3InventoryList.getValue().get(0).getProductSku());
  }

  @Test
  public void createWithInventoryLevel2_forTrustedSellers() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    profileResponse.setTrustedSeller(true);
    productImageQcProcessingResponse.setForceReview(true);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    productImageQcProcessingResponse.setForceReview(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(Mockito.any(),
      Mockito.any())).thenReturn(productImageQcProcessingResponse);
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(Mockito.any(),
      Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      argumentCaptorProductLevel3InventoryList.capture());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU,
      argumentCaptorProductLevel3InventoryList.getValue().get(0).getProductSku());
  }


  @Test
  public void createWithInventoryLevel2_2DeletedPickupPoinyTest() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productData.getProductItemResponses().iterator().next().setMarkForDelete(true);
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      argumentCaptorProductLevel3InventoryList.capture());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU,
      argumentCaptorProductLevel3InventoryList.getValue().get(0).getProductSku());
  }

  @Test
  public void createTakeDownProduct() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productImageQcProcessingResponse);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        productAndItemActivationRequestArgumentCaptor.capture());
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      argumentCaptorProductLevel3InventoryList.capture());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any(),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU,
      argumentCaptorProductLevel3InventoryList.getValue().get(0).getProductSku());
    Assertions.assertTrue(
      productAndItemActivationRequestArgumentCaptor.getValue().getProduct().isForceReview());
    Assertions.assertTrue(
      productAndItemActivationRequestArgumentCaptor.getValue().getProduct().isMarkForDelete());
    Assertions.assertFalse(productAndItemActivationRequestArgumentCaptor.getValue().getItems().get(0)
      .getItemPickupPoints().get(0).getItemViewConfigs().iterator().next().isBuyable());
    Assertions.assertFalse(productAndItemActivationRequestArgumentCaptor.getValue().getItems().get(0)
      .getItemPickupPoints().get(0).getItemViewConfigs().iterator().next().isDiscoverable());
  }

  @Test
  public void createSkipLevel3AggregationProduct() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "skipProductLevel3AggregatorCreation",
      true);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productImageQcProcessingResponse);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        productAndItemActivationRequestArgumentCaptor.capture());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      argumentCaptorProductLevel3InventoryList.capture());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any(),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU,
      argumentCaptorProductLevel3InventoryList.getValue().get(0).getProductSku());
    Assertions.assertTrue(
      productAndItemActivationRequestArgumentCaptor.getValue().getProduct().isForceReview());
    Assertions.assertTrue(
      productAndItemActivationRequestArgumentCaptor.getValue().getProduct().isMarkForDelete());
    Assertions.assertFalse(productAndItemActivationRequestArgumentCaptor.getValue().getItems().get(0)
      .getItemPickupPoints().get(0).getItemViewConfigs().iterator().next().isBuyable());
    Assertions.assertFalse(productAndItemActivationRequestArgumentCaptor.getValue().getItems().get(0)
      .getItemPickupPoints().get(0).getItemViewConfigs().iterator().next().isDiscoverable());
  }

  @Test
  public void createWithWholesalePricesTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "wholesalePriceBatchsize", 10);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    ProductItemWholesalePriceResponse productItemWholesalePriceResponse =
      new ProductItemWholesalePriceResponse();
    productItemWholesalePriceResponse.setQuantity(3);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(this.productPricingOutbound.bulkUpdateWholesalePriceV2(
        Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any()))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productItemWholesalePriceService.findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU))).thenReturn(Arrays.asList(productItemWholesalePrice));
    Mockito.when(this.mapperUtil.mapStringToResponse(WHOLESALE_RULE_1))
      .thenReturn(Arrays.asList(productItemWholesalePriceResponse));
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    Mockito.verify(this.productPricingOutbound)
      .bulkUpdateWholesalePriceV2(Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any());
  }

  @Test
  public void createWithWholesalePricesMppFalseTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "wholesalePriceBatchsize", 10);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    ProductItemWholesalePriceResponse productItemWholesalePriceResponse =
      new ProductItemWholesalePriceResponse();
    productItemWholesalePriceResponse.setQuantity(3);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(this.productPricingOutbound.bulkUpdateWholesalePriceV2(
        Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any()))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productItemWholesalePriceService.findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU))).thenReturn(Arrays.asList(productItemWholesalePrice));
    Mockito.when(this.mapperUtil.mapStringToResponse(WHOLESALE_RULE_1))
      .thenReturn(Arrays.asList(productItemWholesalePriceResponse));
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    Mockito.verify(this.productPricingOutbound)
      .bulkUpdateWholesalePriceV2(Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any());
  }

  @Test
  public void createWithWholesalePricesMppTrueTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "wholesalePriceBatchsize", 10);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU_1);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    ProductItemWholesalePriceResponse productItemWholesalePriceResponse =
      new ProductItemWholesalePriceResponse();
    productItemWholesalePriceResponse.setQuantity(3);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(this.productPricingOutbound.bulkUpdateWholesalePriceV2(
        Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any()))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productItemWholesalePriceService.findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU))).thenReturn(Arrays.asList(productItemWholesalePrice));
    Mockito.when(this.mapperUtil.mapStringToResponse(WHOLESALE_RULE_1))
      .thenReturn(Arrays.asList(productItemWholesalePriceResponse));
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU_1));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    Mockito.verify(this.productPricingOutbound)
      .bulkUpdateWholesalePriceV2(Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any());
  }

  @Test
  public void createWithWholesalePricesMppTrueMfdTrueTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "wholesalePriceBatchsize", 10);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    ProductItemWholesalePriceResponse productItemWholesalePriceResponse =
      new ProductItemWholesalePriceResponse();
    productItemWholesalePriceResponse.setQuantity(3);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.getProductItemBusinessPartners().get(0).setMarkForDelete(true);
    productBusinessPartner.getProductItemBusinessPartners().get(1).setMarkForDelete(true);
    productBusinessPartner.getProductItemBusinessPartners().get(2).setMarkForDelete(true);
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(this.productPricingOutbound.bulkUpdateWholesalePriceV2(
        Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any()))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productItemWholesalePriceService.findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU))).thenReturn(Arrays.asList(productItemWholesalePrice));
    Mockito.when(this.mapperUtil.mapStringToResponse(WHOLESALE_RULE_1))
      .thenReturn(Arrays.asList(productItemWholesalePriceResponse));
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void createWithWholesalePricesPricingMppTrueTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "wholesalePriceBatchsize", 10);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    ProductItemWholesalePriceResponse productItemWholesalePriceResponse =
      new ProductItemWholesalePriceResponse();
    productItemWholesalePriceResponse.setQuantity(3);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    Mockito.when(this.productPricingOutbound.bulkUpdateWholesalePriceV2(
        Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any()))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productItemWholesalePriceService.findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU))).thenReturn(Arrays.asList(productItemWholesalePrice));
    Mockito.when(this.mapperUtil.mapStringToResponse(WHOLESALE_RULE_1))
      .thenReturn(Arrays.asList(productItemWholesalePriceResponse));
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(null);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_2, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    Mockito.verify(this.productPricingOutbound)
      .bulkUpdateWholesalePriceV2(Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any());
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
  }

  @Test
  public void createWithWholesalePricesExceptionTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "wholesalePriceBatchsize", 10);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    ProductItemWholesalePriceResponse productItemWholesalePriceResponse =
      new ProductItemWholesalePriceResponse();
    productItemWholesalePriceResponse.setQuantity(3);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    Mockito.when(this.productPricingOutbound.bulkUpdateWholesalePriceV2(
        Mockito.anyList(),
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.any()))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productItemWholesalePriceService.findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU))).thenReturn(Arrays.asList(productItemWholesalePrice));
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any()))
      .thenReturn(new AttributeResponse());
    Mockito.when(this.mapperUtil.mapStringToResponse(any())).thenThrow(IOException.class);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.create(
            ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_2, productData,
            productBusinessPartner, false, new ArrayList<>());
      });
    } catch (ApplicationRuntimeException e) {
      throw new ApplicationRuntimeException();
    } finally {
      verify(this.attributeRepository).findDetailById(Mockito.any());
      verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
      verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
        Arrays.asList(ITEM_SKU));
    }
  }

  @Test
  public void createWithInventoryLevel2_3Test() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_3);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    productBusinessPartner.getProductItemBusinessPartners().get(0)
      .setProductType(GdnBaseLookup.PRODUCT_TYPE_BOPIS);
    productBusinessPartner.setProductBusinessPartnerAttributes(
      new ArrayList<ProductBusinessPartnerAttribute>());
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE_3, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository, ProductLevel3ServiceBeanTest.NEVER_CALLED).findDetailById(
      Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_3));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE_3, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_3),
      Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
  }

  @Test
  public void createWithInventoryLevel2AndInactiveBusinessPartnerTest() throws Exception {
    this.businessPartnerData.setActivated(false);
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE))).thenReturn(this.businessPartnerData);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(true);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    this.productLevel3ServiceBean.create(ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE,
      productData, productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
  }

  @Test
  public void createWithInventoryLevel2AndInactiveBusinessPartnerTakenDownTrueTest()
    throws Exception {
    this.businessPartnerData.setActivated(false);
    businessPartnerData.setTrustedSeller(true);
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE))).thenReturn(this.businessPartnerData);
    productImageQcProcessingResponse.setForceReview(false);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(Mockito.any(),
      Mockito.any())).thenReturn(productImageQcProcessingResponse);

    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE,
      productData, productBusinessPartner, true, new ArrayList<>());

    Mockito.verify(xProductOutbound)
      .addProductAndItems(eq(STOREID), eq(WEB_CHANNEL_ID), eq(PBP), eq(REQUESTID), eq(null),
        productAndItemActivationRequestArgumentCaptor.capture());
    Mockito.verify(productImageQcProcessingResponseService)
      .findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    Assertions.assertFalse(
      productAndItemActivationRequestArgumentCaptor.getValue().getProduct().isForceReview());
  }

  @Test
  public void createWithInventoryLevel2AndInactiveBusinessPartnerTakenDownTrueForceReviewTrueTest()
    throws Exception {
    this.businessPartnerData.setActivated(false);
    businessPartnerData.setTrustedSeller(true);
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE))).thenReturn(this.businessPartnerData);
    productImageQcProcessingResponse.setForceReview(true);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(Mockito.any(),
      Mockito.any())).thenReturn(productImageQcProcessingResponse);

    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE,
      productData, productBusinessPartner, true, new ArrayList<>());

    Mockito.verify(xProductOutbound)
      .addProductAndItems(eq(STOREID), eq(WEB_CHANNEL_ID), eq(PBP), eq(REQUESTID), eq(null),
        productAndItemActivationRequestArgumentCaptor.capture());
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    Mockito.verify(productImageQcProcessingResponseService)
      .findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    Assertions.assertTrue(
      productAndItemActivationRequestArgumentCaptor.getValue().getProduct().isForceReview());
  }

  @Test
  public void createWithInventoryLevel2ProductItemNullTest() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    productBusinessPartner.getProductItemBusinessPartners().get(0).setProductItemId("not present");
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE,
      productData, productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void createWithInventoryLevel2Test() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE,
      productData, productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());

  }

  @Test
  public void createWithInventoryLevel2PostliveAsyncTest() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productImageQcProcessingResponse);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE,
      productData, productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        productAndItemActivationRequestArgumentCaptor.capture());
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
    Assertions.assertFalse(productAndItemActivationRequestArgumentCaptor.getValue().getItems().get(0)
      .getItemPickupPoints().get(0).getItemViewConfigs().iterator().next().isBuyable());
    Assertions.assertFalse(productAndItemActivationRequestArgumentCaptor.getValue().getItems().get(0)
      .getItemPickupPoints().get(0).getItemViewConfigs().iterator().next().isDiscoverable());
  }

  private ProductBusinessPartner getProductBusinessPartner(ProductDetailResponse productData)
    throws Exception {
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      i++;
    }
    return productBusinessPartner;
  }

  @Test
  public void createWithInventoryLevel2TestProductBusinessPartnerwithNoProductItem()
    throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE);
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      profileResponse);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE,
      productData, productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus,
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
  }

  @AfterEach
  public void finalizeTest() throws Exception {
    Mockito.verifyNoMoreInteractions(this.getProductLevel3Repository());
    Mockito.verifyNoMoreInteractions(this.getCategoryRepository());
    Mockito.verifyNoMoreInteractions(this.getPickupPointRepository());
    Mockito.verifyNoMoreInteractions(this.attributeRepository);
    Mockito.verifyNoMoreInteractions(this.getProductInventoryService());
    Mockito.verifyNoMoreInteractions(this.getUpdatedProductHistoryService());
    Mockito.verifyNoMoreInteractions(this.getProductLevel3InventoryService());
    Mockito.verifyNoMoreInteractions(this.getProductLevel3Converter());
    Mockito.verifyNoMoreInteractions(this.productLevel3AggregatorService);
    Mockito.verifyNoMoreInteractions(this.productMailEventService);
    Mockito.verifyNoMoreInteractions(this.productItemWholesalePriceService);
    Mockito.verifyNoMoreInteractions(this.productPricingOutbound);
    Mockito.verifyNoMoreInteractions(this.solrActiveProductCollectionServiceBean, redisTemplate,
      boundValueOperations);
    Mockito.verifyNoMoreInteractions(this.productImageQcProcessingResponseService);
    Mockito.verifyNoMoreInteractions(this.productItemBusinessPartnerService);
    Mockito.verifyNoMoreInteractions(this.productOutbound);
    Mockito.verifyNoMoreInteractions(this.inventoryOutbound);
    Mockito.verifyNoMoreInteractions(wholesaleValidationUtil);
    Mockito.verifyNoMoreInteractions(productLevel3LogisticsService);
    Mockito.verifyNoMoreInteractions(variantEditValidationService);
    Mockito.verifyNoMoreInteractions(productItemBusinessPartnerRepository);
    Mockito.verifyNoMoreInteractions(productItemWholesalePriceRepository);
    Mockito.verifyNoMoreInteractions(campaignOutbound);
    Mockito.verifyNoMoreInteractions(productNotificationService);
    Mockito.verifyNoMoreInteractions(xProductOutbound);
    verifyNoMoreInteractions(sapOutbound);
    verifyNoMoreInteractions(productLevel3V2Service);
    Mockito.verifyNoMoreInteractions(kafkaTopicProperties);
    MDC.clear();
  }

  @SuppressWarnings("unchecked")
  @Test
  public void findDashboardTest() throws Exception {
    this.productLevel3ServiceBean.findDashboard(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository(), FOUR_TIMES).findSummaryByFilter(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void findProductSummaryForBulkDownloadEmptyResult() throws Exception {
    Page<ItemSummaryResponse> productData =
      new PageImpl<ItemSummaryResponse>(new ArrayList<>(), DEFAULT_PAGEABLE, 10);
    List<String> gdnSkuList = new ArrayList<>();
    gdnSkuList.add(DEFAULT_GDN_SKU);

    Mockito.when(
      productLevel3Repository.findSummaryByFilter(eq(DEFAULT_BUSINESS_PARTNER_CODE), eq(null),
        eq(new ArrayList<>()), eq(null), eq(null), eq(null), eq(null), eq(null),
        eq(DEFAULT_PAGE_REQUEST), eq(false), Mockito.any())).thenReturn(productData);
    Mockito.when(
      getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenReturn(productLevel3InventoryList);

    this.productLevel3ServiceBean.findProductSummaryForBulkDownload(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_PAGE_REQUEST, DEFAULT_REQUEST_ID, null, null, null, null, null, null, false);

    verify(productLevel3Repository).findSummaryByFilter(eq(DEFAULT_BUSINESS_PARTNER_CODE), eq(null),
      eq(new ArrayList<>()), eq(null), eq(null), eq(null), eq(null), eq(null),
      eq(DEFAULT_PAGE_REQUEST), eq(false), sortOrderArgumentCaptor.capture());
    SortOrder sortOrder = sortOrderArgumentCaptor.getValue();
    Assertions.assertEquals(ORDER_BY_ITEM_SKU, sortOrder.getOrderBy());
    Assertions.assertEquals(SolrConstants.ASC, sortOrder.getSortBy());
  }

  @Test
  public void findProductSummaryForBulkDownloadWithMasterCatalogNull() throws Exception {
    List<ItemSummaryResponse> itemSummaryResponseList = new ArrayList<>();
    ItemSummaryResponse itemData =
      new ItemSummaryResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_MERCHANT_SKU,
        "itemName", null, new ArrayList<>(), new HashSet<>(), new HashSet<>(), ProductType.REGULAR,
        DEFAULT_PICKUP_POINT_CODE, new ArrayList<>(), false, DEFAULT_BUSINESS_PARTNER_CODE, "");
    itemSummaryResponseList.add(itemData);
    Page<ItemSummaryResponse> productData =
      new PageImpl<ItemSummaryResponse>(itemSummaryResponseList, DEFAULT_PAGEABLE, 10);
    List<String> gdnSkuList = new ArrayList<>();
    gdnSkuList.add(DEFAULT_GDN_SKU);
    try {
      Mockito.when(
          productLevel3Repository.findSummaryByFilter(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
            Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.eq(DEFAULT_PAGE_REQUEST), Mockito.any(), Mockito.any()))
        .thenReturn(productData);
      Mockito.when(getProductLevel3Converter().convertItemSummaryResponseToListOfGdnSku(
        itemSummaryResponseList)).thenReturn(gdnSkuList);
      Mockito.when(
        getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
          DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenThrow(Exception.class);

      this.productLevel3ServiceBean.findProductSummaryForBulkDownload(DEFAULT_BUSINESS_PARTNER_CODE,
        DEFAULT_PAGE_REQUEST, DEFAULT_REQUEST_ID, null, DEFAULT_GDN_SKU_2, null, null, null, null,
        false);

      verify(productLevel3Repository).findSummaryByFilter(eq(DEFAULT_BUSINESS_PARTNER_CODE),
        eq(null), eq(Arrays.asList(DEFAULT_GDN_SKU_2)), eq(null), eq(null), eq(null), eq(null),
        eq(null), eq(DEFAULT_PAGE_REQUEST), eq(false), sortOrderArgumentCaptor.capture());
      SortOrder sortOrder = sortOrderArgumentCaptor.getValue();
      Assertions.assertEquals(ORDER_BY_ITEM_SKU, sortOrder.getOrderBy());
      Assertions.assertEquals(SolrConstants.ASC, sortOrder.getSortBy());
      verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
      verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
      verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
        itemSummaryResponseList);
    } catch (Exception e) {
    } finally {
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList);
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    }
  }

  @Test
  public void findProductSummaryForBulkDownloadErrorTest() throws Exception {
    Mockito.when(
      productLevel3Repository.findSummaryByFilter(eq(DEFAULT_BUSINESS_PARTNER_CODE), eq(null),
        eq(new ArrayList<>()), eq(null), eq(null), eq(null), eq(null), eq(null),
        eq(DEFAULT_PAGE_REQUEST), eq(false), Mockito.any())).thenThrow(new RuntimeException());
    try {
      Assertions.assertThrows(Exception.class, () -> {
        this.productLevel3ServiceBean.findProductSummaryForBulkDownload(DEFAULT_BUSINESS_PARTNER_CODE,
            DEFAULT_PAGE_REQUEST, DEFAULT_REQUEST_ID, null, null, null, null, null, null, false);
      });
    } catch (Exception e) {
      throw e;
    } finally {
      verify(productLevel3Repository).findSummaryByFilter(eq(DEFAULT_BUSINESS_PARTNER_CODE),
        eq(null), eq(new ArrayList<>()), eq(null), eq(null), eq(null), eq(null), eq(null),
        eq(DEFAULT_PAGE_REQUEST), eq(false), sortOrderArgumentCaptor.capture());
      SortOrder sortOrder = sortOrderArgumentCaptor.getValue();
      Assertions.assertEquals(ORDER_BY_ITEM_SKU, sortOrder.getOrderBy());
      Assertions.assertEquals(SolrConstants.ASC, sortOrder.getSortBy());
    }
  }

  @Test
  public void findProductSummaryForBulkDownloadExceptionTest() throws Exception {
    List<ItemSummaryResponse> itemSummaryResponseList = new ArrayList<>();
    MasterCatalogDTO masterCatalogDTO = new MasterCatalogDTO();
    CategoryDTO categoryDTO = new CategoryDTO();
    categoryDTO.setCategoryCode(DEFAULT_CATEGORY_CODE);
    masterCatalogDTO.setCategory(categoryDTO);
    ItemSummaryResponse itemData =
      new ItemSummaryResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_MERCHANT_SKU,
        "itemName", masterCatalogDTO, new ArrayList<SalesCatalogDTO>(), new HashSet<PriceDTO>(),
        new HashSet<ItemViewConfigDTO>(), ProductType.REGULAR, DEFAULT_PICKUP_POINT_CODE,
        new ArrayList<MasterDataItemImageDTO>(), false, DEFAULT_BUSINESS_PARTNER_CODE, "");
    itemSummaryResponseList.add(itemData);
    Page<ItemSummaryResponse> productData =
      new PageImpl<ItemSummaryResponse>(itemSummaryResponseList, DEFAULT_PAGEABLE, 10);
    List<String> gdnSkuList = new ArrayList<>();
    gdnSkuList.add(DEFAULT_GDN_SKU);
    try {
      Mockito.when(
          productLevel3Repository.findSummaryByFilter(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
            Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.eq(DEFAULT_PAGE_REQUEST), Mockito.any(), Mockito.any()))
        .thenReturn(productData);
      Mockito.when(getProductLevel3Converter().convertItemSummaryResponseToListOfGdnSku(
        itemSummaryResponseList)).thenReturn(gdnSkuList);
      Mockito.when(
        getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
          DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenThrow(Exception.class);

      this.productLevel3ServiceBean.findProductSummaryForBulkDownload(DEFAULT_BUSINESS_PARTNER_CODE,
        DEFAULT_PAGE_REQUEST, DEFAULT_REQUEST_ID, null, DEFAULT_GDN_SKU_2, null, null, null, null,
        false);

      verify(productLevel3Repository).findSummaryByFilter(eq(DEFAULT_BUSINESS_PARTNER_CODE),
        eq(null), eq(Arrays.asList(DEFAULT_GDN_SKU_2)), eq(null), eq(null), eq(null), eq(null),
        eq(null), eq(DEFAULT_PAGE_REQUEST), eq(false), sortOrderArgumentCaptor.capture());
      SortOrder sortOrder = sortOrderArgumentCaptor.getValue();
      Assertions.assertEquals(ORDER_BY_ITEM_SKU, sortOrder.getOrderBy());
      Assertions.assertEquals(SolrConstants.ASC, sortOrder.getSortBy());
      verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
      verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
      verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
        itemSummaryResponseList);
    } catch (Exception e) {
    } finally {
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList);
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    }
  }

  @Test
  public void findProductSummaryForBulkDownloadTestProductDatasCategoryNull() throws Exception {
    List<ItemSummaryResponse> itemSummaryResponseList = new ArrayList<>();
    MasterCatalogDTO masterCatalogDTO = new MasterCatalogDTO();
    CategoryDTO categoryDTO = new CategoryDTO();
    categoryDTO.setCategoryCode(DEFAULT_CATEGORY_CODE);
    masterCatalogDTO.setCategory(categoryDTO);
    ItemSummaryResponse itemData =
      new ItemSummaryResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_MERCHANT_SKU,
        "itemName", masterCatalogDTO, new ArrayList<SalesCatalogDTO>(), new HashSet<PriceDTO>(),
        new HashSet<ItemViewConfigDTO>(), ProductType.REGULAR, DEFAULT_PICKUP_POINT_CODE,
        new ArrayList<MasterDataItemImageDTO>(), false, DEFAULT_BUSINESS_PARTNER_CODE, "");
    itemSummaryResponseList.add(itemData);

    Page<ItemSummaryResponse> productData =
      new PageImpl<ItemSummaryResponse>(itemSummaryResponseList, DEFAULT_PAGEABLE, 10);
    productData.getContent().get(0).getMasterCatalog().setCategory(null);

    List<String> gdnSkuList = new ArrayList<>();
    gdnSkuList.add(DEFAULT_GDN_SKU);

    Mockito.when(
      productLevel3Repository.findSummaryByFilter(eq(DEFAULT_BUSINESS_PARTNER_CODE), eq(null),
        eq(new ArrayList<>()), eq(null), eq(null), eq(null), eq(null), eq(null),
        eq(DEFAULT_PAGE_REQUEST), eq(false), Mockito.any())).thenReturn(productData);
    Mockito.when(getProductLevel3Converter().convertItemSummaryResponseToListOfGdnSku(
      productData.getContent())).thenReturn(gdnSkuList);
    Mockito.when(
      getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenReturn(productLevel3InventoryList);

    this.productLevel3ServiceBean.findProductSummaryForBulkDownload(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_PAGE_REQUEST, DEFAULT_REQUEST_ID, null, null, null, null, null, null, false);

    verify(productLevel3Repository).findSummaryByFilter(eq(DEFAULT_BUSINESS_PARTNER_CODE), eq(null),
      eq(Arrays.asList()), eq(null), eq(null), eq(null), eq(null), eq(null),
      eq(DEFAULT_PAGE_REQUEST), eq(false), sortOrderArgumentCaptor.capture());
    SortOrder sortOrder = sortOrderArgumentCaptor.getValue();
    Assertions.assertEquals(ORDER_BY_ITEM_SKU, sortOrder.getOrderBy());
    Assertions.assertEquals(SolrConstants.ASC, sortOrder.getSortBy());
    verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
      productData.getContent());
    verify(getProductLevel3Converter()).convertProductLevel3InventoryToMapOfGdnSku(
      productLevel3InventoryList);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
      productData.getContent());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
  }

  @Test
  public void findProductSummaryForBulkDownloadWithGdnSkuInventoryNullExceptionTest()
    throws Exception {
    List<ItemSummaryResponse> itemSummaryResponseList = new ArrayList<>();
    MasterCatalogDTO masterCatalogDTO = new MasterCatalogDTO();
    CategoryDTO categoryDTO = new CategoryDTO();
    categoryDTO.setCategoryCode(DEFAULT_CATEGORY_CODE);
    masterCatalogDTO.setCategory(categoryDTO);
    ItemSummaryResponse itemData =
      new ItemSummaryResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_MERCHANT_SKU,
        "itemName", masterCatalogDTO, new ArrayList<SalesCatalogDTO>(), new HashSet<PriceDTO>(),
        new HashSet<ItemViewConfigDTO>(), ProductType.REGULAR, DEFAULT_PICKUP_POINT_CODE,
        new ArrayList<MasterDataItemImageDTO>(), false, DEFAULT_BUSINESS_PARTNER_CODE, "");
    itemSummaryResponseList.add(itemData);
    Page<ItemSummaryResponse> productData =
      new PageImpl<ItemSummaryResponse>(itemSummaryResponseList, DEFAULT_PAGEABLE, 10);
    List<String> gdnSkuList = new ArrayList<>();
    gdnSkuList.add(DEFAULT_GDN_SKU);

    Mockito.when(
        productLevel3Repository.findSummaryByFilter(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.eq(DEFAULT_PAGE_REQUEST), Mockito.any(), Mockito.any()))
      .thenReturn(productData);
    Mockito.when(
        getProductLevel3Converter().convertItemSummaryResponseToListOfGdnSku(itemSummaryResponseList))
      .thenReturn(gdnSkuList);
    Mockito.when(
      getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenThrow(Exception.class);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenThrow(Exception.class);

    this.productLevel3ServiceBean.findProductSummaryForBulkDownload(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_PAGE_REQUEST, DEFAULT_REQUEST_ID, null, DEFAULT_GDN_SKU_2, null, null, null, null,
      true);

    verify(productLevel3Repository).findSummaryByFilter(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
      Mockito.any(), Mockito.anyList(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.eq(DEFAULT_PAGE_REQUEST), Mockito.any(), Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
      itemSummaryResponseList);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
  }

  @Test
  public void findProductSummaryForBulkDownloadWithGdnSkuInventoryNullTest() throws Exception {
    List<ItemSummaryResponse> itemSummaryResponseList = new ArrayList<>();
    MasterCatalogDTO masterCatalogDTO = new MasterCatalogDTO();
    CategoryDTO categoryDTO = new CategoryDTO();
    categoryDTO.setCategoryCode(DEFAULT_CATEGORY_CODE);
    masterCatalogDTO.setCategory(categoryDTO);
    ItemSummaryResponse itemData =
      new ItemSummaryResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_MERCHANT_SKU,
        "itemName", masterCatalogDTO, new ArrayList<SalesCatalogDTO>(), new HashSet<PriceDTO>(),
        new HashSet<ItemViewConfigDTO>(), ProductType.REGULAR, DEFAULT_PICKUP_POINT_CODE,
        new ArrayList<MasterDataItemImageDTO>(), false, DEFAULT_BUSINESS_PARTNER_CODE, "");
    itemSummaryResponseList.add(itemData);
    Page<ItemSummaryResponse> productData =
      new PageImpl<ItemSummaryResponse>(itemSummaryResponseList, DEFAULT_PAGEABLE, 10);
    List<String> gdnSkuList = new ArrayList<>();
    gdnSkuList.add(DEFAULT_GDN_SKU);

    Mockito.when(
        productLevel3Repository.findSummaryByFilter(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.eq(DEFAULT_PAGE_REQUEST), Mockito.any(), Mockito.any()))
      .thenReturn(productData);
    Mockito.when(
        getProductLevel3Converter().convertItemSummaryResponseToListOfGdnSku(itemSummaryResponseList))
      .thenReturn(gdnSkuList);
    Mockito.when(
      getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenThrow(Exception.class);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenReturn(null);

    this.productLevel3ServiceBean.findProductSummaryForBulkDownload(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_PAGE_REQUEST, DEFAULT_REQUEST_ID, null, DEFAULT_GDN_SKU_2, null, null, null, null,
      false);

    verify(productLevel3Repository).findSummaryByFilter(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
      Mockito.any(), Mockito.anyList(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.eq(DEFAULT_PAGE_REQUEST), Mockito.any(), Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
      itemSummaryResponseList);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
  }

  @Test
  public void findProductSummaryForBulkDownloadWithGdnSkuTest() throws Exception {
    List<ItemSummaryResponse> itemSummaryResponseList = new ArrayList<>();
    MasterCatalogDTO masterCatalogDTO = new MasterCatalogDTO();
    CategoryDTO categoryDTO = new CategoryDTO();
    categoryDTO.setCategoryCode(DEFAULT_CATEGORY_CODE);
    masterCatalogDTO.setCategory(categoryDTO);
    ItemSummaryResponse itemData =
      new ItemSummaryResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_MERCHANT_SKU,
        "itemName", masterCatalogDTO, new ArrayList<SalesCatalogDTO>(), new HashSet<PriceDTO>(),
        new HashSet<ItemViewConfigDTO>(), ProductType.REGULAR, DEFAULT_PICKUP_POINT_CODE,
        new ArrayList<MasterDataItemImageDTO>(), false, DEFAULT_BUSINESS_PARTNER_CODE, "");
    itemSummaryResponseList.add(itemData);
    Page<ItemSummaryResponse> productData =
      new PageImpl<ItemSummaryResponse>(itemSummaryResponseList, DEFAULT_PAGEABLE, 10);
    List<String> gdnSkuList = new ArrayList<>();
    gdnSkuList.add(DEFAULT_GDN_SKU);

    Mockito.when(
        productLevel3Repository.findSummaryByFilter(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.eq(DEFAULT_PAGE_REQUEST), Mockito.any(), Mockito.any()))
      .thenReturn(productData);
    Mockito.when(
        getProductLevel3Converter().convertItemSummaryResponseToListOfGdnSku(itemSummaryResponseList))
      .thenReturn(gdnSkuList);
    Mockito.when(
      getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenReturn(productLevel3InventoryList);

    this.productLevel3ServiceBean.findProductSummaryForBulkDownload(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_PAGE_REQUEST, DEFAULT_REQUEST_ID, null, DEFAULT_GDN_SKU_2, null, null, null, null,
      false);

    verify(productLevel3Repository).findSummaryByFilter(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
      Mockito.any(), Mockito.anyList(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.eq(DEFAULT_PAGE_REQUEST), Mockito.any(), Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
      itemSummaryResponseList);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList);
    verify(getProductLevel3Converter()).convertProductLevel3InventoryToMapOfGdnSku(
      productLevel3InventoryList);
  }

  @Test
  public void findSummaryByGdnSkuTest() throws Exception {
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    MDC.put(GdnMandatoryRequestParameterUtil.USERNAME_KEY_PARAMETER,
      GdnBaseLookup.DEFAULT_USERNAME);
    ItemSummaryResponse itemSummaryResponse = generateItemSummaryData();
    itemSummaryResponse.setProductName(PRODUCT_NAME);
    itemSummaryResponse.setProductSku(DEFAULT_PRODUCT_SKU);
    itemSummaryResponse.setForceReview(true);
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any()))
      .thenReturn(itemSummaryResponse);
    ProductLevel3Summary response =
      this.productLevel3ServiceBean.findSummaryByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU);

    verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    Assertions.assertTrue(response.isMerchantPromoDiscount());
    Assertions.assertTrue(response.isMerchantPromoDiscountActivated());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(PRODUCT_NAME, response.getProductName());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, response.getProductSku());
  }

  @Test
  public void findSummaryByGdnSkuTestInventoryLevel2DataNull() throws Exception {
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    MDC.put(GdnMandatoryRequestParameterUtil.USERNAME_KEY_PARAMETER,
      GdnBaseLookup.DEFAULT_USERNAME);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.findSummaryByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3, "Gdn");
      });
    } catch (ApplicationRuntimeException e) {
      throw e;
    }
    verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(
        Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE_3, "Gdn");
  }

  @Test
  public void findSummaryByGdnSkuTestWithInventoryLevel1IdIsNull() throws Exception {
    this.productLevel3ServiceBean.findSummaryByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);

    verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
  }


  @Test
  public void findSummaryByGdnSkuTestWithInventoryLevel1IsNull() throws Exception {
    this.productLevel3ServiceBean.findSummaryByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);

    verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
  }

  @Test
  public void findSummaryByGdnSkuTestWithInventoryLevel2Null() throws Exception {
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(null);
    try {
      Assertions.assertThrows(Exception.class, () -> {
        this.productLevel3ServiceBean.findSummaryByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
            DEFAULT_GDN_SKU);
      });
    } catch (Exception e) {
      throw e;
    } finally {
      verify(getProductLevel3Repository()).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    }
  }


  @Test
  public void findSummaryByGdnSkuTestWithSyncedToLevel1IsFalse() throws Exception {
    this.productLevel3ServiceBean.findSummaryByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
  }

  public ItemSummaryResponse generateItemSummaryData() throws Exception {
    ItemSummaryResponse itemSummaryData =
      new ItemSummaryResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_MERCHANT_SKU,
        "itemName", new MasterCatalogDTO(), new ArrayList<SalesCatalogDTO>(),
        new HashSet<PriceDTO>(), new HashSet<ItemViewConfigDTO>(), ProductType.REGULAR,
        DEFAULT_PICKUP_POINT_CODE, new ArrayList<MasterDataItemImageDTO>(), false,
        DEFAULT_BUSINESS_PARTNER_CODE, "");
    List<DiscountPriceDTO> discountPrices = new ArrayList<DiscountPriceDTO>();
    DiscountPriceDTO discountPrice = new DiscountPriceDTO();
    discountPrice.setDiscountPrice(10000.0);
    discountPrice.setEndDateTime(new Date());
    discountPrice.setStartDateTime(new Date());
    discountPrices.add(discountPrice);
    itemSummaryData.getPrice().add(
      new PriceDTO(IDR_CURRENCY, 10000.0, 1000.0, ChannelName.DEFAULT.name(), discountPrices, null,
        null));
    itemSummaryData.getMasterCatalog().setCategory(new CategoryDTO());
    itemSummaryData.getMasterCatalog().getCategory().setCategoryCode(DEFAULT_CATEGORY_CODE);
    itemSummaryData.getPrice().add(
      new PriceDTO(IDR_CURRENCY, 10000.0, 1000.0, ChannelName.DEFAULT.name(),
        new ArrayList<DiscountPriceDTO>(), null, null));
    itemSummaryData.getItemViewConfigs().add(
      new ItemViewConfigDTO(true, true, ChannelName.DEFAULT.name(),
        new ItemDiscoverableScheduleDTO(), new ItemBuyableScheduleDTO()));
    itemSummaryData.getMasterDataItemImages().add(new MasterDataItemImageDTO(true, null, 0));
    itemSummaryData.setMerchantPromoDiscountActivated(true);
    itemSummaryData.setMerchantPromoDiscount(true);
    itemSummaryData.setVersion(2L);
    return itemSummaryData;
  }

  private Page<ItemSummaryResponse> generateItemSummaryResponse() throws Exception {
    List<ItemSummaryResponse> itemDatas = new ArrayList<ItemSummaryResponse>();
    ItemSummaryResponse itemData =
      new ItemSummaryResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_MERCHANT_SKU,
        "itemName", new MasterCatalogDTO(), new ArrayList<SalesCatalogDTO>(),
        new HashSet<PriceDTO>(), new HashSet<ItemViewConfigDTO>(), ProductType.REGULAR,
        DEFAULT_PICKUP_POINT_CODE, new ArrayList<MasterDataItemImageDTO>(), false,
        DEFAULT_BUSINESS_PARTNER_CODE, "");
    itemData.getMasterCatalog().setCategory(new CategoryDTO());
    itemData.getMasterCatalog().getCategory().setCategoryCode(DEFAULT_CATEGORY_CODE);
    itemData.setProductType(ProductType.REGULAR);
    List<DiscountPriceDTO> discountPrices = new ArrayList<DiscountPriceDTO>();
    DiscountPriceDTO discountPrice = new DiscountPriceDTO();
    discountPrice.setDiscountPrice(10000.0);
    discountPrice.setEndDateTime(new Date());
    discountPrice.setStartDateTime(new Date());
    discountPrices.add(discountPrice);
    itemData.getPrice().add(
      new PriceDTO(IDR_CURRENCY, 10000.0, 1000.0, ChannelName.DEFAULT.name(), discountPrices, null,
        null));
    itemData.getMasterDataItemImages().add(new MasterDataItemImageDTO(true, "locationPath", 1));
    itemData.getItemViewConfigs().add(new ItemViewConfigDTO(true, true, ChannelName.DEFAULT.name(),
      new ItemDiscoverableScheduleDTO(), new ItemBuyableScheduleDTO()));
    itemDatas.add(itemData);
    Pageable pageable = PageRequest.of(0, 10);
    return new PageImpl<ItemSummaryResponse>(itemDatas, pageable, 10);
  }

  private Product generateProduct() throws Exception {
    Product product = new Product();
    product.setId(UUID.randomUUID().toString());
    product.setProductCode(DEFAULT_PRODUCT_CODE);
    product.setProductItems(new ArrayList<ProductItem>());
    product.setStoreId(STOREID);
    ProductItem productItem = new ProductItem();
    productItem.setId(UUID.randomUUID().toString());
    productItem.setSkuCode(DEFAULT_SKU_CODE);
    productItem.setGeneratedItemName(ITEM_NAME);
    ProductItem productItem2 = new ProductItem();
    productItem2.setId(UUID.randomUUID().toString());
    productItem2.setSkuCode(DEFAULT_SKU_CODE_2);
    productItem2.setGeneratedItemName(ITEM_NAME);
    ProductItem productItem3 = new ProductItem();
    productItem3.setId(UUID.randomUUID().toString());
    productItem3.setSkuCode(DEFAULT_SKU_CODE_3);
    productItem3.setGeneratedItemName(ITEM_NAME);
    product.getProductItems().add(productItem);
    product.getProductItems().add(productItem2);
    product.getProductItems().add(productItem3);
    return product;
  }

  private ProductBusinessPartner generateProductBusinessPartner() throws Exception {
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setStoreId(STOREID);
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setProductItemBusinessPartners(
      new ArrayList<ProductItemBusinessPartner>());
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setProductType(GdnBaseLookup.PRODUCT_TYPE_REGULAR);
    productItemBusinessPartner.setPickupPointId(DEFAULT_PICKUP_POINT_CODE);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setProductItemId("");
    productItemBusinessPartner.setStock(1);
    productItemBusinessPartner.setPreOrderQuota(10);
    productItemBusinessPartner.setMinimumStock(2);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner2.setMerchantSku(DEFAULT_MERCHANT_SKU_2);
    productItemBusinessPartner2.setProductType(GdnBaseLookup.PRODUCT_TYPE_BIG_PRODUCT);
    productItemBusinessPartner2.setPickupPointId(DEFAULT_PICKUP_POINT_CODE);
    productItemBusinessPartner2.setSalePrice(10000.0);
    productItemBusinessPartner2.setPrice(10000.0);
    productItemBusinessPartner2.setBuyable(true);
    productItemBusinessPartner2.setDisplay(true);
    productItemBusinessPartner2.setStock(10);
    productItemBusinessPartner2.setMinimumStock(1);
    productItemBusinessPartner2.setGdnProductItemSku(ITEM_SKU_1);
    ProductItemBusinessPartner productItemBusinessPartner3 = new ProductItemBusinessPartner();
    productItemBusinessPartner3.setMerchantSku(DEFAULT_MERCHANT_SKU_3);
    productItemBusinessPartner3.setProductType(GdnBaseLookup.PRODUCT_TYPE_BOPIS);
    productItemBusinessPartner3.setPickupPointId(DEFAULT_PICKUP_POINT_CODE);
    productItemBusinessPartner3.setSalePrice(10000.0);
    productItemBusinessPartner3.setPrice(10000.0);
    productItemBusinessPartner3.setBuyable(true);
    productItemBusinessPartner3.setDisplay(true);
    productItemBusinessPartner3.setStock(0);
    productItemBusinessPartner3.setMinimumStock(1);
    productItemBusinessPartner3.setGdnProductItemSku(ITEM_SKU_2);
    productBusinessPartner.getProductItemBusinessPartners().add(productItemBusinessPartner);
    productBusinessPartner.getProductItemBusinessPartners().add(productItemBusinessPartner2);
    productBusinessPartner.getProductItemBusinessPartners().add(productItemBusinessPartner3);
    ProductBusinessPartnerAttribute productBusinessPartnerAttribute =
      new ProductBusinessPartnerAttribute();
    productBusinessPartnerAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productBusinessPartner.setProductBusinessPartnerAttributes(
      new ArrayList<ProductBusinessPartnerAttribute>());
    productBusinessPartner.getProductBusinessPartnerAttributes()
      .add(productBusinessPartnerAttribute);
    return productBusinessPartner;
  }

  private ProductAndItemsResponse generateProductData() throws Exception {
    ProductAndItemsResponse productData = new ProductAndItemsResponse(
      new ProductResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, ProductType.REGULAR,
        DEFAULT_SETTLEMENT_TYPE, DEFAULT_BUSINESS_PARTNER_CODE, true, DEFAULT_CATENTRY_ID,
        new MasterCatalogDTO(), new ArrayList<SalesCatalogDTO>(), new MasterDataProductDTO(),
        new ArrayList<ProductAttributeDTO>(), new ArrayList<ProductAttributeDetailDTO>(),
        new ArrayList<ProductSpecialAttributeDTO>(), new ArrayList<ItemCatalogDTO>(),
        new ArrayList<SalesCategorySequenceDTO>()), new ArrayList<ItemResponse>());
    productData.getProduct().getMasterCatalog().setCategory(new CategoryDTO());
    productData.getProduct().getMasterCatalog().getCategory()
      .setCategoryCode(DEFAULT_CATEGORY_CODE);
    productData.getProduct().getMasterDataProduct().setDescription(PRODUCT_DESCRIPTION1);
    productData.getProduct().getMasterDataProduct().setProductName(PRODUCT_NAME1);
    productData.getProduct().getMasterDataProduct().setBrand(BRAND);
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(PRODUCT_USP1);
    productData.getProduct().getMasterDataProduct()
      .setMasterDataProductAttributes(new ArrayList<MasterDataProductAttributeDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes()
      .add(new MasterDataProductAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes()
      .add(new MasterDataProductAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes()
      .add(new MasterDataProductAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes()
      .add(new MasterDataProductAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setVariantCreation(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setBasicView(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setMandatory(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setSkuValue(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataProductAttributeValues().add(new MasterDataProductAttributeValueDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .getMasterDataAttribute().setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .getMasterDataAttribute().setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .getMasterDataAttribute().setBasicView(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .getMasterDataAttribute().setMandatory(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .getMasterDataAttribute().setSkuValue(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .getMasterDataAttribute().setSkuValue(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .getMasterDataAttribute().setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .getMasterDataAttribute().setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .getMasterDataAttribute().setBasicView(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .getMasterDataAttribute().setMandatory(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .getMasterDataAttribute().setSkuValue(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .getMasterDataProductAttributeValues().add(new MasterDataProductAttributeValueDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(3)
      .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(3)
      .getMasterDataAttribute().setAttributeType(MasterDataAttributeType.DEFINING_ATTRIBUTE);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(3)
      .getMasterDataAttribute().setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(3)
      .getMasterDataAttribute().setBasicView(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(3)
      .getMasterDataAttribute().setMandatory(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(3)
      .getMasterDataAttribute().setSkuValue(false);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(3)
      .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(3)
      .getMasterDataProductAttributeValues().add(new MasterDataProductAttributeValueDTO());
    productData.getProduct()
      .setProductSpecialAttributes(new ArrayList<ProductSpecialAttributeDTO>());
    productData.getProduct().getProductSpecialAttributes().add(new ProductSpecialAttributeDTO());
    productData.getProduct().getProductSpecialAttributes().get(0)
      .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productData.getProduct().setDescriptiveAttributes(new ArrayList<ProductAttributeDetailDTO>());
    productData.getProduct().getDescriptiveAttributes().add(new ProductAttributeDetailDTO());
    productData.getProduct().getDescriptiveAttributes().add(new ProductAttributeDetailDTO());
    productData.getProduct().getDescriptiveAttributes().get(0)
      .setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    productData.getProduct().getDescriptiveAttributes().get(1)
      .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productData.getProduct().setDefiningAttributes(new ArrayList<ProductAttributeDTO>());
    productData.getProduct().getDefiningAttributes().add(new ProductAttributeDTO());
    productData.getProduct().getDefiningAttributes().get(0)
      .setProductAttributeDetails(new ArrayList<ProductAttributeDetailDTO>());
    productData.getProduct().getDefiningAttributes().get(0).getProductAttributeDetails()
      .add(new ProductAttributeDetailDTO());
    productData.getProduct().getDefiningAttributes().get(0).getProductAttributeDetails().get(0)
      .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productData.getItems().add(
      new ItemResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_SKU, DEFAULT_MERCHANT_SKU, DEFAULT_SKU_CODE,
        true, DEFAULT_CATENTRYITEM_ID, new MasterDataItemDTO(), new HashSet<PriceDTO>(),
        new HashSet<ItemViewConfigDTO>(), false, DEFAULT_PICKUP_POINT_CODE, null, null));
    productData.getItems().get(0).setArchived(false);
    productData.getItems().get(0).setMerchantPromoDiscount(true);
    productData.getItems().get(0).setMerchantPromoDiscountActive(true);
    productData.getItems().get(0).setPriceEditDisabled(false);
    productData.getItems().get(0).setVersion(Long.valueOf(2));
    List<DiscountPriceDTO> discountPrices = new ArrayList<DiscountPriceDTO>();
    DiscountPriceDTO discountPrice = new DiscountPriceDTO();
    discountPrice.setDiscountPrice(10000.0);
    discountPrice.setEndDateTime(new Date());
    discountPrice.setStartDateTime(new Date());
    discountPrices.add(discountPrice);
    productData.getItems().get(0).getPrice().add(
      new PriceDTO(IDR_CURRENCY, 10000.0, 1000.0, ChannelName.DEFAULT.name(), discountPrices, null,
        null));
    productData.getItems().get(0).getItemViewConfigs().add(
      new ItemViewConfigDTO(true, true, ChannelName.DEFAULT.name(),
        new ItemDiscoverableScheduleDTO(), new ItemBuyableScheduleDTO()));
    PristineDataItemDto pristineDataItem = new PristineDataItemDto();
    pristineDataItem.setPristineId(PRISTINE_ID);
    productData.getItems().get(0).setPristineDataItem(pristineDataItem);
    productData.getItems().get(0).getMasterDataItem()
      .setMasterDataItemImages(new ArrayList<MasterDataItemImageDTO>());
    productData.getItems().get(0).getMasterDataItem().getMasterDataItemImages()
      .add(new MasterDataItemImageDTO(true, null, 0));
    productData.getProduct().getMasterDataProduct()
      .setMasterDataProductImages(new ArrayList<MasterDataProductImageDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductImages()
      .add(new MasterDataProductImageDTO(true, null, DEFAULT_PRODUCT_CODE, 0));
    productData.getProduct().setForceReview(false);
    productData.getProduct()
      .setProductScore(new ProductScoreResponse(10, 10, 10, 10, 10, 10, 10, 10, 10, 1, 90));
    return productData;
  }

  private ProductAndItemsResponse generateProductData1() throws Exception {
    ProductAndItemsResponse productData = new ProductAndItemsResponse(
      new ProductResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_CODE, ProductType.REGULAR,
        DEFAULT_SETTLEMENT_TYPE, DEFAULT_BUSINESS_PARTNER_CODE, true, DEFAULT_CATENTRY_ID,
        new MasterCatalogDTO(), new ArrayList<SalesCatalogDTO>(), new MasterDataProductDTO(),
        new ArrayList<ProductAttributeDTO>(), new ArrayList<ProductAttributeDetailDTO>(),
        new ArrayList<ProductSpecialAttributeDTO>(), new ArrayList<ItemCatalogDTO>(),
        new ArrayList<SalesCategorySequenceDTO>()), new ArrayList<ItemResponse>());
    productData.getProduct().getMasterCatalog().setCategory(new CategoryDTO());
    productData.getProduct().getMasterCatalog().getCategory()
      .setCategoryCode(DEFAULT_CATEGORY_CODE);
    productData.getProduct().getMasterDataProduct().setDescription("DESCRIPTON");
    productData.getProduct().getMasterDataProduct()
      .setMasterDataProductAttributes(new ArrayList<MasterDataProductAttributeDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes()
      .add(new MasterDataProductAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes()
      .add(new MasterDataProductAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes()
      .add(new MasterDataProductAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataProductAttributeValues().add(new MasterDataProductAttributeValueDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .getMasterDataAttribute().setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .getMasterDataAttribute().setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(1)
      .getMasterDataAttribute().setSkuValue(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .getMasterDataAttribute().setAttributeType(MasterDataAttributeType.DEFINING_ATTRIBUTE);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .getMasterDataAttribute().setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .getMasterDataAttribute().setBasicView(true);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(2)
      .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getProduct()
      .setProductSpecialAttributes(new ArrayList<ProductSpecialAttributeDTO>());
    productData.getProduct().getProductSpecialAttributes().add(new ProductSpecialAttributeDTO());
    productData.getProduct().getProductSpecialAttributes().get(0)
      .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productData.getProduct().setDescriptiveAttributes(new ArrayList<ProductAttributeDetailDTO>());
    productData.getProduct().getDescriptiveAttributes().add(new ProductAttributeDetailDTO());
    productData.getProduct().getDescriptiveAttributes().add(new ProductAttributeDetailDTO());
    productData.getProduct().getDescriptiveAttributes().get(0)
      .setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    productData.getProduct().getDescriptiveAttributes().get(1)
      .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productData.getProduct().setDefiningAttributes(new ArrayList<ProductAttributeDTO>());
    productData.getProduct().getDefiningAttributes().add(new ProductAttributeDTO());
    productData.getProduct().getDefiningAttributes().get(0)
      .setProductAttributeDetails(new ArrayList<ProductAttributeDetailDTO>());
    productData.getProduct().getDefiningAttributes().get(0).getProductAttributeDetails()
      .add(new ProductAttributeDetailDTO());
    productData.getProduct().getDefiningAttributes().get(0).getProductAttributeDetails().get(0)
      .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productData.getItems().add(
      new ItemResponse(DEFAULT_GDN_SKU, DEFAULT_PRODUCT_SKU, DEFAULT_MERCHANT_SKU, DEFAULT_SKU_CODE,
        true, DEFAULT_CATENTRYITEM_ID, new MasterDataItemDTO(), new HashSet<PriceDTO>(),
        new HashSet<ItemViewConfigDTO>(), false, DEFAULT_PICKUP_POINT_CODE, null, null));
    productData.getItems().get(0).setArchived(false);
    productData.getItems().get(0).setMerchantPromoDiscount(true);
    productData.getItems().get(0).setMerchantPromoDiscountActive(true);
    productData.getItems().get(0).setPriceEditDisabled(true);
    List<DiscountPriceDTO> discountPrices = new ArrayList<DiscountPriceDTO>();
    DiscountPriceDTO discountPrice = new DiscountPriceDTO();
    discountPrice.setDiscountPrice(10000.0);
    discountPrice.setEndDateTime(new Date());
    discountPrice.setStartDateTime(new Date());
    discountPrices.add(discountPrice);
    productData.getItems().get(0).getPrice().add(
      new PriceDTO(IDR_CURRENCY, 10000.0, 1000.0, ChannelName.DEFAULT.name(), discountPrices, null,
        null));
    productData.getItems().get(0).getItemViewConfigs().add(
      new ItemViewConfigDTO(true, true, ChannelName.DEFAULT.name(),
        new ItemDiscoverableScheduleDTO(), new ItemBuyableScheduleDTO()));
    PristineDataItemDto pristineDataItem = new PristineDataItemDto();
    pristineDataItem.setPristineId(PRISTINE_ID);
    productData.getItems().get(0).setPristineDataItem(pristineDataItem);
    productData.getItems().get(0).getMasterDataItem()
      .setMasterDataItemImages(new ArrayList<MasterDataItemImageDTO>());
    productData.getItems().get(0).getMasterDataItem().getMasterDataItemImages()
      .add(new MasterDataItemImageDTO(true, null, 0));
    productData.getProduct().getMasterDataProduct()
      .setMasterDataProductImages(new ArrayList<MasterDataProductImageDTO>());
    productData.getProduct().getMasterDataProduct().getMasterDataProductImages()
      .add(new MasterDataProductImageDTO(true, null, DEFAULT_PRODUCT_CODE, 0));
    productData.getProduct().setForceReview(true);
    return productData;
  }

  private ItemRequest generateItemRequest(ProductItemLevel3 item, String productSku,
    List<ProductLevel3Attribute> attributes) {
    ItemRequest itemRequest = new ItemRequest();
    itemRequest.setItemCode(item.getSkuCode());
    itemRequest.setItemSku(item.getItemSku());
    itemRequest.setLateFulfillment(item.getLateFulfillment());
    itemRequest.setMerchantSku(item.getMerchantSku());
    itemRequest.setPickupPointCode(item.getPickupPointCode());
    itemRequest.setProductSku(productSku);
    itemRequest.setShippingWeight(item.getShippingWeight());
    MasterDataItemDTO masterDataItemDTO = new MasterDataItemDTO();
    masterDataItemDTO.setDangerousLevel(item.getDangerousGoodsLevel());
    masterDataItemDTO.setGeneratedItemName(item.getItemName());
    masterDataItemDTO.setItemDeliveryWeight(item.getShippingWeight());
    masterDataItemDTO.setItemWeight(item.getWeight());
    masterDataItemDTO.setItemHeight(item.getHeight());
    masterDataItemDTO.setItemLength(item.getLength());
    masterDataItemDTO.setItemWidth(item.getWidth());
    masterDataItemDTO.setSkuCode(item.getSkuCode());
    masterDataItemDTO.setUpcCode(item.getUpcCode());
    masterDataItemDTO.setMasterDataItemAttributeValues(
      new ArrayList<MasterDataItemAttributeValueDTO>());
    masterDataItemDTO.setMasterDataItemImages(new ArrayList<MasterDataItemImageDTO>());
    for (ProductLevel3Attribute attribute : attributes) {
      if (!attribute.getSkuValue()) {
        if (MasterDataAttributeType.DEFINING_ATTRIBUTE.equals(
          MasterDataAttributeType.valueOf(attribute.getAttributeType()))) {
          MasterDataItemAttributeValueDTO attributeDTO = new MasterDataItemAttributeValueDTO();
          attributeDTO.setAttributeValue(attribute.getValues().get(0));
          attributeDTO.setMasterDataAttribute(new MasterDataAttributeDTO());
          attributeDTO.getMasterDataAttribute().setAttributeCode(attribute.getAttributeCode());
          attributeDTO.getMasterDataAttribute()
            .setAttributeType(MasterDataAttributeType.valueOf(attribute.getAttributeType()));
          attributeDTO.getMasterDataAttribute().setAttributeName(attribute.getAttributeName());
          attributeDTO.getMasterDataAttribute().setSkuValue(attribute.getSkuValue());
          masterDataItemDTO.getMasterDataItemAttributeValues().add(attributeDTO);
        }
      }
    }
    for (ProductLevel3Image image : item.getImages()) {
      MasterDataItemImageDTO img = new MasterDataItemImageDTO();
      img.setLocationPath(image.getLocationPath());
      img.setMainImage(image.getMainImage());
      img.setSequence(image.getSequence());
      masterDataItemDTO.getMasterDataItemImages().add(img);
    }
    itemRequest.setMasterDataItem(masterDataItemDTO);
    itemRequest.setPrice(new HashSet<PriceRequest>());
    for (ProductLevel3Price price : item.getPrices()) {
      PriceRequest priceRequest = new PriceRequest();
      priceRequest.setListPrice(price.getPrice());
      priceRequest.setOfferPrice(price.getSalePrice());
      priceRequest.setChannel(price.getChannelId());
      itemRequest.getPrice().add(priceRequest);
    }
    for (ProductLevel3Price price : item.getPrices()) {
      PriceRequest priceRequest = new PriceRequest();
      priceRequest.setListPrice(price.getPrice());
      priceRequest.setOfferPrice(price.getSalePrice());
      priceRequest.setChannel(price.getChannelId());
      itemRequest.getPrice().add(priceRequest);
    }
    itemRequest.setItemViewConfigs(new HashSet<ItemViewConfigRequest>());
    for (ProductLevel3ViewConfig viewConfig : item.getViewConfigs()) {
      ItemViewConfigRequest itemViewConfig = new ItemViewConfigRequest();
      itemViewConfig.setBuyable(viewConfig.getBuyable());
      itemViewConfig.setDiscoverable(viewConfig.getDisplay());
      itemViewConfig.setChannel(viewConfig.getChannelId());
      itemRequest.getItemViewConfigs().add(itemViewConfig);
    }
    return itemRequest;
  }

  private ProductAndItemsResponse generateProductDataWithoutDiscount() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getItems().get(0).setPrice(new HashSet<PriceDTO>());
    productData.getItems().get(0).getPrice().add(
      new PriceDTO(IDR_CURRENCY, 10000.0, 1000.0, ChannelName.DEFAULT.name(),
        new ArrayList<DiscountPriceDTO>(), null, null));
    return productData;
  }

  private ProductDetailResponse generateProductDetailResponse() throws Exception {
    ProductDetailResponse product = new ProductDetailResponse();
    product.setId(UUID.randomUUID().toString());
    product.setProductCode(DEFAULT_PRODUCT_CODE);
    product.setProductItemResponses(new HashSet<ProductItemResponse>());
    product.setStoreId(STOREID);
    ProductItemResponse productItem = new ProductItemResponse();
    productItem.setId(UUID.randomUUID().toString());
    productItem.setSkuCode(DEFAULT_SKU_CODE);
    ProductItemResponse productItem2 = new ProductItemResponse();
    productItem2.setId(UUID.randomUUID().toString());
    productItem2.setSkuCode(DEFAULT_SKU_CODE_2);
    ProductItemResponse productItem3 = new ProductItemResponse();
    productItem3.setId(UUID.randomUUID().toString());
    productItem3.setSkuCode(DEFAULT_SKU_CODE_3);
    product.getProductItemResponses().add(productItem);
    product.getProductItemResponses().add(productItem2);
    product.getProductItemResponses().add(productItem3);
    product.setVideoDTO(new VideoDTO());
    return product;
  }

  private ProductItemLevel3 generateProductItemLevel3() {
    ProductItemLevel3 item =
      new ProductItemLevel3(DEFAULT_ITEM_SKU, DEFAULT_SKU_CODE, DEFAULT_MERCHANT_SKU,
        DEFAULT_UPC_CODE, DEFAULT_ITEM_NAME, DEFAULT_LENGTH, DEFAULT_WIDTH, DEFAULT_HEIGHT,
        DEFAULT_WEIGHT, DEFAULT_SHIPPING_WEIGHT, DEFAULT_DANGEROUS_LEVEL, DEFAULT_LATE_FULLFILLMENT,
        DEFAULT_PICKUP_POINT_CODE, DEFAULT_PICKUP_POINT_NAME, STOCK_AVAILABLE_1, STOCK_RESERVED_1,
        STOCK_AVAILABLE_2, STOCK_RESERVED_2, MIN_STOCK, DEFAULT_SYNCHRONIZE,
        new ArrayList<ProductLevel3Price>(), new ArrayList<ProductLevel3ViewConfig>(),
        new ArrayList<ProductLevel3Image>(), new ArrayList<ProductLevel3Logistics>());
    ProductLevel3Price price =
      new ProductLevel3Price(DEFAULT_CHANNEL_ID, DEFAULT_PRICE, DEFAULT_SALE_PRICE,
        DEFAULT_DISCOUNT, DISCOUNT_START, DISCOUNT_END, PROMOTION_NAME);
    item.getPrices().add(price);
    item.setOff2OnActiveFlag(true);
    ProductLevel3ViewConfig viewConfig =
      new ProductLevel3ViewConfig(DEFAULT_CHANNEL_ID, DEFAULT_DISPLAY, DEFAULT_BUYABLE);
    item.getViewConfigs().add(viewConfig);
    ProductLevel3Image image =
      new ProductLevel3Image(DEFAULT_MAIN_IMAGE, DEFAULT_SEQUENCE, DEFAULT_LOCATION_PATH);
    item.getImages().add(image);
    return item;
  }

  private ProductLevel3 generateProductLevel3() {
    ProductLevel3 product =
      new ProductLevel3(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_BUSINESS_PARTNER_CODE,
        false, DEFAULT_PRODUCT_NAME, DEFAULT_PRODUCT_TYPE, DEFAULT_CATEGORY_CODE,
        DEFAULT_CATEGORY_NAME, DEFAULT_CATEGORY_HIERARCHY, DEFAULT_BRAND, DEFAULT_DESCRIPTION,
        DEFAULT_SPECIFICATION, DEFAULT_UNIQUE_SELLING_POINT, DEFAULT_PRODUCT_STORY,
        new ArrayList<ProductItemLevel3>(), new ArrayList<ProductLevel3Attribute>(),
        new ArrayList<ProductLevel3Image>());
    ProductItemLevel3 item = generateProductItemLevel3();
    product.getItems().add(item);
    ProductLevel3Attribute attribute =
      new ProductLevel3Attribute(DEFAULT_ATTRIBUTE_CODE, DEFAULT_ATTRIBUTE_TYPE,
        new ArrayList<String>(), false);
    String value = "value test";
    attribute.getValues().add(value);
    product.getAttributes().add(attribute);
    ProductLevel3Image image = new ProductLevel3Image(false, 1, "location Path");
    product.getImages().add(image);
    product.setInstallationRequired(false);
    return product;
  }

  private ProductLevel3 generateProductLevel3_2() {
    ProductLevel3 product =
      new ProductLevel3(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_CODE, DEFAULT_BUSINESS_PARTNER_CODE,
        false, DEFAULT_PRODUCT_NAME, DEFAULT_PRODUCT_TYPE, DEFAULT_CATEGORY_CODE,
        DEFAULT_CATEGORY_NAME, DEFAULT_CATEGORY_HIERARCHY, DEFAULT_BRAND, DEFAULT_DESCRIPTION,
        DEFAULT_SPECIFICATION, DEFAULT_UNIQUE_SELLING_POINT, DEFAULT_PRODUCT_STORY,
        new ArrayList<ProductItemLevel3>(), new ArrayList<ProductLevel3Attribute>(),
        new ArrayList<ProductLevel3Image>());
    ProductItemLevel3 item = generateProductItemLevel3();
    product.getItems().add(item);
    ProductLevel3Attribute attribute =
      new ProductLevel3Attribute(DEFAULT_ATTRIBUTE_CODE, DEFAULT_ATTRIBUTE_TYPE_2,
        new ArrayList<String>(), true);
    String value = "value test";
    attribute.getValues().add(value);
    product.getAttributes().add(attribute);
    ProductLevel3Image image = new ProductLevel3Image(false, 1, "location Path");
    product.getImages().add(image);
    product.setInstallationRequired(false);
    return product;
  }

  private ProductLevel3UpdateSummary generateProductLevel3UpdateSummary() {
    ProductLevel3UpdateSummary productLevel3UpdateSummary = new ProductLevel3UpdateSummary();
    productLevel3UpdateSummary.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productLevel3UpdateSummary.setProductType(1);
    productLevel3UpdateSummary.setVersion(3L);
    productLevel3UpdateSummary.setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    productLevel3UpdateSummary.setLateFulfillment(true);
    productLevel3UpdateSummary.setDeltaStock(0);
    productLevel3UpdateSummary.setSynchronizeStock(true);
    productLevel3UpdateSummary.setPrices(new ArrayList<>());
    productLevel3UpdateSummary.setViewConfigs(new ArrayList<>());
    ProductLevel3Price productLevel3Price = new ProductLevel3Price();
    productLevel3UpdateSummary.getPrices()
      .add(new ProductLevel3Price(ChannelName.DEFAULT.name(), 10000.0, 10000.0));
    productLevel3UpdateSummary.getPrices().get(0).setDiscountAmount(5000.0);
    productLevel3UpdateSummary.getViewConfigs()
      .add(new ProductLevel3ViewConfig(ChannelName.DEFAULT.name(), true, true));
    productLevel3UpdateSummary.setOff2OnActiveFlag(true);
    productLevel3UpdateSummary.setWholesalePriceActivated(true);
    return productLevel3UpdateSummary;
  }

  private ProductLevel3UpdateSummary generateProductLevel3UpdateSummaryNull() {
    ProductLevel3UpdateSummary productLevel3UpdateSummary = new ProductLevel3UpdateSummary();
    productLevel3UpdateSummary.setMerchantSku(null);
    productLevel3UpdateSummary.setProductType(null);
    productLevel3UpdateSummary.setPickupPointCode(null);
    productLevel3UpdateSummary.setLateFulfillment(null);
    productLevel3UpdateSummary.setDeltaStock(null);
    productLevel3UpdateSummary.setSynchronizeStock(null);
    productLevel3UpdateSummary.setPrices(new ArrayList<>());
    productLevel3UpdateSummary.setViewConfigs(new ArrayList<>());
    return productLevel3UpdateSummary;
  }

  public UpdatedProductHistoryService getUpdatedProductHistoryService() {
    return updatedProductHistoryService;
  }

  public BusinessPartnerRepository getBusinessPartnerRepository() {
    return businessPartnerRepository;
  }

  public CategoryRepository getCategoryRepository() {
    return categoryRepository;
  }

  @Test
  public void getItemTest() throws Exception {
    this.productLevel3ServiceBean.getItem(DEFAULT_GDN_SKU);
    verify(productLevel3Repository).getItem(DEFAULT_GDN_SKU);
  }

  public PickupPointRepository getPickupPointRepository() {
    return pickupPointRepository;
  }

  public ProductBusinessPartnerService getProductBusinessPartnerService() {
    return productBusinessPartnerService;
  }

  public ProductInventoryService getProductInventoryService() {
    return productInventoryService;
  }

  public ProductLevel3Converter getProductLevel3Converter() {
    return productLevel3Converter;
  }

  public ProductLevel3InventoryService getProductLevel3InventoryService() {
    return productLevel3InventoryService;
  }

  public ProductLevel3Repository getProductLevel3Repository() {
    return productLevel3Repository;
  }

  @Test
  public void getProductsCountByBrandTest() throws Exception {
    this.productLevel3ServiceBean.getProductsCountByBrand(BRAND);
    verify(getProductLevel3Repository()).getProductCountByBrand(Mockito.any());
  }

  @Test
  public void getProductTest() throws Exception {
    this.productLevel3ServiceBean.getProduct(DEFAULT_PRODUCT_SKU);
    verify(productLevel3Repository).getProduct(DEFAULT_PRODUCT_SKU);
  }

  @SuppressWarnings("unchecked")
  @BeforeEach
  public void initializeTest() throws Exception {
    MockitoAnnotations.initMocks(this);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "maxWholesalePriceRequests", 5);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "mppAllowedSellers",
      Constants.CM_MERCHANT);
    ReflectionTestUtils.setField(productLevel3ServiceBean,"instoreNewFlowEnabled", true);
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    mandatoryRequestParam =
      MandatoryRequestParam.generateMandatoryRequestParam(STOREID, CHANNELID, CLIENTID, REQUESTID,
        USERNAME, null);

    org.apache.log4j.MDC.put(GdnMandatoryRequestParameterUtil.STORE_ID_KEY_PARAMETER, STOREID);
    org.apache.log4j.MDC.put(GdnMandatoryRequestParameterUtil.CHANNEL_ID_KEY_PARAMETER, CHANNELID);
    org.apache.log4j.MDC.put(GdnMandatoryRequestParameterUtil.CLIENT_ID_KEY_PARAMETER, CLIENTID);
    org.apache.log4j.MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, REQUESTID);
    org.apache.log4j.MDC.put(GdnMandatoryRequestParameterUtil.USERNAME_KEY_PARAMETER, USERNAME);
    org.apache.log4j.MDC.put(GdnMandatoryRequestParameterUtil.AUTHENTICATOR_KEY, null);

    ProductAndItemsResponse productData = generateProductData();
    CategoryResponse categoryResponse1 =
      new CategoryResponse("C2", DEFAULT_CATEGORY_CODE, 0, null, "".getBytes(), "".getBytes(), null,
        true, 100, true, false, true, new CatalogResponse(), null);
    categoryResponse1.setId("id1");

    CategoryResponse categoryResponse2 =
      new CategoryResponse("C1", null, 0, null, "".getBytes(), "".getBytes(), null, true, 100, true,
        false, true, new CatalogResponse(), null);
    categoryResponse2.setId("id2");

    categoriesData = new ArrayList<CategoryResponse>();
    categoriesData.add(categoryResponse1);
    categoriesData.add(categoryResponse2);

    sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType("gold");

    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3Inventory = new ProductLevel3Inventory();
    productLevel3Inventory.setWarehouseItemSku(DEFAULT_SKU_CODE);
    productLevel3Inventory.setWebItemSku(DEFAULT_GDN_SKU);
    productLevel3Inventory.setWarehouseAvailable(10);
    productLevel3Inventory.setWebAvailable(10);
    productLevel3Inventory.setWebReserved(1);
    productLevel3Inventory.setWebSyncStock(true);
    productLevel3Inventory.setWebMinAlert(2);
    productLevel3Inventory2 = new ProductLevel3Inventory();
    productLevel3Inventory2.setWarehouseItemSku(null);
    productLevel3Inventory2.setWebItemSku(DEFAULT_GDN_SKU_2);
    productLevel3Inventory2.setWarehouseAvailable(10);
    productLevel3Inventory2.setWebAvailable(10);
    productLevel3Inventory2.setWebSyncStock(false);
    productLevel3Inventory2.setWebMinAlert(2);
    productLevel3Inventory3 = new ProductLevel3Inventory();
    productLevel3Inventory3.setWarehouseItemSku(DEFAULT_SKU_CODE);
    productLevel3Inventory3.setWebItemSku(DEFAULT_GDN_SKU_4);
    productLevel3Inventory3.setWarehouseAvailable(10);
    productLevel3Inventory3.setWebAvailable(10);
    productLevel3Inventory3.setWebSyncStock(false);
    productLevel3Inventory3.setWebMinAlert(0);
    productLevel3Inventory3.setWebPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    productLevel3InventoryList = new ArrayList<>();
    productLevel3InventoryList.add(productLevel3Inventory);

    pickupPointData = new PickupPointResponse();
    pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponse.setCode(DEFAULT_PICKUP_POINT_CODE);
    pickupPointResponseList = new ArrayList<>();
    pickupPointResponseList.add(pickupPointResponse);
    productItemSummaryDatas = new ArrayList<ItemSummaryResponse>();
    productItemSummaryDatas.add(generateItemSummaryData());
    productItemSummaryDatas.add(generateItemSummaryData());
    productItemSummaryDatas.get(1).setItemSku(DEFAULT_GDN_SKU_2);
    productItemSummaryDatas.add(generateItemSummaryData());
    productItemSummaryDatas.get(2).setItemSku(DEFAULT_GDN_SKU_4);
    Page<ItemSummaryResponse> productItemSummaryDatasPage =
      new PageImpl<ItemSummaryResponse>(productItemSummaryDatas, DEFAULT_PAGEABLE, 3);
    attribute = new AttributeResponse();
    attribute.setId(DEFAULT_ATTRIBUTE_ID);
    attribute.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    AddProductAndItemsResponse addProductAndItemsResponse = new AddProductAndItemsResponse();
    addProductAndItemsResponse.setProductSku(DEFAULT_PRODUCT_SKU);
    addProductAndItemsResponse.setMapOfItemSkuByItemCode(new HashMap<String, String>());
    addProductAndItemsResponse.getMapOfItemSkuByItemCode().put(DEFAULT_SKU_CODE, DEFAULT_GDN_SKU);

    businessPartnerData = new ProfileResponse();
    businessPartnerData.setActivated(true);
    businessPartnerData.setMerchantStatus(Constants.ACTIVE);
    businessPartnerData.setCompany(CompanyDTO.builder().merchantDeliveryType(PICKUP).build());
    businessPartnerData.getCompany().setInventoryFulfillment(INVENTORY_FULFILLMENT_BLIBLI);
    businessPartnerData.getCompany().setPurchaseTerm(GdnBaseLookup.PURCHASE_TERM_COMMISSION);

    Set<String> categoryIds1 = new HashSet<>();
    categoryIds1.add("id1");

    Set<String> categoryIds2 = new HashSet<>();
    categoryIds1.add("id2");
    map.put("testCategory1", categoryIds1);
    map.put("testCategory2", categoryIds2);
    itemSkuAndPickupCodeMap.put(ITEM_SKU, PICKUP_POINT_CODE);

    ProfileResponse businessPartnerData2 = new ProfileResponse();
    businessPartnerData2.setActivated(true);
    businessPartnerData2.setMerchantStatus(Constants.ACTIVE);
    businessPartnerData2.setCompany(new CompanyDTO());
    businessPartnerData2.getCompany()
      .setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BUSINESS_PARTNER);

    ProfileResponse businessPartnerData3 = new ProfileResponse();
    businessPartnerData3.setActivated(true);
    businessPartnerData3.setMerchantStatus(Constants.ACTIVE);
    businessPartnerData3.setCompany(new CompanyDTO());
    businessPartnerData3.getCompany().setInventoryFulfillment(INVENTORY_FULFILLMENT_BLIBLI);
    businessPartnerData3.getCompany().setPurchaseTerm(GdnBaseLookup.PURCHASE_TERM_PURCHASE_ORDER);
    SimpleBooleanResponse simpleBooleanResponse = new SimpleBooleanResponse(true);

    itemPriceResponses = new ArrayList<>();
    for (int i = 1; i <= 4; i++) {
      ItemPriceResponse itemPriceResponse = new ItemPriceResponse();
      itemPriceResponse.setMerchantCode(MERCHANT_CODE_1);
      itemPriceResponse.setItemSku(ITEM_SKU + i);
      itemPriceResponse.setListPrice(i * 3.0);
      itemPriceResponse.setOfferPrice(i * 2.0);
      itemPriceResponses.add(itemPriceResponse);
    }

    for (int i = 1; i <= 2; i++) {
      ItemPriceResponse itemPriceResponse = new ItemPriceResponse();
      itemPriceResponse.setMerchantCode(MERCHANT_CODE_1);
      itemPriceResponse.setItemSku(ITEM_SKU + 10 + i);
      itemPriceResponse.setListPrice(i * 3.0);
      itemPriceResponse.setOfferPrice(i * 2.0);
      itemPriceResponses.add(itemPriceResponse);
    }
    inventoryByGdnSkuMap = new ArrayList<>();
    ProductLevel3Inventory productLevel3InventoryForItemPrice = new ProductLevel3Inventory();
    productLevel3InventoryForItemPrice.setWebItemSku(ITEM_SKU + 1);
    productLevel3InventoryForItemPrice.setWebAvailable(2);
    inventoryByGdnSkuMap.add(productLevel3InventoryForItemPrice);
    productLevel3InventoryForItemPrice = new ProductLevel3Inventory();
    productLevel3InventoryForItemPrice.setWebItemSku(ITEM_SKU + 101);
    productLevel3InventoryForItemPrice.setWebAvailable(0);
    inventoryByGdnSkuMap.add(productLevel3InventoryForItemPrice);

    this.pbpStockAlert = new PbpStockAlert();
    this.pbpStockAlert.setId(DEFAULT_REQUEST_ID);
    this.pbpStockAlert2 = new PbpStockAlert();
    this.pbpStockAlert2.setId(DEFAULT_REQUEST_ID);
    this.listPbpStockAlert = new ArrayList<PbpStockAlert>();
    this.listPbpStockAlert.add(this.pbpStockAlert);
    this.listPbpStockAlert.get(0).setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    this.listPbpStockAlert.get(0).setIsOos(true);
    this.listPbpStockAlert2 = new ArrayList<PbpStockAlert>();
    this.listPbpStockAlert2.add(this.pbpStockAlert2);
    this.listPbpStockAlert2.get(0).setIsOos(false);
    this.listProductStockAlert = new ArrayList<String>();
    this.listProductStockAlert.add(DEFAULT_BUSINESS_PARTNER_CODE);

    productSuspensionHistory.setProductSku(DEFAULT_PRODUCT_SKU);
    productSuspensionHistory.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productSuspensionHistory.setStoreId(DEFAULT_STORE_ID);
    productSuspensionHistory.setDescription(DEFAULT_DESCRIPTION);
    List<ProductSuspensionHistory> historyList = Arrays.asList(productSuspensionHistory);
    Page<ProductSuspensionHistory> productSuspensionHistories =
      new PageImpl<>(historyList, DEFAULT_PAGE_REQUEST, 10);
    itemSkus = new ArrayList<>(Arrays.asList(ITEM_SKU, ITEM_SKU_1, ITEM_SKU_2));
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", false);
    Mockito.when(getProductLevel3Repository().getItemSkusToFetchEstimatedPrice(ITEM_CODE))
      .thenReturn(itemPriceResponses);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    when(productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(
      any(ProductDetailResponse.class), any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    Mockito.when(
        getCategoryRepository().findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE)))
      .thenReturn(categoriesData);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_ITEM_SKU)))
      .thenReturn(productLevel3Inventory);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productLevel3Inventory);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productLevel3Inventory2);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_3), Mockito.eq(DEFAULT_GDN_SKU_4)))
      .thenReturn(productLevel3Inventory3);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productLevel3Inventory);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_3), Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productLevel3Inventory);
    Mockito.when(getPickupPointRepository().findByPickupPointCode(Mockito.any()))
      .thenReturn(pickupPointData);
    Mockito.when(
        getProductLevel3Repository().findSummaryByFilter(Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          (PageRequest) Mockito.any(), Mockito.anyBoolean(), Mockito.any()))
      .thenReturn(productItemSummaryDatasPage);
    Mockito.when(xProductOutbound.addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(ProductAndItemActivationRequest.class)))
      .thenReturn(addProductAndItemsResponse);
    Mockito.when(this.attributeRepository.findDetailById(Mockito.any())).thenReturn(attribute);
    Mockito.when(getProductLevel3Repository().updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any())).thenReturn(generateItemSummaryData());
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any()))
      .thenReturn(generateItemSummaryData());
    Mockito.when(
        productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(), Mockito.anyList()))
      .thenReturn(new ArrayList());
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE))).thenReturn(businessPartnerData);
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2))).thenReturn(businessPartnerData2);
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2))).thenReturn(businessPartnerData2);
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_3))).thenReturn(businessPartnerData3);
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_3))).thenReturn(businessPartnerData3);
    Mockito.when(getProductLevel3Repository().checkPickupPointCodeUsed(DEFAULT_PICKUP_POINT_CODE))
      .thenReturn(simpleBooleanResponse);
    Mockito.when(
        this.productInventoryService.isSyncedToLevel1Inventory(Mockito.any(ProfileResponse.class)))
      .thenReturn(true);
    Mockito.doNothing().when(this.productLevel3AggregatorService)
      .create(Mockito.any(), Mockito.any());
    Mockito.doNothing().when(this.productLevel3AggregatorService)
      .updateState(Mockito.any(), Mockito.any(), Mockito.any());

    Mockito.when(getProductLevel3Repository().getProduct(Mockito.any())).thenReturn(productData);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.SAP_OUTBOUND_SWITCH))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(false), null, false));
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(campaignOutbound.validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    itemSummaryDetailResponse = new ItemSummaryDetailResponse();
    itemSummaryDetailResponse.setProductCode(DEFAULT_PRODUCT_CODE);
    itemSummaryDetailResponse.setProductSku(DEFAULT_PRODUCT_SKU);
    itemSummaryDetailResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemSummaryDetailResponse.setItemViewConfigs(new HashSet<>());

    ItemViewConfigDTO itemViewConfigDTO = new ItemViewConfigDTO();
    itemViewConfigDTO.setDiscoverable(true);
    itemViewConfigDTO.setBuyable(true);
    itemSummaryDetailResponse.getItemViewConfigs().add(itemViewConfigDTO);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(Mockito.any(), Mockito.any()))
      .thenReturn(new PageImpl<>(Arrays.asList(itemSummaryDetailResponse), PAGEABLE, 1));

    categoryCodeResponse = new GdnRestSingleResponse<>();
    SingleObjectResponse singleObjectResponse = new SingleObjectResponse(DEFAULT_CATEGORY_CODE);
    categoryCodeResponse.setValue(singleObjectResponse);

    predefinedAllowedAttributeValueResponses = new ArrayList<>();
    predefinedAllowedAttributeValueResponse = new PredefinedAllowedAttributeValueResponse();
    predefinedAllowedAttributeValueResponse.setValue(DEFAULT_BRAND);
    predefinedAllowedAttributeValueResponses.add(predefinedAllowedAttributeValueResponse);

    summaryFilterRequest = new SummaryFilterRequest();
    summaryFilterRequest.setCategoryCode(DEFAULT_CATEGORY_CODE);
    summaryFilterRequest.setCategoryCodes(Arrays.asList(DEFAULT_CATEGORY_CODE));
    summaryFilterRequest.setPickupPointCodes(Arrays.asList(DEFAULT_PICKUP_POINT_CODE));

    summaryFilterRequest1 = new SummaryFilterRequest();
    summaryFilterRequest1.setSearchKeyword(DEFAULT_GDN_SKU);
    summaryFilterRequest1.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);

    activeProductResponse = new ActiveProductResponse();
    activeProductResponse.setProductCode(DEFAULT_PRODUCT_CODE);

    Mockito.when(
        this.productSuspensionHistoryRepository.findByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
          DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, DEFAULT_PAGE_REQUEST))
      .thenReturn(productSuspensionHistories);
    catalogResponse = new CatalogResponse();
    catalogResponse.setCatalogCode(CATALOG_CODE);

    itemSummaryResponse = new ItemSummaryResponse();
    itemSummaryResponse.setProductCode(DEFAULT_PRODUCT_CODE);
    itemSummaryResponse.setProductSku(DEFAULT_PRODUCT_SKU);
    itemSummaryResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemSummaryResponse.setMasterDataItemImages(
      Arrays.asList(new MasterDataItemImageDTO(true, "location", 0)));
    itemSummaryResponse.setMasterCatalog(new MasterCatalogDTO(CATALOG_CODE, new CategoryDTO()));
    itemSummaryResponse.setProductType(ProductType.REGULAR);
    itemSummaryResponse.setPrice(new HashSet<>());
    itemSummaryResponse.getPrice().add(
      new PriceDTO(IDR_CURRENCY, 10000.0, 1000.0, ChannelName.DEFAULT.name(),
        new ArrayList<DiscountPriceDTO>(), null, null));
    itemSummaryResponse.getMasterCatalog().getCategory().setCategoryCode(DEFAULT_CATEGORY_CODE);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    itemSummaryResponse.setVersion(1L);
    itemSummaryResponse.setBuyable(true);
    itemSummaryResponse.setDiscoverable(true);
    productCollection = new ProductCollection();
    productCollection.setProductCode(DEFAULT_PRODUCT_CODE);

    Mockito.when(applicationContext.getBean(ProductLevel3Service.class))
      .thenReturn(productLevel3ServiceBean);

    Mockito.when(applicationContext.getBean(ProductLevel3ServiceBean.class)).thenReturn(productLevel3ServiceBean);

    suspensionProductRequest = new SuspensionProductRequest();
    suspensionProductRequest.setReason(REASON);
    suspensionProductRequest.setNotes(NOTES);
    ProductLevel3Request request = new ProductLevel3Request();
    request.setProductSku(DEFAULT_PRODUCT_SKU);
    request.setProductName(PRODUCT_NAME);
    request.setBusinessPartnerCode(MERCHANT_CODE_1);
    suspensionProductRequest.setProducts(Arrays.asList(request));

    productAndItemsResponse = new ProductAndItemsResponse();
    ProductResponse productResponse = new ProductResponse();
    productResponse.setProductSku(DEFAULT_PRODUCT_SKU);
    productResponse.setProductCode(DEFAULT_PRODUCT_CODE);
    productResponse.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productAndItemsResponse.setProduct(productResponse);
    ItemResponse itemResponse = new ItemResponse();
    itemResponse.setItemSku(ITEM_SKU);
    itemResponse.setMerchantCode(MERCHANT_CODE_1);
    itemResponse.setMasterDataItem(new MasterDataItemDTO());
    productAndItemsResponse.setItems(Arrays.asList(itemResponse));

    productAndItemsResponse1 = new ProductAndItemsResponse();
    MasterDataProductDTO masterDataProductDTO = new MasterDataProductDTO();
    masterDataProductDTO.setDescription(new String());
    masterDataProductDTO.setLongDescription(new String());
    productResponse.setMasterDataProduct(masterDataProductDTO);
    productAndItemsResponse1.setProduct(productResponse);

    productL3Response = new ProductL3Response();
    BeanUtils.copyProperties(productL3Response, productResponse);
    productL3Response.setItemSkus(Arrays.asList(ITEM_SKU));
    productL3Response.setProductType(productResponse.getProductType());
    productL3Response.setDefaultItemSku(DEFAULT_ITEM_SKU);

    itemViewConfigRequest.setBuyable(false);
    itemViewConfigRequest.setDiscoverable(false);

    filterRequest = new ProductLevel3SummaryFilter();
    filterRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    sortOrder = new SortOrder(CREATED_DATE, DESC);

    itemSummaryResponsePage = new PageImpl<>(Arrays.asList(new ItemSummaryResponse()));

    productImageQcProcessingResponse = new ProductImageQcProcessingResponse();
    productImageQcProcessingResponse.setForceReview(true);

    wholesaleMappingResponse = new WholesaleMappingResponse();
    wholesaleMappingResponse.setWholesalePriceConfigEnabled(false);
    MinWholesaleDiscountResponse minWholesaleDiscountResponse = new MinWholesaleDiscountResponse();
    minWholesaleDiscountResponse.setPercentage(20.0);
    minWholesaleDiscountResponse.setPrice(10000.0);
    MinWholesaleDiscountResponse minWholesaleDiscountResponse1 = new MinWholesaleDiscountResponse();
    minWholesaleDiscountResponse1.setPercentage(30.0);
    minWholesaleDiscountResponse1.setPrice(50000.0);
    WholesaleConfigResponse wholesaleConfigResponse = new WholesaleConfigResponse();
    wholesaleConfigResponse.setQuantity(20);
    wholesaleConfigResponse.setMinWholesaleDiscount(new ArrayList<>());
    wholesaleConfigResponse.getMinWholesaleDiscount().add(minWholesaleDiscountResponse);
    WholesaleConfigResponse wholesaleConfigResponse1 = new WholesaleConfigResponse();
    wholesaleConfigResponse1.setQuantity(20);
    wholesaleConfigResponse1.setMinWholesaleDiscount(new ArrayList<>());
    wholesaleConfigResponse1.getMinWholesaleDiscount().add(minWholesaleDiscountResponse1);
    wholesaleMappingResponse.setWholesaleConfig(new ArrayList<>());
    wholesaleMappingResponse.getWholesaleConfig().add(wholesaleConfigResponse);
    wholesaleMappingResponse.getWholesaleConfig().add(wholesaleConfigResponse1);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    productSystemParameter = new ProductSystemParameter();
    productSystemParameter.setValue("1");

    Map<Integer, Double> map = new HashMap();
    map.put(100, 10.0);
    wholesalePriceSkuResponse = new WholesalePriceSkuResponse();
    wholesalePriceSkuResponse.setItemSku(ITEM_SKU);
    wholesalePriceSkuResponse.setWholesaleRules(map);

    productItemWholesalePriceRequest.setQuantity(QUANTITY);
    productItemWholesalePriceRequest.setWholesaleDiscount(WHOLESALE_DISCOUNT);

    productItemWholesalePriceRequest1.setQuantity(QUANTITY_1);
    productItemWholesalePriceRequest1.setWholesaleDiscount(WHOLESALE_DISCOUNT_1);

    productItemWholesalePriceRequestList.add(productItemWholesalePriceRequest);
    productItemWholesalePriceRequestList.add(productItemWholesalePriceRequest1);
    productPriceAndWholesaleRequest.setOfferPrice(SALE_PRICE);
    productPriceAndWholesaleRequest.setListPrice(NORMAL_PRICE);
    productPriceAndWholesaleRequest.setWholesalePriceActivated(Boolean.TRUE);
    productPriceAndWholesaleRequest.setProductItemWholesalePriceRequests(
      productItemWholesalePriceRequestList);

    minWholesaleDiscountResponse.setPercentage(2.0);
    minWholesaleDiscountResponse1.setPercentage(3.0);
    wholesaleMappingResponse = new WholesaleMappingResponse();
    wholesaleMappingResponse.setConfigurationType("PERCENTAGE");
    wholesaleMappingResponse.setWholesaleConfig(new ArrayList<>());
    wholesaleMappingResponse.getWholesaleConfig()
      .add(new WholesaleConfigResponse(2, Arrays.asList(minWholesaleDiscountResponse)));
    wholesaleMappingResponse.getWholesaleConfig()
      .add(new WholesaleConfigResponse(3, Arrays.asList(minWholesaleDiscountResponse1)));
    wholesaleMappingResponse.setWholesalePriceConfigEnabled(true);
    wholesalePriceSkuResponse.setSkuStatus("ACTIVE");

    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);

    productPriceStockAndImagesRequest = new ProductPriceStockAndImagesRequest();
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setPickupPointCode(PICKUP_POINT_CODE);
    ProductLevel3SummaryDetailsImageRequest productLevel3SummaryDetailsImageRequest =
      new ProductLevel3SummaryDetailsImageRequest();
    productLevel3SummaryDetailsImageRequest.setLocationPath("test-image.jpeg");
    productLevel3SummaryDetailsImageRequest.setReviewType("new");
    productLevel3SummaryDetailsImageRequest.setMainImage(false);
    productLevel3SummaryDetailsImageRequest.setSequence(1);
    productLevel3SummaryDetailsImageRequest.setMarkForDelete(false);
    productPriceStockAndImagesRequest.setImages(
      Arrays.asList(productLevel3SummaryDetailsImageRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(DEFAULT_PRICE);
    price.setSalePrice(DEFAULT_SALE_PRICE);
    price.setChannelId(DEFAULT_CHANNEL_ID);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));

    when(productLevel3LogisticsService.saveLogisticsByItemSku(Mockito.anyList(),
      Mockito.any(), Mockito.anyList(),
      Mockito.anyBoolean())).thenReturn(true);
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(new ArrayList<ProductLevel3Logistics>());

    configurationStatusResponse.setCategoryCode(DEFAULT_CATEGORY_CODE);
    configurationStatusResponse.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    configurationStatusResponse.setReviewConfig("Post-Live");
    ReflectionTestUtils.setField(productLevel3ServiceBean, "campaignPriceInfoBatchSize", 10);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "brandAttributeCodes", "BR-M036969, BR-M036968");
    productLevel3UpdateRequest = new ProductLevel3UpdateRequest();
    productLevel3UpdateRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productLevel3UpdateRequest.setLength(1.0);
    productLevel3UpdateRequest.setWidth(1.0);
    productLevel3UpdateRequest.setHeight(1.0);
    productLevel3UpdateRequest.setWeight(1.0);
    productLevel3UpdateRequest.setShippingWeight(1.0);
    productLevel3UpdateRequest.setProductEditable(true);
    productLevel3UpdateRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3UpdateRequest.setProductName(DEFAULT_PRODUCT_NAME);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(
      Arrays.asList(new ProductLevel3Logistics()));
    productLevel3UpdateRequest.setProductType(3);

    productL3UpdateRequest = new ProductL3UpdateRequest();
    productL3UpdateRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productL3UpdateRequest.setLength(1.0);
    productL3UpdateRequest.setWidth(1.0);
    productL3UpdateRequest.setHeight(1.0);
    productL3UpdateRequest.setWeight(1.0);
    productL3UpdateRequest.setShippingWeight(1.0);
    productL3UpdateRequest.setProductEditable(true);
    productL3UpdateRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productL3UpdateRequest.setProductName(DEFAULT_PRODUCT_NAME);
    productL3UpdateRequest.setProductLevel3LogisticsRequest(
      Arrays.asList(new ProductLevel3Logistics()));
    productL3UpdateRequest.setProductType(3);

    productItemsImageUpdateRequest = new ProductItemsImageUpdateRequest();
    variantList.add(productPriceStockAndImagesRequest);
    copyToAllVariantImages.add(productLevel3SummaryDetailsImageRequest);
    productItemsImageUpdateRequest.setVariantList(variantList);
    productItemsImageUpdateRequest.setCopyToAllVariantImages(copyToAllVariantImages);
    productItemsImageUpdateRequest.setProductCode(DEFAULT_PRODUCT_CODE);
    productItemsImageUpdateRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);

    productVariantPriceStockAndImagesRequest = new ProductVariantPriceStockAndImagesRequest();
    productVariantPriceStockAndImagesRequest.setImages(images);
    productVariantPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setProductCode(PRODUCT_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);


    images.add(productLevel3SummaryDetailsImageRequest);


    stockAndImagesRequestsList.add(productVariantPriceStockAndImagesRequest);
    productVariantUpdateRequest = new ProductVariantUpdateRequest();
    productVariantUpdateRequest.setProductItems(stockAndImagesRequestsList);
    productVariantUpdateRequest.setCopyToAllVariantImages(images);

    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(new ArrayList<>(), PageRequest.of(0, 1), 1));

    productSkuSummaryResponse = ProductSkuSummaryResponse.builder().productSku(DEFAULT_PRODUCT_SKU)
      .categoryCode(CATEGORY_CODE).brand(BRAND).productName(PRODUCT_NAME).build();
    categoryResponse.setName(CATEGORY_NAME);
    categoryHierarchyResponse.setCategoryCode(CATEGORY_CODE);
    categoryHierarchyResponse.setCategoryHierarchy(Arrays.asList(categoryResponse));

    pickupPointUpdateRequest = new PickupPointUpdateRequest();
    pickupPointUpdateRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    pickupPointUpdateRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    pickupPointRequest.setItemSku(DEFAULT_ITEM_SKU);
    pickupPointRequest.setPickupPointCode(PICKUP);
    pickupPointUpdateRequest.getItemsPickupPoint().add(pickupPointRequest);

    webInventoryBulkUpdatePickupPointCodeResponseDTO =
      new WebInventoryBulkUpdatePickupPointCodeResponseDTO();
    updatePickupPointResponse = new WebInventoryUpdatePickupPointResponseDTO();
    WebInventoryUpdatePickupPointResponseDTO.UpdatePickupPointError error =
      new WebInventoryUpdatePickupPointResponseDTO.UpdatePickupPointError();
    updatePickupPointResponse.setErrors(Arrays.asList(error));

    configurationStatusRequest =
      ConfigurationStatusRequest.builder().businessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE)
        .categoryCode(CATEGORY_CODE).build();
    configurationStatusResponse =
      ConfigurationStatusResponse.builder().merchantCode(DEFAULT_BUSINESS_PARTNER_CODE)
        .categoryCode(CATEGORY_CODE).reviewConfig(POST_REVIEW_TYPE).build();
    configurationStatusResponseList = new ArrayList<>();
    configurationStatusResponseList.add(configurationStatusResponse);

    addEditedProductToPDTEvent =
      AddEditedProductToPDTEvent.builder().merchantCode(DEFAULT_BUSINESS_PARTNER_CODE)
        .productCode(PRODUCT_CODE).postLive(false).build();
    preOrderDTO = PreOrderDTO.builder().isPreOrder(true).preOrderType(PREORDER_TYPE)
      .preOrderValue(PREORDER_VALUE).build();

    ProductLevel3PriceRequest productLevel3PriceRequest = new ProductLevel3PriceRequest();
    productLevel3PriceRequest.setPrice(1000.0);
    productLevel3PriceRequest.setSalePrice(1000.0);
    quickEditRequest = new QuickEditRequest();
    quickEditRequest.setItemSku(DEFAULT_ITEM_SKU);
    quickEditRequest.setPrice(productLevel3PriceRequest);
    quickEditRequest.setDeltaStock(100);
    quickEditRequest.setStatus(ProductLevel3Status.ONLINE);
    quickEditRequest.setWholeSaleActivated(true);
    quickEditRequest.setOff2OnActiveFlag(true);
    quickEditRequest.setSellerSku(DEFAULT_MERCHANT_SKU);
    quickEditRequest.setPickupPointCode(PICKUP);
    quickEditRequest.setUseWarehouseStock(true);
    quickEditRequest.setVersion(2L);
    productLevel3QuickEditRequest =
      new ProductLevel3QuickEditRequest(Arrays.asList(quickEditRequest));

    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(productL3Response, REQUESTID));

    preOrderRequest = PreOrderRequest.builder().isPreOrder(true).preOrderType(PREORDER_TYPE)
      .preOrderValue(PREORDER_VALUE).preOrderDate(new Date()).build();
    campaignUpdateDiscountRequest = new CampaignUpdateDiscountRequest();
    UpdateDiscountDTO updateDiscountDTO = new UpdateDiscountDTO();
    updateDiscountDTO.setItemSku(ITEM_SKU);
    updateDiscountDTO.setCategoryCode(DEFAULT_CATEGORY_CODE);
    updateDiscountDTO.setSellingPrice(2000.0);
    campaignUpdateDiscountRequest.setDiscountDTOList(Collections.singletonList(updateDiscountDTO));

    campaignUpdateDiscountResponse = new CampaignUpdateDiscountResponse();
    campaignUpdateDiscountResponse.setItemSkuStatusMap(Collections.EMPTY_MAP);
    Mockito.when(
        campaignOutbound.validateAndUpdateDiscountPrice(true, campaignUpdateDiscountRequest))
      .thenReturn(campaignUpdateDiscountResponse);

    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setPrice(DEFAULT_PRICE);
    productItemBusinessPartner.setSalePrice(DEFAULT_PRICE);
    productItemBusinessPartner.setMinimumStock(DEFAULT_DELTA_STOCK);
    productItemBusinessPartner.setStock(DEFAULT_DELTA_STOCK);
    when(
      this.productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(
        eq(DEFAULT_STORE_ID), anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));

    itemSummaryResponse.setGeneratedItemName(ITEM_NAME);
    itemSummaryResponseMap.put(DEFAULT_ITEM_SKU, itemSummaryResponse);
    Mockito.when(productLevel3Repository.findSummaryByFilter(Mockito.any(ItemSummaryRequest.class),
        Mockito.any(), Mockito.any(SortOrder.class)))
      .thenReturn(new PageImpl<>(Arrays.asList(itemSummaryResponse)));
    List<ProductLevel3Inventory> productLevel3InventoryList = new ArrayList<>();
    productLevel3Inventory.setWebItemSku(DEFAULT_ITEM_SKU);
    productLevel3InventoryList.add(productLevel3Inventory);
    Mockito.when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(),
        anyList())).thenReturn(productLevel3InventoryList);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(DEFAULT_GDN_SKU, false))
      .thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
      new SimpleMasterProductUpdateResponse();
    simpleMasterProductUpdateResponse.setUpdateSuccess(true);
    Mockito.when(this.productRepository.updateSimpleMasterProduct(
        any(SimpleMasterProductUpdateRequestDTO.class)))
      .thenReturn(simpleMasterProductUpdateResponse);

    Mockito.when(
        productBusinessPartnerRepository.countRejectedProductByGdnProductSku(Mockito.any()))
      .thenReturn(0);
    Mockito.when(calendarService.getExpectedActivationDateByCategoryCode(Mockito.any(),
      Mockito.any(Date.class))).thenReturn(new Date());

    itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productCollection.setCategoryCode(DEFAULT_CATEGORY_CODE);
    when(
      productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
      productCollection);
    categoryResponses.add(categoryResponse1);
    categoryResponse.setCategoryCode(CATEGORY_CODE);
    categoryResponses.add(categoryResponse);
    when(productOutbound.filterCategoryHierarchyByCategoryCode(any())).thenReturn(null);

    Mockito.when(
        objectMapper.writeValueAsString(Mockito.anyList()))
      .thenReturn("[]");

    Mockito.when(productLevel3Helper.isProductItemDetailChangedForListingUpdate(
      Mockito.any(QuickEditRequest.class), Mockito.any(ItemSummaryResponse.class),
      Mockito.any(Boolean.class))).thenReturn(true);

    Mockito.when(productLevel3InventoryService.updateStockV2(Mockito.any(), Mockito.any(),
      Mockito.any(Integer.class))).thenReturn(null);

    updateProductLevel3InfoRequest =
      UpdateProductLevel3InfoRequest.builder().productName(PRODUCT_NAME).build();

    agpSimpleQueryResponse =
      AgpSimpleQueryResponse.builder().hits(HitsResponse.builder().total(0).max_score(10.0).build())
        .build();
    Mockito.when(
        agpQueryFeign.findNumberOfOrder(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any()))
      .thenReturn(agpSimpleQueryResponse);

    categoryDetailResponse = new CategoryDetailResponse();
    List<CategoryAttributeResponse> categoryAttributeResponseList = new ArrayList<>();
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
      AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_6).name("attribute-6")
        .build());
    categoryAttributeResponseList.add(categoryAttributeResponse);
    categoryDetailResponse.setCategoryAttributes(categoryAttributeResponseList);

    profileResponse.setCompany(new CompanyDTO());
    ItemLevel5Response itemLevel5Response = new ItemLevel5Response();
    itemLevel5Response.setPrices(Collections.singletonList(new PriceResponse()));
    itemLevel5Response.setViewConfigs(Collections.singletonList(new ViewConfigResponse()));
    BundleItemResponse bundleItemResponse = new BundleItemResponse();
    bundleItemResponse.setQuantity(2);
    bundleItemResponse.setProductSku(PRODUCT_SKU);
    itemLevel5Response.setBundleItemResponses(List.of(bundleItemResponse));
    itemLevel5ResponseList.add(itemLevel5Response);

    Mockito.doNothing().when(fileStorageService)
      .editImageNameIfGcsEnabled(Mockito.any(UpdateItemsPriceStockImagesRequest.class));
    Mockito.when(productBusinessPartnerService.findProductStateByStoreIdAndItemSku(Mockito.any(),
      Mockito.any())).thenReturn(Constants.ACTIVE_STATUS);
    Mockito.when(productService.checkBpBopisEligibility(anyInt(), any())).thenReturn(null);
    itemResponse.setPickupPointCode(PICKUP);
    productAndItemsResponse.setItems(Collections.singletonList(itemResponse));

    Mockito.when(kafkaTopicProperties.getVendorCombinedEventNoPriority())
      .thenReturn(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT);
    itemBasicDetailV2Response.setProductSku(PRODUCT_SKU);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "migrateProductInOtherLogisticUpdateFlow", true);

    CogsValueResponse cogs = new CogsValueResponse(null, null, 100000.0);
    Mockito.when(sapOutbound.getCogsValueResponse(Mockito.anyString())).thenReturn(cogs);
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(false);
  }

  @Test
  public void estimatePriceForFlow2ProductCreationTest() throws Exception {
    Mockito.when(getProductLevel3InventoryService().findInventoryByGdnSkuMap(Mockito.anyMap()))
      .thenReturn(inventoryByGdnSkuMap);
    EstimateItemPriceDTO estimateItemPriceDTO =
      productLevel3ServiceBean.estimatePriceForFlow2ProductCreation(ITEM_CODE, PRICE_COEFFICIENT,
        MAX_INVENTORY_COUNT);
    Assertions.assertEquals(Boolean.TRUE, estimateItemPriceDTO.isNormalPriceEstimated());
    Assertions.assertEquals(Boolean.TRUE, estimateItemPriceDTO.isOfferPriceEstimated());
    verify(productLevel3Repository, Mockito.times(1)).getItemSkusToFetchEstimatedPrice(ITEM_CODE);
    verify(productLevel3InventoryService, Mockito.times(2)).findInventoryByGdnSkuMap(
      Mockito.anyMap());
  }

  @Test
  public void estimatePriceForFlow2ProductCreationWithEmptyStockTest() throws Exception {
    Mockito.when(getProductLevel3InventoryService().findInventoryByGdnSkuMap(Mockito.anyMap()))
      .thenReturn(inventoryByGdnSkuMap);
    for (int i = 1; i <= 6; i++) {
      productLevel3ServiceBean.estimatePriceForFlow2ProductCreation(ITEM_CODE, PRICE_COEFFICIENT,
        MAX_INVENTORY_COUNT);
      itemPriceResponses.remove(FIRST);
    }
    verify(productLevel3Repository, Mockito.times(6)).getItemSkusToFetchEstimatedPrice(ITEM_CODE);
    verify(productLevel3InventoryService, Mockito.times(12)).findInventoryByGdnSkuMap(
      Mockito.anyMap());
  }

  @Test
  public void estimatePriceForFlow2ProductCreationExceptionTest() throws Exception {
    Mockito.when(getProductLevel3InventoryService().findInventoryByGdnSkuMap(Mockito.anyMap()))
      .thenThrow(new RuntimeException());
    EstimateItemPriceDTO estimateItemPriceDTO =
      productLevel3ServiceBean.estimatePriceForFlow2ProductCreation(ITEM_CODE, PRICE_COEFFICIENT,
        MAX_INVENTORY_COUNT);
    Assertions.assertEquals(Boolean.FALSE, estimateItemPriceDTO.isNormalPriceEstimated());
    Assertions.assertEquals(Boolean.FALSE, estimateItemPriceDTO.isOfferPriceEstimated());
    verify(productLevel3Repository, Mockito.times(1)).getItemSkusToFetchEstimatedPrice(ITEM_CODE);
    verify(productLevel3InventoryService, Mockito.times(2)).findInventoryByGdnSkuMap(
      Mockito.anyMap());
  }

  /*
   * If the data is already saved to PBP, but failed to save to X-Product or X-Inventory The GDN SKU
   * is already generated
   */
  @Test
  public void retryCreateWithInventoryLevel2Test() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = generateProductBusinessPartner();
    productBusinessPartner.setBusinessPartnerId(
      ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setGdnProductSku(DEFAULT_GDN_SKU);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    int i = 0;
    for (ProductItemResponse productItem : productData.getProductItemResponses()) {
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setProductItemId(productItem.getId());
      productBusinessPartner.getProductItemBusinessPartners().get(i)
        .setGdnProductItemSku(DEFAULT_GDN_SKU_2);
      i++;
    }
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList()))
      .thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE,
      productData, productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(
      Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(
      Arrays.asList(DEFAULT_GDN_SKU_2, DEFAULT_GDN_SKU_2, DEFAULT_GDN_SKU_2),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.any(ProductAndItemActivationRequest.class),
      Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService, Mockito.times(
      productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService,
      ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID,
      Arrays.asList(DEFAULT_GDN_SKU_2));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID,
      DEFAULT_PRODUCT_CODE);
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
  }

  public void setAttributeRepository(AttributeRepository attributeRepository) {
    this.attributeRepository = attributeRepository;
  }


  public void setUpdatedProductHistoryService(
    UpdatedProductHistoryService updatedProductHistoryService) {
    this.updatedProductHistoryService = updatedProductHistoryService;
  }

  public void setBusinessPartnerRepository(BusinessPartnerRepository businessPartnerRepository) {
    this.businessPartnerRepository = businessPartnerRepository;
  }

  public void setCategoryRepository(CategoryRepository categoryRepository) {
    this.categoryRepository = categoryRepository;
  }

  public void setPickupPointRepository(PickupPointRepository pickupPointRepository) {
    this.pickupPointRepository = pickupPointRepository;
  }

  public void setProductBusinessPartnerService(
    ProductBusinessPartnerService productBusinessPartnerService) {
    this.productBusinessPartnerService = productBusinessPartnerService;
  }

  public void setProductInventoryService(ProductInventoryService productInventoryService) {
    this.productInventoryService = productInventoryService;
  }

  public void setProductLevel3Converter(ProductLevel3Converter productLevel3Converter) {
    this.productLevel3Converter = productLevel3Converter;
  }

  public void setProductLevel3InventoryService(
    ProductLevel3InventoryService productLevel3InventoryService) {
    this.productLevel3InventoryService = productLevel3InventoryService;
  }

  public void setProductLevel3Repository(ProductLevel3Repository productLevel3Repository) {
    this.productLevel3Repository = productLevel3Repository;
  }

  public void setProductLevel3ServiceBean(ProductLevel3ServiceBean productLevel3ServiceBean) {
    this.productLevel3ServiceBean = productLevel3ServiceBean;
  }

  @Test
  public void testFindDetailByGdnSku() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.CHECK_PRODUCT_FOR_REVIEW))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(false), null, false));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isVariantCreation());
  }

  @Test
  public void testFindDetailByGdnSkuStateDraft() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.CHECK_PRODUCT_FOR_REVIEW))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(false), null, false));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(productBusinessPartnerService.findProductStateByStoreIdAndItemSku(Mockito.any(),
      eq(DEFAULT_GDN_SKU))).thenReturn(Constants.DRAFT);
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isVariantCreation());
  }

  @Test
  public void testFindDetailByGdnSkuStateEmpty() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.CHECK_PRODUCT_FOR_REVIEW))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(false), null, false));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(productBusinessPartnerService.findProductStateByStoreIdAndItemSku(Mockito.any(),
      eq(DEFAULT_GDN_SKU))).thenReturn(StringUtils.EMPTY);
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(sapOutbound).getCogsValueResponse(any());
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isVariantCreation());
  }

  @Test
  public void testFindDetailByGdnSkuStateDeletedTest() throws Exception {
    Mockito.when(productBusinessPartnerService.findProductStateByStoreIdAndItemSku(Mockito.any(),
      eq(DEFAULT_GDN_SKU))).thenReturn(Constants.DELETED_STATE);
    Assertions.assertThrows(ProductRejectedException.class, () -> {
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
          DEFAULT_GDN_SKU, false);
    });
    Mockito.verify(productBusinessPartnerService)
      .findProductStateByStoreIdAndItemSku(Mockito.any(), eq(DEFAULT_GDN_SKU));
  }

  @Test
  public void testFindDetailByGdnSkuStateNRTest() throws Exception {
    Mockito.when(productBusinessPartnerService.findProductStateByStoreIdAndItemSku(Mockito.any(),
      eq(DEFAULT_GDN_SKU))).thenReturn(Constants.NEED_CORRECTION);
    Assertions.assertThrows(ProductInNeedCorrectionException.class, () -> {
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
          DEFAULT_GDN_SKU, false);
    });
    Mockito.verify(productBusinessPartnerService)
      .findProductStateByStoreIdAndItemSku(Mockito.any(), eq(DEFAULT_GDN_SKU));
  }

  @Test
  public void testFindDetailByGdnSkuStateInReviewTest() throws Exception {
    Mockito.when(productBusinessPartnerService.findProductStateByStoreIdAndItemSku(Mockito.any(),
      eq(DEFAULT_GDN_SKU))).thenReturn(Constants.IN_PROGRESS_STATE);
    Assertions.assertThrows(ProductInReviewException.class, () -> {
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
          DEFAULT_GDN_SKU, false);
    });
    Mockito.verify(productBusinessPartnerService)
      .findProductStateByStoreIdAndItemSku(Mockito.any(), eq(DEFAULT_GDN_SKU));
  }

  @Test
  public void testFindDetailByGdnSku_SapCallEnabledFalse() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.CHECK_PRODUCT_FOR_REVIEW))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(false), null, false));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "false",
        "sapCallEnabled", false));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isVariantCreation());
  }

  @Test
  public void testFindDetailByGdnSkuSap() throws Exception {
    CogsValueResponse cogs = new CogsValueResponse(null, null, 100000.0);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.SAP_OUTBOUND_SWITCH))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(true), null, false));
    Mockito.when(sapOutbound.getCogsValueResponse(Mockito.any())).thenReturn(cogs);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.CHECK_PRODUCT_FOR_REVIEW))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(false), null, false));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isVariantCreation());
  }

  @Test
  public void testFindDetailByGdnSkuSapBPSwitchFalse() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", false);
    CogsValueResponse cogs = new CogsValueResponse(null, null, 100000.0);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.SAP_OUTBOUND_SWITCH))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(true), null, false));
    Mockito.when(sapOutbound.getCogsValueResponse(Mockito.any())).thenReturn(cogs);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.CHECK_PRODUCT_FOR_REVIEW))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(false), null, false));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isVariantCreation());
  }

  @Test
  public void testFindDetailByGdnSkuSapBPSwitchTrue() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setSuspended(true);
    productData.getProduct().setForceReview(true);
    this.profileResponse.setTrustedSeller(false);
    this.profileResponse.setCompany(CompanyDTO.builder().merchantType(CM_MERCHANT).build());
    this.profileResponse.setMultiDefaultAddressFlag(true);
    CogsValueResponse cogs = new CogsValueResponse(null, null, 100000.0);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.SAP_OUTBOUND_SWITCH))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(true), null, false));
    Mockito.when(sapOutbound.getCogsValueResponse(Mockito.any())).thenReturn(cogs);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.CHECK_PRODUCT_FOR_REVIEW))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(false), null, false));
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(DEFAULT_GDN_SKU, false))
      .thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isVariantCreation());
    Assertions.assertTrue(productLevel3.isForceReview());
    Assertions.assertTrue(productLevel3.isSuspended());
  }

  @Test
  public void testFindDetailByGdnSkuSapBPSwitchTrueForTrustedSeller() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setSuspended(true);
    productData.getProduct().setForceReview(true);
    this.profileResponse.setTrustedSeller(true);
    this.profileResponse.setCompany(CompanyDTO.builder().merchantType(CM_MERCHANT).build());
    this.profileResponse.setMultiDefaultAddressFlag(true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", true);
    CogsValueResponse cogs = new CogsValueResponse(null, null, 100000.0);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.SAP_OUTBOUND_SWITCH))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(true), null, false));
    Mockito.when(sapOutbound.getCogsValueResponse(Mockito.any())).thenReturn(cogs);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(DEFAULT_GDN_SKU, false))
      .thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.CHECK_PRODUCT_FOR_REVIEW))
      .thenReturn(new ProductSystemParameter(null, String.valueOf(false), null, false));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isVariantCreation());
  }

  @Test
  public void testFindDetailByGdnSkuWithDuplicateAttributes() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
        Mockito.eq(false)))
      .thenReturn(new GdnRestSingleResponse<>(generateProductData1(), REQUESTID));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertTrue(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertEquals(3, productLevel3.getAttributes().size());
    Assertions.assertFalse(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertFalse(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).getSkuValue());
    Assertions.assertFalse(productLevel3.getAttributes().get(1).getSkuValue());
    Assertions.assertFalse(productLevel3.getAttributes().get(2).getSkuValue());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionL5SuccessListEmptyTest()
    throws Exception {
    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
      new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
      itemPickupPointRequestList);
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(true);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
      new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
        any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
      Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
      null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
      productItemResponseList);
    when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
      anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
      Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(
        any(), anyList())).thenReturn(productItemBusinessPartnerList);
    when(variantEditValidationService.validateL5UpdateRequestWithErrorCode(any())).thenReturn(
      false);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
      new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
      productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
      new GdnRestSingleResponse<>(null, null, true,
        new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
      Mockito.eq(true))).thenReturn(response);
    productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
      DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest, new EditProductResponse(),
      new ProductLevel3(), true);

    verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests);
    verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
    verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    verify(variantEditValidationService).validateL5UpdateRequestWithErrorCode(any());
    Mockito.verify(variantEditValidationService)
      .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionL5SuccessListEmptyDeletePickupPointTest()
    throws Exception {
    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
      new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
      itemPickupPointRequestList);
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(true);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
      new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
        any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
      Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    productBusinessPartner.setId(ID);
    productBusinessPartner.setFbbActivated(false);
    when(this.productBusinessPartnerService.findByProductSkuList(STORE_ID,
      Arrays.asList(PRODUCT_SKU))).thenReturn(Arrays.asList(productBusinessPartner));
    when(
      productItemBusinessPartnerRepository.findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
        eq(STORE_ID), eq(ID), eq(Boolean.TRUE))).thenReturn(productItemBusinessPartner);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
      null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
      productItemResponseList);
    when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
      anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
      Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(
        any(), anyList())).thenReturn(productItemBusinessPartnerList);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
      new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
      productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
      new GdnRestSingleResponse<>(null, null, true,
        new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
      Mockito.eq(true))).thenReturn(response);
    PickupPointDeleteRequest pickupPointDeleteRequest = new PickupPointDeleteRequest();
    pickupPointDeleteRequest.setItemSku(ITEM_SKU);
    pickupPointDeleteRequest.setPickupPointId(PICKUP_POINT_CODE);
    updateItemsPriceStockImagesRequest.setDeletePickupPoints(
      Arrays.asList(pickupPointDeleteRequest));
    when(
      variantEditValidationService.validateL5UpdateRequestWithErrorCode(Mockito.any())).thenReturn(
      true);
    updateItemsPriceStockImagesRequest.setProductSku(PRODUCT_SKU);

    productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
      DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest, new EditProductResponse(),
      new ProductLevel3(), true);

    verify(
      productItemBusinessPartnerRepository).updateMarkForDeleteTrueAndFbbFalseByStoreIdAndItemSkuInAndPickupPointId(
      eq(DEFAULT_USER_NAME), eq(STOREID), eq(Arrays.asList(ITEM_SKU)), eq(PICKUP_POINT_CODE));
    verify(
      productItemBusinessPartnerRepository).findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
      eq(STORE_ID), eq(ID), eq(Boolean.TRUE));
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests);
    verify(variantEditValidationService).validateL5UpdateRequestWithErrorCode(Mockito.any());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
    verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    verify(productBusinessPartnerService).saveProductBusinessPartner(productBusinessPartner);
    Mockito.verify(variantEditValidationService)
      .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());
    Mockito.verify(productLevel3V2Service).saveL3NeedRevisionHistory(any(), any(), any());
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionDeletePickupPointUpdateInInventoryTrueTest()
      throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "deleteL5sFromInventoryDuringL5DeletionViaNeedRevision", true);
    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
        new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
        itemPickupPointRequestList);
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
        .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
        .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
        .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
        .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
        .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
        .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
        .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
        .setWholesalePriceActivated(true);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
        new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
        productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
            anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
        productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
            any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
        Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    productBusinessPartner.setId(ID);
    productBusinessPartner.setFbbActivated(false);
    when(this.productBusinessPartnerService.findByProductSkuList(STORE_ID,
        Arrays.asList(PRODUCT_SKU))).thenReturn(Arrays.asList(productBusinessPartner));
    when(
        productItemBusinessPartnerRepository.findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
            STORE_ID, ID, Boolean.TRUE)).thenReturn(productItemBusinessPartner);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
        DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
        null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
        productItemResponseList);
    when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
        DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
        anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
        Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    when(
        productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(
            any(), anyList())).thenReturn(productItemBusinessPartnerList);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
        new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
        productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true,
            new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
        Mockito.eq(true))).thenReturn(response);
    PickupPointDeleteRequest pickupPointDeleteRequest = new PickupPointDeleteRequest();
    pickupPointDeleteRequest.setItemSku(ITEM_SKU);
    pickupPointDeleteRequest.setPickupPointId(PICKUP_POINT_CODE);
    updateItemsPriceStockImagesRequest.setDeletePickupPoints(
        Arrays.asList(pickupPointDeleteRequest));
    when(
        variantEditValidationService.validateL5UpdateRequestWithErrorCode(Mockito.any())).thenReturn(
        true);
    updateItemsPriceStockImagesRequest.setProductSku(PRODUCT_SKU);

    productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest, new EditProductResponse(),
        new ProductLevel3(), true);

    verify(
        productItemBusinessPartnerRepository).updateMarkForDeleteTrueAndFbbFalseByStoreIdAndItemSkuInAndPickupPointId(
        DEFAULT_USER_NAME, STOREID, Arrays.asList(ITEM_SKU), PICKUP_POINT_CODE);
    verify(
        productItemBusinessPartnerRepository).findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
        STORE_ID, ID, Boolean.TRUE);
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
        productPriceStockAndImagesRequests, failedRequests);
    verify(variantEditValidationService).validateL5UpdateRequestWithErrorCode(Mockito.any());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
    verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    verify(productBusinessPartnerService).saveProductBusinessPartner(productBusinessPartner);
    Mockito.verify(variantEditValidationService)
        .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());
    Mockito.verify(productLevel3V2Service).saveL3NeedRevisionHistory(any(), any(), any());
    Mockito.verify(productLevel3InventoryService).deleteByItemSkuAndPickupPointCode(deleteL5Captor.capture());
    Assertions.assertEquals(ITEM_SKU, deleteL5Captor.getValue().get(0).getWebItemSku());
    Assertions.assertEquals(PICKUP_POINT_CODE, deleteL5Captor.getValue().get(0).getPickupPointCode());
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionL5AddPickupPointCodeTest()
    throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "deleteL5sFromInventoryDuringL5DeletionViaNeedRevision", true);
    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
      new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
      itemPickupPointRequestList);
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setFbbActive(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setB2bFields(null);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
      new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setB2cActivated(false);
    updateItemsPriceStockImagesRequest.setB2bActivated(false);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    productBusinessPartner.setId(ID);
    productBusinessPartner.setB2bActivated(true);
    productBusinessPartner.setB2cActivated(true);
    when(this.productBusinessPartnerService.findByProductSkuList(STORE_ID,
      Arrays.asList(PRODUCT_SKU))).thenReturn(Arrays.asList(productBusinessPartner));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_1);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
        any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
      Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
      null);
    when(
      productItemBusinessPartnerRepository.findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
        eq(STORE_ID), eq(ID), eq(Boolean.TRUE))).thenReturn(null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
      productItemResponseList);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
      anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
      Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSku(any(),
      any())).thenReturn(productItemBusinessPartnerList);
    when(
      variantEditValidationService.validateL5UpdateRequestWithErrorCode(Mockito.any())).thenReturn(
      true);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
      new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
      productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
      new GdnRestSingleResponse<>(null, null, true,
        new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
      Mockito.eq(true))).thenReturn(response);
    updateItemsPriceStockImagesRequest.setAddPickupPoints(
      productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints());
    updateItemsPriceStockImagesRequest.setProductSku(PRODUCT_SKU);

    productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
      DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest, new EditProductResponse(),
      new ProductLevel3(), true);
    Mockito.verify(variantEditValidationService)
      .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());
    verify(productItemWholesalePriceService).saveWholesalePriceNew(Mockito.anyList());

    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    verify(productItemBusinessPartnerRepository).saveAll(Mockito.anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests);
    verify(variantEditValidationService).validateL5UpdateRequestWithErrorCode(Mockito.any());
    verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSku(Mockito.any(),
      Mockito.any());
    verify(
      productItemBusinessPartnerRepository).findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
      eq(STORE_ID), eq(ID), eq(Boolean.TRUE));
    verify(updatedProductHistoryService, times(1)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
    verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3V2Service).saveL3NeedRevisionHistory(any(), any(), any());

  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionL5AddPickupPointCodeFbbAndCncNullTest()
    throws Exception {

    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
      new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
      itemPickupPointRequestList);
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(true);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
      new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    updateItemsPriceStockImagesRequest.setB2bActivated(true);
    updateItemsPriceStockImagesRequest.setB2cActivated(true);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
      productItemBusinessPartnerRepository.findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
        eq(STORE_ID), eq(ID), eq(Boolean.TRUE))).thenReturn(productItemBusinessPartner);
    when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    productBusinessPartner.setId(ID);
    productBusinessPartner.setB2bActivated(true);
    productBusinessPartner.setB2cActivated(true);
    when(this.productBusinessPartnerService.findByProductSkuList(STORE_ID,
      Arrays.asList(PRODUCT_SKU))).thenReturn(Arrays.asList(productBusinessPartner));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_1);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
        any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
      Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
      null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
      productItemResponseList);
    when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
      anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
      Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSku(any(),
      any())).thenReturn(productItemBusinessPartnerList);
    when(
      variantEditValidationService.validateL5UpdateRequestWithErrorCode(Mockito.any())).thenReturn(
      true);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
      new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
      productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
      new GdnRestSingleResponse<>(null, null, true,
        new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
      Mockito.eq(true))).thenReturn(response);
    updateItemsPriceStockImagesRequest.setAddPickupPoints(
      productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints());
    updateItemsPriceStockImagesRequest.setProductSku(PRODUCT_SKU);

    productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
      DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest, new EditProductResponse(),
      new ProductLevel3(), true);

    verify(productItemWholesalePriceService).saveWholesalePriceNew(Mockito.anyList());

    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    verify(productItemBusinessPartnerRepository).saveAll(Mockito.anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests);
    verify(variantEditValidationService).validateL5UpdateRequestWithErrorCode(Mockito.any());
    verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSku(Mockito.any(),
      Mockito.any());
    verify(
      productItemBusinessPartnerRepository).findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
      eq(STORE_ID), eq(ID), eq(Boolean.TRUE));
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
    verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(variantEditValidationService)
      .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());
    Mockito.verify(productLevel3V2Service).saveL3NeedRevisionHistory(any(), any(), any());
    verify(productLevel3V2Service).saveL3NeedRevisionHistory(any(), any(), any());

  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionL5AddPickupPointCodeWithL5OnlineTest()
    throws Exception {
    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
      new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
      itemPickupPointRequestList);
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setFbbActive(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setB2bFields(null);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
      new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setB2cActivated(false);
    updateItemsPriceStockImagesRequest.setB2bActivated(false);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    productBusinessPartner.setId(ID);
    productBusinessPartner.setB2bActivated(true);
    productBusinessPartner.setB2cActivated(true);
    when(this.productBusinessPartnerService.findByProductSkuList(STORE_ID,
      Arrays.asList(PRODUCT_SKU))).thenReturn(Arrays.asList(productBusinessPartner));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_1);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
        any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
      Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
      null);
    when(
        productItemBusinessPartnerRepository.findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
            STORE_ID, ID, Boolean.TRUE)).thenReturn(null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
      productItemResponseList);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
      anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
      Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSku(any(),
      any())).thenReturn(productItemBusinessPartnerList);
    when(
      variantEditValidationService.validateL5UpdateRequestWithErrorCode(Mockito.any())).thenReturn(
      true);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
      new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
      productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
      new GdnRestSingleResponse<>(null, null, true,
        new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
      Mockito.eq(true))).thenReturn(response);
    updateItemsPriceStockImagesRequest.setAddPickupPoints(
      productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints());
    updateItemsPriceStockImagesRequest.setProductSku(PRODUCT_SKU);

    productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
      DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest, new EditProductResponse(),
      new ProductLevel3(), true);
    Mockito.verify(variantEditValidationService)
      .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());
    verify(productItemWholesalePriceService).saveWholesalePriceNew(Mockito.anyList());

    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    verify(productItemBusinessPartnerRepository).saveAll(Mockito.anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests);
    verify(variantEditValidationService).validateL5UpdateRequestWithErrorCode(Mockito.any());
    verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSku(Mockito.any(),
      Mockito.any());
    verify(
        productItemBusinessPartnerRepository).findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
        STORE_ID, ID, Boolean.TRUE);
    verify(updatedProductHistoryService, times(3)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
    verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3V2Service).saveL3NeedRevisionHistory(any(), any(), any());

  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionL5AddPickupPointCodeWithL5OnlineExceptionTest()
    throws Exception {
    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
      new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
      itemPickupPointRequestList);
    Mockito.doThrow(new ApplicationRuntimeException()).when(updatedProductHistoryService).createProductL3AuditLog(Mockito.anyString(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), eq(false), Mockito.anyString());
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setFbbActive(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setB2bFields(null);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
      new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setB2cActivated(false);
    updateItemsPriceStockImagesRequest.setB2bActivated(false);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    productBusinessPartner.setId(ID);
    productBusinessPartner.setB2bActivated(true);
    productBusinessPartner.setB2cActivated(true);
    when(this.productBusinessPartnerService.findByProductSkuList(STORE_ID,
      Arrays.asList(PRODUCT_SKU))).thenReturn(Arrays.asList(productBusinessPartner));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_1);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
        any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
      Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
      null);
    when(
      productItemBusinessPartnerRepository.findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
        STORE_ID, ID, Boolean.TRUE)).thenReturn(null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
      productItemResponseList);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
      anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
      Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSku(any(),
      any())).thenReturn(productItemBusinessPartnerList);
    when(
      variantEditValidationService.validateL5UpdateRequestWithErrorCode(Mockito.any())).thenReturn(
      true);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
      new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
      productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
      new GdnRestSingleResponse<>(null, null, true,
        new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
      Mockito.eq(true))).thenReturn(response);
    updateItemsPriceStockImagesRequest.setAddPickupPoints(
      productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints());
    updateItemsPriceStockImagesRequest.setProductSku(PRODUCT_SKU);

    productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
      DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest, new EditProductResponse(),
      new ProductLevel3(), true);
    Mockito.verify(variantEditValidationService)
      .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());
    verify(productItemWholesalePriceService).saveWholesalePriceNew(Mockito.anyList());

    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    verify(productItemBusinessPartnerRepository).saveAll(Mockito.anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests);
    verify(variantEditValidationService).validateL5UpdateRequestWithErrorCode(Mockito.any());
    verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSku(Mockito.any(),
      Mockito.any());
    verify(
      productItemBusinessPartnerRepository).findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
      STORE_ID, ID, Boolean.TRUE);
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
    verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3V2Service).saveL3NeedRevisionHistory(any(), any(), any());

  }
  
  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionL5AddPickupPointCodeSamePPCodeTest()
    throws Exception {
    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
      new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
      itemPickupPointRequestList);
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(true);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
      new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productBusinessPartner.setId(ID);
    productBusinessPartner.setCncActivated(true);
    when(this.productBusinessPartnerService.findByProductSkuList(STORE_ID,
      Arrays.asList(PRODUCT_SKU))).thenReturn(Arrays.asList(productBusinessPartner));
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_1);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
        any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    when(
      productItemBusinessPartnerRepository.findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
        eq(STORE_ID), eq(ID), eq(Boolean.TRUE))).thenReturn(null);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
      Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
      null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
      productItemResponseList);
    when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
      anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
      Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    productItemBusinessPartnerList.get(0).setPickupPointId(PICKUP_POINT_CODE);
    productItemBusinessPartnerList.get(0).setMarkForDelete(true);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
      new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
      productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
      new GdnRestSingleResponse<>(null, null, true,
        new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
      Mockito.eq(true))).thenReturn(response);
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSku(any(),
      any())).thenReturn(productItemBusinessPartnerList);
    when(
      variantEditValidationService.validateL5UpdateRequestWithErrorCode(Mockito.any())).thenReturn(
      true);
    updateItemsPriceStockImagesRequest.setAddPickupPoints(
      productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints());
    updateItemsPriceStockImagesRequest.setProductSku(PRODUCT_SKU);

    productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
      DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest, new EditProductResponse(),
      new ProductLevel3(), true);

    verify(productItemWholesalePriceService).saveWholesalePriceNew(Mockito.anyList());

    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    verify(productItemBusinessPartnerRepository).saveAll(Mockito.anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests);
    verify(variantEditValidationService).validateL5UpdateRequestWithErrorCode(Mockito.any());
    verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSku(Mockito.any(),
      Mockito.any());
    verify(
      productItemBusinessPartnerRepository).findFirstByStoreIdAndProductBusinessPartnerIdAndFbbActiveAndMarkForDeleteFalse(
      eq(STORE_ID), eq(ID), eq(Boolean.TRUE));
    verify(updatedProductHistoryService, times(1)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
    verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(variantEditValidationService)
      .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());
    Mockito.verify(productLevel3V2Service).saveL3NeedRevisionHistory(any(), any(), any());
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionL5AddPickupPointCodeAlreadyExistsTest()
    throws Exception {
    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
      new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
      itemPickupPointRequestList);
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(true);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
      new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
        any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
      Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
      null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
      productItemResponseList);
    when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
      anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
      Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSku(any(),
      any())).thenReturn(productItemBusinessPartnerList);
    when(
      variantEditValidationService.validateL5UpdateRequestWithErrorCode(Mockito.any())).thenReturn(
      true);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
      new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
      productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
      new GdnRestSingleResponse<>(null, null, true,
        new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
      Mockito.eq(true))).thenReturn(response);
    updateItemsPriceStockImagesRequest.setAddPickupPoints(
      productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints());
    updateItemsPriceStockImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
            DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest,
            new EditProductResponse(), new ProductLevel3(), false);
      });
    } finally {
      verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
        productPriceStockAndImagesRequests, failedRequests);
      verify(variantEditValidationService).validateL5UpdateRequestWithErrorCode(Mockito.any());
      verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSku(Mockito.any(),
        Mockito.any());
      verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
      verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
      Mockito.verify(variantEditValidationService)
        .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());
    }
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionL5AddPickupPointCodeL4DataNotFoundTest()
    throws Exception {
    List<ProductVariantPriceStockAndImagesRequest> productPriceStockAndImagesRequests =
      new ArrayList<>();
    List<ProductVariantPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    List<ItemPickupPointRequest> itemPickupPointRequestList = new ArrayList<>();
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequestList.add(itemPickupPointRequest);
    productVariantPriceStockAndImagesRequest.setModifiedItemPickupPoints(
      itemPickupPointRequestList);
    productVariantPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productVariantPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productVariantPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.setMerchantCode(MERCHANT_CODE);
    productVariantPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productVariantPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE);
    productVariantPriceStockAndImagesRequest.setSkuCode(SKU_CODE);
    productVariantPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setDisplay(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setBuyable(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0).setPrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSalePrice(1000.0);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setItemSku(ITEM_SKU);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setPickupPointId(PICKUP_POINT_CODE);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(false);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setMinimumStock(STOCK_AVAILABLE_1);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setSynchronizeStock(true);
    productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints().get(0)
      .setWholesalePriceActivated(true);
    successValidationVariantList.add(productVariantPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productVariantPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductVariantUpdateRequest updateItemsPriceStockImagesRequest =
      new ProductVariantUpdateRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductCode(PRODUCT_CODE);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrectionL5(
      productPriceStockAndImagesRequests, failedRequests)).thenReturn(new ArrayList<>());
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    productLevel3Inventory.setWebMinAlert(MIN_STOCK);
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    productItemBusinessPartner.setPickupPointId(PICKUP_1);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuAndPickupPointIdIn(
        any(), any(), anyList())).thenReturn(productItemBusinessPartnerList);
    Map<String, String> productSkuProductNameMap = new HashMap<>();
    productSkuProductNameMap.put(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME);
    when(productLevel3Repository.getProductNameByProductSku(
      Arrays.asList(DEFAULT_PRODUCT_SKU))).thenReturn(productSkuProductNameMap);
    when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, STOCK_AVAILABLE_1)).thenReturn(
      null);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(SKU_CODE);
    productItemResponse.setUpcCode(UPC_CODE);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(Mockito.any())).thenReturn(
      productItemResponseList);
    when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setPickupPointCode(PICKUP_POINT_CODE);
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkuAndPickupPointCode(any(),
      anyList())).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThresholdL5(Mockito.any(ItemPickupPointRequest.class),
      Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class))).thenReturn(true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSku(any(),
      any())).thenReturn(new ArrayList());
    when(variantEditValidationService.validateL5UpdateRequestWithErrorCode(
      updateItemsPriceStockImagesRequest)).thenReturn(true);
    itemPickupPointListingResponse.setItemName(ITEM_NAME);
    Page<ItemPickupPointListingResponse> productItemSummaryDatasPage =
      new PageImpl<>(Arrays.asList(itemPickupPointListingResponse), DEFAULT_PAGEABLE, 1);
    when(xProductOutbound.getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any())).thenReturn(
      productItemSummaryDatasPage);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
      new GdnRestSingleResponse<>(null, null, true,
        new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class),
      Mockito.eq(true))).thenReturn(response);
    updateItemsPriceStockImagesRequest.setAddPickupPoints(
      productVariantPriceStockAndImagesRequest.getModifiedItemPickupPoints());
    updateItemsPriceStockImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);

    Exception exception = new Exception();
    try {
      productLevel3ServiceBean.editProductItemsPriceStockImagesL5(DEFAULT_STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, updateItemsPriceStockImagesRequest,
        new EditProductResponse(), new ProductLevel3(), false);
    } catch (Exception e) {
      exception = e;
    } finally {

      verify(xProductOutbound).getItemPickupPointList(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), eq(0), Mockito.anyInt(), Mockito.any());
      verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));

      verify(variantEditValidationService).validateListOfVariantsForNeedCorrectionL5(
        productPriceStockAndImagesRequests, failedRequests);

      Mockito.verify(variantEditValidationService)
        .validateAndSetFbbActiveFlagAtL5(Mockito.any(), Mockito.any(), Mockito.any());

      Mockito.verify(variantEditValidationService)
        .validateL5UpdateRequestWithErrorCode(Mockito.any());
      verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSku(Mockito.any(),
        Mockito.any());

      Assertions.assertTrue(
        exception.getMessage().contains(ApiErrorCode.REQUIRED_L4_DATA_NOT_FOUND_IN_DB.getDesc()));
    }
  }

  @Test
  public void testFindDetailByGdnSkuWithWholesalePrice() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    
    productAndItemsResponse.getItems().get(0).setWholesalePriceExists(true);
    ProductAndItemsResponse productData = generateProductData();
    WholesalePriceSkuResponse wholesalePriceSkuResponse = new WholesalePriceSkuResponse();
    productData.getItems().get(0).setWholesalePriceExists(true);
    wholesalePriceSkuResponse.setItemSku(DEFAULT_GDN_SKU);
    wholesalePriceSkuResponse.setPromoActive(false);
    wholesalePriceSkuResponse.setSkuStatus(ACTIVE);
    Map<Integer, Double> wholesaleRules = new HashMap<>();
    wholesaleRules.put(2, 12.0);
    wholesalePriceSkuResponse.setWholesaleRules(wholesaleRules);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(DEFAULT_GDN_SKU, false))
      .thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isPriceEditDisabled());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(2).isMandatory());
    Assertions.assertTrue(productLevel3.getAttributes().get(0).isBasicView());
    Assertions.assertTrue(productLevel3.getAttributes().get(1).isMandatory());
    Assertions.assertFalse(productLevel3.isWholesalePriceConfigEnabled());
    Assertions.assertFalse(productLevel3.getAttributes().stream().filter(
        productLevel3Attribute -> MasterDataAttributeType.DEFINING_ATTRIBUTE.name()
          .equalsIgnoreCase(productLevel3Attribute.getAttributeType()))
      .allMatch(ProductLevel3Attribute::getSkuValue));
    Assertions.assertEquals(1, productLevel3.getItems().get(0).getProductItemWholesalePrices().size());
    Assertions.assertEquals(2,
      productLevel3.getItems().get(0).getProductItemWholesalePrices().get(0).getQuantity());
    Assertions.assertTrue(productLevel3.getItems().get(0).getWholesalePriceActivated());
    Assertions.assertFalse(productLevel3.getItems().get(0).isWholesalePromoActivated());
  }

  @Test
  public void testFindDetailByGdnSku_whenMasterDataItemIsNull() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    productData2.getItems().get(0).setMasterDataItem(null);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
        Mockito.eq(false)))
      .thenReturn(new GdnRestSingleResponse<>(generateProductData1(), REQUESTID));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
  }

  @Test
  public void testFindDetailByGdnSku_InventoryNull() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU)).thenReturn(null);
    
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
      DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
  }

  @Test
  public void testFindDetailByGdnSku_NotFoundLevel2Inventory() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
      DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(sapOutbound).getCogsValueResponse(any());
  }

  @Test
  public void testFindDetailByGdnSkuWithCogsNull() throws Exception {
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE))).thenReturn(businessPartnerData);
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductWarehouse cogs = null;
    productData2.getProduct().setPreOrder(new PreOrderDTO());
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData2, REQUESTID));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
        DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    Assertions.assertNotNull(productLevel3.getPreOrder());
  }

  @Test
  public void testFindDetailByGdnSkuWithCogsResponseNull() throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductWarehouse cogs = new ProductWarehouse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
  }

  @Test
  public void testFindDetailByGdnSkuWithListDiscountPriceEmpty() throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setSuspended(true);
    productData.getProduct().setForceReview(true);
    this.profileResponse.setTrustedSeller(false);
    this.profileResponse.setCompany(CompanyDTO.builder().merchantType(CM_MERCHANT).build());
    this.profileResponse.setMultiDefaultAddressFlag(true);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "failed"));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
  }

  @Test
  public void testFindDetailByGdnSkuWithListDiscountPriceEmptyForTrustedSeller() throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setSuspended(true);
    productData.getProduct().setForceReview(true);
    this.profileResponse.setTrustedSeller(false);
    this.profileResponse.setCompany(CompanyDTO.builder().merchantType(CM_MERCHANT).build());
    this.profileResponse.setMultiDefaultAddressFlag(true);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "failed"));
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
  }

  @Test
  public void testFindDetailByGdnSkuWithMasterDataAttributeDTOAttributeTypeNull() throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductWarehouse cogs = null;
    productData2.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setAttributeType(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
  }

  @Test
  public void testFindDetailByGdnSkuWithMasterDataAttributeDTONull() throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductWarehouse cogs = null;
    productData2.getProduct().getDescriptiveAttributes().get(0).setAttributeCode("f");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU, false);
    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU),
      Mockito.eq(false));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(sapOutbound).getCogsValueResponse(any());
  }

  @Test
  public void testFindDetailByGdnSkuWithMDCValueAndInventoryLevel1IdIsNullAndSyncedToLevel1IsFalse()
    throws Exception {
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));

    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, null);
  }

  @Test
  public void testFindDetailByGdnSkuWithNullInventory() throws Exception {
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));

    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false));

    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    
    MDC.clear();
  }


  @Test
  public void testFindDetailByGdnSku_whenMerchantTypeNotCmAndRD() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", true);
    this.businessPartnerData.getCompany().setMerchantType("TD");
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));

    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false));
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    MDC.clear();
  }

  @Test
  public void testFindDetailByGdnSku_whenMerchantTypeCmAndRD() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", true);
    ProfileResponse profileResponse = new ProfileResponse();
    CompanyDTO companyDTO = new CompanyDTO();
    companyDTO.setMerchantType("CM");
    profileResponse.setCompany(companyDTO);

    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(profileResponse);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));

    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false));
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    MDC.clear();
  }

  @Test
  public void testFindDetailByGdnSku_whenOBThrowException() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", true);
    this.businessPartnerData.getCompany().setMerchantType("TD");
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.doThrow(new RuntimeException()).when(this.businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));

    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false));
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    MDC.clear();
  }

  @Test
  public void testFindDetailByGdnSkuWithoutDifferentSpecialAttribute() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));

    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_2),
      Mockito.eq(false));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
  }

  @Test
  public void testFindDetailByGdnSkuWithSyncedToLevel1IsFalsePBPMinStockFound() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(Mockito.any()))
      .thenReturn(2);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_4),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));

    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
      DEFAULT_GDN_SKU_4, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_4),
      Mockito.eq(false));

    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU_4);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(productBusinessPartnerService).getMinimumStockByGdnProductItemSku(Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
  }

  @Test
  public void testFindDetailByGdnSkuWithSyncedToLevel1IsFalsePBPMinStockNotFound()
    throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(Mockito.any()))
      .thenReturn(null);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(xProductOutbound.getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_4),
      Mockito.eq(false))).thenReturn(new GdnRestSingleResponse<>(productData, REQUESTID));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));

    this.productLevel3ServiceBean.findDetailByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
      DEFAULT_GDN_SKU_4, false);

    verify(xProductOutbound).getProductAndSingleItemByItemSku(Mockito.eq(DEFAULT_GDN_SKU_4),
      Mockito.eq(false));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU_4);
    verify(productBusinessPartnerService).getMinimumStockByGdnProductItemSku(Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
  }

  @Test
  public void testFindDetailOrderByGdnSku() throws Exception {
    ProductLevel3Order response =
      this.productLevel3ServiceBean.findDetailOrderByGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU));
    Assertions.assertNotNull(response.getItems().get(0).getPrices());
    Assertions.assertEquals(new Double(1000.0),
      response.getItems().get(0).getPrices().get(0).getPrice());
  }

  @SuppressWarnings("unchecked")
  @Test
  public void testFindSummaryByGdnSkuList() throws Exception {
    List<CategoryResponse> categoriesData = new ArrayList<CategoryResponse>();
    categoriesData.add(
      new CategoryResponse("C2", DEFAULT_CATEGORY_CODE, 0, null, "".getBytes(), "".getBytes(), null,
        true, 100, true, false, true, new CatalogResponse(), null));
    List<String> gdnSkuList = new ArrayList<>();
    productItemSummaryDatas.get(0).setPromoTypes(Arrays.asList(PROMOTION_NAME));
    productItemSummaryDatas.get(0).setMerchantPromoDiscount(true);
    productItemSummaryDatas.get(0).setPriceEditDisabled(true);
    productItemSummaryDatas.get(0).setActivePromoBundlings(Collections.singleton(PROMOTION_NAME));
    productItemSummaryDatas.get(0).setOriginalSellingPrice(100);
    Page<ItemSummaryResponse> productItemSummaryDatasPage =
      new PageImpl<>(productItemSummaryDatas, DEFAULT_PAGEABLE, 3);
    productItemSummaryDatas.get(0).setForceReview(true);
    productItemSummaryDatas.get(1).setForceReview(true);
    productItemSummaryDatas.get(2).setForceReview(true);
    productLevel3InventoryList.get(0).setWebItemSku(DEFAULT_GDN_SKU);
    Mockito.when(
        getProductLevel3Repository().findSummaryByFilter(Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          (PageRequest) Mockito.any(), Mockito.any(), Mockito.any()))
      .thenReturn(productItemSummaryDatasPage);

    Mockito.when(
        getCategoryRepository().findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE)))
      .thenReturn(categoriesData);
    Mockito.when(
      getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenReturn(productLevel3InventoryList);
    Mockito.when(
        productLevel3Converter.convertProductLevel3InventoryToMapOfGdnSku(productLevel3InventoryList))
      .thenReturn(ImmutableMap.of(productLevel3InventoryList.get(0).getWebItemSku(),
        productLevel3InventoryList.get(0)));

    Page<ProductLevel3Summary> summaryByGdnSkuList =
      this.productLevel3ServiceBean.findSummaryByGdnSkuList(DEFAULT_BUSINESS_PARTNER_CODE,
        gdnSkuList, DEFAULT_PAGE_REQUEST);

    verify(getProductLevel3Repository()).findSummaryByFilter(Mockito.any(), Mockito.any(),
      (List<String>) Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), (PageRequest) Mockito.any(), Mockito.any(), Mockito.any());
    verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
      productItemSummaryDatas);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList);
    verify(getProductLevel3Converter()).convertProductLevel3InventoryToMapOfGdnSku(
      productLevel3InventoryList);
    verify(productLevel3Converter).convertItemSummaryResponseToItemSkuAndPickupCodeMap(
      productItemSummaryDatasPage.getContent());
    Assertions.assertEquals(1, summaryByGdnSkuList.getContent().size());
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isForceReview());
    Assertions.assertTrue(
      summaryByGdnSkuList.getContent().get(0).getPromoTypes().contains(PROMOTION_NAME));
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isPriceEditDisabled());
    Assertions.assertTrue(
      summaryByGdnSkuList.getContent().get(0).getActivePromoBundlings().contains(PROMOTION_NAME));
    Assertions.assertEquals(100, summaryByGdnSkuList.getContent().get(0).getOriginalSellingPrice(), 0);
  }

  @Test
  public void testFindSummaryByGdnSkuListWithEmptyMap() throws Exception {
    List<CategoryResponse> categoriesData = new ArrayList<>();
    categoriesData.add(
      new CategoryResponse("C2", DEFAULT_CATEGORY_CODE, 0, null, "".getBytes(), "".getBytes(), null,
        true, 100, true, false, true, new CatalogResponse(), null));
    List<String> gdnSkuList = new ArrayList<>();
    productItemSummaryDatas.get(0).setPromoTypes(Arrays.asList(PROMOTION_NAME));
    productItemSummaryDatas.get(0).setMerchantPromoDiscount(true);
    productItemSummaryDatas.get(0).setPriceEditDisabled(true);
    productItemSummaryDatas.get(0).setActivePromoBundlings(Collections.singleton(PROMOTION_NAME));
    productItemSummaryDatas.get(0).setOriginalSellingPrice(100);
    Page<ItemSummaryResponse> productItemSummaryDatasPage =
      new PageImpl<>(productItemSummaryDatas, DEFAULT_PAGEABLE, 3);
    productItemSummaryDatas.get(0).setForceReview(true);
    productItemSummaryDatas.get(1).setForceReview(true);
    productItemSummaryDatas.get(2).setForceReview(true);
    productSystemParameter.setValue("true");
    productLevel3InventoryList.get(0).setWebItemSku(DEFAULT_GDN_SKU);
    CampaignPriceResponse campaignPriceResponse = new CampaignPriceResponse();
    Map<String, CampaignPriceSkuResponse> itemSkuToPriceResponseMap = new HashMap<>();
    CampaignPriceSkuResponse campaignPriceSkuResponse =
      CampaignPriceSkuResponse.builder().campaignPrice(10001.0).maxAllowedPrice(10001.0)
        .minAllowedPrice(2000.0).live(true).registered(true).lockPriceUpdate(true).build();
    campaignPriceSkuResponse.setLockPriceUpdate(false);
    itemSkuToPriceResponseMap.put(ITEM_SKU, campaignPriceSkuResponse);
    itemSkuToPriceResponseMap.put(DEFAULT_GDN_SKU, campaignPriceSkuResponse);
    Mockito.when(
        getProductLevel3Repository().findSummaryByFilter(Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          (PageRequest) Mockito.any(), Mockito.any(), Mockito.any()))
      .thenReturn(productItemSummaryDatasPage);

    Mockito.when(
        getCategoryRepository().findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE)))
      .thenReturn(categoriesData);
    Mockito.when(
      getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenReturn(productLevel3InventoryList);
    Mockito.when(
        productLevel3Converter.convertProductLevel3InventoryToMapOfGdnSku(productLevel3InventoryList))
      .thenReturn(ImmutableMap.of(productLevel3InventoryList.get(0).getWebItemSku(),
        productLevel3InventoryList.get(0)));
    Mockito.when(modelConverter.convertCampaignPriceResponseListToCampaignPriceSkuResponseMap(
      Mockito.anyList())).thenReturn(itemSkuToPriceResponseMap);
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(productSystemParameter);

    Page<ProductLevel3Summary> summaryByGdnSkuList =
      this.productLevel3ServiceBean.findSummaryByGdnSkuList(DEFAULT_BUSINESS_PARTNER_CODE,
        gdnSkuList, DEFAULT_PAGE_REQUEST);

    verify(getProductLevel3Repository()).findSummaryByFilter(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      (PageRequest) Mockito.any(), Mockito.any(), Mockito.any());
    verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
      productItemSummaryDatas);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList);
    verify(getProductLevel3Converter()).convertProductLevel3InventoryToMapOfGdnSku(
      productLevel3InventoryList);
    verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION);
    verify(productLevel3Converter).convertItemSummaryResponseToItemSkuAndPickupCodeMap(
      productItemSummaryDatasPage.getContent());
    Assertions.assertEquals(1, summaryByGdnSkuList.getContent().size());
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isForceReview());
    Assertions.assertTrue(
      summaryByGdnSkuList.getContent().get(0).getPromoTypes().contains(PROMOTION_NAME));
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isPriceEditDisabled());
    Assertions.assertTrue(
      summaryByGdnSkuList.getContent().get(0).getActivePromoBundlings().contains(PROMOTION_NAME));
    Assertions.assertEquals(100, summaryByGdnSkuList.getContent().get(0).getOriginalSellingPrice(), 0);
  }

  @Test
  public void testFindSummaryByGdnSkuListWithEmptyMap2() throws Exception {
    List<CategoryResponse> categoriesData = new ArrayList<>();
    categoriesData.add(
      new CategoryResponse("C2", DEFAULT_CATEGORY_CODE, 0, null, "".getBytes(), "".getBytes(), null,
        true, 100, true, false, true, new CatalogResponse(), null));
    List<String> gdnSkuList = new ArrayList<>();
    productItemSummaryDatas.get(0).setPromoTypes(Arrays.asList(PROMOTION_NAME));
    productItemSummaryDatas.get(0).setMerchantPromoDiscount(true);
    productItemSummaryDatas.get(0).setPriceEditDisabled(true);
    productItemSummaryDatas.get(0).setActivePromoBundlings(Collections.singleton(PROMOTION_NAME));
    productItemSummaryDatas.get(0).setOriginalSellingPrice(100);
    Page<ItemSummaryResponse> productItemSummaryDatasPage =
      new PageImpl<>(productItemSummaryDatas, DEFAULT_PAGEABLE, 3);
    productItemSummaryDatas.get(0).setForceReview(true);
    productItemSummaryDatas.get(1).setForceReview(true);
    productItemSummaryDatas.get(2).setForceReview(true);
    productSystemParameter.setValue("true");
    productLevel3InventoryList.get(0).setWebItemSku(DEFAULT_GDN_SKU);
    CampaignPriceResponse campaignPriceResponse = new CampaignPriceResponse();
    Map<String, CampaignPriceSkuResponse> itemSkuToPriceResponseMap = new HashMap<>();
    CampaignPriceSkuResponse campaignPriceSkuResponse =
      CampaignPriceSkuResponse.builder().campaignPrice(10001.0).maxAllowedPrice(10001.0)
        .minAllowedPrice(2000.0).live(true).registered(true).lockPriceUpdate(true).build();
    itemSkuToPriceResponseMap.put(ITEM_SKU, campaignPriceSkuResponse);
    Mockito.when(
        getProductLevel3Repository().findSummaryByFilter(Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          (PageRequest) Mockito.any(), Mockito.any(), Mockito.any()))
      .thenReturn(productItemSummaryDatasPage);

    Mockito.when(
        getCategoryRepository().findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE)))
      .thenReturn(categoriesData);
    Mockito.when(
      getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(),
        anyList())).thenReturn(productLevel3InventoryList);
    Mockito.when(
        productLevel3Converter.convertProductLevel3InventoryToMapOfGdnSku(productLevel3InventoryList))
      .thenReturn(ImmutableMap.of(productLevel3InventoryList.get(0).getWebItemSku(),
        productLevel3InventoryList.get(0)));
    Mockito.when(modelConverter.convertCampaignPriceResponseListToCampaignPriceSkuResponseMap(
      Mockito.anyList())).thenReturn(itemSkuToPriceResponseMap);
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(productSystemParameter);

    Page<ProductLevel3Summary> summaryByGdnSkuList =
      this.productLevel3ServiceBean.findSummaryByGdnSkuList(DEFAULT_BUSINESS_PARTNER_CODE,
        gdnSkuList, DEFAULT_PAGE_REQUEST);

    verify(getProductLevel3Repository()).findSummaryByFilter(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      (PageRequest) Mockito.any(), Mockito.any(), Mockito.any());
    verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
      productItemSummaryDatas);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      any(), anyList());
    verify(getProductLevel3Converter()).convertProductLevel3InventoryToMapOfGdnSku(
      productLevel3InventoryList);
    verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION);
    verify(productLevel3Converter).convertItemSummaryResponseToItemSkuAndPickupCodeMap(
      productItemSummaryDatasPage.getContent());
    Assertions.assertEquals(1, summaryByGdnSkuList.getContent().size());
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isForceReview());
    Assertions.assertTrue(
      summaryByGdnSkuList.getContent().get(0).getPromoTypes().contains(PROMOTION_NAME));
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isPriceEditDisabled());
    Assertions.assertTrue(
      summaryByGdnSkuList.getContent().get(0).getActivePromoBundlings().contains(PROMOTION_NAME));
    Assertions.assertEquals(100, summaryByGdnSkuList.getContent().get(0).getOriginalSellingPrice(), 0);
  }

  @Test
  public void testFindSummaryByGdnSkuListWithEmptyMap3() throws Exception {
    List<CategoryResponse> categoriesData = new ArrayList<>();
    categoriesData.add(
      new CategoryResponse("C2", DEFAULT_CATEGORY_CODE, 0, null, "".getBytes(), "".getBytes(), null,
        true, 100, true, false, true, new CatalogResponse(), null));
    List<String> gdnSkuList = new ArrayList<>();
    productItemSummaryDatas.get(0).setPromoTypes(Arrays.asList(PROMOTION_NAME));
    productItemSummaryDatas.get(0).setMerchantPromoDiscount(true);
    productItemSummaryDatas.get(0).setPriceEditDisabled(true);
    productItemSummaryDatas.get(0).setActivePromoBundlings(Collections.singleton(PROMOTION_NAME));
    productItemSummaryDatas.get(0).setOriginalSellingPrice(100);
    Set<String> set = new HashSet<>();
    set.add(PREORDER_TYPE);
    productItemSummaryDatas.get(0).setPriceEditDisabledReasons(set);
    Page<ItemSummaryResponse> productItemSummaryDatasPage =
      new PageImpl<>(productItemSummaryDatas, DEFAULT_PAGEABLE, 3);
    productItemSummaryDatas.get(0).setForceReview(true);
    productItemSummaryDatas.get(1).setForceReview(true);
    productItemSummaryDatas.get(2).setForceReview(true);
    productSystemParameter.setValue("true");
    productLevel3InventoryList.get(0).setWebItemSku(DEFAULT_GDN_SKU);
    CampaignPriceResponse campaignPriceResponse = new CampaignPriceResponse();
    Map<String, CampaignPriceSkuResponse> itemSkuToPriceResponseMap = new HashMap<>();
    CampaignPriceSkuResponse campaignPriceSkuResponse =
      CampaignPriceSkuResponse.builder().campaignPrice(10001.0).maxAllowedPrice(10001.0)
        .minAllowedPrice(2000.0).live(true).registered(true).lockPriceUpdate(true).build();
    campaignPriceSkuResponse.setLockPriceUpdate(true);
    itemSkuToPriceResponseMap.put(ITEM_SKU, campaignPriceSkuResponse);
    itemSkuToPriceResponseMap.put(DEFAULT_GDN_SKU, campaignPriceSkuResponse);
    Mockito.when(
        getProductLevel3Repository().findSummaryByFilter(Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          (PageRequest) Mockito.any(), Mockito.any(), Mockito.any()))
      .thenReturn(productItemSummaryDatasPage);

    Mockito.when(
        getCategoryRepository().findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE)))
      .thenReturn(categoriesData);
    Mockito.when(
      getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList)).thenReturn(productLevel3InventoryList);
    Mockito.when(
        productLevel3Converter.convertProductLevel3InventoryToMapOfGdnSku(productLevel3InventoryList))
      .thenReturn(ImmutableMap.of(productLevel3InventoryList.get(0).getWebItemSku(),
        productLevel3InventoryList.get(0)));
    Mockito.when(modelConverter.convertCampaignPriceResponseListToCampaignPriceSkuResponseMap(
      Mockito.anyList())).thenReturn(itemSkuToPriceResponseMap);
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(productSystemParameter);

    Page<ProductLevel3Summary> summaryByGdnSkuList =
      this.productLevel3ServiceBean.findSummaryByGdnSkuList(DEFAULT_BUSINESS_PARTNER_CODE,
        gdnSkuList, DEFAULT_PAGE_REQUEST);

    verify(getProductLevel3Repository()).findSummaryByFilter(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      (PageRequest) Mockito.any(), Mockito.any(), Mockito.any());
    verify(getProductLevel3Converter()).convertItemSummaryResponseToListOfGdnSku(
      productItemSummaryDatas);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList);
    verify(getProductLevel3Converter()).convertProductLevel3InventoryToMapOfGdnSku(
      productLevel3InventoryList);
    verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION);
    verify(productLevel3Converter).convertItemSummaryResponseToItemSkuAndPickupCodeMap(
      productItemSummaryDatasPage.getContent());
    Assertions.assertEquals(1, summaryByGdnSkuList.getContent().size());
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isForceReview());
    Assertions.assertTrue(
      summaryByGdnSkuList.getContent().get(0).getPromoTypes().contains(PROMOTION_NAME));
    Assertions.assertTrue(summaryByGdnSkuList.getContent().get(0).isPriceEditDisabled());
    Assertions.assertTrue(
      summaryByGdnSkuList.getContent().get(0).getActivePromoBundlings().contains(PROMOTION_NAME));
    Assertions.assertEquals(100, summaryByGdnSkuList.getContent().get(0).getOriginalSellingPrice(), 0);
  }

  @Test
  public void testFindSummaryByGdnSkuList_EmptyTest() throws Exception {
    Page<ItemSummaryResponse> itemDatas =
      new PageImpl<ItemSummaryResponse>(new ArrayList<>(), pageable, 10);

    List<CategoryResponse> categoriesData = new ArrayList<CategoryResponse>();
    categoriesData.add(
      new CategoryResponse("C2", DEFAULT_CATEGORY_CODE, 0, null, "".getBytes(), "".getBytes(), null,
        true, 100, true, false, true, new CatalogResponse(), null));
    Mockito.when(
        getProductLevel3Repository().findSummaryByFilter(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(), (PageRequest) Mockito.any(), Mockito.any(), Mockito.any()))
      .thenReturn(itemDatas);

    List<String> gdnSkuList = new ArrayList<>();
    gdnSkuList.add(DEFAULT_GDN_SKU);
    this.productLevel3ServiceBean.findSummaryByGdnSkuList(DEFAULT_BUSINESS_PARTNER_CODE, gdnSkuList,
      DEFAULT_PAGE_REQUEST);
    verify(getProductLevel3Repository()).findSummaryByFilter(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      (PageRequest) Mockito.any(), Mockito.any(), Mockito.any());
  }

  @Test
  public void testSynchronizeProduct() throws Exception {
    Mockito.when(getProductLevel3Repository().synchronizeProduct(Mockito.any()))
      .thenReturn(generateProductData());
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setSynchronized(false);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.synchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).synchronizeProduct(DEFAULT_PRODUCT_SKU);
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE,
      Constants.DEFAULT, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      UpdateProductActivity.SYNC_CONTENT.getDesc(), String.valueOf(false), String.valueOf(true),
      false, StringUtils.EMPTY);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void testSynchronizeProductForRejectedProduct() throws Exception {
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setMarkForDelete(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    when(productBusinessPartnerRepository.countRejectedProductByGdnProductSku(
      Mockito.any())).thenReturn(1);

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.synchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).countRejectedProductByGdnProductSku(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_REJECTED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void testSynchronizeProductForSynchronizedProduct() throws Exception {
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setSynchronized(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.synchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void testSynchronizeProductForSuspendedProduct() throws Exception {
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setMarkForDelete(true);
    savedProductData1.setSuspended(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.synchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(productBusinessPartnerRepository).countRejectedProductByGdnProductSku(Mockito.any());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_SUSPENDED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void testSynchronizeProductForArchivedItem() throws Exception {
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setArchived(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.synchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_ARCHIVED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void testUnsynchronizeProduct() throws Exception {
    Mockito.when(getProductLevel3Repository().unsynchronizeProduct(Mockito.any()))
      .thenReturn(generateProductData());
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.unsynchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).unsynchronizeProduct(DEFAULT_PRODUCT_SKU);
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE,
      Constants.DEFAULT, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      UpdateProductActivity.SYNC_CONTENT.getDesc(), String.valueOf(true), String.valueOf(false),
      false, StringUtils.EMPTY);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void testUnsynchronizeProductForRejectedProduct() throws Exception {
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setMarkForDelete(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    when(productBusinessPartnerRepository.countRejectedProductByGdnProductSku(
      Mockito.any())).thenReturn(1);

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.unsynchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).countRejectedProductByGdnProductSku(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_REJECTED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void testUnsynchronizeProductForSuspendedProduct() throws Exception {
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setMarkForDelete(true);
    savedProductData1.setSuspended(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.unsynchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(productBusinessPartnerRepository).countRejectedProductByGdnProductSku(Mockito.any());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_SUSPENDED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void testUnsynchronizeProductForArchivedItem() throws Exception {
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setArchived(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.unsynchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_ARCHIVED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void testUnsynchronizeProductForUnsychronizedProduct() throws Exception {
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setSynchronized(false);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ApiErrorCode apiErrorCode =
      this.productLevel3ServiceBean.unsynchronizeProduct(DEFAULT_PRODUCT_SKU, DEFAULT_GDN_SKU);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void testUpdateItemStock() throws Exception {
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(any(), any())).thenReturn(pageOfItems);
    this.productLevel3ServiceBean.updateItemStock(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU, 0,
      null);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(Mockito.any(), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Inventory(
      Mockito.any(ProductLevel3Inventory.class));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(
      DEFAULT_GDN_SKU);
    verify(xProductOutbound).findSummaryDetailsByFilter(any(), any());
  }

  @Test
  public void testUpdateItemStock_empty() throws Exception {
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(any(), any()))
      .thenReturn(new PageImpl<>(Arrays.asList()));
    this.productLevel3ServiceBean.updateItemStock(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU, 0,
      null);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(Mockito.any(), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(
      DEFAULT_GDN_SKU);
    verify(xProductOutbound).findSummaryDetailsByFilter(any(), any());
  }

  @Test
  public void testUpdateItemStockForceReviewTest() throws Exception {
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(any(), any())).thenReturn(pageOfItems);
    Mockito.when(
        productItemBusinessPartnerService.findReviewPendingProductCodeByItemSku(DEFAULT_GDN_SKU))
      .thenReturn(PRODUCT_CODE);
    productImageQcProcessingResponse.setForceReview(false);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(
      Constants.DEFAULT_STORE_ID, PRODUCT_CODE)).thenReturn(productImageQcProcessingResponse);
    this.productLevel3ServiceBean.updateItemStock(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU, 0,
      null);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(Mockito.any(), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Inventory(
      Mockito.any(ProductLevel3Inventory.class));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(
      DEFAULT_GDN_SKU);
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(
      Constants.DEFAULT_STORE_ID, PRODUCT_CODE);
    verify(xProductOutbound).findSummaryDetailsByFilter(any(), any());
  }

  @Test
  public void testUpdateItemStockForceReviewTrueTest() throws Exception {
    Mockito.when(
        productItemBusinessPartnerService.findReviewPendingProductCodeByItemSku(DEFAULT_GDN_SKU))
      .thenReturn(PRODUCT_CODE);
    productImageQcProcessingResponse.setForceReview(true);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(
      Constants.DEFAULT_STORE_ID, PRODUCT_CODE)).thenReturn(productImageQcProcessingResponse);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateItemStock(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
            0, null);
      });
    } finally {
      verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(
        DEFAULT_GDN_SKU);
      verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(
        Constants.DEFAULT_STORE_ID, PRODUCT_CODE);
    }
  }

  @Test
  public void testUpdateItemStockForceReviewImageQcEmptyTest() throws Exception {
    Mockito.when(
        productItemBusinessPartnerService.findReviewPendingProductCodeByItemSku(DEFAULT_GDN_SKU))
      .thenReturn(PRODUCT_CODE);
    Pageable PAGEABLE = PageRequest.of(0, 1);
    ItemSummaryRequest itemFilterRequest = new ItemSummaryRequest();
    itemFilterRequest.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    itemFilterRequest.setItemSkus(Arrays.asList(DEFAULT_GDN_SKU));
    itemFilterRequest.setMarkForDelete(true);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(any(), any())).thenReturn(pageOfItems);
    this.productLevel3ServiceBean.updateItemStock(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU, 0,
      null);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(Mockito.any(), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Inventory(
      Mockito.any(ProductLevel3Inventory.class));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(
      DEFAULT_GDN_SKU);
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(
      Constants.DEFAULT_STORE_ID, PRODUCT_CODE);
    verify(xProductOutbound).findSummaryDetailsByFilter(any(), any());
  }

  @Test
  public void update_2_Test() throws Exception {
    this.productLevel3ServiceBean.update(new ProductRequest(), Boolean.FALSE);
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
  }

  @Test
  public void updateItemOff2OnTest() throws Exception {
    this.productLevel3ServiceBean.updateItemOff2On(true, DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateItemOff2OnActivate(DEFAULT_GDN_SKU);
    this.productLevel3ServiceBean.updateItemOff2On(false, DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateItemOff2OnDeactivate(DEFAULT_GDN_SKU);
    this.productLevel3ServiceBean.updateItemOff2On(null, DEFAULT_GDN_SKU);
  }

  @Test
  public void updateItemPriceTest() throws Exception {
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.productPricingOutbound.setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any())).thenReturn(true);
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID, productPriceAndWholesaleRequest,
      ITEM_SKU);
    verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter,
      TWO_TIMES).convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class));
    verify(this.productPricingOutbound).getWholesalePrice(eq(ITEM_SKU), Mockito.any());
    verify(this.productPricingOutbound).upsertWholesalePrice(
      Mockito.any(WholesalePriceRequest.class));
    verify(this.productPricingOutbound).setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(getProductLevel3Repository()).updateItemPrice((PriceRequest) Mockito.any(),
      Mockito.any());
    verify(this.mapperUtil, times(2)).mapRequestToString(Mockito.anyList());
    verify(this.wholesaleValidationUtil).validateWholesalePriceRequestForUpdate(DEFAULT_STORE_ID,
      productPriceAndWholesaleRequest, ITEM_SKU, item, 1);
    verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
      Mockito.any(ProductAndItemsResponse.class));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(item.getProduct().getMasterCatalog().getCategory().getCategoryCode(),
      value.getDiscountDTOList().get(0).getCategoryCode());
    Assertions.assertEquals(ITEM_SKU, value.getDiscountDTOList().get(0).getItemSku());
    Assertions.assertEquals(productPriceAndWholesaleRequest.getOfferPrice(),
      value.getDiscountDTOList().get(0).getSellingPrice(), 0);
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemPriceMasterCategoryNullTest() throws Exception {
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    ProductAndItemsResponse item = generateProductData();
    item.getProduct().setMasterCatalog(null);
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.productPricingOutbound.setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any())).thenReturn(true);
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID, productPriceAndWholesaleRequest,
      ITEM_SKU);
    verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter,
      TWO_TIMES).convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class));
    verify(this.productPricingOutbound).getWholesalePrice(eq(ITEM_SKU), Mockito.any());
    verify(this.productPricingOutbound).upsertWholesalePrice(
      Mockito.any(WholesalePriceRequest.class));
    verify(this.productPricingOutbound).setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(getProductLevel3Repository()).updateItemPrice((PriceRequest) Mockito.any(),
      Mockito.any());
    verify(this.mapperUtil, times(2)).mapRequestToString(Mockito.anyList());
    verify(this.wholesaleValidationUtil).validateWholesalePriceRequestForUpdate(DEFAULT_STORE_ID,
      productPriceAndWholesaleRequest, ITEM_SKU, item, 1);
    verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
      Mockito.any(ProductAndItemsResponse.class));
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertTrue(StringUtils.isBlank(value.getDiscountDTOList().get(0).getCategoryCode()));
    Assertions.assertEquals(ITEM_SKU, value.getDiscountDTOList().get(0).getItemSku());
    Assertions.assertEquals(productPriceAndWholesaleRequest.getOfferPrice(),
      value.getDiscountDTOList().get(0).getSellingPrice(), 0);
  }

  @Test
  public void updateItemPriceValidateError() throws Exception {
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    doThrow(ApplicationRuntimeException.class).when(campaignOutbound)
      .validateDiscountPrice(anyBoolean(), any(CampaignUpdateDiscountRequest.class));
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.productPricingOutbound.setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any())).thenReturn(true);
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    Map<String, String> itemSkuMap = new HashMap<>();
    itemSkuMap.putIfAbsent(ITEM_SKU, ITEM_SKU);
    campaignUpdateDiscountResponse.setItemSkuStatusMap(itemSkuMap);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID,
            productPriceAndWholesaleRequest, ITEM_SKU);
      });
    } finally {
      verify(productLevel3Repository).findDetailByGdnSku(ITEM_SKU);
      verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
        Mockito.any(ProductAndItemsResponse.class));
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
    }
  }

  @Test
  public void updateItemPriceNullResponseTest() throws Exception {
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    campaignUpdateDiscountResponse.setItemSkuStatusMap(new HashMap<>());
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    when(campaignOutbound.validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.productPricingOutbound.setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any())).thenReturn(true);
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    Map<String, String> itemSkuMap = new HashMap<>();
    itemSkuMap.putIfAbsent(ITEM_SKU, ITEM_SKU);
    campaignUpdateDiscountResponse.setItemSkuStatusMap(itemSkuMap);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID,
            productPriceAndWholesaleRequest, ITEM_SKU);
      });
    } finally {
      verify(productLevel3Repository).findDetailByGdnSku(ITEM_SKU);
      verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
        Mockito.any(ProductAndItemsResponse.class));
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
    }
  }

  @Test
  public void updateItemPriceCampaignUpdateNullResponseTest() throws Exception {
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    campaignUpdateDiscountResponse.setItemSkuStatusMap(new HashMap<>());
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    when(campaignOutbound.validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(
      CampaignUpdateDiscountResponse.builder().build());
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.productPricingOutbound.setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any())).thenReturn(true);
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    Map<String, String> itemSkuMap = new HashMap<>();
    itemSkuMap.putIfAbsent(ITEM_SKU, ITEM_SKU);
    campaignUpdateDiscountResponse.setItemSkuStatusMap(itemSkuMap);
    try {
    } finally {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID,
            productPriceAndWholesaleRequest, ITEM_SKU);
      });
      verify(productLevel3Repository).findDetailByGdnSku(ITEM_SKU);
      verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
        Mockito.any(ProductAndItemsResponse.class));
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
      verify(getProductLevel3Repository()).updateItemPrice((PriceRequest) Mockito.any(),
        Mockito.any());
      verify(this.wholesaleValidationUtil).validateWholesalePriceRequestForUpdate(DEFAULT_STORE_ID,
        productPriceAndWholesaleRequest, ITEM_SKU, item, 1);
      verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
        Mockito.any(ProductAndItemsResponse.class));
      verify(this.productPricingOutbound).getWholesalePrice(eq(ITEM_SKU), Mockito.any());
      verify(this.productPricingOutbound).upsertWholesalePrice(
        Mockito.any(WholesalePriceRequest.class));
      verify(this.productPricingOutbound).setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
        Mockito.any());
      verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
    }
  }

  @Test
  public void updateItemPriceCategoryNullTest() throws Exception {
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    ProductAndItemsResponse item = generateProductData();
    item.getProduct().getMasterCatalog().setCategory(null);
    item.getItems().get(0).setArchived(false);
    Mockito.when(campaignOutbound.validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(null);
    Mockito.when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(null);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.productPricingOutbound.setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any())).thenReturn(true);
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID, productPriceAndWholesaleRequest,
      ITEM_SKU);
    verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter,
      TWO_TIMES).convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class));
    verify(this.productPricingOutbound).getWholesalePrice(eq(ITEM_SKU), Mockito.any());
    verify(this.productPricingOutbound).upsertWholesalePrice(
      Mockito.any(WholesalePriceRequest.class));
    verify(this.productPricingOutbound).setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(getProductLevel3Repository()).updateItemPrice((PriceRequest) Mockito.any(),
      Mockito.any());
    verify(this.mapperUtil, times(2)).mapRequestToString(Mockito.anyList());
    verify(this.wholesaleValidationUtil).validateWholesalePriceRequestForUpdate(DEFAULT_STORE_ID,
      productPriceAndWholesaleRequest, ITEM_SKU, item, 1);
    verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
      Mockito.any(ProductAndItemsResponse.class));
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemPriceExceptionTest() throws Exception {
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.productPricingOutbound.setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any())).thenReturn(true);
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    Mockito.doThrow(ApplicationException.class).when(getProductLevel3Repository())
      .updateItemPrice((PriceRequest) Mockito.any(), Mockito.any());
    try {
      Assertions.assertThrows(ApplicationException.class, () -> {
        productPriceAndWholesaleRequest.setOfferPrice(10000);
        this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID,
            productPriceAndWholesaleRequest, ITEM_SKU);
      });
    } finally {
      verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        Constants.MINIMUM_PRICE);
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
      verify(this.productPricingOutbound).getWholesalePrice(eq(ITEM_SKU), Mockito.any());
      verify(this.productPricingOutbound).upsertWholesalePrice(
        Mockito.any(WholesalePriceRequest.class));
      verify(this.productPricingOutbound).setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
        Mockito.any());
      verify(getProductLevel3Repository()).updateItemPrice((PriceRequest) Mockito.any(),
        Mockito.any());
      verify(this.wholesaleValidationUtil).validateWholesalePriceRequestForUpdate(DEFAULT_STORE_ID,
        productPriceAndWholesaleRequest, ITEM_SKU, item, 1);
      verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
        Mockito.any(ProductAndItemsResponse.class));
    }
  }

  @Test
  public void updateItemPriceException_priceEditDisabledTest() throws Exception {
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    productPriceAndWholesaleRequest.setOfferPrice(20000);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.productPricingOutbound.setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
      Mockito.any())).thenReturn(true);
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    Mockito.doThrow(ApplicationException.class).when(getProductLevel3Repository())
      .updateItemPrice((PriceRequest) Mockito.any(), Mockito.any());
    try {
      Assertions.assertThrows(ApplicationException.class, () -> {
        this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID,
            productPriceAndWholesaleRequest, ITEM_SKU);
      });
    } finally {
      verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        Constants.MINIMUM_PRICE);
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
      verify(this.productPricingOutbound).getWholesalePrice(eq(ITEM_SKU), Mockito.any());
      verify(this.productPricingOutbound).upsertWholesalePrice(
        Mockito.any(WholesalePriceRequest.class));
      verify(this.productPricingOutbound).setWholesaleActivated(eq(ITEM_SKU), eq(ACTIVE_STATUS),
        Mockito.any());
      verify(getProductLevel3Repository()).updateItemPrice((PriceRequest) Mockito.any(),
        Mockito.any());
      verify(this.wholesaleValidationUtil).validateWholesalePriceRequestForUpdate(DEFAULT_STORE_ID,
        productPriceAndWholesaleRequest, ITEM_SKU, item, 1);
      verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
        Mockito.any(ProductAndItemsResponse.class));
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
    }
  }

  @Test
  public void updateItemTest() throws Exception {
    ItemRequest itemRequest = new ItemRequest();
    itemRequest.setItemSku(ITEM_SKU);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(ITEM_SKU))
      .thenReturn(generateProductData());
    Mockito.when(
      xProductOutbound.updateItem(Mockito.anyBoolean(), Mockito.eq(false), Mockito.eq(false),
        Mockito.any(ItemRequest.class))).thenReturn(new ItemResponse());
    this.productLevel3ServiceBean.updateItem(itemRequest, Boolean.TRUE);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter,
      TWO_TIMES).convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, null, null, StringUtils.EMPTY, DEFAULT_GDN_SKU, null,
      false, StringUtils.EMPTY);
    verify(xProductOutbound).updateItem(true, false, false, itemRequest);
    verify(xProductOutbound).updateItem(true, false, false, itemRequest);
  }

  @Test
  public void updateItemViewConfigTest() throws Exception {
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemViewConfig((ItemViewConfigRequest) Mockito.any(), Mockito.any());
    this.productLevel3ServiceBean.updateItemViewConfig(itemViewConfigRequest, ITEM_SKU, StringUtils.EMPTY);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(ITEM_SKU);
    verify(this.updateProductItemLevel3ModelConverter,
      TWO_TIMES).convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(getProductLevel3Repository()).updateItemViewConfig(
      (ItemViewConfigRequest) Mockito.any(), Mockito.any());
  }

  @Test
  public void updateSummaryInventoryNullTest() throws Exception {
    try {
      ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
      request.getPrices().get(0).setSalePrice(20000.0);
      Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenReturn(null);
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
            request);
      });
    } finally {
      verify(getProductLevel3Repository()).findSummaryByGdnSku(DEFAULT_GDN_SKU);
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
    }
  }

  @Test
  public void updateSummaryTest() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
      Mockito.any());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    Assertions.assertFalse(productLevel3Summary.getWholesalePriceActivated());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
  }

  @Test
  public void updateSummaryTestMerchantSkuUpdate() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    ItemSummaryResponse itemSummaryResponseNew = generateItemSummaryData();
    itemSummaryResponseNew.setMerchantSku(DEFAULT_MERCHANT_SKU_2);
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any()))
      .thenReturn(itemSummaryResponseNew);
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
      Mockito.any());
    Assertions.assertFalse(productLevel3Summary.getWholesalePriceActivated());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
  }

  @Test
  public void updateSummaryTestMerchantSkuUpdateExistingPriceEmpty() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    ItemSummaryResponse itemSummaryResponseNew = generateItemSummaryData();
    itemSummaryResponseNew.setMerchantSku(DEFAULT_MERCHANT_SKU_2);
    itemSummaryResponseNew.setPrice(new HashSet<>());
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any()))
      .thenReturn(itemSummaryResponseNew);
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
      Mockito.any());
    Assertions.assertFalse(productLevel3Summary.getWholesalePriceActivated());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
  }

  @Test
  public void updateSummaryTestMerchantSkuUpdateOfferPriceChange() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.getPrices().get(0).setPrice(1000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    ItemSummaryResponse itemSummaryResponseNew = generateItemSummaryData();
    itemSummaryResponseNew.setMerchantSku(DEFAULT_MERCHANT_SKU_2);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any()))
      .thenReturn(itemSummaryResponseNew);
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
      Mockito.any());
    Assertions.assertFalse(productLevel3Summary.getWholesalePriceActivated());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
  }

  @Test
  public void updateSummaryTestMerchantSkuUpdatePriceNotChanged() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(10000.0);
    request.getPrices().get(0).setPrice(1000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    ItemSummaryResponse itemSummaryResponseNew = generateItemSummaryData();
    itemSummaryResponseNew.setMerchantSku(DEFAULT_MERCHANT_SKU_2);
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any()))
      .thenReturn(itemSummaryResponseNew);
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
      Mockito.any());
    Assertions.assertFalse(productLevel3Summary.getWholesalePriceActivated());
  }

  @Test
  public void updateSummaryTestWithNullResponse() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(null, REQUESTID));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
  }

  @Test
  public void updateSummaryTestWithEmptyCampaignResponse() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    campaignUpdateDiscountResponse.setItemSkuStatusMap(new HashMap<>());
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(null, REQUESTID));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }


  private WholesaleMappingResponse getWholeSaleMapping() {
    WholesaleMappingResponse wholesaleMappingResponse = new WholesaleMappingResponse();
    wholesaleMappingResponse.setWholesalePriceConfigEnabled(true);
    MinWholesaleDiscountResponse minWholesaleDiscountResponse = new MinWholesaleDiscountResponse();
    minWholesaleDiscountResponse.setPercentage(20.0);
    minWholesaleDiscountResponse.setPrice(10000.0);
    MinWholesaleDiscountResponse minWholesaleDiscountResponse1 = new MinWholesaleDiscountResponse();
    minWholesaleDiscountResponse1.setPercentage(30.0);
    minWholesaleDiscountResponse1.setPrice(50000.0);
    WholesaleConfigResponse wholesaleConfigResponse = new WholesaleConfigResponse();
    wholesaleConfigResponse.setQuantity(20);
    wholesaleConfigResponse.setMinWholesaleDiscount(new ArrayList<>());
    wholesaleConfigResponse.getMinWholesaleDiscount().add(minWholesaleDiscountResponse);
    WholesaleConfigResponse wholesaleConfigResponse1 = new WholesaleConfigResponse();
    wholesaleConfigResponse1.setQuantity(20);
    wholesaleConfigResponse1.setMinWholesaleDiscount(new ArrayList<>());
    wholesaleConfigResponse1.getMinWholesaleDiscount().add(minWholesaleDiscountResponse1);
    wholesaleMappingResponse.setWholesaleConfig(new ArrayList<>());
    wholesaleMappingResponse.getWholesaleConfig().add(wholesaleConfigResponse);
    wholesaleMappingResponse.getWholesaleConfig().add(wholesaleConfigResponse1);
    return wholesaleMappingResponse;
  }

  @Test
  public void updateSummaryTest_NoChange() throws Exception {
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    ItemSummaryResponse itemSummaryResponse = generateItemSummaryData();
    request.setViewConfigs(new ArrayList<>());
    for (ItemViewConfigDTO itemViewConfigDTO : itemSummaryResponse.getItemViewConfigs()) {
      ProductLevel3ViewConfig productLevel3ViewConfig = new ProductLevel3ViewConfig();
      productLevel3ViewConfig.setBuyable(itemViewConfigDTO.isBuyable());
      productLevel3ViewConfig.setDisplay(itemViewConfigDTO.isDiscoverable());
      productLevel3ViewConfig.setChannelId(itemViewConfigDTO.getChannel());
      request.getViewConfigs().add(productLevel3ViewConfig);
      itemViewConfigDTO.setItemBuyableSchedules(null);
      itemViewConfigDTO.setItemDiscoverableSchedules(null);
    }
    request.setPrices(new ArrayList<>());
    itemSummaryResponse.setPrice(new HashSet<>());
    request.setLateFulfillment(itemSummaryResponse.isLateFulfillment());
    request.setMerchantSku(itemSummaryResponse.getMerchantSku());
    request.setPickupPointCode(itemSummaryResponse.getPickupPointCode());
    request.setOff2OnActiveFlag(itemSummaryResponse.isOff2OnChannelActive());
    request.setWholesalePriceActivated(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(this.productLevel3Repository.findSummaryByGdnSku(DEFAULT_GDN_SKU)).thenReturn(
      itemSummaryResponse);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
      request);
    verify(getProductLevel3Repository(), times(2)).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
  }

  @Test
  public void updateSummaryTest_NoChangeExistingMerchantSkuNull() throws Exception {
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    ItemSummaryResponse itemSummaryResponse = generateItemSummaryData();
    request.setViewConfigs(new ArrayList<>());
    for (ItemViewConfigDTO itemViewConfigDTO : itemSummaryResponse.getItemViewConfigs()) {
      ProductLevel3ViewConfig productLevel3ViewConfig = new ProductLevel3ViewConfig();
      productLevel3ViewConfig.setBuyable(itemViewConfigDTO.isBuyable());
      productLevel3ViewConfig.setDisplay(itemViewConfigDTO.isDiscoverable());
      productLevel3ViewConfig.setChannelId(itemViewConfigDTO.getChannel());
      request.getViewConfigs().add(productLevel3ViewConfig);
      itemViewConfigDTO.setItemBuyableSchedules(null);
      itemViewConfigDTO.setItemDiscoverableSchedules(null);
    }
    request.setPrices(new ArrayList<>());
    itemSummaryResponse.setPrice(new HashSet<>());
    request.setLateFulfillment(itemSummaryResponse.isLateFulfillment());
    request.setMerchantSku(itemSummaryResponse.getMerchantSku());
    request.setPickupPointCode(itemSummaryResponse.getPickupPointCode());
    request.setOff2OnActiveFlag(itemSummaryResponse.isOff2OnChannelActive());
    request.setWholesalePriceActivated(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    itemSummaryResponse.setMerchantSku(null);
    when(this.productLevel3Repository.findSummaryByGdnSku(DEFAULT_GDN_SKU)).thenReturn(
      itemSummaryResponse);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
      request);
    verify(getProductLevel3Repository(), times(2)).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
  }

  @Test
  public void updateSummaryTest_NoChangeUpdateMerchantSkuNull() throws Exception {
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    ItemSummaryResponse itemSummaryResponse = generateItemSummaryData();
    request.setViewConfigs(new ArrayList<>());
    for (ItemViewConfigDTO itemViewConfigDTO : itemSummaryResponse.getItemViewConfigs()) {
      ProductLevel3ViewConfig productLevel3ViewConfig = new ProductLevel3ViewConfig();
      productLevel3ViewConfig.setBuyable(itemViewConfigDTO.isBuyable());
      productLevel3ViewConfig.setDisplay(itemViewConfigDTO.isDiscoverable());
      productLevel3ViewConfig.setChannelId(itemViewConfigDTO.getChannel());
      request.getViewConfigs().add(productLevel3ViewConfig);
      itemViewConfigDTO.setItemBuyableSchedules(null);
      itemViewConfigDTO.setItemDiscoverableSchedules(null);
    }
    request.setPrices(new ArrayList<>());
    itemSummaryResponse.setPrice(new HashSet<>());
    request.setLateFulfillment(itemSummaryResponse.isLateFulfillment());
    request.setMerchantSku(null);
    request.setPickupPointCode(itemSummaryResponse.getPickupPointCode());
    request.setOff2OnActiveFlag(itemSummaryResponse.isOff2OnChannelActive());
    request.setWholesalePriceActivated(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(this.productLevel3Repository.findSummaryByGdnSku(DEFAULT_GDN_SKU)).thenReturn(
      itemSummaryResponse);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
      request);
    verify(getProductLevel3Repository(), times(2)).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
  }

  @Test
  public void updateSummaryTest_NoChangeMerchantSkuNull() throws Exception {
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    ItemSummaryResponse itemSummaryResponse = generateItemSummaryData();
    request.setViewConfigs(new ArrayList<>());
    for (ItemViewConfigDTO itemViewConfigDTO : itemSummaryResponse.getItemViewConfigs()) {
      ProductLevel3ViewConfig productLevel3ViewConfig = new ProductLevel3ViewConfig();
      productLevel3ViewConfig.setBuyable(itemViewConfigDTO.isBuyable());
      productLevel3ViewConfig.setDisplay(itemViewConfigDTO.isDiscoverable());
      productLevel3ViewConfig.setChannelId(itemViewConfigDTO.getChannel());
      request.getViewConfigs().add(productLevel3ViewConfig);
      itemViewConfigDTO.setItemBuyableSchedules(null);
      itemViewConfigDTO.setItemDiscoverableSchedules(null);
    }
    request.setPrices(new ArrayList<>());
    itemSummaryResponse.setPrice(new HashSet<>());
    request.setLateFulfillment(itemSummaryResponse.isLateFulfillment());
    request.setMerchantSku(null);
    request.setPickupPointCode(itemSummaryResponse.getPickupPointCode());
    request.setOff2OnActiveFlag(itemSummaryResponse.isOff2OnChannelActive());
    request.setWholesalePriceActivated(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    itemSummaryResponse.setMerchantSku(null);
    when(this.productLevel3Repository.findSummaryByGdnSku(DEFAULT_GDN_SKU)).thenReturn(
      itemSummaryResponse);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
      request);
    verify(getProductLevel3Repository(), times(2)).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
  }

  @Test
  public void updateSummaryTestvalidateUpdateSummaryFalse() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummaryNull();
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
      request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService(),
      ProductLevel3ServiceBeanTest.NEVER_CALLED).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
  }

  @Test
  public void updateSummaryTestvalidateUpdateSummaryTrueCollectionMorethan0() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummaryNull();
    ProductLevel3Price price =
      new ProductLevel3Price(DEFAULT_CHANNEL_ID, DEFAULT_PRICE, DEFAULT_SALE_PRICE);
    price.setDiscountAmount(50000.0);
    request.getPrices().add(price);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService(),
      ProductLevel3ServiceBeanTest.NEVER_CALLED).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    Assertions.assertNull(productLevel3Summary.getWholesalePriceActivated());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
  }

  @Test
  public void updateSummaryTestWithoutDeltaStock() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setDeltaStock(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
      request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(this.productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateSummaryTestWithoutPickupPointCode() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setProductType(3);
    request.setPickupPointCode(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
      request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(this.productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateSummaryExceptionTestTest() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setWholesalePriceActivated(null);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(getProductLevel3Repository().updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any())).thenThrow(Exception.class);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    try {
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    } catch (Exception e) {
    } finally {
      verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
      verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
        (UpdateItemSummaryRequest) Mockito.any());
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
      verify(this.productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
    }
  }

  @Test
  public void updateSummaryExceptionPriceNotValidatedTest() throws Exception {
    itemSummaryResponse.setPriceEditDisabled(false);
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setWholesalePriceActivated(null);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(getProductLevel3Repository().updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any())).thenThrow(Exception.class);
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(itemSummaryResponse);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    try {
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    } catch (Exception e) {
    } finally {
      verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
      verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
        (UpdateItemSummaryRequest) Mockito.any());
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, itemSummaryResponse.getItemSku());
      verify(this.productPricingOutbound).getWholesalePrice(eq(itemSummaryResponse.getItemSku()),
        Mockito.any());
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
    }
  }

  @Test
  public void productQuickEditExceptionTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "campaignPriceInfoBatchSize", 10);
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.REGULAR);
    itemSummaryResponse.setOff2OnChannelActive(false);
    itemSummaryResponse.setBuyable(false);
    itemSummaryResponse.setFreeSample(true);
    quickEditRequest.setOff2OnActiveFlag(null);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(
      itemSummaryResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture())).thenReturn(
      new CampaignUpdateDiscountResponse());
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(
      wholesalePriceSkuResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    when(wholesaleValidationUtil.validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
      Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(),
      Mockito.any(Boolean.class), eq(null))).thenReturn(null);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(
      profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
      DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(
      new ArrayList<>());
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(
      new PickupPointResponse());
    doNothing().when(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
    doNothing().when(updatedProductHistoryService)
      .createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    doNothing().when(productLevel3InventoryService)
      .updateStock(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getDeltaStock());
    doNothing().when(productLevel3InventoryService)
      .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getUseWarehouseStock(), new ArrayList<>());
    doNothing().when(productLevel3InventoryService)
      .updatePickupPoint(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getItemSku());
    doThrow(RuntimeException.class).when(xProductOutbound)
      .updateItemListing(Mockito.any(), Mockito.any(), quickEditListArgumentCaptor.capture());
    doNothing().when(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU,
        new UpdateProductItemLevel3Model(), new UpdateProductItemLevel3Model(), Constants.DEFAULT,
        DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false, StringUtils.EMPTY);
    try {
      productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU,
        productLevel3QuickEditRequest, new ArrayList());
    } catch (Exception e) {
    } finally {
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
      verify(productLevel3Repository, times(1)).findSummaryByGdnSku(Mockito.any());
      verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
      verify(productSystemParameterService, times(2)).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        Constants.MINIMUM_PRICE);
      verify(wholesaleValidationUtil).validateWholesaleConfigOnUpdate(Mockito.any(),
        Mockito.anyList(), Mockito.any(ItemRequest.class), Mockito.any(Integer.class),
        Mockito.any(), Mockito.any(Boolean.class), eq(null));
      verify(xProductOutbound).updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR),
        quickEditListArgumentCaptor.capture());
      verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
      verify(productLevel3Helper).isProductItemDetailChangedForListingUpdate(
        Mockito.any(QuickEditRequest.class), Mockito.any(ItemSummaryResponse.class),
        Mockito.any(Boolean.class));
      verify(productLevel3InventoryService, times(1)).findInventoryByBusinessPartnerCodeAndGdnSku(
        Mockito.any(), Mockito.any());
    }
  }


  @Test
  public void updateSummaryTestWithoutSynchronizeStock() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.setProductType(2);
    request.setSynchronizeStock(null);
    request.getPrices().get(0).setSalePrice(20000.0);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
      request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService(),
      NEVER_CALLED).updateSyncStockByBusinessPartnerCodeAndGdnSku(Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.anyList());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(this.productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateSummaryTestWithoutSynchronizeStock_2() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setProductType(2);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(wholesaleMappingResponse, REQUESTID));
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE_2, DEFAULT_GDN_SKU,
      request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService(),
      NEVER_CALLED).updateSyncStockByBusinessPartnerCodeAndGdnSku(Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_2,
      DEFAULT_GDN_SKU);
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE_2), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(this.productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
  }

  @Test
  public void pickupPointUpdatedTest() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    itemSummaryResponse.setPriceEditDisabled(true);
    itemSummaryResponse.setItemSku(DEFAULT_GDN_SKU);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    when(this.productLevel3Repository.findSummaryByGdnSku(DEFAULT_GDN_SKU)).thenReturn(
      itemSummaryResponse);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    ReflectionTestUtils.setField(productLevel3ServiceBean, "maxWholesalePriceRequests",
      new Integer(0));
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(inventoryOutbound).updatePickupPoint(Mockito.any(),
      listRequestDTOArgumentCaptor.capture());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
      Mockito.any());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    Assertions.assertFalse(productLevel3Summary.getWholesalePriceActivated());
  }

  @Test
  public void updateTest() throws Exception {
    this.productLevel3ServiceBean.update(new ProductRequest(), Boolean.TRUE);
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
  }

  @Test
  public void updateTest1() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
  }

  @Test
  public void updateTestAttributeEmptyTest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    ProductLevel3Attribute attribute1 =
      new ProductLevel3Attribute(DEFAULT_ATTRIBUTE_CODE_2, DEFAULT_ATTRIBUTE_TYPE_2,
        new ArrayList<String>(Arrays.asList(StringUtils.EMPTY)), false);
    ProductLevel3Attribute attribute2 =
      new ProductLevel3Attribute(DEFAULT_ATTRIBUTE_CODE_3, DEFAULT_ATTRIBUTE_TYPE_2,
        new ArrayList<String>(Arrays.asList(StringUtils.EMPTY)), true);
    ProductLevel3Attribute attribute3 =
      new ProductLevel3Attribute(DEFAULT_ATTRIBUTE_CODE_4, DEFAULT_ATTRIBUTE_TYPE_3,
        new ArrayList<String>(Arrays.asList(StringUtils.EMPTY)), false);
    ProductLevel3Attribute attribute4 =
      new ProductLevel3Attribute(DEFAULT_ATTRIBUTE_CODE_5, DEFAULT_ATTRIBUTE_TYPE_3,
        new ArrayList<String>(Arrays.asList(StringUtils.EMPTY)), true);
    product.getAttributes().add(attribute1);
    product.getAttributes().add(attribute2);
    product.getAttributes().add(attribute3);
    product.getAttributes().add(attribute4);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertEquals(3, productRequestArgumentCaptor.getValue().getMasterDataProduct()
      .getMasterDataProductAttributes().size());
    Assertions.assertEquals(Constants.DELIMITER_DASH,
      productRequestArgumentCaptor.getValue().getMasterDataProduct()
        .getMasterDataProductAttributes().get(2).getMasterDataProductAttributeValues().get(0)
        .getPredefinedAllowedAttributeValue().getValue());
    Assertions.assertEquals(2,
      productRequestArgumentCaptor.getValue().getProductSpecialAttributes().size());
    Assertions.assertEquals(Constants.HYPHEN,
      productRequestArgumentCaptor.getValue().getProductSpecialAttributes().get(0)
        .getAttributeValue());

  }

  @Test
  public void updateWholesaleUpdateTest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getItems().get(0).setWholesalePriceActivated(Boolean.TRUE);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setWholesalePriceActivated(true);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(this.wholesaleValidationUtil.validateWholesaleConfigOnUpdate(eq(DEFAULT_CATEGORY_CODE),
      Mockito.anyList(), Mockito.any(), Mockito.any(), eq(ITEM_SKU), eq(Boolean.TRUE),
      eq(null))).thenReturn(null);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(wholesaleValidationUtil).validateWholesaleConfigOnUpdate(eq(DEFAULT_CATEGORY_CODE),
      Mockito.any(), Mockito.any(ItemRequest.class), Mockito.any(), Mockito.any(), eq(Boolean.TRUE),
      eq(null));
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
  }

  @Test
  public void updateTest_withNullMasterData() throws Exception {
    AttributeResponse attribute = new AttributeResponse();
    attribute.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(this.productOutbound.getAttributeDetailByAttributeCode(Mockito.any()))
      .thenReturn(attribute);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    ProductResponse productResponse = savedProductData.getProduct();
    productResponse.setMasterDataProduct(null);
    productResponse.setMasterCatalog(null);
    savedProductData.setProduct(productResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(this.productOutbound, times(2)).getAttributeDetailByAttributeCode(Mockito.any());
    Assertions.assertNull(updatedProduct.getProductLevel3().getProductName());
    Assertions.assertNull(updatedProduct.getProductLevel3().getBrand());
    Assertions.assertEquals(DEFAULT_DESCRIPTION, updatedProduct.getProductLevel3().getDescription());
    Assertions.assertEquals(DEFAULT_UNIQUE_SELLING_POINT,
      updatedProduct.getProductLevel3().getUniqueSellingPoint());
    Assertions.assertNull(updatedProduct.getProductLevel3().getSpecificationDetail());
    Assertions.assertNull(updatedProduct.getProductLevel3().getProductStory());
    Assertions.assertNull(updatedProduct.getProductLevel3().getUrl());
    Assertions.assertNull(updatedProduct.getProductLevel3().getCategoryCode());
  }

  @Test
  public void updateTest_archivedItemTest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getItems().get(0).setArchived(Boolean.TRUE);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setArchived(Boolean.TRUE);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    try {
      this.productLevel3ServiceBean.update(product, 5, 2, false);
    } catch (ApplicationRuntimeException e) {
    } finally {
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    }
  }

  @Test
  public void updateTest_isSuspendedTest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getItems().get(0).setArchived(Boolean.TRUE);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setArchived(Boolean.FALSE);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    savedProductData.getProduct().setSuspended(true);
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    try {
      this.productLevel3ServiceBean.update(product, 5, 2, false);
    } catch (ApplicationRuntimeException e) {
    } finally {
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    }
  }

  @Test
  public void updateTest_faultyImagesTest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getItems().get(0).setArchived(Boolean.TRUE);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setArchived(Boolean.FALSE);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    savedProductData.getProduct().setForceReview(true);
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    try {
      this.productLevel3ServiceBean.update(product, 5, 2, false);
    } catch (ApplicationRuntimeException e) {
      System.out.println(e);
    } finally {
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    }
  }

  @Test
  public void updateTest_whenChangingProductTypeToRegular() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().setProductType(ProductType.REGULAR);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ItemRequest itemRequest =
      generateItemRequest(product.getItems().get(0), product.getProductSku(),
        product.getAttributes());
    itemRequest.setLateFulfillment(true);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.any(ItemRequest.class))).thenReturn(savedProductData.getItems().get(0));
    Mockito.when(
        getProductLevel3Repository().findDetailByGdnSku(product.getItems().get(0).getItemSku()))
      .thenReturn(savedProductData);

    this.productLevel3ServiceBean.update(product, null, null, false);

    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      Mockito.any(ItemRequest.class));
    savedProductData.getProduct().setProductType(ProductType.BIG_PRODUCT);
    product.setProductType(ProductType.BIG_PRODUCT.getCode());
    itemRequest.setLateFulfillment(true);

    this.productLevel3ServiceBean.update(product, null, null, false);

    verify(xProductOutbound, Mockito.times(2)).updateItem(eq(false), eq(false), eq(false),
      Mockito.any(ItemRequest.class));
    savedProductData.getProduct().setProductType(ProductType.REGULAR);
    product.setProductType(ProductType.REGULAR.getCode());
    itemRequest.setLateFulfillment(true);

    this.productLevel3ServiceBean.update(product, null, null, false);

    verify(xProductOutbound, Mockito.times(3)).updateItem(eq(false), eq(false), eq(false),
      Mockito.any(ItemRequest.class));
    savedProductData.getProduct().setProductType(ProductType.BIG_PRODUCT);
    product.setProductType(ProductType.REGULAR.getCode());
    itemRequest.setLateFulfillment(false);

    this.productLevel3ServiceBean.update(product, null, null, false);

    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false),
      Mockito.any(ItemRequest.class));
    verify(getProductLevel3Repository(), Mockito.times(4)).findDetailByGdnSku(
      product.getItems().get(0).getItemSku());
    verify(xProductOutbound, Mockito.times(4)).updateProduct(eq(false), Mockito.any());
    verify(getProductLevel3InventoryService(), Mockito.times(4)).updatePickupPoint(
      product.getBusinessPartnerCode(), product.getItems().get(0).getItemSku(),
      product.getItems().get(0).getPickupPointCode());
    verify(productLevel3LogisticsService, Mockito.times(4)).saveLogisticsByItemSku(
      Arrays.asList(DEFAULT_GDN_SKU), DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      Mockito.times(8)).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, Mockito.times(8)).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService, Mockito.times(4)).saveUpdateProductLevel3Audit(
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest_whenChangingProductTypeFromRegular() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().setProductType(ProductType.REGULAR);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    product.setProductType(ProductType.REGULAR.getCode());
    ProfileResponse businessPartner = getProfileResponse();
    ItemRequest itemRequest =
      generateItemRequest(product.getItems().get(0), product.getProductSku(),
        product.getAttributes());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      product.getBusinessPartnerCode())).thenReturn(businessPartner);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(
        getProductLevel3Repository().findDetailByGdnSku(product.getItems().get(0).getItemSku()))
      .thenReturn(savedProductData);
    product.setProductType(2);

    this.productLevel3ServiceBean.update(product, 5, 2, false);

    itemRequest.setLateFulfillment(true);
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false),
      Mockito.any(ItemRequest.class));
    verify(getProductLevel3Repository()).findDetailByGdnSku(product.getItems().get(0).getItemSku());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(product.getBusinessPartnerCode(),
      product.getItems().get(0).getItemSku(), 5);
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(
      product.getBusinessPartnerCode(), product.getItems().get(0).getItemSku(), 2);
    verify(getProductLevel3InventoryService()).updatePickupPoint(product.getBusinessPartnerCode(),
      product.getItems().get(0).getItemSku(), product.getItems().get(0).getPickupPointCode());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      Mockito.times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, Mockito.times(2)).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest2MinStockFound() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.DEFINING_ATTRIBUTE.name());
    product.setProductType(2);

    productLevel3Inventory.setWebMinAlert(0);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(DEFAULT_GDN_SKU))
      .thenReturn(1);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest2MinStockNotFound() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setPristineId(PRISTINE_ID);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.DEFINING_ATTRIBUTE.name());
    product.setProductType(2);

    productLevel3Inventory.setWebMinAlert(0);
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(DEFAULT_GDN_SKU))
      .thenReturn(null);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);

    this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductBusinessPartnerService()).updateMinimumStockByGdnProductItemSku(Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  private ProfileResponse getProfileResponse() {
    ProfileResponse businessPartner = new ProfileResponse();
    PickupPointDTO pickupPointDTO = new PickupPointDTO();
    pickupPointDTO.setCode(DEFAULT_PICKUP_POINT_CODE);
    pickupPointDTO.setOriginId(DEFAULT_ORIGIN_ID);
    businessPartner.setPickupPoints(Arrays.asList(pickupPointDTO));
    CompanyDTO dto = new CompanyDTO();
    dto.setInternationalFlag(Boolean.TRUE);
    businessPartner.setCompany(dto);
    businessPartner.getCompany().setInternationalFlag(true);
    businessPartner.getCompany().setMerchantDeliveryType(PICKUP);
    businessPartner.getCompany().setInventoryFulfillment(INVENTORY_FULFILLMENT_BLIBLI);
    return businessPartner;
  }

  @Test
  public void updateTest2MinStockNotFound_nullPristineId() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setPristineId(null);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.DEFINING_ATTRIBUTE.name());
    product.setProductType(2);

    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenReturn(null);
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(DEFAULT_GDN_SKU))
      .thenReturn(null);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductBusinessPartnerService()).updateMinimumStockByGdnProductItemSku(Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest3MinStockFound() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    product.setProductType(3);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(Mockito.any()))
      .thenReturn(null);

    this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest3NonNullO2OFlag() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setOff2OnActiveFlag(Boolean.FALSE);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    product.setProductType(3);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(Mockito.any()))
      .thenReturn(null);

    this.productLevel3ServiceBean.update(product, null, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest4() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductType(4);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    this.productLevel3ServiceBean.update(product, null, null, false);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest5() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3_2();
    product.setProductType(3);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    this.productLevel3ServiceBean.update(product, null, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest6MinStockNotFound() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.DEFINING_ATTRIBUTE.name());
    product.setProductType(2);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(Mockito.any()))
      .thenReturn(2);

    this.productLevel3ServiceBean.update(product, null, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTestWhenMinimumStockIsNull() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    this.productLevel3ServiceBean.update(product, null, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void findDetailByProductSkuTest() throws Exception {
    ProductResponse productResponse = new ProductResponse();
    productResponse.setProductCode(DEFAULT_PRODUCT_CODE);
    productResponse.setProductSku(DEFAULT_PRODUCT_SKU);
        ProductAndItemsResponse productAndItemResponse = new ProductAndItemsResponse();
        productAndItemResponse.setProduct(productResponse);
    Mockito.when(productLevel3Repository.findDetailByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(productAndItemResponse);
    ProductAndItemsResponse response =
      productLevel3ServiceBean.findDetailByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3Repository).findDetailByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, response.getProduct().getProductSku());
  }

  @Test
  public void findDetailByProductSkuExceptionTest() throws Exception {
    Mockito.doThrow(new ApplicationException()).when(productLevel3Repository)
      .findDetailByProductSku(DEFAULT_PRODUCT_SKU);
    ProductAndItemsResponse response =
      productLevel3ServiceBean.findDetailByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3Repository).findDetailByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertNull(response);
  }

  @Test
  public void archiveGdnSkuTest() throws Exception {
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(this.listPbpStockAlert);
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU_1,
      true, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(ITEM_SKU_1);
    verify(this.productStockAlertRepository).save(Mockito.any(PbpStockAlert.class));
  }

  @Test
  public void archiveGdnSku_new_Test() throws Exception {
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(this.listPbpStockAlert);
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU,
      true, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(ITEM_SKU);
    verify(this.productStockAlertRepository).save(Mockito.any(PbpStockAlert.class));
  }

  @Test
  public void unArchiveGdnSku_new_Test() throws Exception {
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(this.listPbpStockAlert);
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU,
      false, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(ITEM_SKU);
    verify(this.productStockAlertRepository).save(Mockito.any(PbpStockAlert.class));
  }

  @Test
  public void archiveGdnSku_exception_Test() throws Exception {
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(this.listPbpStockAlert);
    Mockito.doThrow(RuntimeException.class).when(this.productStockAlertRepository)
      .save(Mockito.any(PbpStockAlert.class));
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU,
      true, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(ITEM_SKU);
  }

  @Test
  public void unArchiveGdnSku_exception_Test() throws Exception {
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(this.listPbpStockAlert);
    Mockito.doThrow(RuntimeException.class).when(this.productStockAlertRepository)
      .save(Mockito.any(PbpStockAlert.class));
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU,
      false, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(ITEM_SKU);
  }

  @Test
  public void archiveGdnSku_objectOptimisticLockingFailureObjectOptimisticLockingFailureException_Test()
    throws Exception {
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(this.listPbpStockAlert);
    Mockito.doThrow(ObjectOptimisticLockingFailureException.class)
      .when(this.productStockAlertRepository).save(Mockito.any(PbpStockAlert.class));
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU,
      true, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(ITEM_SKU);
  }

  @Test
  public void unArchiveGdnSku_objectOptimisticLockingFailureObjectOptimisticLockingFailureException_Test()
    throws Exception {
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(this.listPbpStockAlert);
    Mockito.doThrow(ObjectOptimisticLockingFailureException.class)
      .when(this.productStockAlertRepository).save(Mockito.any(PbpStockAlert.class));
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU,
      false, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(ITEM_SKU);
  }

  @Test
  public void bulkArchiveItemsTest_WithWrongSku() throws Exception {
    List<String> failedItemSkus = productLevel3ServiceBean.bulkArchiveItems(Arrays.asList(ITEM_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE);
    Assertions.assertTrue(failedItemSkus.size() == 1);
    Assertions.assertEquals(ITEM_SKU, failedItemSkus.get(0));
  }

  @Test
  public void bulkArchiveItemsTest_WithException() throws Exception {
    Mockito.when(productLevel3Repository.findSummaryByGdnSku(Mockito.any()))
      .thenThrow(Exception.class);
    List<String> failedItemSkus = new ArrayList<>();
    try {
      failedItemSkus = productLevel3ServiceBean.bulkArchiveItems(Arrays.asList(DEFAULT_GDN_SKU),
        DEFAULT_BUSINESS_PARTNER_CODE);
    } finally {
      Assertions.assertTrue(failedItemSkus.size() == 1);
      Assertions.assertEquals(DEFAULT_GDN_SKU, failedItemSkus.get(0));
    }
  }

  @Test
  public void bulkArchiveItemsTest() throws Exception {
    List<String> failedItemSkus =
      productLevel3ServiceBean.bulkArchiveItems(Arrays.asList(DEFAULT_GDN_SKU),
        DEFAULT_BUSINESS_PARTNER_CODE);
    Assertions.assertFalse(failedItemSkus.isEmpty());
  }

  @Test
  public void bulkArchiveItemsAggregateFalseTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "skipProductLevel3AggregatorCreation",
      true);
    List<String> failedItemSkus =
      productLevel3ServiceBean.bulkArchiveItems(Arrays.asList(DEFAULT_GDN_SKU),
        DEFAULT_BUSINESS_PARTNER_CODE);
    Assertions.assertFalse(failedItemSkus.isEmpty());
  }

  @Test
  public void getAllActiveBrandsByCNCategoryId() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", true);
    Mockito.when(
      this.categoryRepository.getFinalParentCategoryCached(DEFAULT_REQUEST_ID_1, DEFAULT_USER_NAME,
        DEFAULT_CATEGORY_CODE)).thenReturn(categoryCodeResponse);
    Mockito.when(this.redisTemplate.hasKey(Mockito.any())).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.when(this.boundValueOperations.get())
      .thenReturn(predefinedAllowedAttributeValueResponses);
    List<PredefinedAllowedAttributeValueResponse> predefinedAllowedAttributeValueResponses =
      this.productLevel3ServiceBean.getAllActiveBrandsByCNCategoryId(DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE, false);
    verify(categoryRepository).getFinalParentCategoryCached(DEFAULT_REQUEST_ID_1, DEFAULT_USER_NAME,
      DEFAULT_CATEGORY_CODE);
    verify(redisTemplate).hasKey(Mockito.any());
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).get();
    Assertions.assertNotNull(predefinedAllowedAttributeValueResponses);
    Assertions.assertEquals(1, predefinedAllowedAttributeValueResponses.size());
    Assertions.assertEquals(DEFAULT_BRAND, predefinedAllowedAttributeValueResponses.get(0).getValue());
  }

  @Test
  public void getAllActiveBrandsByCNCategoryIdCacheClearTrue() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisCacheExpiration", "10000");
    Mockito.when(
      this.categoryRepository.getFinalParentCategoryCached(DEFAULT_REQUEST_ID_1, DEFAULT_USER_NAME,
        DEFAULT_CATEGORY_CODE)).thenReturn(categoryCodeResponse);
    Mockito.when(this.categoryRepository.getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE)).thenReturn(new ArrayList<>());
    Mockito.when(this.solrActiveProductCollectionServiceBean.getAllActiveBrandsByCategoryCodes(
      Mockito.anyList())).thenReturn(predefinedAllowedAttributeValueResponses);
    Mockito.when(this.redisTemplate.hasKey(Mockito.any())).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.when(this.boundValueOperations.get())
      .thenReturn(predefinedAllowedAttributeValueResponses);
    Mockito.when(this.redisTemplate.expire(Mockito.any(), eq(10000), eq(TimeUnit.SECONDS)))
      .thenReturn(true);
    List<PredefinedAllowedAttributeValueResponse> predefinedAllowedAttributeValueResponses =
      this.productLevel3ServiceBean.getAllActiveBrandsByCNCategoryId(DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE, true);
    verify(categoryRepository).getFinalParentCategoryCached(DEFAULT_REQUEST_ID_1, DEFAULT_USER_NAME,
      DEFAULT_CATEGORY_CODE);
    verify(redisTemplate).hasKey(Mockito.any());
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(redisTemplate).delete((String) Mockito.any());
    verify(redisTemplate).expire(Mockito.any(), eq(Long.valueOf("10000")), eq(TimeUnit.SECONDS));
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).set(predefinedAllowedAttributeValueResponses);
    verify(categoryRepository).getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE);
    verify(solrActiveProductCollectionServiceBean).getAllActiveBrandsByCategoryCodes(
      Mockito.anyList());
    Assertions.assertNotNull(predefinedAllowedAttributeValueResponses);
    Assertions.assertEquals(1, predefinedAllowedAttributeValueResponses.size());
    Assertions.assertEquals(DEFAULT_BRAND, predefinedAllowedAttributeValueResponses.get(0).getValue());
  }

  @Test
  public void getAllActiveBrandsByCNCategoryIdRedisEnabledFalse() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisCacheExpiration", "10000");
    Mockito.when(
      this.categoryRepository.getFinalParentCategoryCached(DEFAULT_REQUEST_ID_1, DEFAULT_USER_NAME,
        DEFAULT_CATEGORY_CODE)).thenReturn(categoryCodeResponse);
    Mockito.when(this.categoryRepository.getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE)).thenReturn(new ArrayList<>());
    Mockito.when(this.solrActiveProductCollectionServiceBean.getAllActiveBrandsByCategoryCodes(
      Mockito.anyList())).thenReturn(predefinedAllowedAttributeValueResponses);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.doNothing().when(this.boundValueOperations)
      .set(predefinedAllowedAttributeValueResponses);
    Mockito.when(this.redisTemplate.expire(Mockito.any(), eq(10000), eq(TimeUnit.SECONDS)))
      .thenReturn(true);
    List<PredefinedAllowedAttributeValueResponse> predefinedAllowedAttributeValueResponses =
      this.productLevel3ServiceBean.getAllActiveBrandsByCNCategoryId(DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE, false);
    verify(categoryRepository).getFinalParentCategoryCached(DEFAULT_REQUEST_ID_1, DEFAULT_USER_NAME,
      DEFAULT_CATEGORY_CODE);
    verify(categoryRepository).getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE);
    verify(solrActiveProductCollectionServiceBean).getAllActiveBrandsByCategoryCodes(
      Mockito.anyList());
    verify(redisTemplate).expire(Mockito.any(), eq(Long.valueOf("10000")), eq(TimeUnit.SECONDS));
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).set(predefinedAllowedAttributeValueResponses);
    Assertions.assertNotNull(predefinedAllowedAttributeValueResponses);
    Assertions.assertEquals(1, predefinedAllowedAttributeValueResponses.size());
    Assertions.assertEquals(DEFAULT_BRAND, predefinedAllowedAttributeValueResponses.get(0).getValue());
  }

  @Test
  public void getAllProductsWithRedisEnabledTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", true);
    Mockito.when(this.categoryRepository.getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE)).thenReturn(Arrays.asList(DEFAULT_CATEGORY_CODE));
    Mockito.when(this.redisTemplate.hasKey(Mockito.any())).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.when(this.boundValueOperations.get()).thenReturn(CATALOG_CODE);
    Mockito.when(applicationProperties.isCatalogCodeRequired()).thenReturn(true);
    Mockito.when(this.productLevel3Repository.getAllProducts(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true)).thenReturn(
      new PageImpl<ActiveProductResponse>(Arrays.asList(activeProductResponse), DEFAULT_PAGEABLE,
        10));

    Page<SuspensionProductResponse> suspensionProductResponses =
      this.productLevel3ServiceBean.getAllProducts(summaryFilterRequest, DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, STOREID, pageable);

    verify(categoryRepository).getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE);
    verify(redisTemplate).hasKey(Mockito.any());
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).get();
    verify(productLevel3Repository).getAllProducts(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true);
    verify(applicationProperties).isCatalogCodeRequired();
    Assertions.assertNotNull(suspensionProductResponses);
    Assertions.assertEquals(1, suspensionProductResponses.getContent().size());
  }

  @Test
  public void getAllProductsWithRedisEnabledTest_withEmptyCategoryList() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", true);
    Mockito.when(this.categoryRepository.getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE)).thenReturn(new ArrayList<>());
    Mockito.when(this.redisTemplate.hasKey(Mockito.any())).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.when(this.boundValueOperations.get()).thenReturn(CATALOG_CODE);
    Mockito.when(applicationProperties.isCatalogCodeRequired()).thenReturn(true);
    Mockito.when(this.productLevel3Repository.getAllProducts(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true)).thenReturn(
      new PageImpl<ActiveProductResponse>(Arrays.asList(activeProductResponse), DEFAULT_PAGEABLE,
        10));

    Page<SuspensionProductResponse> suspensionProductResponses =
      this.productLevel3ServiceBean.getAllProducts(summaryFilterRequest, DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, STOREID, pageable);

    verify(categoryRepository).getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE);
    verify(redisTemplate).hasKey(Mockito.any());
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).get();
    verify(productLevel3Repository).getAllProducts(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true);
    verify(applicationProperties).isCatalogCodeRequired();
    Assertions.assertNotNull(suspensionProductResponses);
    Assertions.assertEquals(1, suspensionProductResponses.getContent().size());
  }

  @Test
  public void getAllProductsRedisDisabled_withNullProductCollectionExceptionTest()
    throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisCacheExpiration", "10000");
    Mockito.when(this.categoryRepository.getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE)).thenReturn(Arrays.asList(DEFAULT_CATEGORY_CODE));
    Mockito.when(this.productLevel3Repository.getAllProducts(summaryFilterRequest, pageable,
        Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true))
      .thenReturn(new PageImpl<>(Arrays.asList(activeProductResponse), DEFAULT_PAGEABLE, 10));
    Mockito.when(this.productRepository.getCatalogByType(CatalogType.MASTER_CATALOG, pageable))
      .thenReturn(Arrays.asList(catalogResponse));
    Mockito.when(applicationProperties.isCatalogCodeRequired()).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.doNothing().when(this.boundValueOperations).set(CATALOG_CODE);
    Mockito.when(this.redisTemplate.expire(Mockito.any(), eq(10000), eq(TimeUnit.SECONDS)))
      .thenReturn(true);

    Page<SuspensionProductResponse> suspensionProductResponses =
      this.productLevel3ServiceBean.getAllProducts(summaryFilterRequest, DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, STOREID, pageable);

    verify(categoryRepository).getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE);
    verify(productLevel3Repository).getAllProducts(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true);
    verify(productRepository).getCatalogByType(CatalogType.MASTER_CATALOG, pageable);
    verify(redisTemplate).expire(Mockito.any(), eq(Long.valueOf("10000")), eq(TimeUnit.SECONDS));
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).set(CATALOG_CODE);
    verify(applicationProperties).isCatalogCodeRequired();
  }

  @Test
  public void getAllProductsRedisDisabledTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisCacheExpiration", "10000");
    Mockito.when(this.categoryRepository.getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE)).thenReturn(Arrays.asList(DEFAULT_CATEGORY_CODE));
    Mockito.when(this.productLevel3Repository.getAllProducts(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true)).thenReturn(
      new PageImpl<ActiveProductResponse>(Arrays.asList(activeProductResponse), DEFAULT_PAGEABLE,
        10));
    Mockito.when(this.productRepository.getCatalogByType(CatalogType.MASTER_CATALOG, pageable))
      .thenReturn(Arrays.asList(catalogResponse));
    Mockito.when(applicationProperties.isCatalogCodeRequired()).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.doNothing().when(this.boundValueOperations).set(CATALOG_CODE);
    Mockito.when(this.redisTemplate.expire(Mockito.any(), eq(10000), eq(TimeUnit.SECONDS)))
      .thenReturn(true);

    Page<SuspensionProductResponse> suspensionProductResponses =
      this.productLevel3ServiceBean.getAllProducts(summaryFilterRequest, DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, STOREID, pageable);

    verify(categoryRepository).getAllChildCategoriesByC1CategoryCode(DEFAULT_REQUEST_ID_1,
      DEFAULT_USER_NAME, DEFAULT_CATEGORY_CODE);
    verify(productLevel3Repository).getAllProducts(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true);
    verify(productRepository).getCatalogByType(CatalogType.MASTER_CATALOG, pageable);
    verify(redisTemplate).expire(Mockito.any(), eq(Long.valueOf("10000")), eq(TimeUnit.SECONDS));
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).set(CATALOG_CODE);
    verify(applicationProperties).isCatalogCodeRequired();
    Assertions.assertNotNull(suspensionProductResponses);
    Assertions.assertEquals(1, suspensionProductResponses.getContent().size());
  }

  @Test
  public void saveSuspensionHistoryNullSuspendedTest() {
    Date createdDate = new Date();
    ProductSuspensionHistory productSuspensionHistory = null;
    Mockito.when(
      this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        STOREID, DEFAULT_PRODUCT_SKU)).thenReturn(productSuspensionHistory);
    productLevel3ServiceBean.saveSuspensionHistory(STOREID, DEFAULT_PRODUCT_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_REASON, DEFAULT_DESCRIPTION,
      SuspensionStatus.SUSPENDED, USERNAME, createdDate);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      STOREID, DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void saveSuspensionHistorySuspendedTest() {
    Date createdDate = new Date();
    ProductSuspensionHistory productSuspensionHistory = new ProductSuspensionHistory();
    Mockito.when(
      this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        STOREID, DEFAULT_PRODUCT_SKU)).thenReturn(productSuspensionHistory);
    productLevel3ServiceBean.saveSuspensionHistory(STOREID, DEFAULT_PRODUCT_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_REASON, DEFAULT_DESCRIPTION,
      SuspensionStatus.SUSPENDED, USERNAME, createdDate);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      STOREID, DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void saveSuspensionHistoryActiveTest() {
    Date createdDate = new Date();
    ProductSuspensionHistory productSuspensionHistory = new ProductSuspensionHistory();
    Mockito.when(
      this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        STOREID, DEFAULT_PRODUCT_SKU)).thenReturn(productSuspensionHistory);
    productLevel3ServiceBean.saveSuspensionHistory(STOREID, DEFAULT_PRODUCT_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_REASON, DEFAULT_DESCRIPTION, SuspensionStatus.ACTIVE,
      USERNAME, createdDate);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      STOREID, DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void saveSuspensionHistoryNullActiveTest() {
    Date createdDate = new Date();
    ProductSuspensionHistory productSuspensionHistory = null;
    Mockito.when(
      this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        STOREID, DEFAULT_PRODUCT_SKU)).thenReturn(productSuspensionHistory);
    productLevel3ServiceBean.saveSuspensionHistory(STOREID, DEFAULT_PRODUCT_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_REASON, DEFAULT_DESCRIPTION, SuspensionStatus.ACTIVE,
      USERNAME, createdDate);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      STOREID, DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void saveSuspensionHistoryInvalidReasonTest() {
    Date createdDate = new Date();
    ProductSuspensionHistory productSuspensionHistory = new ProductSuspensionHistory();
    Mockito.when(
      this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        STOREID, DEFAULT_PRODUCT_SKU)).thenReturn(productSuspensionHistory);
    productLevel3ServiceBean.saveSuspensionHistory(STOREID, DEFAULT_PRODUCT_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_INTERNAL_REASON, DEFAULT_DESCRIPTION,
      SuspensionStatus.ACTIVE, USERNAME, createdDate);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      STOREID, DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void getSuspendedItemsWithRedisEnabledTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", true);
    Mockito.when(applicationProperties.isCatalogCodeRequired()).thenReturn(true);
    Mockito.when(applicationProperties.getProductDetailPageUrlPrefix()).thenReturn(DETAIL_LINK);
    Mockito.when(this.redisTemplate.hasKey(Mockito.any())).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.when(this.boundValueOperations.get()).thenReturn(CATALOG_CODE);
    Mockito.when(this.productLevel3Repository.getSuspendedItemList(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true)).thenReturn(
      new PageImpl<ItemSummaryResponse>(Arrays.asList(itemSummaryResponse), DEFAULT_PAGEABLE, 10));
    Mockito.when(
        this.productCollectionRepository.findByProductCodeInAndStoreIdAndMarkForDeleteFalse(
          Arrays.asList(itemSummaryResponse.getProductCode()), STOREID))
      .thenReturn(Arrays.asList(productCollection));
    Mockito.when(
      this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        STOREID, itemSummaryResponse.getProductSku())).thenReturn(new ProductSuspensionHistory());

    Page<SuspensionItemResponse> suspensionItemResponses =
      this.productLevel3ServiceBean.getSuspendedItems(summaryFilterRequest, DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, STOREID, pageable);

    verify(redisTemplate).hasKey(Mockito.any());
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).get();
    verify(productLevel3Repository).getSuspendedItemList(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true);
    verify(productCollectionRepository).findByProductCodeInAndStoreIdAndMarkForDeleteFalse(
      Arrays.asList(itemSummaryResponse.getProductCode()), STOREID);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      STOREID, itemSummaryResponse.getProductSku());
    verify(applicationProperties).isCatalogCodeRequired();
    Assertions.assertNotNull(suspensionItemResponses);
    Assertions.assertEquals(1, suspensionItemResponses.getContent().size());
    Assertions.assertEquals(ITEM_DETAIL_LINK, suspensionItemResponses.getContent().get(0).getProductDetailPageLink());
  }


  @Test
  public void getSuspendedItemsWithRedisEnabled_withNullProductCollectionTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", true);
    Mockito.when(applicationProperties.isCatalogCodeRequired()).thenReturn(true);
    Mockito.when(this.redisTemplate.hasKey(Mockito.any())).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.when(this.boundValueOperations.get()).thenReturn(CATALOG_CODE);
    Mockito.when(this.productLevel3Repository.getSuspendedItemList(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true)).thenReturn(
      new PageImpl<ItemSummaryResponse>(Arrays.asList(itemSummaryResponse), DEFAULT_PAGEABLE, 10));
    Mockito.when(
        this.productCollectionRepository.findByProductCodeInAndStoreIdAndMarkForDeleteFalse(
          Arrays.asList(itemSummaryResponse.getProductCode()), STOREID))
      .thenReturn(Arrays.asList(new ProductCollection()));

    Page<SuspensionItemResponse> suspensionItemResponses =
      this.productLevel3ServiceBean.getSuspendedItems(summaryFilterRequest, DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, STOREID, pageable);
    verify(redisTemplate).hasKey(Mockito.any());
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).get();
    verify(productLevel3Repository).getSuspendedItemList(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true);
    verify(productCollectionRepository).findByProductCodeInAndStoreIdAndMarkForDeleteFalse(
      Arrays.asList(itemSummaryResponse.getProductCode()), STOREID);
    verify(applicationProperties).isCatalogCodeRequired();
  }

  @Test
  public void getSuspendedItemsWithRedisEnabled_withNullProductSuspensionHistoryTest()
    throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", true);
    Mockito.when(applicationProperties.isCatalogCodeRequired()).thenReturn(true);
    Mockito.when(this.redisTemplate.hasKey(Mockito.any())).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.when(this.boundValueOperations.get()).thenReturn(CATALOG_CODE);
    Mockito.when(this.productLevel3Repository.getSuspendedItemList(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true)).thenReturn(
      new PageImpl<ItemSummaryResponse>(Arrays.asList(itemSummaryResponse), DEFAULT_PAGEABLE, 10));
    Mockito.when(
        this.productCollectionRepository.findByProductCodeInAndStoreIdAndMarkForDeleteFalse(
          Arrays.asList(itemSummaryResponse.getProductCode()), STOREID))
      .thenReturn(Arrays.asList(productCollection));
    Mockito.when(
      this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        STOREID, itemSummaryResponse.getProductSku())).thenReturn(null);

    Page<SuspensionItemResponse> suspensionItemResponses =
      this.productLevel3ServiceBean.getSuspendedItems(summaryFilterRequest, DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, STOREID, pageable);

    verify(redisTemplate).hasKey(Mockito.any());
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).get();
    verify(productLevel3Repository).getSuspendedItemList(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true);
    verify(productCollectionRepository).findByProductCodeInAndStoreIdAndMarkForDeleteFalse(
      Arrays.asList(itemSummaryResponse.getProductCode()), STOREID);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      STOREID, itemSummaryResponse.getProductSku());
    verify(applicationProperties).isCatalogCodeRequired();

  }

  @Test
  public void getSuspendedItemsWithRedisDisabledTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisEnabled", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "redisCacheExpiration", "10000");
    Mockito.when(this.productLevel3Repository.getSuspendedItemList(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true)).thenReturn(
      new PageImpl<ItemSummaryResponse>(Arrays.asList(itemSummaryResponse), DEFAULT_PAGEABLE, 10));
    Mockito.when(
        this.productCollectionRepository.findByProductCodeInAndStoreIdAndMarkForDeleteFalse(
          Arrays.asList(itemSummaryResponse.getProductCode()), STOREID))
      .thenReturn(Arrays.asList(productCollection));
    Mockito.when(this.productRepository.getCatalogByType(CatalogType.MASTER_CATALOG, pageable))
      .thenReturn(Arrays.asList(catalogResponse));
    Mockito.when(applicationProperties.isCatalogCodeRequired()).thenReturn(true);
    Mockito.when(this.redisTemplate.boundValueOps(Mockito.any())).thenReturn(boundValueOperations);
    Mockito.doNothing().when(this.boundValueOperations).set(CATALOG_CODE);
    Mockito.when(this.redisTemplate.expire(Mockito.any(), eq(10000), eq(TimeUnit.SECONDS)))
      .thenReturn(true);
    Mockito.when(
      this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        STOREID, itemSummaryResponse.getProductSku())).thenReturn(new ProductSuspensionHistory());

    Page<SuspensionItemResponse> suspensionItemResponses =
      this.productLevel3ServiceBean.getSuspendedItems(summaryFilterRequest, DEFAULT_REQUEST_ID_1,
        DEFAULT_USER_NAME, STOREID, pageable);

    verify(productLevel3Repository).getSuspendedItemList(summaryFilterRequest, pageable,
      Arrays.asList(DEFAULT_CATEGORY_CODE), CATALOG_CODE, true);
    verify(productCollectionRepository).findByProductCodeInAndStoreIdAndMarkForDeleteFalse(
      Arrays.asList(itemSummaryResponse.getProductCode()), STOREID);
    verify(productRepository).getCatalogByType(CatalogType.MASTER_CATALOG, pageable);
    verify(redisTemplate).expire(Mockito.any(), eq(Long.valueOf("10000")), eq(TimeUnit.SECONDS));
    verify(redisTemplate).boundValueOps(Mockito.any());
    verify(boundValueOperations).set(CATALOG_CODE);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      STOREID, itemSummaryResponse.getProductSku());
    verify(applicationProperties).isCatalogCodeRequired();
    Assertions.assertNotNull(suspensionItemResponses);
    Assertions.assertEquals(1, suspensionItemResponses.getContent().size());
  }

  @Test
  public void getSuspensionHistoryTest() throws Exception {
    Page<ProductSuspensionHistory> result =
      productLevel3ServiceBean.getSuspensionHistory(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU,
        DEFAULT_PAGE_REQUEST);
    Assertions.assertEquals(DEFAULT_BUSINESS_PARTNER_CODE,
      result.getContent().get(0).getBusinessPartnerCode());
    verify(
      productSuspensionHistoryRepository).findByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, DEFAULT_PAGE_REQUEST);
  }

  @Test
  public void getProductByProductCodeAndMerchantCodeTest() throws Exception {
    Mockito.when(
      productLevel3Repository.getProductsByProductCodeAndMerchantCode(DEFAULT_PRODUCT_CODE,
        MERCHANT_CODE_1)).thenReturn(Arrays.asList(new ProductResponse()));
    List<ProductResponse> result =
      productLevel3ServiceBean.getProductsByProductCodeAndMerchantCode(DEFAULT_PRODUCT_CODE,
        MERCHANT_CODE_1);
    Assertions.assertNotNull(result);
    verify(productLevel3Repository).getProductsByProductCodeAndMerchantCode(DEFAULT_PRODUCT_CODE,
      MERCHANT_CODE_1);
  }

  @Test
  public void doSuspensionProductsActions_SuspendAction_ForArchivedItemTest() throws Exception {
    suspensionProductRequest.setAction(SUSPEND_ACTION);
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productL3Response.setArchived(false);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, true);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ARCHIVED);
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.SUSPENDED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3Repository).toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, true);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU);
    verify(productSuspensionHistoryRepository).saveAndFlush(
      Mockito.any(ProductSuspensionHistory.class));
    verify(productLevel3AggregatorService).updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
      ProductLevel3AggregatorState.ARCHIVED);
    verify(updatedProductHistoryService).createProductL3AuditLog(MERCHANT_CODE_1, Constants.DEFAULT,
      DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.SUSPENSION.getDesc(),
      String.valueOf(false), String.valueOf(true), false, StringUtils.EMPTY);
    verify(productMailEventService).createAndSaveMailEventForSuspensionOrReActivation(
      ProductMailEventsEnum.SUSPENDED, DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE,
      DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void doSuspensionProductsActionsAggregateTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "skipProductLevel3AggregatorCreation",
      true);
    suspensionProductRequest.setAction(SUSPEND_ACTION);
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productL3Response.setArchived(false);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, true);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ARCHIVED);
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.SUSPENDED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3Repository).toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, true);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU);
    verify(productSuspensionHistoryRepository).saveAndFlush(
      Mockito.any(ProductSuspensionHistory.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(MERCHANT_CODE_1, Constants.DEFAULT,
      DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.SUSPENSION.getDesc(),
      String.valueOf(false), String.valueOf(true), false, StringUtils.EMPTY);
    verify(productMailEventService).createAndSaveMailEventForSuspensionOrReActivation(
      ProductMailEventsEnum.SUSPENDED, DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE,
      DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void doSuspensionProductsActions_SuspendAction_ForArchivedItemNullTestTest()
    throws Exception {
    suspensionProductRequest.setAction(SUSPEND_ACTION);
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productL3Response.setArchived(false);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, null, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, true);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ARCHIVED);
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.SUSPENDED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void doSuspensionProductsActions_SuspendAction_AlreadySuspendedTestTest()
    throws Exception {
    suspensionProductRequest.setAction(SUSPEND_ACTION);
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productL3Response.setArchived(false);
    productL3Response.setSuspended(true);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, true);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ARCHIVED);
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.SUSPENDED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void doSuspensionProductsActions_SuspendAction_ForUnArchivedItemTest() throws Exception {
    suspensionProductRequest.setAction(SUSPEND_ACTION);
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productL3Response.setArchived(true);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, true);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ARCHIVED);
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.SUSPENDED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);
    verify(productLevel3AggregatorService).updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
      ProductLevel3AggregatorState.ARCHIVED);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3Repository).toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, true);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU);
    verify(productSuspensionHistoryRepository).saveAndFlush(
      Mockito.any(ProductSuspensionHistory.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(MERCHANT_CODE_1, Constants.DEFAULT,
      DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.SUSPENSION.getDesc(),
      String.valueOf(false), String.valueOf(true), false, StringUtils.EMPTY);
    verify(productMailEventService).createAndSaveMailEventForSuspensionOrReActivation(
      ProductMailEventsEnum.SUSPENDED, DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE,
      DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void doSuspensionProductsActions_ReactivateAction_ForUnArchivedItemTest()
    throws Exception {
    suspensionProductRequest.setAction(REACTIVATE_ACTION);
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productL3Response.setSuspended(true);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, false);
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ACTIVE);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.RE_ACTIVATED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);
    verify(productLevel3AggregatorService).updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
      ProductLevel3AggregatorState.ACTIVE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3Repository).toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, false);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU);
    verify(productSuspensionHistoryRepository).saveAndFlush(
      Mockito.any(ProductSuspensionHistory.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(MERCHANT_CODE_1, Constants.DEFAULT,
      DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.SUSPENSION.getDesc(),
      String.valueOf(true), String.valueOf(false), false, StringUtils.EMPTY);
    verify(productMailEventService).createAndSaveMailEventForSuspensionOrReActivation(
      ProductMailEventsEnum.RE_ACTIVATED, DEFAULT_BUSINESS_PARTNER_CODE, NOTES,
      DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void doSuspensionProductsActions_ReactivateAction_ForUnArchivedItemTestNull()
    throws Exception {
    suspensionProductRequest.setAction(REACTIVATE_ACTION);
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productL3Response.setSuspended(true);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, null, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, false);
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ACTIVE);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.RE_ACTIVATED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void doSuspensionProductsActions_ReactivateAction_ForUnArchivedItemTestAlreadyActive()
    throws Exception {
    suspensionProductRequest.setAction(REACTIVATE_ACTION);
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productL3Response.setSuspended(false);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, false);
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, ProductLevel3AggregatorState.ACTIVE);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.RE_ACTIVATED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void doSuspensionProductsActions_ReactivateAction_ForArchivedItemTest() throws Exception {
    suspensionProductRequest.setAction(REACTIVATE_ACTION);
    productL3Response.setItemSkus(Arrays.asList(DEFAULT_ITEM_SKU));
    productL3Response.setSuspended(true);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    productL3Response.setMerchantCode(MERCHANT_CODE_1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, false);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(DEFAULT_ITEM_SKU, MERCHANT_CODE_1, ProductLevel3AggregatorState.ACTIVE);
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.RE_ACTIVATED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3Repository).toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, false);
    verify(productLevel3AggregatorService).updateState(DEFAULT_ITEM_SKU, MERCHANT_CODE_1,
      ProductLevel3AggregatorState.ACTIVE);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU);
    verify(productSuspensionHistoryRepository).saveAndFlush(
      Mockito.any(ProductSuspensionHistory.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(MERCHANT_CODE_1, Constants.DEFAULT,
      DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.SUSPENSION.getDesc(),
      String.valueOf(true), String.valueOf(false), false, StringUtils.EMPTY);
    verify(productMailEventService).createAndSaveMailEventForSuspensionOrReActivation(
      ProductMailEventsEnum.RE_ACTIVATED, MERCHANT_CODE_1, NOTES, DEFAULT_PRODUCT_CODE,
      DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void doSuspensionProductsActionsReactivateActionForArchivedItemTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "skipProductLevel3AggregatorCreation",
      true);
    suspensionProductRequest.setAction(REACTIVATE_ACTION);
    productL3Response.setItemSkus(Arrays.asList(DEFAULT_ITEM_SKU));
    productL3Response.setSuspended(true);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    productL3Response.setMerchantCode(MERCHANT_CODE_1);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.doNothing().when(this.productLevel3Repository)
      .toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, false);
    Mockito.when(
      productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
        DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(new ProductSuspensionHistory());
    Mockito.when(
        productSuspensionHistoryRepository.saveAndFlush(Mockito.any(ProductSuspensionHistory.class)))
      .thenReturn(new ProductSuspensionHistory());
    Mockito.doNothing().when(productLevel3AggregatorService)
      .updateState(DEFAULT_ITEM_SKU, MERCHANT_CODE_1, ProductLevel3AggregatorState.ACTIVE);
    Mockito.doNothing().when(this.productMailEventService)
      .createAndSaveMailEventForSuspensionOrReActivation(ProductMailEventsEnum.RE_ACTIVATED,
        DEFAULT_BUSINESS_PARTNER_CODE, NOTES, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_SKU);

    this.productLevel3ServiceBean.doSuspensionProductsActions(DEFAULT_STORE_ID, DEFAULT_USER_NAME,
      suspensionProductRequest);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3Repository).toggleSuspensionProduct(DEFAULT_PRODUCT_SKU, false);
    verify(
      productSuspensionHistoryRepository).findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
      DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU);
    verify(productSuspensionHistoryRepository).saveAndFlush(
      Mockito.any(ProductSuspensionHistory.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(MERCHANT_CODE_1, Constants.DEFAULT,
      DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.SUSPENSION.getDesc(),
      String.valueOf(true), String.valueOf(false), false, StringUtils.EMPTY);
    verify(productMailEventService).createAndSaveMailEventForSuspensionOrReActivation(
      ProductMailEventsEnum.RE_ACTIVATED, MERCHANT_CODE_1, NOTES, DEFAULT_PRODUCT_CODE,
      DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void updateTest_noO2OFlagChange() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getItems().get(0).setOff2OnActiveFlag(null);
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    savedProductData.getItems().get(0).setOff2OnChannelActive(Boolean.TRUE);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct =
      this.productLevel3ServiceBean.update(product, null, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(updatedProduct.getProductLevel3().getItems().get(0).getOff2OnActiveFlag());
  }

  @Test
  public void countSummaryForInactiveProductTest() throws Exception {
    Page<ItemSummaryResponse> productData =
      new PageImpl<ItemSummaryResponse>(new ArrayList<>(), DEFAULT_PAGEABLE, 30);
    Mockito.when(productBusinessPartnerService.countRejectedProductsByBusinessPartnerId(STOREID,
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(10L);
    Mockito.when(
      productBusinessPartnerService.countSuspendedProductsByBusinessPartnerCode(STOREID, REQUESTID,
        USERNAME, DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(20L);
    Mockito.when(
      productLevel3Repository.findSummaryByFilter(DEFAULT_BUSINESS_PARTNER_CODE, null, null, null,
        null, null, null, null, PageRequest.of(0, 1), true, null)).thenReturn(productData);

    CountProductLevel3InactiveResponse result =
      productLevel3ServiceBean.countSummaryForInactiveProduct(STOREID, REQUESTID, USERNAME,
        DEFAULT_BUSINESS_PARTNER_CODE);

    Assertions.assertNotNull(result);
    verify(productBusinessPartnerService).countRejectedProductsByBusinessPartnerId(STOREID,
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productBusinessPartnerService).countSuspendedProductsByBusinessPartnerCode(STOREID,
      REQUESTID, USERNAME, DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3Repository).findSummaryByFilter(DEFAULT_BUSINESS_PARTNER_CODE, null, null,
      null, null, null, null, null, PageRequest.of(0, 1), true, null);
    Map<ProductLevel3InactiveSummaryCriteria, Long> totalItemsByCriterias =
      result.getTotalItemsByCriterias();
    Assertions.assertEquals(10L,
      totalItemsByCriterias.get(ProductLevel3InactiveSummaryCriteria.REJECTED).longValue());
    Assertions.assertEquals(20L,
      totalItemsByCriterias.get(ProductLevel3InactiveSummaryCriteria.SUSPENDED).longValue());
    Assertions.assertEquals(30L,
      totalItemsByCriterias.get(ProductLevel3InactiveSummaryCriteria.ARCHIVED).longValue());
  }

  @Test
  public void unArchiveGdnSkuTest_newStockAlertTest() throws Exception {
    MDC.put(GdnMandatoryRequestParameterUtil.STORE_ID_KEY_PARAMETER, DEFAULT_STORE_ID);
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(this.productLevel3Repository.findSummaryByGdnSku(DEFAULT_GDN_SKU))
      .thenReturn(itemSummaryResponse);
    Mockito.when(this.categoryRepository.findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE))
      .thenReturn(categoriesData);
    Mockito.when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU, false, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(DEFAULT_GDN_SKU);
  }

  @Test
  public void unArchiveGdnSkuTest_newStockAlertTest_OOSTest() throws Exception {
    productLevel3Inventory.setWarehouseAvailable(0);
    MDC.put(GdnMandatoryRequestParameterUtil.STORE_ID_KEY_PARAMETER, DEFAULT_STORE_ID);
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(new ArrayList<>());
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU, false, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(DEFAULT_GDN_SKU);
  }

  @Test
  public void unArchiveGdnSkuTest_newStockAlertTest_OOSTest_unSynchronizedStock() throws Exception {
    productLevel3Inventory.setWebSyncStock(false);
    productLevel3Inventory.setWebAvailable(0);
    MDC.put(GdnMandatoryRequestParameterUtil.STORE_ID_KEY_PARAMETER, DEFAULT_STORE_ID);
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(this.productLevel3Repository.findSummaryByGdnSku(DEFAULT_GDN_SKU))
      .thenReturn(itemSummaryResponse);
    Mockito.when(this.categoryRepository.findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE))
      .thenReturn(categoriesData);
    Mockito.when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU, false, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(DEFAULT_GDN_SKU);
  }

  @Test
  public void unArchiveGdnSkuTest_newStockAlertTest_unSynchronizedStock() throws Exception {
    productLevel3Inventory.setWebSyncStock(false);
    MDC.put(GdnMandatoryRequestParameterUtil.STORE_ID_KEY_PARAMETER, DEFAULT_STORE_ID);
    Mockito.when(this.productStockAlertRepository.findByGdnSkuOrderByUpdatedDateDesc(Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(this.productLevel3Repository.findSummaryByGdnSku(DEFAULT_GDN_SKU))
      .thenReturn(itemSummaryResponse);
    Mockito.when(this.categoryRepository.findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE))
      .thenReturn(categoriesData);
    Mockito.when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    this.productLevel3ServiceBean.archiveProductStockAlert(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU, false, 0);
    verify(this.productStockAlertRepository).findByGdnSkuOrderByUpdatedDateDesc(DEFAULT_GDN_SKU);
  }

  @Test
  public void tesFindDetailByGdnSkuForAllItemSkus() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    ProductLevel3 productLevel3 = this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(productLevel3.getItems().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertFalse(productLevel3.isForceReview());
    Assertions.assertEquals(Long.valueOf(2), productLevel3.getVersion());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    Assertions.assertEquals(90.0, productLevel3.getProductScore().getTotalScore(), 0);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkus_whenMasterDataItemIsNull() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    productData2.getItems().get(0).setMasterDataItem(null);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    itemSummaryResponse.setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(DEFAULT_PICKUP_POINT_CODE).collect(Collectors.toSet()));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    ProductLevel3 productLevel3 = this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);

    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    Mockito.
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(sapOutbound).getCogsValueResponse(any());
    Assertions.assertEquals("id1", productLevel3.getCategoryId());
    Assertions.assertEquals(DEFAULT_PICKUP_POINT_CODE, productLevel3.getPickupPointCodes().get(0));
    Assertions.assertFalse(productLevel3.isSuspended());
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkus_WithSuspendedTrue() throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    productData2.getItems().get(0).setMasterDataItem(null);
    productData2.getProduct().setSuspended(true);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    itemSummaryResponse.setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(DEFAULT_PICKUP_POINT_CODE).collect(Collectors.toSet()));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));

    ProductLevel3 productLevel3 = this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);

    Mockito.verify(getProductLevel3Repository())
      .findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU));
    Mockito.verify(getProductLevel3InventoryService())
      .findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_GDN_SKU);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE_3);
    Mockito.
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(sapOutbound).getCogsValueResponse(any());
    Assertions.assertEquals(DEFAULT_PICKUP_POINT_CODE, productLevel3.getPickupPointCodes().get(0));
    Assertions.assertTrue(productLevel3.isSuspended());
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkus_InventoryNull() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU)).thenReturn(null);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE_3,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    Mockito.
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(sapOutbound).getCogsValueResponse(any());
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkus_NotFoundLevel2Inventory() throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE_3,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithCogsNull() throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    productData2.getProduct().setForceReview(true);
    productData2.getProduct().setForceReview(true);
    businessPartnerData.setTrustedSeller(false);
    ProductWarehouse cogs = null;
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(sapOutbound).getCogsValueResponse(any());
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithCogsResponseNull() throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductWarehouse cogs = new ProductWarehouse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);

    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithListDiscountPriceEmpty() throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    productData2.getProduct().setForceReview(true);
    productData2.getProduct().setForceReview(true);
    businessPartnerData.setTrustedSeller(false);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "failed"));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
        DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithListDiscountPriceEmptyForTrsutedSellers()
    throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "failed"));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithMasterDataAttributeDTOAttributeTypeNull()
    throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductWarehouse cogs = null;
    productData2.getProduct().getMasterDataProduct().getMasterDataProductAttributes().get(0)
      .getMasterDataAttribute().setAttributeType(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(sapOutbound).getCogsValueResponse(any());
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithMasterDataAttributeDTONull()
    throws Exception {
    ProductAndItemsResponse productData2 = generateProductDataWithoutDiscount();
    ProductWarehouse cogs = null;
    productData2.getProduct().getDescriptiveAttributes().get(0).setAttributeCode("f");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productData2);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithMDCValueAndInventoryLevel1IdIsNullAndSyncedToLevel1IsFalse()
    throws Exception {
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setForceReview(true);
    productData.getProduct().setSuspended(true);
    businessPartnerData.setTrustedSeller(false);
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_2));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, null);
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithMDCValueAndInventoryForTrustedSeller()
    throws Exception {
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setForceReview(true);
    productData.getProduct().setSuspended(true);
    businessPartnerData.setTrustedSeller(true);
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2);

    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_2));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, null);
  }


  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithNullInventory() throws Exception {
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2);

    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_2));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(sapOutbound).getCogsValueResponse(any());
    MDC.clear();
  }


  @Test
  public void testFindDetailByGdnSkuForAllItemSkus_whenMerchantTypeNotCmAndRD() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", true);
    this.businessPartnerData.getCompany().setMerchantType("TD");
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2);

    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_2));
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    MDC.clear();
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkus_whenMerchantTypeCmAndRD() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", true);
    ProfileResponse profileResponse = new ProfileResponse();
    CompanyDTO companyDTO = new CompanyDTO();
    companyDTO.setMerchantType("CM");
    profileResponse.setCompany(companyDTO);

    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(profileResponse);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2);

    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_2));
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    MDC.clear();
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkus_whenOBThrowException() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "isBusinessPartnerCallRequire", true);
    this.businessPartnerData.getCompany().setMerchantType("TD");
    MDC.put(GdnMandatoryRequestParameterUtil.REQUEST_ID_KEY_PARAMETER, DEFAULT_REQUEST_ID);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().setProductSpecialAttributes(null);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    Mockito.doThrow(new RuntimeException()).when(this.businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2);

    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_2));
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    MDC.clear();
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithoutDifferentSpecialAttribute()
    throws Exception {
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU_2);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_2));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithSyncedToLevel1IsFalsePBPMinStockFound()
    throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_4)))
      .thenReturn(productData);
    
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(Mockito.any()))
      .thenReturn(2);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE_3,
      DEFAULT_GDN_SKU_4);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_4));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU_4);
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(productBusinessPartnerService).getMinimumStockByGdnProductItemSku(Mockito.any());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    Mockito.verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemSkusWithSyncedToLevel1IsFalsePBPMinStockNotFound()
    throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_4)))
      .thenReturn(productData);
    
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(Mockito.any()))
      .thenReturn(null);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE_3,
      DEFAULT_GDN_SKU_4);

    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_4));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_GDN_SKU_4);
    verify(productBusinessPartnerService).getMinimumStockByGdnProductItemSku(Mockito.any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE_3);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    
  }


  @Test
  public void updateItemViewConfigForChangedConfigTest_noChanges() throws Exception {
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    for (ItemViewConfigDTO itemViewConfigDTO : item.getItems().get(0).getItemViewConfigs()) {
      itemViewConfigDTO.setBuyable(false);
      itemViewConfigDTO.setDiscoverable(false);
      itemViewConfigDTO.setChannel(CHANNELID);
    }
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    this.productLevel3ServiceBean.updateItemViewConfigToHideItemSku(itemViewConfigRequest,
      ITEM_SKU, StringUtils.EMPTY);
    verify(getProductLevel3Repository()).findDetailByGdnSku(ITEM_SKU);
  }

  @Test
  public void updateItemViewConfigForChangedConfigTest_archivedProductTest() throws Exception {
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(true);
    for (ItemViewConfigDTO itemViewConfigDTO : item.getItems().get(0).getItemViewConfigs()) {
      itemViewConfigDTO.setBuyable(false);
      itemViewConfigDTO.setDiscoverable(false);
      itemViewConfigDTO.setChannel(CHANNELID);
    }
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    this.productLevel3ServiceBean.updateItemViewConfigToHideItemSku(itemViewConfigRequest,
      ITEM_SKU, StringUtils.EMPTY);
    verify(getProductLevel3Repository()).findDetailByGdnSku(ITEM_SKU);
  }

  @Test
  public void updateItemViewConfigForChangedConfigTest() throws Exception {
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemViewConfig((ItemViewConfigRequest) Mockito.any(), Mockito.any());
    this.productLevel3ServiceBean.updateItemViewConfigToHideItemSku(itemViewConfigRequest,
      ITEM_SKU, StringUtils.EMPTY);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(ITEM_SKU);
    verify(this.updateProductItemLevel3ModelConverter,
      TWO_TIMES).convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(getProductLevel3Repository()).updateItemViewConfig(
      (ItemViewConfigRequest) Mockito.any(), Mockito.any());
  }

  @Test
  public void findProductSummaryForBulkDownloadTest() throws Exception {
    Mockito.when(productLevel3DirectAggregatorService.aggregateProductLevel3Summary(filterRequest,
      DEFAULT_PAGE_REQUEST, sortOrder)).thenReturn(new PageImpl<>(new ArrayList<>()));
    this.productLevel3ServiceBean.findProductSummaryForBulkDownload(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_PAGE_REQUEST, DEFAULT_REQUEST_ID, filterRequest);
    verify(productLevel3DirectAggregatorService).aggregateProductLevel3Summary(
      productLevel3SummaryFilterArgumentCaptor.capture(), Mockito.eq(DEFAULT_PAGE_REQUEST),
      sortOrderArgumentCaptor.capture());
    Assertions.assertEquals(CREATED_DATE, sortOrderArgumentCaptor.getValue().getOrderBy());
    Assertions.assertEquals(DESC, sortOrderArgumentCaptor.getValue().getSortBy());
    Assertions.assertEquals(DEFAULT_BUSINESS_PARTNER_CODE,
      productLevel3SummaryFilterArgumentCaptor.getValue().getBusinessPartnerCode());
  }

  @Test
  public void findProductSummaryForBulkDownloadByDbTest() throws Exception {
    Mockito.when(
        bulkProductLevel3AggregatorService.aggregateProductLevel3SummaryByDb(filterRequest, false,
            null))
      .thenReturn(new BulkDownloadProductLevel3Response());
    this.productLevel3ServiceBean.findProductSummaryForBulkDownloadByDb(filterRequest, false, null);
    verify(bulkProductLevel3AggregatorService).aggregateProductLevel3SummaryByDb(
      productLevel3SummaryFilterArgumentCaptor.capture(), eq(false), eq(null));
  }

  @Test
  public void findProductSummaryForBulkDownloadByDb_ExceptionTest() throws Exception {
    Mockito.when(
        bulkProductLevel3AggregatorService.aggregateProductLevel3SummaryByDb(filterRequest, false,
            null))
      .thenThrow(new Exception());
    Assertions.assertThrows(Exception.class, () -> {
      this.productLevel3ServiceBean.findProductSummaryForBulkDownloadByDb(filterRequest, false, null);
    });
    verify(bulkProductLevel3AggregatorService).aggregateProductLevel3SummaryByDb(
        Mockito.any(),Mockito.anyBoolean(),Mockito.any());
  }

  @Test
  public void filterDetailByGdnSkuWithPVEnableFalseTest() throws Exception {
    Assertions.assertFalse(productLevel3ServiceBean.isPristineCategory(DEFAULT_CATEGORY_ID));
  }

  @Test
  public void updateTestWithVersion() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setArchived(Boolean.TRUE);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    product.setVersion(VERSION);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU)))
      .thenReturn(productLevel3Inventory);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(DEFAULT_GDN_SKU))
      .thenReturn(savedProductData);
    try {
      Assertions.assertThrows(ApplicationException.class, () -> {
        this.productLevel3ServiceBean.update(product, 5, 2, false);
      });
    } finally {
      verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU));
      verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_GDN_SKU);
    }
  }

  @Test
  public void getMinimumPriceTest() {
    Mockito.when(
        this.productSystemParameterService.findByStoreIdAndVariable(STOREID, Constants.MINIMUM_PRICE))
      .thenReturn(productSystemParameter);
    Integer response = this.productLevel3ServiceBean.getMinimumPrice(STOREID);
    verify(productSystemParameterService).findByStoreIdAndVariable(STOREID,
      Constants.MINIMUM_PRICE);
    Assertions.assertEquals(new Integer(1), response);
  }

  @Test
  public void getMinimumPriceWithNullTest() {
    Mockito.when(
        this.productSystemParameterService.findByStoreIdAndVariable(STOREID, Constants.MINIMUM_PRICE))
      .thenReturn(null);
    Integer response = this.productLevel3ServiceBean.getMinimumPrice(STOREID);
    verify(productSystemParameterService).findByStoreIdAndVariable(STOREID,
      Constants.MINIMUM_PRICE);
    Assertions.assertNull(response);
  }

  @Test
  public void testFindDetailByGdnSkuForAllItemWithDifferentSpecialAttribute() throws Exception {
    AttributeResponse attributeResponse = new AttributeResponse();
    attributeResponse.setMandatory(true);
    attributeResponse.setBasicView(true);
    attributeResponse.setSkuValue(true);
    attributeResponse.setName(DEFAULT_ATTRIBUTE_NAME);
    attributeResponse.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_5);
    attributeResponse.setAttributeType(DEFAULT_ATTRIBUTE_TYPE_3);
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setDefiningAttributes(null);
    productData.getProduct().getProductSpecialAttributes().get(0)
      .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_5);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(
        getProductLevel3Repository().findProductAndItemDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU_2)))
      .thenReturn(productData);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(this.productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_5))
      .thenReturn(attributeResponse);
    Mockito.when(getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2)).thenReturn(null);
    
    Mockito.when(this.productPricingOutbound.getWholesalePrice(any(), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(
      productBusinessPartnerRepository.findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU)).thenReturn(
      Arrays.asList(DEFAULT_ITEM_SKU));
    ProductLevel3 productLevel3 =
      this.productLevel3ServiceBean.findDetailByGdnSkuForAllItemSkus(DEFAULT_BUSINESS_PARTNER_CODE,
        DEFAULT_GDN_SKU_2);
    verify(this.productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_5);
    verify(getProductLevel3Repository()).findProductAndItemDetailByGdnSku(
      Mockito.eq(DEFAULT_GDN_SKU_2));
    verify(getProductLevel3InventoryService()).findInventoryByBusinessPartnerCodeAndGdnSku(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU_2);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_GDN_SKU_2,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_GDN_SKU);
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_GDN_SKU);
    verify(productPricingOutbound).getWholesalePrice(any(), Mockito.any());
    ProductLevel3Attribute productLevel3Attribute = productLevel3.getAttributes().stream()
      .filter(p -> DEFAULT_ATTRIBUTE_CODE_5.equals(p.getAttributeCode())).findFirst().get();
    Assertions.assertTrue(productLevel3Attribute.isMandatory());
    Assertions.assertTrue(productLevel3Attribute.isBasicView());
    Assertions.assertTrue(productLevel3Attribute.getSkuValue());
    Assertions.assertEquals(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name(),
      productLevel3Attribute.getAttributeType());
    Assertions.assertEquals(DEFAULT_ATTRIBUTE_NAME, productLevel3Attribute.getAttributeName());
  }

  @Test
  public void updateItemPriceTest_exceptionOnVersionCheck() throws Exception {
    ProductAndItemsResponse item = generateProductData();
    productPriceAndWholesaleRequest.setVersion(Long.valueOf(0));
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID,
            productPriceAndWholesaleRequest, ITEM_SKU);
      });
    } finally {
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    }
  }

  @Test
  public void checkCategoryProductWholesaleRulesTest() throws Exception {
    productCollection.setPostLive(true);
    productCollection.setProductId(PRODUCT_CODE);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productBusinessPartner.setProductItemBusinessPartners(
      Arrays.asList(productItemBusinessPartner));
    when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      PRODUCT_CODE)).thenReturn(productCollection);
    when(this.productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID,
      PRODUCT_CODE)).thenReturn(Arrays.asList(productBusinessPartner));
    when(this.productPricingOutbound.getWholesalePriceList(eq(Collections.singleton(ITEM_SKU)),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(this.wholesaleValidationUtil.validateWholesaleConfigOnFlow1(eq(CATEGORY_CODE),
      Mockito.anyList(), Mockito.eq(true))).thenReturn(null);
    productLevel3ServiceBean.checkCategoryProductWholesaleRules(DEFAULT_STORE_ID, PRODUCT_CODE,
      CATEGORY_CODE);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      PRODUCT_CODE);
    verify(this.productBusinessPartnerRepository).findByStoreIdAndProductId(DEFAULT_STORE_ID,
      PRODUCT_CODE);
    verify(this.productPricingOutbound).getWholesalePriceList(eq(Collections.singleton(ITEM_SKU)),
      Mockito.anyMap());
    verify(this.wholesaleValidationUtil).validateWholesaleConfigOnFlow1(eq(CATEGORY_CODE),
      Mockito.anyList(), Mockito.eq(true));
  }

  @Test
  public void checkCategoryProductWholesaleRules_preLiveTest() throws Exception {
    productCollection.setPostLive(false);
    productCollection.setProductId(PRODUCT_CODE);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productBusinessPartner.setProductItemBusinessPartners(
      Arrays.asList(productItemBusinessPartner));
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      PRODUCT_CODE)).thenReturn(productCollection);
    when(this.productPricingOutbound.getWholesalePriceList(eq(Collections.singleton(ITEM_SKU)),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(this.productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID,
      PRODUCT_CODE)).thenReturn(Arrays.asList(productBusinessPartner));
    when(this.productItemWholesalePriceService.findByStoreIdAndItemSkus(DEFAULT_STORE_ID,
      Arrays.asList(ITEM_SKU))).thenReturn(Arrays.asList(productItemWholesalePrice));
    when(this.wholesaleValidationUtil.validateWholesaleConfigOnFlow1(eq(CATEGORY_CODE),
      Mockito.anyList(), eq(true))).thenReturn(null);
    when(mapperUtil.mapStringToResponse(Mockito.any())).thenReturn(
      Arrays.asList(new ProductItemWholesalePriceResponse(3, 30.0)));
    productLevel3ServiceBean.checkCategoryProductWholesaleRules(DEFAULT_STORE_ID, PRODUCT_CODE,
      CATEGORY_CODE);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      PRODUCT_CODE);
    verify(this.productBusinessPartnerRepository).findByStoreIdAndProductId(DEFAULT_STORE_ID,
      PRODUCT_CODE);
    verify(this.productPricingOutbound).getWholesalePriceList(eq(Collections.singleton(ITEM_SKU)),
      Mockito.anyMap());
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(DEFAULT_STORE_ID,
      Arrays.asList(ITEM_SKU));
    verify(this.wholesaleValidationUtil).validateWholesaleConfigOnFlow1(eq(CATEGORY_CODE),
      Mockito.anyList(), eq(true));
    verify(this.mapperUtil).mapStringToResponse(Mockito.any());
  }

  @Test
  public void checkCategoryProductWholesaleRules_comparisonFailedTest() throws Exception {
    productCollection.setPostLive(true);
    productCollection.setProductId(PRODUCT_CODE);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productBusinessPartner.setProductItemBusinessPartners(
      Arrays.asList(productItemBusinessPartner));
    when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      PRODUCT_CODE)).thenReturn(productCollection);
    when(this.productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID,
      PRODUCT_CODE)).thenReturn(Arrays.asList(productBusinessPartner));
    when(this.productPricingOutbound.getWholesalePriceList(eq(Collections.singleton(ITEM_SKU)),
      Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(this.wholesaleValidationUtil.validateWholesaleConfigOnFlow1(eq(CATEGORY_CODE),
      Mockito.anyList(), Mockito.eq(true))).thenReturn(ApiErrorCode.DIFFERENT_THRESHOLD_ERROR_CODE);
    productLevel3ServiceBean.checkCategoryProductWholesaleRules(DEFAULT_STORE_ID, PRODUCT_CODE,
      CATEGORY_CODE);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      PRODUCT_CODE);
    verify(this.productBusinessPartnerRepository).findByStoreIdAndProductId(DEFAULT_STORE_ID,
      PRODUCT_CODE);
    verify(this.productPricingOutbound).getWholesalePriceList(eq(Collections.singleton(ITEM_SKU)),
      Mockito.anyMap());
    verify(this.wholesaleValidationUtil).validateWholesaleConfigOnFlow1(eq(CATEGORY_CODE),
      Mockito.anyList(), Mockito.eq(true));
  }

  @Test
  public void updateItemPrice_wholesalePromoTrueTest() throws Exception {
    wholesalePriceSkuResponse.setPromoActive(Boolean.TRUE);
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID, productPriceAndWholesaleRequest,
      ITEM_SKU);
    verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter,
      TWO_TIMES).convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class));
    verify(this.productPricingOutbound).getWholesalePrice(eq(ITEM_SKU), Mockito.any());
    verify(this.productPricingOutbound).upsertWholesalePrice(
      Mockito.any(WholesalePriceRequest.class));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(getProductLevel3Repository()).updateItemPrice(Mockito.any(), Mockito.any());
    verify(this.mapperUtil, times(2)).mapRequestToString(Mockito.anyList());
    verify(this.wholesaleValidationUtil).validateWholesalePriceRequestForUpdate(DEFAULT_STORE_ID,
      productPriceAndWholesaleRequest, ITEM_SKU, item, 1);
    verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
      Mockito.any(ProductAndItemsResponse.class));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(item.getProduct().getMasterCatalog().getCategory().getCategoryCode(),
      value.getDiscountDTOList().get(0).getCategoryCode());
    Assertions.assertEquals(ITEM_SKU, value.getDiscountDTOList().get(0).getItemSku());
    Assertions.assertEquals(productPriceAndWholesaleRequest.getOfferPrice(),
      value.getDiscountDTOList().get(0).getSellingPrice(), 0);
  }


  @Test
  public void updateItemPrice_newRulesAdded() throws Exception {
    wholesalePriceSkuResponse.setWholesaleRules(new HashMap<>());
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID, productPriceAndWholesaleRequest,
      ITEM_SKU);
    verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter,
      TWO_TIMES).convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class));
    verify(this.productPricingOutbound).getWholesalePrice(eq(ITEM_SKU), Mockito.any());
    verify(this.productPricingOutbound).upsertWholesalePrice(
      Mockito.any(WholesalePriceRequest.class));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(getProductLevel3Repository()).updateItemPrice(Mockito.any(), Mockito.any());
    verify(this.mapperUtil, times(2)).mapRequestToString(Mockito.anyList());
    verify(this.wholesaleValidationUtil).validateWholesalePriceRequestForUpdate(DEFAULT_STORE_ID,
      productPriceAndWholesaleRequest, ITEM_SKU, item, 1);
    verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
      Mockito.any(ProductAndItemsResponse.class));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    System.out.println(value);
    Assertions.assertEquals(item.getProduct().getMasterCatalog().getCategory().getCategoryCode(),
      value.getDiscountDTOList().get(0).getCategoryCode());
    Assertions.assertEquals(ITEM_SKU, value.getDiscountDTOList().get(0).getItemSku());
    Assertions.assertEquals(productPriceAndWholesaleRequest.getOfferPrice(),
      value.getDiscountDTOList().get(0).getSellingPrice(), 0);
  }

  @Test
  public void updateItemPrice_noWholesaleFlagChange() throws Exception {
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    Mockito.when(this.productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
        this.productPricingOutbound.upsertWholesalePrice(Mockito.any(WholesalePriceRequest.class)))
      .thenReturn(new WholesalePriceBulkUpdateResponse());
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE)).thenReturn(productSystemParameter);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductAndItemsResponse(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.doNothing().when(this.updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.when(this.mapperUtil.mapRequestToString(Mockito.anyList())).thenReturn(PRODUCT_HISTORY);
    this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID, productPriceAndWholesaleRequest,
      ITEM_SKU);
    verify(this.productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.MINIMUM_PRICE);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter,
      TWO_TIMES).convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class));
    verify(this.productPricingOutbound).getWholesalePrice(eq(ITEM_SKU), Mockito.any());
    verify(this.productPricingOutbound).upsertWholesalePrice(
      Mockito.any(WholesalePriceRequest.class));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    verify(getProductLevel3Repository()).updateItemPrice(Mockito.any(), Mockito.any());
    verify(this.mapperUtil, times(2)).mapRequestToString(Mockito.anyList());
    verify(this.wholesaleValidationUtil).validateWholesalePriceRequestForUpdate(DEFAULT_STORE_ID,
      productPriceAndWholesaleRequest, ITEM_SKU, item, 1);
    verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
      Mockito.any(ProductAndItemsResponse.class));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(item.getProduct().getMasterCatalog().getCategory().getCategoryCode(),
      value.getDiscountDTOList().get(0).getCategoryCode());
    Assertions.assertEquals(ITEM_SKU, value.getDiscountDTOList().get(0).getItemSku());
    Assertions.assertEquals(productPriceAndWholesaleRequest.getOfferPrice(),
      value.getDiscountDTOList().get(0).getSellingPrice(), 0);
  }

  @Test
  public void updateItemPrice_IsArchived() throws Exception {
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(true);
    Mockito.when(variantEditValidationService.checkArchivedSuspendedRejectedFaultyImageForUpdate(
      Mockito.any(ProductAndItemsResponse.class))).thenReturn(ApiErrorCode.ITEM_IS_ARCHIVED);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    Mockito.doNothing().when(getProductLevel3Repository())
      .updateItemPrice(Mockito.any(), Mockito.any());
    ApiErrorCode apiErrorCode = this.productLevel3ServiceBean.updateItemPrice(DEFAULT_STORE_ID,
      productPriceAndWholesaleRequest, ITEM_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(variantEditValidationService).checkArchivedSuspendedRejectedFaultyImageForUpdate(
      Mockito.any(ProductAndItemsResponse.class));
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_ARCHIVED.getCode(), apiErrorCode.getCode());
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_ARCHIVED.getDesc(), apiErrorCode.getDesc());
  }

  @Test
  public void updateTest_priceUpdateTest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct =
      this.productLevel3ServiceBean.update(product, null, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
  }

  @Test
  public void updateTest_priceNullTest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setPrices(null);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct =
      this.productLevel3ServiceBean.update(product, null, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
  }

  @Test
  public void updateTest_priceUpdateTest_deltaStockZero() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    product.setProductType(3);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(Mockito.any()))
      .thenReturn(null);

    this.productLevel3ServiceBean.update(product, 0, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest_emptyPricesOnRequest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    savedProductData.getItems().get(0).setPrice(new HashSet<>());
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    product.setProductType(3);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(true), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(productBusinessPartnerService.getMinimumStockByGdnProductItemSku(Mockito.any()))
      .thenReturn(null);

    this.productLevel3ServiceBean.update(product, 0, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(true), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void updateTest_samePriceTest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    savedProductData.getItems().get(0).setPrice(new HashSet<>());
    product.getItems().get(0).setPrices(new ArrayList<>());
    PriceDTO priceDTO = new PriceDTO();
    priceDTO.setListPrice(100);
    priceDTO.setOfferPrice(100);
    priceDTO.setChannel(DEFAULT_CHANNEL_ID);
    savedProductData.getItems().get(0).getPrice().add(priceDTO);
    ProductLevel3Price productLevel3Price = new ProductLevel3Price();
    productLevel3Price.setChannelId(DEFAULT_CHANNEL_ID);
    productLevel3Price.setPrice(100.0);
    productLevel3Price.setSalePrice(100.0);
    product.getItems().get(0).getPrices().add(productLevel3Price);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct =
      this.productLevel3ServiceBean.update(product, null, null, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
  }

  @Test
  public void updateWholesaleUpdateTest_emptyRules() throws Exception {
    wholesalePriceSkuResponse.setWholesaleRules(new HashMap<>());
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getItems().get(0).setWholesalePriceActivated(Boolean.TRUE);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setWholesalePriceActivated(true);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
  }

  @Test
  public void updateWholesaleUpdateTest_nonNullApiErrorCode() throws Exception {
    wholesalePriceSkuResponse.setWholesaleRules(new HashMap<>());
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getItems().get(0).setWholesalePriceActivated(Boolean.TRUE);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setWholesalePriceActivated(true);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    when(this.wholesaleValidationUtil.validateWholesaleConfigOnUpdate(eq(DEFAULT_CATEGORY_CODE),
      Mockito.anyList(), Mockito.any(ItemRequest.class), Mockito.anyInt(), Mockito.any(),
      eq(Boolean.TRUE), eq(null))).thenReturn(ApiErrorCode.DIFFERENT_THRESHOLD_ERROR_CODE);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
  }

  @Test
  public void updateSummaryVersionTest() throws Exception {
    try {
      ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
      request.setVersion(2L);
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
            request);
      });
    } finally {
      verify(getProductLevel3Repository()).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    }
  }

  @Test
  public void updateSummaryTestNullRequestVersion() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    ItemSummaryResponse itemSummaryResponse = generateItemSummaryData();
    request.setVersion(null);
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any()))
      .thenReturn(itemSummaryResponse);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
      Mockito.any());
    Assertions.assertFalse(productLevel3Summary.getWholesalePriceActivated());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateSummaryTestNullResponseVersion() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getPrices().get(0).setSalePrice(20000.0);
    ItemSummaryResponse itemSummaryResponse = generateItemSummaryData();
    itemSummaryResponse.setVersion(null);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any()))
      .thenReturn(itemSummaryResponse);
    Mockito.when(pcbFeign.getWholesaleConfigToCategory(Constants.DEFAULT_STORE_ID,
        Constants.DEFAULT_CHANNEL_ID, Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, DEFAULT_CATEGORY_CODE))
      .thenReturn(new GdnRestSingleResponse<>(getWholeSaleMapping(), REQUESTID));
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Mockito.when(
      productPricingOutbound.setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
        Mockito.any())).thenReturn(true);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    ProductLevel3Summary productLevel3Summary =
      this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU,
        request);
    verify(getProductLevel3Repository(), TWO_TIMES).findSummaryByGdnSku(DEFAULT_GDN_SKU);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(getProductLevel3Repository()).updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(
      Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(getBusinessPartnerRepository()).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    verify(getPickupPointRepository()).findByPickupPointCode(Mockito.any());
    verify(updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class));
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(DEFAULT_GDN_SKU), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_GDN_SKU), Mockito.any());
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_GDN_SKU), eq(INACTIVE_STATUS),
      Mockito.any());
    Assertions.assertFalse(productLevel3Summary.getWholesalePriceActivated());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture());
    CampaignUpdateDiscountRequest value = campaignUpdateDiscountRequestArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_GDN_SKU, value.getDiscountDTOList().get(0).getItemSku());
  }

  @Test
  public void updateTestForDifferentProductName() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(PRODUCT_NAME2);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void updateTestForDifferentProductDescription() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(PRODUCT_NAME1);
    product.setDescription(PRODUCT_DESCRIPTION2);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void updateTestForDifferentProductUniqueSellingPoint() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(PRODUCT_NAME1);
    product.setDescription(PRODUCT_DESCRIPTION1);
    product.setUniqueSellingPoint(PRODUCT_USP2);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void updateTestContentChangeFalse() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean,"instoreNewFlowEnabled", false);
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(null);
    product.setDescription(null);
    product.setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.setAttributes(new ArrayList<>());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertFalse(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void updateTestContentChangeWithUSP() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(null);
    product.setDescription(null);
    product.setUniqueSellingPoint(null);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.setAttributes(new ArrayList<>());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void updateTestContentChangeWithSavedProductUSPNull() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(null);
    product.setDescription(null);
    product.setUniqueSellingPoint(DEFAULT_UNIQUE_SELLING_POINT);
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.setAttributes(new ArrayList<>());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void updateTestContentChangeWithUSPUpdated() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(null);
    product.setDescription(null);
    product.setUniqueSellingPoint(DEFAULT_UNIQUE_SELLING_POINT);
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(PRODUCT_USP1);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.setAttributes(new ArrayList<>());
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void updateTestForNewAttribute() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(PRODUCT_NAME1);
    product.setDescription(PRODUCT_DESCRIPTION1);
    product.setUniqueSellingPoint(PRODUCT_USP1);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    ProductLevel3Attribute productLevel3Attribute = new ProductLevel3Attribute();
    productLevel3Attribute.setSkuValue(false);
    productLevel3Attribute.setVariantCreation(false);
    productLevel3Attribute.setAttributeCode("NEW");
    productLevel3Attribute.setAttributeType("DESCRIPTIVE_ATTRIBUTE");
    productLevel3Attribute.setValues(Arrays.asList("A"));
    product.getAttributes().add(productLevel3Attribute);
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void updateTestForSkipSpecialAttribute() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(PRODUCT_NAME1);
    product.setDescription(PRODUCT_DESCRIPTION1);
    product.setUniqueSellingPoint(PRODUCT_USP1);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    ProductLevel3Attribute productLevel3Attribute = new ProductLevel3Attribute();
    productLevel3Attribute.setSkuValue(true);
    productLevel3Attribute.setVariantCreation(false);
    productLevel3Attribute.setAttributeCode("NEW");
    productLevel3Attribute.setAttributeType("DESCRIPTIVE_ATTRIBUTE");
    productLevel3Attribute.setValues(Arrays.asList("A"));
    product.getAttributes().add(productLevel3Attribute);
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void updateTestForDifferentHTMLProductDescription() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct()
      .setDescription("PRODUCT_DESCRIPTION2 + &amp;");
    ProductLevel3 product = generateProductLevel3();
    product.setProductName(PRODUCT_NAME1);
    product.setDescription(PRODUCT_DESCRIPTION2 + "&lt;");
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0)
      .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false);

    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false),
      itemArgumentCaptor.capture());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
      Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(DEFAULT_GDN_SKU),
      DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true);
    verify(getProductLevel3InventoryService(),
      TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
      DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
      Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getDescription());
    Assertions.assertNotNull(updatedProduct.getProductLevel3().getCategoryCode());
    Assertions.assertTrue(itemArgumentCaptor.getValue().isContentChanged());
  }

  @Test
  public void findSummaryDetailsByFilterTest() throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(ITEM_CODE);
    productItemResponse.setUpcCode(DEFAULT_UPC_CODE);
    Image image = new Image();
    image.setLocationPath("location-path");
    image.setMarkForDelete(false);
    image.setEdited(true);
    image.setActive(true);
    image.setSequence(1);
    image.setMainImages(true);
    productItemResponse.setImages(Arrays.asList(image));
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(any(SkuCodesRequest.class))).thenReturn(
      productItemResponseList);
    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    Mockito.when(sapOutbound.getCogsValueResponse(any())).thenThrow(new RuntimeException());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
      new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "true",
        "campaignPriceValidation", false));
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);

    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(campaignOutbound).getCampaignPriceInfoV2(Mockito.any());
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE,result.getContent().get(0).getProductCode());
    Assertions.assertEquals(result.getContent().get(0).getProductSku(), DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
    Assertions.assertEquals(DEFAULT_BUSINESS_PARTNER_CODE,
      result.getContent().get(0).getMerchantCode());
    Assertions.assertEquals(DEFAULT_CATEGORY_CODE, result.getContent().get(0).getCategoryCode());
    Assertions.assertEquals("ERR-00000", result.getContent().get(0).getCogsErrorCode());
    Assertions.assertEquals(1, result.getContent().get(0).getImages().size());
  }

  @Test
  public void findSummaryDetailsByFilterWithExceptionTest() throws Exception {
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(ITEM_CODE);
    productItemResponse.setUpcCode(DEFAULT_UPC_CODE);
    Image image = new Image();
    image.setLocationPath("location-path");
    image.setMarkForDelete(false);
    image.setEdited(true);
    image.setActive(true);
    image.setSequence(1);
    image.setMainImages(true);
    productItemResponse.setImages(Arrays.asList(image));
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(any(SkuCodesRequest.class))).thenThrow(
      new Exception());
    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    Mockito.when(sapOutbound.getCogsValueResponse(any())).thenThrow(new RuntimeException());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
      new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "true",
        "campaignPriceValidation", false));
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);

    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(campaignOutbound).getCampaignPriceInfoV2(Mockito.any());
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(result.getContent().get(0).getProductSku(), DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
    Assertions.assertEquals(DEFAULT_BUSINESS_PARTNER_CODE,
      result.getContent().get(0).getMerchantCode());
    Assertions.assertEquals(DEFAULT_CATEGORY_CODE, result.getContent().get(0).getCategoryCode());
    Assertions.assertEquals("ERR-00000", result.getContent().get(0).getCogsErrorCode());
  }

  @Test
  public void updateImagesApiErrorCodeSynchronisedProductTestForException() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(true);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode("INTERNAL");
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductImageEditRequest productImageEditRequest =
      ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageUpdated(true)
        .imagePath(DEFAULT_LOCATION_PATH).build();
    ItemImageEditRequest itemImageEditRequest = new ItemImageEditRequest();
    itemImageEditRequest.setMarkForDelete(true);
    productImageEditRequest.setProductItems(Arrays.asList(itemImageEditRequest));
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    List<ConfigurationStatusResponse> configurationStatusResponses = Arrays.asList(
      new ConfigurationStatusResponse(MERCHANT_CODE_1, CATEGORY_CODE, POST_REVIEW_TYPE));
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType("gold");
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.doThrow(RuntimeException.class).when(productAnalyticsOutbound)
      .getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
      .thenReturn(itemImagesUpdateStatus);
    Mockito.when(
        productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
      .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
      .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
      .thenReturn(new ProductBusinessPartner());
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
      productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound).updateImages(
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository)
      .findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
  }

  @Test
  public void findSummaryDetailsByFilterEmptyResponseFromXproductTest() throws Exception {
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    List<String> listOfGdnSkus = new ArrayList<>();
    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(new PageImpl<>(new ArrayList<>(), PAGEABLE, 0));
    Mockito.when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(),
        anyList())).thenReturn(inventories);
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);
    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound)
      .findSummaryDetailsByFilter(Mockito.any(ItemsSummaryDetailRequest.class),
        Mockito.any(Pageable.class));
    Assertions.assertTrue(CollectionUtils.isEmpty(result.getContent()));
  }

  @Test
  public void findSummaryDetailsByFilterIsNeedCorrectionAndEmptyResponseFromXproductTest()
    throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    productLevel3SummaryFilterDetails.setNeedCorrection(true);
    Product product = generateProduct();
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setSalePrice(DEFAULT_SALE_PRICE);
    productItemBusinessPartner.setPrice(DEFAULT_PRICE);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(DEFAULT_DELTA_STOCK);
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    ItemNotesDto itemNotesDto =
      ItemNotesDto.builder().itemSku(ITEM_SKU).itemName(ITEM_NAME).build();
    productCollection.setPostLive(true);
    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(new PageImpl<>(new ArrayList<>(), PAGEABLE, 0));
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(productBusinessPartner);
    Mockito.when(
        this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
          any(), any(), any(Pageable.class)))
      .thenReturn(new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    Mockito.when(this.productRepository.findOne(any())).thenReturn(product);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    Mockito.when(productServiceWrapper.getVendorNotes(any(), any())).thenReturn(
      VendorNotesResponse.builder().contentAdditionalNotes("content").imagesAdditionalNotes("image")
        .allVariants(true).itemNotes(Arrays.asList(itemNotesDto)).build());
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);
    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productItemBusinessPartnerRepository)
      .findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(any(),
        any(), any(Pageable.class));
    Mockito.verify(this.productRepository).findOne(any());
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(any(), any());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    Mockito.verify(productItemWholesalePriceRepository).findByStoreIdAndItemSkuIn(any(), anyList());
    Mockito.verify(productServiceWrapper).getVendorNotes(any(), any());
    Assertions.assertFalse(CollectionUtils.isEmpty(result.getContent()));
  }


  @Test
  public void findSummaryDetailsByFilterIsNeedCorrectionAndEmptyResponseFromXproductWithWSTest()
    throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    productLevel3SummaryFilterDetails.setNeedCorrection(true);
    Product product = generateProduct();
    ProductCategory productCategory = new ProductCategory();
    Category category = new Category();
    category.setCategoryCode(DEFAULT_CATEGORY_CODE);
    productCategory.setCategory(category);
    product.setProductCategories(Arrays.asList(productCategory));
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setSalePrice(DEFAULT_SALE_PRICE);
    productItemBusinessPartner.setPrice(DEFAULT_PRICE);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(DEFAULT_DELTA_STOCK);
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productCollection.setPostLive(true);
    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(new PageImpl<>(new ArrayList<>(), PAGEABLE, 0));
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(productBusinessPartner);
    Mockito.when(
        this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
          any(), any(), any(Pageable.class)))
      .thenReturn(new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    Mockito.when(this.productRepository.findOne(any())).thenReturn(product);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    Mockito.when(productItemWholesalePriceRepository.findByStoreIdAndItemSkuIn(any(), anyList()))
      .thenReturn(Arrays.asList(productItemWholesalePrice));
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(categoriesData);
    Mockito.when(productServiceWrapper.getVendorNotes(any(), any())).thenReturn(
      VendorNotesResponse.builder().contentAdditionalNotes("content").imagesAdditionalNotes("image")
        .allVariants(true).build());
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);
    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productItemBusinessPartnerRepository)
      .findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(any(),
        any(), any(Pageable.class));
    Mockito.verify(this.productRepository).findOne(any());
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(any(), any());
    Mockito.verify(productItemWholesalePriceRepository).findByStoreIdAndItemSkuIn(any(), anyList());
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(Mockito.any());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    Mockito.verify(productServiceWrapper).getVendorNotes(any(), any());
    Assertions.assertFalse(CollectionUtils.isEmpty(result.getContent()));
  }


  @Test
  public void findSummaryDetailsByFilterIsNeedCorrectionAndEmptyResponseFromXproductWithImagesTest()
    throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    productLevel3SummaryFilterDetails.setNeedCorrection(true);
    Product product = generateProduct();
    ProductCategory productCategory = new ProductCategory();
    productCategory.setCategory(null);
    product.setProductCategories(Arrays.asList(productCategory));
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setSalePrice(DEFAULT_SALE_PRICE);
    productItemBusinessPartner.setPrice(DEFAULT_PRICE);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(DEFAULT_DELTA_STOCK);
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    List<ProductItemImage> imageList = new ArrayList<>();
    ProductItemImage image = new ProductItemImage();
    image.setLocationPath("location-path");
    image.setMarkForDelete(false);
    image.setEdited(false);
    image.setRevised(true);
    image.setSequence(1);
    image.setMainImages(true);
    imageList.add(image);
    ProductItemImage image1 = new ProductItemImage();
    image1.setLocationPath("location-path1");
    image1.setMarkForDelete(true);
    image1.setEdited(false);
    image1.setRevised(true);
    image1.setSequence(1);
    image1.setMainImages(true);
    imageList.add(image1);
    ProductItemImage image2 = new ProductItemImage();
    image2.setLocationPath("location-path2");
    image2.setMarkForDelete(false);
    image2.setEdited(false);
    image2.setRevised(false);
    image2.setActive(true);
    image2.setSequence(1);
    image2.setMainImages(true);
    imageList.add(image2);
    ProductItemImage image3 = new ProductItemImage();
    image3.setLocationPath("location-path3");
    image3.setMarkForDelete(false);
    image3.setEdited(false);
    image3.setRevised(true);
    image3.setActive(false);
    image3.setSequence(0);
    image3.setMainImages(true);
    imageList.add(image3);
    ProductItemImage image4 = new ProductItemImage();
    image4.setLocationPath("location-path4");
    image4.setMarkForDelete(false);
    image4.setEdited(false);
    image4.setRevised(false);
    image4.setActive(false);
    image4.setSequence(0);
    image4.setMainImages(true);
    image4.setOriginalImage(true);
    imageList.add(image4);
    ProductItemImage image_edited = new ProductItemImage();
    image_edited.setLocationPath("location-path5");
    image_edited.setMarkForDelete(false);
    image_edited.setEdited(true);
    image_edited.setRevised(false);
    image_edited.setActive(true);
    image_edited.setSequence(5);
    image_edited.setMainImages(true);
    imageList.add(image_edited);
    ProductItemImage imageRevised = new ProductItemImage();
    imageRevised.setLocationPath("location-path6");
    imageRevised.setMarkForDelete(false);
    imageRevised.setEdited(false);
    imageRevised.setRevised(true);
    imageRevised.setActive(true);
    imageRevised.setSequence(6);
    imageRevised.setMainImages(true);
    imageList.add(imageRevised);
    ProductItemImage imageInActive = new ProductItemImage();
    imageInActive.setLocationPath("location-path7");
    imageInActive.setMarkForDelete(false);
    imageInActive.setEdited(false);
    imageInActive.setRevised(false);
    imageInActive.setActive(false);
    imageInActive.setSequence(7);
    imageInActive.setMainImages(false);
    imageInActive.setOriginalImage(false);
    imageList.add(imageInActive);
    product.getProductItems().get(0).setProductItemImages(imageList);
    productCollection.setPostLive(true);
    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(new PageImpl<>(new ArrayList<>(), PAGEABLE, 0));
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(productBusinessPartner);
    Mockito.when(
        this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
          any(), any(), any(Pageable.class)))
      .thenReturn(new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    Mockito.when(this.productRepository.findOne(any())).thenReturn(product);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(productCollection);
    Mockito.when(productItemWholesalePriceRepository.findByStoreIdAndItemSkuIn(any(), anyList()))
      .thenReturn(Arrays.asList(productItemWholesalePrice));
    Mockito.when(productServiceWrapper.getVendorNotes(any(), any())).thenReturn(
      VendorNotesResponse.builder().contentAdditionalNotes("content").imagesAdditionalNotes("image")
        .allVariants(true).build());
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);
    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productItemBusinessPartnerRepository)
      .findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(any(),
        any(), any(Pageable.class));
    Mockito.verify(this.productRepository).findOne(any());
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(any(), any());
    Mockito.verify(productItemWholesalePriceRepository).findByStoreIdAndItemSkuIn(any(), anyList());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    Mockito.verify(productServiceWrapper).getVendorNotes(any(), any());
    Assertions.assertFalse(CollectionUtils.isEmpty(result.getContent()));
  }

  @Test
  public void findSummaryDetailsByFilterMasterDataImagesTest() throws Exception {
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(ITEM_CODE);
    productItemResponse.setUpcCode(DEFAULT_UPC_CODE);
    List<Image> imageList = new ArrayList<>();
    Image image = new Image();
    image.setLocationPath("location-path");
    image.setMarkForDelete(false);
    image.setEdited(true);
    image.setSequence(1);
    image.setMainImages(true);
    imageList.add(image);
    Image image1 = new Image();
    image1.setLocationPath("location-path1");
    image1.setMarkForDelete(true);
    image1.setEdited(true);
    image1.setSequence(1);
    image1.setMainImages(true);
    imageList.add(image1);
    Image image2 = new Image();
    image2.setLocationPath("location-path2");
    image2.setMarkForDelete(false);
    image2.setEdited(false);
    image2.setActive(true);
    image2.setSequence(1);
    image2.setMainImages(true);
    imageList.add(image2);
    Image image3 = new Image();
    image3.setLocationPath("location-path3");
    image3.setMarkForDelete(false);
    image3.setEdited(true);
    image2.setActive(false);
    image3.setSequence(0);
    image3.setMainImages(true);
    imageList.add(image3);
    Image image4 = new Image();
    image4.setLocationPath("location-path4");
    image4.setMarkForDelete(false);
    image4.setEdited(false);
    image2.setActive(false);
    image4.setSequence(0);
    image4.setMainImages(true);
    image4.setOriginalImage(true);
    imageList.add(image4);
    productItemResponse.setImages(imageList);
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(any(SkuCodesRequest.class))).thenReturn(
      productItemResponseList);
    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(sapOutbound.getCogsValueResponse(any())).thenThrow(new RuntimeException());
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);

    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(result.getContent().get(0).getProductSku(), DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
    Assertions.assertEquals(DEFAULT_BUSINESS_PARTNER_CODE,
      result.getContent().get(0).getMerchantCode());
    Assertions.assertEquals(DEFAULT_CATEGORY_CODE, result.getContent().get(0).getCategoryCode());
    Assertions.assertEquals("ERR-00000", result.getContent().get(0).getCogsErrorCode());
    Assertions.assertEquals(1, result.getContent().get(0).getImages().size());
  }

  @Test
  public void findSummaryDetailsByFilterEmptyImagesPriceAndItemViewableTest() throws Exception {
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());

    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    Mockito.when(sapOutbound.getCogsValueResponse(any())).thenThrow(new RuntimeException());
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);

    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, result.getContent().get(0).getProductSku());
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
    Assertions.assertEquals(DEFAULT_BUSINESS_PARTNER_CODE,
      result.getContent().get(0).getMerchantCode());
    Assertions.assertEquals(DEFAULT_CATEGORY_CODE, result.getContent().get(0).getCategoryCode());
    Assertions.assertEquals("ERR-00000", result.getContent().get(0).getCogsErrorCode());
  }

  @Test
  public void findSummaryDetailsByFilterWithCogsValuesTest() throws Exception {
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());
    ProductWarehouse cogs = new ProductWarehouse(new Cogs(0, "test", 100000.0, "success"));
    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    Mockito.when(
        businessPartnerRepository.filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE))
      .thenReturn(getProfileResponse());
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);

    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, result.getContent().get(0).getProductSku());
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
    Assertions.assertEquals(DEFAULT_BUSINESS_PARTNER_CODE,
      result.getContent().get(0).getMerchantCode());
    Assertions.assertEquals(DEFAULT_CATEGORY_CODE, result.getContent().get(0).getCategoryCode());
    Assertions.assertEquals(100000.0, result.getContent().get(0).getCogs(), 0);
  }

  @Test
  public void findSummaryDetailsByFilterMasterCatalogNullTest() throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .salesCatalogs(new ArrayList<>()).price(new HashSet<>()).itemViewConfigs(new HashSet<>())
        .productType(ProductType.REGULAR).pickupPointCode(DEFAULT_PICKUP_POINT_CODE)
        .masterDataItemImages(new ArrayList<>()).isLateFulfillment(false)
        .merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());
    wholesalePriceSkuResponse.setSkuStatus(null);
    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    Mockito.when(productPricingOutbound.getWholesalePrice(eq(ITEM_SKU), Mockito.any()))
      .thenReturn(wholesalePriceSkuResponse);
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);

    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, result.getContent().get(0).getProductSku());
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
  }

  @Test
  public void findSummaryDetailsByFilterWholeSalePromoActiveTest() throws Exception {
    wholesalePriceSkuResponse.setPromoActive(Boolean.TRUE);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    item.setWholesalePriceExists(true);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());

    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    Mockito.when(
      productPricingOutbound.getWholesalePriceList(eq(new HashSet<>(Arrays.asList(ITEM_SKU))),
        Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
      new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "true",
        "campaignPriceValidation", false));
    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);
    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(campaignOutbound).getCampaignPriceInfoV2(Mockito.any());
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, result.getContent().get(0).getProductSku());
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
    Assertions.assertTrue(result.getContent().get(0).isWholesalePromoActivated());
  }

  @Test
  public void findSummaryDetailsByFilterPromoFlagsTest() throws Exception {
    wholesalePriceSkuResponse.setPromoActive(Boolean.TRUE);
    wholesalePriceSkuResponse.setWholesaleRules(new HashMap<>());
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE)
        .merchantPromoDiscount(true).merchantPromoDiscountActivated(true)
        .promoTypes(Arrays.asList("PROMO_BUNDLING")).promoBundling(true).flashSaleActive(true)
        .build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    item.setWholesalePriceExists(true);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());

    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    Mockito.when(
      productPricingOutbound.getWholesalePriceList(eq(new HashSet<>(Arrays.asList(ITEM_SKU))),
        Mockito.anyMap())).thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
      new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "true",
        "campaignPriceValidation", false));

    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);

    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(campaignOutbound).getCampaignPriceInfoV2(Mockito.any());
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, result.getContent().get(0).getProductSku());
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertTrue(result.getContent().get(0).isPriceEditDisabled());
    Assertions.assertFalse(result.getContent().get(0).isWholesalePromoActivated());
    Assertions.assertTrue(result.getContent().get(0).isMerchantPromoDiscount());
    Assertions.assertTrue(result.getContent().get(0).isMerchantPromoDiscountActivated());
    Assertions.assertTrue(result.getContent().get(0).isFlashSaleActive());
    Assertions.assertTrue(result.getContent().get(0).isPromoBundling());
    Assertions.assertEquals(result.getContent().get(0).getPromoTypes().get(0), "PROMO_BUNDLING");
  }

  @Test
  public void findSummaryDetailsByFilterCampaignPriceInfoTest() throws Exception {
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());
    CampaignPriceRequest campaignPriceRequest = new CampaignPriceRequest();
    campaignPriceRequest.setCampaignPriceSkuRequestList(Arrays.asList(
      CampaignPriceSkuRequest.builder().itemSku(ITEM_SKU).categoryCode(DEFAULT_CATEGORY_CODE)
        .build()));
    CampaignPriceResponse campaignPriceResponse = new CampaignPriceResponse();
    Map<String, CampaignPriceSkuResponse> itemSkuToPriceResponseMap = new HashMap<>();
    CampaignPriceSkuResponse campaignPriceSkuResponse =
      CampaignPriceSkuResponse.builder().campaignPrice(10001.0).maxAllowedPrice(10001.0)
        .minAllowedPrice(2000.0).live(true).registered(true).lockPriceUpdate(true).build();
    itemSkuToPriceResponseMap.put(ITEM_SKU, campaignPriceSkuResponse);
    campaignPriceResponse.setItemSkuToPriceResponse(itemSkuToPriceResponseMap);

    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    Mockito.when(modelConverter.convertItemSkusToCampaignPriceRequest(eq(Arrays.asList(ITEM_SKU)),
        eq(DEFAULT_CATEGORY_CODE), eq(itemSkuAndPickupCodeMap), any()))
      .thenReturn(campaignPriceRequest);
    Mockito.when(campaignOutbound.getCampaignPriceInfoV2(campaignPriceRequest))
      .thenReturn(campaignPriceResponse);
    Mockito.when(modelConverter.convertCampaignPriceResponseListToCampaignPriceSkuResponseMap(
      Arrays.asList(campaignPriceResponse))).thenReturn(itemSkuToPriceResponseMap);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
      new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "true",
        "campaignPriceValidation", false));

    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);

    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(campaignOutbound).getCampaignPriceInfoV2(campaignPriceRequest);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, result.getContent().get(0).getProductSku());
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertTrue(result.getContent().get(0).isPriceEditDisabled());
    Assertions.assertEquals(10001.0, result.getContent().get(0).getCampaignCurrentPrice(), 0);
    Assertions.assertEquals(10001.0, result.getContent().get(0).getCampaignMaxPrice(), 0);
    Assertions.assertEquals(2000.0, result.getContent().get(0).getCampaignMinPrice(), 0);
    Assertions.assertTrue(result.getContent().get(0).isItemCampaignMapped());
    Assertions.assertTrue(result.getContent().get(0).isItemCampaignActivated());
  }

  @Test
  public void findSummaryDetailsByFilterCampaignValidationSwitchOffTest() throws Exception {
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails =
      new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME)
        .masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>())
        .isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories =
      generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
      pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku)
        .collect(Collectors.toList());

    Mockito.when(modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails)).thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE))
      .thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
        "sapCallEnabled", false));
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
      .thenReturn(mapOfProductInventories);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
      new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "false",
        "campaignPriceValidation", false));

    Page<ProductLevel3SummaryDetails> result =
      productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID,
        productLevel3SummaryFilterDetails, PAGEABLE);

    Mockito.verify(modelConverter).convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(
      productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(),
        listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(getCategoryRepository())
      .findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(businessPartnerRepository)
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, result.getContent().get(0).getProductSku());
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
  }

  private ProductLevel3Inventory generateInventory(ItemSummaryDetailResponse item) {
    ProductLevel3Inventory inventory = new ProductLevel3Inventory();
    inventory.setWebItemSku(item.getItemSku());
    inventory.setNonDistributionReserved(10);
    inventory.setNonDistributionAvailable(20);
    return inventory;
  }

  private Map<String, ProductLevel3Inventory> generateMapOfProductInventories(
    List<ItemSummaryDetailResponse> items, List<ProductLevel3Inventory> inventories) {
    Map<String, ProductLevel3Inventory> map = new HashMap<>();
    items.forEach(item -> {
      inventories.forEach(inventory -> {
        if (inventory.getWebItemSku().equals(item.getItemSku())) {
          map.put(item.getItemSku(), inventory);
        }
      });
    });
    return map;
  }

  @Test
  public void getPickupPointCodes_mppFalseTest() throws Exception {
    ItemPickupPointCodeResponse itemPickupPointCodeResponse =
      new ItemPickupPointCodeResponse(DEFAULT_ITEM_SKU, DEFAULT_ITEM_NAME, PICKUP,
        PICKUP_POINT_NAME);
    CompanyDTO company = CompanyDTO.builder().merchantType("CM").cncActivated(false).build();
    ProfileResponse profileResponse =
      ProfileResponse.builder().company(company).multiDefaultAddressFlag(false).build();
    when(
      xProductOutbound.getItemPickupPointCodeResponse(DEFAULT_PRODUCT_SKU, 0, 1, false)).thenReturn(
      new PageImpl<>(Arrays.asList(itemPickupPointCodeResponse)));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(profileResponse);
    Page<PickupPointCodeResponse> response =
      productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, false, STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, false);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getItemPickupPointCodeResponse(DEFAULT_PRODUCT_SKU, 0, 1, false);
    Assertions.assertEquals(1, response.getContent().size());
    Assertions.assertEquals(DEFAULT_ITEM_SKU, response.getContent().get(0).getItemSku());
    Assertions.assertEquals(PICKUP_POINT_NAME, response.getContent().get(0).getPickupPointName());
  }

  @Test
  public void getPickupPointCodesNoItemsTest() throws Exception {
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      ProfileResponse.builder().company(CompanyDTO.builder().cncActivated(false).build())
        .multiDefaultAddressFlag(false).build());
    when(
      xProductOutbound.getItemPickupPointCodeResponse(DEFAULT_PRODUCT_SKU, 0, 1, false)).thenReturn(
      new PageImpl<>(new ArrayList<>()));
    Page<PickupPointCodeResponse> response =
      productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, false, STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, false);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.any());
    verify(xProductOutbound).getItemPickupPointCodeResponse(DEFAULT_PRODUCT_SKU, 0, 1, false);
    Assertions.assertEquals(0, response.getContent().size());
  }

  @Test
  public void getPickupPointCodesNeedCorrectionProductTest() throws Exception {
    Product product = generateProduct();
    CompanyDTO company = CompanyDTO.builder().merchantType(null).cncActivated(false).build();
    ProfileResponse profileResponse =
      ProfileResponse.builder().company(company).multiDefaultAddressFlag(false).build();
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setPickupPointId(PICKUP);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(
      this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
        any(), any(), any(Pageable.class))).thenReturn(
      new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    when(productRepository.findOne(Mockito.any())).thenReturn(product);
    when(xProductOutbound.getPickupPointDetailResponse(Collections.singletonList(PICKUP),
      false)).thenReturn(Collections.singletonList(
      PickupPointDetailResponse.builder().pickupPointCode(PICKUP).pickupPointName(NAME).build()));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(profileResponse);
    Page<PickupPointCodeResponse> response =
      productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, false);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
      any(), any(), any(Pageable.class));
    verify(productRepository).findOne(Mockito.any());
    verify(xProductOutbound).getPickupPointDetailResponse(Collections.singletonList(PICKUP), false);
    Assertions.assertEquals(1, response.getContent().size());
    Assertions.assertEquals(ITEM_SKU, response.getContent().get(0).getItemSku());
    Assertions.assertEquals(NAME, response.getContent().get(0).getPickupPointName());
  }

  @Test
  public void getPickupPointCodesNeedCorrectionWithoutPPTest() throws Exception {
    Product product = generateProduct();
    CompanyDTO company = CompanyDTO.builder().merchantType(null).cncActivated(false).build();
    ProfileResponse profileResponse =
      ProfileResponse.builder().company(company).multiDefaultAddressFlag(false).build();
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setPickupPointId(PICKUP);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(
      this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
        any(), any(), any(Pageable.class))).thenReturn(
      new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    when(productRepository.findOne(Mockito.any())).thenReturn(product);
    when(xProductOutbound.getPickupPointDetailResponse(Collections.singletonList(PICKUP),
      false)).thenReturn(Collections.emptyList());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(profileResponse);
    Page<PickupPointCodeResponse> response =
      productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, false);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
      any(), any(), any(Pageable.class));
    verify(productRepository).findOne(Mockito.any());
    verify(xProductOutbound).getPickupPointDetailResponse(Collections.singletonList(PICKUP), false);
    Assertions.assertEquals(1, response.getContent().size());
    Assertions.assertEquals(ITEM_SKU, response.getContent().get(0).getItemSku());
    Assertions.assertEquals(null, response.getContent().get(0).getPickupPointName());
  }

  @Test
  public void getPickupPointCodesNeedCorrectionNoProductTest() throws Exception {
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      ProfileResponse.builder().company(CompanyDTO.builder().cncActivated(false).build())
        .multiDefaultAddressFlag(false).build());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      null);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        Page<PickupPointCodeResponse> response =
            productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
                DEFAULT_BUSINESS_PARTNER_CODE, false);
      });
    } finally {
      verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.any());
      verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    }
  }

  @Test
  public void getPickupPointCodesNeedCorrectionNoProductItemTest() throws Exception {
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      ProfileResponse.builder().company(CompanyDTO.builder().cncActivated(false).build())
        .multiDefaultAddressFlag(false).build());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(
      this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
        any(), any(), any(Pageable.class))).thenReturn(null);
    Page<PickupPointCodeResponse> response =
      productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, false);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.any());
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
      any(), any(), any(Pageable.class));
    Assertions.assertEquals(0, response.getContent().size());
  }

  @Test
  public void getPickupPointCodes_mppTrueTest() throws Exception {
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      ProfileResponse.builder()
        .company(CompanyDTO.builder().cncActivated(true).merchantType(null).build())
        .multiDefaultAddressFlag(false).build());
    try {
      Assertions.assertThrows(ApplicationException.class, () -> {
        Page<PickupPointCodeResponse> response =
            productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
                DEFAULT_BUSINESS_PARTNER_CODE, false);
      });
    } finally {
      verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.any());
    }
  }

  @Test
  public void getPickupPointCodes_mppTrueCNCFalseTest() throws Exception {
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      ProfileResponse.builder()
        .company(CompanyDTO.builder().cncActivated(false).merchantType("CM").build())
        .multiDefaultAddressFlag(true).build());
    try {
      Assertions.assertThrows(ApplicationException.class, () -> {
        productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
            DEFAULT_BUSINESS_PARTNER_CODE, false);
      });
    } finally {
      verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.any());
    }
  }

  @Test()
  public void getPickupPointCodesMerchantTypeCM_mppTrueTest() throws Exception {
    Exception exception = new Exception();
    Product product = generateProduct();
    CompanyDTO company = CompanyDTO.builder().merchantType("CM").cncActivated(true).build();
    ProfileResponse profileResponse =
      ProfileResponse.builder().company(company).multiDefaultAddressFlag(false).build();
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      profileResponse);
    try {
      productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, false);
    } catch (Exception e) {
      exception = e;
    } finally {
      verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.any());
      Assertions.assertEquals(ApplicationException.class, exception.getClass());
    }
  }

  @Test
  public void getPickupPointCodes_mppTrueMerchantTypeNullTest() throws Exception {
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      ProfileResponse.builder()
        .company(CompanyDTO.builder().cncActivated(true).merchantType(null).build())
        .multiDefaultAddressFlag(true).build());
    try {
      Assertions.assertThrows(ApplicationException.class, () -> {
        Page<PickupPointCodeResponse> response =
            productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
                DEFAULT_BUSINESS_PARTNER_CODE, false);
      });
    } finally {
      verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.any());
    }
  }

  @Test
  public void getUniquePickupPointCodesTest() throws Exception {
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(
      DEFAULT_PRODUCT_SKU)).thenReturn(Arrays.asList(DEFAULT_ITEM_SKU));
    UniquePickupPointCodeResponse response =
      productLevel3ServiceBean.getUniquePickupPointCodes(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).getPickupPointCodesByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(1, response.getItemSkus().size());
    Assertions.assertEquals(1, response.getPickupPointCodes().size());
  }

  @Test
  public void publishEditImagesForResizingTest() throws Exception {
    when(productPublisherService.publishEditImageResizeEvent(
      imageResizeEventArgumentCaptor.capture())).thenReturn(new EditedImageResizeEvent());
    List<LocationPathAndCommonImage> commonImagePathDtos =
      productPriceStockAndImagesRequest.getImages().stream().map(
          productLevel3SummaryDetailsImageRequest -> new LocationPathAndCommonImage(
            productLevel3SummaryDetailsImageRequest.getLocationPath(), true))
        .collect(Collectors.toList());
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    EditedResizeImagesResponse response = productLevel3ServiceBean.publishEditImagesForResizing(
      productPriceStockAndImagesRequest.getImages(), commonImagePathDtos, PRODUCT_CODE);
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
  }

  @Test
  public void publishEditImagesForResizingWithWrongReviewTypeTest() throws Exception {
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(DEFAULT_ATTRIBUTE_TYPE);
    List<LocationPathAndCommonImage> commonImagePathDtos =
      productPriceStockAndImagesRequest.getImages().stream().map(
          productLevel3SummaryDetailsImageRequest -> new LocationPathAndCommonImage(
            productLevel3SummaryDetailsImageRequest.getLocationPath(), true))
        .collect(Collectors.toList());
    EditedResizeImagesResponse response = productLevel3ServiceBean.publishEditImagesForResizing(
      productPriceStockAndImagesRequest.getImages(), commonImagePathDtos, PRODUCT_CODE);
    Assertions.assertTrue(response.getProductLevel3SummaryDetailsImageRequestStringMap().isEmpty());
  }

  @Test
  public void publishEditImagesForResizingNoNewImageTest() throws Exception {
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType("update");
    List<LocationPathAndCommonImage> commonImagePathDtos =
      productPriceStockAndImagesRequest.getImages().stream().map(
          productLevel3SummaryDetailsImageRequest -> new LocationPathAndCommonImage(
            productLevel3SummaryDetailsImageRequest.getLocationPath(), true))
        .collect(Collectors.toList());
    EditedResizeImagesResponse response = productLevel3ServiceBean.publishEditImagesForResizing(
      productPriceStockAndImagesRequest.getImages(), commonImagePathDtos,
      productPriceStockAndImagesRequest.getProductCode());
    Assertions.assertTrue(
      MapUtils.isEmpty(response.getProductLevel3SummaryDetailsImageRequestStringMap()));
  }

  @Test
  public void updateItemsPriceStockImagesTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(productCollectionRepository.findByStoreIdAndProductCode(eq(STORE_ID),
      Mockito.any())).thenReturn(productCollection);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productCollectionRepository).findByStoreIdAndProductCode(eq(STORE_ID), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }


  @Test
  public void updateItemsPriceStockImagesImageRefreshTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(PRODUCT_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(UPDATE);
    productPriceStockAndImagesRequest.setProductCode(PRODUCT_CODE);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(PRODUCT_CODE));
    productCollection.setReviewPending(true);
    productCollection.setReviewType("IMAGE");
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(
      productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
      productCollection);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
      .thenReturn(sellerDetailResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
      .thenReturn(new ProductBusinessPartner());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .createProductL3AuditLog(any(), any(), any(), any(), any(), any(), any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.verify(kafkaProducer)
      .send(eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
        addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Assertions.assertEquals("IMAGE_REFRESH",
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .getReviewTypes());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
  }

  @Test
  public void updateItemsPriceStockImagesImageRefreshExceptionTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(PRODUCT_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(UPDATE);
    productPriceStockAndImagesRequest.setProductCode(PRODUCT_CODE);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(PRODUCT_CODE));
    productCollection.setReviewPending(true);
    productCollection.setReviewType("IMAGE");
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    Mockito.when(getProductLevel3Repository().updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any())).thenThrow(Exception.class);
    when(
      productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
      productCollection);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    try {
      productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
        productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
        new ProductL3Response());
    } catch (Exception e) {
    } finally {
      Mockito.verify(productLevel3Repository)
        .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
          Mockito.any(SortOrder.class));
      verify(variantEditValidationService).validateListOfVariantsWithSuccess(
        productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
      verify(
        productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
      Mockito.verify(productPricingOutbound)
        .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
      Mockito.verify(productLevel3Repository)
        .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
      verify(variantEditValidationService).validatePriceLockCampaignRequest(
        productPriceStockAndImagesRequests.get(0), failedRequests);
      Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    }
  }

  @Test
  public void updateItemsPriceStockImagesImageRefreshExceptionNoPriceValidationTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(PRODUCT_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(UPDATE);
    productPriceStockAndImagesRequest.setProductCode(PRODUCT_CODE);
    productPriceStockAndImagesRequest.getPrices().get(0).setSalePrice(10000.0);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(PRODUCT_CODE));
    productCollection.setReviewPending(true);
    productCollection.setReviewType("IMAGE");
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    Mockito.when(getProductLevel3Repository().updateSummary(Mockito.any(), Mockito.any(),
      (UpdateItemSummaryRequest) Mockito.any())).thenThrow(Exception.class);
    when(
      productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
      productCollection);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    try {
      productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
        productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
        new ProductL3Response());
    } catch (Exception e) {
    } finally {
      Mockito.verify(productLevel3Repository)
        .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
          Mockito.any(SortOrder.class));
      verify(variantEditValidationService).validateListOfVariantsWithSuccess(
        productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
      verify(
        productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
      Mockito.verify(productPricingOutbound)
        .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
      Mockito.verify(productLevel3Repository)
        .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
      Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    }
  }

  @Test
  public void updateItemsPriceStockImagesPBPNullResponseTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(null);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(productCollectionRepository.findByStoreIdAndProductCode(eq(STORE_ID),
      Mockito.any())).thenReturn(productCollection);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productCollectionRepository).findByStoreIdAndProductCode(eq(STORE_ID), Mockito.any());
  }

  @Test
  public void updateItemsPriceStockImages_priceLockExceptionTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    Mockito.doThrow(ApplicationRuntimeException.class).when(variantEditValidationService)
      .validatePriceLockCampaignRequest(productPriceStockAndImagesRequests.get(0), failedRequests);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(productCollectionRepository.findByStoreIdAndProductCode(eq(STORE_ID),
      Mockito.any())).thenReturn(productCollection);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productCollectionRepository).findByStoreIdAndProductCode(eq(STORE_ID), Mockito.any());
  }

  @Test
  public void updateItemsPriceStockImagesProductItemBusinessPartnerEmptyTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(productCollectionRepository.findByStoreIdAndProductCode(eq(STORE_ID),
      Mockito.any())).thenReturn(productCollection);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productCollectionRepository).findByStoreIdAndProductCode(eq(STORE_ID), Mockito.any());
  }

  @Test
  public void updateItemsPriceStockImagesSuccessValidationVariantListIsEmptyTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      new ArrayList<>());
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    when(productCollectionRepository.findByStoreIdAndProductCode(eq(STORE_ID),
      Mockito.any())).thenReturn(productCollection);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productCollectionRepository).findByStoreIdAndProductCode(eq(STORE_ID), Mockito.any());
  }

  @Test
  public void updateItemsPriceStockImagesWholeSalePriceValidationTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(true);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(
      Arrays.asList(productItemWholesalePriceRequest));
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    WholesalePriceBulkUpdateResponse wholesalePriceBulkUpdateResponse =
      new WholesalePriceBulkUpdateResponse();
    Map<String, String> wholesalePriceSkuStatusMap = new HashMap<>();
    wholesalePriceSkuStatusMap.put(DEFAULT_ITEM_SKU, INACTIVE);
    Map<String, String> failedItemSkuToFailedReasonMap = new HashMap<>();
    failedItemSkuToFailedReasonMap.put(DEFAULT_ITEM_SKU, "update failed");
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatus(
      Arrays.asList(new WholeSalePriceSkuStatusDto(DEFAULT_ITEM_SKU, null, INACTIVE)));
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatusMap(wholesalePriceSkuStatusMap);
    wholesalePriceBulkUpdateResponse.setFailedItemSkuToFailedReasonMap(
      failedItemSkuToFailedReasonMap);
    ProductItemWholesalePrice productItemWholesalePriceValues = new ProductItemWholesalePrice();
    productItemWholesalePriceValues.setItemSku(DEFAULT_ITEM_SKU);
    productItemWholesalePriceValues.setWholesalePriceActivated(true);
    productItemWholesalePriceValues.setWholesaleRules(WHOLESALE_RULE_1);
    wholesalePriceSkuResponse.setItemSku(DEFAULT_ITEM_SKU);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(productPricingOutbound.bulkUpdateWholesalePrice(
        Mockito.anyList(), Mockito.any()))
      .thenReturn(wholesalePriceBulkUpdateResponse);
    Mockito.when(productPricingOutbound.bulkActivateOrDeactivateSku(
        Mockito.anyList()))
      .thenReturn(new BulkActivateDeactivateResponse());
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(this.productPricingOutbound.getWholesalePriceList(anySet(), Mockito.anyMap())).thenReturn(
      Arrays.asList(wholesalePriceSkuResponse));
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(Mockito.anyList(),
      Mockito.anyList(), anyMap());
    verify(variantEditValidationService).isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productPricingOutbound)
      .bulkUpdateWholesalePrice(Mockito.anyList(), any());
    Mockito.verify(productPricingOutbound)
      .bulkActivateOrDeactivateSku(Mockito.anyList());
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(updatedProductHistoryService, times(2))
      .createProductL3AuditLog(any(), any(), any(), any(), any(), any(), any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      eq(productPriceStockAndImagesRequests.get(0)), anyList());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesWholeSalePriceValidationWsResponseTrueAndUpdateFalseTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(true);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(
      Arrays.asList(productItemWholesalePriceRequest));
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    WholesalePriceBulkUpdateResponse wholesalePriceBulkUpdateResponse =
      new WholesalePriceBulkUpdateResponse();
    Map<String, String> wholesalePriceSkuStatusMap = new HashMap<>();
    wholesalePriceSkuStatusMap.put(DEFAULT_ITEM_SKU, ACTIVE);
    Map<String, String> failedItemSkuToFailedReasonMap = new HashMap<>();
    failedItemSkuToFailedReasonMap.put(DEFAULT_ITEM_SKU, "update failed");
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatusMap(wholesalePriceSkuStatusMap);
    wholesalePriceBulkUpdateResponse.setFailedItemSkuToFailedReasonMap(
      failedItemSkuToFailedReasonMap);
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatus(
      Arrays.asList(new WholeSalePriceSkuStatusDto(DEFAULT_ITEM_SKU, null, ACTIVE)));
    ProductItemWholesalePrice productItemWholesalePriceValues = new ProductItemWholesalePrice();
    productItemWholesalePriceValues.setItemSku(DEFAULT_ITEM_SKU);
    productItemWholesalePriceValues.setWholesalePriceActivated(true);
    productItemWholesalePriceValues.setWholesaleRules(WHOLESALE_RULE_1);
    wholesalePriceSkuResponse.setItemSku(DEFAULT_ITEM_SKU);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(productPricingOutbound.bulkUpdateWholesalePrice(
        Mockito.anyList(), Mockito.any()))
      .thenReturn(wholesalePriceBulkUpdateResponse);
    Mockito.when(productPricingOutbound.bulkActivateOrDeactivateSku(
        Mockito.anyList()))
      .thenReturn(new BulkActivateDeactivateResponse());
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(this.productPricingOutbound.getWholesalePriceList(anySet(), Mockito.anyMap())).thenReturn(
      Arrays.asList(wholesalePriceSkuResponse));
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(Mockito.anyList(),
      Mockito.anyList(), anyMap());
    verify(variantEditValidationService).isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productPricingOutbound)
      .bulkUpdateWholesalePrice(Mockito.anyList(), any());
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(updatedProductHistoryService, times(2))
      .createProductL3AuditLog(any(), any(), any(), any(), any(), any(), any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      eq(productPriceStockAndImagesRequests.get(0)), anyList());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesWholeSalePriceActivationFalse_forTrustedSellerTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(false);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(
      Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    WholesalePriceBulkUpdateResponse wholesalePriceBulkUpdateResponse =
      new WholesalePriceBulkUpdateResponse();
    Map<String, String> wholesalePriceSkuStatusMap = new HashMap<>();
    wholesalePriceSkuStatusMap.put(DEFAULT_ITEM_SKU, ACTIVE);
    Map<String, String> failedItemSkuToFailedReasonMap = new HashMap<>();
    failedItemSkuToFailedReasonMap.put(DEFAULT_ITEM_SKU, "update failed");
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatusMap(wholesalePriceSkuStatusMap);
    wholesalePriceBulkUpdateResponse.setFailedItemSkuToFailedReasonMap(
      failedItemSkuToFailedReasonMap);
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatus(
      Arrays.asList(new WholeSalePriceSkuStatusDto(DEFAULT_ITEM_SKU, null, ACTIVE)));
    ProductItemWholesalePrice productItemWholesalePriceValues = new ProductItemWholesalePrice();
    productItemWholesalePriceValues.setItemSku(DEFAULT_ITEM_SKU);
    productItemWholesalePriceValues.setWholesalePriceActivated(true);
    productItemWholesalePriceValues.setWholesaleRules(WHOLESALE_RULE_1);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      profileResponse);
    profileResponse.setTrustedSeller(true);
    this.businessPartnerData.setTrustedSeller(true);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(productPricingOutbound.bulkUpdateWholesalePrice(
        Mockito.anyList(), Mockito.any()))
      .thenReturn(wholesalePriceBulkUpdateResponse);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.save(
      productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(
      new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, "INTERNAL", new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(Mockito.anyList(),
      Mockito.anyList(), anyMap());
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productPricingOutbound)
      .bulkUpdateWholesalePrice(Mockito.anyList(), any());
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      eq(productPriceStockAndImagesRequests.get(0)), anyList());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(any());
    verify(productLevel3Repository).findSummaryByFilter(any(), any(), any());
    verify(productPricingOutbound).getWholesalePrice(any(), any());
  }

  @Test
  public void updateItemsPriceStockImagesWholeSalePriceActivationFalseRequestNoWSConfig_forTrustedSellerTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(false);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(
      Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    wholesalePriceSkuResponse.setItemSku(DEFAULT_ITEM_SKU);
    WholesalePriceSkuResponse wholesalePriceSkuResponse1 = new WholesalePriceSkuResponse();
    wholesalePriceSkuResponse1.setItemSku(DEFAULT_ITEM_SKU);
    wholesalePriceSkuResponse1.setPromoActive(false);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    WholesalePriceBulkUpdateResponse wholesalePriceBulkUpdateResponse =
      new WholesalePriceBulkUpdateResponse();
    Map<String, String> wholesalePriceSkuStatusMap = new HashMap<>();
    wholesalePriceSkuStatusMap.put(DEFAULT_ITEM_SKU, ACTIVE);
    Map<String, String> failedItemSkuToFailedReasonMap = new HashMap<>();
    failedItemSkuToFailedReasonMap.put(DEFAULT_ITEM_SKU, "update failed");
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatusMap(wholesalePriceSkuStatusMap);
    wholesalePriceBulkUpdateResponse.setFailedItemSkuToFailedReasonMap(
      failedItemSkuToFailedReasonMap);
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatus(
      Arrays.asList(new WholeSalePriceSkuStatusDto(DEFAULT_ITEM_SKU, null, ACTIVE)));
    ProductItemWholesalePrice productItemWholesalePriceValues = new ProductItemWholesalePrice();
    productItemWholesalePriceValues.setItemSku(DEFAULT_ITEM_SKU);
    productItemWholesalePriceValues.setWholesalePriceActivated(false);
    productItemWholesalePriceValues.setWholesaleRules(WHOLESALE_RULE_1);
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      profileResponse);
    profileResponse.setTrustedSeller(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse1);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(productPricingOutbound.bulkUpdateWholesalePrice(
        Mockito.anyList(), Mockito.any()))
      .thenReturn(wholesalePriceBulkUpdateResponse);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productPricingOutbound.bulkActivateOrDeactivateSku(
        Mockito.anyList()))
      .thenReturn(new BulkActivateDeactivateResponse());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.save(
      productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(
      new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, "INTERNAL", new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(Mockito.anyList(),
      Mockito.anyList(), anyMap());
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productPricingOutbound)
      .bulkUpdateWholesalePrice(Mockito.anyList(), any());
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productPricingOutbound)
      .bulkActivateOrDeactivateSku(Mockito.anyList());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      eq(productPriceStockAndImagesRequests.get(0)), anyList());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(any());
    verify(productLevel3Repository).findSummaryByFilter(any(), any(), any());
    verify(productPricingOutbound).getWholesalePrice(any(), any());
  }

  @Test
  public void updateItemsPriceStockImagesWholeSalePriceActivationFalseRequest_forTrustedSellerTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(true);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(
      Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    wholesalePriceSkuResponse.setItemSku(DEFAULT_ITEM_SKU);
    WholesalePriceSkuResponse wholesalePriceSkuResponse1 = new WholesalePriceSkuResponse();
    wholesalePriceSkuResponse1.setItemSku(DEFAULT_ITEM_SKU);
    wholesalePriceSkuResponse1.setPromoActive(false);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    WholesalePriceBulkUpdateResponse wholesalePriceBulkUpdateResponse =
      new WholesalePriceBulkUpdateResponse();
    Map<String, String> wholesalePriceSkuStatusMap = new HashMap<>();
    wholesalePriceSkuStatusMap.put(DEFAULT_ITEM_SKU, ACTIVE);
    Map<String, String> failedItemSkuToFailedReasonMap = new HashMap<>();
    failedItemSkuToFailedReasonMap.put(DEFAULT_ITEM_SKU, "update failed");
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatus(
      Arrays.asList(new WholeSalePriceSkuStatusDto(DEFAULT_ITEM_SKU, null, ACTIVE)));
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatusMap(wholesalePriceSkuStatusMap);
    wholesalePriceBulkUpdateResponse.setFailedItemSkuToFailedReasonMap(
      failedItemSkuToFailedReasonMap);
    ProductItemWholesalePrice productItemWholesalePriceValues = new ProductItemWholesalePrice();
    productItemWholesalePriceValues.setItemSku(DEFAULT_ITEM_SKU);
    productItemWholesalePriceValues.setWholesalePriceActivated(true);
    productItemWholesalePriceValues.setWholesaleRules(WHOLESALE_RULE_1);
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      profileResponse);
    profileResponse.setTrustedSeller(true);
    when(variantEditValidationService.isSameThreshold(any(ProductPriceStockAndImagesRequest.class),
      any(), any(), any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(true);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse1);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(productPricingOutbound.bulkUpdateWholesalePrice(
        Mockito.anyList(), Mockito.any()))
      .thenReturn(wholesalePriceBulkUpdateResponse);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productPricingOutbound.bulkActivateOrDeactivateSku(
        Mockito.anyList()))
      .thenReturn(new BulkActivateDeactivateResponse());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productLevel3Repository.findSummaryByFilter(any(ItemSummaryRequest.class), any(),
      any())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.save(
      productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(
      new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, "INTERNAL", new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(Mockito.anyList(),
      Mockito.anyList(), anyMap());
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productPricingOutbound)
      .bulkUpdateWholesalePrice(Mockito.anyList(), any());
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      eq(productPriceStockAndImagesRequests.get(0)), anyList());
    verify(variantEditValidationService).isSameThreshold(any(), any(), any(), any(), any());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(any());
    verify(productLevel3Repository).findSummaryByFilter(any(), any(), any());
    verify(productPricingOutbound).getWholesalePrice(any(), any());
  }

  @Test
  public void updateItemImages_WhenVariantImageUpdateNotEligible_ShouldReturnOriginalImages() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "addDeleteVariantSwitch", true);

    ItemImageUpdateRequestPCB request = ItemImageUpdateRequestPCB.builder()
      .productCode(PRODUCT_CODE)
      .businessPartnerCode(BUSINESS_PARTNER_ID)
      .needCorrection(false)
      .updatedProductItemImageRequestList(Collections.emptyList())
      .newProductItemImageRequestList(Collections.emptyList())
      .locationPathAndCommonImages(Arrays.asList(new LocationPathAndCommonImage()))
      .productSku(PRODUCT_SKU)
      .build();

    Map<String, String> itemSkuItemNameMap = new HashMap<>();
    Map<String, String> skuCodeItemSkuMap = new HashMap<>();
    List<com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest> productImageEditRequestsForPCB = new ArrayList<>();
    List<LocationPathAndCommonImage> result = productLevel3ServiceBean.updateItemImages(
      request, itemSkuItemNameMap, skuCodeItemSkuMap, productImageEditRequestsForPCB);
    Mockito.verifyNoInteractions(productCollectionRepository, productOutbound);
  }

  @Test
  public void updateItemsPriceStockImagesWholeSalePriceActivationFalseEmptySKUStatusRequestTest_forTrustedSellers()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(false);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(
      Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    wholesalePriceSkuResponse.setItemSku(DEFAULT_ITEM_SKU);
    WholesalePriceSkuResponse wholesalePriceSkuResponse1 = new WholesalePriceSkuResponse();
    wholesalePriceSkuResponse1.setItemSku(DEFAULT_ITEM_SKU);
    wholesalePriceSkuResponse1.setPromoActive(false);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    WholesalePriceBulkUpdateResponse wholesalePriceBulkUpdateResponse =
      new WholesalePriceBulkUpdateResponse();
    Map<String, String> wholesalePriceSkuStatusMap = new HashMap<>();
    wholesalePriceSkuStatusMap.put(DEFAULT_ITEM_SKU, ACTIVE);
    Map<String, String> failedItemSkuToFailedReasonMap = new HashMap<>();
    failedItemSkuToFailedReasonMap.put(DEFAULT_ITEM_SKU, "update failed");
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatusMap(wholesalePriceSkuStatusMap);
    wholesalePriceBulkUpdateResponse.setFailedItemSkuToFailedReasonMap(
      failedItemSkuToFailedReasonMap);
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatus(
      Arrays.asList(new WholeSalePriceSkuStatusDto(DEFAULT_ITEM_SKU, null, ACTIVE)));
    ProductItemWholesalePrice productItemWholesalePriceValues = new ProductItemWholesalePrice();
    productItemWholesalePriceValues.setItemSku(DEFAULT_ITEM_SKU);
    productItemWholesalePriceValues.setWholesalePriceActivated(true);
    productItemWholesalePriceValues.setWholesaleRules(WHOLESALE_RULE_1);
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(
      profileResponse);
    profileResponse.setTrustedSeller(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse1);
    when(productPricingOutbound.getWholesalePriceList(anySet(), Mockito.anyMap())).thenReturn(
      Arrays.asList(wholesalePriceSkuResponse1));
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(productPricingOutbound.bulkUpdateWholesalePrice(
        Mockito.anyList(), Mockito.any()))
      .thenReturn(wholesalePriceBulkUpdateResponse);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productPricingOutbound.bulkActivateOrDeactivateSku(
        Mockito.anyList()))
      .thenReturn(new BulkActivateDeactivateResponse());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.save(
      productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(
      new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, "INTERNAL", new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(Mockito.anyList(),
      Mockito.anyList(), anyMap());
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productPricingOutbound)
      .bulkUpdateWholesalePrice(Mockito.anyList(), any());
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productPricingOutbound)
      .bulkActivateOrDeactivateSku(Mockito.anyList());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      eq(productPriceStockAndImagesRequests.get(0)), anyList());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(any());
    verify(productLevel3Repository).findSummaryByFilter(any(), any(), any());
    verify(productPricingOutbound).getWholesalePrice(any(), any());
  }


  @Test
  public void updateItemsPriceStockImagesWholeSalePriceValidationSuccessResponseTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(true);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(
      Arrays.asList(productItemWholesalePriceRequest));
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    WholesalePriceBulkUpdateResponse wholesalePriceBulkUpdateResponse =
      new WholesalePriceBulkUpdateResponse();
    Map<String, String> wholesalePriceSkuStatusMap = new HashMap<>();
    wholesalePriceSkuStatusMap.put(DEFAULT_ITEM_SKU, INACTIVE);
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatus(
      Arrays.asList(new WholeSalePriceSkuStatusDto(DEFAULT_ITEM_SKU, null, INACTIVE)));
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatusMap(wholesalePriceSkuStatusMap);
    ProductItemWholesalePrice productItemWholesalePriceValues = new ProductItemWholesalePrice();
    productItemWholesalePriceValues.setItemSku(DEFAULT_ITEM_SKU);
    productItemWholesalePriceValues.setWholesalePriceActivated(true);
    productItemWholesalePriceValues.setWholesaleRules(WHOLESALE_RULE_1);
    itemSummaryResponse.setItemSku(DEFAULT_ITEM_SKU);
    wholesalePriceSkuResponse.setItemSku(DEFAULT_ITEM_SKU);
    when(productLevel3Repository.findSummaryByGdnSku(any())).thenReturn(itemSummaryResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(productPricingOutbound.bulkUpdateWholesalePrice(
        Mockito.anyList(), Mockito.any()))
      .thenReturn(wholesalePriceBulkUpdateResponse);
    Mockito.when(productPricingOutbound.bulkActivateOrDeactivateSku(
        Mockito.anyList()))
      .thenReturn(new BulkActivateDeactivateResponse());
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(this.productPricingOutbound.getWholesalePriceList(anySet(), Mockito.anyMap())).thenReturn(
      Arrays.asList(wholesalePriceSkuResponse));
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(variantEditValidationService).isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productPricingOutbound)
      .bulkUpdateWholesalePrice(Mockito.anyList(), any());
    Mockito.verify(productPricingOutbound)
      .bulkActivateOrDeactivateSku(Mockito.anyList());
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(updatedProductHistoryService, times(2))
      .createProductL3AuditLog(any(), any(), any(), any(), any(), any(), any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    Mockito.verify(xProductOutbound)
      .generateProductScoreByProductSkuOrProductCode(Mockito.any(), Mockito.any(),
        Mockito.anyBoolean());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    //Mockito.verify(xProductOutbound).updateWholeSaleActivationFlag(Mockito.anyList(), Mockito.anyBoolean());
  }


  @Test
  public void updateItemsPriceStockImagesWholeSalePriceValidationFailedResponseTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(true);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(
      Arrays.asList(productItemWholesalePriceRequest));
    wholesalePriceSkuResponse.setSkuStatus(INACTIVE_STATUS);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    List<VariantsErrorListResponse> failedRequests1 = new ArrayList<>();
    VariantsErrorListResponse variantsErrorListResponse = new VariantsErrorListResponse();
    variantsErrorListResponse.setItemSku(DEFAULT_ITEM_SKU);
    variantsErrorListResponse.setMessage(ApiErrorCode.WHOLESALE_FLAG_UPDATE_FAILED.getDesc());
    variantsErrorListResponse.setCode(ApiErrorCode.WHOLESALE_FLAG_UPDATE_FAILED.getCode());
    variantsErrorListResponse.setItemName("itemName");
    failedRequests1.add(variantsErrorListResponse);
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    WholesalePriceBulkUpdateResponse wholesalePriceBulkUpdateResponse =
      new WholesalePriceBulkUpdateResponse();
    Map<String, String> wholesalePriceSkuStatusMap = new HashMap<>();
    wholesalePriceSkuStatusMap.put(DEFAULT_ITEM_SKU, INACTIVE);
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatusMap(wholesalePriceSkuStatusMap);
    wholesalePriceBulkUpdateResponse.setWholesalePriceSkuStatus(
      Arrays.asList(new WholeSalePriceSkuStatusDto(DEFAULT_ITEM_SKU, null, INACTIVE)));
    ProductItemWholesalePrice productItemWholesalePriceValues = new ProductItemWholesalePrice();
    productItemWholesalePriceValues.setItemSku(DEFAULT_ITEM_SKU);
    productItemWholesalePriceValues.setWholesalePriceActivated(true);
    productItemWholesalePriceValues.setWholesaleRules(WHOLESALE_RULE_1);
    itemSummaryResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemSummaryResponse.setGeneratedItemName(ITEM_NAME);
    wholesalePriceSkuResponse.setItemSku(DEFAULT_ITEM_SKU);
    when(productLevel3Repository.findSummaryByGdnSku(any())).thenReturn(itemSummaryResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    Mockito.when(productPricingOutbound.bulkUpdateWholesalePrice(
        Mockito.anyList(), Mockito.any()))
      .thenReturn(wholesalePriceBulkUpdateResponse);
    BulkActivateDeactivateResponse bulkActivateDeactivateResponse =
      new BulkActivateDeactivateResponse();
    Map<String, String> failedMap = new HashMap<>();
    failedMap.put(DEFAULT_ITEM_SKU, "campaign");
    bulkActivateDeactivateResponse.setFailedItemSkuToFailedReasonMap(failedMap);
    Mockito.when(productPricingOutbound.bulkActivateOrDeactivateSku(
        Mockito.anyList()))
      .thenReturn(bulkActivateDeactivateResponse);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(this.productPricingOutbound.getWholesalePriceList(anySet(), Mockito.anyMap())).thenReturn(
      Arrays.asList(wholesalePriceSkuResponse));
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests1, itemSummaryResponseMap);
    verify(variantEditValidationService).isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productPricingOutbound)
      .bulkUpdateWholesalePrice(Mockito.anyList(), any());
    Mockito.verify(productPricingOutbound)
      .bulkActivateOrDeactivateSku(Mockito.anyList());
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(updatedProductHistoryService, times(2))
      .createProductL3AuditLog(any(), any(), any(), any(), any(), any(), any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests1);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    Mockito.verify(xProductOutbound)
      .generateProductScoreByProductSkuOrProductCode(Mockito.any(), Mockito.any(),
        Mockito.anyBoolean());
    Mockito.verify(xProductOutbound)
      .updateWholeSaleActivationFlag(Mockito.anyList(), Mockito.anyBoolean());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesUpcCodeChangeTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductCode(DEFAULT_PRODUCT_CODE);
    productPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE_1);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setUpcCode(DEFAULT_UPC_CODE);
    productItemResponse.setSkuCode(DEFAULT_SKU_CODE);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    when(productOutbound.getProductItemBySkuCodes(any(SkuCodesRequest.class))).thenReturn(
      Arrays.asList(productItemResponse));
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(productCollectionRepository.findByStoreIdAndProductCode(eq(STORE_ID),
      Mockito.any())).thenReturn(productCollection);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    verify(variantEditValidationService).validateUpcCodeL5Level(Mockito.anyMap(),
      Mockito.any(), Mockito.any(ProductPriceStockAndImagesRequest.class));
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .editItemUpcCode(any(), Mockito.anyList());
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(updatedProductHistoryService)
      .createProductL3AuditLog(any(), any(), any(), any(), any(), any(), any(), anyBoolean(),
        eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productCollectionRepository).findByStoreIdAndProductCode(eq(STORE_ID), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));

  }

  @Test
  public void updateItemsPriceStockImagesUpcCodeChangeNoTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductCode(DEFAULT_PRODUCT_CODE);
    productPriceStockAndImagesRequest.setUpcCode(DEFAULT_UPC_CODE_1);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setUpcCode(DEFAULT_UPC_CODE + "-1");
    productItemResponse.setSkuCode(DEFAULT_SKU_CODE);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    when(productOutbound.getProductItemBySkuCodes(any(SkuCodesRequest.class))).thenReturn(
      Arrays.asList(productItemResponse));
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    when(productCollectionRepository.findByStoreIdAndProductCode(eq(STORE_ID),
      Mockito.any())).thenReturn(productCollection);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(variantEditValidationService).validateUpcCodeL5Level(Mockito.anyMap(),
      Mockito.any(), Mockito.any(ProductPriceStockAndImagesRequest.class));
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productCollectionRepository).findByStoreIdAndProductCode(eq(STORE_ID), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesCampaignValidationTest() throws Exception {
    productCollection.setActivated(true);
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest viewConfigs = new ProductLevel3ViewConfigRequest();
    viewConfigs.setBuyable(false);
    viewConfigs.setDisplay(false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(viewConfigs));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(DEFAULT_PRICE);
    price.setSalePrice(DEFAULT_SALE_PRICE);
    price.setChannelId(DEFAULT_CHANNEL_ID);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesBuyableDisplayChangeTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest viewConfigs = new ProductLevel3ViewConfigRequest();
    viewConfigs.setBuyable(true);
    viewConfigs.setDisplay(false);
    viewConfigs.setChannelId(DEFAULT_CHANNEL_ID);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(viewConfigs));
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(productNotificationService).sendNotificationForProductStatus(
      DEFAULT_BUSINESS_PARTNER_CODE, "itemName", ProductLevel3Status.B2B.name());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesBuyableDisplayChange1Test() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest viewConfigs = new ProductLevel3ViewConfigRequest();
    viewConfigs.setBuyable(true);
    viewConfigs.setDisplay(false);
    viewConfigs.setChannelId(DEFAULT_CHANNEL_ID);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(viewConfigs));
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(productNotificationService).sendNotificationForProductStatus(
      DEFAULT_BUSINESS_PARTNER_CODE, "itemName", ProductLevel3Status.B2B.name());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
  }

  @Test
  public void updateItemsPriceStockImagesStockChangeTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    ProductLevel3ViewConfigRequest viewConfigs = new ProductLevel3ViewConfigRequest();
    viewConfigs.setBuyable(true);
    viewConfigs.setDisplay(true);
    viewConfigs.setChannelId(DEFAULT_CHANNEL_ID);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(viewConfigs));
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(),
      anyList())).thenReturn(Arrays.asList(
      ProductLevel3Inventory.builder().webAvailable(100).webMinAlert(20)
        .webItemSku(DEFAULT_ITEM_SKU).build()));
    Mockito.when(productItemBusinessPartnerService.findReviewPendingProductCodeByItemSku(any()))
      .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(ProductImageQcProcessingResponse.builder().forceReview(false).build());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3InventoryService)
      .updateStockV2(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_ITEM_SKU, DEFAULT_DELTA_STOCK);
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(any());
    Mockito.verify(productImageQcProcessingResponseService)
      .findByStoreIdAndProductCode(any(), any());
    verify(updatedProductHistoryService, times(1)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesMinimumStockChangeTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setMinimumStockLevel2(DEFAULT_DELTA_STOCK);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(),
      anyList())).thenReturn(Arrays.asList(
      ProductLevel3Inventory.builder().webAvailable(100).webMinAlert(20)
        .webItemSku(DEFAULT_ITEM_SKU).build()));
    Mockito.when(productItemBusinessPartnerService.findReviewPendingProductCodeByItemSku(any()))
      .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(ProductImageQcProcessingResponse.builder().forceReview(false).build());
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(any());
    Mockito.verify(productImageQcProcessingResponseService)
      .findByStoreIdAndProductCode(any(), any());
    verify(updatedProductHistoryService, times(1)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesMinimumStockNoChangeTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setMinimumStockLevel2(20);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(),
      anyList())).thenReturn(Arrays.asList(
      ProductLevel3Inventory.builder().webAvailable(100).webMinAlert(20)
        .webItemSku(DEFAULT_ITEM_SKU).build()));
    Mockito.when(productItemBusinessPartnerService.findReviewPendingProductCodeByItemSku(any()))
      .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(ProductImageQcProcessingResponse.builder().forceReview(false).build());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(any());
    Mockito.verify(productImageQcProcessingResponseService)
      .findByStoreIdAndProductCode(any(), any());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesNewImageAddedToVariantTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    productCollection.setReviewType("CONTENT");
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(productPublisherService)
      .publishEditImageResizeEvent(Mockito.any(EditedImageResizeEvent.class));
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesUpdatedVariantImageTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(UPDATE);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesDeletedVariantImageTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(UPDATE);
    productPriceStockAndImagesRequest.getImages().get(0).setMarkForDelete(true);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesUpdatedVariantImageAndProductInReviewTest()
    throws Exception {
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType("gold");
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
      .thenReturn(sellerDetailResponse);
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(UPDATE);
    productPriceStockAndImagesRequest.setProductCode(DEFAULT_PRODUCT_CODE);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    productCollection.setReviewPending(true);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
      .thenReturn(new ProductBusinessPartner());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
  }

  @Test
  public void updateItemsPriceStockImagesStockChangeWarehouseMerchantTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    productPriceStockAndImagesRequest.setSynchronizeStock(true);
    productPriceStockAndImagesRequest.setMinimumStockLevel2(1);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(),
        anyList())).thenReturn(Arrays.asList(
      ProductLevel3Inventory.builder().webAvailable(10).webMinAlert(2).webItemSku(DEFAULT_ITEM_SKU)
        .build()));
    Mockito.when(productItemBusinessPartnerService.findReviewPendingProductCodeByItemSku(any()))
      .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(ProductImageQcProcessingResponse.builder().forceReview(false).build());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3InventoryService)
      .updateStockV2(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_ITEM_SKU, DEFAULT_DELTA_STOCK);
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(businessPartnerRepository, times(2))
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productLevel3InventoryService)
      .updateSyncStockByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
        DEFAULT_ITEM_SKU, true, Collections.singletonList(
          new ItemSkuPickupPointSyncStockDto(DEFAULT_ITEM_SKU, PICKUP, true)));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(any());
    Mockito.verify(productImageQcProcessingResponseService)
      .findByStoreIdAndProductCode(any(), any());
    verify(updatedProductHistoryService, times(3)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesStockChangeWarehouseMerchantNoChangeTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    PriceDTO priceDTO = new PriceDTO();
    priceDTO.setListPrice(10000);
    priceDTO.setOfferPrice(10000);
    ProductLevel3PriceRequest productLevel3PriceRequest = new ProductLevel3PriceRequest();
    productLevel3PriceRequest.setSalePrice(10000D);
    productLevel3PriceRequest.setPrice(10000D);
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    productPriceStockAndImagesRequest.setSynchronizeStock(false);
    productPriceStockAndImagesRequest.setMinimumStockLevel2(1);
    productPriceStockAndImagesRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(productLevel3PriceRequest));
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    itemSummaryResponse.setPrice(new HashSet<>(Arrays.asList(priceDTO)));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productLevel3Repository.findSummaryByGdnSku(any()))
      .thenReturn(itemSummaryResponse);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
      this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(),
        anyList())).thenReturn(Arrays.asList(
      ProductLevel3Inventory.builder().webAvailable(10).webMinAlert(2).webItemSku(DEFAULT_ITEM_SKU)
        .build()));
    Mockito.when(productItemBusinessPartnerService.findReviewPendingProductCodeByItemSku(any()))
      .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(any(), any()))
      .thenReturn(ProductImageQcProcessingResponse.builder().forceReview(false).build());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true,
      new ProductL3Response());
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3InventoryService)
      .updateStockV2(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_ITEM_SKU, DEFAULT_DELTA_STOCK);
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(businessPartnerRepository, times(2))
      .filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productItemBusinessPartnerService).findReviewPendingProductCodeByItemSku(any());
    Mockito.verify(productImageQcProcessingResponseService)
      .findByStoreIdAndProductCode(any(), any());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
      Mockito.anyInt());
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
  }

  @Test
  public void updateItemsPriceStockImagesMultiUsedProductTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsForMultiUsedProduct(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), false,
      new ProductL3Response());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsForMultiUsedProduct(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesCopyToAllVariantTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType("new");
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Map<String, Map<String, String>> success = new HashMap<>();
    Map<String, String> success1 = new HashMap<>();
    success1.put(Constants.COPY_ALL_STATUS, Constants.SUCCESS);
    success.put(productPriceStockAndImagesRequest.getImages().get(0).getLocationPath(), success1);
    Mockito.when(this.productOutbound.updateCommonImages(Mockito.anyList())).thenReturn(success);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE,
      productPriceStockAndImagesRequest.getImages(), true, new ProductL3Response());
    Mockito.verify(fileStorageService, times(2)).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(productLevel3Repository).getProductNameByProductSku(anyList());
    verify(productOutbound).updateCommonImages(Mockito.anyList());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesCopyToAllVariantWithFailStatusTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType("new");
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Map<String, Map<String, String>> success = new HashMap<>();
    Map<String, String> success1 = new HashMap<>();
    success1.put(Constants.COPY_ALL_STATUS, Constants.FAIL);
    success.put(productPriceStockAndImagesRequest.getImages().get(0).getLocationPath(), success1);
    Mockito.when(this.productOutbound.updateCommonImages(Mockito.anyList())).thenReturn(success);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE,
      productPriceStockAndImagesRequest.getImages(), true, new ProductL3Response());
    Mockito.verify(fileStorageService, times(2)).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService, times(1)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(productOutbound).updateCommonImages(Mockito.anyList());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesCopyToAllVariant_withSwitchOnReverseOrderTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "updateCommonImageBeforeVariantImages", true);
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType("new");
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Map<String, Map<String, String>> success = new HashMap<>();
    Map<String, String> success1 = new HashMap<>();
    success1.put(Constants.COPY_ALL_STATUS, Constants.SUCCESS);
    success.put(productPriceStockAndImagesRequest.getImages().get(0).getLocationPath(), success1);
    Mockito.when(this.productOutbound.updateCommonImages(Mockito.anyList())).thenReturn(success);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any()))
      .thenReturn("/test-image.jpeg");
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE,
      productPriceStockAndImagesRequest.getImages(), true, new ProductL3Response());
    Mockito.verify(fileStorageService, times(2)).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(productLevel3Repository).getProductNameByProductSku(anyList());
    verify(productOutbound).updateCommonImages(Mockito.anyList());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test//doing
  public void editProductItemsPriceStockImagesSyncProductReverseOrderTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "updateCommonImageBeforeVariantImages", true);
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest =
      new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setProductEditable(true);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    when(productCollectionRepository.findByStoreIdAndProductCode(eq(STORE_ID),
      Mockito.any())).thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID,
      updateItemsPriceStockImagesRequest, DEFAULT_BUSINESS_PARTNER_CODE);
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository).findByStoreIdAndProductCode(eq(STORE_ID), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesCopyToAllVariantExistingImageTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.getImages().get(0).setMainImage(true);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType("update");
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Map<String, Map<String, String>> success = new HashMap<>();
    Map<String, String> success1 = new HashMap<>();
    success1.put(Constants.COPY_ALL_STATUS, Constants.SUCCESS);
    success.put(productPriceStockAndImagesRequest.getImages().get(0).getLocationPath(), success1);
    Mockito.when(this.productOutbound.updateCommonImages(Mockito.anyList())).thenReturn(success);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE,
      productPriceStockAndImagesRequest.getImages(), true, new ProductL3Response());
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(productLevel3Repository).getProductNameByProductSku(anyList());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productOutbound).updateCommonImages(Mockito.anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void updateItemsPriceStockImagesCopyToAllVariantExistingImageDeleteTest()
    throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.getImages().get(0).setMarkForDelete(true);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType("update");
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(this.productRepository.getConfigurationStatus(
        Mockito.anyList()))
      .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
        successValidationVariantList.stream().findFirst().get().getProductCode()))
      .thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    Map<String, Map<String, String>> success = new HashMap<>();
    Map<String, String> success1 = new HashMap<>();
    success1.put(Constants.COPY_ALL_STATUS, Constants.SUCCESS);
    success.put(productPriceStockAndImagesRequest.getImages().get(0).getLocationPath(), success1);
    Mockito.when(this.productOutbound.updateCommonImages(Mockito.anyList())).thenReturn(success);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID,
      productPriceStockAndImagesRequests, DEFAULT_BUSINESS_PARTNER_CODE,
      productPriceStockAndImagesRequest.getImages(), true, new ProductL3Response());
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productOutbound)
      .updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(),
      Mockito.anyBoolean());
    verify(productLevel3Repository).getProductNameByProductSku(anyList());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productOutbound).updateCommonImages(Mockito.anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void takeDownOrReactivateProductTestMppOnTest() throws Exception {
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setFreeSample(false);
    productL3Response.setOnline(true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "schedulesAddEditEnabled", true);
    productBusinessPartner.setProductItemBusinessPartners(
      Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setFreeSample(false);
    productBusinessPartner.setOnline(true);
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false), eq(true));
    when(xProductOutbound.getL5ItemListing(Mockito.anySet(), Mockito.anyList(), Mockito.anyList(),
      eq(false), eq(null))).thenReturn(itemLevel5ResponseList);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      businessPartnerData);
    when(productBusinessPartnerRepository.save(
      productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false), Mockito.anyBoolean());
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(
      new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    productLevel3ServiceBean.takeDownOrReactivateProduct(STORE_ID, DEFAULT_PRODUCT_SKU, true, null,
      productL3Response);

    verify(productSystemParameterService).findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getL5ItemListing(
      Mockito.eq(Collections.singleton(DEFAULT_PRODUCT_SKU)), Mockito.anyList(), Mockito.anyList(),
      eq(false), eq(Constants.ALL));
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.getValue(),
      itemViewConfigRequestArgumentCaptor.getValue(), false, false);
  }

  @Test
  public void takeDownOrReactivateProductOfflineTest() throws Exception {
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setFreeSample(false);
    productL3Response.setOnline(false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "schedulesAddEditEnabled", true);
    productBusinessPartner.setProductItemBusinessPartners(
      Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setFreeSample(true);
    productBusinessPartner.setOnline(true);
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false), eq(true));
    when(xProductOutbound.getL5ItemListing(Mockito.anySet(), Mockito.anyList(), Mockito.anyList(),
      eq(false), eq(null))).thenReturn(itemLevel5ResponseList);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      businessPartnerData);
    when(productBusinessPartnerRepository.save(
      productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false), Mockito.anyBoolean());
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(
      new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    productLevel3ServiceBean.takeDownOrReactivateProduct(STORE_ID, DEFAULT_PRODUCT_SKU, true, null,
      productL3Response);

    verify(productSystemParameterService).findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getL5ItemListing(
      Mockito.eq(Collections.singleton(DEFAULT_PRODUCT_SKU)), Mockito.anyList(), Mockito.anyList(),
      eq(false), eq(Constants.ALL));
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.getValue(),
      itemViewConfigRequestArgumentCaptor.getValue(), false, true);
  }

  @Test
  public void takeDownOrReactivateProductFreeSampleTest() throws Exception {
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setFreeSample(true);
    productL3Response.setOnline(true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "schedulesAddEditEnabled", false);
    productBusinessPartner.setProductItemBusinessPartners(
      Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setFreeSample(true);
    productBusinessPartner.setOnline(true);
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false), eq(true));
    when(xProductOutbound.getL5ItemListing(Mockito.anySet(), Mockito.anyList(), Mockito.anyList(),
      eq(false), Mockito.eq(null))).thenReturn(itemLevel5ResponseList);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(
      businessPartnerData);
    when(productBusinessPartnerRepository.save(
      productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false), Mockito.anyBoolean());
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(
      new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    productLevel3ServiceBean.takeDownOrReactivateProduct(STORE_ID, DEFAULT_PRODUCT_SKU, true, null,
      productL3Response);

    verify(productSystemParameterService).findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getL5ItemListing(
      Mockito.eq(Collections.singleton(DEFAULT_PRODUCT_SKU)), Mockito.anyList(), Mockito.anyList(),
      eq(false), Mockito.eq(Constants.ALL));
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.getValue(),
      itemViewConfigRequestArgumentCaptor.getValue(), false, false);
  }


  @Test
  public void takeDownOrReactivateProductTakeDownFalseTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "schedulesAddEditEnabled", true);
    productBusinessPartner.setProductItemBusinessPartners(
      Arrays.asList(productItemBusinessPartner));
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(this.businessPartnerData);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productBusinessPartnerService.updateProductBusinessPartnerState(Mockito.any(),
      Mockito.anyBoolean(), Mockito.any(), Mockito.any())).thenReturn(productBusinessPartner);
    when(productBusinessPartnerRepository.save(
      productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound)
      .updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), Mockito.anyBoolean(), Mockito.anyBoolean());
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(
      new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    productLevel3ServiceBean.takeDownOrReactivateProduct(STORE_ID, DEFAULT_PRODUCT_SKU, false, null,
      new ProductL3Response());

    verify(productSystemParameterService).findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.getValue(),
      itemViewConfigRequestArgumentCaptor.getValue(), false, true);
  }

  @Test
  public void updateLogisticsTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsPickupPointTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "setWaitingDeletionForDeletePickupPoint", true);
    List<PickupPointResponse> pickupPointResponses = new ArrayList<>();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP);
    PickupPointResponse pickupPointResponse1 = new PickupPointResponse();
    pickupPointResponse1.setCode(PICKUP_1);
    pickupPointResponses.add(pickupPointResponse);
    pickupPointResponses.add(pickupPointResponse1);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(this.businessPartnerRepository.filterPickupPointsByPickupPointRequest(
        pickupPointFilterRequestArgumentCaptor.capture())).thenReturn(pickupPointResponses);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
    Assertions.assertFalse(pickupPointFilterRequestArgumentCaptor.getValue().getWaitingDeletion());
  }

  @Test
  public void updateLogisticsPickupPointGeolocationNullTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "setWaitingDeletionForDeletePickupPoint", true);
    List<PickupPointResponse> pickupPointResponses = new ArrayList<>();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP);
    GeolocationDTO geolocationDTO = new GeolocationDTO();
    geolocationDTO.setPlaceId("PlaceId");
    pickupPointResponse.setGeolocation(geolocationDTO);
    PickupPointResponse pickupPointResponse1 = new PickupPointResponse();
    pickupPointResponse1.setCode(PICKUP_1);
    pickupPointResponses.add(pickupPointResponse);
    pickupPointResponses.add(pickupPointResponse1);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(this.businessPartnerRepository.filterPickupPointsByPickupPointRequest(
        pickupPointFilterRequestArgumentCaptor.capture())).thenReturn(pickupPointResponses);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
    Assertions.assertFalse(pickupPointFilterRequestArgumentCaptor.getValue().getWaitingDeletion());
  }

  @Test
  public void updateLogisticsPickupPointGeolocationTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    List<PickupPointResponse> pickupPointResponses = new ArrayList<>();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP);
    GeolocationDTO geolocationDTO = new GeolocationDTO();
    geolocationDTO.setPlaceId("");
    pickupPointResponse.setGeolocation(geolocationDTO);
    PickupPointResponse pickupPointResponse1 = new PickupPointResponse();
    pickupPointResponse1.setCode(PICKUP_1);
    pickupPointResponse1.setGeolocation(geolocationDTO);
    pickupPointResponses.add(pickupPointResponse);
    pickupPointResponses.add(pickupPointResponse1);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(this.businessPartnerRepository.filterPickupPointsByPickupPointRequest(
        pickupPointFilterRequestArgumentCaptor.capture())).thenReturn(pickupPointResponses);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateLogisticsDimensionUpdateFailedInPCBTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
      new SimpleMasterProductUpdateResponse();
    simpleMasterProductUpdateResponse.setUpdateSuccess(false);
    Mockito.when(this.productRepository.updateSimpleMasterProduct(
        any(SimpleMasterProductUpdateRequestDTO.class)))
      .thenReturn(simpleMasterProductUpdateResponse);
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setDangerousGoodsLevel(1);
    ApiErrorCode apiErrorCode =
      productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, false);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.DIMENSION_UPDATE_FAILED.getDesc(), apiErrorCode.getDesc());
    Assertions.assertEquals(ApiErrorCode.DIMENSION_UPDATE_FAILED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void updateLogisticsWithPreOrderEditTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(true),
      itemArgumentCaptor.capture());
    verify(updatedProductHistoryService).createProductL3AuditLog(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(Constants.DEFAULT),
        Mockito.eq(DEFAULT_PRODUCT_SKU), Mockito.eq(PRODUCT_NAME1), Mockito.eq(UpdateProductActivity.PRE_ORDER.getDesc()), Mockito.any(), Mockito.any(), Mockito.eq(false),
        Mockito.eq(StringUtils.EMPTY));
    Assertions.assertEquals(PREORDER_TYPE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderType());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderNullTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setPreOrder(null);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(false),
      itemArgumentCaptor.capture());
    Assertions.assertEquals(PREORDER_TYPE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderType());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderFalseTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setPreOrderDTO(new PreOrderDTO(false, null, null, null, false));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setPreOrder(new PreOrderRequest(false, null, null, null));
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(false),
      itemArgumentCaptor.capture());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderChangeTrueTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    preOrderDTO = new PreOrderDTO();
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(true),
      itemArgumentCaptor.capture());
    verify(updatedProductHistoryService).createProductL3AuditLog(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(Constants.DEFAULT),
      Mockito.eq(DEFAULT_PRODUCT_SKU), Mockito.eq(PRODUCT_NAME1),
      Mockito.eq(UpdateProductActivity.PRE_ORDER.getDesc()), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertEquals(PREORDER_TYPE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderType());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderTypeChangeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    preOrderDTO.setPreOrderType(PREORDER_TYPE_WEEK);
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(true),
      itemArgumentCaptor.capture());
    verify(updatedProductHistoryService).createProductL3AuditLog(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
      Mockito.eq(Constants.DEFAULT), Mockito.eq(DEFAULT_PRODUCT_SKU), Mockito.eq(PRODUCT_NAME1),
      Mockito.eq(UpdateProductActivity.PRE_ORDER.getDesc()), Mockito.any(),
      Mockito.any(), Mockito.eq(false),
      Mockito.eq(StringUtils.EMPTY));
    Assertions.assertEquals(PREORDER_TYPE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderValue());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderValueChangeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    preOrderDTO.setPreOrderValue(12);
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(true),
      itemArgumentCaptor.capture());
    verify(updatedProductHistoryService).createProductL3AuditLog(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(Constants.DEFAULT),
      Mockito.eq(DEFAULT_PRODUCT_SKU), Mockito.eq(PRODUCT_NAME1),
      Mockito.eq(UpdateProductActivity.PRE_ORDER.getDesc()), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertEquals(PREORDER_VALUE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderValue());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderValueChange1Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    preOrderDTO.setPreOrderValue(12);
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    preOrderRequest.setIsPreOrder(false);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(true),
      itemArgumentCaptor.capture());
    verify(updatedProductHistoryService).createProductL3AuditLog(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(Constants.DEFAULT),
      Mockito.eq(DEFAULT_PRODUCT_SKU), Mockito.eq(PRODUCT_NAME1),
      Mockito.eq(UpdateProductActivity.PRE_ORDER.getDesc()), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertEquals(PREORDER_VALUE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderValue());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderValueChange2Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    preOrderDTO.setPreOrderValue(12);
    preOrderDTO.setIsPreOrder(false);
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(true),
      itemArgumentCaptor.capture());
    verify(updatedProductHistoryService).createProductL3AuditLog(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(Constants.DEFAULT),
      Mockito.eq(DEFAULT_PRODUCT_SKU), Mockito.eq(PRODUCT_NAME1),
      Mockito.eq(UpdateProductActivity.PRE_ORDER.getDesc()), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertEquals(PREORDER_VALUE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderValue());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderValueChange3Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    preOrderDTO.setPreOrderValue(12);
    preOrderDTO.setIsPreOrder(false);
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    preOrderRequest.setIsPreOrder(false);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(false),
      Mockito.any(ItemRequest.class));
    Assertions.assertEquals(12,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderValue().intValue());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderTypeNullTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    preOrderDTO.setPreOrderType(PREORDER_TYPE_WEEK);
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    preOrderRequest.setPreOrderType(null);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(true),
      itemArgumentCaptor.capture());
    verify(updatedProductHistoryService).createProductL3AuditLog(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
      Mockito.eq(Constants.DEFAULT), Mockito.eq(DEFAULT_PRODUCT_SKU), Mockito.eq(PRODUCT_NAME1),
      Mockito.eq(UpdateProductActivity.PRE_ORDER.getDesc()), Mockito.any(),
      Mockito.any(), Mockito.eq(false),
      Mockito.eq(StringUtils.EMPTY));
    Assertions.assertNull(productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderType());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithPreOrderTypeDateTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    preOrderDTO.setPreOrderType(PREORDER_TYPE_DATE);
    preOrderDTO.setPreOrderDate(new Date());
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    preOrderRequest.setPreOrderType(PREORDER_TYPE_DATE);
    Date currentDate = new Date();
    Calendar cal = Calendar.getInstance();
    cal.setTime(currentDate);
    cal.add(Calendar.DATE, 2);
    preOrderRequest.setPreOrderDate(cal.getTime());
    preOrderRequest.setPreOrderValue(null);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(true),
      itemArgumentCaptor.capture());
    verify(updatedProductHistoryService).createProductL3AuditLog(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE), Mockito.eq(Constants.DEFAULT),
      Mockito.eq(DEFAULT_PRODUCT_SKU), Mockito.eq(PRODUCT_NAME1),
      Mockito.eq(UpdateProductActivity.PRE_ORDER.getDesc()), Mockito.any(), Mockito.any(),
      Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertEquals(PREORDER_TYPE_DATE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderType());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithWidthUpdateTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(
      DEFAULT_PRODUCT_SKU)).thenReturn(Arrays.asList(DEFAULT_ITEM_SKU));
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    productLevel3UpdateRequest.setLength(10.20);
    savedProductData1.setLength(10.20);
    savedProductData1.setWidth(13.50);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(false),
      itemArgumentCaptor.capture());
    Assertions.assertNull(productRequestArgumentCaptor.getValue().getPreOrder());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogisticsWithoutPreOrderChangeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    preOrderDTO.setPreOrderDate(preOrderRequest.getPreOrderDate());
    savedProductData1.setPreOrderDTO(preOrderDTO);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE);
    verify(xProductOutbound).updateProduct(Mockito.eq(false),
      productRequestArgumentCaptor.capture());
    verify(xProductOutbound).updateItem(Mockito.eq(false), Mockito.eq(true), Mockito.eq(false),
      itemArgumentCaptor.capture());
    Assertions.assertEquals(PREORDER_TYPE,
      productRequestArgumentCaptor.getValue().getPreOrder().getPreOrderType());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withLogisticsChangeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLateFulfillment(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(
      Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(
      DEFAULT_PRODUCT_SKU)).thenReturn(Arrays.asList(DEFAULT_ITEM_SKU));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
      Mockito.anyList(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE,
      Constants.DEFAULT, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      UpdateProductActivity.LOGISTIC.getDesc(), String.valueOf(Collections.EMPTY_LIST),
      String.valueOf(Collections.singletonList("GOJEK")), false, StringUtils.EMPTY);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withLogisticsChange1Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLateFulfillment(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(
      Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    ProductLevel3Logistics productLevel3Logistics1 = new ProductLevel3Logistics();
    productLevel3Logistics1.setLogisticProductCode("GOJEK1");
    productLevel3Logistics1.setSelected(true);
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(Arrays.asList(productLevel3Logistics1));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    profileResponse.getCompany().setMerchantType(Constants.CM_MERCHANT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
      Mockito.anyList(), Mockito.anyBoolean());
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE,
      Constants.DEFAULT, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      UpdateProductActivity.LOGISTIC.getDesc(), String.valueOf(Collections.singletonList("GOJEK1")),
      String.valueOf(Collections.singletonList("GOJEK")), false, StringUtils.EMPTY);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withNoDimensionChangeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(1.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, true, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withDimensionChange_productNotEditableTest() throws Exception {
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, false)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(10.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(10.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(10.0);
    savedProductData1.setWidth(190.0);
    savedProductData1.setHeight(1.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(11.0);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setProductEditable(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withIsEditableFalseNoDimensionChangeTest() throws Exception {
    productLevel3UpdateRequest.setProductType(2);
    productLevel3UpdateRequest.setLateFulfillment(true);
    productLevel3UpdateRequest.setProductEditable(false);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(
      Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
      Mockito.anyList(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE,
      Constants.DEFAULT, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      UpdateProductActivity.LOGISTIC.getDesc(), String.valueOf(Collections.EMPTY_LIST),
      String.valueOf(Collections.singletonList("GOJEK")), false, StringUtils.EMPTY);
    verify(xProductOutbound, TWO_TIMES).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }


  @Test
  public void updateLogistics_withShippingTypeChangeTest() throws Exception {
    productLevel3UpdateRequest.setProductType(2);
    productLevel3UpdateRequest.setLateFulfillment(true);
    productLevel3UpdateRequest.setProductEditable(false);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(
      Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(
      DEFAULT_PRODUCT_SKU)).thenReturn(Arrays.asList(DEFAULT_ITEM_SKU));
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(false);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
      Mockito.anyList(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE,
      Constants.DEFAULT, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      UpdateProductActivity.LOGISTIC.getDesc(), String.valueOf(Collections.EMPTY_LIST),
      String.valueOf(Collections.singletonList("GOJEK")), false, StringUtils.EMPTY);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(
      DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1,
      false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withShippingTypeChangeFailedTest() throws Exception {
    productLevel3UpdateRequest.setProductType(2);
    productLevel3UpdateRequest.setLateFulfillment(true);
    productLevel3UpdateRequest.setProductEditable(false);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(
      Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(
      DEFAULT_PRODUCT_SKU)).thenReturn(Arrays.asList(DEFAULT_ITEM_SKU));
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    Mockito.when(
      productLevel3LogisticsService.saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean())).thenReturn(false);
    productLevel3UpdateRequest.setSynchronize(false);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode =
      productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
      Mockito.anyList(), Mockito.anyBoolean());
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    Assertions.assertEquals(ApiErrorCode.LOGISTICS_DATA_NOT_SAVED.getCode(), apiErrorCode.getCode());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
      ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withShippingTypeChangeTest1() throws Exception {
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLateFulfillment(true);
    productLevel3UpdateRequest.setProductEditable(false);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(null);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(
      DEFAULT_PRODUCT_SKU)).thenReturn(Arrays.asList(DEFAULT_ITEM_SKU));
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().setProductType(ProductType.BIG_PRODUCT);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(true);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withDimensionChangeTest1() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(
      DEFAULT_PRODUCT_SKU)).thenReturn(Arrays.asList(DEFAULT_ITEM_SKU));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(10.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(false);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withDimensionChangeTest2() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(xProductOutbound.getPickupPointCodesByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      Stream.of(PICKUP).collect(Collectors.toSet()));
    when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(
      DEFAULT_PRODUCT_SKU)).thenReturn(Arrays.asList(DEFAULT_ITEM_SKU));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(10.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
      DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withDimensionChangeTest3() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setMerchantDeliveryType(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(10.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(1.0);
    savedProductData1.setWeight(10.0);
    savedProductData1.setShippingWeight(1.0);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test
  public void updateLogistics_withDimensionChangeTest4() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU,
      true, true)).thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(
      PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setMerchantDeliveryType(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(
        xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(10.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any()))
      .thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(false);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(1.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(10.0);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(
      DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU,
      null, false);
  }

  @Test//doing
  public void editProductItemsPriceStockImagesSyncProductTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "combinedEditFlowEnabled", true);
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest =
      new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setProductEditable(true);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(
      productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku())).thenReturn(
      productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap)).thenReturn(
      successValidationVariantList);
    when(
      productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest,
      DEFAULT_CATEGORY_CODE, DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    when(productCollectionRepository.findByStoreIdAndProductCode(eq(STORE_ID),
      Mockito.any())).thenReturn(productCollection);
    Mockito.when(
        this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
      .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID,
      updateItemsPriceStockImagesRequest, DEFAULT_BUSINESS_PARTNER_CODE);
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(
      productPriceStockAndImagesRequests, failedRequests, itemSummaryResponseMap);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
      DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound)
      .getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository)
      .save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
      .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
      .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(
      productPriceStockAndImagesRequests.get(0), failedRequests);
    Mockito.verify(productLevel3Repository)
      .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
        Mockito.any(SortOrder.class));
    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository).findByStoreIdAndProductCode(eq(STORE_ID), Mockito.any());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }


  @Test
  public void editProductItemsPriceStockImagesSyncProductEditFalseTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(DEFAULT_STORE_ID,
        productPriceStockAndImagesRequest.getItemSku())).thenReturn(productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(productPriceStockAndImagesRequests,
        failedRequests, itemSummaryResponseMap)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(variantEditValidationService).validateListOfVariantsForMultiUsedProduct(productPriceStockAndImagesRequests,
        failedRequests, itemSummaryResponseMap);
    Mockito.verify(productLevel3Repository)
        .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
            Mockito.any(SortOrder.class));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
  }


  @Test
  public void editProductItemsPriceStockImagesUnSyncProductTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setProductCode(PRODUCT_CODE);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setProductEditable(true);
    updateItemsPriceStockImagesRequest.setSynchronize(false);
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(DEFAULT_STORE_ID,
        productPriceStockAndImagesRequest.getItemSku())).thenReturn(productItemBusinessPartner);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(productPriceStockAndImagesRequests,
        failedRequests, itemSummaryResponseMap)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productLevel3Repository)
        .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
            Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(productPriceStockAndImagesRequests,
        failedRequests, itemSummaryResponseMap);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    verify(productPricingOutbound).getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any());
    verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
        .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
        .saveUpdateProductLevel3Audit(any(), any(), any(),
            any(), any(), Mockito.any(), Mockito.any(),
            Mockito.anyBoolean(), Mockito.any());
    verify(variantEditValidationService).validatePriceLockCampaignRequest(productPriceStockAndImagesRequests.get(0),
        failedRequests);
    verify(productLevel3Repository).synchronizeProduct(DEFAULT_PRODUCT_SKU);
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesSyncProduct_ErrorTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setProductEditable(true);
    updateItemsPriceStockImagesRequest.setSynchronize(false);
    productL3Response.setMarkForDelete(true);
    productL3Response.setTakenDown(true);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).countRejectedProductByGdnProductSku(Mockito.any());
  }

  @Test
  public void getProductL3SummaryTest() throws Exception {
    Mockito.when(
            this.xProductOutbound.getProductSkuSummary(DEFAULT_BUSINESS_PARTNER_CODE, new ProductSkuSummaryRequest(), PAGE,
                SIZE))
        .thenReturn(new PageImpl<>(Arrays.asList(productSkuSummaryResponse), PageRequest.of(PAGE, SIZE), SIZE));
    Mockito.when(this.categoryRepository.findHierarchyByCategoryCodes(Mockito.any(CategoryCodeRequest.class)))
        .thenReturn(Arrays.asList(categoryHierarchyResponse));
    Page<ProductL3SummaryResponse> productL3SummaryResponses =
        productLevel3ServiceBean.getProductL3Summary(STORE_ID, REQUESTID, DEFAULT_BUSINESS_PARTNER_CODE, 0, 10,
            productL3SummaryRequest);
    Mockito.verify(this.xProductOutbound)
        .getProductSkuSummary(DEFAULT_BUSINESS_PARTNER_CODE, new ProductSkuSummaryRequest(), PAGE, SIZE);
    Mockito.verify(this.categoryRepository).findHierarchyByCategoryCodes(Mockito.any(CategoryCodeRequest.class));
    Assertions.assertEquals(BRAND, productL3SummaryResponses.getContent().get(0).getBrand());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, productL3SummaryResponses.getContent().get(0).getProductSku());
    Assertions.assertEquals(PRODUCT_NAME, productL3SummaryResponses.getContent().get(0).getProductSkuName());
    Assertions.assertEquals(CATEGORY_CODE, productL3SummaryResponses.getContent().get(0).getCategoryCode());
    Assertions.assertEquals(CATEGORY_NAME, productL3SummaryResponses.getContent().get(0).getCategoryName());
    Assertions.assertEquals(CATEGORY_NAME, productL3SummaryResponses.getContent().get(0).getCategoryHierarchy());
  }

  @Test
  public void updatePickupPointCodesCncAndCmAndWhiteListedTest() throws Exception {
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(true);
    profileResponse.getCompany().setMerchantType(Constants.CM_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    productSystemParameter1.setValue("true");
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
      productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    });
  }

  @Test
  public void updatePickupPointCodesCncAndNonCmAndWhiteListedTest() throws Exception {
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(true);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    productSystemParameter1.setValue("true");
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
      productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    });
  }

  @Test
  public void updatePickupPointCodesCncAndCmAndNonWhiteListedTest() throws Exception {
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(true);
    profileResponse.getCompany().setMerchantType(Constants.CM_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    productSystemParameter1.setValue("true");
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
      productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    });
  }

  @Test
  public void updatePickupPointCodesCncAndNonCmAndNonWhiteListedTest() throws Exception {
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(true);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    productSystemParameter1.setValue("true");
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
      productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    });
  }

  @Test
  public void updatePickupPointCodesNonCncAndCmAndWhiteListedTest() throws Exception {
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CM_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    productSystemParameter1.setValue("true");
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
      productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    });
  }

  @Test
  public void updatePickupPointCodesNonCncAndNonCmAndWhiteListedTest() throws Exception {
    productSystemParameter1.setValue("true");
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(true);
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setPickUpPointCode(PICKUP_1);
    itemResponses.add(itemResponseV2);
    when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(itemResponses);
    when(inventoryOutbound.updatePickupPoint(
        any(MandatoryRequestParam.class),
        any())).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true)))
        .thenReturn(response);
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setItemName(ITEM_NAME);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(Mockito.any()))
        .thenReturn(Arrays.asList(itemResponseV2));
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(inventoryOutbound).updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    verify(xProductOutbound).getItemPickupPointsByItemSku(Mockito.any());
    verify(xProductOutbound).getItemNameByItemSkus(Mockito.any(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.anyString(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), eq(false), Mockito.anyString());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
  }

  @Test
  public void updatePickupPointCodesNonCncAndNonCmAndWhiteListedSamePPCodeUpdateTest() throws Exception {
    productSystemParameter1.setValue("true");
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(true);
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setPickUpPointCode(PICKUP);
    itemResponses.add(itemResponseV2);
    when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(itemResponses);
    when(inventoryOutbound.updatePickupPoint(
        any(MandatoryRequestParam.class),
        any())).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true)))
        .thenReturn(response);
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setItemName(ITEM_NAME);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(Mockito.any()))
        .thenReturn(Arrays.asList(itemResponseV2));
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(inventoryOutbound).updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    verify(xProductOutbound).getItemPickupPointsByItemSku(Mockito.any());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
  }

  @Test
  public void updatePickupPointCodesNonCncAndNonCmAndWhiteListedWithPPCodeNullTest() throws Exception {
    productSystemParameter1.setValue("true");
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(true);
    itemResponseV2.setItemSku(RANDOM_SKU);
    itemResponseV2.setPickUpPointCode(RANDOM_CODE);
    itemResponses.add(itemResponseV2);
    when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(itemResponses);
    when(inventoryOutbound.updatePickupPoint(
        any(MandatoryRequestParam.class),
        any())).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(1L);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true)))
        .thenReturn(response);
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setItemName(ITEM_NAME);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(Mockito.any()))
        .thenReturn(Arrays.asList(itemResponseV2));
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(inventoryOutbound).updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    verify(xProductOutbound).getItemPickupPointsByItemSku(Mockito.any());
    verify(xProductOutbound).getItemNameByItemSkus(Mockito.any(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.anyString(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), eq(false), Mockito.anyString());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
  }

  @Test
  public void updatePickupPointCodesExceptionTestFbbTrue() throws Exception {
    pickupPointUpdateRequest.setFbbActivated(true);
    productSystemParameter1.setValue("false");
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponseList.add(pickupPointResponse);
    pickupPointUpdateRequest.setDifferentLocation(true);
    itemSummaryResponse.setPickupPointCode(PICKUP_1);
    updatePickupPointResponse.setErrors(new ArrayList<>());
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 1));
    when(inventoryOutbound.updatePickupPoint(
        any(MandatoryRequestParam.class),
        any(ListRequestDTO.class))).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    ItemRequestV2 itemRequest = new ItemRequestV2();
    itemRequest.setItemSkuList(Arrays.asList(PICKUP_1));
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(itemRequest)).thenReturn(Arrays.asList(new ItemResponseV2()));
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true))).thenReturn(response);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse = null;
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
      });
    } finally {
      verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
      verify(xProductOutbound).getItemPickupPointsByItemSku(Mockito.any());
    }
  }

  @Test
  public void updatePickupPointCodesExceptionWaitingDeletionSwitchOnTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "setWaitingDeletionForDeletePickupPoint", true);
    pickupPointUpdateRequest.setFbbActivated(true);
    productSystemParameter1.setValue("false");
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponseList.add(pickupPointResponse);
    pickupPointUpdateRequest.setDifferentLocation(true);
    itemSummaryResponse.setPickupPointCode(PICKUP_1);
    updatePickupPointResponse.setErrors(new ArrayList<>());
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 1));
    when(inventoryOutbound.updatePickupPoint(any(MandatoryRequestParam.class), any(ListRequestDTO.class))).thenReturn(
        updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    ItemRequestV2 itemRequest = new ItemRequestV2();
    itemRequest.setItemSkuList(Arrays.asList(PICKUP_1));
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(itemRequest))
        .thenReturn(Arrays.asList(new ItemResponseV2()));
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true)))
        .thenReturn(response);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse = null;
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
      });
    } finally {
      verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
      verify(xProductOutbound).getItemPickupPointsByItemSku(Mockito.any());
    }
  }

  @Test
  public void updatePickupPointCodesPpCodeNulExceptionTestFbbTrue() throws Exception {
    pickupPointUpdateRequest.setFbbActivated(true);
    productSystemParameter1.setValue("false");
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponseList.add(pickupPointResponse);
    pickupPointUpdateRequest.setDifferentLocation(true);
    itemSummaryResponse.setPickupPointCode(PICKUP_1);
    updatePickupPointResponse.setErrors(new ArrayList<>());
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 1));
    when(inventoryOutbound.updatePickupPoint(
        any(MandatoryRequestParam.class),
        any(ListRequestDTO.class))).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    ItemRequestV2 itemRequest = new ItemRequestV2();
    itemRequest.setItemSkuList(Arrays.asList(PICKUP_1));
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setPickUpPointCode(null);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(itemRequest)).thenReturn(Arrays.asList(itemResponseV2));
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true))).thenReturn(response);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse = null;
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
      });
    } finally {
      verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
      verify(xProductOutbound).getItemPickupPointsByItemSku(Mockito.any());
    }
  }

  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalse_noItemSkusMppTrueTest() throws Exception {
    ItemResponseV2 itemResponse = new ItemResponseV2();
    itemResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemResponse.setPickUpPointCode(PICKUP_1);
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(Arrays.asList(itemResponse));
    when(inventoryOutbound.updatePickupPoint(
        any(MandatoryRequestParam.class),
        any())).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList(
        itemBasicDetailV2Response));
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(inventoryOutbound).updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
    verify(xProductOutbound).getItemPickupPointsByItemSku(any());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
  }
  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalse_noItemSkusMppTrueFbbTest() throws Exception {
    pickupPointUpdateRequest.setFbbActivated(true);
    ItemResponseV2 itemResponse = new ItemResponseV2();
    itemResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemResponse.setPickUpPointCode(PICKUP_1);
    itemResponse.setFbbActivated(true);
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponse.setArchived(false);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList(
        itemBasicDetailV2Response));
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(Arrays.asList(itemResponse));
    when(inventoryOutbound.updatePickupPoint(
        any(MandatoryRequestParam.class),
        any())).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(inventoryOutbound).updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound).getItemPickupPointsByItemSku(any());
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
  }

  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalse_noItemSkusMppTrueFbWithThreeResponseTest() throws Exception {
    pickupPointUpdateRequest.setFbbActivated(true);
    ItemResponseV2 itemResponse = new ItemResponseV2();
    itemResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemResponse.setPickUpPointCode(PICKUP_1);
    itemResponse.setFbbActivated(true);
    ItemResponseV2 itemResponse1 = new ItemResponseV2();
    itemResponse1.setItemSku(ITEM_SKU_1);
    itemResponse1.setPickUpPointCode(PICKUP_1);
    itemResponse1.setFbbActivated(true);
    ItemResponseV2 itemResponse2 = new ItemResponseV2();
    itemResponse2.setItemSku(ITEM_SKU_3);
    itemResponse2.setPickUpPointCode(PICKUP_1);
    itemResponse2.setFbbActivated(true);
    List<ItemResponseV2> itemResponseV2s = Arrays.asList(itemResponse, itemResponse1, itemResponse2);
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponse.setArchived(false);
    pickupPointResponseList.add(pickupPointResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "2", "item-summary-size", false));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(itemResponseV2s);
    Mockito.when(inventoryOutbound.updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any())).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(Long.valueOf(1));
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList(
        itemBasicDetailV2Response));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(inventoryOutbound, times(2)).updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any());
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
    verify(xProductOutbound, times(1)).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound, times(1)).getItemPickupPointsByItemSku(any());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
  }


  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalse_noItemSkusMppTrueFbWithEmptyResponseTest() throws Exception {
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponse.setArchived(false);
    pickupPointResponseList.add(pickupPointResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "2", "item-summary-size", false));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(new ArrayList<>());
    Mockito.when(inventoryOutbound.updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any())).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList());
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
  }

  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalse_noItemSkusMppTrueFbbNotNullTest() throws Exception {
    ItemResponseV2 itemResponse = new ItemResponseV2();
    itemResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemResponse.setPickUpPointCode(PICKUP_1);
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(Arrays.asList(itemResponse));
    Mockito.when(inventoryOutbound.updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any())).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList(
        itemBasicDetailV2Response));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(inventoryOutbound).updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound).getItemPickupPointsByItemSku(any());
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
  }

  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalseException_noItemSkusMppTrueTest() throws Exception {
    ItemResponseV2 itemResponse = new ItemResponseV2();
    itemResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemResponse.setPickUpPointCode(PICKUP_1);
    List<ItemResponseV2> itemResponseV2s = Arrays.asList(itemResponse);
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(itemResponseV2s);
    Mockito.when(inventoryOutbound.updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any())).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList(
        itemBasicDetailV2Response));
    Mockito.doThrow(Exception.class).when(xProductOutbound)
        .updatePickupPointCodes(Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound).getItemPickupPointsByItemSku(any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
  }

  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalse_noItemSkusMppTrue1Test() throws Exception {
    ItemResponseV2 itemResponse = new ItemResponseV2();
    itemResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemResponse.setPickUpPointCode(PICKUP_1);
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CM_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(Arrays.asList(itemResponse));
    Mockito.when(inventoryOutbound.updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any())).thenReturn(new WebInventoryUpdatePickupPointResponseDTO());
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList(
        itemBasicDetailV2Response));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
    verify(inventoryOutbound).updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(productLevel3Repository).getProductNameByProductSku(any());
    verify(xProductOutbound).getItemPickupPointsByItemSku(any());
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE, Constants.DEFAULT,
        DEFAULT_PRODUCT_SKU, null, UpdateProductActivity.PICK_POINT_CODE.getDesc(), PICKUP_1, PICKUP, false, PICKUP);
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
  }

  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalse2ItemSkusMppTrue1Test() throws Exception {
    ItemResponseV2 itemResponse = new ItemResponseV2();
    itemResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemResponse.setPickUpPointCode(PICKUP_1);
    ItemResponseV2 itemResponse1 = new ItemResponseV2();
    itemResponse1.setItemSku(ITEM_SKU_1);
    itemResponse1.setPickUpPointCode(DEFAULT_ITEM_SKU);
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CM_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true))).thenReturn(
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID));
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "2", "max-size", false));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(Arrays.asList(itemResponse, itemResponse1));
    Mockito.when(inventoryOutbound.updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any())).thenReturn(new WebInventoryUpdatePickupPointResponseDTO());
    when(xProductOutbound
        .updatePickupPointCodes(Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class)))
        .thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList(
        itemBasicDetailV2Response));
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true)))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true,
            new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)), REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(inventoryOutbound).updatePickupPoint(
        Mockito.any(MandatoryRequestParam.class),
        Mockito.any());
    verify(xProductOutbound)
        .updatePickupPointCodes(Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound, times(2)).getItemNameByItemSkus(any(), eq(true));
    verify(xProductOutbound).getItemPickupPointsByItemSku(any());
    verify(updatedProductHistoryService)
        .createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, DEFAULT_PRODUCT_SKU, ITEM_NAME,
            UpdateProductActivity.PICK_POINT_CODE.getDesc(), DEFAULT_ITEM_SKU, PICKUP, false, PICKUP);
    verify(updatedProductHistoryService)
        .createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_ITEM_SKU, DEFAULT_PRODUCT_SKU, null,
            UpdateProductActivity.PICK_POINT_CODE.getDesc(), PICKUP_1, PICKUP, false, PICKUP);
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
  }

  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalse_noItemSkusMppTrue2findSummaryDetailsByFilterTest()
      throws Exception {
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CM_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    itemResponses.size();
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(Arrays.asList());
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList());
    when(inventoryOutbound.updatePickupPoint(
        any(MandatoryRequestParam.class),
        any())).thenReturn(new WebInventoryUpdatePickupPointResponseDTO());
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
  }

  @Test
  public void updatePickupPointCodesNeedCorrectionFbbTest() throws Exception {
    pickupPointUpdateRequest.setFbbActivated(true);
    pickupPointUpdateRequest.setNeedCorrection(true);
    pickupPointUpdateRequest.getItemsPickupPoint().get(0).setItemSku(ITEM_SKU);
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    pickupPointRequest.setItemSku(ITEM_SKU_3);
    pickupPointRequest.setPickupPointCode(PICKUP_1);
    pickupPointUpdateRequest.getItemsPickupPoint().add(pickupPointRequest);
    productItemBusinessPartner.setPickupPointId(PICKUP_1);
    productItemBusinessPartner.setId(ID);
    productItemBusinessPartner.setFbbActive(true);
    productSystemParameter1.setValue("false");
    productItemBusinessPartner1.setMarkForDelete(true);
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner1.setPickupPointId(PICKUP);
    productItemBusinessPartner1.setFbbActive(true);
    productItemBusinessPartner2.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner2.setPickupPointId(PICKUP_POINT_CODE);
    productItemBusinessPartner2.setMarkForDelete(true);
    productItemBusinessPartner2.setFbbActive(true);
    ProductItemBusinessPartner productItemBusinessPartner3 = new ProductItemBusinessPartner();
    productItemBusinessPartner3.setGdnProductItemSku(ITEM_SKU_3);
    productItemBusinessPartner3.setMarkForDelete(true);
    productItemBusinessPartner3.setFbbActive(true);
    productCollection.setPostLive(true);
    productCollection.setEdited(true);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductIdAndMarkForDeleteFalse(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerId(DEFAULT_STORE_ID,
        productBusinessPartner.getId())).thenReturn(
        Arrays.asList(productItemBusinessPartner, productItemBusinessPartner1, productItemBusinessPartner2,
            productItemBusinessPartner3));
    WebInventoryBulkUpdatePickupPointCodeResponseDTO dto = new WebInventoryBulkUpdatePickupPointCodeResponseDTO();
    WebInventoryBulkUpdatePickupPointCodeResponseDTO.BulkUpdatePickupPointCodeError error =
        new WebInventoryBulkUpdatePickupPointCodeResponseDTO.BulkUpdatePickupPointCodeError();
    error.setWebItemSku(ITEM_SKU_3);
    dto.setErrors(Arrays.asList(error));
    Mockito.when(inventoryOutbound.updatePickupPoint(any(), any())).thenReturn(updatePickupPointResponse);
    Mockito.when(this.productItemWholesalePriceService.findOneByItemSkuAndPickupPointCode(ITEM_SKU, PICKUP_1))
        .thenReturn(new ProductItemWholesalePrice());
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    Mockito.when(productOutbound.findProductNameByProductItemId(Mockito.any())).thenReturn(NAME);
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    Mockito.verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound).findProductNameByProductItemId(Mockito.any());
    Mockito.verify(productItemBusinessPartnerRepository)
        .findByStoreIdAndProductBusinessPartnerId(DEFAULT_STORE_ID, productBusinessPartner.getId());
    Mockito.verify(this.productItemWholesalePriceService).findOneByItemSkuAndPickupPointCode(ITEM_SKU, PICKUP_1);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductIdAndMarkForDeleteFalse(any(), any());
    Mockito.verify(productItemBusinessPartnerRepository).saveAll(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findOneByItemSkuAndPickupPointCode(ITEM_SKU, PICKUP_1);
    Mockito.verify(updatedProductHistoryService)
        .createProductL3AuditLog(any(), any(), any(), any(), any(), any(),
            any(), anyBoolean(), any());
    Mockito.verify(inventoryOutbound).updatePickupPoint(any(), any());
    Mockito.verify(this.productItemWholesalePriceService)
        .saveWholesalePriceNew(Mockito.anyList());
  }

  @Test
  public void updatePickupPointCodesNeedCorrectionTestMpp() throws Exception {
    productSystemParameter1.setValue("true");
    pickupPointUpdateRequest.setNeedCorrection(true);
    pickupPointUpdateRequest.getItemsPickupPoint().get(0).setItemSku(ITEM_SKU);
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    pickupPointRequest.setItemSku(ITEM_SKU_3);
    pickupPointRequest.setPickupPointCode(PICKUP_1);
    pickupPointUpdateRequest.getItemsPickupPoint().add(pickupPointRequest);
    pickupPointUpdateRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productItemBusinessPartner.setPickupPointId(PICKUP_1);
    productItemBusinessPartner.setId(ID);
    productItemBusinessPartner1.setMarkForDelete(true);
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner1.setPickupPointId(PICKUP);
    productItemBusinessPartner1.setId(ID);
    productItemBusinessPartner2.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner2.setPickupPointId(PICKUP_POINT_CODE);
    productItemBusinessPartner2.setMarkForDelete(true);
    productItemBusinessPartner2.setId(ID);
    ProductItemBusinessPartner productItemBusinessPartner3 = new ProductItemBusinessPartner();
    productItemBusinessPartner3.setGdnProductItemSku(ITEM_SKU_3);
    productItemBusinessPartner3.setMarkForDelete(true);
    productItemBusinessPartner3.setId(ID);
    productCollection.setPostLive(false);
    productCollection.setEdited(true);
    Mockito.when(this.productItemWholesalePriceService.findOneByItemSkuAndPickupPointCode(ITEM_SKU, PICKUP_1))
        .thenReturn(new ProductItemWholesalePrice());
    profileResponse.getCompany().setMerchantType(Constants.CM_MERCHANT);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerId(DEFAULT_STORE_ID,
        productBusinessPartner.getId())).thenReturn(
        Arrays.asList(productItemBusinessPartner, productItemBusinessPartner1, productItemBusinessPartner2,
            productItemBusinessPartner3));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductIdAndMarkForDeleteFalse(any(), any()))
        .thenReturn(productCollection);
    WebInventoryUpdatePickupPointResponseDTO dto = new WebInventoryUpdatePickupPointResponseDTO();
    WebInventoryUpdatePickupPointResponseDTO.UpdatePickupPointError error =
        new WebInventoryUpdatePickupPointResponseDTO.UpdatePickupPointError();
    error.setWebItemSku(ITEM_SKU_3);
    dto.setErrors(Arrays.asList(error));
    Mockito.when(inventoryOutbound.updatePickupPoint(any(), any())).thenReturn(dto);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    Mockito.when(productOutbound.findProductNameByProductItemId(Mockito.any())).thenReturn(NAME);
      Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(profileResponse);
      PickupPointUpdateResponse pickupPointUpdateResponse =
              productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    Mockito.verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound).findProductNameByProductItemId(Mockito.any());
    Mockito.verify(productItemBusinessPartnerRepository)
        .findByStoreIdAndProductBusinessPartnerId(DEFAULT_STORE_ID, productBusinessPartner.getId());
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductIdAndMarkForDeleteFalse(any(), any());
    Mockito.verify(productItemBusinessPartnerRepository).saveAll(anyList());
    Mockito.verify(updatedProductHistoryService)
        .createProductL3AuditLog(any(), any(), any(), any(), any(), any(),
            any(), anyBoolean(), any());
    Mockito.verify(inventoryOutbound).updatePickupPoint(any(), any());
    Mockito.verify(this.productItemWholesalePriceService).findOneByItemSkuAndPickupPointCode(ITEM_SKU, PICKUP_1);
    Mockito.verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(this.productItemWholesalePriceService)
        .saveWholesalePriceNew(Mockito.anyList());
  }

  @Test
  public void getItemSummaryResponseByProductSkuTest() throws Exception {
    itemSummaryResponse.setGeneratedItemName(DEFAULT_ITEM_NAME);
    Mockito.when(productLevel3Repository.findSummaryByFilter(Mockito.any(ItemSummaryRequest.class),
            Mockito.any(PageRequest.class), Mockito.any(SortOrder.class)))
        .thenReturn(new PageImpl<>(Arrays.asList(itemSummaryResponse)));
    Page<ProductItemNameResponse> responses =
        productLevel3ServiceBean.getItemSummaryResponseByProductSku(DEFAULT_PRODUCT_SKU, 0, 10);
    verify(productLevel3Repository).findSummaryByFilter(Mockito.any(ItemSummaryRequest.class),
        Mockito.any(PageRequest.class), Mockito.any(SortOrder.class));
    Assertions.assertEquals(DEFAULT_ITEM_NAME, responses.getContent().get(0).getItemName());
    Assertions.assertEquals(DEFAULT_ITEM_SKU, responses.getContent().get(0).getItemSku());
    Assertions.assertEquals(1, responses.getContent().size());
  }

  @Test
  public void getItemSummaryResponseByProductSkuEmptyResponceTest() throws Exception {
    itemSummaryResponse.setGeneratedItemName(DEFAULT_ITEM_NAME);
    Mockito.when(productLevel3Repository.findSummaryByFilter(Mockito.any(ItemSummaryRequest.class),
        Mockito.any(PageRequest.class), Mockito.any(SortOrder.class))).thenReturn(new PageImpl<>(new ArrayList<>()));
    Page<ProductItemNameResponse> responses =
        productLevel3ServiceBean.getItemSummaryResponseByProductSku(DEFAULT_PRODUCT_SKU, 0, 10);
    verify(productLevel3Repository).findSummaryByFilter(Mockito.any(ItemSummaryRequest.class),
        Mockito.any(PageRequest.class), Mockito.any(SortOrder.class));
    Assertions.assertEquals(0, responses.getContent().size());
  }

  @Test
  public void updateEditInfoWithContentChangeEventTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "convertPreOrderDateToJKT", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().setPreOrder(null);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(true);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    product.setSizeChartCode(SIZE_CHART_CODE);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
      .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, productCollection, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
  }

  @Test
  public void updateEditInfoWithContentChangeEventAttributeResponseNullTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.doThrow(IllegalArgumentException.class).when(this.productLevel3Repository)
        .findDetailByGdnSku(Mockito.any());

    try {
      Assertions.assertThrows(IllegalArgumentException.class, () -> {
        EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
            false, generateProductL3Response(), false, null, null);
      });
    } finally {
      verify(productLevel3Repository).findDetailByGdnSku(Mockito.any());
    }
  }

  @Test
  public void updateEditInfoWithContentChangeEventAttributeNullTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    List<String> promoLabelList = new ArrayList<>();
    promoLabelList.add("TEST-PROMO");
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    productL3Response.setPromoLabels(promoLabelList);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(true);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setProductAttributeValues(new ArrayList());
    productAttribute.setOwnByProductItem(true);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setValue("value1");
    productAttributeValue.setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValue);
    productAttribute.setProductAttributeValues(Arrays.asList(productAttributeValue));
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    ProductAttribute productAttribute2 = new ProductAttribute();
    productAttribute2.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute2.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute2.setProductAttributeName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute2.setOwnByProductItem(true);
    Attribute attribute2 = new Attribute();
    attribute2.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    attribute2.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    attribute2.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute2.setAttribute(attribute2);
    ProductAttributeValue productAttributeValue2 = new ProductAttributeValue();
    productAttributeValue2.setDescriptiveAttributeValue("Value2");
    productAttribute2.setProductAttributeValues(Arrays.asList(productAttributeValue2));
    existingProduct.setProductAttributes(Arrays.asList(productAttribute, productAttribute2));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(null);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    try {
      Assertions.assertThrows(IllegalArgumentException.class, () -> {
        EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
            false, generateProductL3Response(), false, null, null);
      });
    } finally {
      verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
      verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
      verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
          Mockito.any(), Mockito.anyBoolean());
      verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    }
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithPreLiveProductAndConfigurationPostLiveTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    preOrderDTO.setIsPreOrder(false);
    productData.getProduct().setPreOrder(preOrderDTO);
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(true);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection.setPostLive(false);
    configurationStatusResponseList.get(0).setReviewConfig(POST_REVIEW_TYPE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, false, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithPreLiveProductAndConfigurationPostLive_PreOrder_True_Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    preOrderDTO.setIsPreOrder(true);
    preOrderDTO.setPreOrderType("DAYS");
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.HOUR, -7);
    preOrderDTO.setPreOrderDate(calendar.getTime());
    productData.getProduct().setPreOrder(preOrderDTO);
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection.setPostLive(false);
    configurationStatusResponseList.get(0).setReviewConfig(POST_REVIEW_TYPE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, false, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoEmptyItemTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "productSuitabilityFeatureEnabled",
      true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateAttributesByBrandCode", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection.setPostLive(true);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode("BR-M036969");
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(), PageRequest.of(0, 1), 2));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoEmptyItemBrandCodeDoesNotContainTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "productSuitabilityFeatureEnabled",
      false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateAttributesByBrandCode", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    attribute.setHideForSeller(true);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection.setPostLive(true);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(DEFAULT_BRAND);
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(), PageRequest.of(0, 1), 2));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoHideFromSellerTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateAttributesByBrandCode", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "productSuitabilityFeatureEnabled",
      true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    attribute1.setHideForSeller(true);
    attribute.setHideForSeller(true);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection.setPostLive(true);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode("BR-M036969");
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(), PageRequest.of(0, 1), 2));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
      Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
      Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
      this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
        productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
      productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
      itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
      .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
      Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
      eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithHideFromSellerAttributeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "productSuitabilityFeatureEnabled",
      true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().setPreOrder(null);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(true);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setHideForSeller(true);
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    product.setSizeChartCode(SIZE_CHART_CODE);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
      this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
        productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
      .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, productCollection, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
      Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
      eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
      EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
  }

  @Test
  public void updateEditInfoEmptyItemBrandCodeDoesNotContainSizeChartChangedTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateAttributesByBrandCode", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setSizeChartChanged(true);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection.setPostLive(true);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(DEFAULT_BRAND);
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(), PageRequest.of(0, 1), 2));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoEmptyItemValidateByBrandCOdeSwitchOffTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection.setPostLive(true);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode("BR-M036969");
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(), PageRequest.of(0, 1), 2));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }


  @Test
  public void updateEditInfoWithContentChangeEventWithPostLiveProductAndConfigurationPreLiveForTrustedSellerTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection.setPostLive(true);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    businessPartner.setTrustedSeller(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
      Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
      Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
      this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
        productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
      productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
      itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
      .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
      EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithPostLiveProductAndConfigurationForTrustedSellerTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection.setPostLive(false);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    businessPartner.setTrustedSeller(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
      Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
      Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
      this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
        productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
      productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
      itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
      .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
      EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithVariantCreationTrueTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    existingProduct.getProductAttributes().get(0).getAttribute().setVariantCreation(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithVariantCreationFalseTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.setSynchronized(false);
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    existingProduct.getProductAttributes().get(0).getAttribute().setVariantCreation(false);
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DEFINING_ATTRIBUTE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    existingProduct.getProductItems().get(0).setDangerousGoodsLevel(null);
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithDiscriptiveAttributeTypeTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithDescriptiveAttributeTypeTest2() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentCombinedWithLogisticsPreOrder() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "convertPreOrderDateToJKT", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    com.gdn.mta.product.entity.PreOrderDTO preOrderDTO1 = new com.gdn.mta.product.entity.PreOrderDTO();
    preOrderDTO1.setIsPreOrder(true);
    preOrderDTO1.setPreOrderDate(new Date());
    product.setPreOrder(preOrderDTO1);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    doNothing().when(updatedProductHistoryService)
        .createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        true, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).createProductL3AuditLog(Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any()
    ,Mockito.any(),Mockito.any(),Mockito.anyBoolean(),Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentCombinedWithLogisticsPreOrderPreOrderDTONull() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    Date date= new Date();
    preOrderDTO.setPreOrderDate(date);
    preOrderDTO.setPreOrderType("DATE");
    preOrderDTO.setIsPreOrder(null);
    productL3Response.setPreOrderDTO(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    com.gdn.mta.product.entity.PreOrderDTO preOrderDTO1 = new com.gdn.mta.product.entity.PreOrderDTO();
    preOrderDTO1.setIsPreOrder(true);
    preOrderDTO1.setPreOrderType("DATE");
    preOrderDTO1.setPreOrderDate(date);
    product.setPreOrder(preOrderDTO1);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    doNothing().when(updatedProductHistoryService)
        .createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        true, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).createProductL3AuditLog(Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any()
        ,Mockito.any(),Mockito.any(),Mockito.anyBoolean(),Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentCombinedWithLogisticsPreOrderForPreOrderRequestNull() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    Date date= new Date();
    preOrderDTO.setPreOrderDate(date);
    preOrderDTO.setPreOrderType("DATE");
    preOrderDTO.setIsPreOrder(null);
    productL3Response.setPreOrderDTO(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    com.gdn.mta.product.entity.PreOrderDTO preOrderDTO1 = new com.gdn.mta.product.entity.PreOrderDTO();
    preOrderDTO1.setIsPreOrder(true);
    preOrderDTO1.setPreOrderType("DATE");
    preOrderDTO1.setPreOrderDate(date);
    product.setPreOrder(null);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
    verify(productBusinessPartnerService).updateProductMasterData(DEFAULT_PRODUCT_SKU,
      DEFAULT_ITEM_NAME, DEFAULT_CATEGORY_CODE, null, null, USERNAME, false, "brand");
  }

  @Test
  public void updateEditInfoWithContentCombinedWithLogisticsPreOrderForPreOrderRequestNullProject() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    Date date= new Date();
    preOrderDTO.setPreOrderDate(date);
    preOrderDTO.setPreOrderType("DATE");
    preOrderDTO.setIsPreOrder(false);
    productL3Response.setPreOrderDTO(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    com.gdn.mta.product.entity.PreOrderDTO preOrderDTO1 = new com.gdn.mta.product.entity.PreOrderDTO();
    preOrderDTO1.setIsPreOrder(false);
    preOrderDTO1.setPreOrderType("DATE");
    preOrderDTO1.setPreOrderDate(date);
    product.setPreOrder(preOrderDTO1);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);


    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        true,generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }
  @Test
  public void updateEditInfoWithContentCombinedWithLogisticsPreOrderForFalse() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    productL3Response.setPreOrderDTO(new PreOrderDTO());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    com.gdn.mta.product.entity.PreOrderDTO preOrderDTO1 = new com.gdn.mta.product.entity.PreOrderDTO();
    preOrderDTO1.setIsPreOrder(true);
    product.setPreOrder(preOrderDTO1);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        true, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).createProductL3AuditLog(Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any()
        ,Mockito.any(),Mockito.any(),Mockito.anyBoolean(),Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }


  @Test
  public void updateEditInfoWithContentCombinedWithLogisticsPreOrderForFalse1() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    productL3Response.setPreOrderDTO(new PreOrderDTO());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    com.gdn.mta.product.entity.PreOrderDTO preOrderDTO1 = new com.gdn.mta.product.entity.PreOrderDTO();
    preOrderDTO1.setIsPreOrder(true);
    product.setPreOrder(preOrderDTO1);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        true, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).createProductL3AuditLog(Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any()
        ,Mockito.any(),Mockito.any(),Mockito.anyBoolean(),Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentCombinedWithLogisticsPreOrderNull() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "skipDefinitiveAction", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    preOrderDTO.setIsPreOrder(false);
    productL3Response.setPreOrderDTO(preOrderDTO);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    com.gdn.mta.product.entity.VideoAddEditRequest videoAddEditRequest =
      new com.gdn.mta.product.entity.VideoAddEditRequest();
    product.setVideoUpdated(true);
    videoAddEditRequest.setVideoId(URL_VIDEO_EDITED);
    product.setVideoAddEditRequest(videoAddEditRequest);
    product.setProductName(null);
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.setCategoryUpdated(true);
    com.gdn.mta.product.entity.PreOrderDTO preOrderDTO1 = new com.gdn.mta.product.entity.PreOrderDTO();
    preOrderDTO1.setIsPreOrder(false);
    product.setPreOrder(preOrderDTO1);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    product.setProductName(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        true, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithDescriptiveAttributeTypeWithEmptyValueTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    com.gdn.mta.product.entity.VideoAddEditRequest videoAddEditRequest =
      new com.gdn.mta.product.entity.VideoAddEditRequest();
    product.setVideoUpdated(false);
    videoAddEditRequest.setVideoId(URL_VIDEO_EDITED);
    product.setVideoAddEditRequest(videoAddEditRequest);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    businessPartner.setTrustedSeller(true);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    existingProduct.getProductAttributes().get(0).setProductAttributeValues(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(product.getBusinessPartnerCode()))
        .thenReturn(businessPartner);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct =
        this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse, false,
            generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithDescriptiveAttributeTypeWithEmptyValueFalseTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    businessPartner.setTrustedSeller(true);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    existingProduct.getProductAttributes().get(0).setProductAttributeValues(new ArrayList<>());
    ProductCollection productCollection1 = new ProductCollection();
    productCollection1.setProductId(DEFAULT_STORE_ID);
    productCollection1.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productCollection1.setPostLive(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU))).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenThrow(RuntimeException.class);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection1);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection1, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(product.getBusinessPartnerCode()))
        .thenReturn(businessPartner);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(productBusinessPartner);
    try {
      Assertions.assertThrows(RuntimeException.class, () -> {
        EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
            false, generateProductL3Response(), false, null, null);
      });
    }
    finally {
        verify(this.productLevel3Repository).findDetailByGdnSku(Mockito.any());
    }
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithNonDescriptiveAttributeTypeTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValue);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .getPredefinedAllowedAttributeValue().setValue(DEFAULT_ATTRIBUTE_CODE_3);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithNonDescriptiveAttributeTypeWithMandatoryTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(Collections.singletonList(StringUtils.EMPTY));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValue);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .getPredefinedAllowedAttributeValue().setValue(DEFAULT_ATTRIBUTE_CODE_3);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithNonDescriptiveAttributeTypeWithMandatory1Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(new ArrayList<>());
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValue);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .getPredefinedAllowedAttributeValue().setValue(DEFAULT_ATTRIBUTE_CODE_3);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithNonDescriptiveAttributeTypeWithMandatory2Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(null);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValue);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .getPredefinedAllowedAttributeValue().setValue(DEFAULT_ATTRIBUTE_CODE_3);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventProductAttributesValueNullTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(null);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0).setProductAttributeValues(null);
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventProductAttributesValueNull1Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(null);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0).setProductAttributeValues(null);
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventProductAttributesValueNull2Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(null);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    predefinedAllowedAttributeValue.setValue("-");
    productAttributeValue.setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValue);
    existingProduct.getProductAttributes().get(0).setProductAttributeValues(Arrays.asList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventProductAttributesValueNull3Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(null);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue("-");
    existingProduct.getProductAttributes().get(0).setProductAttributeValues(Arrays.asList(productAttributeValue));
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithNonDescriptiveAttributeTypeWithMandatory3Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setValues(null);
    product.getAttributes().get(0).setMandatory(true);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    attribute1.setMandatory(true);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValue);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .getPredefinedAllowedAttributeValue().setValue(DEFAULT_ATTRIBUTE_CODE_3);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());

    try {
      Assertions.assertThrows(ApplicationException.class, () -> {
        EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
            false, generateProductL3Response(), false, null, null);
      });
    } catch (Exception e) {
      throw e;
    } finally {
      verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
      verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    }
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithNonDescriptiveAttributeTypeWithMandatory4NewAttributeTest()
      throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.getAttributes().get(0).setAttributeCode("name");
    product.getAttributes().get(0).setValues(null);
    product.getAttributes().get(0).setMandatory(true);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    attribute1.setMandatory(true);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    PredefinedAllowedAttributeValue predefinedAllowedAttributeValue = new PredefinedAllowedAttributeValue();
    predefinedAllowedAttributeValue.setPredefinedAllowedAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValue);
    existingProduct.getProductAttributes().get(0).getProductAttributeValues().get(0)
        .getPredefinedAllowedAttributeValue().setValue(DEFAULT_ATTRIBUTE_CODE_3);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    attribute.setMandatory(true);
    when(productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);

    try {
      Assertions.assertThrows(ApplicationException.class, () -> {
        EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
            false, generateProductL3Response(), false, null, null);
      });
    } catch (Exception e) {
      throw e;
    } finally {
      verify(productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
      verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
      verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    }
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithDiscriptiveAttributeTypeTest3() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    attribute.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithDiscriptiveAttributeTypeTest4() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "addDeleteVariantSwitch", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    attribute1.setVariantCreation(true);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    attribute.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    attribute.setVariantCreation(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    AttributeResponse attributeResponse = new AttributeResponse();
    attributeResponse.setAttributeCode(PRODUCT_CODE);
    attributeResponse.setVariantCreation(true);
    attributeResponse.setSkuValue(false);
    attributeResponse.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    when(productOutbound.getAttributeDetailByAttributeCode(PRODUCT_CODE)).thenReturn(attributeResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    ProductLevel3Attribute productLevel3Attribute = new ProductLevel3Attribute();
    productLevel3Attribute.setAttributeCode(PRODUCT_CODE);
    productLevel3Attribute.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    productLevel3Attribute.setVariantCreation(true);
    productLevel3Attribute.setValues(Collections.singletonList(PRODUCT_USP1));
    productLevel3Attribute.setSkuValue(false);
    product.getAttributes().add(productLevel3Attribute);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getAttributeDetailByAttributeCode(PRODUCT_CODE);
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentChangeEventWithDiscriptiveAttributeTypeValidateByBrandTest4() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "addDeleteVariantSwitch", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateAttributesByBrandCode", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    attribute1.setVariantCreation(true);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    attribute.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    attribute.setVariantCreation(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    AttributeResponse attributeResponse = new AttributeResponse();
    attributeResponse.setAttributeCode(PRODUCT_CODE);
    attributeResponse.setVariantCreation(true);
    attributeResponse.setSkuValue(false);
    attributeResponse.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    when(productOutbound.getAttributeDetailByAttributeCode(PRODUCT_CODE)).thenReturn(attributeResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);

    ProductLevel3Attribute productLevel3Attribute = new ProductLevel3Attribute();
    productLevel3Attribute.setAttributeCode(PRODUCT_CODE);
    productLevel3Attribute.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    productLevel3Attribute.setVariantCreation(true);
    productLevel3Attribute.setValues(Collections.singletonList(PRODUCT_USP1));
    productLevel3Attribute.setSkuValue(false);
    product.getAttributes().add(productLevel3Attribute);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getAttributeDetailByAttributeCode(PRODUCT_CODE);
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventAndRestrictedKeywordTest() throws Exception {
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(StringUtils.EMPTY);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setSynchronized(false);
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(STOREID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventAndRestrictedKeywordAutoRejectTest() throws Exception {
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(StringUtils.EMPTY);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setSynchronized(false);
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(STOREID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType.setAction(3);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventAndRestrictedKeywordAutoRejectTest2() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "skipDefinitiveAction", true);
    RestrictedKeywordsByField restrictedKeywordsByField =  new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.emptyList());
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(StringUtils.EMPTY);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setSynchronized(false);
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(STOREID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType.setAction(3);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
      Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(
      this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
        productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
      productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
      itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
      .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
      Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
      Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean());
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoRestrictedKeywordAutoCategoryChangeSameDestinationTest() throws Exception {
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType
        .setAction(RestrictedKeywordActionType.CHANGE_CATEGORY_AND_AUTO_APPROVE.getRestrictedKeywordActionType());
    restrictedKeywordsByFieldAndActionType
        .setRestrictedKeywordsByFieldList(Arrays.asList(new RestrictedKeywordsByField()));
    restrictedKeywordsByFieldAndActionType.setCategoryRestrictedKeywordId(CATEGORY_RESTRICTED_ID);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(StringUtils.EMPTY);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setSynchronized(false);
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(STOREID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false))
        .thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType
        .setAction(RestrictedKeywordActionType.CHANGE_CATEGORY_AND_AUTO_APPROVE.getRestrictedKeywordActionType());
    Mockito.when(this.productLevel3Helper
        .getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(this.productService
        .publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT, productCollection,
            null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE))
        .thenReturn(new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository
        .findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(), pageableArgumentCaptor.capture(),
            sortOrderArgumentCaptor.capture()))
        .thenReturn(new PageImpl<>(Collections.singletonList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound
        .getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(), Mockito.any(), Mockito.anyBoolean()))
        .thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture()))
        .thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(this.productOutbound
        .migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any()))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService
        .getMerchantModifiedFields(any(), any()))
        .thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setDestinationCategory(product.getCategoryCode());
    when(productRepository.getCategoryRestrictedKeywordDetail(CATEGORY_RESTRICTED_ID))
        .thenReturn(categoryRestrictedKeywordResponse);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(productRepository).getCategoryRestrictedKeywordDetail(CATEGORY_RESTRICTED_ID);
    verify(this.productLevel3Helper)
        .getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound)
        .getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES)
        .convertFromProductLevel3Detail(Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    verify(updatedProductHistoryService)
        .getMerchantModifiedFields(any(), any());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoRestrictedKeywordAutoCategoryNewSameDestinationTest() throws Exception {
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<>();
    productBusinessPartners.add(productBusinessPartner);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType
        .setAction(RestrictedKeywordActionType.CHANGE_CATEGORY_AND_AUTO_APPROVE.getRestrictedKeywordActionType());
    restrictedKeywordsByFieldAndActionType
        .setRestrictedKeywordsByFieldList(Arrays.asList(new RestrictedKeywordsByField()));
    restrictedKeywordsByFieldAndActionType.setCategoryRestrictedKeywordId(CATEGORY_RESTRICTED_ID);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(StringUtils.EMPTY);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setSynchronized(false);
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(STOREID);
    product.setSizeChartCode(SIZE_CHART_CODE);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setCategoryName(CATEGORY_NAME);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false))
        .thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    configurationStatusRequest.setCategoryCode(productCollection.getCategoryCode());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType
        .setAction(RestrictedKeywordActionType.CHANGE_CATEGORY_AND_AUTO_APPROVE.getRestrictedKeywordActionType());
    Mockito.when(this.productLevel3Helper
        .getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(this.productService
        .publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT, productCollection,
            null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE))
        .thenReturn(new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository
        .findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(), pageableArgumentCaptor.capture(),
            sortOrderArgumentCaptor.capture()))
        .thenReturn(new PageImpl<>(Collections.singletonList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound
        .getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(), Mockito.any(), Mockito.anyBoolean()))
        .thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture()))
        .thenReturn(productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(this.productOutbound
        .migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any()))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService
        .getMerchantModifiedFields(any(), any()))
        .thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setDestinationCategory(productCollection.getCategoryCode());
    when(productRepository.getCategoryRestrictedKeywordDetail(CATEGORY_RESTRICTED_ID))
        .thenReturn(categoryRestrictedKeywordResponse);
    CategoryResponse categoryResponse = new CategoryResponse();
    categoryResponse.setCategoryCode(productCollection.getCategoryCode());
    categoryResponse.setName(CATEGORY_NAME);
    when(productOutbound.getCategoryBasicDetailByCategoryCode(productCollection.getCategoryCode()))
        .thenReturn(categoryResponse);
    when(productBusinessPartnerService.findByStoreIdAndProductId(any(), any()))
        .thenReturn(productBusinessPartners);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productOutbound).getCategoryBasicDetailByCategoryCode(productCollection.getCategoryCode());
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(productRepository).getCategoryRestrictedKeywordDetail(CATEGORY_RESTRICTED_ID);
    verify(this.productLevel3Helper)
        .getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound)
        .getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);

    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES)
        .convertFromProductLevel3Detail(Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    verify(updatedProductHistoryService)
        .getMerchantModifiedFields(any(), any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Mockito.verify(this.kafkaProducer).send(eq(DomainEventName.PRODUCT_INTERNAL_HISTORY_SAVE), any(),
        any(InternalProductHistoryEventModel.class));
    Mockito.verify(this.kafkaProducer)
        .send(eq(ProductDomainEventName.PRODUCT_SKU_UPDATE_HISTORY), any(), any(AuditTrailListRequest.class));
    Mockito.verify(productBusinessPartnerService).findByStoreIdAndProductId(any(), any());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }



  @Test
  public void updateEditInfoWithContentRefreshEventAndRestrictedKeywordAutoNeedRevisionTest() throws Exception {
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(StringUtils.EMPTY);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setSynchronized(false);
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(STOREID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    businessPartner.setTrustedSeller(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType.setAction(2);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventAndRestrictedKeywordAutoNeedRevisionFalseTest() throws Exception {
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
      Collections.emptyList());
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(StringUtils.EMPTY);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setSynchronized(false);
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(STOREID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    businessPartner.setTrustedSeller(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType.setAction(2);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
      Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(
      this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
        productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
      productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
      itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
      .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
      Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
      Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    Assertions.assertTrue(updatedProduct.isProductReview());
    verify(productBusinessPartnerService).updateProductMasterData(DEFAULT_PRODUCT_SKU,
      DEFAULT_ITEM_NAME, DEFAULT_CATEGORY_CODE, null, null, USERNAME, false,"brand");
  }

  @Test
  public void updateEditInfoWithContentRefreshEventWithContentUpdateTrueTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setSynchronized(false);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setSkuValue(true);
    product.getAttributes().get(0).setValues(Collections.singletonList("Changed"));
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(DEFAULT_STORE_ID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    productData.getProduct().getMasterDataProduct().setUrl(UPDATING_REJECTED_ITEM);
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(true);
    configurationStatusResponseList.get(0).setReviewConfig("Pre-live");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_REFRESH, productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_REFRESH, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentEditEventWithContentEventPublishTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setSynchronized(false);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(DEFAULT_STORE_ID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    productData.getProduct().getMasterDataProduct().setUrl(UPDATING_REJECTED_ITEM);
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(true);
    configurationStatusResponseList.get(0).setReviewConfig("Pre-live");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_REFRESH, productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    ProductItemLevel3 productItemLevel3 = new ProductItemLevel3();
    product.setNewlyAddedItems(Collections.singletonList(productItemLevel3));
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }


  @Test
  public void updateEditInfoWithContentEditEventWithContentEventPublishTest2() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setSynchronized(false);
    productL3Response.setVersion(null);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(DEFAULT_STORE_ID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    productData.getProduct().getMasterDataProduct().setUrl(UPDATING_REJECTED_ITEM);
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(true);
    configurationStatusResponseList.get(0).setReviewConfig(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
      EditedReviewTypeConstants.CONTENT_REFRESH, productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
      productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
      itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
      .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    ProductItemLevel3 productItemLevel3 = new ProductItemLevel3();
    product.setNewlyAddedItems(Collections.singletonList(productItemLevel3));
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
      Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
      EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithReviewPendingFalseTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setSkuValue(true);
    product.getAttributes().get(0).setValues(Collections.singletonList("Changed"));
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(DEFAULT_STORE_ID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    productData.getProduct().getMasterDataProduct().setUrl(UPDATING_REJECTED_ITEM);
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(false);
    configurationStatusResponseList.get(0).setReviewConfig("Pre-live");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventWithContentUpdateTrueForSpecialAttributesTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setSkuValue(true);
    product.getAttributes().get(0).setValues(Collections.singletonList("Existing"));
    product.getAttributes().get(0).setAttributeCode("AT-0000002");
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    productData.getProduct().getDescriptiveAttributes().get(1).setAttributeValue("Changed");
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(true);
    configurationStatusResponseList.get(0).setReviewConfig("Post-live");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    when(productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(xProductOutbound.updateProduct(eq(true), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(true), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventWithContentUpdateTrueForSpecialAttributesTest2() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setSkuValue(true);
    product.getAttributes().get(0).setValues(Collections.singletonList("Existing"));
    product.getAttributes().get(0).setAttributeCode("AT-0000002");
    product.setVersion(2L);
    ProductAttributeDTO productAttr = new ProductAttributeDTO();
    ProductAttributeDetailDTO productAttributeDetail = new ProductAttributeDetailDTO();
    productAttributeDetail.setAttributeCode("AT-0000002");
    productAttributeDetail.setAttributeValue("Exiting Value");
    productAttr.setProductAttributeDetails(Collections.singletonList(productAttributeDetail));
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    product.getAttributes().get(0).setValues(Collections.singletonList("Existing"));
    savedProductData.getProduct().getProductAttributes().get(0).setProductAttributeDetails(Collections.emptyList());
    productData.getProduct().getDescriptiveAttributes().get(0).setAttributeValue("Changed");
    productData.getProduct().setDefiningAttributes(Collections.emptyList());

    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(true);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    ProductLevel3Attribute productLevel3Attribute = new ProductLevel3Attribute();
    productLevel3Attribute.setAttributeCode("AT-0000002");
    productLevel3Attribute.setValues(Collections.singletonList("Existing Value"));
    product.setAttributes(Collections.singletonList(productLevel3Attribute));
    savedProductData.getProduct().setProductAttributes(Collections.singletonList(productAttr));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    when(productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(xProductOutbound.updateProduct(eq(true), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(true), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(productBusinessPartner);
    when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(Collections.singletonList(itemSummaryDetailResponse),Collections.emptyList(),null)).thenReturn(new ProductBusinessPartnerAndItemViewConfigDto());
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
      Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerService).updateProductItemBusinessPartnerStateTakeDownTrue(
      Collections.singletonList(itemSummaryDetailResponse), Collections.emptyList(), null);
    verify(productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventWithContentUpdateTrueForSpecialAttributesEmptyTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setSkuValue(true);
    product.getAttributes().get(0).setValues(Collections.emptyList());
    product.getAttributes().get(0).setAttributeCode("AT-0000002");
    product.setVersion(2L);
    ProductAttributeDTO productAttr = new ProductAttributeDTO();
    ProductAttributeDetailDTO productAttributeDetail = new ProductAttributeDetailDTO();
    productAttributeDetail.setAttributeCode("AT-0000002");
    productAttributeDetail.setAttributeValue("");
    productAttr.setProductAttributeDetails(Collections.singletonList(productAttributeDetail));
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    product.getAttributes().get(0).setValues(Collections.emptyList());
    savedProductData.getProduct().getProductAttributes().get(0).setProductAttributeDetails(Collections.emptyList());
    productData.getProduct().getDescriptiveAttributes().get(0).setAttributeValue("");
    productData.getProduct().setDefiningAttributes(Collections.emptyList());
    product.getAttributes().get(0).setValues(Collections.emptyList());

    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(true);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    ProductLevel3Attribute productLevel3Attribute = new ProductLevel3Attribute();
    productLevel3Attribute.setAttributeCode("AT-0000002");
    productLevel3Attribute.setValues(Collections.singletonList("Existing Value"));
    product.setAttributes(Collections.singletonList(productLevel3Attribute));
    savedProductData.getProduct().setProductAttributes(Collections.singletonList(productAttr));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    when(productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(xProductOutbound.updateProduct(eq(true), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(true), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(productBusinessPartner);
    when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(Collections.singletonList(itemSummaryDetailResponse),Collections.emptyList(),null)).thenReturn(new ProductBusinessPartnerAndItemViewConfigDto());
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
      Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
      eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerService).updateProductItemBusinessPartnerStateTakeDownTrue(
      Collections.singletonList(itemSummaryDetailResponse), Collections.emptyList(), null);
    verify(productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }



  @Test
  public void updateEditInfoWithContentRefreshEventWithContentUpdateTrueForAttributesEmptyTest() throws Exception {
      ProductAndItemsResponse productData = generateProductData();
      ProductL3Response productL3Response = generateProductL3Response();
      productL3Response.getMasterDataProduct().setBrand(BRAND);
      productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
      productL3Response.setVersion(null);
      productL3Response.setSynchronized(false);
      ProductLevel3 product = generateProductLevel3ForProductEditInfo();
      product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
      product.getAttributes().get(0).setMandatory(true);
      product.getAttributes().get(0).setSkuValue(true);
      product.getAttributes().get(0).setValues(Collections.singletonList("Existing"));
      product.getAttributes().get(0).setAttributeCode("AT-0000002");
      product.setVersion(2L);
      ProductAttributeDTO productAttr = new ProductAttributeDTO();
      ProductAttributeDetailDTO productAttributeDetail = new ProductAttributeDetailDTO();
      productAttributeDetail.setAttributeCode("AT-0000002");
      productAttributeDetail.setAttributeValue("Exiting Value");
      productAttr.setProductAttributeDetails(Collections.emptyList());
      product.setProductEditable(true);
      product.setSynchronize(false);
      product.setId(DEFAULT_STORE_ID);
      ProductAndItemsResponse savedProductData = generateProductData();
      ProfileResponse businessPartner = getProfileResponse();
      Product existingProduct = generateProduct();
      productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
      productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
      productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
      product.getAttributes().get(0).setValues(Collections.emptyList());
      savedProductData.getProduct().getProductAttributes().get(0).setProductAttributeDetails(Collections.emptyList());
      productData.getProduct().getDescriptiveAttributes().get(0).setAttributeValue("Changed");
      productData.getProduct().setDefiningAttributes(Collections.emptyList());

      addEditedProductToPDTEvent.setPostLive(true);
      productCollection.setProductId(DEFAULT_STORE_ID);
      productCollection.setReviewPending(true);
      configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    ProductLevel3Attribute productLevel3Attribute = new ProductLevel3Attribute();
    productLevel3Attribute.setAttributeCode("AT-0000002");
    productLevel3Attribute.setValues(Collections.emptyList());
    product.setAttributes(Collections.singletonList(productLevel3Attribute));

    ProductLevel3Attribute savedProductLevel3Attribute = new ProductLevel3Attribute();
    savedProductLevel3Attribute.setAttributeCode("AT-0000002");
    savedProductLevel3Attribute.setValues(Collections.singletonList("Old Value"));
      savedProductData.getProduct().setProductAttributes(Collections.singletonList(productAttr));
      Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
      Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
      when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
      when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

      Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
      Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
      when(productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);
      when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
      Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
      Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
      Mockito.when(xProductOutbound.updateProduct(eq(true), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
      Mockito.when(xProductOutbound.updateItem(eq(true), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));

      EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

      verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
      verify(productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
      verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
      verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
      verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
      verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
      Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
      Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventWithContentUpdateTrueForSpecialAttributesEmpty2Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setSkuValue(true);
    product.getAttributes().get(0).setVariantCreation(false);
    product.getAttributes().get(0).setValues(Collections.singletonList(null));
    product.getAttributes().get(0).setAttributeCode("AT-0000002");
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    productData.getProduct().getDescriptiveAttributes().get(1).setAttributeValue("Changed");
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(true);
    configurationStatusResponseList.get(0).setReviewConfig(PRE_REVIEW_TYPE);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(xProductOutbound.updateProduct(eq(true), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(true), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));

    Mockito.when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_2)).thenReturn(
      AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_2).attributeType(
        "PREDEFINED").build());
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(DEFAULT_STORE_ID);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
      Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(),
      Mockito.anyBoolean(), any(), any(), Mockito.any(EditProductResponse.class));
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
      Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(DEFAULT_ATTRIBUTE_CODE_2, "-", false);
    Assertions.assertFalse(updatedProduct.isProductReview());
  }


  @Test
  public void updateEditInfoWithContentRefreshEventWithReviewPendingFalseTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    productL3Response.setSynchronized(false);

    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setSkuValue(true);
    product.getAttributes().get(0).setValues(Collections.singletonList("Changed"));
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(DEFAULT_STORE_ID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    productData.getProduct().getMasterDataProduct().setUrl(UPDATING_REJECTED_ITEM);
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(false);
    configurationStatusResponseList.get(0).setReviewConfig("Pre-live");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    product.setUrl("URL");
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
    verify(productBusinessPartnerService).updateProductMasterData(DEFAULT_PRODUCT_SKU,
      DEFAULT_ITEM_NAME, DEFAULT_CATEGORY_CODE, null, null, USERNAME, false,"brand");
  }

  @Test
  public void updateItemsPriceStockImagesImageRefreshTestForNull() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(PRODUCT_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(UPDATE);
    productPriceStockAndImagesRequest.setProductCode(PRODUCT_CODE);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(PRODUCT_CODE));
    productCollection.setReviewPending(true);
    productCollection.setReviewType("IMAGE");
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(DEFAULT_STORE_ID,
        productPriceStockAndImagesRequest.getItemSku())).thenReturn(productItemBusinessPartner);
    when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(productPriceStockAndImagesRequests,
        failedRequests, itemSummaryResponseMap)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(null);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID, productPriceStockAndImagesRequests,
        DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true, new ProductL3Response());
    Mockito.verify(productLevel3Repository)
        .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
            Mockito.any(SortOrder.class));
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(productPriceStockAndImagesRequests,
        failedRequests, itemSummaryResponseMap);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound).getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
        .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
        .saveUpdateProductLevel3Audit(any(), any(), any(),
            any(), any(), Mockito.any(), Mockito.any(),
            Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(updatedProductHistoryService, times(1))
        .createProductL3AuditLog(any(), any(), any(), any(), any(), any(),
            any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(productOutbound).updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    verify(variantEditValidationService).validatePriceLockCampaignRequest(productPriceStockAndImagesRequests.get(0),
        failedRequests);
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(), Mockito.anyBoolean());
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Mockito.verify(kafkaProducer).send(eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
        addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Assertions.assertEquals("IMAGE_REFRESH",
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getReviewTypes());
  }

  @Test
  public void updateImagesApiErrorCodeSynchronisedProductTest() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(true);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode("INTERNAL");
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageUpdated(true)
            .imagePath(DEFAULT_LOCATION_PATH).build();
    ItemImageEditRequest itemImageEditRequest = new ItemImageEditRequest();
    itemImageEditRequest.setMarkForDelete(true);
    productImageEditRequest.setProductItems(Arrays.asList(itemImageEditRequest));
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    List<ConfigurationStatusResponse> configurationStatusResponses =
        Arrays.asList(new ConfigurationStatusResponse(MERCHANT_CODE_1, CATEGORY_CODE, POST_REVIEW_TYPE));
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType("gold");
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(null);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
  }

  @Test
  public void updateEditInfoWithContentRefreshEventWithReviewPendingFalseSpecialAttribueChangeTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(null);
    productL3Response.setSynchronized(false);

    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setSkuValue(true);
    product.getAttributes().get(0).setValues(Collections.singletonList("Changed"));
    product.setVersion(2L);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setUrl(null);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    existingProduct.getProductItems().get(0).setDangerousGoodsLevel(0);
    productData.getProduct().getMasterDataProduct().setProductName(product.getProductName());
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint(product.getUniqueSellingPoint());
    productData.getProduct().getMasterDataProduct().setDescription(product.getDescription());
    productData.getProduct().getMasterDataProduct().setUrl(null);
    addEditedProductToPDTEvent.setPostLive(true);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(false);
    configurationStatusResponseList.get(0).setReviewConfig("Post-live");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventTest() throws Exception {
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_REFRESH);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.capture());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithContentRefreshEventWithExceptionWithGetReviewConfigurationTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(1L);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setVersion(2L);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenThrow(RuntimeException.class);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_REFRESH, productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageableArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(
        productBusinessPartner);
    doNothing().when(xProductOutbound).updateItemViewConfigAndForceReview(booleanArgumentCaptor.capture(),
        itemViewConfigRequestArgumentCaptor.capture(), eq(false));
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE);
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditInfoWithProductEditableFalseTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    savedProductData.getProduct().setId(DEFAULT_STORE_ID);
    savedProductData.setItems(productData.getItems());
    savedProductData.getProduct().setId(DEFAULT_STORE_ID);
    ProductLevel3 product = generateProductLevel3();
    product.setId(DEFAULT_STORE_ID);
    product.setStoreId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    product.setProductEditable(false);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ItemResponse itemResponse = new ItemResponse();
    itemResponse.setItemSku(DEFAULT_GDN_SKU);
    itemResponse.setMerchantCode(MERCHANT_CODE_1);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU))).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(xProductOutbound.updateProduct(eq(true), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(true), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, false, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(true), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(eq(true), eq(false), eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(true), eq(false), eq(false), Mockito.any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertTrue(StringUtils.isEmpty(updatedProduct.getReviewType()));
    Assertions.assertFalse(updatedProduct.isProductReview());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  private ProductAndItemsResponse generateProductAndItemsResponse() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(PRODUCT_NAME);
    savedProductData.getProduct().getMasterDataProduct().setBrand(BRAND);
    savedProductData.getProduct().getMasterDataProduct().getMasterDataProductImages().get(0)
        .setLocationPath(DEFAULT_LOCATION_PATH);
    savedProductData.getItems().get(0).getMasterDataItem().getMasterDataItemImages().get(0)
        .setLocationPath(DEFAULT_LOCATION_PATH);
    savedProductData.getProduct().setId(STOREID);
    savedProductData.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    return savedProductData;
  }

  @Test
  public void updateEditInfoWithBrandChangeTest() throws Exception {
    String errorMessage = StringUtils.EMPTY;
    ProductL3Response productL3Response = generateProductL3Response();
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setProductEditable(true);
    product.setSynchronize(true);
    productL3Response.getMasterDataProduct().setBrand(DEFAULT_BRAND);
    when(productLevel3Repository.findDetailByGdnSku(Mockito.any())).thenAnswer(invocation -> {
      throw new ApplicationRuntimeException(ErrorCategory.VALIDATION);
    });
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));

    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
            false, generateProductL3Response(), false, null, null);
      });
    } finally {
      verify(this.productLevel3Repository).findDetailByGdnSku(Mockito.any());
    }
  }

  public ProductLevel3 generateProductLevel3ForProductEditInfo() throws Exception {
    ProductLevel3 product = generateProductLevel3();
    product.setUpdatedBy(DEFAULT_USER_NAME);
    product.setUpdatedDate(new Date());
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    product.setBrand(BRAND);
    product.setCategoryCode(CATEGORY_CODE);
    product.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    product.setStoreId(DEFAULT_STORE_ID);
    product.setProductSku(DEFAULT_PRODUCT_SKU);
    product.setPreOrder(new com.gdn.mta.product.entity.PreOrderDTO());
    return product;
  }

  @Test
  public void getL3DetailByProductSkuTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    profileResponse.setCompany(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.when(
            productLevel3LogisticsService.findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Arrays.asList(new ProductLevel3Logistics()));
    ProductLevel3DetailResponse productLevel3Detail = productLevel3ServiceBean
        .getL3DetailByProductSku(DEFAULT_PRODUCT_SKU, false, true,
            Arrays.asList(new PickupPointDeleteRequest(ITEM_SKU, PICKUP_POINT_CODE)), false);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService)
        .findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, productLevel3Detail.getProductSku());
    Assertions.assertEquals(PREORDER_VALUE, productLevel3Detail.getPreOrder().getPreOrderValue());
  }

  @Test
  public void getL3DetailByProductSku_withNullMerchantDeliverTypeTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setMarkForDelete(true);
    savedProductData.setMasterDataProduct(null);
    savedProductData.setDefiningAttributes(null);
    savedProductData.setDescriptiveAttributes(null);
    savedProductData.setProductSpecialAttributes(null);
    savedProductData.setProductScore(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setMerchantDeliveryType(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    ProductLevel3DetailResponse productLevel3Detail =
        productLevel3ServiceBean.getL3DetailByProductSku(DEFAULT_PRODUCT_SKU, false, true, new ArrayList<>(), false);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, productLevel3Detail.getProductSku());
  }

  @Test
  public void getL3DetailByProductSkuNeedRevisionTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Arrays.asList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    ProductLevel3DetailResponse productLevel3Detail =
        productLevel3ServiceBean.getL3DetailByProductSku(DEFAULT_PRODUCT_SKU, true, true, new ArrayList<>(), false);
    verify(productCollectionRepository).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, productLevel3Detail.getProductSku());
    Assertions.assertEquals(PREORDER_VALUE, productLevel3Detail.getPreOrder().getPreOrderValue());
    Assertions.assertEquals(1, productLevel3Detail.getItemCount(), 0);
  }

  @Test
  public void getL3DetailByProductSkuNeedRevisionTest2() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Arrays.asList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    ProductLevel3DetailResponse productLevel3Detail = productLevel3ServiceBean
        .getL3DetailByProductSku(DEFAULT_PRODUCT_SKU, true, true, Arrays.asList(new PickupPointDeleteRequest("", "")),
            true);
    verify(productCollectionRepository).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, productLevel3Detail.getProductSku());
    Assertions.assertEquals(PREORDER_VALUE, productLevel3Detail.getPreOrder().getPreOrderValue());
    Assertions.assertEquals(1, productLevel3Detail.getItemCount());
  }

  @Test
  public void getL3DetailByProductSkuNeedRevisionExceptionTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_NAME);
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU_2);
    productItemBusinessPartner1.setMarkForDelete(true);
    productItemBusinessPartner1.setPickupPointId(PICKUP_POINT_NAME);
    productBusinessPartner
        .setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner, productItemBusinessPartner1));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Arrays.asList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    try {
    } finally {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        ProductLevel3DetailResponse productLevel3Detail = productLevel3ServiceBean
            .getL3DetailByProductSku(DEFAULT_PRODUCT_SKU, true, true,
                Arrays.asList(new PickupPointDeleteRequest(PICKUP_POINT_NAME, ITEM_SKU)), false);
      });
      {
        verify(productCollectionRepository).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
        verify(productOutbound).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
        verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
        verify(productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      }
    }
  }

  @Test
  public void saveNeedCorrectionChangesInPCBTest() throws Exception {
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(new byte[1]);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Arrays.asList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(Mockito.anyString())).thenReturn(PRODUCT_CODE);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false))
        .thenReturn(new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(null);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound
        .getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(), Mockito.any(), Mockito.anyBoolean()))
        .thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(this.updateProductItemLevel3ModelConverter
        .convertFromProductAndItemsResponse(Mockito.any(ProductAndItemsResponse.class)))
        .thenReturn(new UpdateProductItemLevel3Model());
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(Mockito.any(ProductLevel3Summary.class)))
        .thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productService
        .publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT, productCollection,
            null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any()))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.anyString()))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.updateProductItemLevel3ModelConverter
        .convertFromProductLevel3(Mockito.any(ProductLevel3.class), Mockito.anyBoolean()))
        .thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.updateProductItemLevel3ModelConverter
        .convertFromProductLevel3Detail(Mockito.any(ProductLevel3DetailResponse.class), Mockito.anyBoolean()))
        .thenReturn(new UpdateProductItemLevel3Model());
    product.setOff2OnChannelActive(true);
    productLevel3ServiceBean.saveNeedCorrectionChangesInPCB(product, new ArrayList<>(), false, new ProductL3Response(), null, productCollection);
    verify(getCategoryRepository(),Mockito.times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound)
        .getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(), Mockito.any(), Mockito.anyBoolean());
//    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(), any());
    verify(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(),
            any(), any(), anyBoolean(), anyString());
    verify(productOutbound, times(2)).getProductDetailByProductCode(Mockito.anyString(), Mockito.anyBoolean(), Mockito.anyBoolean());
    verify(productOutbound).getAttributeDetailByAttributeCode(Mockito.anyString());
    verify(productOutbound)
        .getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
  }

  @Test
  public void getL3DetailByProductSkuDataNeedRevisionTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    ProductItemBusinessPartner partner = new ProductItemBusinessPartner();
    partner.setGdnProductItemSku(ITEM_SKU);
    partner.setPickupPointId("-");
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner, partner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    productBusinessPartner.setCategoryCode(DEFAULT_CATEGORY_CODE);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setLength(10.0);
    productDetailResponse.setProductAttributeResponses(new ArrayList<>());
    productDetailResponse.setImages(new ArrayList<>());
    productDetailResponse.getImages().add(new Image(true, DEFAULT_LOCATION_PATH, 1));
    productDetailResponse.setProductAttributeResponses(new ArrayList<>());
    ProductAttributeResponse productAttributeResponse = new ProductAttributeResponse();
    productAttributeResponse.setProductAttributeValues(new ArrayList<>());
    AttributeResponse attributeResponse = new AttributeResponse();
    attributeResponse.setAttributeType(DEFAULT_ATTRIBUTE_TYPE);
    attributeResponse.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attributeResponse.setName("Color");
    attributeResponse.setSkuValue(false);
    ProductAttributeValueResponse productAttributeValueResponse = new ProductAttributeValueResponse();
    PredefinedAllowedAttributeValueResponse predefinedAllowedAttributeValueResponse =
        new PredefinedAllowedAttributeValueResponse();
    predefinedAllowedAttributeValueResponse.setValue("Orange");
    productAttributeValueResponse.setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValueResponse);
    productAttributeResponse.setAttribute(attributeResponse);
    productAttributeResponse.getProductAttributeValues().add(productAttributeValueResponse);
    productDetailResponse.getProductAttributeResponses().add(productAttributeResponse);

    ProductAttributeResponse productAttributeResponse1 = new ProductAttributeResponse();
    productAttributeResponse1.setProductAttributeValues(new ArrayList<>());
    AttributeResponse attributeResponse1 = new AttributeResponse();
    attributeResponse1.setAttributeType(DEFAULT_ATTRIBUTE_TYPE_2);
    attributeResponse1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    attributeResponse1.setName("RAM");
    attributeResponse1.setSkuValue(false);
    ProductAttributeValueResponse productAttributeValueResponse1 = new ProductAttributeValueResponse();
    productAttributeValueResponse1.setDescriptiveAttributeValue("10GB");
    productAttributeResponse1.setAttribute(attributeResponse1);
    productAttributeResponse1.getProductAttributeValues().add(productAttributeValueResponse1);
    productDetailResponse.getProductAttributeResponses().add(productAttributeResponse1);

    ProductAttributeResponse productAttributeResponse2 = new ProductAttributeResponse();
    productAttributeResponse2.setProductAttributeValues(new ArrayList<>());
    AttributeResponse attributeResponse2 = new AttributeResponse();
    attributeResponse2.setAttributeType(DEFAULT_ATTRIBUTE_TYPE_3);
    attributeResponse2.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    attributeResponse2.setName("OS");
    attributeResponse2.setSkuValue(false);
    ProductAttributeValueResponse productAttributeValueResponse2 = new ProductAttributeValueResponse();
    AllowedAttributeValueResponse allowedAttributeValueResponse = new AllowedAttributeValueResponse();
    allowedAttributeValueResponse.setValue("Windows");
    productAttributeValueResponse2.setAllowedAttributeValue(allowedAttributeValueResponse);
    productAttributeResponse2.setAttribute(attributeResponse2);
    productAttributeResponse2.getProductAttributeValues().add(productAttributeValueResponse2);
    productDetailResponse.getProductAttributeResponses().add(productAttributeResponse2);

    ProductAttributeResponse productAttributeResponse3 = new ProductAttributeResponse();
    productAttributeResponse3.setProductAttributeValues(new ArrayList<>());
    AttributeResponse attributeResponse3 = new AttributeResponse();
    attributeResponse3.setAttributeType(DEFAULT_ATTRIBUTE_TYPE_3);
    attributeResponse3.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    attributeResponse3.setName("OS");
    attributeResponse3.setSkuValue(false);
    ProductAttributeValueResponse productAttributeValueResponse3 = new ProductAttributeValueResponse();
    productAttributeResponse3.setAttribute(attributeResponse3);
    productAttributeResponse3.getProductAttributeValues().add(productAttributeValueResponse3);
    productDetailResponse.getProductAttributeResponses().add(productAttributeResponse3);

    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(new ArrayList<>());
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(categoryRepository.findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE)).thenReturn(categoriesData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    ProductLevel3DetailResponse productLevel3Detail =
        productLevel3ServiceBean.getL3DetailByProductSku(DEFAULT_PRODUCT_SKU, true, true, Arrays.asList(new PickupPointDeleteRequest("",ITEM_SKU)), false);
    verify(productCollectionRepository).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, productLevel3Detail.getProductSku());
    Assertions.assertEquals(PREORDER_VALUE, productLevel3Detail.getPreOrder().getPreOrderValue());
    Assertions.assertEquals(4, productLevel3Detail.getAttributes().size());
    Assertions.assertEquals(10.0, productLevel3Detail.getLength(), 0.0);
  }

  @Test
  public void getL3DetailByProductSkuDataNeedRevisionTest2() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    ProductItemBusinessPartner partner = new ProductItemBusinessPartner();
    partner.setGdnProductItemSku(ITEM_SKU);
    partner.setPickupPointId("-");
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner, partner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    productBusinessPartner.setCategoryCode(DEFAULT_CATEGORY_CODE);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setLength(10.0);
    productDetailResponse.setProductAttributeResponses(new ArrayList<>());
    productDetailResponse.setImages(new ArrayList<>());
    productDetailResponse.getImages().add(new Image(true, DEFAULT_LOCATION_PATH, 1));
    productDetailResponse.setProductAttributeResponses(new ArrayList<>());
    ProductAttributeResponse productAttributeResponse = new ProductAttributeResponse();
    productAttributeResponse.setProductAttributeValues(new ArrayList<>());
    AttributeResponse attributeResponse = new AttributeResponse();
    attributeResponse.setAttributeType(DEFAULT_ATTRIBUTE_TYPE);
    attributeResponse.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attributeResponse.setName("Color");
    attributeResponse.setSkuValue(false);
    ProductAttributeValueResponse productAttributeValueResponse = new ProductAttributeValueResponse();
    PredefinedAllowedAttributeValueResponse predefinedAllowedAttributeValueResponse =
        new PredefinedAllowedAttributeValueResponse();
    predefinedAllowedAttributeValueResponse.setValue("Orange");
    productAttributeValueResponse.setPredefinedAllowedAttributeValue(predefinedAllowedAttributeValueResponse);
    productAttributeResponse.setAttribute(attributeResponse);
    productAttributeResponse.getProductAttributeValues().add(productAttributeValueResponse);
    productDetailResponse.getProductAttributeResponses().add(productAttributeResponse);

    ProductAttributeResponse productAttributeResponse1 = new ProductAttributeResponse();
    productAttributeResponse1.setProductAttributeValues(new ArrayList<>());
    AttributeResponse attributeResponse1 = new AttributeResponse();
    attributeResponse1.setAttributeType(DEFAULT_ATTRIBUTE_TYPE_2);
    attributeResponse1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    attributeResponse1.setName("RAM");
    attributeResponse1.setSkuValue(false);
    ProductAttributeValueResponse productAttributeValueResponse1 = new ProductAttributeValueResponse();
    productAttributeValueResponse1.setDescriptiveAttributeValue("10GB");
    productAttributeResponse1.setAttribute(attributeResponse1);
    productAttributeResponse1.getProductAttributeValues().add(productAttributeValueResponse1);
    productDetailResponse.getProductAttributeResponses().add(productAttributeResponse1);

    ProductAttributeResponse productAttributeResponse2 = new ProductAttributeResponse();
    productAttributeResponse2.setProductAttributeValues(new ArrayList<>());
    AttributeResponse attributeResponse2 = new AttributeResponse();
    attributeResponse2.setAttributeType(DEFAULT_ATTRIBUTE_TYPE_3);
    attributeResponse2.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    attributeResponse2.setName("OS");
    attributeResponse2.setSkuValue(false);
    ProductAttributeValueResponse productAttributeValueResponse2 = new ProductAttributeValueResponse();
    AllowedAttributeValueResponse allowedAttributeValueResponse = new AllowedAttributeValueResponse();
    allowedAttributeValueResponse.setValue("Windows");
    productAttributeValueResponse2.setAllowedAttributeValue(allowedAttributeValueResponse);
    productAttributeResponse2.setAttribute(attributeResponse2);
    productAttributeResponse2.getProductAttributeValues().add(productAttributeValueResponse2);
    productDetailResponse.getProductAttributeResponses().add(productAttributeResponse2);

    ProductAttributeResponse productAttributeResponse3 = new ProductAttributeResponse();
    productAttributeResponse3.setProductAttributeValues(new ArrayList<>());
    AttributeResponse attributeResponse3 = new AttributeResponse();
    attributeResponse3.setAttributeType(DEFAULT_ATTRIBUTE_TYPE_3);
    attributeResponse3.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    attributeResponse3.setName("OS");
    attributeResponse3.setSkuValue(false);
    ProductAttributeValueResponse productAttributeValueResponse3 = new ProductAttributeValueResponse();
    productAttributeResponse3.setAttribute(attributeResponse3);
    productAttributeResponse3.getProductAttributeValues().add(productAttributeValueResponse3);
    productDetailResponse.getProductAttributeResponses().add(productAttributeResponse3);

    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(new ArrayList<>());
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(categoryRepository.findHierarchyByCategoryCode(DEFAULT_CATEGORY_CODE)).thenReturn(categoriesData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    ProductLevel3DetailResponse productLevel3Detail =
        productLevel3ServiceBean.getL3DetailByProductSku(DEFAULT_PRODUCT_SKU, true, true, Arrays.asList(new PickupPointDeleteRequest("",ITEM_SKU)), false);
    verify(productCollectionRepository).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, productLevel3Detail.getProductSku());
    Assertions.assertEquals(PREORDER_VALUE, productLevel3Detail.getPreOrder().getPreOrderValue());
    Assertions.assertEquals(4, productLevel3Detail.getAttributes().size());
    Assertions.assertEquals(10.0, productLevel3Detail.getLength(), 0.0);
  }

  private ProductL3Response generateProductL3Response() throws Exception {
    ProductL3Response productData = new ProductL3Response();
    productData.setVersion(10L);
    productData.setItemSkus(Arrays.asList(DEFAULT_ITEM_SKU));
    productData.setProductEditable(true);
    productData.setProductSku(DEFAULT_PRODUCT_SKU);
    productData.setProductCode(DEFAULT_PRODUCT_CODE);
    productData.setProductType(ProductType.REGULAR);
    productData.setSettlementType(DEFAULT_SETTLEMENT_TYPE);
    productData.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productData.setSynchronized(true);
    productData.setDefaultItemSku(DEFAULT_ITEM_SKU);
    productData.setMasterCatalog(new MasterCatalogDTO());
    productData.getMasterCatalog().setCategory(new CategoryDTO());
    productData.getMasterCatalog().getCategory().setCategoryCode(DEFAULT_CATEGORY_CODE);
    productData.setMasterDataProduct(new MasterDataProductDTO());
    productData.getMasterDataProduct().setDescription(PRODUCT_DESCRIPTION1);
    productData.getMasterDataProduct().setProductName(PRODUCT_NAME1);
    productData.getMasterDataProduct().setUniqueSellingPoint(PRODUCT_USP1);
    productData.getMasterDataProduct().setBrand(DEFAULT_BRAND);
    productData.getMasterDataProduct().setMasterDataProductAttributes(new ArrayList<MasterDataProductAttributeDTO>());
    productData.getMasterDataProduct().getMasterDataProductAttributes().add(new MasterDataProductAttributeDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().add(new MasterDataProductAttributeDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().add(new MasterDataProductAttributeDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().add(new MasterDataProductAttributeDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(0)
        .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(0).getMasterDataAttribute()
        .setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(0).getMasterDataAttribute()
        .setVariantCreation(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(0).getMasterDataAttribute()
        .setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(0).getMasterDataAttribute()
        .setBasicView(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(0).getMasterDataAttribute()
        .setMandatory(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(0).getMasterDataAttribute()
        .setSkuValue(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(0)
        .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(0).getMasterDataProductAttributeValues()
        .add(new MasterDataProductAttributeValueDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(1)
        .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(1).getMasterDataAttribute()
        .setAttributeType(MasterDataAttributeType.DESCRIPTIVE_ATTRIBUTE);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(1).getMasterDataAttribute()
        .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(1).getMasterDataAttribute()
        .setBasicView(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(1).getMasterDataAttribute()
        .setMandatory(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(1).getMasterDataAttribute()
        .setSkuValue(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(1)
        .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(1).getMasterDataAttribute()
        .setSkuValue(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(2)
        .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(2).getMasterDataAttribute()
        .setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(2).getMasterDataAttribute()
        .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(2).getMasterDataAttribute()
        .setBasicView(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(2).getMasterDataAttribute()
        .setMandatory(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(2).getMasterDataAttribute()
        .setSkuValue(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(2)
        .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(2).getMasterDataProductAttributeValues()
        .add(new MasterDataProductAttributeValueDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(3)
        .setMasterDataAttribute(new MasterDataAttributeDTO());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(3).getMasterDataAttribute()
        .setAttributeType(MasterDataAttributeType.DEFINING_ATTRIBUTE);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(3).getMasterDataAttribute()
        .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(3).getMasterDataAttribute()
        .setBasicView(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(3).getMasterDataAttribute()
        .setMandatory(true);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(3).getMasterDataAttribute()
        .setSkuValue(false);
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(3)
        .setMasterDataProductAttributeValues(new ArrayList<MasterDataProductAttributeValueDTO>());
    productData.getMasterDataProduct().getMasterDataProductAttributes().get(3).getMasterDataProductAttributeValues()
        .add(new MasterDataProductAttributeValueDTO());
    productData.setProductSpecialAttributes(new ArrayList<ProductSpecialAttributeDTO>());
    productData.getProductSpecialAttributes().add(new ProductSpecialAttributeDTO());
    productData.getProductSpecialAttributes().get(0).setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productData.setDescriptiveAttributes(new ArrayList<ProductAttributeDetailDTO>());
    productData.getDescriptiveAttributes().add(new ProductAttributeDetailDTO());
    productData.getDescriptiveAttributes().add(new ProductAttributeDetailDTO());
    productData.getDescriptiveAttributes().get(0).setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    productData.getDescriptiveAttributes().get(1).setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productData.setDefiningAttributes(new ArrayList<ProductAttributeDTO>());
    productData.getDefiningAttributes().add(new ProductAttributeDTO());
    productData.getDefiningAttributes().get(0).setProductAttributeDetails(new ArrayList<ProductAttributeDetailDTO>());
    productData.getDefiningAttributes().get(0).getProductAttributeDetails().add(new ProductAttributeDetailDTO());
    productData.getDefiningAttributes().get(0).getProductAttributeDetails().get(0)
        .setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productData.getMasterDataProduct().setMasterDataProductImages(new ArrayList<MasterDataProductImageDTO>());
    productData.getMasterDataProduct().getMasterDataProductImages()
        .add(new MasterDataProductImageDTO(true, null, DEFAULT_PRODUCT_CODE, 0));
    productData.setForceReview(true);
    productData.setProductScore(new ProductScoreResponse(10, 10, 10, 10, 10, 10, 10, 10, 10, 1, 90));
    productData.setPickupPointCodes(Arrays.asList(PICKUP, PICKUP_1));
    return productData;
  }

  @Test
  public void updateLogistics_suspendedTest() throws Exception {
    ProfileResponse profileResponse = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    productLevel3UpdateRequest.setSynchronize(false);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setMarkForDelete(true);
    savedProductData1.setSuspended(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(productLevel3LogisticsService, times(1)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productBusinessPartnerRepository).countRejectedProductByGdnProductSku(Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_SUSPENDED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void updateLogistics_RejectedTest() throws Exception {
    productLevel3UpdateRequest.setSynchronize(false);
    ProfileResponse profileResponse = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setMarkForDelete(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    when(productBusinessPartnerRepository.countRejectedProductByGdnProductSku(Mockito.any())).thenReturn(1);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        PICKUP);
    verify(productBusinessPartnerRepository).countRejectedProductByGdnProductSku(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_REJECTED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void updateLogistics_ArchivedTest() throws Exception {
    ProfileResponse profileResponse = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setArchived(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productLevel3LogisticsService, times(1)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    Assertions.assertEquals(ApiErrorCode.ITEM_IS_ARCHIVED.getCode(), apiErrorCode.getCode());
  }

  @Test
  public void updateLogistics_ShippingWeight0Test() throws Exception {
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setShippingWeight(0.0);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(true);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.SHIPPING_WEIGHT_NOT_VALID.getCode(), apiErrorCode.getCode());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        PICKUP);
  }

  @Test
  public void updateLogisticsLength0Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateDimensionInL3Update", true);
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLength(0.0);
    productLevel3UpdateRequest.setWeight(10.0);
    productLevel3UpdateRequest.setWidth(10.0);
    productLevel3UpdateRequest.setHeight(10.0);
    productLevel3UpdateRequest.setShippingWeight(10.0);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(true);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.DIMENSION_LESS_THAN_ZERO.getCode(), apiErrorCode.getCode());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        PICKUP);
  }

  @Test
  public void updateLogisticsWeight0Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateDimensionInL3Update", true);
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLength(10.0);
    productLevel3UpdateRequest.setWeight(0.0);
    productLevel3UpdateRequest.setWidth(10.0);
    productLevel3UpdateRequest.setHeight(10.0);
    productLevel3UpdateRequest.setShippingWeight(10.0);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(true);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.DIMENSION_LESS_THAN_ZERO.getCode(), apiErrorCode.getCode());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        PICKUP);
  }

  @Test
  public void updateLogisticsWeight0ForInstoreProductTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateDimensionInL3Update", true);
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLength(10.0);
    productLevel3UpdateRequest.setWeight(0.0);
    productLevel3UpdateRequest.setWidth(10.0);
    productLevel3UpdateRequest.setHeight(10.0);
    productLevel3UpdateRequest.setShippingWeight(10.0);
    productLevel3UpdateRequest.setOff2OnChannelActive(true);
    productLevel3UpdateRequest.setB2cActivated(false);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(true);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
      false, true);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
      PICKUP);
  }
  @Test
  public void updateLogisticsWeight0ForInstoreProductTest1() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateDimensionInL3Update", true);
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLength(0.0);
    productLevel3UpdateRequest.setWeight(0.0);
    productLevel3UpdateRequest.setWidth(10.0);
    productLevel3UpdateRequest.setHeight(10.0);
    productLevel3UpdateRequest.setShippingWeight(10.0);
    productLevel3UpdateRequest.setOff2OnChannelActive(true);
    productLevel3UpdateRequest.setB2cActivated(false);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
      new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
      pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
      new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(true);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
      false, true);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
      PICKUP);
  }
  @Test
  public void updateLogisticsWidth0Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateDimensionInL3Update", true);
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLength(10.0);
    productLevel3UpdateRequest.setWeight(10.0);
    productLevel3UpdateRequest.setWidth(0.0);
    productLevel3UpdateRequest.setHeight(10.0);
    productLevel3UpdateRequest.setShippingWeight(10.0);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    ProductAndItemsResponse savedProductData = generateProductData();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(true);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.DIMENSION_LESS_THAN_ZERO.getCode(), apiErrorCode.getCode());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        PICKUP);
  }

  @Test
  public void updateLogisticsHeight0Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateDimensionInL3Update", true);
    productLevel3UpdateRequest.setProductType(null);
    productLevel3UpdateRequest.setLength(10.0);
    productLevel3UpdateRequest.setWeight(10.0);
    productLevel3UpdateRequest.setWidth(10.0);
    productLevel3UpdateRequest.setHeight(0.0);
    productLevel3UpdateRequest.setShippingWeight(10.0);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    itemSummaryResponse.setPickupPointCode(PICKUP);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(ITEM_SUMMARY_PAGE_SIZE, "1", "item-summary-size", false));
    when(productLevel3Repository.findSummaryByFilter(itemSummaryRequestArgumentCaptor.capture(),
        pageRequestArgumentCaptor.capture(), sortOrderArgumentCaptor.capture())).thenReturn(
        new PageImpl<>(Arrays.asList(itemSummaryResponse), PageRequest.of(0, 1), 2));
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().setProductType(ProductType.REGULAR);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    productLevel3UpdateRequest.setSynchronize(true);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.DIMENSION_LESS_THAN_ZERO.getCode(), apiErrorCode.getCode());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        PICKUP);
  }

  @Test
  public void getProductL3SummaryTest_emptyProductList() throws Exception {
    Mockito.when(
        this.xProductOutbound.getProductSkuSummary(DEFAULT_BUSINESS_PARTNER_CODE, new ProductSkuSummaryRequest(), PAGE,
            SIZE)).thenReturn(new PageImpl<>(new ArrayList<>(), PageRequest.of(PAGE, SIZE), SIZE));
    Page<ProductL3SummaryResponse> productL3SummaryResponses =
        productLevel3ServiceBean.getProductL3Summary(STORE_ID, REQUESTID, DEFAULT_BUSINESS_PARTNER_CODE, 0, 10,
            productL3SummaryRequest);
    Mockito.verify(this.xProductOutbound)
        .getProductSkuSummary(DEFAULT_BUSINESS_PARTNER_CODE, new ProductSkuSummaryRequest(), PAGE, SIZE);
    Assertions.assertTrue(CollectionUtils.isEmpty(productL3SummaryResponses.getContent()));
  }

  @Test
  public void toggleArchiveProductsTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.doNothing().when(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, true);
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(Arrays.asList(DEFAULT_PRODUCT_SKU), true);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, true);
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE, Constants.DEFAULT,
        DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.ARCHIVE.getDesc(), String.valueOf(false),
        String.valueOf(true), false, StringUtils.EMPTY);
    verify(productLevel3AggregatorService).updateState(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        ProductLevel3AggregatorState.ARCHIVED);
  }

  @Test
  public void toggleArchiveProductsAggregateTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "productLimitSwitchEnabled", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "skipProductLevel3AggregatorCreation", true);
    ProductL3Response savedProductData = generateProductL3Response();
    Map<String, Object> flags = new HashMap<>();
    flags.put("productLimit", true);
    profileResponse.setFlags(flags);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.when(productService.getProfileResponse(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.doNothing().when(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, true);
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(Arrays.asList(DEFAULT_PRODUCT_SKU), true);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, true);
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE, Constants.DEFAULT,
        DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.ARCHIVE.getDesc(), String.valueOf(false),
        String.valueOf(true), false, StringUtils.EMPTY);
    verify(productService).getProfileResponse(Mockito.anyString());
  }

  @Test
  public void toggleArchiveProductsEmptyProductSkusTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "productLimitSwitchEnabled", true);
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(new ArrayList<>(), true);
    Assertions.assertTrue(CollectionUtils.isEmpty(response.getFailedItemSkus()));
  }

  @Test
  public void toggleArchiveBulkProductsTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setArchived(true);
    savedProductData.setActiveL5Mapped(false);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU_2))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(Arrays.asList(DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_SKU_2), false);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU_2);
    Assertions.assertEquals(ApiErrorCode.FAILED_TO_UNARCHIVE_NO_ACTIVE_L5.getCode(), response.getErrorCode());
  }

  @Test
  public void toggleArchiveProductsDoArchiveFalseTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setArchived(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.doNothing().when(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, false);
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(Arrays.asList(DEFAULT_PRODUCT_SKU), false);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, false);
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE, Constants.DEFAULT,
        DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.ARCHIVE.getDesc(), String.valueOf(true),
        String.valueOf(false), false, StringUtils.EMPTY);
    verify(productLevel3AggregatorService).updateState(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        ProductLevel3AggregatorState.ACTIVE);
  }

  @Test
  public void toggleArchiveProductsDoArchiveFalseAggregateTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "skipProductLevel3AggregatorCreation", true);
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setArchived(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.doNothing().when(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, false);
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(Arrays.asList(DEFAULT_PRODUCT_SKU), false);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, false);
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE, Constants.DEFAULT,
        DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.ARCHIVE.getDesc(), String.valueOf(true),
        String.valueOf(false), false, StringUtils.EMPTY);
  }

  @Test
  public void toggleArchiveProductsDoArchiveFalseNoActiveL5MappedTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "productLimitSwitchEnabled", true);
    Map<String, Object> flags = new HashMap<>();
    flags.put("productLimit", true);
    profileResponse.setFlags(flags);
    Mockito.when(productService.getProfileResponse(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productService.checkProductLimitExceeded(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(null);
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setActiveL5Mapped(false);
    savedProductData.setArchived(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.doNothing().when(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, false);
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(Arrays.asList(DEFAULT_PRODUCT_SKU), false);
    Assertions.assertEquals(ApiErrorCode.FAILED_TO_UNARCHIVE_NO_ACTIVE_L5.getCode(), response.getErrorCode());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productService).checkProductLimitExceeded(Mockito.anyString(), Mockito.anyString());
  }

  @Test
  public void toggleArchiveProductsDoArchiveFalseProductLimitTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "productLimitSwitchEnabled", true);
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setActiveL5Mapped(false);
    savedProductData.setArchived(true);
    Map<String, Object> flags = new HashMap<>();
    flags.put("productLimit", true);
    profileResponse.setFlags(flags);
    Mockito.when(productService.getProfileResponse(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productService.checkProductLimitExceeded(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(ApiErrorCode.PRODUCT_LIMIT_REACHED);
    ItemBulkArchiveResponse response =
        productLevel3ServiceBean.toggleArchiveProducts(Arrays.asList(DEFAULT_PRODUCT_SKU), false);
    Assertions.assertEquals(ApiErrorCode.PRODUCT_LIMIT_REACHED.getCode(), response.getErrorCode());
    verify(productService).checkProductLimitExceeded(Mockito.anyString(), Mockito.anyString());
  }

  @Test
  public void toggleArchiveProductsExceptionTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.doThrow(Exception.class).when(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, true);
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(Arrays.asList(DEFAULT_PRODUCT_SKU), true);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, true);
    Assertions.assertEquals(1, response.getFailedItemSkus().size());
  }

  @Test
  public void toggleArchiveProductsSameArchiveStateTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.doNothing().when(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, false);
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(Arrays.asList(DEFAULT_PRODUCT_SKU), false);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void toggleArchiveProductsTakenDownProductTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setMarkForDelete(true);
    savedProductData.setTakenDown(true);
    savedProductData.setArchived(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.doNothing().when(xProductOutbound).toggleArchiveProduct(DEFAULT_PRODUCT_SKU, false);
    ItemBulkArchiveResponse
        response = productLevel3ServiceBean.toggleArchiveProducts(Collections.singletonList(DEFAULT_PRODUCT_SKU), false);
    verify(productBusinessPartnerRepository).countRejectedProductByGdnProductSku(Mockito.any());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void updateItemsPriceStockImagesImageRefreshTestForException() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(PRODUCT_CODE);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(UPDATE);
    productPriceStockAndImagesRequest.setProductCode(PRODUCT_CODE);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(PRODUCT_CODE));
    productCollection.setReviewPending(true);
    productCollection.setReviewType("IMAGE");
    when(productItemBusinessPartnerRepository.findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(DEFAULT_STORE_ID,
        productPriceStockAndImagesRequest.getItemSku())).thenReturn(productItemBusinessPartner);
    when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(variantEditValidationService.validateListOfVariantsWithSuccess(productPriceStockAndImagesRequests,
        failedRequests, itemSummaryResponseMap)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.doThrow(RuntimeException.class).when(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3ServiceBean.updateItemsPriceStockImages(DEFAULT_STORE_ID, productPriceStockAndImagesRequests,
        DEFAULT_BUSINESS_PARTNER_CODE, new ArrayList<>(), true, new ProductL3Response());
    Mockito.verify(productLevel3Repository)
        .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
            Mockito.any(SortOrder.class));
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(productPriceStockAndImagesRequests,
        failedRequests, itemSummaryResponseMap);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndGdnProductItemSkuAndMarkForDeleteFalse(
        DEFAULT_STORE_ID, productPriceStockAndImagesRequest.getItemSku());
    Mockito.verify(productPricingOutbound).getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()),
        Mockito.any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository)
        .updateSummary(any(), any(), any(UpdateItemSummaryRequest.class));
    Mockito.verify(categoryRepository).findHierarchyByCategoryCode(any());
    Mockito.verify(updatedProductHistoryService, times(1))
        .saveUpdateProductLevel3Audit(any(), any(), any(),
            any(), any(), Mockito.any(), Mockito.any(),
            Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(updatedProductHistoryService, times(1))
        .createProductL3AuditLog(any(), any(), any(), any(), any(), any(),
            any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(productOutbound).updateProductItemImagesByProductCode(any(ProductItemImageUpdateRequest.class));
    verify(variantEditValidationService).validatePriceLockCampaignRequest(productPriceStockAndImagesRequests.get(0),
        failedRequests);
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(any(), any(), Mockito.anyBoolean());
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Mockito.verify(kafkaProducer).send(eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
        addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Assertions.assertEquals("IMAGE_REFRESH",
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getReviewTypes());
  }

  @Test
  public void productQuickEditTest() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(false);
    itemSummaryResponse.setBuyable(false);
    quickEditRequest.setOff2OnActiveFlag(true);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    Mockito.when(campaignOutbound.validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(null);
    when(campaignOutbound.validateAndUpdateDiscountPrice(eq(true),
        campaignUpdateDiscountRequestArgumentCaptor.capture())).thenReturn(new CampaignUpdateDiscountResponse());
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
        new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    when(wholesaleValidationUtil.validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
        Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(),
        Mockito.any(Boolean.class), eq(null))).thenReturn(null);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(new ArrayList<>());
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(new PickupPointResponse());
    doNothing().when(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
    doNothing().when(updatedProductHistoryService)
        .createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    doNothing().when(productLevel3InventoryService)
        .updateStock(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getDeltaStock());
    doNothing().when(productLevel3InventoryService)
        .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
            quickEditRequest.getUseWarehouseStock(), new ArrayList<>());
    doNothing().when(productLevel3InventoryService)
        .updatePickupPoint(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getItemSku());
    doNothing().when(xProductOutbound)
        .updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR), quickEditListArgumentCaptor.capture());
    doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU, new UpdateProductItemLevel3Model(),
            new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false,
            StringUtils.EMPTY);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
        new ArrayList());
    verify(productLevel3Repository, times(2)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(campaignOutbound).validateAndUpdateDiscountPrice(true,
        campaignUpdateDiscountRequestArgumentCaptor.getValue());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
    verify(productSystemParameterService, times(2)).findByStoreIdAndVariable(
      DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
    verify(wholesaleValidationUtil).validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
        Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(), Mockito.any(Boolean.class),
        eq(null));
    verify(updateProductItemLevel3ModelConverter, times(2)).convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class));
    verify(productLevel3InventoryService).updateStockV2(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getDeltaStock());
    verify(productLevel3InventoryService)
        .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
            quickEditRequest.getUseWarehouseStock(), Collections.singletonList(
                new ItemSkuPickupPointSyncStockDto(quickEditRequest.getItemSku(), quickEditRequest.getPickupPointCode(),
                    quickEditRequest.getUseWarehouseStock())));
    verify(productLevel3InventoryService).updatePickupPoint(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getPickupPointCode());
    verify(xProductOutbound).updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.BOPIS),
        quickEditListArgumentCaptor.capture());
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU,
        new UpdateProductItemLevel3Model(), new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU,
        ITEM_NAME, false, StringUtils.EMPTY);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
    verify(productLevel3InventoryService, times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    verify(categoryRepository).findHierarchyByCategoryCode(Mockito.any());
    verify(pickupPointRepository).findByPickupPointCode(Mockito.any());
    verify(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(productNotificationService).sendNotificationForProductStatus(profileResponse.getBusinessPartnerCode(),
        itemSummaryResponse.getGeneratedItemName(),
        productLevel3QuickEditRequest.getQuickEditRequests().get(0).getStatus().name());
    verify(productLevel3Helper).isProductItemDetailChangedForListingUpdate(Mockito.any(QuickEditRequest.class),
        Mockito.any(ItemSummaryResponse.class), Mockito.any(Boolean.class));
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void productQuickEditTestCampaignValiadtionFailed() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(false);
    itemSummaryResponse.setBuyable(false);
    quickEditRequest.setOff2OnActiveFlag(true);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    Map<String, String> map = new HashMap<>();
    map.put(DEFAULT_ITEM_SKU,"0");
    campaignUpdateDiscountResponse.setItemSkuStatusMap(map);
    when(campaignOutbound.validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture())).thenReturn(new CampaignUpdateDiscountResponse());
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    when(wholesaleValidationUtil.validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
      Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(),
      Mockito.any(Boolean.class), eq(null))).thenReturn(null);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
      DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(new ArrayList<>());
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(new PickupPointResponse());
    doNothing().when(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
    doNothing().when(updatedProductHistoryService)
      .createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    doNothing().when(productLevel3InventoryService)
      .updateStock(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getDeltaStock());
    doNothing().when(productLevel3InventoryService)
      .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getUseWarehouseStock(), new ArrayList<>());
    doNothing().when(productLevel3InventoryService)
      .updatePickupPoint(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getItemSku());
    doNothing().when(xProductOutbound)
      .updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR), quickEditListArgumentCaptor.capture());
    doNothing().when(updatedProductHistoryService)
      .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU, new UpdateProductItemLevel3Model(),
        new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false,
          StringUtils.EMPTY);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
      new ArrayList());
    verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }


  @Test
  public void productQuickEdit_offlineToOnlineFalseTest() throws Exception {
    Map<String, String> itemSkuStatusMap = new HashMap<>();
    itemSkuStatusMap.put(ITEM_CODE, "message");
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(true);
    itemSummaryResponse.setBuyable(false);
    quickEditRequest.setOff2OnActiveFlag(false);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(eq(true),
        campaignUpdateDiscountRequestArgumentCaptor.capture())).thenReturn(
        new CampaignUpdateDiscountResponse(itemSkuStatusMap, null));
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
        new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    when(wholesaleValidationUtil.validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
        Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(),
        Mockito.any(Boolean.class), eq(null))).thenReturn(null);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(new ArrayList<>());
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(new PickupPointResponse());
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    doNothing().when(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
    doNothing().when(updatedProductHistoryService)
        .createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    doNothing().when(productLevel3InventoryService)
        .updateStock(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getDeltaStock());
    doNothing().when(productLevel3InventoryService)
        .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
            quickEditRequest.getUseWarehouseStock(), new ArrayList<>());
    doNothing().when(productLevel3InventoryService)
        .updatePickupPoint(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getPickupPointCode());
    doNothing().when(xProductOutbound)
        .updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR), quickEditListArgumentCaptor.capture());
    doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU, new UpdateProductItemLevel3Model(),
            new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false,
            StringUtils.EMPTY);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
        new ArrayList());
    verify(productLevel3Repository, times(2)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
    verify(productSystemParameterService, times(2)).findByStoreIdAndVariable(
      DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
    verify(wholesaleValidationUtil).validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
        Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(), Mockito.any(Boolean.class),
        Mockito.eq(null));
    verify(updateProductItemLevel3ModelConverter, times(2)).convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class));
    verify(productLevel3InventoryService).updateStockV2(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getDeltaStock());
    verify(productLevel3InventoryService)
        .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
            quickEditRequest.getUseWarehouseStock(), Collections.singletonList(
                new ItemSkuPickupPointSyncStockDto(quickEditRequest.getItemSku(), quickEditRequest.getPickupPointCode(),
                    quickEditRequest.getUseWarehouseStock())));
    verify(productLevel3InventoryService).updatePickupPoint(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getPickupPointCode());
    verify(xProductOutbound).updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.BOPIS),
        quickEditListArgumentCaptor.capture());
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU,
        new UpdateProductItemLevel3Model(), new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU,
        ITEM_NAME, false, StringUtils.EMPTY);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
    verify(productLevel3InventoryService, times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    verify(categoryRepository).findHierarchyByCategoryCode(Mockito.any());
    verify(pickupPointRepository).findByPickupPointCode(Mockito.any());
    verify(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(productNotificationService).sendNotificationForProductStatus(profileResponse.getBusinessPartnerCode(),
        itemSummaryResponse.getGeneratedItemName(),
        productLevel3QuickEditRequest.getQuickEditRequests().get(0).getStatus().name());
    verify(productLevel3Helper).isProductItemDetailChangedForListingUpdate(Mockito.any(QuickEditRequest.class),
        Mockito.any(ItemSummaryResponse.class), Mockito.any(Boolean.class));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void productQuickEdit_PriceValidationFailed() throws Exception {
    Map<String, String> itemSkuStatusMap = new HashMap<>();
    itemSkuStatusMap.put(DEFAULT_ITEM_SKU, "message");
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(true);
    itemSummaryResponse.setBuyable(false);
    itemSummaryResponse.setFreeSample(true);
    quickEditRequest.setOff2OnActiveFlag(false);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(eq(true),
        campaignUpdateDiscountRequestArgumentCaptor.capture())).thenReturn(
        new CampaignUpdateDiscountResponse(itemSkuStatusMap, null));
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU,
            productLevel3QuickEditRequest, new ArrayList());
      });
    }
    finally {
      verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
      verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
      verify(productLevel3InventoryService).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    }
  }

  @Test
  public void productQuickEdit_PriceValidationEmptyMap() throws Exception {
    Map<String, String> itemSkuStatusMap = new HashMap<>();
    campaignUpdateDiscountResponse.setItemSkuStatusMap(itemSkuStatusMap);
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(true);
    itemSummaryResponse.setBuyable(false);
    itemSummaryResponse.setFreeSample(true);
    quickEditRequest.setOff2OnActiveFlag(false);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture())).thenReturn(
      campaignUpdateDiscountResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU,
            productLevel3QuickEditRequest, new ArrayList());
      });
    }
    finally {
      verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
      verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
      verify(productLevel3InventoryService).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    }
  }

  @Test
  public void productQuickEdit_PriceNullResponse() throws Exception {
    Map<String, String> itemSkuStatusMap = new HashMap<>();
    campaignUpdateDiscountResponse.setItemSkuStatusMap(itemSkuStatusMap);
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(true);
    itemSummaryResponse.setBuyable(false);
    itemSummaryResponse.setFreeSample(true);
    quickEditRequest.setOff2OnActiveFlag(false);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(campaignOutbound.validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class))).thenReturn(null);
    when(campaignOutbound.validateAndUpdateDiscountPrice(eq(true),
      campaignUpdateDiscountRequestArgumentCaptor.capture())).thenReturn(
      campaignUpdateDiscountResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU,
            productLevel3QuickEditRequest, new ArrayList());
      });
    }
    finally {
      verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
      verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
      verify(productLevel3InventoryService).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    }
  }

  @Test
  public void productQuickEdit_priceEditDisabledTest() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(false);
    itemSummaryResponse.setBuyable(false);
    itemSummaryResponse.setPriceEditDisabled(true);
    quickEditRequest.setOff2OnActiveFlag(true);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
        new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    when(wholesaleValidationUtil.validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
        Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(),
        Mockito.any(Boolean.class), eq(null))).thenReturn(null);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(new ArrayList<>());
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(new PickupPointResponse());
    doNothing().when(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
    doNothing().when(updatedProductHistoryService)
        .createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    doNothing().when(productLevel3InventoryService)
        .updateStock(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getDeltaStock());
    doNothing().when(productLevel3InventoryService)
        .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
            quickEditRequest.getUseWarehouseStock(), new ArrayList<>());
    doNothing().when(xProductOutbound)
        .updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR), quickEditListArgumentCaptor.capture());
    doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU, new UpdateProductItemLevel3Model(),
            new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false,
            StringUtils.EMPTY);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
        new ArrayList());
    verify(productLevel3Repository, times(2)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
    verify(productSystemParameterService, times(2)).findByStoreIdAndVariable(
      DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
    verify(wholesaleValidationUtil).validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
        Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(), Mockito.any(Boolean.class),
        eq(null));
    verify(updateProductItemLevel3ModelConverter, times(2)).convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class));
    verify(productLevel3InventoryService).updateStockV2(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getDeltaStock());
    verify(productLevel3InventoryService)
        .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
            quickEditRequest.getUseWarehouseStock(), Collections.singletonList(
                new ItemSkuPickupPointSyncStockDto(quickEditRequest.getItemSku(), quickEditRequest.getPickupPointCode(),
                    quickEditRequest.getUseWarehouseStock())));
    verify(xProductOutbound).updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.BOPIS),
        quickEditListArgumentCaptor.capture());
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU,
        new UpdateProductItemLevel3Model(), new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU,
        ITEM_NAME, false, StringUtils.EMPTY);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
    verify(productLevel3InventoryService, times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    verify(categoryRepository).findHierarchyByCategoryCode(Mockito.any());
    verify(pickupPointRepository).findByPickupPointCode(Mockito.any());
    verify(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(productNotificationService).sendNotificationForProductStatus(profileResponse.getBusinessPartnerCode(),
        itemSummaryResponse.getGeneratedItemName(),
        productLevel3QuickEditRequest.getQuickEditRequests().get(0).getStatus().name());
    verify(productLevel3Helper).isProductItemDetailChangedForListingUpdate(Mockito.any(QuickEditRequest.class),
        Mockito.any(ItemSummaryResponse.class), Mockito.any(Boolean.class));

  }

  @Test
  public void productQuickEdit_stockUpdateTest() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(false);
    itemSummaryResponse.setBuyable(false);
    itemSummaryResponse.setPriceEditDisabled(true);
    quickEditRequest.setOff2OnActiveFlag(true);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
        new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    when(wholesaleValidationUtil.validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
        Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(),
        Mockito.any(Boolean.class), eq(null))).thenReturn(null);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(Mockito.any(),
        Mockito.any())).thenReturn(new ProductLevel3Inventory());
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(new ArrayList<>());
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(new PickupPointResponse());
    doNothing().when(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
    doNothing().when(updatedProductHistoryService)
        .createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    doNothing().when(productLevel3InventoryService)
        .updateStock(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getDeltaStock());
    doNothing().when(productLevel3InventoryService)
        .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
            quickEditRequest.getUseWarehouseStock(), new ArrayList<>());
    doNothing().when(productLevel3InventoryService)
        .updatePickupPoint(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getItemSku());
    when(productLevel3Helper.isProductItemDetailChangedForListingUpdate(Mockito.any(QuickEditRequest.class),
        Mockito.any(ItemSummaryResponse.class), Mockito.any(Boolean.class))).thenReturn(false);
    doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU, new UpdateProductItemLevel3Model(),
            new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false,
            StringUtils.EMPTY);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
        new ArrayList());
    verify(productLevel3Repository, times(2)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
    verify(productSystemParameterService, times(2)).findByStoreIdAndVariable(
      DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
    verify(wholesaleValidationUtil).validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
        Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(), Mockito.any(Boolean.class),
        eq(null));
    verify(updateProductItemLevel3ModelConverter, times(2)).convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class));
    verify(productLevel3InventoryService).updateStockV2(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getDeltaStock());
    verify(productLevel3InventoryService)
        .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
            quickEditRequest.getUseWarehouseStock(), Collections.singletonList(
                new ItemSkuPickupPointSyncStockDto(quickEditRequest.getItemSku(), quickEditRequest.getPickupPointCode(),
                    quickEditRequest.getUseWarehouseStock())));
    verify(productLevel3InventoryService).updatePickupPoint(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getPickupPointCode());
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU,
        new UpdateProductItemLevel3Model(), new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU,
        ITEM_NAME, false, StringUtils.EMPTY);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
    verify(productLevel3InventoryService, times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(Mockito.any(),
        Mockito.any());
    verify(categoryRepository).findHierarchyByCategoryCode(Mockito.any());
    verify(pickupPointRepository).findByPickupPointCode(Mockito.any());
    verify(productNotificationService).sendNotificationForProductStatus(profileResponse.getBusinessPartnerCode(),
        itemSummaryResponse.getGeneratedItemName(),
        productLevel3QuickEditRequest.getQuickEditRequests().get(0).getStatus().name());
    verify(productLevel3Helper).isProductItemDetailChangedForListingUpdate(Mockito.any(QuickEditRequest.class),
        Mockito.any(ItemSummaryResponse.class), Mockito.any(Boolean.class));
  }

  @Test
  public void productQuickEditWholeSaleOffTest() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.REGULAR);
    itemSummaryResponse.setOff2OnChannelActive(true);
    quickEditRequest.setWholeSaleActivated(false);
    quickEditRequest.setDeltaStock(null);
    quickEditRequest.setUseWarehouseStock(null);
    quickEditRequest.setPickupPointCode(null);
    quickEditRequest.setOff2OnActiveFlag(true);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(productPricingOutbound.setWholesaleActivated(eq(DEFAULT_ITEM_SKU), eq(INACTIVE_STATUS), Mockito.any())).thenReturn(true);
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(new ArrayList<>());
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(new PickupPointResponse());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    doNothing().when(xProductOutbound)
        .updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR), quickEditListArgumentCaptor.capture());
    doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU, new UpdateProductItemLevel3Model(),
            new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false,
            StringUtils.EMPTY);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
        new ArrayList());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
    verify(productLevel3Repository, times(2)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(updateProductItemLevel3ModelConverter, times(2)).convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class));
    verify(xProductOutbound).updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR),
        quickEditListArgumentCaptor.capture());
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU,
        new UpdateProductItemLevel3Model(), new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU,
        ITEM_NAME, false, StringUtils.EMPTY);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
    verify(productLevel3InventoryService, times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    verify(categoryRepository).findHierarchyByCategoryCode(Mockito.any());
    verify(pickupPointRepository).findByPickupPointCode(Mockito.any());
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_ITEM_SKU), eq(INACTIVE_STATUS), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
    verify(productLevel3Helper).isProductItemDetailChangedForListingUpdate(Mockito.any(QuickEditRequest.class),
        Mockito.any(ItemSummaryResponse.class), Mockito.any(Boolean.class));
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void productQuickEditSyncStockTest() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    quickEditRequest.setWholeSaleActivated(false);
    quickEditRequest.setDeltaStock(null);
    quickEditRequest.setUseWarehouseStock(true);
    quickEditRequest.setPickupPointCode(null);
    quickEditRequest.setVersion(null);
    quickEditRequest.setOff2OnActiveFlag(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BUSINESS_PARTNER);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(productPricingOutbound.setWholesaleActivated(eq(DEFAULT_ITEM_SKU), eq(INACTIVE_STATUS), Mockito.any())).thenReturn(true);
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(new ArrayList<>());
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(new PickupPointResponse());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    doNothing().when(xProductOutbound)
        .updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR), quickEditListArgumentCaptor.capture());
    doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU, new UpdateProductItemLevel3Model(),
            new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false,
            StringUtils.EMPTY);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
        new ArrayList());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
    verify(productLevel3Repository, times(2)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(updateProductItemLevel3ModelConverter, times(2)).convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class));
    verify(xProductOutbound).updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(itemSummaryResponse.getProductType()),
        quickEditListArgumentCaptor.capture());
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU,
        new UpdateProductItemLevel3Model(), new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU,
        ITEM_NAME, false, StringUtils.EMPTY);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
    verify(productLevel3InventoryService, times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    verify(categoryRepository).findHierarchyByCategoryCode(Mockito.any());
    verify(pickupPointRepository).findByPickupPointCode(Mockito.any());
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_ITEM_SKU), eq(INACTIVE_STATUS), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
    verify(productLevel3Helper).isProductItemDetailChangedForListingUpdate(Mockito.any(QuickEditRequest.class),
        Mockito.any(ItemSummaryResponse.class), Mockito.any(Boolean.class));
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void productQuickEditSyncStockItemVersionNullTest() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setVersion(null);
    quickEditRequest.setWholeSaleActivated(false);
    quickEditRequest.setDeltaStock(null);
    quickEditRequest.setUseWarehouseStock(true);
    quickEditRequest.setPickupPointCode(null);
    quickEditRequest.setVersion(null);
    quickEditRequest.setOff2OnActiveFlag(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BUSINESS_PARTNER);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(productPricingOutbound.setWholesaleActivated(eq(DEFAULT_ITEM_SKU), eq(INACTIVE_STATUS), Mockito.any())).thenReturn(true);
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(new ArrayList<>());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(new PickupPointResponse());
    doNothing().when(xProductOutbound)
        .updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR), quickEditListArgumentCaptor.capture());
    doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU, new UpdateProductItemLevel3Model(),
            new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false,
            StringUtils.EMPTY);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
        new ArrayList());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
    verify(productLevel3Repository, times(2)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(updateProductItemLevel3ModelConverter, times(2)).convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class));
    verify(xProductOutbound).updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(itemSummaryResponse.getProductType()),
        quickEditListArgumentCaptor.capture());
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU,
        new UpdateProductItemLevel3Model(), new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU,
        ITEM_NAME, false, StringUtils.EMPTY);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
    verify(productLevel3InventoryService, times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    verify(categoryRepository).findHierarchyByCategoryCode(Mockito.any());
    verify(pickupPointRepository).findByPickupPointCode(Mockito.any());
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_ITEM_SKU), eq(INACTIVE_STATUS), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
    verify(productLevel3Helper).isProductItemDetailChangedForListingUpdate(Mockito.any(QuickEditRequest.class),
        Mockito.any(ItemSummaryResponse.class), Mockito.any(Boolean.class));
  }

  @Test
  public void productQuickEditSyncStockOnlyItemVersionNullTest() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setVersion(null);
    quickEditRequest.setWholeSaleActivated(false);
    quickEditRequest.setDeltaStock(null);
    quickEditRequest.setUseWarehouseStock(true);
    quickEditRequest.setPickupPointCode(null);
    quickEditRequest.setOff2OnActiveFlag(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BUSINESS_PARTNER);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(campaignOutbound.validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(productPricingOutbound.setWholesaleActivated(eq(DEFAULT_ITEM_SKU), eq(INACTIVE_STATUS), Mockito.any())).thenReturn(true);
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    when(categoryRepository.findHierarchyByCategoryCode(Mockito.any())).thenReturn(new ArrayList<>());
    when(pickupPointRepository.findByPickupPointCode(Mockito.any())).thenReturn(new PickupPointResponse());
    doNothing().when(xProductOutbound)
        .updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR), quickEditListArgumentCaptor.capture());
    doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU, new UpdateProductItemLevel3Model(),
            new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU, DEFAULT_PRODUCT_NAME, false,
            StringUtils.EMPTY);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
        new ArrayList());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
    verify(productLevel3Repository, times(2)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
    verify(updateProductItemLevel3ModelConverter, times(2)).convertFromProductLevel3Summary(
        Mockito.any(ProductLevel3Summary.class));
    verify(xProductOutbound).updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(itemSummaryResponse.getProductType()),
        quickEditListArgumentCaptor.capture());
    verify(updatedProductHistoryService).saveUpdateProductLevel3Audit(MERCHANT_CODE_1, DEFAULT_ITEM_SKU,
        new UpdateProductItemLevel3Model(), new UpdateProductItemLevel3Model(), Constants.DEFAULT, DEFAULT_PRODUCT_SKU,
        ITEM_NAME, false, StringUtils.EMPTY);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
    verify(productLevel3InventoryService, times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
        DEFAULT_ITEM_SKU);
    verify(categoryRepository).findHierarchyByCategoryCode(Mockito.any());
    verify(pickupPointRepository).findByPickupPointCode(Mockito.any());
    verify(productPricingOutbound).setWholesaleActivated(eq(DEFAULT_ITEM_SKU), eq(INACTIVE_STATUS), Mockito.any());
    verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
    verify(productLevel3Helper).isProductItemDetailChangedForListingUpdate(Mockito.any(QuickEditRequest.class),
        Mockito.any(ItemSummaryResponse.class), Mockito.any(Boolean.class));
  }

  @Test
  public void productQuickEditNullSummaryTest() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    quickEditRequest.setItemSku(ITEM_SKU);
    when(productLevel3Repository.findSummaryByGdnSku(ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(getProfileResponse());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    doNothing().when(xProductOutbound)
        .updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.REGULAR), quickEditListArgumentCaptor.capture());
    when(campaignOutbound.validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
        new ArrayList());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE);
    verify(productLevel3Repository).findSummaryByGdnSku(ITEM_SKU);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(MERCHANT_CODE_1);
    verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void productQuickEditVersionTest() throws Exception {
    itemSummaryResponse.setVersion(quickEditRequest.getVersion());
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
            new ArrayList());
      });
    } finally {
      verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    }
  }

  @Test
  public void updateEditInfoWithOff2OnFlagChangeTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    product.setOff2OnChannelActive(true);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }


  @Test
  public void updateEditWithNoChangeTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());

    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithNoChangeNewlyAddedItemsTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setPostLive(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    ProductItemLevel3 productItemLevel3 = new ProductItemLevel3();
    product.setNewlyAddedItems(Collections.singletonList(productItemLevel3));
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithFreeSampleUpdatedTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());

    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    product.setFreeSample(true);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithOff2OnUpdatedTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());

    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    product.setOff2OnChannelActive(true);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithNoChangePostLiveTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());

    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithNoChangeAndRestrictedkeywordPresentTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    profileResponse.setTrustedSeller(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
        productBusinessPartner);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE_1);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.capture());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithNoChangeAndRestrictedkeywordPresentSkipAllActionsTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    profileResponse.setTrustedSeller(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
        Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
        productBusinessPartner);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false,generateProductL3Response(), false, null, null);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }


  @Test
  public void updateEditWithNoChangeAndRestrictedkeywordPresentTest_forTrustedSellers() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    profileResponse.setTrustedSeller(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
      Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
      Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    Mockito.when(this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
      EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
      productBusinessPartner);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false),
      Mockito.anyBoolean(), eq(true), Mockito.anyList(), Mockito.anyMap(), Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
      EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithNoChangeAndRestrictedkeywordPresentTest_forTrustedSellersFalseCase() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    profileResponse.setTrustedSeller(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
      Arrays.asList(new RestrictedKeywordsByField()));
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(),
      Mockito.any())).thenReturn(restrictedKeywordsByFieldAndActionType);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(new ConfigurationStatusRequest())))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    Mockito.when(this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
      EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
      productBusinessPartner);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    Mockito.when(
      productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(),
        any())).thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false),
      Mockito.anyBoolean(), eq(true), Mockito.anyList(), Mockito.anyMap(), Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.anyList(), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
      EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
      any());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithUrlUpdatedWithReviewPendingFalseTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().setUrl("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
        productBusinessPartner);
    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithAutoApproval() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setPostLive(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().setUrl("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
        productBusinessPartner);
    when(productOutbound.filterCategoryHierarchyByCategoryCode(any())).thenReturn(categoryResponses);
    when(productService.verifyAutoApprovalRules(any())).thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    product.setProductName("New Product");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
    verify(productOutbound).filterCategoryHierarchyByCategoryCode(any());
    verify(productService).verifyAutoApprovalRules(any());
    verify(productService).saveProductHistory(any(), any());
  }


  @Test
  public void updateEditWithAutoApprovalWithEmptyCategoryResponses() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setPostLive(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().setUrl("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(
      this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
        productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
      productBusinessPartner);
    when(productOutbound.filterCategoryHierarchyByCategoryCode(any())).thenReturn(Collections.emptyList());
    when(productService.verifyAutoApprovalRules(any())).thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    product.setProductName("New Product");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
      Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
    verify(productOutbound).filterCategoryHierarchyByCategoryCode(any());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(), any());
  }

  @Test
  public void updateEditWithHistoryEventSwitchTrue() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "productHistoryUpdateThroughEvent", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setPostLive(true);
    productCollection.setStoreId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().setUrl("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
        productBusinessPartner);
    when(productOutbound.filterCategoryHierarchyByCategoryCode(any())).thenReturn(categoryResponses);
    when(productService.verifyAutoApprovalRules(any())).thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    product.setProductName("New Product");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false,generateProductL3Response(), false, null, null);

    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
    verify(productOutbound).filterCategoryHierarchyByCategoryCode(any());
    verify(productService).verifyAutoApprovalRules(any());

    verify(kafkaProducer).send( anyString(), anyString(), any(InternalProductHistoryEventModel.class));
  }


  @Test
  public void updateEditWithAutoApprovalNewlyAddedL4s() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setPostLive(true);
    productCollection.setReviewPending(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().setUrl("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
        productBusinessPartner);
    when(productOutbound.filterCategoryHierarchyByCategoryCode(any())).thenReturn(categoryResponses);
    when(productService.verifyAutoApprovalRules(any())).thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    product.setProductName("New Product");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
    verify(productOutbound).filterCategoryHierarchyByCategoryCode(any());
    verify(productService).verifyAutoApprovalRules(any());
    verify(productService).saveProductHistory(any(), any());
  }


  @Test
  public void updateEditWithAutoApproval_2() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewPending(true);
    productCollection.setPostLive(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().setUrl("ABCD");
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(Mockito.any())).thenReturn(
        productBusinessPartner);
    when(productOutbound.filterCategoryHierarchyByCategoryCode(any())).thenReturn(categoryResponses);
    when(productService.verifyAutoApprovalRules(any())).thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    product.setProductName("New Product");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");

    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
    verify(productOutbound).filterCategoryHierarchyByCategoryCode(any());
    verify(productService).verifyAutoApprovalRules(any());
    verify(productService).saveProductHistory(any(), any());
  }

  @Test
  public void findSummaryDetailsByFilterMoreTest() throws Exception {
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails = new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
        ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE).merchantSku(DEFAULT_MERCHANT_SKU)
            .generatedItemName(DEFAULT_ITEM_NAME).masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
            .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
            .pickupPointCode(PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>()).isLateFulfillment(false)
            .merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);

    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories = generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
        pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku).collect(Collectors.toList());
    CampaignPriceRequest campaignPriceRequest = new CampaignPriceRequest();
    campaignPriceRequest.setCampaignPriceSkuRequestList(Arrays.asList(
        CampaignPriceSkuRequest.builder().itemSku(ITEM_SKU).categoryCode(DEFAULT_CATEGORY_CODE)
            .pickUpPointCode(PICKUP_POINT_CODE).build()));
    CampaignPriceResponse campaignPriceResponse = new CampaignPriceResponse();
    Map<String, CampaignPriceSkuResponse> itemSkuToPriceResponseMap = new HashMap<>();
    CampaignPriceSkuResponse campaignPriceSkuResponse =
        CampaignPriceSkuResponse.builder().campaignPrice(10001.0).maxAllowedPrice(10001.0).minAllowedPrice(2000.0)
            .live(true).registered(true).lockPriceUpdate(false).build();
    itemSkuToPriceResponseMap.put(ITEM_SKU, campaignPriceSkuResponse);
    campaignPriceResponse.setItemSkuToPriceResponse(itemSkuToPriceResponseMap);
    List<ProductItemResponse> productItemResponseList = new ArrayList<>();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setSkuCode(ITEM_CODE);
    productItemResponse.setUpcCode(DEFAULT_UPC_CODE);
    productItemResponse.setImages(new ArrayList<>());
    productItemResponseList.add(productItemResponse);
    when(productOutbound.getProductItemBySkuCodes(any(SkuCodesRequest.class))).thenReturn(productItemResponseList);
    Mockito.when(
            modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails))
        .thenReturn(itemFilterRequest);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
            SystemParameterConstants.SAP_CALL_ENABLED))
        .thenReturn(new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true", "sapCallEnabled", false));
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE)).thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
        .thenReturn(mapOfProductInventories);
    Mockito.when(modelConverter.convertItemSkusToCampaignPriceRequest(eq(Arrays.asList(ITEM_SKU)), eq(DEFAULT_CATEGORY_CODE),
        eq(itemSkuAndPickupCodeMap), any())).thenReturn(campaignPriceRequest);
    Mockito.when(campaignOutbound.getCampaignPriceInfoV2(campaignPriceRequest)).thenReturn(campaignPriceResponse);
    Mockito.when(modelConverter.convertCampaignPriceResponseListToCampaignPriceSkuResponseMap(
        Arrays.asList(campaignPriceResponse))).thenReturn(itemSkuToPriceResponseMap);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
        new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "true", "campaignPriceValidation", false));

    Page<ProductLevel3SummaryDetails> result =
        productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID, productLevel3SummaryFilterDetails,
            PAGEABLE);

    Mockito.verify(modelConverter)
        .convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(), listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(campaignOutbound).getCampaignPriceInfoV2(campaignPriceRequest);
    Mockito.verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(sapOutbound).getCogsValueResponse(any());
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, result.getContent().get(0).getProductSku());
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
    Assertions.assertEquals(10001.0, result.getContent().get(0).getCampaignCurrentPrice(), 0);
    Assertions.assertEquals(10001.0, result.getContent().get(0).getCampaignMaxPrice(), 0);
    Assertions.assertEquals(2000.0, result.getContent().get(0).getCampaignMinPrice(), 0);
    Assertions.assertTrue(result.getContent().get(0).isItemCampaignMapped());
    Assertions.assertTrue(result.getContent().get(0).isItemCampaignActivated());
  }

  @Test
  public void updateHasOrderTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setRestrictedKeywordsByFieldList(
        Arrays.asList(new RestrictedKeywordsByField()));
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProductLevel3ViewConfig productLevel3ViewConfig = new ProductLevel3ViewConfig();
    productLevel3ViewConfig.setBuyable(false);
    productLevel3ViewConfig.setDisplay(false);
    productLevel3ViewConfig.setChannelId("DEFAULT");
    product.getItems().get(0).setViewConfigs(Arrays.asList(productLevel3ViewConfig));
    ProfileResponse businessPartner = getProfileResponse();
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    product.getItems().get(0).setLogistics(Arrays.asList(productLevel3Logistics));
    product.getItems().get(0).setMerchantSku(SKU_CODE);
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    savedProductData.getItems().get(0).setMerchantSku(SKU_CODE);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setSynchronized(true);
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ItemViewConfigDTO itemViewConfigDTO = new ItemViewConfigDTO();
    itemViewConfigDTO.setBuyable(true);
    itemViewConfigDTO.setDiscoverable(true);
    itemViewConfigDTO.setChannel("DEFAULT");
    Set<ItemViewConfigDTO> set = new HashSet();
    set.add(itemViewConfigDTO);
    productData.getItems().get(0).setItemViewConfigs(set);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(Arrays.asList(productLevel3Logistics));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    ProductEditValidationDTO productEditValidationDTO = new ProductEditValidationDTO();
    productEditValidationDTO.setProductL3Response(savedProductData1);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productLevel3V2Service.validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false))).thenReturn(
        productEditValidationDTO);
    Mockito.when(this.productOutbound.getReviewConfiguration(Mockito.anyList()))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setFieldIdentifier(PRODUCT_DESCRIPTION1);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(restrictedKeywordsByFieldAndActionType);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    when(productSystemParameterService.findByStoreIdAndVariable(product.getStoreId(),
        SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.ITEM_SUMMARY_PAGE_SIZE, "1", "max-size", false));
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    Mockito.when(productBusinessPartnerService.updateProductItemBusinessPartnerStateTakeDownTrue(any(), any(), any()))
        .thenReturn(new ProductBusinessPartnerAndItemViewConfigDto(productBusinessPartner, new ArrayList<>()));
    product.setProductName(savedProductData1.getMasterDataProduct().getProductName());
    product.setPreOrder(new com.gdn.mta.product.entity.PreOrderDTO());
    product.setProductType(1);
    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, false, true);

    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(getProductLevel3Repository(), times(3)).findDetailByGdnSku(Mockito.any());
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(this.businessPartnerRepository, times(3)).filterDetailByBusinessPartnerCode(Mockito.anyString());
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(this.businessPartnerRepository, times(3)).filterDetailByBusinessPartnerCode(Mockito.anyString());
    verify(updatedProductHistoryService,times(4)).createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), anyBoolean(), eq(StringUtils.EMPTY));
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(getProductLevel3Repository(), times(2)).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(xProductOutbound, times(3)).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(this.productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productOutbound).getReviewConfiguration(Mockito.anyList());
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(updatedProductHistoryService, times(4)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound, times(2)).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(xProductOutbound, times(1)).generateProductScoreByProductSkuOrProductCode(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound)
        .generateProductScoreByProductSkuOrProductCode(Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound).findSummaryDetailsByFilter(any(), any());
    verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
  }

  @Test
  public void updateHasOrder1Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "syncProductDataOnLogisticUpdate", true);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    product.getItems().get(0).setLogistics(Arrays.asList(productLevel3Logistics));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setSynchronized(true);
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Mockito.anyList()))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    product.setPreOrder(new com.gdn.mta.product.entity.PreOrderDTO());
    ProductEditValidationDTO productEditValidationDTO = new ProductEditValidationDTO();
    productEditValidationDTO.setProductL3Response(savedProductData1);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productLevel3V2Service.validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false))).thenReturn(
        productEditValidationDTO);
    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, false, false);

    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(getProductLevel3Repository(), times(3)).findDetailByGdnSku(Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(this.businessPartnerRepository, times(3)).filterDetailByBusinessPartnerCode(Mockito.anyString());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), anyBoolean(), eq(StringUtils.EMPTY));
    verify(getProductLevel3Repository(), times(2)).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound, times(3)).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(this.productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productOutbound).getReviewConfiguration(Mockito.anyList());
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(xProductOutbound, times(1)).generateProductScoreByProductSkuOrProductCode(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound)
        .generateProductScoreByProductSkuOrProductCode(Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
    verify(productLevel3Repository).synchronizeProduct(DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void updateLogisticsWithFbbPpCodesSwitchTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "addFbbPickupPointCodesForLogisticsUpdateCheck", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "fbbPickupPointCodesLogisticsUpdateValidationChange", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "syncProductDataOnLogisticUpdate", true);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    product.getItems().get(0).setLogistics(Arrays.asList(productLevel3Logistics));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setSynchronized(true);
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Mockito.anyList()))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    product.setPreOrder(new com.gdn.mta.product.entity.PreOrderDTO());
    ProductEditValidationDTO productEditValidationDTO = new ProductEditValidationDTO();
    productEditValidationDTO.setProductL3Response(savedProductData1);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productLevel3V2Service.validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false))).thenReturn(
        productEditValidationDTO);
    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, false, false);

    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(getProductLevel3Repository(), times(3)).findDetailByGdnSku(Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(this.businessPartnerRepository, times(3)).filterDetailByBusinessPartnerCode(Mockito.anyString());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), anyBoolean(), eq(StringUtils.EMPTY));
    verify(getProductLevel3Repository(), times(2)).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound, times(3)).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(this.productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productOutbound).getReviewConfiguration(Mockito.anyList());
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(xProductOutbound, times(1)).generateProductScoreByProductSkuOrProductCode(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound)
        .generateProductScoreByProductSkuOrProductCode(Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
    verify(productLevel3Repository).synchronizeProduct(DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void updateLogisticsWithFbbPpCodesSwitch2Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "addFbbPickupPointCodesForLogisticsUpdateCheck", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "fbbPickupPointCodesLogisticsUpdateValidationChange", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "syncProductDataOnLogisticUpdate", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "setWaitingDeletionForDeletePickupPoint", true);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    product.getItems().get(0).setLogistics(Arrays.asList(productLevel3Logistics));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setSynchronized(true);
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setFbbPickupPointCodes(Collections.singletonList(PICKUP_POINT_CODE));
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setFbbActivated(true);
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(this.businessPartnerRepository.filterPickupPointsByPickupPointRequest(
        pickupPointFilterRequestArgumentCaptor.capture())).thenReturn(Collections.singletonList(pickupPointResponse));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Mockito.anyList()))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    product.setPreOrder(new com.gdn.mta.product.entity.PreOrderDTO());
    ProductEditValidationDTO productEditValidationDTO = new ProductEditValidationDTO();
    productEditValidationDTO.setProductL3Response(savedProductData1);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productLevel3V2Service.validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false))).thenReturn(
        productEditValidationDTO);
    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, false, false);

    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(getProductLevel3Repository(), times(3)).findDetailByGdnSku(Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(this.businessPartnerRepository, times(3)).filterDetailByBusinessPartnerCode(Mockito.anyString());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), anyBoolean(), eq(StringUtils.EMPTY));
    verify(getProductLevel3Repository(), times(2)).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound, times(3)).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(this.productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productOutbound).getReviewConfiguration(Mockito.anyList());
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(xProductOutbound, times(1)).generateProductScoreByProductSkuOrProductCode(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound)
        .generateProductScoreByProductSkuOrProductCode(Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
    verify(productLevel3Repository).synchronizeProduct(DEFAULT_PRODUCT_SKU);
    Assertions.assertFalse(pickupPointFilterRequestArgumentCaptor.getValue().getWaitingDeletion());
  }

  @Test
  public void updateHasOrderWithCheckProductForReviewFalseTest() throws Exception {
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    product.getItems().get(0).setLogistics(Arrays.asList(productLevel3Logistics));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setSynchronized(true);
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU))).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Mockito.anyList()))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "false", "product-review", false));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, false, true);

    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
        Mockito.any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        PICKUP);
    verify(getProductLevel3InventoryService(), times(2)).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).updateProduct(eq(false), Mockito.any());
    verify(xProductOutbound).updateItem(eq(false), eq(false), eq(false), Mockito.any());
    verify(getProductLevel3InventoryService()).updateStock(Mockito.any(), Mockito.any(), Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
        Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
        Mockito.any());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(getProductLevel3InventoryService(), TWO_TIMES).findInventoryByBusinessPartnerCodeAndGdnSku(
        DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU);
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3(
        Mockito.any(ProductLevel3.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(any());
  }

  @Test
  public void updateHasOrderTrueTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    product.getItems().get(0).setLogistics(Arrays.asList(productLevel3Logistics));

    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    savedProductData1.setSynchronized(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getItems().get(0).setPickupPointCode(PICKUP);
    productData.getItems().get(0).setMerchantSku(PICKUP);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Mockito.anyList()))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    product.getItems().get(0).setMerchantSku(null);
    productData.getItems().get(0).setMerchantSku(null);
    product.setPreOrder(new com.gdn.mta.product.entity.PreOrderDTO());
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    ProductEditValidationDTO productEditValidationDTO = new ProductEditValidationDTO();
    productEditValidationDTO.setProductL3Response(savedProductData1);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productLevel3V2Service.validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false))).thenReturn(
        productEditValidationDTO);
    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, true, true);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(getProductLevel3Repository(), times(3)).findDetailByGdnSku(Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
        Mockito.any());
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(this.businessPartnerRepository, times(3)).filterDetailByBusinessPartnerCode(Mockito.anyString());
    verify(getProductLevel3Repository(), times(2)).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound, times(3)).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(this.productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productOutbound).getReviewConfiguration(Mockito.anyList());
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(updatedProductHistoryService, times(2)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound, times(1)).generateProductScoreByProductSkuOrProductCode(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound)
        .generateProductScoreByProductSkuOrProductCode(Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
  }

  @Test
  public void updateHasOrderTrueSameNameTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateDimensionInL3Update", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "maxProductDimensionLimit", 10000);
    ProductLevel3 product = generateProductLevel3();
    product.setProductType(1);
    product.setLength(10.0);
    product.setWeight(10.0);
    product.setWidth(10.0);
    product.setWeight(10.0);
    product.setShippingWeight(10.0);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    product.getItems().get(0).setLogistics(Arrays.asList(productLevel3Logistics));

    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    savedProductData1.setSynchronized(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getItems().get(0).setPickupPointCode(PICKUP);
    productData.getItems().get(0).setMerchantSku(PICKUP);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    ProductEditValidationDTO productEditValidationDTO = new ProductEditValidationDTO();
    productEditValidationDTO.setProductL3Response(savedProductData1);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productLevel3V2Service.validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false))).thenReturn(
        productEditValidationDTO);
    Mockito.when(this.productOutbound.getReviewConfiguration(Mockito.anyList()))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    product.setProductName(savedProductData1.getMasterDataProduct().getProductName());
    product.getItems().get(0).setMerchantSku("1");
    productData.getItems().get(0).setMerchantSku(StringUtils.EMPTY);
    product.setPreOrder(new com.gdn.mta.product.entity.PreOrderDTO());
    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, true, true);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(getProductLevel3Repository(), times(3)).findDetailByGdnSku(Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
        Mockito.any());
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(getProductLevel3Repository(), times(2)).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(xProductOutbound, times(3)).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(this.productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productOutbound).getReviewConfiguration(Mockito.anyList());
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(updatedProductHistoryService, times(3)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(xProductOutbound, times(1)).generateProductScoreByProductSkuOrProductCode(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound, times(1)).generateProductScoreByProductSkuOrProductCode(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound, times(2)).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(businessPartnerRepository, times(3)).filterDetailByBusinessPartnerCode(Mockito.anyString());
    verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),
        Mockito.any(EditProductResponse.class), Mockito.any(), Mockito.anyBoolean(), any(), Mockito.anyList(),
        Mockito.any(), Mockito.anyBoolean(), Mockito.anyBoolean());
  }

  @Test
  public void update_sameMerchantSkuTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateDimensionInL3Update", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    ProductLevel3 product = generateProductLevel3();
    product.setProductType(3);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    product.getItems().get(0).setLogistics(Arrays.asList(productLevel3Logistics));

    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    savedProductData1.setSynchronized(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getItems().get(0).setPickupPointCode(PICKUP);
    productData.getItems().get(0).setMerchantSku(PICKUP);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(productData);
    ProductEditValidationDTO productEditValidationDTO = new ProductEditValidationDTO();
    productEditValidationDTO.setProductL3Response(savedProductData1);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productLevel3V2Service.validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false))).thenReturn(
        productEditValidationDTO);
    Mockito.when(this.productOutbound.getReviewConfiguration(Mockito.anyList()))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    product.setProductName(savedProductData1.getMasterDataProduct().getProductName());
    product.getItems().get(0).setMerchantSku(StringUtils.EMPTY);
    productData.getItems().get(0).setMerchantSku(PICKUP);
    product.setPreOrder(new com.gdn.mta.product.entity.PreOrderDTO());
    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, true, true);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(getProductLevel3Repository(), times(3)).findDetailByGdnSku(Mockito.any());
    verify(getProductLevel3InventoryService()).updatePickupPoint(Mockito.any(), Mockito.any(),
        Mockito.any());
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
    verify(this.businessPartnerRepository, times(3)).filterDetailByBusinessPartnerCode(Mockito.any());
    verify(getProductLevel3Repository(), times(2)).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound, times(3)).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(this.productOutbound).getAttributeDetailByAttributeCode(Mockito.any());
    verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(this.productOutbound).getReviewConfiguration(Mockito.anyList());
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(updatedProductHistoryService, times(3)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound, times(2)).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(xProductOutbound, times(1)).generateProductScoreByProductSkuOrProductCode(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean());
    verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
        EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyBoolean());
    verify(productBusinessPartnerService).updateProductMasterData(DEFAULT_PRODUCT_SKU,
      PRODUCT_NAME1, DEFAULT_CATEGORY_CODE, null, null, null, false,"TEST");
  }

  @Test
  public void updateWithHasOrderSuspendedProductTest() throws Exception {
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setMarkForDelete(true);
    savedProductData1.setSuspended(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, false, true);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService, times(1)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(1)).findHierarchyByCategoryCode(Mockito.any());
    verify(productBusinessPartnerRepository).countRejectedProductByGdnProductSku(Mockito.any());
  }

  @Test
  public void updateWithHasOrderBigProductShippingWeight0Test() throws Exception {
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setProductEditable(false);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ProductLevel3 product = generateProductLevel3();
    product.setProductType(2);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setShippingWeight(0.0);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());

    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, false, true);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(productLevel3LogisticsService, times(1)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(1)).findHierarchyByCategoryCode(Mockito.any());
  }

  @Test
  public void update_existingLogisticsEmpty() throws Exception {
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
        new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setProductEditable(false);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    ProductLevel3 product = generateProductLevel3();
    product.setProductType(2);
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getItems().get(0).setShippingWeight(0.0);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    Mockito.when(
            productLevel3LogisticsService.findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.EMPTY_LIST);
    ProductLevel3DTO updatedProduct = this.productLevel3ServiceBean.update(product, 5, 2, false, false, false);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW);
    verify(productLevel3LogisticsService, times(1)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    verify(getCategoryRepository(), times(1)).findHierarchyByCategoryCode(Mockito.any());
  }

  @Test
  public void getProductSuspensionHistoryByProductSkusTest() {
    productSuspensionHistory.setStatus(SuspensionStatus.SUSPENDED);
    Mockito.when(
        this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
            STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(productSuspensionHistory);
    List<ProductSuspensionHistoryResponse> productSuspensionHistoryResponses =
        this.productLevel3ServiceBean.getProductSuspensionHistoryByProductSkus(STORE_ID,
            Arrays.asList(DEFAULT_PRODUCT_SKU));
    Mockito.verify(this.productSuspensionHistoryRepository)
        .findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(STORE_ID, DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, productSuspensionHistoryResponses.get(0).getProductSku());
    Assertions.assertEquals(SuspensionStatus.SUSPENDED.name(), productSuspensionHistoryResponses.get(0).getStatus());
  }

  @Test
  public void getProductSuspensionHistoryByProductSkusNullStatusTest() {
    Mockito.when(
        this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
            STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(productSuspensionHistory);
    List<ProductSuspensionHistoryResponse> productSuspensionHistoryResponses =
        this.productLevel3ServiceBean.getProductSuspensionHistoryByProductSkus(STORE_ID,
            Arrays.asList(DEFAULT_PRODUCT_SKU));
    Mockito.verify(this.productSuspensionHistoryRepository)
        .findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(STORE_ID, DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, productSuspensionHistoryResponses.get(0).getProductSku());
    ;
  }

  @Test
  public void getProductSuspensionHistoryByProductSkus_emptyResultTest() {
    Mockito.when(
        this.productSuspensionHistoryRepository.findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(
            STORE_ID, DEFAULT_PRODUCT_SKU)).thenReturn(null);
    List<ProductSuspensionHistoryResponse> productSuspensionHistoryResponses =
        this.productLevel3ServiceBean.getProductSuspensionHistoryByProductSkus(STORE_ID,
            Arrays.asList(DEFAULT_PRODUCT_SKU));
    Mockito.verify(this.productSuspensionHistoryRepository)
        .findTop1ByStoreIdAndProductSkuAndMarkForDeleteFalseOrderByCreatedDateDesc(STORE_ID, DEFAULT_PRODUCT_SKU);
    Assertions.assertTrue(CollectionUtils.isEmpty(productSuspensionHistoryResponses));
  }

  @Test
  public void updateLogistics_withLogisticsChangeWithPinPointCheckTest() throws Exception {
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLateFulfillment(true);
    productLevel3UpdateRequest.setVersion(2L);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    PickupPointDTO pickupPointDTO = new PickupPointDTO();
    pickupPointDTO.setCode(PICKUP);
    GeolocationDTO geolocationDTO = new GeolocationDTO();
    geolocationDTO.setPlaceId(PICKUP);
    pickupPointDTO.setGeolocation(geolocationDTO);
    profileResponse.setPickupPoints(Arrays.asList(pickupPointDTO));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setPickupPointCodes(Arrays.asList(PICKUP));
    savedProductData1.setVersion(1L);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(true);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE, Constants.DEFAULT,
        DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.LOGISTIC.getDesc(),
        String.valueOf(Collections.EMPTY_LIST), String.valueOf(Collections.singletonList("GOJEK")), false,
        StringUtils.EMPTY);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(any(), any(), any(),
            any(), any(), Mockito.any(), Mockito.any(),
            Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateLogistics_withLogisticsChangeWithPinPointCheck1Test() throws Exception {
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLateFulfillment(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    PickupPointDTO pickupPointDTO = new PickupPointDTO();
    pickupPointDTO.setCode(PICKUP);
    pickupPointDTO.setGeolocation(new GeolocationDTO());
    profileResponse.setPickupPoints(Arrays.asList(pickupPointDTO));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setPickupPointCodes(Arrays.asList(PICKUP));
    savedProductData1.setVersion(1L);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(true);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
        Mockito.anyList(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).createProductL3AuditLog(DEFAULT_BUSINESS_PARTNER_CODE, Constants.DEFAULT,
        DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, UpdateProductActivity.LOGISTIC.getDesc(),
        String.valueOf(Collections.EMPTY_LIST), String.valueOf(Collections.singletonList("GOJEK")), false,
        StringUtils.EMPTY);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(any(), any(), any(),
            any(), any(), Mockito.any(), Mockito.any(),
            Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);

  }

  @Test
  public void updateLogistics_withLogisticsChangeWithPinPointCheckErrorTest() throws Exception {
    productLevel3UpdateRequest.setProductType(1);
    productLevel3UpdateRequest.setLateFulfillment(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode(PICKUP);
    productLevel3Logistics.setSelected(true);
    productLevel3Logistics.setRequiredLongLat(true);
    productLevel3UpdateRequest.setProductLevel3LogisticsRequest(Arrays.asList(productLevel3Logistics));
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(Arrays.asList(productLevel3Logistics));
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    PickupPointDTO pickupPointDTO = new PickupPointDTO();
    pickupPointDTO.setCode(PICKUP);
    pickupPointDTO.setGeolocation(new GeolocationDTO());
    profileResponse.setPickupPoints(Arrays.asList(pickupPointDTO));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setPickupPointCodes(Arrays.asList(PICKUP));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(true);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false,
        false, true);
    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    Mockito.verify(updatedProductHistoryService)
        .saveUpdateProductLevel3Audit(any(), any(), any(),
            any(), any(), Mockito.any(), Mockito.any(),
            Mockito.anyBoolean(), Mockito.any());
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void checkIfItemChangedTest() throws Exception {
    UpdateItemSummaryRequest productLevel3UpdateSummarryRequest = new UpdateItemSummaryRequest();
    productLevel3UpdateSummarryRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    ItemViewConfigDTO itemViewConfigDTO = new ItemViewConfigDTO();
    itemViewConfigDTO.setBuyable(true);
    itemViewConfigDTO.setDiscoverable(false);
    productLevel3UpdateSummarryRequest.setItemViewConfigs(new HashSet<>(Arrays.asList(itemViewConfigDTO)));
    productLevel3UpdateSummarryRequest.setPrice(generateItemSummaryData().getPrice());
    productLevel3UpdateSummarryRequest.setOff2OnChannelActive(true);
    productLevel3UpdateSummarryRequest.setWholesalePriceActivated(true);
    ItemSummaryResponse savedProductData = new ItemSummaryResponse();
    savedProductData.setMerchantSku(StringUtils.EMPTY);
    savedProductData.setItemViewConfigs(generateItemSummaryData().getItemViewConfigs());
    PriceDTO priceDTO = new PriceDTO();
    priceDTO.setOfferPrice(1000000);
    priceDTO.setListPrice(100000000);
    savedProductData.setPrice(new HashSet<>(Arrays.asList(priceDTO)));
    savedProductData.setOff2OnChannelActive(false);
    savedProductData.setWholesalePriceActivated(false);
    boolean isChangeItem =
        productLevel3ServiceBean.checkIfItemChanged(productLevel3UpdateSummarryRequest, savedProductData);
    Assertions.assertTrue(isChangeItem);
  }

  @Test
  public void checkIfItemChanged1Test() throws Exception {
    UpdateItemSummaryRequest productLevel3UpdateSummarryRequest = new UpdateItemSummaryRequest();
    productLevel3UpdateSummarryRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    ItemViewConfigDTO itemViewConfigDTO = new ItemViewConfigDTO();
    itemViewConfigDTO.setBuyable(true);
    itemViewConfigDTO.setDiscoverable(false);
    productLevel3UpdateSummarryRequest.setItemViewConfigs(new HashSet<>(Arrays.asList(itemViewConfigDTO)));
    productLevel3UpdateSummarryRequest.setPrice(generateItemSummaryData().getPrice());
    productLevel3UpdateSummarryRequest.setOff2OnChannelActive(true);
    productLevel3UpdateSummarryRequest.setWholesalePriceActivated(true);
    ItemSummaryResponse savedProductData = new ItemSummaryResponse();
    savedProductData.setMerchantSku(StringUtils.EMPTY);
    savedProductData.setItemViewConfigs(generateItemSummaryData().getItemViewConfigs());
    PriceDTO priceDTO = new PriceDTO();
    priceDTO.setOfferPrice(100000);
    priceDTO.setListPrice(1000);
    savedProductData.setPrice(new HashSet<>(Arrays.asList(priceDTO)));
    savedProductData.setOff2OnChannelActive(false);
    savedProductData.setWholesalePriceActivated(false);
    boolean isChangeItem =
        productLevel3ServiceBean.checkIfItemChanged(productLevel3UpdateSummarryRequest, savedProductData);
    Assertions.assertTrue(isChangeItem);
  }

  @Test
  public void checkIfItemChangedNoChangeTest() throws Exception {
    UpdateItemSummaryRequest productLevel3UpdateSummarryRequest = new UpdateItemSummaryRequest();
    productLevel3UpdateSummarryRequest.setMerchantSku(DEFAULT_MERCHANT_SKU);
    ItemViewConfigDTO itemViewConfigDTO = new ItemViewConfigDTO();
    itemViewConfigDTO.setBuyable(true);
    itemViewConfigDTO.setDiscoverable(true);
    productLevel3UpdateSummarryRequest.setItemViewConfigs(new HashSet<>(Arrays.asList(itemViewConfigDTO)));
    productLevel3UpdateSummarryRequest.setPrice(generateItemSummaryData().getPrice());
    productLevel3UpdateSummarryRequest.setOff2OnChannelActive(true);
    productLevel3UpdateSummarryRequest.setWholesalePriceActivated(true);
    ItemSummaryResponse savedProductData = new ItemSummaryResponse();
    savedProductData.setMerchantSku(DEFAULT_MERCHANT_SKU);
    savedProductData.setItemViewConfigs(generateItemSummaryData().getItemViewConfigs());
    savedProductData.setPrice(itemSummaryResponse.getPrice());
    savedProductData.setOff2OnChannelActive(true);
    savedProductData.setWholesalePriceActivated(true);
    boolean isChangeItem =
        productLevel3ServiceBean.checkIfItemChanged(productLevel3UpdateSummarryRequest, savedProductData);
    Assertions.assertFalse(isChangeItem);
  }

  @Test
  public void checkIfItemChangedEmptyTest() throws Exception {
    UpdateItemSummaryRequest productLevel3UpdateSummarryRequest = new UpdateItemSummaryRequest();
    ItemSummaryResponse savedProductData = new ItemSummaryResponse();
    boolean isChangeItem =
        productLevel3ServiceBean.checkIfItemChanged(productLevel3UpdateSummarryRequest, savedProductData);
    Assertions.assertFalse(isChangeItem);
  }

  @Test
  public void getProductIdProductCodeMapTest() throws Exception {
    productCollection.setProductId(PRODUCT_CODE);
    when(productCollectionRepository.findByStoreIdAndProductIds(STORE_ID, Arrays.asList(PRODUCT_CODE))).thenReturn(
        Collections.singletonList(productCollection));
    this.productLevel3ServiceBean.getProductIdProductCodeMap(STORE_ID, Arrays.asList(PRODUCT_CODE));
    verify(productCollectionRepository).findByStoreIdAndProductIds(STORE_ID, Arrays.asList(PRODUCT_CODE));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setSalePrice(1000.0);
    productItemBusinessPartner.setPrice(1000.0);
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionValuesChangeTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    verify(updatedProductHistoryService, times(7)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionValuesWholesalePriceChangeTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(false);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(9)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionValuesWholesalePriceNoChangeTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(true);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(7)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(variantEditValidationService).isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null));
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionValuesNewWholesalePriceTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(false);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(DEFAULT_ITEM_SKU);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(9)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(getProductLevel3InventoryService()).updateStockV2(Mockito.any(), Mockito.any(),
        Mockito.anyInt());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionValuesNoWholesaleflagTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(null);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setMinimumStockLevel2(2);
    productPriceStockAndImagesRequest.setSynchronizeStock(null);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(DEFAULT_ITEM_SKU);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(8)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(getProductLevel3InventoryService()).updateStockV2(Mockito.any(), Mockito.any(),
        Mockito.anyInt());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionValuesMinStockValuesTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(null);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setMinimumStockLevel2(10);
    productPriceStockAndImagesRequest.setSynchronizeStock(true);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(DEFAULT_ITEM_SKU);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    businessPartnerData.getCompany().setInventoryFulfillment("BP");
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(this.businessPartnerData);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(8)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(getProductLevel3InventoryService()).updateStockV2(Mockito.any(), Mockito.any(),
        Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
        Mockito.anyInt());
    Mockito.verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(any());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionSyncStockTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(DEFAULT_DELTA_STOCK);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(null);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setMinimumStockLevel2(10);
    productPriceStockAndImagesRequest.setSynchronizeStock(false);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(DEFAULT_ITEM_SKU);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(this.businessPartnerData);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    Mockito.when(
            this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(any(), any()))
        .thenReturn(new ProductLevel3Inventory());
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(9)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(getProductLevel3InventoryService()).updateStockV2(Mockito.any(), Mockito.any(),
        Mockito.anyInt());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
        Mockito.anyInt());
    Mockito.verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(any());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionSyncStockTrueTest() throws Exception {
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(null);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(null);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setMinimumStockLevel2(10);
    productPriceStockAndImagesRequest.setSynchronizeStock(true);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(DEFAULT_ITEM_SKU);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(this.businessPartnerData);
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    productLevel3Inventory.setWebSyncStock(false);
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(
        getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
            DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(8)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
        Mockito.anyInt());
    Mockito.verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(any());
    verify(getProductLevel3InventoryService()).updateSyncStockByBusinessPartnerCodeAndGdnSku(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionSyncStockNoChangeTest() throws Exception {
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(null);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(null);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setMinimumStockLevel2(10);
    productPriceStockAndImagesRequest.setSynchronizeStock(false);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(DEFAULT_ITEM_SKU);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(this.businessPartnerData);
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    productLevel3Inventory.setWebSyncStock(false);
    Mockito.when(
        getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
            DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(7)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(getProductLevel3InventoryService()).updateMinimumStockAlert(Mockito.any(), Mockito.any(),
        Mockito.anyInt());
    Mockito.verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(any());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrectionSyncStockNoInvertoryTest() throws Exception {
    productCollection.setPostLive(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(null);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(null);
    productPriceStockAndImagesRequest.setPickupPointCode(PICKUP_POINT_CODE);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setMinimumStockLevel2(10);
    productPriceStockAndImagesRequest.setSynchronizeStock(false);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(DEFAULT_ITEM_SKU);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    Mockito.when(
            productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList()))
        .thenReturn(new ArrayList());
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    productLevel3Inventory.setWebSyncStock(false);
    Mockito.when(
        getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
            DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(7)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrection_edited() throws Exception {
    productCollection.setEdited(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(null);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(null);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setMinimumStockLevel2(10);
    productPriceStockAndImagesRequest.setSynchronizeStock(false);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(DEFAULT_ITEM_SKU);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    Mockito.when(
            productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList()))
        .thenReturn(new ArrayList());
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    productLevel3Inventory.setWebSyncStock(false);
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    Mockito.when(
        getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
            DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(7)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void editProductItemsPriceStockImagesNeedCorrection_NoInvCall() throws Exception {
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.setItemSku(DEFAULT_ITEM_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest =
        new ProductLevel3ViewConfigRequest(DEFAULT_CHANNEL_ID, false, false);
    productPriceStockAndImagesRequest.setViewConfigs(Arrays.asList(productLevel3ViewConfigRequest));
    ProductLevel3PriceRequest price = new ProductLevel3PriceRequest();
    price.setPrice(1000.0);
    price.setSalePrice(1000.0);
    productPriceStockAndImagesRequest.setPrices(Arrays.asList(price));
    productPriceStockAndImagesRequest.setDeltaStock(null);
    productPriceStockAndImagesRequest.setWholesalePriceActivated(null);
    productPriceStockAndImagesRequest.setProductItemWholesalePrices(Arrays.asList(productItemWholesalePriceRequest));
    productPriceStockAndImagesRequest.setMinimumStockLevel2(10);
    productPriceStockAndImagesRequest.setSynchronizeStock(false);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    List<VariantsErrorListResponse> failedRequests = new ArrayList<>();
    SkuCodesRequest skuCodesRequest = new SkuCodesRequest();
    skuCodesRequest.setFetchArchived(true);
    skuCodesRequest.setSkuCodes(Arrays.asList(DEFAULT_SKU_CODE));
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setNeedCorrection(true);
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(STOCK_AVAILABLE_1);
    productItemBusinessPartner.setMinimumStock(MINIMUM_STOCK);
    productItemBusinessPartner.setSalePrice(10000.0);
    productItemBusinessPartner.setPrice(10000.0);
    productItemBusinessPartner.setBuyable(true);
    productItemBusinessPartner.setDisplay(true);
    productItemBusinessPartner.setGdnProductItemSku(DEFAULT_ITEM_SKU);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    Mockito.when(mapperUtil.mapRequestToString(Mockito.any())).thenReturn(WHOLESALE_RULE_1);
    when(productPricingOutbound.getWholesalePriceList(Mockito.anySet(), Mockito.anyMap())).thenReturn(
        Arrays.asList(wholesalePriceSkuResponse));
    when(variantEditValidationService.isSameThreshold(Mockito.any(ProductPriceStockAndImagesRequest.class),
        Mockito.any(), Mockito.any(), Mockito.any(WholesalePriceSkuResponse.class), eq(null))).thenReturn(
        true);
    when(productItemBusinessPartnerRepository.findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList())).thenReturn(Arrays.asList(productItemBusinessPartner));
    Mockito.when(
            productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList()))
        .thenReturn(new ArrayList());
    when(campaignOutbound.validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(variantEditValidationService.validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests)).thenReturn(successValidationVariantList);
    when(productPricingOutbound.getWholesalePrice(eq(productPriceStockAndImagesRequest.getItemSku()), Mockito.any())).thenReturn(
        wholesalePriceSkuResponse);
    when(variantEditValidationService.isSameThreshold(productPriceStockAndImagesRequest, DEFAULT_CATEGORY_CODE,
        DEFAULT_ITEM_SKU, wholesalePriceSkuResponse, null)).thenReturn(true);
    productLevel3Inventory.setWebSyncStock(false);
    Mockito.when(
        getProductLevel3InventoryService().findInventoryByBusinessPartnerCodeAndGdnSku(DEFAULT_BUSINESS_PARTNER_CODE,
            DEFAULT_GDN_SKU)).thenReturn(productLevel3Inventory);
    Mockito.when(productItemWholesalePriceService.findByStoreIdAndItemSkus(any(), anyList()))
        .thenReturn(Arrays.asList(productItemWholesalePrice));
    productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productItemBusinessPartnerRepository).findByStoreIdAndMarkForDeleteFalseAndGdnProductItemSkuIn(any(),
        anyList());
    verify(variantEditValidationService).validateListOfVariantsForNeedCorrection(productPriceStockAndImagesRequests,
        failedRequests);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productItemBusinessPartnerRepository).save(any(ProductItemBusinessPartner.class));
    Mockito.verify(productLevel3Repository).getProductNameByProductSku(anyList());
    Mockito.verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(any(), anyList());
    Mockito.verify(variantEditValidationService)
        .validatePriceLockCampaignRequest(any(ProductPriceStockAndImagesRequest.class), anyList());
    Mockito.verify(productItemWholesalePriceService).saveWholesalePrice(anyList());
    verify(updatedProductHistoryService, times(7)).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(productPricingOutbound).getWholesalePriceList(Mockito.anySet(), Mockito.anyMap());
    verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class));
  }

  @Test
  public void findSummaryDetailsByFilterNeedCorrectionCampaignValidationSwitchOffTest() throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails = new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    productLevel3SummaryFilterDetails.setNeedCorrection(false);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
        ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode("itemCode").merchantSku(DEFAULT_MERCHANT_SKU)
            .generatedItemName(DEFAULT_ITEM_NAME).masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
            .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
            .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>()).isLateFulfillment(false)
            .merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories = generateMapOfProductInventories(items, inventories);
    List<String> listOfGdnSkus =
        pageOfItems.getContent().stream().map(ItemSummaryDetailResponse::getItemSku).collect(Collectors.toList());
    wholesalePriceSkuResponse.setSkuStatus(null);
    wholesalePriceSkuResponse.setPromoActive(true);
    Mockito.when(
            modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails))
        .thenReturn(itemFilterRequest);
    Mockito.when(xProductOutbound.findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE)).thenReturn(pageOfItems);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        filterRequest.getBusinessPartnerCode(), listOfGdnSkus)).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
        .thenReturn(mapOfProductInventories);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
        new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "false", "campaignPriceValidation", false));
    Mockito.when(productPricingOutbound.getWholesalePriceList(eq(new HashSet<>(Arrays.asList(ITEM_SKU))), Mockito.anyMap()))
        .thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
            SystemParameterConstants.SAP_CALL_ENABLED))
        .thenReturn(new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true", "sapCallEnabled", false));
    Page<ProductLevel3SummaryDetails> result =
        productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID, productLevel3SummaryFilterDetails,
            PAGEABLE);

    Mockito.verify(modelConverter)
        .convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails);
    Mockito.verify(productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(filterRequest.getBusinessPartnerCode(), listOfGdnSkus);
    Mockito.verify(modelConverter).convertProductLevel3InventoryToMapOfGdnSku(inventories);
    Mockito.verify(xProductOutbound).findSummaryDetailsByFilter(itemFilterRequest, PAGEABLE);
    Mockito.verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productOutbound).getProductItemBySkuCodes(any(SkuCodesRequest.class));
    Mockito.verify(productPricingOutbound).getWholesalePriceList(anySet(), Mockito.anyMap());
    Mockito.verify(sapOutbound).getCogsValueResponse(any());
    Assertions.assertTrue(CollectionUtils.isNotEmpty(result.getContent()));
    Assertions.assertEquals(PRODUCT_CODE, result.getContent().get(0).getProductCode());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, result.getContent().get(0).getProductSku());
    Assertions.assertEquals(20, result.getContent().get(0).getNonDistributionAvailable().intValue());
    Assertions.assertEquals(10, result.getContent().get(0).getNonDistributionReserved().intValue());
    Assertions.assertEquals(90.0, result.getContent().get(0).getProductScore(), 0);
    Assertions.assertFalse(result.getContent().get(0).isPriceEditDisabled());
  }

  @Test
  public void findSummaryDetailsByFilterNeedCorrectionPreLiveNonEditedProductTest() throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails = new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    productLevel3SummaryFilterDetails.setNeedCorrection(true);
    Product product = generateProduct();
    ProductCategory productCategory = new ProductCategory();
    Category category = new Category();
    category.setCategoryCode(DEFAULT_CATEGORY_CODE);
    productCategory.setCategory(category);
    product.setProductCategories(Arrays.asList(productCategory));
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setSalePrice(DEFAULT_SALE_PRICE);
    productItemBusinessPartner.setPrice(DEFAULT_PRICE);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(DEFAULT_DELTA_STOCK);
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    CampaignPriceRequest campaignPriceRequest = new CampaignPriceRequest();
    CampaignPriceResponse campaignPriceResponse = new CampaignPriceResponse();
    campaignPriceRequest.setCampaignPriceSkuRequestList(
        Arrays.asList(CampaignPriceSkuRequest.builder().itemSku(ITEM_SKU).categoryCode(DEFAULT_CATEGORY_CODE).pickUpPointCode(PICKUP_POINT_CODE).build()));
    Map<String, CampaignPriceSkuResponse> itemSkuToPriceResponseMap = new HashMap<>();
    CampaignPriceSkuResponse campaignPriceSkuResponse =
        CampaignPriceSkuResponse.builder().campaignPrice(10001.0).maxAllowedPrice(10001.0).minAllowedPrice(2000.0)
            .live(true).registered(true).lockPriceUpdate(true).build();
    itemSkuToPriceResponseMap.put(ITEM_SKU, campaignPriceSkuResponse);
    campaignPriceResponse.setItemSkuToPriceResponse(itemSkuToPriceResponseMap);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    //productCollection.setPostLive(false);
    ItemSummaryDetailResponse item =
        ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE).merchantSku(DEFAULT_MERCHANT_SKU)
            .generatedItemName(DEFAULT_ITEM_NAME).masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
            .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
            .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>()).isLateFulfillment(false)
            .merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories = generateMapOfProductInventories(items, inventories);
    Mockito.when(
            modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails))
        .thenReturn(itemFilterRequest);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(
            this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
                any(), any(), any(Pageable.class)))
        .thenReturn(new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    Mockito.when(this.productRepository.findOne(any())).thenReturn(product);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
        new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "true", "campaignPriceValidation", false));
    Mockito.when(productPricingOutbound.getWholesalePriceList(eq(new HashSet<>(Arrays.asList(ITEM_SKU))), Mockito.anyMap()))
        .thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    Mockito.when(campaignOutbound.getCampaignPriceInfoV2(campaignPriceRequest)).thenReturn(campaignPriceResponse);
    Mockito.when(modelConverter.convertItemSkusToCampaignPriceRequest(eq(Arrays.asList(ITEM_SKU)), eq(DEFAULT_CATEGORY_CODE),
        eq(itemSkuAndPickupCodeMap), any()))
        .thenReturn(campaignPriceRequest);
    Mockito.when(modelConverter.convertCampaignPriceResponseListToCampaignPriceSkuResponseMap(Mockito.anyList()))
        .thenReturn(itemSkuToPriceResponseMap);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        filterRequest.getBusinessPartnerCode(), Arrays.asList(ITEM_SKU))).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
        .thenReturn(mapOfProductInventories);
    Page<ProductLevel3SummaryDetails> result =
        productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID, productLevel3SummaryFilterDetails,
            PAGEABLE);
    Mockito.verify(modelConverter)
        .convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails);
    Mockito.verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productItemBusinessPartnerRepository)
        .findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(any(), any(),
            any(Pageable.class));
    Mockito.verify(this.productRepository).findOne(any());
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(any(), any());
    Mockito.verify(productItemWholesalePriceRepository).findByStoreIdAndItemSkuIn(any(), anyList());
    Mockito.verify(campaignOutbound).getCampaignPriceInfoV2(campaignPriceRequest);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Assertions.assertFalse(CollectionUtils.isEmpty(result.getContent()));
  }

  @Test
  public void findSummaryDetailsByFilterNeedCorrectionCampaignValidationSwitchOnTest() throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails = new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    productLevel3SummaryFilterDetails.setNeedCorrection(true);
    Product product = generateProduct();
    ProductCategory productCategory = new ProductCategory();
    Category category = new Category();
    category.setCategoryCode(DEFAULT_CATEGORY_CODE);
    productCategory.setCategory(category);
    product.setProductCategories(Arrays.asList(productCategory));
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setSalePrice(DEFAULT_SALE_PRICE);
    productItemBusinessPartner.setPrice(DEFAULT_PRICE);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(DEFAULT_DELTA_STOCK);
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    CampaignPriceRequest campaignPriceRequest = new CampaignPriceRequest();
    campaignPriceRequest.setCampaignPriceSkuRequestList(Arrays.asList(
        CampaignPriceSkuRequest.builder().itemSku(ITEM_SKU).categoryCode(DEFAULT_CATEGORY_CODE)
            .pickUpPointCode(PICKUP_POINT_CODE).build()));
    CampaignPriceResponse campaignPriceResponse = new CampaignPriceResponse();
    Map<String, CampaignPriceSkuResponse> itemSkuToPriceResponseMap = new HashMap<>();
    CampaignPriceSkuResponse campaignPriceSkuResponse =
        CampaignPriceSkuResponse.builder().campaignPrice(10001.0).maxAllowedPrice(10001.0).minAllowedPrice(2000.0)
            .live(true).registered(true).lockPriceUpdate(true).build();
    itemSkuToPriceResponseMap.put(ITEM_SKU, campaignPriceSkuResponse);
    campaignPriceResponse.setItemSkuToPriceResponse(itemSkuToPriceResponseMap);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
        ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE).merchantSku(DEFAULT_MERCHANT_SKU)
            .generatedItemName(DEFAULT_ITEM_NAME).masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
            .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
            .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>()).isLateFulfillment(false)
            .merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories = generateMapOfProductInventories(items, inventories);
    productCollection.setPostLive(false);
    productCollection.setEdited(true);
    Mockito.when(
            modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails))
        .thenReturn(itemFilterRequest);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(
            this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
                any(), any(), any(Pageable.class)))
        .thenReturn(new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    Mockito.when(this.productRepository.findOne(any())).thenReturn(product);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
        new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "true", "campaignPriceValidation", false));
    Mockito.when(productPricingOutbound.getWholesalePriceList(eq(new HashSet<>(Arrays.asList(ITEM_SKU))), Mockito.anyMap()))
        .thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    Mockito.when(campaignOutbound.getCampaignPriceInfoV2(campaignPriceRequest)).thenReturn(campaignPriceResponse);
    Mockito.when(modelConverter.convertItemSkusToCampaignPriceRequest(eq(Arrays.asList(ITEM_SKU)), eq(DEFAULT_CATEGORY_CODE),
        eq(itemSkuAndPickupCodeMap), any()))
        .thenReturn(campaignPriceRequest);
    Mockito.when(modelConverter.convertCampaignPriceResponseListToCampaignPriceSkuResponseMap(Mockito.anyList()))
        .thenReturn(itemSkuToPriceResponseMap);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        filterRequest.getBusinessPartnerCode(), Arrays.asList(ITEM_SKU))).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
        .thenReturn(mapOfProductInventories);
    Page<ProductLevel3SummaryDetails> result =
        productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID, productLevel3SummaryFilterDetails,
            PAGEABLE);
    Mockito.verify(modelConverter)
        .convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails);
    Mockito.verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productItemBusinessPartnerRepository)
        .findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(any(), any(),
            any(Pageable.class));
    Mockito.verify(this.productRepository).findOne(any());
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(any(), any());
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    Mockito.verify(productItemWholesalePriceRepository).findByStoreIdAndItemSkuIn(any(), anyList());
    Mockito.verify(campaignOutbound).getCampaignPriceInfoV2(campaignPriceRequest);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Assertions.assertFalse(CollectionUtils.isEmpty(result.getContent()));
  }

  @Test
  public void findSummaryDetailsByFilterNeedCorrectionCampaignValidationSwitchOnNotRegisteredTest() throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails = new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    productLevel3SummaryFilterDetails.setNeedCorrection(true);
    Product product = generateProduct();
    ProductCategory productCategory = new ProductCategory();
    Category category = new Category();
    category.setCategoryCode(DEFAULT_CATEGORY_CODE);
    productCategory.setCategory(category);
    product.setProductCategories(Arrays.asList(productCategory));
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setSalePrice(DEFAULT_SALE_PRICE);
    productItemBusinessPartner.setPrice(DEFAULT_PRICE);
    productItemBusinessPartner.setMerchantSku(DEFAULT_MERCHANT_SKU);
    productItemBusinessPartner.setStock(DEFAULT_DELTA_STOCK);
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner.setPickupPointId(PICKUP_POINT_CODE);
    CampaignPriceRequest campaignPriceRequest = new CampaignPriceRequest();
    campaignPriceRequest.setCampaignPriceSkuRequestList(Arrays.asList(
        CampaignPriceSkuRequest.builder().itemSku(ITEM_SKU).categoryCode(DEFAULT_CATEGORY_CODE)
            .pickUpPointCode(PICKUP_POINT_CODE).build()));
    CampaignPriceResponse campaignPriceResponse = new CampaignPriceResponse();
    Map<String, CampaignPriceSkuResponse> itemSkuToPriceResponseMap = new HashMap<>();
    CampaignPriceSkuResponse campaignPriceSkuResponse =
        CampaignPriceSkuResponse.builder().campaignPrice(10001.0).maxAllowedPrice(10001.0).minAllowedPrice(2000.0)
            .live(true).registered(true).lockPriceUpdate(true).build();
    itemSkuToPriceResponseMap.put(DEFAULT_ITEM_SKU, campaignPriceSkuResponse);
    campaignPriceResponse.setItemSkuToPriceResponse(itemSkuToPriceResponseMap);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item = ItemSummaryDetailResponse.builder().itemSku(DEFAULT_ITEM_SKU).itemCode(ITEM_CODE)
        .merchantSku(DEFAULT_MERCHANT_SKU).generatedItemName(DEFAULT_ITEM_NAME).masterCatalog(new MasterCatalogDTO())
        .salesCatalogs(new ArrayList<>()).price(new HashSet<>()).itemViewConfigs(new HashSet<>())
        .productType(ProductType.REGULAR).pickupPointCode(DEFAULT_PICKUP_POINT_CODE)
        .masterDataItemImages(new ArrayList<>()).isLateFulfillment(false).merchantCode(DEFAULT_BUSINESS_PARTNER_CODE)
        .build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    Page<ItemSummaryDetailResponse> pageOfItems = new PageImpl<>(items, PAGEABLE, items.size());
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    Map<String, ProductLevel3Inventory> mapOfProductInventories = generateMapOfProductInventories(items, inventories);
    productCollection.setPostLive(true);
    Mockito.when(
            modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails))
        .thenReturn(itemFilterRequest);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(
            this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
                any(), any(), any(Pageable.class)))
        .thenReturn(new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    Mockito.when(this.productRepository.findOne(any())).thenReturn(product);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        Constants.CAMPAIGN_PRICE_VALIDATION)).thenReturn(
        new ProductSystemParameter(Constants.CAMPAIGN_PRICE_VALIDATION, "true", "campaignPriceValidation", false));
    Mockito.when(productPricingOutbound.getWholesalePriceList(eq(new HashSet<>(Arrays.asList(ITEM_SKU))), Mockito.anyMap()))
        .thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    Mockito.when(campaignOutbound.getCampaignPriceInfoV2(campaignPriceRequest)).thenReturn(campaignPriceResponse);
    Mockito.when(modelConverter
        .convertItemSkusToCampaignPriceRequest(eq(Arrays.asList(ITEM_SKU)), eq(DEFAULT_CATEGORY_CODE),
            eq(itemSkuAndPickupCodeMap), any())).thenReturn(campaignPriceRequest);
    Mockito.when(modelConverter.convertCampaignPriceResponseListToCampaignPriceSkuResponseMap(Mockito.anyList()))
        .thenReturn(itemSkuToPriceResponseMap);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
        filterRequest.getBusinessPartnerCode(), Arrays.asList(ITEM_SKU))).thenReturn(inventories);
    Mockito.when(modelConverter.convertProductLevel3InventoryToMapOfGdnSku(Mockito.eq(inventories)))
        .thenReturn(mapOfProductInventories);
    Page<ProductLevel3SummaryDetails> result =
        productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID, productLevel3SummaryFilterDetails,
            PAGEABLE);
    Mockito.verify(modelConverter)
        .convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails);
    Mockito.verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productItemBusinessPartnerRepository)
        .findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(any(), any(),
            any(Pageable.class));
    Mockito.verify(this.productRepository).findOne(any());
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(any(), any());
    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
    Mockito.verify(productItemWholesalePriceRepository).findByStoreIdAndItemSkuIn(any(), anyList());
    Mockito.verify(campaignOutbound).getCampaignPriceInfoV2(campaignPriceRequest);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Assertions.assertFalse(CollectionUtils.isEmpty(result.getContent()));
  }

  @Test
  public void findSummaryDetailsByFilterNoProductSkuFound() throws Exception {
    ItemsSummaryDetailRequest itemFilterRequest = new ItemsSummaryDetailRequest();
    itemFilterRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    ProductLevel3SummaryFilterDetails productLevel3SummaryFilterDetails = new ProductLevel3SummaryFilterDetails();
    productLevel3SummaryFilterDetails.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productLevel3SummaryFilterDetails.setProductSku(DEFAULT_PRODUCT_SKU);
    productLevel3SummaryFilterDetails.setNeedCorrection(true);
    Mockito.when(
            modelConverter.convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails))
        .thenReturn(itemFilterRequest);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(null);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        Page<ProductLevel3SummaryDetails> result =
            productLevel3ServiceBean.findSummaryDetailsByFilter(DEFAULT_STORE_ID, productLevel3SummaryFilterDetails,
                PAGEABLE);
      });
    } finally {
      Mockito.verify(modelConverter)
          .convertProductLevel3SummaryDetailsRequestToItemSummaryRequest(productLevel3SummaryFilterDetails);
      Mockito.verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    }
  }

  @Test
  public void activateProductOnNeedCorrectionTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryValidationMerchantTypes", "CM");
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    profileResponse.setMerchantStatus(ACTIVE);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(profileResponse);
    when(productCollectionRepository.findProductByGdnSku(DEFAULT_PRODUCT_SKU)).thenReturn(productCollection);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList())).thenReturn(new ArrayList<>());
    ActivateNeedRevisionResponse activateNeedRevisionResponse = new ActivateNeedRevisionResponse();
    activateNeedRevisionResponse.setCreateNew(false);
    when(xProductOutbound.activateOnNeedCorrection(any())).thenReturn(activateNeedRevisionResponse);
    productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
      profileResponse, new ArrayList<>());
    verify(productCollectionRepository).findProductByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).activateOnNeedCorrection(needCorrectionArgumentCaptor.capture());
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    verify(productItemWholesalePriceService).findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList());
    verify(productLevel3V2Service).insertInventoryForNewlyAddedL5DuringNeedRevision(any(),any(),
      any());
  }

  @Test
  public void activateProductOnNeedCorrectionInactiveMerchantStatusExceptionTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryValidationMerchantTypes", "CM");
    productItemBusinessPartner.setProductType(1);
    productItemBusinessPartner.setB2bPrice(5.0);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    profileResponse.setMerchantStatus(MerchantStatus.INACTIVE.name());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(profileResponse);
    when(productCollectionRepository.findProductByGdnSku(DEFAULT_PRODUCT_SKU)).thenReturn(productCollection);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList())).thenReturn(new ArrayList<>());
    ActivateNeedRevisionResponse activateNeedRevisionResponse = new ActivateNeedRevisionResponse();
    activateNeedRevisionResponse.setCreateNew(false);
    when(xProductOutbound.activateOnNeedCorrection(any())).thenReturn(activateNeedRevisionResponse);
    productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
        profileResponse, new ArrayList<>());
    verify(productCollectionRepository).findProductByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).activateOnNeedCorrection(needCorrectionArgumentCaptor.capture());
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
    verify(productItemWholesalePriceService).findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList());
    verify(productLevel3V2Service).insertInventoryForNewlyAddedL5DuringNeedRevision(any(),any(),
      any());
  }

  @Test
  public void activateProductOnNeedCorrectionMppTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryValidationMerchantTypes", "CM");
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryRestrictionFeatureEnabled", true);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    when(productCollectionRepository.findProductByGdnSku(DEFAULT_PRODUCT_SKU)).thenReturn(productCollection);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    ProductItemWholesalePrice productItemWholesalePrice = new ProductItemWholesalePrice();
    productItemWholesalePrice.setItemSku(ITEM_SKU);
    productItemWholesalePrice.setItemCode(ITEM_CODE);
    productItemWholesalePrice.setWholesaleRules(WHOLESALE_RULE_1);
    productItemWholesalePrice.setWholesalePriceActivated(true);
    profileResponse.setMerchantStatus(ACTIVE);
    profileResponse.getCompany().setMerchantType("CM");
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(profileResponse);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList())).thenReturn(Collections.singletonList(productItemWholesalePrice));
    ActivateNeedRevisionResponse activateNeedRevisionResponse = new ActivateNeedRevisionResponse();
    activateNeedRevisionResponse.setCreateNew(false);
    when(xProductOutbound.activateOnNeedCorrection(any())).thenReturn(activateNeedRevisionResponse);
    productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
      profileResponse, new ArrayList<>());
    verify(productCollectionRepository).findProductByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).activateOnNeedCorrection(needCorrectionArgumentCaptor.capture());
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    verify(productItemWholesalePriceService).findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList());
    verify(productLevel3V2Service).insertInventoryForNewlyAddedL5DuringNeedRevision(any(),any(),
      any());
  }

  @Test
  public void activateProductOnNeedCorrectionProfileResponseNullExceptionTest() throws Exception {
    productItemBusinessPartner.setProductType(1);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(null);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList())).thenReturn(new ArrayList<>());
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
            null, new ArrayList<>());
      });
    } finally {
      verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
      verify(productItemWholesalePriceService).findByStoreIdAndItemSkus(Mockito.any(),
          Mockito.anyList());
    }
  }

  @Test
  public void activateProductOnNeedCorrection_newProdTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "mppForWhEnabled", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryValidationMerchantTypes", "CM");
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    productItemBusinessPartner.setProductType(1);
    productItemBusinessPartner.setSalePrice((double) 10);
    productItemBusinessPartner.setPrice((double) 10);
    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(DEFAULT_PICKUP_POINT_CODE);
    productItemBusinessPartner.setFbbActive(true);
    ProfileResponse businessPartner = new ProfileResponse();
    profileResponse.setMerchantStatus(ACTIVE);
    PickupPointDTO pickupPointDTO = new PickupPointDTO();
    pickupPointDTO.setCode(DEFAULT_PICKUP_POINT_CODE);
    pickupPointDTO.setOriginId(DEFAULT_ORIGIN_ID);
    businessPartner.setPickupPoints(Arrays.asList(pickupPointDTO));
    profileResponse.getCompany().setMerchantType("CM");
    CompanyDTO dto = new CompanyDTO();
    dto.setInternationalFlag(Boolean.TRUE);
    businessPartner.setCompany(dto);
    businessPartner.getCompany().setInternationalFlag(true);
    businessPartner.getCompany().setMerchantDeliveryType(PICKUP);
    businessPartner.getCompany().setInventoryFulfillment(INVENTORY_FULFILLMENT_BLIBLI);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    pickupPointResponseList.forEach(pp -> pp.setFbbActivated(true));
    when(productRepository.findProductDetailByProductCode(DEFAULT_PRODUCT_CODE)).thenReturn(productData);
    when(xProductOutbound.activateOnNeedCorrection(any())).thenReturn(
        new ActivateNeedRevisionResponse(true, new ArrayList<>()));
    when(productCollectionRepository.findProductByGdnSku(DEFAULT_PRODUCT_SKU)).thenReturn(productCollection);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList())).thenReturn(new ArrayList<>());
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList())).thenReturn(pickupPointResponseList);
    productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
      profileResponse, new ArrayList<>());
//    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(productCollectionRepository).findProductByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).activateOnNeedCorrection(needCorrectionArgumentCaptor.capture());
    verify(productRepository).findProductDetailByProductCode(DEFAULT_PRODUCT_CODE);
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
    Mockito.verify(xProductOutbound)
        .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(ITEM_SKU), DEFAULT_BUSINESS_PARTNER_CODE,
        new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
        Mockito.any(ProductAndItemActivationRequest.class), Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService,
        Mockito.times(productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
        Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService).create(Mockito.any(ProductLevel3Aggregator.class));
    verify(productItemWholesalePriceService, times(2)).findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList());
    verify(this.productLevel3AggregatorService).findByGdnSku(Mockito.any());
  }

  @Test
  public void activateProductOnNeedCorrection_newProdTestWithSwitchOnFbbActive() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryValidationMerchantTypes", "CM");
    ReflectionTestUtils.setField(productLevel3ServiceBean, "mppForWhEnabled", true);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    productItemBusinessPartner.setProductType(1);
    productItemBusinessPartner.setSalePrice((double) 10);
    productItemBusinessPartner.setPrice((double) 10);
    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(DEFAULT_PICKUP_POINT_CODE);
    ProfileResponse businessPartner = new ProfileResponse();
    profileResponse.setMerchantStatus(ACTIVE);
    PickupPointDTO pickupPointDTO = new PickupPointDTO();
    pickupPointDTO.setCode(DEFAULT_PICKUP_POINT_CODE);
    pickupPointDTO.setOriginId(DEFAULT_ORIGIN_ID);
    businessPartner.setPickupPoints(Arrays.asList(pickupPointDTO));
    CompanyDTO dto = new CompanyDTO();
    dto.setInternationalFlag(Boolean.TRUE);
    businessPartner.setCompany(dto);
    businessPartner.getCompany().setInternationalFlag(true);
    businessPartner.getCompany().setMerchantDeliveryType(PICKUP);
    businessPartner.getCompany().setInventoryFulfillment(INVENTORY_FULFILLMENT_BLIBLI);
    productItemBusinessPartner.setFbbActive(true);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    pickupPointResponseList.forEach(pickupPointResponse1 -> pickupPointResponse1.setFbbActivated(true));
    when(productRepository.findProductDetailByProductCode(DEFAULT_PRODUCT_CODE)).thenReturn(productData);
    when(xProductOutbound.activateOnNeedCorrection(any())).thenReturn(
      new ActivateNeedRevisionResponse(true, new ArrayList<>()));
    when(productCollectionRepository.findProductByGdnSku(DEFAULT_PRODUCT_SKU)).thenReturn(productCollection);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(profileResponse);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
      Mockito.anyList())).thenReturn(new ArrayList<>());
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList())).thenReturn(pickupPointResponseList);
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(true);
    productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
      profileResponse, new ArrayList<>());
    //    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(productCollectionRepository).findProductByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).activateOnNeedCorrection(needCorrectionArgumentCaptor.capture());
    verify(productRepository).findProductDetailByProductCode(DEFAULT_PRODUCT_CODE);
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
      Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(ITEM_SKU), DEFAULT_BUSINESS_PARTNER_CODE,
      new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
      Mockito.any(ProductAndItemActivationRequest.class), Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService,
      Mockito.times(productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService).create(Mockito.any(ProductLevel3Aggregator.class));
    verify(productItemWholesalePriceService, times(2)).findByStoreIdAndItemSkus(Mockito.any(),
      Mockito.anyList());
    verify(this.productLevel3AggregatorService).findByGdnSku(Mockito.any());
  }

  @Test
  public void activateProductOnNeedCorrection_notNullTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryValidationMerchantTypes", "CM");
    productItemBusinessPartner.setPrice(1.0);
    productItemBusinessPartner.setSalePrice(1.0);
    productItemBusinessPartner.setProductType(1);
    ActivateNeedRevisionResponse activateNeedRevisionResponse = new ActivateNeedRevisionResponse();
    activateNeedRevisionResponse.setCreateNew(false);
    profileResponse.setMerchantStatus(ACTIVE);
    when(xProductOutbound.activateOnNeedCorrection(any())).thenReturn(activateNeedRevisionResponse);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    when(productCollectionRepository.findProductByGdnSku(DEFAULT_PRODUCT_SKU)).thenReturn(productCollection);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList())).thenReturn(new ArrayList<>());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any())).thenReturn(profileResponse);
    productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
      profileResponse, new ArrayList<>());
    verify(productCollectionRepository).findProductByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).activateOnNeedCorrection(needCorrectionArgumentCaptor.capture());
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    verify(productItemWholesalePriceService).findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList());
    verify(productLevel3V2Service).insertInventoryForNewlyAddedL5DuringNeedRevision(any(),any(),
      any());
  }

  @Test
  public void updateLogisticsForNeedRevisionTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(3)).findByStoreIdAndProductCode(any(), any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNull(apiErrorCode);
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
  }

  @Test
  public void updateLogisticsForNeedRevisionTestNonOmgSeller() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productLevel3UpdateRequest.setSellerOmg(false);
    productLevel3UpdateRequest.setPreOrder(PreOrderRequest.builder().isPreOrder(true).preOrderType("DATE").preOrderDate(new Date()).build());
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(3)).findByStoreIdAndProductCode(any(), any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertNull(apiErrorCode);
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
  }

  @Test
  public void updateLogisticsForNeedRevisionTestOmgSeller() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productLevel3UpdateRequest.setSellerOmg(true);
    productLevel3UpdateRequest.setPreOrder(PreOrderRequest.builder().isPreOrder(true).preOrderType("DATE").preOrderDate(new Date()).build());
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(3)).findByStoreIdAndProductCode(any(), any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertNull(apiErrorCode);
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
  }

  @Test
  public void updateLogisticsForNeedRevisionTestOmgSellerPoQuotaEnabled() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productLevel3UpdateRequest.setSellerOmg(true);
    productLevel3UpdateRequest.setPreOrder(PreOrderRequest.builder().isPreOrder(true).preOrderType("DATE").preOrderDate(new Date()).build());
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(3)).findByStoreIdAndProductCode(any(), any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(inventoryOutbound).updatePoDateByL3(Mockito.any(), Mockito.any());
    Assertions.assertNull(apiErrorCode);
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
  }

  @Test
  public void updateLogisticsForNeedRevisionTestNonOmgSellerPoQuotaEnabled() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productLevel3UpdateRequest.setSellerOmg(false);
    productLevel3UpdateRequest.setPreOrder(PreOrderRequest.builder().isPreOrder(true).preOrderType("DATE").preOrderDate(new Date()).build());
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(3)).findByStoreIdAndProductCode(any(), any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertNull(apiErrorCode);
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
  }

  @Test
  public void updateLogisticsForNeedRevisionNoDimensionsUpdateTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productDetailResponse.setLength(1d);
    productDetailResponse.setWidth(1d);
    productDetailResponse.setHeight(1d);
    productDetailResponse.setWeight(1d);
    productDetailResponse.setShippingWeight(1d);
    productLevel3UpdateRequest.setLength(1d);
    productLevel3UpdateRequest.setWidth(1d);
    productLevel3UpdateRequest.setHeight(1d);
    productLevel3UpdateRequest.setWeight(1d);
    productLevel3UpdateRequest.setShippingWeight(1d);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(2)).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionDimensionsUpdate1Test() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productDetailResponse.setLength(1d);
    productDetailResponse.setWidth(1d);
    productDetailResponse.setHeight(1d);
    productDetailResponse.setWeight(1d);
    productDetailResponse.setShippingWeight(1d);
    productLevel3UpdateRequest.setLength(11d);
    productLevel3UpdateRequest.setWidth(1d);
    productLevel3UpdateRequest.setHeight(1d);
    productLevel3UpdateRequest.setWeight(1d);
    productLevel3UpdateRequest.setShippingWeight(1d);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(3)).findByStoreIdAndProductCode(any(), any());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionDimensionsUpdate2Test() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productDetailResponse.setLength(1d);
    productDetailResponse.setWidth(1d);
    productDetailResponse.setHeight(1d);
    productDetailResponse.setWeight(1d);
    productDetailResponse.setShippingWeight(1d);
    productLevel3UpdateRequest.setLength(1d);
    productLevel3UpdateRequest.setWidth(11d);
    productLevel3UpdateRequest.setHeight(1d);
    productLevel3UpdateRequest.setWeight(1d);
    productLevel3UpdateRequest.setShippingWeight(1d);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(3)).findByStoreIdAndProductCode(any(), any());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productBusinessPartnerService).saveProductBusinessPartner(Mockito.any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionDimensionsUpdate3Test() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productDetailResponse.setLength(1d);
    productDetailResponse.setWidth(1d);
    productDetailResponse.setHeight(1d);
    productDetailResponse.setWeight(1d);
    productDetailResponse.setShippingWeight(1d);
    productLevel3UpdateRequest.setLength(1d);
    productLevel3UpdateRequest.setWidth(1d);
    productLevel3UpdateRequest.setHeight(11d);
    productLevel3UpdateRequest.setWeight(1d);
    productLevel3UpdateRequest.setShippingWeight(1d);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(3)).findByStoreIdAndProductCode(any(), any());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionDimensionsUpdate4Test() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productDetailResponse.setLength(1d);
    productDetailResponse.setWidth(1d);
    productDetailResponse.setHeight(1d);
    productDetailResponse.setWeight(1d);
    productDetailResponse.setShippingWeight(1d);
    productLevel3UpdateRequest.setLength(1d);
    productLevel3UpdateRequest.setWidth(1d);
    productLevel3UpdateRequest.setHeight(1d);
    productLevel3UpdateRequest.setWeight(11d);
    productLevel3UpdateRequest.setShippingWeight(1d);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(3)).findByStoreIdAndProductCode(any(), any());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionDimensionsUpdate5Test() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productDetailResponse.setLength(1d);
    productDetailResponse.setWidth(1d);
    productDetailResponse.setHeight(1d);
    productDetailResponse.setWeight(1d);
    productDetailResponse.setShippingWeight(1d);
    productLevel3UpdateRequest.setLength(1d);
    productLevel3UpdateRequest.setWidth(1d);
    productLevel3UpdateRequest.setHeight(1d);
    productLevel3UpdateRequest.setWeight(1d);
    productLevel3UpdateRequest.setShippingWeight(11d);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(any(), any()))
        .thenReturn(productCollection);
    Mockito.when(objectMapper.writeValueAsString(any(VendorNotesRequest.class))).thenReturn(NOTES);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(2)).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(productCollectionRepository).save(any(ProductCollection.class));
    Mockito.verify(objectMapper).writeValueAsString(any(VendorNotesRequest.class));
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionPCBUpdateExceptionTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse = new SimpleMasterProductUpdateResponse();
    simpleMasterProductUpdateResponse.setUpdateSuccess(false);
    Mockito.when(productRepository.updateSimpleMasterProduct(Mockito.any()))
        .thenReturn(simpleMasterProductUpdateResponse);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTOArgumentCaptor.capture());
    Assertions.assertNotNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionShippingTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productLevel3UpdateRequest.setShippingWeight(0d);
    productLevel3UpdateRequest.setProductType(2);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse = new SimpleMasterProductUpdateResponse();
    simpleMasterProductUpdateResponse.setUpdateSuccess(false);
    Mockito.when(productRepository.updateSimpleMasterProduct(Mockito.any()))
        .thenReturn(simpleMasterProductUpdateResponse);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Assertions.assertNotNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionPreOrderUpdateTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.setPreOrderDTO(preOrderDTO);
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    productBusinessPartner.setPreOrderValue(10);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productDetailResponse.setLength(1d);
    productDetailResponse.setWidth(1d);
    productDetailResponse.setHeight(1d);
    productDetailResponse.setWeight(1d);
    productDetailResponse.setShippingWeight(1d);
    productLevel3UpdateRequest.setLength(1d);
    productLevel3UpdateRequest.setWidth(1d);
    productLevel3UpdateRequest.setHeight(1d);
    productLevel3UpdateRequest.setWeight(1d);
    productLevel3UpdateRequest.setShippingWeight(1d);
    productLevel3UpdateRequest.setPreOrder(new PreOrderRequest(true, null, null, null));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(2)).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productBusinessPartnerService).saveProductBusinessPartner(Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionPreOrderOldValueNullUpdateTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productDetailResponse.setLength(1d);
    productDetailResponse.setWidth(1d);
    productDetailResponse.setHeight(1d);
    productDetailResponse.setWeight(1d);
    productDetailResponse.setShippingWeight(1d);
    productLevel3UpdateRequest.setLength(1d);
    productLevel3UpdateRequest.setWidth(1d);
    productLevel3UpdateRequest.setHeight(1d);
    productLevel3UpdateRequest.setWeight(1d);
    productLevel3UpdateRequest.setShippingWeight(1d);
    productLevel3UpdateRequest.setPreOrder(new PreOrderRequest(true, null, null, null));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(2)).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Mockito.verify(productBusinessPartnerService).saveProductBusinessPartner(Mockito.any());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void updateLogisticsForNeedRevisionPreOrderIsValueNullUpdateTest() throws Exception {
    ProductL3Response savedProductData = generateProductL3Response();
    productBusinessPartner.setGdnProductSku(DEFAULT_PRODUCT_SKU);
    productItemBusinessPartner.setProductType(1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setBusinessPartnerId(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    productDetailResponse.setDescription(DEFAULT_DESCRIPTION.getBytes());
    productDetailResponse.setProductType(0);
    productDetailResponse.setLength(1d);
    productDetailResponse.setWidth(1d);
    productDetailResponse.setHeight(1d);
    productDetailResponse.setWeight(1d);
    productDetailResponse.setShippingWeight(1d);
    productLevel3UpdateRequest.setLength(1d);
    productLevel3UpdateRequest.setWidth(1d);
    productLevel3UpdateRequest.setHeight(1d);
    productLevel3UpdateRequest.setWeight(1d);
    productLevel3UpdateRequest.setShippingWeight(1d);
    productLevel3UpdateRequest.setPreOrder(new PreOrderRequest(false, null, null, null));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(productCollectionRepository.getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(productLevel3LogisticsService.findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP))
        .thenReturn(Collections.singletonList(new ProductLevel3Logistics()));
    Mockito.when(productOutbound.getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(productBusinessPartner);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    ApiErrorCode apiErrorCode = productLevel3ServiceBean.updateLogisticsForNeedRevision(productLevel3UpdateRequest);
    verify(productCollectionRepository, times(2)).getProductCodeByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService).findLogisticsByItemSku(ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(productOutbound, times(2)).getProductDetailByProductCode(DEFAULT_PRODUCT_CODE, true, false);
    verify(productBusinessPartnerRepository, times(3)).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(productCollectionRepository, times(2)).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void updateProductItemViewConfigTest() throws Exception {
    ProductLevel3ViewConfigStockRequest productLevel3ViewConfigStockRequest = new ProductLevel3ViewConfigStockRequest();
    productLevel3ViewConfigStockRequest.setDisplay(false);
    productLevel3ViewConfigStockRequest.setBuyable(false);
    productLevel3ViewConfigStockRequest.setChannelId(CHANNELID);
    productLevel3ViewConfigStockRequest.setCncActive(true);
    productBusinessPartner.setBusinessPartnerId(BUSINESS_PARTNER_ID);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    Mockito.when(
            this.productBusinessPartnerRepository.findByStoreIdAndGdnProductSkuIn(Mockito.any(), Mockito.anyList()))
        .thenReturn(Arrays.asList(productBusinessPartner));

    productLevel3ServiceBean.updateProductItemViewConfig(productLevel3ViewConfigStockRequest, PRODUCT_SKU);

    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndGdnProductSkuIn(Mockito.any(), Mockito.anyList());
    Mockito.verify(productBusinessPartnerRepository).saveAll(Mockito.anyList());
  }
  @Test
  public void updateProductItemViewConfigTestForB2bTrue() throws Exception {
    ProductLevel3ViewConfigStockRequest productLevel3ViewConfigStockRequest = new ProductLevel3ViewConfigStockRequest();
    productLevel3ViewConfigStockRequest.setDisplay(false);
    productLevel3ViewConfigStockRequest.setBuyable(false);
    productLevel3ViewConfigStockRequest.setChannelId(CHANNELID);
    productLevel3ViewConfigStockRequest.setCncActive(true);
    productLevel3ViewConfigStockRequest.setB2bDisplay(true);
    productLevel3ViewConfigStockRequest.setB2bBuyable(true);
    productBusinessPartner.setBusinessPartnerId(BUSINESS_PARTNER_ID);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    Mockito.when(
            this.productBusinessPartnerRepository.findByStoreIdAndGdnProductSkuIn(Mockito.any(), Mockito.anyList()))
        .thenReturn(Arrays.asList(productBusinessPartner));

    productLevel3ServiceBean.updateProductItemViewConfig(productLevel3ViewConfigStockRequest, PRODUCT_SKU);

    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndGdnProductSkuIn(Mockito.any(), Mockito.anyList());
    Mockito.verify(productBusinessPartnerRepository).saveAll(Mockito.anyList());
  }

  @Test
  public void updateProductItemViewConfigWithStockTest() throws Exception {
    ProductLevel3ViewConfigStockRequest productLevel3ViewConfigStockRequest = new ProductLevel3ViewConfigStockRequest();
    productLevel3ViewConfigStockRequest.setDisplay(false);
    productLevel3ViewConfigStockRequest.setBuyable(false);
    productLevel3ViewConfigStockRequest.setAvailableStock(10);
    productLevel3ViewConfigStockRequest.setChannelId(CHANNELID);
    productBusinessPartner.setBusinessPartnerId(BUSINESS_PARTNER_ID);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    Mockito.when(
            this.productBusinessPartnerRepository.findByStoreIdAndGdnProductSkuIn(Mockito.any(), Mockito.anyList()))
        .thenReturn(Arrays.asList(productBusinessPartner));

    productLevel3ServiceBean.updateProductItemViewConfig(productLevel3ViewConfigStockRequest, ITEM_SKU);

    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndGdnProductSkuIn(Mockito.any(), Mockito.anyList());
    Mockito.verify(productBusinessPartnerRepository).saveAll(Mockito.anyList());
  }

  @Test
  public void updateProductItemViewConfigExceptionTest() throws Exception {
    ProductLevel3ViewConfigStockRequest productLevel3ViewConfigStockRequest = new ProductLevel3ViewConfigStockRequest();
    productLevel3ViewConfigStockRequest.setDisplay(false);
    productLevel3ViewConfigStockRequest.setBuyable(false);
    productLevel3ViewConfigStockRequest.setChannelId(CHANNELID);
    productBusinessPartner.setBusinessPartnerId(BUSINESS_PARTNER_ID);
    productBusinessPartner.setProductItemBusinessPartners(new ArrayList());
    Mockito.when(
            this.productBusinessPartnerRepository.findByStoreIdAndGdnProductSkuIn(Mockito.any(), Mockito.anyList()))
        .thenReturn(Arrays.asList(productBusinessPartner));

    try {
      Assertions.assertThrows(ApplicationException.class, () -> {
        productLevel3ServiceBean.updateProductItemViewConfig(productLevel3ViewConfigStockRequest, ITEM_SKU);
      });
    } finally {
      Mockito.verify(this.productBusinessPartnerRepository)
          .findByStoreIdAndGdnProductSkuIn(Mockito.any(), Mockito.anyList());
    }
  }

  @Test
  public void retrySkipReviewProductActivationTest() throws Exception {
    Mockito.doNothing().when(this.productServiceWrapper).retrySkipReviewProductActivation(PRODUCT_CODE);
    productLevel3ServiceBean.retrySkipReviewProductActivation(DEFAULT_STORE_ID, Arrays.asList(PRODUCT_CODE));
    Mockito.verify(this.productServiceWrapper).retrySkipReviewProductActivation(PRODUCT_CODE);
  }

  @Test
  public void updateProductLevel3InfoTest() throws Exception {
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setProductType(ProductType.REGULAR);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        PICKUP);
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
  }

  @Test
  public void updateProductLevel3InfoOfficialSellerTest() throws Exception {
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.setOfficial(true);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setProductType(ProductType.REGULAR);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
        PICKUP);
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
  }

  @Test
  public void updateProductLevel3InfoSuccessSaveTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(false);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU))).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    updateProductLevel3InfoRequest.setProductType(3);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.getMasterDataProduct().setBrand(BRAND);
    savedProductData1.setProductEditable(false);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_GDN_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);

    productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);

    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository(), THREE_TIMES).findDetailByGdnSku(Mockito.any());
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(3)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, times(4)).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService, times(2)).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE,
        DEFAULT, null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound, times(2)).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound, times(2)).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound,Mockito.times(2)).generateProductScoreByProductSkuOrProductCode(DEFAULT_GDN_SKU, null, false);
    verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(), Mockito.any(), Mockito.any(),Mockito.anyBoolean(),
        any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
  }

  @Test
  public void updateProductLevel3InfoSuccessSaveAndIgnoreCaseForL1DataTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().getMasterDataProduct().setProductName(PRODUCT_NAME);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.getMasterDataProduct().setProductName(PRODUCT_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(false);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.eq(DEFAULT_GDN_SKU))).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(), Mockito.any(),
        Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any()))
        .thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    productAndItemsResponse.getProduct().getMasterDataProduct().setProductName(PRODUCT_NAME1);
    updateProductLevel3InfoRequest.setProductType(3);
    Mockito.when(this.productLevel3Repository.findDetailByGdnSku(Mockito.any())).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(PRODUCT_NAME1);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.getMasterDataProduct().setBrand(BRAND);
    savedProductData1.setProductEditable(false);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_GDN_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    updateProductLevel3InfoRequest.setProductName(PRODUCT_NAME1);
    productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);

    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
    verify(productLevel3LogisticsService, times(2)).findLogisticsByItemSku(Mockito.any(), Mockito.any(), Mockito.any());
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, times(2)).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_GDN_SKU, null, false);
  }

  @Test
  public void updateProductLevel3InfoProductNameEmptyTest() throws Exception {
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    updateProductLevel3InfoRequest.setProductName(StringUtils.EMPTY);
    EditProductResponse editProductResponse =
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.PRODUCT_NAME_IS_EMPTY.name(), editProductResponse.getApiErrorCode().name());
  }

  @Test
  public void updateProductLevel3InfoProductAttributeCheckInValidTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "sanitizeProductNameAndSellerSku", true);
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE, "attribute1");
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_2, "attribute2");
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    EditProductResponse editProductResponse =
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.PRODUCT_ATTRIBUTE_INVALID.name(), editProductResponse.getApiErrorCode().name());
    Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
  }

  @Test
  public void updateProductLevel3InfoProductAttributeCheckVariantCreatingTest() throws Exception {
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE, "attribute1");
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_4, "attribute2");
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_2).attributeType(DEFAULT_ATTRIBUTE_TYPE_2)
            .variantCreation(true).build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    EditProductResponse editProductResponse =
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.PRODUCT_ATTRIBUTE_INVALID.name(), editProductResponse.getApiErrorCode().name());
    Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
  }

  @Test
  public void updateProductLevel3InfoProductAttributeCheckFamilyColourTest() throws Exception {
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE, "attribute1");
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_2, "attribute2");
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_2).attributeType(DEFAULT_ATTRIBUTE_TYPE_3)
            .variantCreation(false).name(Constants.FAMILY_COLOUR).build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    EditProductResponse editProductResponse =
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.PRODUCT_ATTRIBUTE_INVALID.name(), editProductResponse.getApiErrorCode().name());
    Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
  }

  @Test
  public void updateProductLevel3InfoProductAttributeCheckTest() throws Exception {
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE, "attribute1");
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_4, "attribute2");
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    EditProductResponse editProductResponse =
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.PRODUCT_ATTRIBUTE_INVALID.name(), editProductResponse.getApiErrorCode().name());
    Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
  }

  @Test
  public void updateProductLevel3InfoProductAttributeCheckPredefinedValueTest() throws Exception {
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_2, "attribute1");
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_4, "attribute2");
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_2).attributeType(DEFAULT_ATTRIBUTE_TYPE_3)
            .build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    predefinedAllowedAttributeValueResponse.setValue(DEFAULT_ATTRIBUTE_VALUE);
    when(this.predefinedAttributeAllowedValueService.findByStoreIdAndMatchAttributeCodeAndValue(Mockito.any(),
        eq(DEFAULT_ATTRIBUTE_CODE_2), eq(DEFAULT_ATTRIBUTE_VALUE))).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    EditProductResponse editProductResponse =
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.PRODUCT_ATTRIBUTE_INVALID.name(), editProductResponse.getApiErrorCode().name());
    Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
  }

  @Test
  public void updateProductLevel3InfoProductAttributeCheckPredefinedValueExceptionTest() throws Exception {
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_2, "attribute1");
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_4, "attribute2");
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_2).attributeType(DEFAULT_ATTRIBUTE_TYPE_3)
            .build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    predefinedAllowedAttributeValueResponse.setValue(DEFAULT_ATTRIBUTE_VALUE);
    doThrow(Exception.class).when(this.predefinedAttributeAllowedValueService)
        .findByStoreIdAndMatchAttributeCodeAndValue(Mockito.any(), Mockito.any(), Mockito.any());
    EditProductResponse editProductResponse =
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.PRODUCT_ATTRIBUTE_INVALID.name(), editProductResponse.getApiErrorCode().name());
    Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
  }

  @Test
  public void updateProductLevel3InfoNoContentChangeTest() throws Exception {
    updateProductLevel3InfoRequest.setProductType(PRODUCT_TYPE_BOPIS);
    updateProductLevel3InfoRequest.setDimension(
        DimensionRequest.builder().length(10.0).height(10.0).width(10.0).weight(10.0).build());
    updateProductLevel3InfoRequest.setLogistics(
        Arrays.asList(ProductItemLogisticsRequest.builder().logisticProductCode("GOJEK").isSelected(true).build()));
    updateProductLevel3InfoRequest.setPreOrder(preOrderRequest);
    updateProductLevel3InfoRequest.setDescription(PRODUCT_DESCRIPTION1_BASE64);
    updateProductLevel3InfoRequest.setUniqueSellingPoint(PRODUCT_USP1_BASE64);
    updateProductLevel3InfoRequest.setVideoUrl(YOUTUBE_URL);
    ProductLevel3Logistics productLevel3Logistics1 = new ProductLevel3Logistics();
    productLevel3Logistics1.setLogisticProductCode("GOJEK1");
    productLevel3Logistics1.setSelected(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    List<ProductLevel3Logistics> productLevel3LogisticsList = new ArrayList<>();
    productLevel3LogisticsList.add(productLevel3Logistics);
    productLevel3LogisticsList.add(productLevel3Logistics1);

    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(productLevel3LogisticsList);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setProductName(PRODUCT_NAME);
    savedProductData.getProduct().getMasterDataProduct().setUrl(YOUTUBE_URL);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.getMasterDataProduct().setUrl(YOUTUBE_URL);
    savedProductData1.setProductType(ProductType.BOPIS);
    savedProductData1.getDescriptiveAttributes().get(0).setAttributeValue("");
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(any()))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, TWO_TIMES).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_GDN_SKU, null, false);
  }

  @Test
  public void updateProductLevel3InfoContentChangeTest() throws Exception {
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_4, "attribute2");
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    updateProductLevel3InfoRequest.setProductType(PRODUCT_TYPE_BOPIS);
    updateProductLevel3InfoRequest.setDimension(
        DimensionRequest.builder().length(10.0).height(10.0).width(10.0).weight(10.0).build());
    updateProductLevel3InfoRequest.setLogistics(
        Arrays.asList(ProductItemLogisticsRequest.builder().logisticProductCode("GOJEK").isSelected(true).build()));
    updateProductLevel3InfoRequest.setPreOrder(preOrderRequest);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    updateProductLevel3InfoRequest.setProductType(3);
    updateProductLevel3InfoRequest.setDescription("UFJPRFVDVF9ERVNDUklQVElPTjI=");
    updateProductLevel3InfoRequest.setUniqueSellingPoint(PRODUCT_USP2_BASE64);
    updateProductLevel3InfoRequest.setVideoUrl(YOUTUBE_URL + "1");
    ProductLevel3Logistics productLevel3Logistics1 = new ProductLevel3Logistics();
    productLevel3Logistics1.setLogisticProductCode("GOJEK1");
    productLevel3Logistics1.setSelected(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    List<ProductLevel3Logistics> productLevel3LogisticsList = new ArrayList<>();
    productLevel3LogisticsList.add(productLevel3Logistics);
    productLevel3LogisticsList.add(productLevel3Logistics1);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_4).attributeType(DEFAULT_ATTRIBUTE_TYPE_2)
            .build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(productLevel3LogisticsList);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(PRODUCT_USP1);
    savedProductData.getProduct().getMasterDataProduct().setUrl("URL");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(any()))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenThrow(RuntimeException.class);
    productLevel3UpdateRequest.setSynchronize(false);
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    try {
      Assertions.assertThrows(Exception.class, () -> {
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
      });
    } finally {
      verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
      verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
      verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
          DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
      verify(xProductOutbound, TWO_TIMES).getProductDetailsByProductSku(Mockito.any());
      verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
          Mockito.any(ProductLevel3DetailResponse.class), eq(false));
      verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT,
          null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
      verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
      verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
      verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
          Mockito.any(ItemRequest.class));
      verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.anyBoolean(), eq(StringUtils.EMPTY));
      Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
      verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_GDN_SKU, null, false);
      verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class), Mockito.any(), Mockito.any(),Mockito.anyBoolean(),
          any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
    }
  }


  @Test
  public void updateProductLevel3InfoContentChangeTest1() throws Exception {
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_4, null);
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    updateProductLevel3InfoRequest.setProductType(PRODUCT_TYPE_BOPIS);
    updateProductLevel3InfoRequest.setDimension(
        DimensionRequest.builder().length(10.0).height(10.0).width(10.0).weight(10.0).build());
    updateProductLevel3InfoRequest.setLogistics(
        Arrays.asList(ProductItemLogisticsRequest.builder().logisticProductCode("GOJEK").isSelected(true).build()));
    updateProductLevel3InfoRequest.setPreOrder(preOrderRequest);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    updateProductLevel3InfoRequest.setProductType(3);
    updateProductLevel3InfoRequest.setDescription("UFJPRFVDVF9ERVNDUklQVElPTjI=");
    updateProductLevel3InfoRequest.setUniqueSellingPoint(PRODUCT_USP2_BASE64);
    updateProductLevel3InfoRequest.setVideoUrl(YOUTUBE_URL + "1");
    ProductLevel3Logistics productLevel3Logistics1 = new ProductLevel3Logistics();
    productLevel3Logistics1.setLogisticProductCode("GOJEK1");
    productLevel3Logistics1.setSelected(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    List<ProductLevel3Logistics> productLevel3LogisticsList = new ArrayList<>();
    productLevel3LogisticsList.add(productLevel3Logistics);
    productLevel3LogisticsList.add(productLevel3Logistics1);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_4).attributeType(DEFAULT_ATTRIBUTE_TYPE_2)
            .build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(productLevel3LogisticsList);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(PRODUCT_USP1);
    savedProductData.getProduct().getMasterDataProduct().setUrl("URL");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(any()))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenThrow(RuntimeException.class);
    productLevel3UpdateRequest.setSynchronize(false);
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    try {
      Assertions.assertThrows(Exception.class, () -> {
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
      });
    } finally {
      verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
      verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
      verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
          DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
      verify(xProductOutbound, TWO_TIMES).getProductDetailsByProductSku(Mockito.any());
      verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
          Mockito.any(ProductLevel3DetailResponse.class), eq(false));
      verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT,
          null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
      verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
      verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
      verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
          Mockito.any(ItemRequest.class));
      verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.anyBoolean(), eq(StringUtils.EMPTY));
      Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
      verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_GDN_SKU, null, false);
      verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class), Mockito.any(), Mockito.any(),Mockito.anyBoolean(),
          any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
    }
  }


  @Test
  public void updateProductLevel3BrandEditFromExternalTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean,"brandCategoryEditEnabledForExternal",true);
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_4, null);
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    updateProductLevel3InfoRequest.setProductType(PRODUCT_TYPE_BOPIS);
    updateProductLevel3InfoRequest.setDimension(
        DimensionRequest.builder().length(10.0).height(10.0).width(10.0).weight(10.0).build());
    updateProductLevel3InfoRequest.setLogistics(
        Arrays.asList(ProductItemLogisticsRequest.builder().logisticProductCode("GOJEK").isSelected(true).build()));
    updateProductLevel3InfoRequest.setPreOrder(preOrderRequest);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    updateProductLevel3InfoRequest.setProductType(3);
    updateProductLevel3InfoRequest.setDescription("UFJPRFVDVF9ERVNDUklQVElPTjI=");
    updateProductLevel3InfoRequest.setUniqueSellingPoint(PRODUCT_USP2_BASE64);
    updateProductLevel3InfoRequest.setVideoUrl(YOUTUBE_URL + "1");
    ProductLevel3Logistics productLevel3Logistics1 = new ProductLevel3Logistics();
    productLevel3Logistics1.setLogisticProductCode("GOJEK1");
    productLevel3Logistics1.setSelected(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    List<ProductLevel3Logistics> productLevel3LogisticsList = new ArrayList<>();
    productLevel3LogisticsList.add(productLevel3Logistics);
    productLevel3LogisticsList.add(productLevel3Logistics1);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_4).attributeType(DEFAULT_ATTRIBUTE_TYPE_2)
            .build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(productLevel3LogisticsList);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(PRODUCT_USP1);
    savedProductData.getProduct().getMasterDataProduct().setUrl("URL");
    savedProductData.getProduct().getMasterDataProduct().setBrand("old-brand");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(any()))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenThrow(RuntimeException.class);
    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3UpdateRequest.setBrand("new-brand");
    updateProductLevel3InfoRequest.setBrandName("new-brand");
    updateProductLevel3InfoRequest.setCategoryCode("new-category-code");
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    try {
      Assertions.assertThrows(Exception.class, () -> {
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
      });
    } finally {
      verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
      verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
      verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
          DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
      verify(xProductOutbound, TWO_TIMES).getProductDetailsByProductSku(Mockito.any());
      verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
          Mockito.any(ProductLevel3DetailResponse.class), eq(false));
      verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT,
          null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
      verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
      verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
      verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
          Mockito.any(ItemRequest.class));
      verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.anyBoolean(), eq(StringUtils.EMPTY));
      Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
      verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_GDN_SKU, null, false);
      verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class), Mockito.any(), Mockito.any(),Mockito.anyBoolean(),
          any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
    }
  }

  @Test
  public void updateProductLevel3BrandEditFromExternalSwitchButBrandNotUpdatedTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean,"brandCategoryEditEnabledForExternal",true);
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_4, null);
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    updateProductLevel3InfoRequest.setProductType(PRODUCT_TYPE_BOPIS);
    updateProductLevel3InfoRequest.setDimension(
        DimensionRequest.builder().length(10.0).height(10.0).width(10.0).weight(10.0).build());
    updateProductLevel3InfoRequest.setLogistics(
        Arrays.asList(ProductItemLogisticsRequest.builder().logisticProductCode("GOJEK").isSelected(true).build()));
    updateProductLevel3InfoRequest.setPreOrder(preOrderRequest);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    updateProductLevel3InfoRequest.setProductType(3);
    updateProductLevel3InfoRequest.setDescription("UFJPRFVDVF9ERVNDUklQVElPTjI=");
    updateProductLevel3InfoRequest.setUniqueSellingPoint(PRODUCT_USP2_BASE64);
    updateProductLevel3InfoRequest.setVideoUrl(YOUTUBE_URL + "1");
    ProductLevel3Logistics productLevel3Logistics1 = new ProductLevel3Logistics();
    productLevel3Logistics1.setLogisticProductCode("GOJEK1");
    productLevel3Logistics1.setSelected(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    List<ProductLevel3Logistics> productLevel3LogisticsList = new ArrayList<>();
    productLevel3LogisticsList.add(productLevel3Logistics);
    productLevel3LogisticsList.add(productLevel3Logistics1);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_4).attributeType(DEFAULT_ATTRIBUTE_TYPE_2)
            .build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(productLevel3LogisticsList);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(PRODUCT_USP1);
    savedProductData.getProduct().getMasterDataProduct().setUrl("URL");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(any()))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenThrow(RuntimeException.class);
    productLevel3UpdateRequest.setSynchronize(false);
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    try {
      Assertions.assertThrows(Exception.class, () -> {
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
      });
    } finally {
      verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
      verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
      verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
          DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
      verify(xProductOutbound, TWO_TIMES).getProductDetailsByProductSku(Mockito.any());
      verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
          Mockito.any(ProductLevel3DetailResponse.class), eq(false));
      verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT,
          null, null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
      verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
      verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
      verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
          Mockito.any(ItemRequest.class));
      verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.anyBoolean(), eq(StringUtils.EMPTY));
      Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
      verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_GDN_SKU, null, false);
      verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class), Mockito.any(), Mockito.any(),Mockito.anyBoolean(),
          any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
    }
  }
  @Test
  public void updateProductLevel3InfoContentChangeAndMerchantDeliveryTypeEmptyTest() throws Exception {
    Map<String, String> attributeMap = new HashMap<>();
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_2, "attribute1");
    attributeMap.put(DEFAULT_ATTRIBUTE_CODE_4, "attribute2");
    updateProductLevel3InfoRequest.setAttributes(attributeMap);
    updateProductLevel3InfoRequest.setProductType(PRODUCT_TYPE_BOPIS);
    updateProductLevel3InfoRequest.setDimension(
        DimensionRequest.builder().length(10.0).height(10.0).width(10.0).weight(10.0).build());
    updateProductLevel3InfoRequest.setLogistics(
        Arrays.asList(ProductItemLogisticsRequest.builder().logisticProductCode("GOJEK").isSelected(true).build()));
    updateProductLevel3InfoRequest.setPreOrder(preOrderRequest);
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    updateProductLevel3InfoRequest.setProductType(3);
    updateProductLevel3InfoRequest.setDescription(PRODUCT_DESCRIPTION2_BASE64);
    updateProductLevel3InfoRequest.setUniqueSellingPoint(PRODUCT_USP2_BASE64);
    updateProductLevel3InfoRequest.setVideoUrl(YOUTUBE_URL + "1");
    ProductLevel3Logistics productLevel3Logistics1 = new ProductLevel3Logistics();
    productLevel3Logistics1.setLogisticProductCode("GOJEK1");
    productLevel3Logistics1.setSelected(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    List<ProductLevel3Logistics> productLevel3LogisticsList = new ArrayList<>();
    productLevel3LogisticsList.add(productLevel3Logistics);
    productLevel3LogisticsList.add(productLevel3Logistics1);
    categoryDetailResponse.getCategoryAttributes().get(0).getAttribute().setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    categoryDetailResponse.getCategoryAttributes().get(0).getAttribute().setAttributeType(DEFAULT_ATTRIBUTE_TYPE_2);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_4).attributeType(DEFAULT_ATTRIBUTE_TYPE_2)
            .build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(productLevel3LogisticsList);
    ProfileResponse businessPartner = getProfileResponse();
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(PRODUCT_USP1);
    savedProductData.getProduct().getMasterDataProduct().setUrl("URL");
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(any()))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    businessPartner.getCompany().setMerchantDeliveryType(StringUtils.EMPTY);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    productLevel3UpdateRequest.setSynchronize(false);
    when(this.predefinedAttributeAllowedValueService.findByStoreIdAndMatchAttributeCodeAndValue(Mockito.any(),
        eq(DEFAULT_ATTRIBUTE_CODE_2), eq("attribute1"))).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(productOutbound.getCategoryDetailByCategoryCode(any())).thenReturn(categoryDetailResponse);
    try {
      productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    } finally {
      verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
      verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
      verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
      Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(DEFAULT_CATEGORY_CODE);
    }
  }

  @Test
  public void updateProductLevel3InfoLogisticUpdateValueTest() throws Exception {
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    updateProductLevel3InfoRequest.setProductType(3);
    updateProductLevel3InfoRequest.setLogistics(
        Arrays.asList(ProductItemLogisticsRequest.builder().logisticProductCode("GOJEK1").isSelected(false).build()));
    updateProductLevel3InfoRequest.setInStore(true);
    ProductLevel3Logistics productLevel3Logistics1 = new ProductLevel3Logistics();
    productLevel3Logistics1.setLogisticProductCode("GOJEK1");
    productLevel3Logistics1.setSelected(true);
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    List<ProductLevel3Logistics> productLevel3LogisticsList = new ArrayList<>();
    productLevel3LogisticsList.add(productLevel3Logistics);
    productLevel3LogisticsList.add(productLevel3Logistics1);
    productAndItemsResponse.getItems().stream().findFirst().get().setOff2OnChannelActive(false);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setProductType(ProductType.REGULAR);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(any()))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    when(productLevel3LogisticsService.findLogisticsByItemSku(Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(productLevel3LogisticsList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenThrow(RuntimeException.class);
    productLevel3UpdateRequest.setSynchronize(false);
    try {
      Assertions.assertThrows(Exception.class, () -> {
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
      });
    } finally {
      verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
      verify(getProductLevel3Repository(), TWO_TIMES).findDetailByGdnSku(Mockito.any());
      verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
          DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
      verify(xProductOutbound, TWO_TIMES).getProductDetailsByProductSku(Mockito.any());
      verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
      verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(any(), any(), any(), any(), any(),
          any(), any(), anyBoolean(), any());
      verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
      verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
          Mockito.any(ItemRequest.class));
      verify(updatedProductHistoryService, TWO_TIMES).createProductL3AuditLog(Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.anyBoolean(), eq(StringUtils.EMPTY));
      verify(productLevel3LogisticsService).saveLogisticsByItemSku(Mockito.anyList(), Mockito.any(),
          Mockito.anyList(), Mockito.anyBoolean());
      verify(xProductOutbound).updateOff2OnActiveFlagByProductSku(Mockito.any(Map.class));
      verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_GDN_SKU, null, false);
      verify(productLevel3V2Service).validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class), Mockito.any(),
          Mockito.any(), Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false));
    }
  }

  @Test
  public void updateProductLevel3InfoProductHasOrderTest() throws Exception {
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    agpSimpleQueryResponse.getHits().setTotal(10);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    predefinedAllowedAttributeValueResponse.setValue(DEFAULT_ATTRIBUTE_VALUE);
    when(this.predefinedAttributeAllowedValueService.findByStoreIdAndMatchAttributeCodeAndValue(Mockito.any(),
        eq(DEFAULT_ATTRIBUTE_CODE_2), eq(DEFAULT_ATTRIBUTE_VALUE))).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(agpQueryFeign.findNumberOfOrder(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(agpSimpleQueryResponse);
    EditProductResponse editProductResponse =
        productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    Assertions.assertEquals(ApiErrorCode.PRODUCT_HAS_ORDER.name(), editProductResponse.getApiErrorCode().name());
  }

  @Test
  public void updateProductLevel3InfoAgpResponseEmptyTest() throws Exception {
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    predefinedAllowedAttributeValueResponse.setValue(DEFAULT_ATTRIBUTE_VALUE);
    when(this.predefinedAttributeAllowedValueService.findByStoreIdAndMatchAttributeCodeAndValue(Mockito.any(),
        eq(DEFAULT_ATTRIBUTE_CODE_2), eq(DEFAULT_ATTRIBUTE_VALUE))).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(agpQueryFeign.findNumberOfOrder(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(null);
    try {
      Assertions.assertThrows(Exception.class, () -> {
        EditProductResponse editProductResponse =
            productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
      });
    } finally {
      verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
      verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    }
  }

  @Test
  public void updateProductLevel3InfoAgpResponseHitsEmptyTest() throws Exception {
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    ProductL3Response savedProductData1 = generateProductL3Response();
    agpSimpleQueryResponse.setHits(null);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    predefinedAllowedAttributeValueResponse.setValue(DEFAULT_ATTRIBUTE_VALUE);
    when(this.predefinedAttributeAllowedValueService.findByStoreIdAndMatchAttributeCodeAndValue(Mockito.any(),
        eq(DEFAULT_ATTRIBUTE_CODE_2), eq(DEFAULT_ATTRIBUTE_VALUE))).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(agpQueryFeign.findNumberOfOrder(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(agpSimpleQueryResponse);
    try {
      Assertions.assertThrows(Exception.class, () -> {
        EditProductResponse editProductResponse =
            productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
      });
    } finally {
      verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
      verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    }
  }

  @Test
  public void updateProductLevel3InfoDimensionErrTrue() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateUpdateProductLevel3Info", true);
    updateProductLevel3InfoRequest.setProductType(PRODUCT_TYPE_REGULAR);
    updateProductLevel3InfoRequest.setDimension(
            DimensionRequest.builder()
                    .height(10.0)
                    .width(10.0)
                    .weight(10.0)
                    .build());
    when(productLevel3V2Service.validateShippingAndDimensionForEdit(updateProductLevel3InfoRequest.getDimension(), true)).thenReturn(ApiErrorCode.DIMENSION_LESS_THAN_ZERO);
    EditProductResponse resp =
            productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(productLevel3V2Service).validateShippingAndDimensionForEdit(updateProductLevel3InfoRequest.getDimension(), true);
    Assertions.assertEquals(ApiErrorCode.DIMENSION_LESS_THAN_ZERO.name(), resp.getApiErrorCode().name());
    Mockito.verify(productLevel3V2Service).validateShippingAndDimensionForEdit(any(), eq(true));
  }
  @Test
  public void updateProductLevel3InfoCategoryErrTrue() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "validateUpdateProductLevel3Info", true);
    final String SAME_NAME = "NAME_OK";
    updateProductLevel3InfoRequest.setProductType(PRODUCT_TYPE_BOPIS);
    updateProductLevel3InfoRequest.setProductName(SAME_NAME);
    updateProductLevel3InfoRequest.setAttributes(new HashMap<String, String>() {{
      put(DEFAULT_ATTRIBUTE_CODE_2, "val");
    }});
    updateProductLevel3InfoRequest.setDimension(
            DimensionRequest.builder().length(1.0).width(1.0).height(1.0).weight(1.0).build());
    when(productLevel3V2Service.validateShippingAndDimensionForEdit(any(), eq(true))).thenReturn(null);
    when(productService.checkBpBopisEligibility(eq(PRODUCT_TYPE_BOPIS), any())).thenReturn(null);
    ProductL3Response savedProductData = generateProductL3Response();
    when(xProductOutbound.getProductDetailsByProductSku(any()))
            .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setProductName(SAME_NAME);
    when(getProductLevel3Repository().findDetailByGdnSku(eq(savedProductData.getDefaultItemSku())))
            .thenReturn(productData);
    ProfileResponse officialProfile = getProfileResponse();
    officialProfile.setOfficial(true);
    when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(any()))
            .thenReturn(officialProfile);
    CategoryDetailResponse categoryResponse = new CategoryDetailResponse();
    categoryResponse.setBopisEligible(false);
    categoryResponse.setCategoryAttributes(new ArrayList<>());
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
      com.gdn.x.productcategorybase.dto.response.AttributeResponse.builder()
      .attributeCode(DEFAULT_ATTRIBUTE_CODE_2)
      .attributeType(DEFAULT_ATTRIBUTE_TYPE_2)
      .build());
    categoryResponse.getCategoryAttributes().add(categoryAttributeResponse);
    when(productOutbound.getCategoryDetailByCategoryCode(anyString())).thenReturn(categoryResponse);
    EditProductResponse resp = productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    Assertions.assertEquals(ApiErrorCode.BOPIS_CATEGORY_ELIGIBILTY_ERROR.name(), resp.getApiErrorCode().name());
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(Mockito.eq(DEFAULT_PRODUCT_SKU));
    Mockito.verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.eq(savedProductData.getDefaultItemSku()));
    Mockito.verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.eq(savedProductData.getMerchantCode()));
    Mockito.verify(productOutbound).getCategoryDetailByCategoryCode(Mockito.eq(DEFAULT_CATEGORY_CODE));
    Mockito.verify(productService).checkBpBopisEligibility(Mockito.eq(PRODUCT_TYPE_BOPIS), Mockito.any(ProfileResponse.class));
    Mockito.verify(productLevel3V2Service).validateShippingAndDimensionForEdit(any(), eq(true));
  }

  @Test
  public void updateLogisticsOnlyProductTypeChangeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    MDC.put("storeId", STORE_ID);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(productLevel3UpdateRequest.getLength());
    savedProductData1.setWidth(productLevel3UpdateRequest.getWidth());
    savedProductData1.setHeight(productLevel3UpdateRequest.getHeight());
    savedProductData1.setWeight(productLevel3UpdateRequest.getWeight());
    savedProductData1.setShippingWeight(productLevel3UpdateRequest.getShippingWeight());
    productLevel3UpdateRequest.setSynchronize(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);

  }

  @Test
  public void updateLogisticsOnlyDimensionChangeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    MDC.put("storeId", STORE_ID);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductL3Response savedProductData1 = generateProductL3Response();
    productLevel3UpdateRequest.setProductType(savedProductData1.getProductType().getCode());
    productLevel3UpdateRequest.setSynchronize(false);
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse = new SimpleMasterProductUpdateResponse();
    simpleMasterProductUpdateResponse.setDimensionOrDgLevelUpdated(true);
    simpleMasterProductUpdateResponse.setUpdateSuccess(true);
    Mockito.when(this.productRepository.updateSimpleMasterProduct(any(SimpleMasterProductUpdateRequestDTO.class)))
        .thenReturn(simpleMasterProductUpdateResponse);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateLogisticsBothProductTypeAndDimensionChangeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    MDC.put("storeId", STORE_ID);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductL3Response savedProductData1 = generateProductL3Response();
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse = new SimpleMasterProductUpdateResponse();
    simpleMasterProductUpdateResponse.setDimensionOrDgLevelUpdated(true);
    simpleMasterProductUpdateResponse.setUpdateSuccess(true);
    productLevel3UpdateRequest.setSynchronize(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(this.productRepository.updateSimpleMasterProduct(any(SimpleMasterProductUpdateRequestDTO.class)))
        .thenReturn(simpleMasterProductUpdateResponse);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateLogisticsNoProductTypeAndDimensionChangeTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    MDC.put("storeId", STORE_ID);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setLength(productLevel3UpdateRequest.getLength());
    savedProductData1.setWidth(productLevel3UpdateRequest.getWidth());
    savedProductData1.setHeight(productLevel3UpdateRequest.getHeight());
    savedProductData1.setWeight(productLevel3UpdateRequest.getWeight());
    savedProductData1.setShippingWeight(productLevel3UpdateRequest.getShippingWeight());
    productLevel3UpdateRequest.setProductType(savedProductData1.getProductType().getCode());
    productLevel3UpdateRequest.setSynchronize(false);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
  }

  @Test
  public void itemViewConfigEditFreeSampleExceptionTest() throws Exception {
    Exception exception = new Exception();
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    itemViewConfigRequest.setBuyable(true);
    itemViewConfigRequest.setDiscoverable(true);
    item.getItems().get(0).setFreeSample(true);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateItemViewConfigToHideItemSku(itemViewConfigRequest, ITEM_SKU,
            StringUtils.EMPTY);
      });
    } catch (ApplicationRuntimeException e) {
      exception = e;
      throw e;
    } finally {
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    }
  }

  @Test
  public void updateSummaryFreeSampleExceptionTest() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getViewConfigs().get(0).setBuyable(true);
    request.getViewConfigs().get(0).setDisplay(true);
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    itemSummaryResponse.setFreeSample(true);
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any())).thenReturn(itemSummaryResponse);
    Exception exception = new Exception();
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU, request);
      });
    } catch (ApplicationRuntimeException e) {
      exception = e;
      throw e;
    }
    verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
  }

  @Test
  public void productQuickEdit_PriceException() throws Exception {
    Map<String, String> itemSkuStatusMap = new HashMap<>();
    campaignUpdateDiscountResponse.setItemSkuStatusMap(itemSkuStatusMap);
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(true);
    itemSummaryResponse.setBuyable(true);
    itemSummaryResponse.setFreeSample(false);
    quickEditRequest.setOff2OnActiveFlag(true);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.B2B);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(
      itemSummaryResponse);
    when(updateProductItemLevel3ModelConverter.convertFromProductLevel3Summary(
      Mockito.any(ProductLevel3Summary.class))).thenReturn(new UpdateProductItemLevel3Model());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(MERCHANT_CODE_1)).thenReturn(profileResponse);
    when(productPricingOutbound.getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any())).thenReturn(wholesalePriceSkuResponse);
    when(campaignOutbound.validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(campaignUpdateDiscountResponse);
    when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1,
      DEFAULT_ITEM_SKU)).thenReturn(new ProductLevel3Inventory());
    doNothing().when(productLevel3InventoryService)
      .updateStock(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getDeltaStock());
    doNothing().when(productLevel3InventoryService)
      .updateSyncStockByBusinessPartnerCodeAndGdnSku(MERCHANT_CODE_1, quickEditRequest.getItemSku(),
        quickEditRequest.getUseWarehouseStock(), new ArrayList<>());
    doNothing().when(productLevel3InventoryService)
      .updatePickupPoint(MERCHANT_CODE_1, quickEditRequest.getItemSku(), quickEditRequest.getItemSku());
    doThrow(Exception.class).when(campaignOutbound)
      .validateAndUpdateDiscountPrice(anyBoolean(), any(CampaignUpdateDiscountRequest.class));
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "100", Constants.MINIMUM_PRICE, false));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU,
            productLevel3QuickEditRequest, new ArrayList());
      });
    } finally {
      verify(productPricingOutbound).getWholesalePrice(eq(DEFAULT_ITEM_SKU), Mockito.any());
      verify(productSystemParameterService, times(2)).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        Constants.MINIMUM_PRICE);
      verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
      verify(campaignOutbound).validateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
      verify(campaignOutbound).validateAndUpdateDiscountPrice(anyBoolean(),
        any(CampaignUpdateDiscountRequest.class));
      verify(productLevel3InventoryService).findInventoryByBusinessPartnerCodeAndGdnSku(
        MERCHANT_CODE_1, DEFAULT_ITEM_SKU);
      verify(wholesaleValidationUtil).validateWholesaleConfigOnUpdate(Mockito.any(), Mockito.anyList(),
        Mockito.any(ItemRequest.class), Mockito.any(Integer.class), Mockito.any(), Mockito.any(Boolean.class),
          eq(null));
      verify(xProductOutbound).updateItemListing(eq(DEFAULT_PRODUCT_SKU), eq(ProductType.BOPIS),
        quickEditListArgumentCaptor.capture());
    }
  }


  @Test
  public void quickEditFreeSampleExceptionTest() throws Exception {
    Exception exception = new Exception();
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(false);
    itemSummaryResponse.setBuyable(true);
    itemSummaryResponse.setPriceEditDisabled(true);
    itemSummaryResponse.setFreeSample(true);
    quickEditRequest.setOff2OnActiveFlag(true);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.ONLINE);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
            new ArrayList());
      });
    } catch (ApplicationRuntimeException e) {
      exception = e;
      throw e;
    }
    verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
  }

  @Test
  public void priceStockEditFreeSampleExceptionTest() throws Exception {
    Exception exception = new Exception();
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest = new ProductLevel3ViewConfigRequest();
    productLevel3ViewConfigRequest.setBuyable(true);
    productLevel3ViewConfigRequest.setDisplay(true);

    List<ProductLevel3ViewConfigRequest> productLevel3ViewConfigRequests = new ArrayList<>();
    productLevel3ViewConfigRequests.add(productLevel3ViewConfigRequest);

    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setViewConfigs(productLevel3ViewConfigRequests);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);

    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.getProductItems().get(0).getViewConfigs().get(0).setBuyable(true);
    updateItemsPriceStockImagesRequest.getProductItems().get(0).getViewConfigs().get(0).setDisplay(true);
    productL3Response.setFreeSample(true);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
            DEFAULT_BUSINESS_PARTNER_CODE);
      });
    } catch (ApplicationRuntimeException e) {
      exception = e;
      throw e;
    } finally {
      verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    }
  }

  @Test()
  public void priceStockEditCampaignExceptionTest() throws Exception {
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest = new ProductLevel3ViewConfigRequest();
    productLevel3ViewConfigRequest.setBuyable(true);
    productLevel3ViewConfigRequest.setDisplay(true);
    List<ItemSummaryDetailResponse> items = new ArrayList<>();
    ItemSummaryDetailResponse item =
      ItemSummaryDetailResponse.builder().itemSku(ITEM_SKU).itemCode(ITEM_CODE).merchantSku(DEFAULT_MERCHANT_SKU)
        .generatedItemName(DEFAULT_ITEM_NAME).masterCatalog(new MasterCatalogDTO()).salesCatalogs(new ArrayList<>())
        .price(new HashSet<>()).itemViewConfigs(new HashSet<>()).productType(ProductType.REGULAR)
        .pickupPointCode(DEFAULT_PICKUP_POINT_CODE).masterDataItemImages(new ArrayList<>()).isLateFulfillment(false)
        .merchantCode(DEFAULT_BUSINESS_PARTNER_CODE).build();
    item.getMasterCatalog().setCategory(new CategoryDTO(DEFAULT_CATEGORY_CODE, null));
    item.setProductCode(PRODUCT_CODE);
    item.setProductSku(DEFAULT_PRODUCT_SKU);
    item.setPriceEditDisabled(true);
    item.setProductScore(90.0);
    items.add(item);
    List<ProductLevel3ViewConfigRequest> productLevel3ViewConfigRequests = new ArrayList<>();
    productLevel3ViewConfigRequests.add(productLevel3ViewConfigRequest);
    List<ProductLevel3Inventory> inventories = new ArrayList<>();
    inventories.add(generateInventory(item));
    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setViewConfigs(productLevel3ViewConfigRequests);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);
    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.getProductItems().get(0).getViewConfigs().get(0).setBuyable(true);
    updateItemsPriceStockImagesRequest.getProductItems().get(0).getViewConfigs().get(0).setDisplay(true);
    productL3Response.setFreeSample(false);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(campaignOutbound.validateDiscountPrice(anyBoolean(),
      any(CampaignUpdateDiscountRequest.class))).thenReturn(null);
    Mockito.when(productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndListOfGdnSku(
      filterRequest.getBusinessPartnerCode(), Arrays.asList(ITEM_SKU))).thenReturn(inventories);
    try {
      productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
        DEFAULT_BUSINESS_PARTNER_CODE);
    }  finally {
      Mockito.verify(productLevel3Repository)
        .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
          Mockito.any(SortOrder.class));
      Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndListOfGdnSku(any(), anyList());
      verify(variantEditValidationService).validateListOfVariantsForMultiUsedProduct(Mockito.anyList(), Mockito.anyList(),
        Mockito.anyMap());
      verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    }
  }


  @Test
  public void itemViewConfigEditFreeSampleException_DiscoverableTrueTest() throws Exception {
    Exception exception = new Exception();
    ProductAndItemsResponse item = generateProductData();
    item.getItems().get(0).setArchived(false);
    itemViewConfigRequest.setDiscoverable(true);
    item.getItems().get(0).setFreeSample(true);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(item);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateItemViewConfigToHideItemSku(itemViewConfigRequest, ITEM_SKU,
            StringUtils.EMPTY);
      });
    } catch (ApplicationRuntimeException e) {
      exception = e;
      throw e;
    } finally {
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    }
  }

  @Test
  public void updateSummaryFreeSampleException_DiscoverableTrueTest() throws Exception {
    ProductLevel3UpdateSummary request = generateProductLevel3UpdateSummary();
    request.getViewConfigs().get(0).setBuyable(false);
    request.getViewConfigs().get(0).setDisplay(true);
    request.getPrices().get(0).setSalePrice(20000.0);
    request.setAccessChannel(UpdateProductAccessChannel.MTA_API_UPDATE_SINGLE.getDesc());
    itemSummaryResponse.setFreeSample(true);
    Mockito.when(getProductLevel3Repository().findSummaryByGdnSku(Mockito.any())).thenReturn(itemSummaryResponse);
    Exception exception = new Exception();
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        this.productLevel3ServiceBean.updateSummary(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_GDN_SKU, request);
      });
    } catch (ApplicationRuntimeException e) {
      exception = e;
      throw e;
    } finally {
      verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
    }
  }

  @Test
  public void quickEditFreeSampleException_DiscoverableTrueTest() throws Exception {
    Exception exception = new Exception();
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(false);
    itemSummaryResponse.setBuyable(false);
    itemSummaryResponse.setDiscoverable(true);
    itemSummaryResponse.setPriceEditDisabled(true);
    itemSummaryResponse.setFreeSample(true);
    quickEditRequest.setOff2OnActiveFlag(true);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.ONLINE);
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setInternationalFlag(false);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
            new ArrayList());
      });
    } catch (ApplicationRuntimeException e) {
      exception = e;
      throw e;
    }
    verify(getProductLevel3Repository()).findSummaryByGdnSku(Mockito.any());
  }

  @Test
  public void priceStockEditFreeSampleException_DiscoverableTrueTest() throws Exception {
    Exception exception = new Exception();
    ProductLevel3ViewConfigRequest productLevel3ViewConfigRequest = new ProductLevel3ViewConfigRequest();
    productLevel3ViewConfigRequest.setBuyable(false);
    productLevel3ViewConfigRequest.setDisplay(true);

    List<ProductLevel3ViewConfigRequest> productLevel3ViewConfigRequests = new ArrayList<>();
    productLevel3ViewConfigRequests.add(productLevel3ViewConfigRequest);

    List<ProductPriceStockAndImagesRequest> productPriceStockAndImagesRequests = new ArrayList<>();
    List<ProductPriceStockAndImagesRequest> successValidationVariantList = new ArrayList<>();
    productPriceStockAndImagesRequest.setSkuCode(DEFAULT_SKU_CODE);
    productPriceStockAndImagesRequest.setProductSku(DEFAULT_PRODUCT_SKU);
    productPriceStockAndImagesRequest.getImages().get(0).setReviewType(StringUtils.EMPTY);
    productPriceStockAndImagesRequest.setViewConfigs(productLevel3ViewConfigRequests);
    successValidationVariantList.add(productPriceStockAndImagesRequest);
    productPriceStockAndImagesRequests.add(productPriceStockAndImagesRequest);

    UpdateItemsPriceStockImagesRequest updateItemsPriceStockImagesRequest = new UpdateItemsPriceStockImagesRequest();
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.setCopyToAllVariantImages(new ArrayList<>());
    updateItemsPriceStockImagesRequest.setProductEditable(false);
    updateItemsPriceStockImagesRequest.setSynchronize(true);
    updateItemsPriceStockImagesRequest.setProductItems(productPriceStockAndImagesRequests);
    updateItemsPriceStockImagesRequest.getProductItems().get(0).getViewConfigs().get(0).setBuyable(false);
    updateItemsPriceStockImagesRequest.getProductItems().get(0).getViewConfigs().get(0).setDisplay(true);
    productL3Response.setFreeSample(true);
    when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.editProductItemsPriceStockImages(DEFAULT_STORE_ID, updateItemsPriceStockImagesRequest,
            DEFAULT_BUSINESS_PARTNER_CODE);
      });
    } catch (ApplicationRuntimeException e) {
      exception = e;
      throw e;
    } finally {
      verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    }
  }

  @Test
  public void getCogsValueResponseTest() {
    productLevel3ServiceBean.fetchCogsValueByMaterialCode(ITEM_SKU);
    verify(sapOutbound).getCogsValueResponse(ITEM_SKU);
  }

  @Test
  public void updateImagesApiErrorCodeNotNullTest() throws Exception {
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setSuspended(true);
    productL3Response.setMarkForDelete(true);
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).build();

    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));

    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);

    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);

    Assertions.assertNotNull(itemsPriceStockImagesUpdateResponse.getApiErrorCode());
  }

  @Test
  public void updateImagesApiErrorCodeProductNotEditableTest() throws Exception {
    ProductL3Response productL3Response = new ProductL3Response();
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).build();

    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));

    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);

    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);

    Assertions.assertNotNull(itemsPriceStockImagesUpdateResponse.getApiErrorCode());
  }

  @Test
  public void testSetMainImageFlagForProductImages() {
    ProductLevel3 productLevel3 = new ProductLevel3();
    List<ProductLevel3Image> level3Images = new ArrayList<>();
    ProductLevel3Image productLevel3Image = new ProductLevel3Image();
    productLevel3Image.setMainImage(true);
    productLevel3Image.setLocationPath(DEFAULT_LOCATION_PATH);
    level3Images.add(productLevel3Image);
    productLevel3.setImages(level3Images);

    Product product = new Product();
    List<ProductImage> productImages = new ArrayList<>();
    ProductImage image = new ProductImage();
    image.setLocationPath(DEFAULT_LOCATION_PATH);
    image.setMainImages(false);
    ProductImage image2 = new ProductImage();
    image2.setLocationPath(DEFAULT_LOCATION_PATH.concat(DEFAULT_LOCATION_PATH));
    image2.setMainImages(false);
    productImages.add(image);
    productImages.add(image2);
    product.setProductImages(productImages);
    ProductItem productItem = new ProductItem();
    ProductItemImage productItemImage = new ProductItemImage();
    productItemImage.setCommonImage(true);
    productItemImage.setMainImages(false);
    productItemImage.setLocationPath(DEFAULT_LOCATION_PATH);
    productItem.setProductItemImages(Collections.singletonList(productItemImage));
    product.setProductItems(Collections.singletonList(productItem));
    productLevel3ServiceBean.setMainImageFlagForProductImages(productLevel3, product);
    Assertions.assertEquals(true, productImages.get(0).isMainImages());
}

  @Test
  public void testSetMainImageFlagForProductImagesWithDifferentImage() {
    ProductLevel3 productLevel3 = new ProductLevel3();
    List<ProductLevel3Image> level3Images = new ArrayList<>();
    ProductLevel3Image productLevel3Image = new ProductLevel3Image();
    productLevel3Image.setMainImage(true);
    productLevel3Image.setLocationPath(DEFAULT_LOCATION_PATH);
    level3Images.add(productLevel3Image);
    productLevel3.setImages(level3Images);

    Product product = new Product();
    List<ProductImage> productImages = new ArrayList<>();
    ProductImage image = new ProductImage();
    image.setLocationPath(DEFAULT_LOCATION_PATH);
    image.setMainImages(false);
    ProductImage image2 = new ProductImage();
    image2.setLocationPath(DEFAULT_LOCATION_PATH.concat(DEFAULT_LOCATION_PATH));
    image2.setMainImages(false);
    productImages.add(image);
    productImages.add(image2);
    product.setProductImages(productImages);
    ProductItem productItem = new ProductItem();
    ProductItemImage productItemImage = new ProductItemImage();
    productItemImage.setCommonImage(true);
    productItemImage.setMainImages(false);
    productItemImage.setLocationPath(DEFAULT_LOCATION_PATH.concat("-9"));
    productItem.setProductItemImages(Collections.singletonList(productItemImage));
    product.setProductItems(Collections.singletonList(productItem));
    productLevel3ServiceBean.setMainImageFlagForProductImages(productLevel3, product);
    Assertions.assertEquals(true, productImages.get(0).isMainImages());
  }

  @Test
  public void updateEditInfoAddDeleteVariantTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "addDeleteVariantSwitch", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().setPreOrder(null);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setProductEditable(true);
    product.setSizeChartCode(SIZE_CHART_CODE);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setDeletedItems(Arrays.asList(ITEM_SKU));
    ProductLevel3Attribute productLevel3Attribute1 = new ProductLevel3Attribute();
    productLevel3Attribute1.setSkuValue(Boolean.TRUE);
    productLevel3Attribute1.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    productLevel3Attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productLevel3Attribute1.setVariantCreation(true);
    productLevel3Attribute1.setValues(Arrays.asList("Red"));
    ProductLevel3Attribute productLevel3Attribute2 = new ProductLevel3Attribute();
    productLevel3Attribute2.setSkuValue(Boolean.FALSE);
    productLevel3Attribute2.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    productLevel3Attribute2.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productLevel3Attribute2.setVariantCreation(true);
    productLevel3Attribute2.setValues(Arrays.asList("Green"));
    ProductLevel3Attribute productLevel3Attribute3 = new ProductLevel3Attribute();
    productLevel3Attribute3.setSkuValue(Boolean.TRUE);
    productLevel3Attribute3.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE.name());
    productLevel3Attribute3.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productLevel3Attribute3.setAttributeName(BRAND_NAME);
    productLevel3Attribute3.setValues(Arrays.asList("H&M"));
    ProductLevel3Attribute productLevel3Attribute4 = new ProductLevel3Attribute();
    productLevel3Attribute4.setSkuValue(Boolean.TRUE);
    productLevel3Attribute4.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    productLevel3Attribute4.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_5);
    productLevel3Attribute4.setValues(Arrays.asList("H&M"));
    ProductLevel3Attribute productLevel3Attribute5 = new ProductLevel3Attribute();
    productLevel3Attribute5.setSkuValue(Boolean.FALSE);
    productLevel3Attribute5.setVariantCreation(true);
    productLevel3Attribute5.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    productLevel3Attribute5.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productLevel3Attribute5.setValues(Arrays.asList("Royal"));
    product.setAttributes(Arrays.asList(productLevel3Attribute1, productLevel3Attribute2, productLevel3Attribute3,
        productLevel3Attribute4));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    ProductAttribute productAttribute2 = new ProductAttribute();
    productAttribute2.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute2.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute2.setOwnByProductItem(true);
    Attribute attribute2 = new Attribute();
    attribute2.setAttributeType(AttributeType.DEFINING_ATTRIBUTE);
    attribute2.setVariantCreation(true);
    attribute2.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_5);
    attribute2.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute2.setAttribute(attribute2);
    ProductAttribute productAttribute3 = new ProductAttribute();
    productAttribute3.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute3.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute3.setOwnByProductItem(true);
    Attribute attribute3 = new Attribute();
    attribute3.setAttributeType(AttributeType.DEFINING_ATTRIBUTE);
    attribute3.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    attribute3.setName(DEFAULT_ATTRIBUTE_NAME);
    attribute3.setVariantCreation(true);
    productAttribute3.setAttribute(attribute3);
    existingProduct.setProductAttributes(Arrays.asList(productAttribute, productAttribute2, productAttribute3));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    attribute.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_2)).thenReturn(attribute);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_5)).thenReturn(attribute);
    AttributeResponse attributeResponse =new AttributeResponse();
    attributeResponse.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    attributeResponse.setVariantCreation(true);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_4)).thenReturn(attributeResponse);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    AllowedAttributeValueRequest allowedAttributeValueRequest = new AllowedAttributeValueRequest();
    allowedAttributeValueRequest.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    allowedAttributeValueRequest.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    allowedAttributeValueRequest.setValues(Arrays.asList("Red", "Green"));
    com.gdn.x.productcategorybase.dto.allowedvalue.AllowedAttributeValueResponse allowedAttributeValueResponse =
        new com.gdn.x.productcategorybase.dto.allowedvalue.AllowedAttributeValueResponse();
    AllowedValueResponse allowedValueResponse1 = new AllowedValueResponse();
    allowedValueResponse1.setValue("Red");
    AllowedValueResponse allowedValueResponse2 = new AllowedValueResponse();
    allowedValueResponse2.setValue("Green");
    allowedAttributeValueResponse.setAllowedValue(Arrays.asList(allowedValueResponse1, allowedValueResponse2));
    allowedAttributeValueRequest.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    Mockito.when(productOutbound.findAllowedAttributeValue(Mockito.anyList()))
        .thenReturn(Collections.singletonList(allowedAttributeValueResponse));
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
       Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.anyList(), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    verify(productOutbound, Mockito.times(2)).findAllowedAttributeValue(Mockito.anyList());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
  }

  @Test
  public void updateEditInfoAddDeleteVariantDeleteVariantEmptyTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "addDeleteVariantSwitch", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().setPreOrder(null);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setDeletedItems(new ArrayList<>());
    VideoAddEditRequest videoAddEditRequest = new VideoAddEditRequest();
    product.setVideoUpdated(null);
    videoAddEditRequest.setVideoId(ID);
    videoAddEditRequest.setVideoUrl(URL_VIDEO_EDITED);
    product.setVideoAddEditRequest(videoAddEditRequest);
    ProductLevel3Attribute productLevel3Attribute1 = new ProductLevel3Attribute();
    productLevel3Attribute1.setSkuValue(Boolean.TRUE);
    productLevel3Attribute1.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    productLevel3Attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productLevel3Attribute1.setVariantCreation(true);
    productLevel3Attribute1.setValues(Arrays.asList("Red"));
    ProductLevel3Attribute productLevel3Attribute2 = new ProductLevel3Attribute();
    productLevel3Attribute2.setSkuValue(Boolean.FALSE);
    productLevel3Attribute2.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    productLevel3Attribute2.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productLevel3Attribute2.setVariantCreation(true);
    productLevel3Attribute2.setValues(Arrays.asList("Green"));
    ProductLevel3Attribute productLevel3Attribute3 = new ProductLevel3Attribute();
    productLevel3Attribute3.setSkuValue(Boolean.TRUE);
    productLevel3Attribute3.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE.name());
    productLevel3Attribute3.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productLevel3Attribute3.setAttributeName(BRAND_NAME);
    productLevel3Attribute3.setValues(Arrays.asList("H&M"));
    ProductLevel3Attribute productLevel3Attribute4 = new ProductLevel3Attribute();
    productLevel3Attribute4.setSkuValue(Boolean.TRUE);
    productLevel3Attribute4.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    productLevel3Attribute4.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_5);
    productLevel3Attribute4.setValues(Arrays.asList("H&M"));
    ProductLevel3Attribute productLevel3Attribute5 = new ProductLevel3Attribute();
    productLevel3Attribute5.setSkuValue(Boolean.FALSE);
    productLevel3Attribute5.setVariantCreation(true);
    productLevel3Attribute5.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    productLevel3Attribute5.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productLevel3Attribute5.setValues(Arrays.asList("Royal"));
    product.setAttributes(Arrays.asList(productLevel3Attribute1, productLevel3Attribute2, productLevel3Attribute3,
        productLevel3Attribute4));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    ProductAttribute productAttribute2 = new ProductAttribute();
    productAttribute2.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute2.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute2.setOwnByProductItem(true);
    Attribute attribute2 = new Attribute();
    attribute2.setAttributeType(AttributeType.DEFINING_ATTRIBUTE);
    attribute2.setVariantCreation(true);
    attribute2.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_5);
    attribute2.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute2.setAttribute(attribute2);
    ProductAttribute productAttribute3 = new ProductAttribute();
    productAttribute3.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute3.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute3.setOwnByProductItem(true);
    Attribute attribute3 = new Attribute();
    attribute3.setAttributeType(AttributeType.DEFINING_ATTRIBUTE);
    attribute3.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    attribute3.setName(DEFAULT_ATTRIBUTE_NAME);
    attribute3.setVariantCreation(true);
    productAttribute3.setAttribute(attribute3);
    existingProduct.setProductAttributes(Arrays.asList(productAttribute, productAttribute2, productAttribute3));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    attribute.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_2)).thenReturn(attribute);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_5)).thenReturn(attribute);
    AttributeResponse attributeResponse =new AttributeResponse();
    attributeResponse.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    attributeResponse.setVariantCreation(true);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_4)).thenReturn(attributeResponse);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    AllowedAttributeValueRequest allowedAttributeValueRequest = new AllowedAttributeValueRequest();
    allowedAttributeValueRequest.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    allowedAttributeValueRequest.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    allowedAttributeValueRequest.setValues(Arrays.asList("Red", "Green"));
    com.gdn.x.productcategorybase.dto.allowedvalue.AllowedAttributeValueResponse allowedAttributeValueResponse =
        new com.gdn.x.productcategorybase.dto.allowedvalue.AllowedAttributeValueResponse();
    AllowedValueResponse allowedValueResponse1 = new AllowedValueResponse();
    allowedValueResponse1.setValue("Red");
    AllowedValueResponse allowedValueResponse2 = new AllowedValueResponse();
    allowedValueResponse2.setValue("Green");
    allowedAttributeValueResponse.setAllowedValue(Arrays.asList(allowedValueResponse1, allowedValueResponse2));
    allowedAttributeValueRequest.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    Mockito.when(productOutbound.findAllowedAttributeValue(Mockito.anyList()))
        .thenReturn(Collections.singletonList(allowedAttributeValueResponse));
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse, false, generateProductL3Response(),
      false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    verify(productOutbound, Mockito.times(2)).findAllowedAttributeValue(Mockito.anyList());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
  }

  @Test
  public void updateEditInfoAddDeleteVariantDeleteVariantEmptyExistingProductAttributeMfdTrueTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "addDeleteVariantSwitch", true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().setPreOrder(null);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setDeletedItems(new ArrayList<>());
    VideoAddEditRequest videoAddEditRequest = new VideoAddEditRequest();
    product.setVideoUpdated(Boolean.TRUE);
    videoAddEditRequest.setVideoId(ID);
    videoAddEditRequest.setVideoUrl(URL_VIDEO_EDITED);
    product.setVideoAddEditRequest(videoAddEditRequest);
    ProductLevel3Attribute productLevel3Attribute1 = new ProductLevel3Attribute();
    productLevel3Attribute1.setSkuValue(Boolean.TRUE);
    productLevel3Attribute1.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    productLevel3Attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productLevel3Attribute1.setVariantCreation(true);
    productLevel3Attribute1.setValues(Arrays.asList("Red"));
    ProductLevel3Attribute productLevel3Attribute2 = new ProductLevel3Attribute();
    productLevel3Attribute2.setSkuValue(Boolean.FALSE);
    productLevel3Attribute2.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    productLevel3Attribute2.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    productLevel3Attribute2.setVariantCreation(true);
    productLevel3Attribute2.setValues(Arrays.asList("Green"));
    ProductLevel3Attribute productLevel3Attribute3 = new ProductLevel3Attribute();
    productLevel3Attribute3.setSkuValue(Boolean.TRUE);
    productLevel3Attribute3.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE.name());
    productLevel3Attribute3.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_3);
    productLevel3Attribute3.setAttributeName(BRAND_NAME);
    productLevel3Attribute3.setValues(Arrays.asList("H&M"));
    ProductLevel3Attribute productLevel3Attribute4 = new ProductLevel3Attribute();
    productLevel3Attribute4.setSkuValue(Boolean.TRUE);
    productLevel3Attribute4.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    productLevel3Attribute4.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_5);
    productLevel3Attribute4.setValues(Arrays.asList("H&M"));
    ProductLevel3Attribute productLevel3Attribute5 = new ProductLevel3Attribute();
    productLevel3Attribute5.setSkuValue(Boolean.FALSE);
    productLevel3Attribute5.setVariantCreation(true);
    productLevel3Attribute5.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    productLevel3Attribute5.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    productLevel3Attribute5.setValues(Arrays.asList("Royal"));
    product.setAttributes(Arrays.asList(productLevel3Attribute1, productLevel3Attribute2, productLevel3Attribute3,
        productLevel3Attribute4));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    ProductAttribute productAttribute2 = new ProductAttribute();
    productAttribute2.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute2.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute2.setOwnByProductItem(true);
    Attribute attribute2 = new Attribute();
    attribute2.setAttributeType(AttributeType.DEFINING_ATTRIBUTE);
    attribute2.setVariantCreation(true);
    attribute2.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_5);
    attribute2.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute2.setMarkForDelete(true);
    productAttribute2.setAttribute(attribute2);
    ProductAttribute productAttribute3 = new ProductAttribute();
    productAttribute3.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute3.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute3.setOwnByProductItem(true);
    Attribute attribute3 = new Attribute();
    attribute3.setAttributeType(AttributeType.DEFINING_ATTRIBUTE);
    attribute3.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_4);
    attribute3.setName(DEFAULT_ATTRIBUTE_NAME);
    attribute3.setVariantCreation(true);
    productAttribute3.setMarkForDelete(true);
    productAttribute3.setAttribute(attribute3);
    existingProduct.setProductAttributes(Arrays.asList(productAttribute, productAttribute2, productAttribute3));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    attribute.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_2)).thenReturn(attribute);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_5)).thenReturn(attribute);
    AttributeResponse attributeResponse =new AttributeResponse();
    attributeResponse.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    attributeResponse.setVariantCreation(true);
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_4)).thenReturn(attributeResponse);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    AllowedAttributeValueRequest allowedAttributeValueRequest = new AllowedAttributeValueRequest();
    allowedAttributeValueRequest.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    allowedAttributeValueRequest.setAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    allowedAttributeValueRequest.setValues(Arrays.asList("Red", "Green"));
    com.gdn.x.productcategorybase.dto.allowedvalue.AllowedAttributeValueResponse allowedAttributeValueResponse =
        new com.gdn.x.productcategorybase.dto.allowedvalue.AllowedAttributeValueResponse();
    AllowedValueResponse allowedValueResponse1 = new AllowedValueResponse();
    allowedValueResponse1.setValue("Red");
    AllowedValueResponse allowedValueResponse2 = new AllowedValueResponse();
    allowedValueResponse2.setValue("Green");
    allowedAttributeValueResponse.setAllowedValue(Arrays.asList(allowedValueResponse1, allowedValueResponse2));
    allowedAttributeValueRequest.setAttributeType(AttributeType.DEFINING_ATTRIBUTE.name());
    Mockito.when(productOutbound.findAllowedAttributeValue(Mockito.anyList()))
        .thenReturn(Collections.singletonList(allowedAttributeValueResponse));
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse, false, generateProductL3Response(),
      false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE_2);
    verify(productOutbound, Mockito.times(2)).findAllowedAttributeValue(Mockito.anyList());
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
  }

  @Test
  public void updateImagesApiErrorCodeSynchronisedProductTestForNull() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(true);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode("INTERNAL");
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    productL3Response.setMerchantCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageUpdated(true)
            .imagePath(DEFAULT_LOCATION_PATH).build();
    ItemImageEditRequest itemImageEditRequest = new ItemImageEditRequest();
    itemImageEditRequest.setMarkForDelete(true);
    productImageEditRequest.setProductItems(Arrays.asList(itemImageEditRequest));
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    List<ConfigurationStatusResponse> configurationStatusResponses =
        Arrays.asList(new ConfigurationStatusResponse(MERCHANT_CODE_1, CATEGORY_CODE, POST_REVIEW_TYPE));
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType("gold");
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(sellerDetailResponse);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
  }

  @Test
  public void updateImagesApiErrorCodeImageNotUpdatedTest() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(true);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode("INTERNAL");
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imagePath(DEFAULT_LOCATION_PATH).build();
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    List<ConfigurationStatusResponse> configurationStatusResponses =
        Arrays.asList(new ConfigurationStatusResponse(MERCHANT_CODE_1, CATEGORY_CODE, POST_REVIEW_TYPE));

    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);

    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);

    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateImagesPostliveProductTest() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(false);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode(MERCHANT_CODE_1);
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageAdded(true)
            .imagePath(DEFAULT_LOCATION_PATH).build();
    CopyImageEditRequest copyToAllVariantImages = new CopyImageEditRequest();
    copyToAllVariantImages.setAdd(true);
    productImageEditRequest.setCopyToAllVariantImages(copyToAllVariantImages);
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    itemImagesUpdateStatus.put(Constants.COPY_ALL_STATUS, "SUCCESS");
    List<ConfigurationStatusResponse> configurationStatusResponses =
        Arrays.asList(new ConfigurationStatusResponse(MERCHANT_CODE_1, CATEGORY_CODE, POST_REVIEW_TYPE));
    Mockito.when(this.productRepository.getConfigurationStatus(Mockito.anyList()))
        .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any())).thenReturn("/test-image.jpeg");
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateImagesPostliveProduct_nullCopyToAllVariantImagesTest() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(false);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode(MERCHANT_CODE_1);
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageAdded(true)
            .imagePath(DEFAULT_LOCATION_PATH).build();
    productImageEditRequest.setCopyToAllVariantImages(null);
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    itemImagesUpdateStatus.put(Constants.COPY_ALL_STATUS, "SUCCESS");
    List<ConfigurationStatusResponse> configurationStatusResponses =
        Arrays.asList(new ConfigurationStatusResponse(MERCHANT_CODE_1, CATEGORY_CODE, POST_REVIEW_TYPE));
    Mockito.when(this.productRepository.getConfigurationStatus(Mockito.anyList()))
        .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any())).thenReturn(productImageEditRequest.getImagePath());
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateImagesPostliveProductImageUpdatedStatusFailTest() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(false);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode(MERCHANT_CODE_1);
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageAdded(true)
            .imagePath(DEFAULT_LOCATION_PATH).build();
    CopyImageEditRequest copyToAllVariantImages = new CopyImageEditRequest();
    copyToAllVariantImages.setAdd(true);
    productImageEditRequest.setCopyToAllVariantImages(copyToAllVariantImages);
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    itemImagesUpdateStatus.put(Constants.COPY_ALL_STATUS, "FAIL");
    List<ConfigurationStatusResponse> configurationStatusResponses =
        Arrays.asList(new ConfigurationStatusResponse(MERCHANT_CODE_1, CATEGORY_CODE, POST_REVIEW_TYPE));
    Mockito.when(this.productRepository.getConfigurationStatus(Mockito.anyList()))
        .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any())).thenReturn("/test-image.jpeg");
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateImagesPostliveProductImageUpdatedStatusBlankTest() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(false);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode(MERCHANT_CODE_1);
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageAdded(true)
            .imagePath(DEFAULT_LOCATION_PATH).build();
    CopyImageEditRequest copyToAllVariantImages = new CopyImageEditRequest();
    copyToAllVariantImages.setAdd(true);
    productImageEditRequest.setCopyToAllVariantImages(copyToAllVariantImages);
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    List<ConfigurationStatusResponse> configurationStatusResponses =
        Arrays.asList(new ConfigurationStatusResponse(MERCHANT_CODE_1, CATEGORY_CODE, POST_REVIEW_TYPE));
    Mockito.when(this.productRepository.getConfigurationStatus(Mockito.anyList()))
        .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any())).thenReturn("/test-image.jpeg");
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateImagesPostliveProduct1Test() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(false);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode(MERCHANT_CODE_1);
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageAdded(true)
            .imagePath(DEFAULT_LOCATION_PATH).build();
    CopyImageEditRequest copyToAllVariantImages = new CopyImageEditRequest();
    copyToAllVariantImages.setCopy(true);
    productImageEditRequest.setCopyToAllVariantImages(copyToAllVariantImages);
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    itemImagesUpdateStatus.put(Constants.COPY_ALL_STATUS, "SUCCESS");
    Mockito.when(this.productRepository.getConfigurationStatus(Mockito.anyList()))
        .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any())).thenReturn("/test-image.jpeg");
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null,false);
  }

  @Test
  public void updateImagesPostliveProduct2Test() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(false);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode(MERCHANT_CODE_1);
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageAdded(true)
            .imagePath(DEFAULT_LOCATION_PATH).build();
    CopyImageEditRequest copyToAllVariantImages = new CopyImageEditRequest();
    copyToAllVariantImages.setMainImage(true);
    productImageEditRequest.setCopyToAllVariantImages(copyToAllVariantImages);
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    itemImagesUpdateStatus.put(Constants.COPY_ALL_STATUS, "SUCCESS");
    Mockito.when(this.productRepository.getConfigurationStatus(Mockito.anyList()))
        .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any())).thenReturn("/test-image.jpeg");
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.verify(fileStorageService).generateFinalImageFullPath(Mockito.any());
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateImagesPostliveProduct3Test() throws Exception {
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setMerchantStatus(MerchantStatus.ACTIVE.name());
    productCollection.setReviewType(null);
    productCollection.setReviewPending(false);
    ProductL3Response productL3Response = new ProductL3Response();
    productL3Response.setProductEditable(true);
    productL3Response.setItemSkuItemCodeMap(ImmutableMap.of(ITEM_SKU, ITEM_CODE));
    productL3Response.setMasterCatalog(getMasterCatalogDTO());
    productL3Response.setSynchronized(true);
    productL3Response.setMerchantCode(MERCHANT_CODE_1);
    productL3Response.setMasterDataProduct(new MasterDataProductDTO());
    ProductImageEditRequest productImageEditRequest =
        ProductImageEditRequest.builder().productSku(DEFAULT_PRODUCT_SKU).imageAdded(true)
            .imagePath(DEFAULT_LOCATION_PATH).build();
    CopyImageEditRequest copyToAllVariantImages = new CopyImageEditRequest();
    copyToAllVariantImages.setMarkForDelete(true);
    productImageEditRequest.setCopyToAllVariantImages(copyToAllVariantImages);
    Map<String, String> itemImagesUpdateStatus = new HashMap<>();
    itemImagesUpdateStatus.put(Constants.COPY_ALL_STATUS, "SUCCESS");
    Mockito.when(this.productRepository.getConfigurationStatus(Mockito.anyList()))
        .thenReturn(Arrays.asList(configurationStatusResponse));
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(null, null, true, productL3Response, REQUESTID));
    Mockito.when(productOutbound.updateImages(
            Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class)))
        .thenReturn(itemImagesUpdateStatus);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any())).thenReturn("/test-image.jpeg");
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse =
        productLevel3ServiceBean.updateImages(STORE_ID, productImageEditRequest);
    Mockito.when(fileStorageService.generateFinalImageFullPath(Mockito.any())).thenReturn("/test-image.jpeg");
    Mockito.verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.verify(productOutbound)
        .updateImages(Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductImageEditRequest.class));
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
    Mockito.verify(productCollectionRepository).saveAndFlush(Mockito.any(ProductCollection.class));
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), eq(StringUtils.EMPTY));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateFreeSampleToPreOrderExceptionTest() throws Exception {
    Exception exception = new Exception();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().setPreOrder(preOrderDTO);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    try {
      EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
          false, generateProductL3Response(), false, null, null);
    } catch (Exception e) {
      exception = e;
      throw e;
    } finally {
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    }
  }

  @Test
  public void updateLogisticsFreeSampleToPreOrderExceptionTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    Exception exception = new Exception();
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setFreeSample(true);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    productLevel3UpdateRequest.setSynchronize(false);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
      });
    } catch (Exception e) {
      exception = e;
      throw e;
    } finally {
      verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
      verify(getCategoryRepository()).findHierarchyByCategoryCode(Mockito.any());
      verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
          PICKUP);
      verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
      verify(productLevel3LogisticsService).findLogisticsByItemSku(DEFAULT_ITEM_SKU, DEFAULT_BUSINESS_PARTNER_CODE,
          PICKUP);
      verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
          Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
      verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    }
  }

  @Test
  public void updateFreeSampleToOff2OnExceptionTest() throws Exception {
    Exception exception = new Exception();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(true);
    product.setOff2OnChannelActive(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    try {
      EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
          false, generateProductL3Response(), false, null, null);
    } catch (Exception e) {
      exception = e;
      throw e;
    } finally {
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    }
  }

  @Test
  public void updateLogisticFreeSampleNullPreOrderTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    productLevel3UpdateRequest.setPreOrder(null);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setFreeSample(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null, false);
  }

  @Test
  public void updateLogisticFreeSamplePreOrderFalseTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    preOrderRequest.setIsPreOrder(Boolean.FALSE);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setFreeSample(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, false, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(DEFAULT_ITEM_SKU);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound).updateProduct(Mockito.anyBoolean(), Mockito.any(ProductRequest.class));
    verify(xProductOutbound).updateItem(Mockito.anyBoolean(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        Mockito.any(ItemRequest.class));
    verify(xProductOutbound).generateProductScoreByProductSkuOrProductCode(DEFAULT_PRODUCT_SKU, null,false);
  }

  @Test
  public void updateLogisticCombineTrueTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", true);
    preOrderRequest.setIsPreOrder(Boolean.FALSE);
    productLevel3UpdateRequest.setPreOrder(preOrderRequest);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
        .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
        .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setFreeSample(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    productLevel3UpdateRequest.setSynchronize(false);
    productLevel3ServiceBean.updateLogistics(productLevel3UpdateRequest, false, null, true, false, true);
    verify(xProductOutbound).getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, true);
    verify(productOutbound).migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class));
    verify(this.businessPartnerRepository, TWO_TIMES).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productLevel3LogisticsService, TWO_TIMES).findLogisticsByItemSku(DEFAULT_ITEM_SKU,
        DEFAULT_BUSINESS_PARTNER_CODE, PICKUP);
    verify(xProductOutbound, times(2)).getProductDetailsByProductSku(Mockito.any());
    verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
        Mockito.any(ProductLevel3DetailResponse.class), eq(false));
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT, null,
        null, null, DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
    verify(getCategoryRepository(), times(2)).findHierarchyByCategoryCode(Mockito.any());
  }

  @Test
  public void productQuickEditFreeSampleToInStoreException() throws Exception {
    Exception exception = new Exception();
    itemSummaryResponse.setFreeSample(true);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setOff2OnActiveFlag(true);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).setStatus(ProductLevel3Status.OFFLINE);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean.productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
            new ArrayList());
      });
    } catch (Exception ex) {
      exception = ex;
      throw ex;
    } finally {
      verify(productLevel3Repository).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
    }
  }

  @Test
  public void updateEditInfoWholesalePriceToFreeSampleException() throws Exception {
    List<String> promoLabels = new ArrayList<>();
    promoLabels.add("WHOLESALE_PRICE");
    Exception exception = new Exception();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    productL3Response.setPromoLabels(promoLabels);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getItems().get(0).setWholesalePriceActivated(true);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    try {
      EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
          false, generateProductL3Response(), false, null, null);
    } catch (Exception e) {
      exception = e;
    } finally {
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(productOutbound).getReviewConfiguration(Mockito.anyList());
    }
  }

  @Test
  public void updateEditInfoWholesaleToFreeSampleException() throws Exception {
    List<String> promoLabels = new ArrayList<>();
    promoLabels.add("WHOLESALE");
    Exception exception = new Exception();
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    productL3Response.setPromoLabels(promoLabels);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getItems().get(0).setWholesalePriceActivated(true);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(true);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    try {
      EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
          false, generateProductL3Response(), false, null, null);
    } catch (Exception e) {
      exception = e;
    } finally {
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(productOutbound).getReviewConfiguration(Mockito.anyList());
    }
  }


  @Test()
  public void updateEditInfoWithFreeSampleToggleOffForUpcomingPromoTest() throws Exception {
    Exception exception = new Exception();
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().setPreOrder(null);
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.getMasterDataProduct().setBrand(BRAND_NAME);
    savedProductData.setDefaultItemSku(DEFAULT_GDN_SKU);
    savedProductData.setVersion(2L);
    savedProductData.setSynchronized(false);
    savedProductData.setFreeSample(true);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(false);
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    ApiErrorCode freeSampleChangeError = ApiErrorCode.INVALID_STATE;
    List<String> freeSampleProductList;

    PromoBundlingPricingSummaryRequest promoBundlingPricingSummaryRequest;
    PromoBundlingSummaryResponse promoBundlingSummaryResponse;

    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    GdnRestListResponse<PromoBundlingSummaryResponse> response;
    promoBundlingPricingSummaryRequest =
        PromoBundlingPricingSummaryRequest.builder().merchantCode(DEFAULT_BUSINESS_PARTNER_CODE)
            .itemSkus(new HashSet<>(Collections.singleton(DEFAULT_ITEM_SKU))).statusSet(
                Stream.of(com.gdn.partners.product.pricing.model.enums.PromoBundlingStatus.PENDING.name(),
                    PromoBundlingStatus.ACTIVE.name()).collect(Collectors.toSet())).build();
    promoBundlingSummaryResponse = PromoBundlingSummaryResponse.builder().promoBundlingCode(PROMO_BUNDLING_CODE)
        .promoBundlingName(PROMO_BUNDLING_NAME).promoBundlingType(PromoBundlingType.FREE_SAMPLE.name()).build();

    response =
        new GdnRestListResponse<>(Arrays.asList(promoBundlingSummaryResponse), new PageMetaData(1, 0, 1), REQUESTID);

    List<PromoBundlingSummaryResponse> content = response.getContent();

    freeSampleProductList = response.getContent().stream().map(PromoBundlingSummaryResponse::getPromoBundlingType)
        .filter((promoBundlingType) -> promoBundlingType.equals(PromoBundlingType.FREE_SAMPLE.name()))
        .collect(Collectors.toList());

    Mockito.when(productPricingOutbound.getPromoBundlingSummaryResponse(promoBundlingPricingSummaryRequest))
        .thenReturn(content);
    try {
      EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
          false, generateProductL3Response(), false, null, null);
      Assertions.assertEquals(freeSampleChangeError, updatedProduct.getApiErrorCode());
    } catch (Exception e) {
      exception = e;
    } finally {
      verify(productOutbound).getReviewConfiguration(Mockito.anyList());
      verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      Assertions.assertNotNull(promoBundlingPricingSummaryRequest);
      Set<String> statusSet = Stream.of(com.gdn.partners.product.pricing.model.enums.PromoBundlingStatus.PENDING.name(),
          PromoBundlingStatus.ACTIVE.name()).collect(Collectors.toSet());
      Assertions.assertArrayEquals(statusSet.toArray(), promoBundlingPricingSummaryRequest.getStatusSet().toArray());

      Assertions.assertTrue(savedProductData.isFreeSample());
      Assertions.assertFalse(product.isFreeSample());
      Assertions.assertNotNull(content);
      Assertions.assertFalse(freeSampleProductList.isEmpty());
    }
  }

  @Test()
  public void updateEditInfoWithFreeSampleToggleOffForUpcomingPromoSavedProductFreeSampleTest() throws Exception {
    Exception exception = new Exception();
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.getProduct().setPreOrder(null);
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.getMasterDataProduct().setBrand(BRAND_NAME);
    savedProductData.setDefaultItemSku(DEFAULT_GDN_SKU);
    savedProductData.setVersion(2L);
    savedProductData.setSynchronized(false);
    savedProductData.setFreeSample(true);
    savedProductData.setPromoLabels(Collections.singletonList(PROMO_LISTING));
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setFreeSample(true);
    product.setVideoAddEditRequest(new VideoAddEditRequest());
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    existingProduct.setPromoSKU(true);
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    ApiErrorCode freeSampleChangeError = ApiErrorCode.INVALID_STATE;
    List<String> freeSampleProductList;
    ProductL3Response l3Response = generateProductL3Response();
    l3Response.setFreeSample(true);
    PromoBundlingPricingSummaryRequest promoBundlingPricingSummaryRequest;
    PromoBundlingSummaryResponse promoBundlingSummaryResponse;

    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
      any())).thenReturn(null);
    GdnRestListResponse<PromoBundlingSummaryResponse> response;
    promoBundlingPricingSummaryRequest =
      PromoBundlingPricingSummaryRequest.builder().merchantCode(DEFAULT_BUSINESS_PARTNER_CODE)
        .itemSkus(new HashSet<>(Collections.singleton(DEFAULT_ITEM_SKU))).statusSet(
          Stream.of(com.gdn.partners.product.pricing.model.enums.PromoBundlingStatus.PENDING.name(),
            PromoBundlingStatus.ACTIVE.name()).collect(Collectors.toSet())).build();
    promoBundlingSummaryResponse = PromoBundlingSummaryResponse.builder().promoBundlingCode(PROMO_BUNDLING_CODE)
      .promoBundlingName(PROMO_BUNDLING_NAME).promoBundlingType(PromoBundlingType.FREE_SAMPLE.name()).build();

    response =
      new GdnRestListResponse<>(Arrays.asList(promoBundlingSummaryResponse), new PageMetaData(1, 0, 1), REQUESTID);

    List<PromoBundlingSummaryResponse> content = response.getContent();

    freeSampleProductList = response.getContent().stream().map(PromoBundlingSummaryResponse::getPromoBundlingType)
      .filter((promoBundlingType) -> promoBundlingType.equals(PromoBundlingType.FREE_SAMPLE.name()))
      .collect(Collectors.toList());

    Mockito.when(productPricingOutbound.getPromoBundlingSummaryResponse(promoBundlingPricingSummaryRequest))
      .thenReturn(content);
    try {
      EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        false, l3Response, false, null, null);
      Assertions.assertEquals(freeSampleChangeError, updatedProduct.getApiErrorCode());
    } catch (Exception e) {
      exception = e;
    } finally {
      verify(productOutbound).getReviewConfiguration(Mockito.anyList());
      verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      Assertions.assertNotNull(promoBundlingPricingSummaryRequest);
      Set<String> statusSet = Stream.of(com.gdn.partners.product.pricing.model.enums.PromoBundlingStatus.PENDING.name(),
        PromoBundlingStatus.ACTIVE.name()).collect(Collectors.toSet());
      Assertions.assertArrayEquals(statusSet.toArray(), promoBundlingPricingSummaryRequest.getStatusSet().toArray());

      Assertions.assertTrue(savedProductData.isFreeSample());
    }
  }

  @Test()
  public void updateEditInfoWithFreeSampleToggleOffChangedToOnByUser() throws Exception {
    Exception exception = new Exception();
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.setStoreId(STORE_ID);
    productData.getProduct().setPreOrder(null);
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.getMasterDataProduct().setBrand(BRAND);
    savedProductData.setDefaultItemSku(DEFAULT_GDN_SKU);
    savedProductData.setVersion(2L);
    savedProductData.setSynchronized(false);
    savedProductData.setId(STORE_ID);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    savedProductData.setFreeSample(false);
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(STORE_ID);
    product.setBrand(BRAND);
    product.setFreeSample(true);
    product.setProductEditable(true);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    List<PromoBundlingSummaryResponse> content = Collections.emptyList();
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    configurationStatusResponseList.get(0).setReviewConfig(POST_REVIEW_TYPE);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_4).attributeType(DEFAULT_ATTRIBUTE_TYPE_2)
            .build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    GdnRestListResponse<PromoBundlingSummaryResponse> response = null;
    PromoBundlingPricingSummaryRequest promoBundlingPricingSummaryRequest = null;
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);

    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    try {
      EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
          false, generateProductL3Response(), false, null, null);
    } finally {
      verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
          Mockito.any(ProductLevel3DetailResponse.class), eq(false));
      verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT,
          null, null, "MTA web update detail", DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
      verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
          any());
      verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
      verify(this.productOutbound).getAttributeDetailByAttributeCode(Mockito.anyString());
      verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.anyString(),Mockito.any(),Mockito.anyBoolean());
      verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class),Mockito.anyBoolean());
      Assertions.assertFalse(savedProductData.isFreeSample());
      Assertions.assertTrue(product.isFreeSample());
      List<String> freeSampleProductList = new ArrayList<>();
      Assertions.assertEquals(Collections.EMPTY_LIST, freeSampleProductList);
      Assertions.assertNull(promoBundlingPricingSummaryRequest);
      Assertions.assertTrue(CollectionUtils.isEmpty(content));
      PromoBundlingPricingSummaryRequest finalResponse = promoBundlingPricingSummaryRequest;
      final Throwable raisedException = catchThrowable(() -> finalResponse.getPromoBundlingName());
      assertThat(raisedException).isInstanceOf(NullPointerException.class);
    }
  }

  @Test()
  public void updateEditInfoWithFreeSampleToggleOffForUpcomingPromo_NullResponseFromPricingFeign() throws Exception {
    Exception exception = new Exception();
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    productData.setStoreId(STORE_ID);
    productData.getProduct().setPreOrder(null);
    ProductL3Response savedProductData = generateProductL3Response();
    savedProductData.getMasterDataProduct().setBrand(BRAND);
    savedProductData.setDefaultItemSku(DEFAULT_GDN_SKU);
    savedProductData.setVersion(2L);
    savedProductData.setSynchronized(false);
    savedProductData.setId(STORE_ID);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    savedProductData.setFreeSample(true);
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(STORE_ID);
    product.setBrand(BRAND);
    product.setFreeSample(false);
    product.setProductEditable(true);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    configurationStatusResponseList.get(0).setReviewConfig(POST_REVIEW_TYPE);
    CategoryAttributeResponse categoryAttributeResponse = new CategoryAttributeResponse();
    categoryAttributeResponse.setAttribute(
        AttributeResponse.builder().attributeCode(DEFAULT_ATTRIBUTE_CODE_4).attributeType(DEFAULT_ATTRIBUTE_TYPE_2)
            .build());
    categoryDetailResponse.getCategoryAttributes().add(categoryAttributeResponse);
    GdnRestListResponse<PromoBundlingSummaryResponse> response;
    PromoBundlingPricingSummaryRequest promoBundlingPricingSummaryRequest =
        PromoBundlingPricingSummaryRequest.builder().merchantCode(DEFAULT_BUSINESS_PARTNER_CODE)
            .itemSkus(new HashSet<>(Collections.singleton(DEFAULT_ITEM_SKU))).statusSet(
                Stream.of(PromoBundlingStatus.PENDING.name(), PromoBundlingStatus.ACTIVE.name())
                    .collect(Collectors.toSet())).build();
    PromoBundlingSummaryResponse promoBundlingSummaryResponse =
        PromoBundlingSummaryResponse.builder().promoBundlingCode(PROMO_BUNDLING_CODE)
            .promoBundlingName(PROMO_BUNDLING_NAME).promoBundlingType(PromoBundlingType.WHOLESALE.name()).build();
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(Mockito.any(), Mockito.any()))
        .thenReturn(productCollection);
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(productCollectionRepository.saveAndFlush(Mockito.any(ProductCollection.class)))
        .thenReturn(productCollection);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData, REQUESTID));
    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.productOutbound.getAttributeDetailByAttributeCode(Mockito.any())).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
        Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);

    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    Mockito.when(productPricingOutbound.getPromoBundlingSummaryResponse(promoBundlingPricingSummaryRequest))
        .thenReturn(null);
    try {
      EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
          false, generateProductL3Response(), false, null, null);
    } finally {
      verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
      verify(productOutbound).getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
          Mockito.any(), Mockito.anyBoolean());
      verify(productOutbound).getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE);
      verify(this.updateProductItemLevel3ModelConverter, TWO_TIMES).convertFromProductLevel3Detail(
          Mockito.any(ProductLevel3DetailResponse.class), eq(false));
      verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT,
          null, null, "MTA web update detail", DEFAULT_PRODUCT_SKU, PRODUCT_NAME1, false, StringUtils.EMPTY);
      verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
      verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
      verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
          any());
      verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    }
  }

  @Test
  public void updateProductItemImages_ProductNotEditableTest() throws Exception {
    productL3UpdateRequest.setProductEditable(false);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    productLevel3ServiceBean.updateProductItemImages(productL3UpdateRequest, productVariantUpdateRequest);
    Mockito.verify(productLevel3Repository)
        .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
            Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsForMultiUsedProduct(Mockito.anyList(), Mockito.anyList(),
        Mockito.anyMap());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
  }

  @Test
  public void updateProductItemImages_ProductEditableTrueTest() throws Exception {
    productL3UpdateRequest.setProductEditable(true);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(eq(DEFAULT_STORE_ID), any()))
        .thenReturn(productCollection);
    productLevel3ServiceBean.updateProductItemImages(productL3UpdateRequest, productVariantUpdateRequest);
    Mockito.verify(productLevel3Repository)
        .findSummaryByFilter(Mockito.any(ItemSummaryRequest.class), Mockito.any(Pageable.class),
            Mockito.any(SortOrder.class));
    verify(variantEditValidationService).validateListOfVariantsWithSuccess(Mockito.anyList(), Mockito.anyList(),
        Mockito.anyMap());
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
  }

  private MasterCatalogDTO getMasterCatalogDTO() {
    CategoryDTO categoryDTO = new CategoryDTO();
    MasterCatalogDTO masterCatalogDTO = new MasterCatalogDTO();
    masterCatalogDTO.setCategory(categoryDTO);
    return masterCatalogDTO;
  }

  @Test
  public void upsertL5StockInInventoryTest() throws Exception {
    List<UpsertOfflineItem> updateOfflineItems = new ArrayList<>();
    UpsertOfflineItem upsertOfflineItem = new UpsertOfflineItem();
    upsertOfflineItem.setItemSku(ITEM_SKU);
    upsertOfflineItem.setPickupPointCode(PICKUP_POINT_CODE);
    upsertOfflineItem.setProductSku(PRODUCT_SKU);
    upsertOfflineItem.setStock(100);
    upsertOfflineItem.setItemName(ITEM_NAME);

    UpsertOfflineItem upsertOfflineItem1 = new UpsertOfflineItem();
    upsertOfflineItem1.setItemSku(ITEM_SKU);
    upsertOfflineItem1.setPickupPointCode(PICKUP);
    upsertOfflineItem1.setProductSku(PRODUCT_SKU);
    upsertOfflineItem1.setStock(100);
    upsertOfflineItem1.setItemName(ITEM_NAME);
    upsertOfflineItem1.setNew(true);

    updateOfflineItems.add(upsertOfflineItem);
    updateOfflineItems.add(upsertOfflineItem1);

    ProductLevel3Inventory productLevel3Inventory = new ProductLevel3Inventory();
    productLevel3Inventory.setProductSku(PRODUCT_SKU);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebAvailable(1000);

    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    Mockito.when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(DEFAULT_BUSINESS_PARTNER_CODE,
        ITEM_SKU, PICKUP_POINT_CODE, -900)).thenReturn(null);
    Mockito.doNothing().when(productLevel3InventoryService).insertInventory(Mockito.anyList());

    List<UpsertOfflineItemFailedResponse> failedOfflineItemResponses = new ArrayList<>();
    List<UpsertOfflineItem> response =
        productLevel3ServiceBean.upsertL5StockInInventory(DEFAULT_BUSINESS_PARTNER_CODE, updateOfflineItems,
            failedOfflineItemResponses, profileResponse);

    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(anyList());
    Mockito.verify(this.updatedProductHistoryService)
        .createProductL3AuditLog(any(), any(), any(), any(), any(), any(),
            any(), anyBoolean(), any());
    Mockito.verify(this.productLevel3InventoryService)
        .updateStockForItemPickupPointWithErrorCode(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, -900);
    Mockito.verify(this.productLevel3InventoryService).insertInventory(anyList());
    Assertions.assertEquals(2, response.size());
  }

  @Test
  public void upsertL5StockInInventoryUpdateFailedTest() throws Exception {
    List<UpsertOfflineItem> updateOfflineItems = new ArrayList<>();
    UpsertOfflineItem upsertOfflineItem = new UpsertOfflineItem();
    upsertOfflineItem.setItemSku(ITEM_SKU);
    upsertOfflineItem.setPickupPointCode(PICKUP_POINT_CODE);
    upsertOfflineItem.setProductSku(PRODUCT_SKU);
    upsertOfflineItem.setStock(100);
    upsertOfflineItem.setItemName(ITEM_NAME);

    UpsertOfflineItem upsertOfflineItem1 = new UpsertOfflineItem();
    upsertOfflineItem1.setItemSku(ITEM_SKU);
    upsertOfflineItem1.setPickupPointCode(PICKUP);
    upsertOfflineItem1.setProductSku(PRODUCT_SKU);
    upsertOfflineItem1.setStock(100);
    upsertOfflineItem1.setItemName(ITEM_NAME);
    upsertOfflineItem1.setNew(true);

    updateOfflineItems.add(upsertOfflineItem);
    updateOfflineItems.add(upsertOfflineItem1);

    ProductLevel3Inventory productLevel3Inventory = new ProductLevel3Inventory();
    productLevel3Inventory.setProductSku(PRODUCT_SKU);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebAvailable(1000);

    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    Mockito.when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(DEFAULT_BUSINESS_PARTNER_CODE,
        ITEM_SKU, PICKUP_POINT_CODE, -900)).thenReturn(ApiErrorCode.STOCK_UPDATE_FAILED);
    Mockito.doNothing().when(productLevel3InventoryService).insertInventory(Mockito.anyList());

    List<UpsertOfflineItemFailedResponse> failedOfflineItemResponses = new ArrayList<>();
    List<UpsertOfflineItem> response =
        productLevel3ServiceBean.upsertL5StockInInventory(DEFAULT_BUSINESS_PARTNER_CODE, updateOfflineItems,
            failedOfflineItemResponses, profileResponse);

    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(anyList());
    Mockito.verify(this.productLevel3InventoryService)
        .updateStockForItemPickupPointWithErrorCode(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, -900);
    Mockito.verify(this.productLevel3InventoryService).insertInventory(anyList());
    Assertions.assertEquals(1, response.size());
    Assertions.assertEquals(1, failedOfflineItemResponses.size());
  }

  @Test
  public void upsertL5StockInInventoryPurchaseOrderTest() throws Exception {

    List<UpsertOfflineItem> updateOfflineItems = new ArrayList<>();
    UpsertOfflineItem upsertOfflineItem = new UpsertOfflineItem();
    upsertOfflineItem.setItemSku(ITEM_SKU);
    upsertOfflineItem.setPickupPointCode(PICKUP_POINT_CODE);
    upsertOfflineItem.setProductSku(PRODUCT_SKU);
    upsertOfflineItem.setStock(100);
    upsertOfflineItem.setItemName(ITEM_NAME);

    UpsertOfflineItem upsertOfflineItem1 = new UpsertOfflineItem();
    upsertOfflineItem1.setItemSku(ITEM_SKU);
    upsertOfflineItem1.setPickupPointCode(PICKUP);
    upsertOfflineItem1.setProductSku(PRODUCT_SKU);
    upsertOfflineItem1.setStock(100);
    upsertOfflineItem1.setItemName(ITEM_NAME);
    upsertOfflineItem1.setNew(true);

    updateOfflineItems.add(upsertOfflineItem);
    updateOfflineItems.add(upsertOfflineItem1);

    ProductLevel3Inventory productLevel3Inventory = new ProductLevel3Inventory();
    productLevel3Inventory.setProductSku(PRODUCT_SKU);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebAvailable(1000);

    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    Mockito.when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(DEFAULT_BUSINESS_PARTNER_CODE,
        ITEM_SKU, PICKUP_POINT_CODE, -900)).thenReturn(null);
    Mockito.doNothing().when(productLevel3InventoryService).insertInventory(Mockito.anyList());

    List<UpsertOfflineItemFailedResponse> failedOfflineItemResponses = new ArrayList<>();
    profileResponse.getCompany().setPurchaseTerm(GdnBaseLookup.PURCHASE_TERM_PURCHASE_ORDER);
    List<UpsertOfflineItem> response =
        productLevel3ServiceBean.upsertL5StockInInventory(DEFAULT_BUSINESS_PARTNER_CODE, updateOfflineItems,
            failedOfflineItemResponses, profileResponse);

    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(anyList());
    Mockito.verify(this.updatedProductHistoryService)
        .createProductL3AuditLog(any(), any(), any(), any(), any(), any(),
            any(), anyBoolean(), any());
    Mockito.verify(this.productLevel3InventoryService)
        .updateStockForItemPickupPointWithErrorCode(DEFAULT_BUSINESS_PARTNER_CODE, ITEM_SKU, PICKUP_POINT_CODE, -900);
    Mockito.verify(this.productLevel3InventoryService).insertInventory(anyList());
    Assertions.assertEquals(2, response.size());
  }

  @Test
  public void upsertL5StockInInventoryDelta0Test() throws Exception {
    List<UpsertOfflineItem> updateOfflineItems = new ArrayList<>();
    UpsertOfflineItem upsertOfflineItem = new UpsertOfflineItem();
    upsertOfflineItem.setItemSku(ITEM_SKU);
    upsertOfflineItem.setPickupPointCode(PICKUP_POINT_CODE);
    upsertOfflineItem.setProductSku(PRODUCT_SKU);
    upsertOfflineItem.setStock(100);
    upsertOfflineItem.setItemName(ITEM_NAME);

    updateOfflineItems.add(upsertOfflineItem);

    ProductLevel3Inventory productLevel3Inventory = new ProductLevel3Inventory();
    productLevel3Inventory.setProductSku(PRODUCT_SKU);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebAvailable(100);

    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(Arrays.asList(productLevel3Inventory));
    Mockito.when(productLevel3InventoryService.updateStockForItemPickupPointWithErrorCode(DEFAULT_BUSINESS_PARTNER_CODE,
        ITEM_SKU, PICKUP_POINT_CODE, -900)).thenReturn(ApiErrorCode.STOCK_UPDATE_FAILED);
    Mockito.doNothing().when(productLevel3InventoryService).insertInventory(Mockito.anyList());

    List<UpsertOfflineItemFailedResponse> failedOfflineItemResponses = new ArrayList<>();
    List<UpsertOfflineItem> response =
        productLevel3ServiceBean.upsertL5StockInInventory(DEFAULT_BUSINESS_PARTNER_CODE, updateOfflineItems,
            failedOfflineItemResponses, profileResponse);

    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(anyList());
    Assertions.assertEquals(1, response.size());
  }

  @Test
  public void upsertL5StockInInventoryOnlyInsertTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "mppForWhEnabled", false);
    List<UpsertOfflineItem> updateOfflineItems = new ArrayList<>();
    UpsertOfflineItem upsertOfflineItem = new UpsertOfflineItem();
    upsertOfflineItem.setItemSku(ITEM_SKU);
    upsertOfflineItem.setPickupPointCode(PICKUP_POINT_CODE);
    upsertOfflineItem.setProductSku(PRODUCT_SKU);
    upsertOfflineItem.setStock(100);
    upsertOfflineItem.setItemName(ITEM_NAME);

    UpsertOfflineItem upsertOfflineItem1 = new UpsertOfflineItem();
    upsertOfflineItem1.setItemSku(ITEM_SKU);
    upsertOfflineItem1.setPickupPointCode(PICKUP);
    upsertOfflineItem1.setProductSku(PRODUCT_SKU);
    upsertOfflineItem1.setStock(100);
    upsertOfflineItem1.setItemName(ITEM_NAME);
    upsertOfflineItem1.setNew(true);

    updateOfflineItems.add(upsertOfflineItem);
    updateOfflineItems.add(upsertOfflineItem1);
    updateOfflineItems.forEach(item -> item.setFbbActivated(true));
    ProductLevel3Inventory productLevel3Inventory = new ProductLevel3Inventory();
    productLevel3Inventory.setProductSku(PRODUCT_SKU);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebAvailable(1000);

    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
        anyList())).thenReturn(new ArrayList());
    Mockito.doNothing().when(productLevel3InventoryService).insertInventory(Mockito.anyList());

    List<UpsertOfflineItemFailedResponse> failedOfflineItemResponses = new ArrayList<>();
    List<UpsertOfflineItem> response =
        productLevel3ServiceBean.upsertL5StockInInventory(DEFAULT_BUSINESS_PARTNER_CODE, updateOfflineItems,
            failedOfflineItemResponses, profileResponse);

    Mockito.verify(this.productLevel3InventoryService)
        .findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(anyList());
    Mockito.verify(this.productLevel3InventoryService).insertInventory(anyList());
    Assertions.assertEquals(2, response.size());
  }

  @Test
  public void upsertL5StockInInventoryOnlyInsertTestWithSwitchON() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "mppForWhEnabled", true);
    List<UpsertOfflineItem> updateOfflineItems = new ArrayList<>();
    UpsertOfflineItem upsertOfflineItem = new UpsertOfflineItem();
    upsertOfflineItem.setItemSku(ITEM_SKU);
    upsertOfflineItem.setPickupPointCode(PICKUP_POINT_CODE);
    upsertOfflineItem.setProductSku(PRODUCT_SKU);
    upsertOfflineItem.setStock(100);
    upsertOfflineItem.setItemName(ITEM_NAME);

    UpsertOfflineItem upsertOfflineItem1 = new UpsertOfflineItem();
    upsertOfflineItem1.setItemSku(ITEM_SKU);
    upsertOfflineItem1.setPickupPointCode(PICKUP);
    upsertOfflineItem1.setProductSku(PRODUCT_SKU);
    upsertOfflineItem1.setStock(100);
    upsertOfflineItem1.setItemName(ITEM_NAME);
    upsertOfflineItem1.setNew(true);

    updateOfflineItems.add(upsertOfflineItem);
    updateOfflineItems.add(upsertOfflineItem1);
    updateOfflineItems.forEach(item -> item.setFbbActivated(true));
    ProductLevel3Inventory productLevel3Inventory = new ProductLevel3Inventory();
    productLevel3Inventory.setProductSku(PRODUCT_SKU);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebAvailable(1000);

    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
      anyList())).thenReturn(new ArrayList());
    Mockito.doNothing().when(productLevel3InventoryService).insertInventory(Mockito.anyList());

    List<UpsertOfflineItemFailedResponse> failedOfflineItemResponses = new ArrayList<>();
    List<UpsertOfflineItem> response =
      productLevel3ServiceBean.upsertL5StockInInventory(DEFAULT_BUSINESS_PARTNER_CODE, updateOfflineItems,
        failedOfflineItemResponses, profileResponse);

    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(anyList());
    Mockito.verify(this.productLevel3InventoryService).insertInventory(anyList());
    Assertions.assertEquals(2, response.size());
  }

  @Test
  public void upsertL5StockInInventoryOnlyInsertTestWithSwitchONFbbFalse() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "mppForWhEnabled", true);
    List<UpsertOfflineItem> updateOfflineItems = new ArrayList<>();
    UpsertOfflineItem upsertOfflineItem = new UpsertOfflineItem();
    upsertOfflineItem.setItemSku(ITEM_SKU);
    upsertOfflineItem.setPickupPointCode(PICKUP_POINT_CODE);
    upsertOfflineItem.setProductSku(PRODUCT_SKU);
    upsertOfflineItem.setStock(100);
    upsertOfflineItem.setItemName(ITEM_NAME);

    UpsertOfflineItem upsertOfflineItem1 = new UpsertOfflineItem();
    upsertOfflineItem1.setItemSku(ITEM_SKU);
    upsertOfflineItem1.setPickupPointCode(PICKUP);
    upsertOfflineItem1.setProductSku(PRODUCT_SKU);
    upsertOfflineItem1.setStock(100);
    upsertOfflineItem1.setItemName(ITEM_NAME);
    upsertOfflineItem1.setNew(true);

    updateOfflineItems.add(upsertOfflineItem);
    updateOfflineItems.add(upsertOfflineItem1);
    updateOfflineItems.forEach(item -> item.setFbbActivated(false));
    ProductLevel3Inventory productLevel3Inventory = new ProductLevel3Inventory();
    productLevel3Inventory.setProductSku(PRODUCT_SKU);
    productLevel3Inventory.setWebItemSku(ITEM_SKU);
    productLevel3Inventory.setWebPickupPointCode(PICKUP_POINT_CODE);
    productLevel3Inventory.setWebAvailable(1000);

    when(this.productLevel3InventoryService.findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(
      anyList())).thenReturn(new ArrayList());
    Mockito.doNothing().when(productLevel3InventoryService).insertInventory(Mockito.anyList());

    List<UpsertOfflineItemFailedResponse> failedOfflineItemResponses = new ArrayList<>();
    List<UpsertOfflineItem> response =
      productLevel3ServiceBean.upsertL5StockInInventory(DEFAULT_BUSINESS_PARTNER_CODE, updateOfflineItems,
        failedOfflineItemResponses, profileResponse);

    Mockito.verify(this.productLevel3InventoryService)
      .findInventoryByBusinessPartnerCodeAndItemSkuAndPickupPointCode(anyList());
    Mockito.verify(this.productLevel3InventoryService).insertInventory(anyList());
    Assertions.assertEquals(2, response.size());
  }

  @Test
  public void productQuickEditMinimumPriceTest() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(false);
    itemSummaryResponse.setBuyable(false);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).getPrice().setPrice(0.0);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).getPrice().setSalePrice(0.0);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "1", Constants.MINIMUM_PRICE, false));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean
            .productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
                new ArrayList());
      });
    } finally {
      verify(productLevel3Repository, times(1)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
      verify(this.productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, Constants.MINIMUM_PRICE);
    }
  }

  @Test
  public void productQuickEditMinimumPrice_2Test() throws Exception {
    itemSummaryResponse.setMerchantCode(MERCHANT_CODE_1);
    itemSummaryResponse.setProductType(ProductType.BOPIS);
    itemSummaryResponse.setOff2OnChannelActive(false);
    itemSummaryResponse.setBuyable(false);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).getPrice().setPrice(0.0);
    productLevel3QuickEditRequest.getQuickEditRequests().get(0).getPrice().setSalePrice(2.0);
    when(productLevel3Repository.findSummaryByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(itemSummaryResponse);
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.MINIMUM_PRICE)).thenReturn(
      new ProductSystemParameter(Constants.MINIMUM_PRICE, "1", Constants.MINIMUM_PRICE, false));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productLevel3ServiceBean
            .productQuickEdit(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU, productLevel3QuickEditRequest,
                new ArrayList());
      });
    } finally {
      verify(productLevel3Repository, times(1)).findSummaryByGdnSku(DEFAULT_ITEM_SKU);
      verify(this.productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, Constants.MINIMUM_PRICE);
    }
  }


  @Test
  public void validateWholesaleThresholdL5Test() throws Exception {
    productLevel3ServiceBean.validateWholesaleThresholdL5(Arrays.asList(new ProductVariantPriceStockAndImagesRequest()),
        CATEGORY_CODE);
  }

  @Test
  public void validateWholesaleThresholdL5WithMoreL5Test() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "wholesalePriceFetchBatchSize", 1);
    ItemInfoDto itemInfoDto = new ItemInfoDto();
    itemInfoDto.setItemSku(ITEM_SKU);
    itemInfoDto.setPickupPointCode(PICKUP_POINT_CODE);
    itemInfoDto.setItemPickupPointId(ITEM_SKU + "-" + PICKUP_POINT_CODE);
    ItemInfoDto itemInfoDto2 = new ItemInfoDto();
    itemInfoDto2.setItemSku(ITEM_SKU);
    itemInfoDto2.setPickupPointCode(PICKUP_POINT_CODE_2);
    itemInfoDto2.setItemPickupPointId(ITEM_SKU + "-" + PICKUP_POINT_CODE_2);
    WholesalePriceSkuResponse wholesalePriceSkuResponse = new WholesalePriceSkuResponse();
    wholesalePriceSkuResponse.setItemSku(ITEM_SKU);
    wholesalePriceSkuResponse.setPickUpPointCode(PICKUP_POINT_CODE);

    WholesalePriceSkuResponse wholesalePriceSkuResponse2 = new WholesalePriceSkuResponse();
    wholesalePriceSkuResponse2.setItemSku(ITEM_SKU);
    wholesalePriceSkuResponse2.setPickUpPointCode(PICKUP_POINT_CODE_2);
    Mockito.when(productPricingOutbound.getWholesalePriceByItemSkuAndPickupPointCode(Arrays.asList(itemInfoDto)))
        .thenReturn(Arrays.asList(wholesalePriceSkuResponse));
    Mockito.when(productPricingOutbound.getWholesalePriceByItemSkuAndPickupPointCode(Arrays.asList(itemInfoDto2)))
        .thenReturn(Arrays.asList(wholesalePriceSkuResponse2));

    ProductVariantPriceStockAndImagesRequest priceStockAndImagesRequest =
        new ProductVariantPriceStockAndImagesRequest();
    priceStockAndImagesRequest.setItemSku(ITEM_SKU);
    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequest.setItemSku(ITEM_SKU);
    itemPickupPointRequest.setPickupPointId(PICKUP_POINT_CODE);
    ItemPickupPointRequest itemPickupPointRequest1 = new ItemPickupPointRequest();
    itemPickupPointRequest1.setItemSku(ITEM_SKU);
    itemPickupPointRequest1.setPickupPointId(PICKUP_POINT_CODE_2);
    priceStockAndImagesRequest.setModifiedItemPickupPoints(
        Arrays.asList(itemPickupPointRequest, itemPickupPointRequest1));
    productLevel3ServiceBean.validateWholesaleThresholdL5(Arrays.asList(priceStockAndImagesRequest), CATEGORY_CODE);
    Mockito.verify(productPricingOutbound).getWholesalePriceByItemSkuAndPickupPointCode(Arrays.asList(itemInfoDto));
    Mockito.verify(productPricingOutbound).getWholesalePriceByItemSkuAndPickupPointCode(Arrays.asList(itemInfoDto2));
  }

  @Test
  public void updateEditWithDimensionUpdateTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setFreeSample(false);
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setShippingWeight(10.0);
    existingProduct.setLength(10.0);
    existingProduct.setHeight(10.0);
    existingProduct.setWidth(10.0);
    existingProduct.setWeight(10.0);
    productL3Response.setProductType(ProductType.REGULAR);
    productL3Response.setShippingWeight(10.0);
    productL3Response.setLength(10.0);
    productL3Response.setHeight(10.0);
    productL3Response.setWidth(10.0);
    productL3Response.setFreeSample(false);
    productL3Response.setWeight(10.0);

    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().setFreeSample(false);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(product.getBusinessPartnerCode()))
        .thenReturn(this.businessPartnerData);

    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    product.setProductType(1);
    product.setShippingWeight(10.0);
    product.setLength(10.0);
    product.setHeight(10.0);
    product.setWidth(10.0);
    product.setWeight(10.0);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, true, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class),Mockito.anyBoolean());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithDimensionUpdate1Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setShippingWeight(10.0);
    existingProduct.setLength(10.0);
    existingProduct.setHeight(10.0);
    existingProduct.setWidth(10.0);
    existingProduct.setWeight(10.0);
    productL3Response.setProductType(ProductType.REGULAR);
    productL3Response.setShippingWeight(10.0);
    productL3Response.setLength(11.0);
    productL3Response.setHeight(10.0);
    productL3Response.setWidth(10.0);
    productL3Response.setWeight(10.0);

    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(product.getBusinessPartnerCode()))
        .thenReturn(this.businessPartnerData);

    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    product.setProductType(null);
    product.setShippingWeight(10.0);
    product.setLength(10.0);
    product.setHeight(10.0);
    product.setWidth(10.0);
    product.setWeight(10.0);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, true, profileResponse,
        false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithProduuctTypeUpdate1Test() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    productData.getProduct().setProductType(ProductType.REGULAR);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setShippingWeight(10.0);
    existingProduct.setLength(10.0);
    existingProduct.setHeight(10.0);
    existingProduct.setWidth(10.0);
    existingProduct.setWeight(10.0);
    productL3Response.setProductType(ProductType.BIG_PRODUCT);
    productL3Response.setShippingWeight(10.0);
    productL3Response.setLength(10.0);
    productL3Response.setHeight(10.0);
    productL3Response.setWidth(10.0);
    productL3Response.setWeight(10.0);

    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(product.getBusinessPartnerCode()))
        .thenReturn(this.businessPartnerData);

    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    product.setProductType(2);
    product.setShippingWeight(10.0);
    product.setLength(10.0);
    product.setHeight(10.0);
    product.setWidth(10.0);
    product.setWeight(10.0);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, true, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithProduuctTypeUpdate1RegularProductTest() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    productData.getProduct().setProductType(ProductType.BIG_PRODUCT);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setShippingWeight(10.0);
    existingProduct.setLength(10.0);
    existingProduct.setHeight(10.0);
    existingProduct.setWidth(10.0);
    existingProduct.setWeight(10.0);
    productL3Response.setProductType(ProductType.BIG_PRODUCT);
    productL3Response.setShippingWeight(10.0);
    productL3Response.setLength(10.0);
    productL3Response.setHeight(10.0);
    productL3Response.setWidth(10.0);
    productL3Response.setWeight(10.0);

    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
        masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(product.getBusinessPartnerCode()))
        .thenReturn(this.businessPartnerData);

    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    product.setProductType(1);
    product.setShippingWeight(10.0);
    product.setLength(10.0);
    product.setHeight(10.0);
    product.setWidth(10.0);
    product.setWeight(10.0);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, true, profileResponse,
        false, generateProductL3Response(), false, null, null);
    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithProduuctTypeUpdate1RegularProductTestForInstoreProductAndLengthAsZero() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    productData.getProduct().setProductType(ProductType.BIG_PRODUCT);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setShippingWeight(10.0);
    existingProduct.setLength(10.0);
    existingProduct.setHeight(10.0);
    existingProduct.setWidth(10.0);
    existingProduct.setWeight(10.0);
    productL3Response.setProductType(ProductType.BIG_PRODUCT);
    productL3Response.setShippingWeight(10.0);
    productL3Response.setLength(10.0);
    productL3Response.setHeight(10.0);
    productL3Response.setWidth(10.0);
    productL3Response.setWeight(10.0);

    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
      masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(product.getBusinessPartnerCode()))
      .thenReturn(this.businessPartnerData);

    product.setOff2OnChannelActive(true);
    product.setB2cActivated(false);
    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    product.setProductType(1);
    product.setShippingWeight(10.0);
    product.setLength(0.0);
    product.setHeight(10.0);
    product.setWidth(10.0);
    product.setWeight(10.0);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, true, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }

  @Test
  public void updateEditWithProduuctTypeUpdate1RegularProductTestForInstoreProduct() throws Exception {
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    productData.getProduct().setProductType(ProductType.BIG_PRODUCT);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setShippingWeight(10.0);
    existingProduct.setLength(10.0);
    existingProduct.setHeight(10.0);
    existingProduct.setWidth(10.0);
    existingProduct.setWeight(10.0);
    productL3Response.setProductType(ProductType.BIG_PRODUCT);
    productL3Response.setShippingWeight(10.0);
    productL3Response.setLength(10.0);
    productL3Response.setHeight(10.0);
    productL3Response.setWidth(10.0);
    productL3Response.setWeight(10.0);

    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
      masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(product.getBusinessPartnerCode()))
      .thenReturn(this.businessPartnerData);

    product.setOff2OnChannelActive(true);
    product.setB2cActivated(false);
    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    product.setProductType(1);
    product.setShippingWeight(10.0);
    product.setLength(10.0);
    product.setHeight(10.0);
    product.setWidth(10.0);
    product.setWeight(10.0);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, true, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }
  @Test
  public void updateEditWithProduuctTypeUpdate1RegularProductTestForInstoreProductWithSwitchOff() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean,"instoreNewFlowEnabled", false);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().setProductAttributes(new ArrayList<>());
    productData.getProduct().setProductType(ProductType.BIG_PRODUCT);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND_NAME);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(true);
    productL3Response.setDescriptiveAttributes(new ArrayList<>());
    productL3Response.setProductSpecialAttributes(new ArrayList<>());
    productL3Response.setDefiningAttributes(new ArrayList<>());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(true);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND_NAME);
    product.setAttributes(new ArrayList<>());
    Product existingProduct = generateProduct();
    existingProduct.setShippingWeight(10.0);
    existingProduct.setLength(10.0);
    existingProduct.setHeight(10.0);
    existingProduct.setWidth(10.0);
    existingProduct.setWeight(10.0);
    productL3Response.setProductType(ProductType.BIG_PRODUCT);
    productL3Response.setShippingWeight(10.0);
    productL3Response.setLength(10.0);
    productL3Response.setHeight(10.0);
    productL3Response.setWidth(10.0);
    productL3Response.setWeight(10.0);

    existingProduct.setProductAttributes(new ArrayList<>());
    productCollection.setProductId(DEFAULT_STORE_ID);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    productData.getProduct().getMasterDataProduct().setProductName("ABCD");
    productData.getProduct().getMasterDataProduct().setDescription("ABCD");
    productData.getProduct().getMasterDataProduct().setUniqueSellingPoint("ABCD");
    productData.getProduct().getMasterDataProduct().getMasterDataProductAttributes().forEach(
      masterDataProductAttributeDTO -> masterDataProductAttributeDTO.getMasterDataAttribute().setSkuValue(false));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    Mockito.when(getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(product.getBusinessPartnerCode()))
      .thenReturn(this.businessPartnerData);

    product.setOff2OnChannelActive(true);
    product.setB2cActivated(false);
    product.setProductName("ABCD");
    product.setDescription("ABCD");
    product.setUniqueSellingPoint("ABCD");
    product.setProductType(1);
    product.setShippingWeight(10.0);
    product.setLength(10.0);
    product.setHeight(10.0);
    product.setWidth(10.0);
    product.setWeight(10.0);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, true, profileResponse,
      false, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(),
      Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    Assertions.assertEquals(PRE_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertFalse(updatedProduct.isProductReview());
  }
  @Test
  public void getTakeDownStatusNoUpdateTest() {
    boolean takeDownStatus = productLevel3ServiceBean
        .getTakeDownStatus(false, new HashMap<>(), new EditedResizeAndImagesUpdateStatusResponse(), productCollection);
    Assertions.assertFalse(takeDownStatus);
  }

  @Test
  public void getTakeDownStatusNewImageTest() {
    Map<String, Boolean> imageMap = new HashMap<>();
    imageMap.putIfAbsent(NEW, true);
    boolean takeDownStatus = productLevel3ServiceBean
        .getTakeDownStatus(false, imageMap, new EditedResizeAndImagesUpdateStatusResponse(), productCollection);
    Assertions.assertTrue(takeDownStatus);
  }

  @Test
  public void getTakeDownStatusImageUpdateTest() {
    Map<String, Boolean> imageMap = new HashMap<>();
    imageMap.putIfAbsent(UPDATE, true);
    boolean takeDownStatus = productLevel3ServiceBean
        .getTakeDownStatus(false, imageMap, new EditedResizeAndImagesUpdateStatusResponse(), productCollection);
    Assertions.assertFalse(takeDownStatus);
  }

  @Test
  public void getTakeDownStatusImageUpdate1Test() {
    Map<String, Boolean> imageMap = new HashMap<>();
    productCollection.setPostLive(false);
    imageMap.putIfAbsent(UPDATE, true);
    boolean takeDownStatus = productLevel3ServiceBean
        .getTakeDownStatus(false, imageMap, new EditedResizeAndImagesUpdateStatusResponse(), productCollection);
    Assertions.assertFalse(takeDownStatus);
  }

  @Test
  public void getTakeDownStatusImageUpdateEditedImagesTest() {
    Map<String, Boolean> imageMap = new HashMap<>();
    EditedResizeAndImagesUpdateStatusResponse updateStatusResponse = new EditedResizeAndImagesUpdateStatusResponse();
    updateStatusResponse.setEditedImages(Collections.singletonList(new ImageRequest()));
    productCollection.setPostLive(false);
    imageMap.putIfAbsent(UPDATE, true);
    boolean takeDownStatus = productLevel3ServiceBean
        .getTakeDownStatus(false, imageMap, updateStatusResponse, productCollection);
    Assertions.assertTrue(takeDownStatus);
  }

  @Test
  public void getTakeDownStatusNewImageFalseTest() {
    Map<String, Boolean> imageMap = new HashMap<>();
    imageMap.putIfAbsent(NEW, true);
    boolean takeDownStatus = productLevel3ServiceBean
        .getTakeDownStatus(true, imageMap, new EditedResizeAndImagesUpdateStatusResponse(), productCollection);
    Assertions.assertFalse(takeDownStatus);
  }

  @Test
  public void updatePickupPointCodes_ExceptionCatchTest() throws Exception {
    pickupPointUpdateRequest.setDifferentLocation(false);
    productSystemParameter1.setValue("false");
    updatePickupPointResponse.setErrors(new ArrayList<>());
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponseList.add(pickupPointResponse);
    when(inventoryOutbound.updatePickupPoint(
        any(MandatoryRequestParam.class),
        any(ListRequestDTO.class))).thenReturn(updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenThrow(Exception.class);
    Assertions.assertThrows(Exception.class, () -> {
      PickupPointUpdateResponse pickupPointUpdateResponse =
          productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    });
  }

  @Test
  public void getInProgressProductsByBusinessPartnerAndPickupPointCodeTest() {
    List<InProgressProductsByPickupPointCodeResponse> products = new ArrayList<>();
    InProgressProductsByPickupPointCodeResponse inProgressProductResponsePageResponseByPickuppoint =
        new InProgressProductsByPickupPointCodeResponse();
    inProgressProductResponsePageResponseByPickuppoint.setProductSku(DEFAULT_PRODUCT_SKU);
    inProgressProductResponsePageResponseByPickuppoint.setPickupPointCode(DEFAULT_PICKUP_POINT_CODE);
    inProgressProductResponsePageResponseByPickuppoint.setItemSku(DEFAULT_ITEM_SKU);
    products.add(inProgressProductResponsePageResponseByPickuppoint);
    Page<InProgressProductsByPickupPointCodeResponse> page = new PageImpl<>(products);
    Mockito.when(productBusinessPartnerRepository.findProductDataInProgress(DEFAULT_BUSINESS_PARTNER_CODE_3,
            DEFAULT_PICKUP_POINT_CODE, Arrays.asList(ProductLevel3SummaryCriteria.IN_PROGRESS.name(),
                ProductLevel3SummaryCriteria.NEED_CORRECTION.name(), Constants.ACTIVE), DEFAULT_PAGE_REQUEST))
        .thenReturn(page);
    Page<InProgressProductsByPickupPointCodeResponse> response =
        productLevel3ServiceBean.getInProgressProductsByBusinessPartnerAndPickupPointCode(DEFAULT_STORE_ID,
            DEFAULT_BUSINESS_PARTNER_CODE_3, DEFAULT_PICKUP_POINT_CODE, PAGE, SIZE);
    verify(productBusinessPartnerRepository).findProductDataInProgress(DEFAULT_BUSINESS_PARTNER_CODE_3,
        DEFAULT_PICKUP_POINT_CODE, Arrays.asList(ProductLevel3SummaryCriteria.IN_PROGRESS.name(),
            ProductLevel3SummaryCriteria.NEED_CORRECTION.name(), Constants.ACTIVE), DEFAULT_PAGE_REQUEST);
    Assertions.assertEquals(response.getContent().get(0).getPickupPointCode(), DEFAULT_PICKUP_POINT_CODE);
  }

  @Test
  public void getInProgressByBusinessPartnerAndPickupPointCodeBpCodeNullTest(){
    Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
      this.productLevel3ServiceBean.getInProgressProductsByBusinessPartnerAndPickupPointCode(STORE_ID,
          null,PICKUP_POINT_CODE,0,1);
    });
  }

  @Test
  public void getInProgressByBusinessPartnerAndPickupPointCodeNullTest() {
    Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
      this.productLevel3ServiceBean.getInProgressProductsByBusinessPartnerAndPickupPointCode(STORE_ID, MERCHANT_CODE, null,
          0, 1);
    });
  }

  @Test
  public void getPickupPointCodesFbbActivatedTest() throws Exception {
    ItemPickupPointCodeResponse itemPickupPointCodeResponse =
      new ItemPickupPointCodeResponse(DEFAULT_ITEM_SKU, DEFAULT_ITEM_NAME, PICKUP, PICKUP_POINT_NAME);
    CompanyDTO company = CompanyDTO.builder().merchantType(null).cncActivated(true).build();
    ProfileResponse profileResponse = ProfileResponse.builder().company(company).multiDefaultAddressFlag(true).build();
    when(xProductOutbound.getItemPickupPointCodeResponse(DEFAULT_PRODUCT_SKU, 0, 1, true)).thenReturn(
      new PageImpl<>(Arrays.asList(itemPickupPointCodeResponse)));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(
      profileResponse);
    Page<PickupPointCodeResponse> response =
      productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, false, STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, true);
    verify(xProductOutbound).getItemPickupPointCodeResponse(DEFAULT_PRODUCT_SKU, 0, 1, true);
    Assertions.assertEquals(1, response.getContent().size());
    Assertions.assertEquals(DEFAULT_ITEM_SKU, response.getContent().get(0).getItemSku());
    Assertions.assertEquals(PICKUP_POINT_NAME, response.getContent().get(0).getPickupPointName());
  }

  @Test
  public void getPickupPointCodesNeedCorrectionProductFbbActivatedTest() throws Exception {
    Product product = generateProduct();
    CompanyDTO company = CompanyDTO.builder().merchantType(null).cncActivated(false).build();
    ProfileResponse profileResponse = ProfileResponse.builder().company(company).multiDefaultAddressFlag(false).build();
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setPickupPointId(PICKUP);
    productItemBusinessPartner.setFbbActive(true);
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner1.setFbbActive(true);
    productItemBusinessPartner1.setPickupPointId(PICKUP);
    productItemBusinessPartner1.setProductItemId(product.getProductItems().get(0).getId());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
      productBusinessPartner);
    when(
      this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
        any(), any(), any(Pageable.class))).thenReturn(
      new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    when(this.productItemBusinessPartnerRepository
        .findByStoreIdAndGdnProductItemSkuInAndFbbActiveTrueAndMarkForDeleteFalse(any(), anyList(), any(Pageable.class))).thenReturn(
            new PageImpl<>(Arrays.asList(productItemBusinessPartner1),PAGEABLE,0));
    when(productRepository.findOne(Mockito.any())).thenReturn(product);
    when(xProductOutbound.getPickupPointDetailResponse(Collections.singletonList(PICKUP), true)).thenReturn(
      Collections.singletonList(
        PickupPointDetailResponse.builder().pickupPointCode(PICKUP).pickupPointName(NAME).build()));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(
      profileResponse);
    Page<PickupPointCodeResponse> response =
      productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
        DEFAULT_BUSINESS_PARTNER_CODE, true);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(
      productItemBusinessPartnerRepository).findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
      any(), any(), any(Pageable.class));
    verify(productItemBusinessPartnerRepository)
        .findByStoreIdAndGdnProductItemSkuInAndFbbActiveTrueAndMarkForDeleteFalse(any(), anyList(), any(Pageable.class));
    verify(productRepository).findOne(Mockito.any());
    verify(xProductOutbound).getPickupPointDetailResponse(Collections.singletonList(PICKUP), true);
    Assertions.assertEquals(1, response.getContent().size());
    Assertions.assertEquals(ITEM_SKU, response.getContent().get(0).getItemSku());
    Assertions.assertEquals(NAME, response.getContent().get(0).getPickupPointName());
  }

  @Test
  public void getPickupPointCodesNeedCorrectionProductFbbActivatedFalseTest() throws Exception {
    Product product = generateProduct();
    CompanyDTO company = CompanyDTO.builder().merchantType(null).cncActivated(false).build();
    ProfileResponse profileResponse = ProfileResponse.builder().company(company).multiDefaultAddressFlag(false).build();
    productItemBusinessPartner.setProductItemId(product.getProductItems().get(0).getId());
    productItemBusinessPartner.setPickupPointId(PICKUP);
    productItemBusinessPartner.setFbbActive(true);
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU_3);
    productItemBusinessPartner1.setPickupPointId(PICKUP);
    productItemBusinessPartner1.setFbbActive(false);
    productItemBusinessPartner1.setProductItemId(product.getProductItems().get(0).getId());
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    when(
        this.productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
            any(), any(), any(Pageable.class))).thenReturn(
        new PageImpl<>(Arrays.asList(productItemBusinessPartner), PAGEABLE, 0));
    when(this.productItemBusinessPartnerRepository
        .findByStoreIdAndGdnProductItemSkuInAndFbbActiveTrueAndMarkForDeleteFalse(any(), anyList(), any(Pageable.class))).thenReturn(
        new PageImpl<>(Arrays.asList(productItemBusinessPartner1),PAGEABLE,0));
    when(productRepository.findOne(Mockito.any())).thenReturn(product);
    when(xProductOutbound.getPickupPointDetailResponse(anyList(), anyBoolean())).thenReturn(
        Collections.singletonList(
            PickupPointDetailResponse.builder().pickupPointCode(PICKUP).pickupPointName(NAME).build()));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(
        profileResponse);
        productLevel3ServiceBean.getPickupPointCodes(DEFAULT_PRODUCT_SKU, 0, 1, true, STORE_ID,
            DEFAULT_BUSINESS_PARTNER_CODE, true);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(
        productItemBusinessPartnerRepository).findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
        any(), any(), any(Pageable.class));
    verify(productItemBusinessPartnerRepository)
        .findByStoreIdAndGdnProductItemSkuInAndFbbActiveTrueAndMarkForDeleteFalse(any(), anyList(), any(Pageable.class));
    verify(productRepository).findOne(Mockito.any());
    verify(xProductOutbound).getPickupPointDetailResponse(anyList(), anyBoolean());
  }

  @Test
  public void createWithInventoryWithPartitonTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "inventoryPartitionSwitch", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "inventoryBatchSize", 1);
    this.businessPartnerData.setActivated(false);
    Mockito.when(
        getBusinessPartnerRepository().filterDetailByBusinessPartnerCode(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE)))
      .thenReturn(this.businessPartnerData);

    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList())).thenReturn(pickupPointResponseList);
    this.productLevel3ServiceBean.create(ProductLevel3ServiceBeanTest.DEFAULT_BUSINESS_PARTNER_CODE, productData,
      productBusinessPartner, true, new ArrayList<>());
    Mockito.verify(xProductOutbound)
      .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(ProductAndItemActivationRequest.class));
    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService, times(3)).insertInventory(Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(itemSkus, DEFAULT_BUSINESS_PARTNER_CODE,
      new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
      Mockito.any(ProductAndItemActivationRequest.class), Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService,
      Mockito.times(productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
      Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService, ProductLevel3ServiceBeanTest.CALLED_THREE_TIMES).create(
      Mockito.any(ProductLevel3Aggregator.class));
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STOREID, DEFAULT_PRODUCT_CODE);
    verify(this.productItemWholesalePriceService).findByStoreIdAndItemSkus(STOREID, Arrays.asList(ITEM_SKU));
    verify(this.productLevel3AggregatorService, times(3)).findByGdnSku(Mockito.any());
  }

  @Test
  public void updateProductLevel3InfoShippingTypeNotEligibleTest() throws Exception {
    ProductAndItemsResponse productAndItemsResponse = generateProductData();
    productAndItemsResponse.getProduct().setProductSku(DEFAULT_PRODUCT_SKU);
    Mockito.when(productLevel3Repository.findDetailByGdnSku(DEFAULT_ITEM_SKU)).thenReturn(productAndItemsResponse);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any(com.gdn.x.productcategorybase.dto.request.ProductRequest.class))).thenReturn(PRODUCT_CODE);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    Mockito.when(productService.checkBpBopisEligibility(anyInt(), any())).thenReturn(
      ApiErrorCode.BP_BOPIS_ELIGIBILITY_ERROR);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
      .thenReturn(getProfileResponse());
    Mockito.when(xProductOutbound.updateProduct(eq(false), Mockito.any(ProductRequest.class)))
      .thenReturn(savedProductData.getProduct());
    Mockito.when(xProductOutbound.updateItem(eq(false), eq(false), eq(false), Mockito.any(ItemRequest.class)))
      .thenReturn(savedProductData.getItems().get(0));
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setProductType(ProductType.REGULAR);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    productLevel3UpdateRequest.setSynchronize(false);
    updateProductLevel3InfoRequest.setProductType(2);
    productLevel3ServiceBean.updateProductLevel3Info(updateProductLevel3InfoRequest, DEFAULT_PRODUCT_SKU);
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.any());
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
  }

  @Test
  public void testHandleNonContentEditEvent_ReviewPending_PreReviewType() {
    ProductCollection productCollection = new ProductCollection();
    EditProductResponse editProductResponse = new EditProductResponse();
    ProductDetailEditDTO falseDTO = new ProductDetailEditDTO();
    List<ConfigurationStatusResponse> configurationStatusResponseList = new ArrayList<>();
    configurationStatusResponseList.add(ConfigurationStatusResponse.builder().reviewConfig("PRE_REVIEW_TYPE").build());

    productCollection.setReviewPending(true);
    productLevel3ServiceBean.handleNonContentEditEvent(productCollection, editProductResponse, falseDTO, configurationStatusResponseList);
    Assertions.assertTrue(productCollection.isEdited());
  }

  @Test
  public void testHandleNonContentEditEvent_ReviewPending_PostLive() {
    ProductCollection productCollection = new ProductCollection();
    productCollection.setReviewPending(true);
    EditProductResponse editProductResponse = new EditProductResponse();
    ProductDetailEditDTO productDetailEditDTO = new ProductDetailEditDTO();
    List<ConfigurationStatusResponse> configurationStatusResponseList = new ArrayList<>();
    configurationStatusResponseList.add(
      ConfigurationStatusResponse.builder().reviewConfig("POST_LIVE").build());
    productCollection.setReviewPending(true);
    productLevel3ServiceBean.handleNonContentEditEvent(productCollection, editProductResponse, productDetailEditDTO,
      configurationStatusResponseList);
    Assertions.assertEquals(true, productCollection.isEdited());
  }


  @Test
  public void brandChangeCheck() throws Exception {
    Assertions.assertThrows(ApiIncorrectInputDataException.class, () -> {
      productLevel3ServiceBean.brandChangeCheck(BRAND,REASON);
    });
  }

  @Test
  public void updatePickupPointCodes_WithDifferentLocationFalse_noItemSkusMppTrueCreateDeleteTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "deleteInsertInventoryOnPickupPointUpdate", true);
    ItemResponseV2 itemResponse = new ItemResponseV2();
    itemResponse.setItemSku(DEFAULT_ITEM_SKU);
    itemResponse.setPickUpPointCode(PICKUP_1);
    productSystemParameter1.setValue("true");
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(false);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(false);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(Arrays.asList(itemResponse));
    when(productLevel3InventoryService.updatePickupPointInInventory(anyString(), anyList())).thenReturn(
        updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(new Long(1));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    when(xProductOutbound.findItemBasicDetailsByProductSku(any())).thenReturn(Arrays.asList(
        itemBasicDetailV2Response));
    when(inventoryOutbound.updatePickupPoint(Mockito.any(), Mockito.any())).thenThrow(
        new ApplicationRuntimeException(ErrorCategory.VALIDATION,
            Constants.INVENTORY_NOT_FOUND_ERROR_MESSAGE));
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(xProductOutbound).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(productLevel3InventoryService).updatePickupPointInInventory(anyString(), anyList());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound).findItemBasicDetailsByProductSku(any());
    verify(xProductOutbound).getItemPickupPointsByItemSku(any());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
    verify(inventoryOutbound).updatePickupPoint(Mockito.any(), Mockito.any());

  }

  @Test
  public void updatePickupPointCodesNonCncAndNonCmAndWhiteListedSwitchOnTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "deleteInsertInventoryOnPickupPointUpdate", true);
    productSystemParameter1.setValue("true");
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(true);
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setPickUpPointCode(PICKUP_1);
    itemResponses.add(itemResponseV2);
    when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(itemResponses);
    when(productLevel3InventoryService.updatePickupPointInInventory(anyString(), anyList())).thenReturn(
        updatePickupPointResponse);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(Long.valueOf(1));
    when(inventoryOutbound.updatePickupPoint(Mockito.any(), Mockito.any())).thenThrow(
        new ApplicationRuntimeException(ErrorCategory.VALIDATION,
            Constants.INVENTORY_NOT_FOUND_ERROR_MESSAGE));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true)))
        .thenReturn(response);
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setItemName(ITEM_NAME);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(Mockito.any()))
        .thenReturn(Arrays.asList(itemResponseV2));
    PickupPointUpdateResponse pickupPointUpdateResponse =
        productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
    verify(productLevel3InventoryService).updatePickupPointInInventory(anyString(), anyList());
    verify(xProductOutbound).updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
    verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
    verify(xProductOutbound).getItemPickupPointsByItemSku(Mockito.any());
    verify(xProductOutbound).getItemNameByItemSkus(Mockito.any(), Mockito.anyBoolean());
    verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.anyString(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), eq(false), Mockito.anyString());
    verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID,Arrays.asList(PICKUP));
    verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
    verify(inventoryOutbound).updatePickupPoint(Mockito.any(), Mockito.any());
  }

  @Test
  public void updatePickupPointCodesNonCncAndNonCmAndWhiteListedSwitchOnDifferentErrorMessageTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "deleteInsertInventoryOnPickupPointUpdate", true);
    productSystemParameter1.setValue("true");
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(true);
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setPickUpPointCode(PICKUP_1);
    itemResponses.add(itemResponseV2);
    when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(itemResponses);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(Long.valueOf(1));
    when(inventoryOutbound.updatePickupPoint(Mockito.any(), Mockito.any())).thenThrow(
        new ApplicationRuntimeException(ErrorCategory.VALIDATION,
            Constants.BULK_ARCHIVE_LIMIT_ERROR_MESSAGE));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true)))
        .thenReturn(response);
    Mockito.doNothing().when(updatedProductHistoryService).createProductL3AuditLog(Mockito.anyString(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), eq(false), Mockito.anyString());
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setItemName(ITEM_NAME);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(Mockito.any()))
        .thenReturn(Arrays.asList(itemResponseV2));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        PickupPointUpdateResponse pickupPointUpdateResponse = productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
      });
    }
    finally {
      verify(xProductOutbound).updatePickupPointCodes(Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
      verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
      verify(xProductOutbound).getItemPickupPointsByItemSku(Mockito.any());
      verify(xProductOutbound).getItemNameByItemSkus(Mockito.any(), Mockito.anyBoolean());
      verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.anyString(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), eq(false), Mockito.anyString());
      verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP));
      verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
      verify(inventoryOutbound).updatePickupPoint(Mockito.any(), Mockito.any());
    }
  }

  @Test
  public void updatePickupPointCodesNonCncAndNonCmAndWhiteListedSwitchOffTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "deleteInsertInventoryOnPickupPointUpdate", false);
    productSystemParameter1.setValue("true");
    PickupPointRequest pickupPointRequest = new PickupPointRequest();
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    ProfileResponse profileResponse = getProfileResponse();
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    List<ItemResponseV2> itemResponses = new ArrayList<>();
    pickupPointRequest.setPickupPointCode(PICKUP);
    List<PickupPointResponse> pickupPointResponseList = new ArrayList<>();
    pickupPointResponse.setArchived(false);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    pickupPointResponseList.add(pickupPointResponse);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(any())).thenReturn(profileResponse);
    pickupPointUpdateRequest.setDifferentLocation(true);
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setPickUpPointCode(PICKUP_1);
    itemResponses.add(itemResponseV2);
    when(xProductOutbound.getItemPickupPointsByItemSku(any())).thenReturn(itemResponses);
    when(xProductOutbound.updatePickupPointCodes(
        Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class))).thenReturn(Long.valueOf(1));
    when(inventoryOutbound.updatePickupPoint(Mockito.any(), Mockito.any())).thenThrow(
        new ApplicationRuntimeException(ErrorCategory.VALIDATION,
            Constants.BULK_ARCHIVE_LIMIT_ERROR_MESSAGE));
    ProductL3Response savedProductData1 = generateProductL3Response();
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP)))
        .thenReturn(pickupPointResponseList);
    GdnRestSingleResponse<SimpleMapStringResponse> response =
        new GdnRestSingleResponse<>(null, null, true, new SimpleMapStringResponse(ImmutableMap.of(ITEM_SKU, ITEM_NAME)),
            REQUESTID);
    Mockito.when(xProductOutbound.getItemNameByItemSkus(Mockito.any(SimpleListStringRequest.class), Mockito.eq(true)))
        .thenReturn(response);
    Mockito.doNothing().when(updatedProductHistoryService).createProductL3AuditLog(Mockito.anyString(), Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), eq(false), Mockito.anyString());
    itemResponseV2.setItemSku(DEFAULT_ITEM_SKU);
    itemResponseV2.setItemName(ITEM_NAME);
    Mockito.when(xProductOutbound.getItemPickupPointsByItemSku(Mockito.any()))
        .thenReturn(Arrays.asList(itemResponseV2));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        PickupPointUpdateResponse pickupPointUpdateResponse = productLevel3ServiceBean.updatePickupPointCodes(pickupPointUpdateRequest);
      });
    }
    finally {
      verify(xProductOutbound).updatePickupPointCodes(Mockito.any(com.gdn.x.product.rest.web.model.request.PickupPointUpdateRequest.class));
      verify(xProductOutbound).getProductDetailsByProductSku(Mockito.any());
      verify(xProductOutbound).getItemPickupPointsByItemSku(Mockito.any());
      verify(xProductOutbound).getItemNameByItemSkus(Mockito.any(), Mockito.anyBoolean());
      verify(updatedProductHistoryService).createProductL3AuditLog(Mockito.anyString(), Mockito.any(), Mockito.any(),
          Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), eq(false), Mockito.anyString());
      verify(pickupPointOutbound).getByPickupPointCodes(REQUESTID, Arrays.asList(PICKUP));
      verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID, ITEM_SUMMARY_PAGE_SIZE);
      verify(inventoryOutbound).updatePickupPoint(Mockito.any(), Mockito.any());
    }
  }

  @Test
  public void generateHistoryForPriceAndWholesaleUpdateTest() throws Exception {
    Mockito.when(this.productLevel3Repository.findDetailByGdnSku(ITEM_SKU)).thenReturn(productAndItemsResponse);
    productLevel3ServiceBean.generateHistoryForPriceAndWholesaleUpdate(ITEM_SKU, false, null, null,
        productAndItemsResponse, 0);
    Mockito.verify(productLevel3Repository).findDetailByGdnSku(ITEM_SKU);
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.anyBoolean(), Mockito.any());
  }

  @Test
  public void testCheckContentUpdateForSpecialAttributes_AttributeValueChange() throws Exception {
    ProductLevel3 productL3Response = generateProductLevel3ForProductEditInfo();
    productL3Response.setVersion(null);
    List<ProductLevel3Attribute> productAttributes = createAttributesList();
    List<ProductLevel3Attribute> savedProductAttributes = createAttributesList();
    savedProductAttributes.get(0).setValues(Collections.emptyList());
    savedProductAttributes.get(0).setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    savedProductAttributes.get(0).setVariantCreation(false);
    productAttributes.get(0).setValues(Collections.emptyList());
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setAttributes(Collections.emptyList());
    product.setAttributes(productAttributes);
    productL3Response.setAttributes(savedProductAttributes);
    productL3Response.setAttributes(Collections.emptyList());
    boolean result =
      productLevel3ServiceBean.checkContentUpdateForSpecialAttributes(productL3Response,
      product);
    Assertions.assertTrue(result);
  }

  @Test
  public void testCheckContentUpdateForSpecialAttributes_AttributeValueChangeEmptyAttr() throws Exception {
    ProductLevel3 productL3Response = generateProductLevel3ForProductEditInfo();
    productL3Response.setVersion(null);
    List<ProductLevel3Attribute> productAttributes = createAttributesList();
    List<ProductLevel3Attribute> savedProductAttributes = createAttributesList();
    savedProductAttributes.get(0).setValues(Collections.emptyList());
    savedProductAttributes.get(0).setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    savedProductAttributes.get(0).setVariantCreation(false);
    productAttributes.get(0).setValues(Collections.emptyList());
    productAttributes.get(0).setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    productAttributes.get(0).setValues(Collections.singletonList("values"));
    product.setAttributes(productAttributes);
    productL3Response.setAttributes(savedProductAttributes);
    boolean result =
      productLevel3ServiceBean.checkContentUpdateForSpecialAttributes(productL3Response,
        product);
    Assertions.assertFalse(result);
  }

  @Test
  public void testCheckContentUpdateForSpecialAttributes_AttributeValueChangeEmpty() throws Exception {
    ProductLevel3 productL3Response = generateProductLevel3ForProductEditInfo();
    productL3Response.setVersion(null);
    List<ProductLevel3Attribute> productAttributes = createAttributesList();
    List<ProductLevel3Attribute> savedProductAttributes = createAttributesList();
    savedProductAttributes.get(0).setValues(Collections.singletonList("values"));
    savedProductAttributes.get(0).setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    savedProductAttributes.get(0).setVariantCreation(false);
    productAttributes.get(0).setValues(Collections.emptyList());
    productAttributes.get(0).setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    productAttributes.get(0).setValues(Collections.emptyList());
    product.setAttributes(productAttributes);
    productL3Response.setAttributes(savedProductAttributes);
    boolean result =
      productLevel3ServiceBean.checkContentUpdateForSpecialAttributes(productL3Response,
        product);
    Assertions.assertFalse(result);
  }

  @Test
  public void getInProgressProductsBySizeChartCodeTest() {
    Page<InProgressProductsBySizeChartCodeResponse> page =
        new PageImpl<>(Arrays.asList(new InProgressProductsBySizeChartCodeResponse()));
    Mockito.when(productBusinessPartnerRepository.findInProgressProductsWithSizeChartCode(STOREID,
        Arrays.asList(ProductLevel3SummaryCriteria.IN_PROGRESS.name(),
            ProductLevel3SummaryCriteria.NEED_CORRECTION.name()), SIZE_CHART_CODE,
        PageRequest.of(0, 10))).thenReturn(page);
    Page<InProgressProductsBySizeChartCodeResponse> inProgressProductsBySizeChartCode =
        productLevel3ServiceBean.getInProgressProductsBySizeChartCode(STOREID, SIZE_CHART_CODE,
            PAGE, SIZE);
    Mockito.verify(productBusinessPartnerRepository)
        .findInProgressProductsWithSizeChartCode(STOREID,
            Arrays.asList(ProductLevel3SummaryCriteria.IN_PROGRESS.name(),
                ProductLevel3SummaryCriteria.NEED_CORRECTION.name()), SIZE_CHART_CODE,
            PageRequest.of(0, 10));
  }


  private List<ProductLevel3Attribute> createAttributesList() {
    List<ProductLevel3Attribute> attributes = new ArrayList<>();
    ProductLevel3Attribute attribute = new ProductLevel3Attribute();
    attribute.setSkuValue(true);
    List<String> values = new ArrayList<>();
    values.add("value");
    attribute.setValues(values);
    attributes.add(attribute);
    return attributes;
  }

  @Test
  public void activateProductOnNeedCorrection_BopisRestrictedTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "mppForWhEnabled", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryValidationMerchantTypes", "CM");
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryRestrictionFeatureEnabled", true);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    productItemBusinessPartner.setProductType(1);
    productItemBusinessPartner.setSalePrice((double) 10);
    productItemBusinessPartner.setPrice((double) 10);
    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(DEFAULT_PICKUP_POINT_CODE);
    productItemBusinessPartner.setFbbActive(true);
    productItemBusinessPartner.setProductType(PRODUCT_TYPE_BOPIS);
    ProfileResponse businessPartner = new ProfileResponse();
    profileResponse.setMerchantStatus(ACTIVE);
    PickupPointDTO pickupPointDTO = new PickupPointDTO();
    pickupPointDTO.setCode(DEFAULT_PICKUP_POINT_CODE);
    pickupPointDTO.setOriginId(DEFAULT_ORIGIN_ID);
    businessPartner.setPickupPoints(Arrays.asList(pickupPointDTO));
    profileResponse.getCompany().setMerchantType("CM");
    CompanyDTO dto = new CompanyDTO();
    dto.setInternationalFlag(Boolean.TRUE);
    businessPartner.setCompany(dto);
    businessPartner.getCompany().setInternationalFlag(true);
    businessPartner.getCompany().setMerchantDeliveryType(PICKUP);
    businessPartner.getCompany().setInventoryFulfillment(INVENTORY_FULFILLMENT_BLIBLI);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    pickupPointResponseList.forEach(pp -> pp.setFbbActivated(true));
    when(productRepository.findProductDetailByProductCode(DEFAULT_PRODUCT_CODE)).thenReturn(productData);
    when(xProductOutbound.activateOnNeedCorrection(any())).thenReturn(
        new ActivateNeedRevisionResponse(true, new ArrayList<>()));
    when(productCollectionRepository.findProductByGdnSku(DEFAULT_PRODUCT_SKU)).thenReturn(productCollection);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList())).thenReturn(new ArrayList<>());
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList())).thenReturn(pickupPointResponseList);
    ProductCategoryResponse productCategoryResponse = new ProductCategoryResponse();
    categoryResponse.setActivated(true);
    categoryResponse.setBopisEligible(false);
    productCategoryResponse.setCategory(categoryResponse);
    CategoryResponse categoryResponse1 = new CategoryResponse();
    categoryResponse1.setActivated(false);
    ProductCategoryResponse productCategoryResponse1 = new ProductCategoryResponse();
    productCategoryResponse1.setCategory(categoryResponse1);
    productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
        profileResponse,Arrays.asList(productCategoryResponse,productCategoryResponse1));
    //    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(productCollectionRepository).findProductByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).activateOnNeedCorrection(needCorrectionArgumentCaptor.capture());
    verify(productRepository).findProductDetailByProductCode(DEFAULT_PRODUCT_CODE);
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
    Mockito.verify(xProductOutbound)
        .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(ITEM_SKU), DEFAULT_BUSINESS_PARTNER_CODE,
        new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
        Mockito.any(ProductAndItemActivationRequest.class), Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService,
        Mockito.times(productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
        Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService).create(Mockito.any(ProductLevel3Aggregator.class));
    verify(productItemWholesalePriceService, times(2)).findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList());
    verify(this.productLevel3AggregatorService).findByGdnSku(Mockito.any());
  }

  @Test
  public void activateProductOnNeedCorrection_BopisCategoryTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "mppForWhEnabled", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryValidationMerchantTypes", "CM");
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryRestrictionFeatureEnabled", true);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    productItemBusinessPartner.setProductType(1);
    productItemBusinessPartner.setSalePrice((double) 10);
    productItemBusinessPartner.setPrice((double) 10);
    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(DEFAULT_PICKUP_POINT_CODE);
    productItemBusinessPartner.setFbbActive(true);
    productItemBusinessPartner.setProductType(PRODUCT_TYPE_BOPIS);
    ProfileResponse businessPartner = new ProfileResponse();
    profileResponse.setMerchantStatus(ACTIVE);
    PickupPointDTO pickupPointDTO = new PickupPointDTO();
    pickupPointDTO.setCode(DEFAULT_PICKUP_POINT_CODE);
    pickupPointDTO.setOriginId(DEFAULT_ORIGIN_ID);
    businessPartner.setPickupPoints(Arrays.asList(pickupPointDTO));
    profileResponse.getCompany().setMerchantType("CM");
    CompanyDTO dto = new CompanyDTO();
    dto.setInternationalFlag(Boolean.TRUE);
    businessPartner.setCompany(dto);
    businessPartner.getCompany().setInternationalFlag(true);
    businessPartner.getCompany().setMerchantDeliveryType(PICKUP);
    businessPartner.getCompany().setInventoryFulfillment(INVENTORY_FULFILLMENT_BLIBLI);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    pickupPointResponseList.forEach(pp -> pp.setFbbActivated(true));
    when(productRepository.findProductDetailByProductCode(DEFAULT_PRODUCT_CODE)).thenReturn(productData);
    when(xProductOutbound.activateOnNeedCorrection(any())).thenReturn(
        new ActivateNeedRevisionResponse(true, new ArrayList<>()));
    when(productCollectionRepository.findProductByGdnSku(DEFAULT_PRODUCT_SKU)).thenReturn(productCollection);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList())).thenReturn(new ArrayList<>());
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList())).thenReturn(pickupPointResponseList);
    ProductCategoryResponse productCategoryResponse = new ProductCategoryResponse();
    categoryResponse.setActivated(true);
    categoryResponse.setBopisEligible(true);
    productCategoryResponse.setCategory(categoryResponse);
    productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
        profileResponse,Arrays.asList(productCategoryResponse));
    //    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(productCollectionRepository).findProductByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).activateOnNeedCorrection(needCorrectionArgumentCaptor.capture());
    verify(productRepository).findProductDetailByProductCode(DEFAULT_PRODUCT_CODE);
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
    Mockito.verify(xProductOutbound)
        .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(ITEM_SKU), DEFAULT_BUSINESS_PARTNER_CODE,
        new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
        Mockito.any(ProductAndItemActivationRequest.class), Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService,
        Mockito.times(productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
        Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService).create(Mockito.any(ProductLevel3Aggregator.class));
    verify(productItemWholesalePriceService, times(2)).findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList());
    verify(this.productLevel3AggregatorService).findByGdnSku(Mockito.any());
  }

  @Test
  public void activateProductOnNeedCorrection_BopisRestrictedB2bActivatedTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "mppForWhEnabled", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryValidationMerchantTypes", "CM");
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCategoryRestrictionFeatureEnabled", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "bopisCNCRestrictionEnabled", true);
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner(productData);
    productItemBusinessPartner.setProductType(1);
    productItemBusinessPartner.setSalePrice((double) 10);
    productItemBusinessPartner.setPrice((double) 10);
    productItemBusinessPartner.setStock(10);
    productItemBusinessPartner.setMinimumStock(10);
    productItemBusinessPartner.setPickupPointId(DEFAULT_PICKUP_POINT_CODE);
    productItemBusinessPartner.setFbbActive(true);
    productItemBusinessPartner.setProductType(PRODUCT_TYPE_BOPIS);
    productItemBusinessPartner.setB2bPrice(2.0);

    B2bFieldsVo b2bFieldsVo = new B2bFieldsVo();
    com.gdn.x.product.model.entity.ItemViewConfig itemViewConfig = new ItemViewConfig();
    itemViewConfig.setDiscoverable(false);
    b2bFieldsVo.setB2bItemViewConfigs(Collections.singleton(itemViewConfig));

    ProfileResponse businessPartner = new ProfileResponse();
    profileResponse.setMerchantStatus(ACTIVE);
    PickupPointDTO pickupPointDTO = new PickupPointDTO();
    pickupPointDTO.setCode(DEFAULT_PICKUP_POINT_CODE);
    pickupPointDTO.setOriginId(DEFAULT_ORIGIN_ID);
    businessPartner.setPickupPoints(Arrays.asList(pickupPointDTO));
    profileResponse.getCompany().setMerchantType("CM");
    CompanyDTO dto = new CompanyDTO();
    dto.setInternationalFlag(Boolean.TRUE);
    businessPartner.setCompany(dto);
    businessPartner.getCompany().setInternationalFlag(true);
    businessPartner.getCompany().setMerchantDeliveryType(PICKUP);
    businessPartner.getCompany().setInventoryFulfillment(INVENTORY_FULFILLMENT_BLIBLI);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner));
    productBusinessPartner.setB2bActivated(true);
    pickupPointResponseList.forEach(pp -> pp.setFbbActivated(true));
    when(productRepository.findProductDetailByProductCode(DEFAULT_PRODUCT_CODE)).thenReturn(productData);
    when(xProductOutbound.activateOnNeedCorrection(any())).thenReturn(
        new ActivateNeedRevisionResponse(true, new ArrayList<>()));
    when(productCollectionRepository.findProductByGdnSku(DEFAULT_PRODUCT_SKU)).thenReturn(productCollection);
    when(productBusinessPartnerRepository.findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(
        productBusinessPartner);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(profileResponse);
    when(productItemWholesalePriceService.findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList())).thenReturn(new ArrayList<>());
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(anyString(), anyList())).thenReturn(pickupPointResponseList);
    ProductCategoryResponse productCategoryResponse = new ProductCategoryResponse();
    categoryResponse.setActivated(true);
    categoryResponse.setBopisEligible(false);
    productCategoryResponse.setCategory(categoryResponse);
    CategoryResponse categoryResponse1 = new CategoryResponse();
    categoryResponse1.setActivated(false);
    ProductCategoryResponse productCategoryResponse1 = new ProductCategoryResponse();
    productCategoryResponse1.setCategory(categoryResponse1);
    productLevel3ServiceBean.activateProductOnNeedCorrection(STORE_ID, DEFAULT_PRODUCT_SKU,
        profileResponse,Arrays.asList(productCategoryResponse,productCategoryResponse1));
    //    verify(pickupPointOutbound).getByPickupPointCodes(anyString(), anyList());
    verify(productCollectionRepository).findProductByGdnSku(DEFAULT_PRODUCT_SKU);
    verify(productBusinessPartnerRepository).findFirstByGdnProductSku(DEFAULT_PRODUCT_SKU);
    verify(xProductOutbound).activateOnNeedCorrection(needCorrectionArgumentCaptor.capture());
    verify(productRepository).findProductDetailByProductCode(DEFAULT_PRODUCT_CODE);
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
    Mockito.verify(xProductOutbound)
        .addProductAndItems(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(ProductAndItemActivationRequest.class));
    verify(this.attributeRepository).findDetailById(Mockito.any());
    verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(
        Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE));
    verify(this.productLevel3InventoryService).insertInventory(Mockito.anyList());
    verify(productLevel3LogisticsService).saveLogisticsByItemSku(Arrays.asList(ITEM_SKU), DEFAULT_BUSINESS_PARTNER_CODE,
        new ArrayList<>(), true);
    verify(this.updatedProductHistoryService).saveCreateProductLevel3Audit(Mockito.eq(DEFAULT_BUSINESS_PARTNER_CODE),
        Mockito.any(ProductAndItemActivationRequest.class), Mockito.any(ProductBusinessPartner.class));
    verify(this.productInventoryService,
        Mockito.times(productBusinessPartner.getProductItemBusinessPartners().size())).isSyncedToLevel1Inventory(
        Mockito.any(ProfileResponse.class));
    verify(this.productLevel3AggregatorService).create(Mockito.any(ProductLevel3Aggregator.class));
    verify(productItemWholesalePriceService, times(2)).findByStoreIdAndItemSkus(Mockito.any(),
        Mockito.anyList());
    verify(this.productLevel3AggregatorService).findByGdnSku(Mockito.any());
  }

  @Test
  public void getProductWareHouseDataTest() {
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "false",
            "sapCallEnabled", false));
    productLevel3ServiceBean.getProductWareHouseData(ITEM_CODE, profileResponse);
    Mockito.verify(productSystemParameterService).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.SAP_CALL_ENABLED);
  }

  @Test
  public void getProductWareHouseDataNullProfileResponseTest() {
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.SAP_CALL_ENABLED)).thenReturn(
        new ProductSystemParameter(SystemParameterConstants.SAP_CALL_ENABLED, "true",
            "sapCallEnabled", false));
    productLevel3ServiceBean.getProductWareHouseData(ITEM_CODE, null);
    productLevel3ServiceBean.getProductWareHouseData(ITEM_CODE, new ProfileResponse());
    profileResponse.getCompany().setMerchantType("CM");
    productLevel3ServiceBean.getProductWareHouseData(ITEM_CODE, profileResponse);
    Mockito.verify(productSystemParameterService, times(3)).findByStoreIdAndVariable(DEFAULT_STORE_ID,
        SystemParameterConstants.SAP_CALL_ENABLED);
  }

  @Test
  public void updateEditInfo_withOmgSellerAndPreOrder() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "convertPreOrderDateToJKT", true);
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(true);
    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    ProductL3Response productL3Response = generateProductL3Response();
    productL3Response.getMasterDataProduct().setBrand(BRAND);
    productL3Response.setDefaultItemSku(DEFAULT_GDN_SKU);
    productL3Response.setVersion(2L);
    productL3Response.setSynchronized(false);
    ProductLevel3 product = generateProductLevel3ForProductEditInfo();
    product.setVersion(null);
    product.setUrl(StringUtils.EMPTY);
    product.setProductEditable(true);
    product.setSynchronize(false);
    product.setId(DEFAULT_STORE_ID);
    product.setBrand(BRAND);
    com.gdn.mta.product.entity.PreOrderDTO preOrderDTO1 = new com.gdn.mta.product.entity.PreOrderDTO();
    preOrderDTO1.setIsPreOrder(true);
    product.setPreOrder(preOrderDTO1);
    product.getAttributes().get(0).setValues(Collections.singletonList(DEFAULT_STORE_ID));
    ProfileResponse businessPartner = getProfileResponse();
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(DEFAULT_ATTRIBUTE_CODE);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE);
    ProductAttributeValue productAttributeValue = new ProductAttributeValue();
    productAttributeValue.setDescriptiveAttributeValue(DEFAULT_ATTRIBUTE_CODE_3);
    existingProduct.getProductAttributes().get(0)
        .setProductAttributeValues(Collections.singletonList(productAttributeValue));
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.any()))
        .thenReturn(businessPartner);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
        .thenReturn(new GdnRestSingleResponse<>(productL3Response, REQUESTID));
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
        new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);

    Mockito.when(this.productOutbound.getReviewConfiguration(Collections.singletonList(configurationStatusRequest)))
        .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
        .thenReturn(new ArrayList<>());
    Mockito.when(
        this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
            productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
        Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
        eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    doNothing().when(updatedProductHistoryService)
        .createProductL3AuditLog(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), eq(StringUtils.EMPTY));

    product.setSellerOmg(true);
    EditProductResponse updatedProduct = this.productLevel3ServiceBean.updateEditInfo(product, true, true, false, profileResponse,
        true, generateProductL3Response(), false, null, null);

    verify(xProductOutbound, Mockito.times(1)).getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU);
    verify(this.productOutbound).getReviewConfiguration(Collections.singletonList(configurationStatusRequest));
    verify(this.productLevel3Helper).getRestrictedKeywordsWithActionTypeInProductDetails(Mockito.any(), Mockito.any());
    verify(this.productRepository).findOne(Mockito.eq(DEFAULT_STORE_ID));
    verify(getProductLevel3Repository()).findDetailByGdnSku(Mockito.anyString());
    verify(this.productRepository).update(Mockito.any(), Mockito.any(), eq(false), Mockito.anyBoolean(), eq(true),
        Mockito.anyList(), Mockito.anyMap(),Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean(),
        eq(new ArrayList<>()), Mockito.any(), Mockito.any(EditProductResponse.class));
    verify(this.productService).publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID,
        EditedReviewTypeConstants.CONTENT_EDIT, productCollection, null);
    verify(this.productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    verify(this.updatedProductHistoryService).createProductL3AuditLog(Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any(),Mockito.any()
        ,Mockito.any(),Mockito.any(),Mockito.anyBoolean(),Mockito.any());
    verify(xProductOutbound).updateEditedProduct(Mockito.any(ProductEditRequest.class), Mockito.anyBoolean());
    when(updatedProductHistoryService.getMerchantModifiedFields(any(),
        any())).thenReturn(null);
    verify(updatedProductHistoryService).getMerchantModifiedFields(any(),
        any());
    verify(this.updatedProductHistoryService).saveUpdateProductLevel3Audit(Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(),
        Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.any());
    verify(inventoryOutbound).updatePoDateByL3(Mockito.any(MandatoryRequestParam.class), Mockito.any(UpdatePoDateByL3RequestDTO.class));
    Assertions.assertEquals(POST_REVIEW_TYPE, updatedProduct.getReviewType());
    Assertions.assertTrue(updatedProduct.isProductReview());
  }

  // Test cases for processSellerPenaltyChecks method
  @Test
  public void processSellerPenaltyChecks_shouldPass_whenNoPenaltyRestrictions() {
    // Given
    ProfileResponse profileResponse = ProfileResponse.builder().flags(new HashMap<>()).build();

    ProductVariantUpdateRequest request = ProductVariantUpdateRequest.builder().addPickupPoints(
      Arrays.asList(ItemPickupPointRequest.builder().stock(5).build(),
        ItemPickupPointRequest.builder().stock(0).build())).productItems(Arrays.asList(
      ProductVariantPriceStockAndImagesRequest.builder().modifiedItemPickupPoints(
        Arrays.asList(ItemPickupPointRequest.builder().stock(3).build(),
          ItemPickupPointRequest.builder().stock(-2).build())).build())).build();

    // When & Then - should not throw any exception
    Assertions.assertDoesNotThrow(
      () -> productLevel3ServiceBean.processSellerPenaltyChecks(request, profileResponse, true));
  }

  @Test
  public void processSellerPenaltyChecks_shouldThrowException_whenStockIncrementRestrictionViolated() {
    // Given
    Map<String, Object> flags = new HashMap<>();
    flags.put(Constants.PRODUCT_CONSEQUENCE_LIMITATION, true);
    ProfileResponse profileResponse = ProfileResponse.builder().flags(flags).build();

    ProductVariantUpdateRequest request = ProductVariantUpdateRequest.builder().addPickupPoints(
      Arrays.asList(ItemPickupPointRequest.builder().stock(10).build()// This should trigger penalty
      )).productItems(Arrays.asList(ProductVariantPriceStockAndImagesRequest.builder()
      .modifiedItemPickupPoints(Arrays.asList(ItemPickupPointRequest.builder().stock(5).build()
        // This should also trigger penalty
      )).build())).build();

    // When & Then
    ApplicationRuntimeException exception =
      Assertions.assertThrows(ApplicationRuntimeException.class,
        () -> productLevel3ServiceBean.processSellerPenaltyChecks(request, profileResponse, true));

    Assertions.assertEquals(ErrorCategory.VALIDATION, exception.getErrorCodes());
    Assertions.assertTrue(
      exception.getErrorMessage().contains(ApiErrorCode.SELLER_PENALTY_RESTRICTION.getDesc()));
  }

  @Test
  public void processSellerPenaltyChecks_shouldPass_whenFeatureDisabled() {
    // Given
    Map<String, Object> flags = new HashMap<>();
    flags.put(Constants.PRODUCT_CONSEQUENCE_LIMITATION, true);
    ProfileResponse profileResponse = ProfileResponse.builder().flags(flags).build();

    ProductVariantUpdateRequest request = ProductVariantUpdateRequest.builder()
      .addPickupPoints(Arrays.asList(ItemPickupPointRequest.builder().stock(10).build()))
      .productItems(Arrays.asList(ProductVariantPriceStockAndImagesRequest.builder()
        .modifiedItemPickupPoints(Arrays.asList(ItemPickupPointRequest.builder().stock(5).build()))
        .build())).build();

    // When & Then - should not throw exception when feature is disabled
    Assertions.assertDoesNotThrow(
      () -> productLevel3ServiceBean.processSellerPenaltyChecks(request, profileResponse, false));
  }

  @Test
  public void processSellerPenaltyChecks_shouldPass_whenEmptyPickupPointsLists() {
    // Given
    Map<String, Object> flags = new HashMap<>();
    flags.put(Constants.PRODUCT_CONSEQUENCE_LIMITATION, true);
    ProfileResponse profileResponse = ProfileResponse.builder().flags(flags).build();

    ProductVariantUpdateRequest request =
      ProductVariantUpdateRequest.builder().addPickupPoints(new ArrayList<>()).productItems(
        Arrays.asList(ProductVariantPriceStockAndImagesRequest.builder()
          .modifiedItemPickupPoints(new ArrayList<>()).build())).build();

    // When & Then - should not throw exception with empty lists
    Assertions.assertDoesNotThrow(
      () -> productLevel3ServiceBean.processSellerPenaltyChecks(request, profileResponse, true));
  }

  @Test
  public void processSellerPenaltyChecks_shouldPass_whenNullPickupPoints() {
    // Given
    Map<String, Object> flags = new HashMap<>();
    flags.put(Constants.PRODUCT_CONSEQUENCE_LIMITATION, true);
    ProfileResponse profileResponse = ProfileResponse.builder().flags(flags).build();

    ProductVariantUpdateRequest request =
      ProductVariantUpdateRequest.builder().addPickupPoints(null).productItems(Arrays.asList(
          ProductVariantPriceStockAndImagesRequest.builder().modifiedItemPickupPoints(null).build()))
        .build();

    // When & Then - should not throw exception with null lists (handled gracefully)
    Assertions.assertDoesNotThrow(
      () -> productLevel3ServiceBean.processSellerPenaltyChecks(request, profileResponse, true));
  }

  @Test
  public void processSellerPenaltyChecks_shouldPass_whenNoProductItems() {
    // Given
    Map<String, Object> flags = new HashMap<>();
    flags.put(Constants.PRODUCT_CONSEQUENCE_LIMITATION, true);
    ProfileResponse profileResponse = ProfileResponse.builder().flags(flags).build();

    ProductVariantUpdateRequest request = ProductVariantUpdateRequest.builder()
      .addPickupPoints(Arrays.asList(ItemPickupPointRequest.builder().stock(10).build()))
      .productItems(new ArrayList<>()).build();

    // When & Then - should throw exception for addPickupPoints but not for empty productItems
    ApplicationRuntimeException exception =
      Assertions.assertThrows(ApplicationRuntimeException.class,
        () -> productLevel3ServiceBean.processSellerPenaltyChecks(request, profileResponse, true));

    Assertions.assertEquals(ErrorCategory.VALIDATION, exception.getErrorCodes());
    Assertions.assertTrue(
      exception.getErrorMessage().contains(ApiErrorCode.SELLER_PENALTY_RESTRICTION.getDesc()));
  }

  @Test
  public void processSellerPenaltyChecks_shouldPass_whenMixedStockValues() {
    // Given
    Map<String, Object> flags = new HashMap<>();
    flags.put(Constants.PRODUCT_CONSEQUENCE_LIMITATION, true);
    ProfileResponse profileResponse = ProfileResponse.builder().flags(flags).build();

    ProductVariantUpdateRequest request = ProductVariantUpdateRequest.builder().addPickupPoints(
      Arrays.asList(ItemPickupPointRequest.builder().stock(0).build(),    // Should pass
        ItemPickupPointRequest.builder().stock(-5).build(),   // Should pass
        ItemPickupPointRequest.builder().stock(3).build()     // Should fail
      )).productItems(Arrays.asList(ProductVariantPriceStockAndImagesRequest.builder()
      .modifiedItemPickupPoints(
        Arrays.asList(ItemPickupPointRequest.builder().stock(0).build(),    // Should pass
          ItemPickupPointRequest.builder().stock(-2).build()    // Should pass
        )).build())).build();

    // When & Then - should throw exception on first positive stock increment
    ApplicationRuntimeException exception =
      Assertions.assertThrows(ApplicationRuntimeException.class,
        () -> productLevel3ServiceBean.processSellerPenaltyChecks(request, profileResponse, true));

    Assertions.assertEquals(ErrorCategory.VALIDATION, exception.getErrorCodes());
    Assertions.assertTrue(
      exception.getErrorMessage().contains(ApiErrorCode.SELLER_PENALTY_RESTRICTION.getDesc()));
  }

  @Test
  public void processSellerPenaltyChecks_shouldPass_whenProfileResponseHasNoFlags() {
    // Given
    ProfileResponse profileResponse = ProfileResponse.builder().flags(null).build();

    ProductVariantUpdateRequest request = ProductVariantUpdateRequest.builder()
      .addPickupPoints(Arrays.asList(ItemPickupPointRequest.builder().stock(10).build()))
      .productItems(Arrays.asList(ProductVariantPriceStockAndImagesRequest.builder()
        .modifiedItemPickupPoints(Arrays.asList(ItemPickupPointRequest.builder().stock(5).build()))
        .build())).build();

    // When & Then - should not throw exception when flags are null
    Assertions.assertDoesNotThrow(
      () -> productLevel3ServiceBean.processSellerPenaltyChecks(request, profileResponse, true));
  }

  @Test
  public void processSellerPenaltyChecks_shouldPass_whenFlagIsFalse() {
    // Given
    Map<String, Object> flags = new HashMap<>();
    flags.put(Constants.PRODUCT_CONSEQUENCE_LIMITATION, false);
    ProfileResponse profileResponse = ProfileResponse.builder().flags(flags).build();

    ProductVariantUpdateRequest request = ProductVariantUpdateRequest.builder()
      .addPickupPoints(Arrays.asList(ItemPickupPointRequest.builder().stock(10).build()))
      .productItems(Arrays.asList(ProductVariantPriceStockAndImagesRequest.builder()
        .modifiedItemPickupPoints(Arrays.asList(ItemPickupPointRequest.builder().stock(5).build()))
        .build())).build();

    // When & Then - should not throw exception when flag is false
    Assertions.assertDoesNotThrow(
      () -> productLevel3ServiceBean.processSellerPenaltyChecks(request, profileResponse, true));
  }

  @Test
  public void updateReturnPenaltyEnabledTest() throws Exception {
    ReflectionTestUtils.setField(productLevel3ServiceBean, "removeDuplicateSyncCallSwitch", false);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "addFbbPickupPointCodesForLogisticsUpdateCheck", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "fbbPickupPointCodesLogisticsUpdateValidationChange", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "syncProductDataOnLogisticUpdate", true);
    ReflectionTestUtils.setField(productLevel3ServiceBean, "sellerPenaltyEnabledPhase2", true);
    Map<String, Object> flags = new HashMap<>();
    flags.put(Constants.PRODUCT_CONSEQUENCE_LIMITATION, true);
    profileResponse.setFlags(flags);
    ProductAndItemsResponse savedProductData = generateProductData();
    savedProductData.getProduct().getMasterDataProduct().setUniqueSellingPoint(null);
    savedProductData.getProduct().getMasterDataProduct().setProductName(null);
    ProductLevel3 product = generateProductLevel3();
    product.getItems().get(0).setItemSku(DEFAULT_GDN_SKU);
    product.getAttributes().get(0).setAttributeType(MasterDataAttributeType.PREDEFINED_ATTRIBUTE.name());
    product.getAttributes().get(0).setMandatory(true);
    product.getAttributes().get(0).setValues(Collections.singletonList(""));
    product.setAccessChannel(UpdateProductAccessChannel.MTA_WEB_UPDATE_DETAIL.getDesc());
    ProfileResponse businessPartner = getProfileResponse();
    ProductLevel3Logistics productLevel3Logistics = new ProductLevel3Logistics();
    productLevel3Logistics.setLogisticProductCode("GOJEK");
    productLevel3Logistics.setSelected(true);
    product.getItems().get(0).setLogistics(Arrays.asList(productLevel3Logistics));
    savedProductData.getItems().get(0).getMasterDataItem().setItemLength(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWidth(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemHeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemWeight(1.0);
    savedProductData.getItems().get(0).getMasterDataItem().setItemDeliveryWeight(1.0);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.any())).thenReturn(savedProductData);
    ProductL3Response savedProductData1 = generateProductL3Response();
    savedProductData1.setSynchronized(true);
    savedProductData1.setLength(1.0);
    savedProductData1.setWidth(1.0);
    savedProductData1.setHeight(10.0);
    savedProductData1.setWeight(1.0);
    savedProductData1.setShippingWeight(1.0);
    savedProductData1.setProductType(ProductType.BIG_PRODUCT);
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU))
      .thenReturn(new GdnRestSingleResponse<>(savedProductData1, REQUESTID));

    ProductAndItemsResponse productData = generateProductData();
    productData.getProduct().getMasterDataProduct().setUrl(STOREID);
    Product existingProduct = generateProduct();
    ProductAttribute productAttribute = new ProductAttribute();
    productAttribute.setAttributeId(DEFAULT_ATTRIBUTE_ID);
    productAttribute.setProductId(ProductAttribute.COLUMN_PRODUCT_ID);
    productAttribute.setProductAttributeName(BRAND_NAME);
    productAttribute.setOwnByProductItem(true);
    Attribute attribute1 = new Attribute();
    attribute1.setAttributeType(AttributeType.PREDEFINED_ATTRIBUTE);
    attribute1.setAttributeCode(DEFAULT_ATTRIBUTE_CODE);
    attribute1.setName(DEFAULT_ATTRIBUTE_NAME);
    productAttribute.setAttribute(attribute1);
    existingProduct.setProductAttributes(Collections.singletonList(productAttribute));
    existingProduct.getProductAttributes().get(0).getAttribute().setAttributeCode(Attribute.COLUMN_ATTRIBUTE_CODE);
    productCollection.setProductId(DEFAULT_STORE_ID);
    productCollection.setReviewType(EditedReviewTypeConstants.CONTENT_EDIT);
    when(xProductOutbound.getProductAndItemsWithProductData(true, DEFAULT_PRODUCT_SKU, true, false)).thenReturn(
      new GdnRestSingleResponse<>(productAndItemsResponse1, REQUESTID));
    when(productRepository.findOne(Mockito.any())).thenReturn(existingProduct);
    Mockito.when(getProductLevel3Repository().findDetailByGdnSku(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productOutbound.getReviewConfiguration(Mockito.anyList()))
      .thenReturn(configurationStatusResponseList);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(this.productLevel3Helper.getRestrictedKeywordsInProductDetails(Mockito.any(), Mockito.any()))
      .thenReturn(new ArrayList<>());
    when(productOutbound.getAttributeDetailByAttributeCode(DEFAULT_ATTRIBUTE_CODE)).thenReturn(attribute);
    when(productOutbound.getPredefinedAllowedAttributeValueByAttributeCodeAndValue(Mockito.any(),
      Mockito.any(), Mockito.anyBoolean())).thenReturn(predefinedAllowedAttributeValueResponse);
    Mockito.when(
      this.productService.publishAddEditedProductToPDTEvent(DEFAULT_STORE_ID, EditedReviewTypeConstants.CONTENT_EDIT,
        productCollection, null)).thenReturn(addEditedProductToPDTEvent);
    Mockito.when(this.productOutbound.migrateProduct(Mockito.any(), Mockito.any(), Mockito.any(),
      Mockito.any())).thenReturn(DEFAULT_PRODUCT_CODE);
    Mockito.when(this.updateProductItemLevel3ModelConverter.convertFromProductLevel3(Mockito.any(ProductLevel3.class),
      eq(false))).thenReturn(new UpdateProductItemLevel3Model());
    when(productSystemParameterService.findByStoreIdAndVariable(DEFAULT_STORE_ID, CHECK_PRODUCT_FOR_REVIEW)).thenReturn(
      new ProductSystemParameter(CHECK_PRODUCT_FOR_REVIEW, "true", "product-review", false));
    product.setPreOrder(new com.gdn.mta.product.entity.PreOrderDTO());
    ProductEditValidationDTO productEditValidationDTO = new ProductEditValidationDTO();
    productEditValidationDTO.setProductL3Response(savedProductData1);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString())).thenReturn(profileResponse);
    Mockito.when(productLevel3V2Service.validationForProductL3ResponseAndNeedRevisionUpdate(Mockito.any(ProductLevel3.class),Mockito.any(
      EditProductResponse.class),Mockito.any(),Mockito.anyBoolean(), any(), Mockito.anyList(), Mockito.any(), Mockito.anyBoolean(), Mockito.eq(false))).thenReturn(
      productEditValidationDTO);
    this.productLevel3ServiceBean.update(product, 5, 2, false, false, false);

    verify(this.businessPartnerRepository, times(2)).filterDetailByBusinessPartnerCode(Mockito.anyString());
    verify(getCategoryRepository(), times(1)).findHierarchyByCategoryCode(Mockito.any());
    verify(xProductOutbound, times(1)).getProductDetailsByProductSku(Mockito.any());
  }

  @Test
  public void testGetOldValueForPreOrderHistory_WhenPreOrderDTOIsNull() {
    ProductL3Response savedProductData = new ProductL3Response();
    savedProductData.setPreOrderDTO(null);
    String oldValue = "originalValue";
    String result = productLevel3ServiceBean.getOldValueForPreOrderHistory(savedProductData, oldValue);
    Assertions.assertEquals(oldValue, result);
  }

  @Test
  public void testGetOldValueForPreOrderHistory_WhenPreOrderDTOIsNotNull() {
    ProductL3Response savedProductData = new ProductL3Response();
    PreOrderDTO preOrderDTO = new PreOrderDTO();
    preOrderDTO.setIsPreOrder(true);
    preOrderDTO.setPreOrderType("DATE");
    preOrderDTO.setPreOrderValue(5);
    preOrderDTO.setPreOrderDate(new Date());
    savedProductData.setPreOrderDTO(preOrderDTO);
    String oldValue = null;
    String result = productLevel3ServiceBean.getOldValueForPreOrderHistory(savedProductData, oldValue);
    String preOrderString = String.valueOf(preOrderDTO);
    if (preOrderString.contains(Constants.CONVERT_TO_JKT_VARIABLE_FOR_HISTORY)) {
      String expectedSubstring =
          preOrderString.substring(11, preOrderString.indexOf(Constants.CONVERT_TO_JKT_VARIABLE_FOR_HISTORY));
      String expectedResult = expectedSubstring + Constants.CLOSE_PARENTHESIS;
      Assertions.assertEquals(expectedResult, result);
    } else {
      Assertions.assertNotNull(result);
    }
  }

  @Test
  public void testGetOldValueForPreOrderHistory_WhenPreOrderDTOHasConvertToJKT() {
    ProductL3Response savedProductData = new ProductL3Response();
    PreOrderDTO preOrderDTO = Mockito.mock(PreOrderDTO.class);
    String mockToString =
        "PreOrderDTO(isPreOrder=true, preOrderType=DATE, preOrderValue=5, preOrderDate=2024-01-01, convertToJKT=true)";
    Mockito.when(preOrderDTO.toString()).thenReturn(mockToString);
    savedProductData.setPreOrderDTO(preOrderDTO);
    String oldValue = null;
    String result = productLevel3ServiceBean.getOldValueForPreOrderHistory(savedProductData, oldValue);
    String expectedSubstring =
        mockToString.substring(11, mockToString.indexOf(Constants.CONVERT_TO_JKT_VARIABLE_FOR_HISTORY));
    String expectedResult = expectedSubstring + Constants.CLOSE_PARENTHESIS;
    Assertions.assertEquals(expectedResult, result);
  }

  @Test
  public void testGetOldValueForPreOrderHistory_WhenPreOrderDTOHasAllFields() {
    ProductL3Response savedProductData = new ProductL3Response();
    PreOrderDTO preOrderDTO = Mockito.mock(PreOrderDTO.class);
    String mockToString =
        "PreOrderDTO(isPreOrder=true, preOrderType=QUANTITY, preOrderValue=10, preOrderDate=Mon Jan 01 10:00:00 WIB 2024, convertToJKT=false)";
    Mockito.when(preOrderDTO.toString()).thenReturn(mockToString);
    savedProductData.setPreOrderDTO(preOrderDTO);
    String oldValue = "initialOldValue";
    String result = productLevel3ServiceBean.getOldValueForPreOrderHistory(savedProductData, oldValue);
    String expectedSubstring =
        mockToString.substring(11, mockToString.indexOf(Constants.CONVERT_TO_JKT_VARIABLE_FOR_HISTORY));
    String expectedResult = expectedSubstring + Constants.CLOSE_PARENTHESIS;
    Assertions.assertEquals(expectedResult, result);
    Assertions.assertNotEquals(oldValue, result);
  }

  @Test
  public void testGetOldValueForPreOrderHistory_WhenPreOrderDTOHasNullFields() {
    ProductL3Response savedProductData = new ProductL3Response();
    PreOrderDTO preOrderDTO = Mockito.mock(PreOrderDTO.class);
    String mockToString =
        "PreOrderDTO(isPreOrder=false, preOrderType=null, preOrderValue=null, preOrderDate=null, convertToJKT=true)";
    Mockito.when(preOrderDTO.toString()).thenReturn(mockToString);
    savedProductData.setPreOrderDTO(preOrderDTO);
    String oldValue = null;
    String result = productLevel3ServiceBean.getOldValueForPreOrderHistory(savedProductData, oldValue);
    String expectedSubstring =
        mockToString.substring(11, mockToString.indexOf(Constants.CONVERT_TO_JKT_VARIABLE_FOR_HISTORY));
    String expectedResult = expectedSubstring + Constants.CLOSE_PARENTHESIS;
    Assertions.assertEquals(expectedResult, result);
  }
}
