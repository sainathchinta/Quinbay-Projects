package com.gdn.mta.product.service;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyBoolean;
import static org.mockito.ArgumentMatchers.anyDouble;
import static org.mockito.ArgumentMatchers.anyList;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.doReturn;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.verifyNoInteractions;
import static org.mockito.Mockito.verifyNoMoreInteractions;
import static org.mockito.Mockito.when;

import java.io.IOException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.EnumSet;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;

import com.gda.mta.product.dto.DimensionAndUomRequest;
import com.gda.mta.product.dto.DistributionItemRequest;
import com.gda.mta.product.dto.MasterProductEditDTO;
import com.gda.mta.product.dto.MessageEmailRequest;
import com.gda.mta.product.dto.ProductBrandUpdateRequest;
import com.gda.mta.product.dto.ProductLevel3SummaryDetailsImageRequest;
import com.gda.mta.product.dto.ProductMasterDataEditRequest;
import com.gdn.mta.product.entity.VideoAddEditRequest;
import com.gdn.mta.product.enums.L3InfoUpdateChangeType;
import com.gdn.mta.product.service.config.PreOrderConfig;
import com.gdn.mta.product.service.exception.ApiGenericException;
import com.gdn.x.productcategorybase.dto.ConfigurationStatusResponse;
import jakarta.persistence.PersistenceException;

import com.gda.mta.product.dto.NeedRevisionProductsRequest;
import com.gda.mta.product.dto.ProductAndL5MigrationRequest;

import com.gdn.mta.domain.event.modal.XProdAttributeMigrationEventModel;
import com.gdn.mta.product.enums.RestrictedKeywordActionType;
import org.apache.commons.collections.map.HashedMap;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.tuple.Pair;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.mockito.Captor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.MockitoAnnotations;
import org.mockito.verification.VerificationMode;

import com.gdn.mta.product.service.solr.SolrActiveProductCollectionService;
import com.gdn.mta.product.util.BeanUtils;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.test.util.ReflectionTestUtils;

import com.gdn.mta.product.service.config.KafkaPublisher;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.gda.mta.product.dto.AutoApprovalTypeRequest;
import com.gda.mta.product.dto.AutoApprovalsDetailDto;
import com.gda.mta.product.dto.AutoNeedRevisionAndForceReviewResponse;
import com.gda.mta.product.dto.DalamProductListRequest;
import com.gda.mta.product.dto.DimensionRefreshRequest;
import com.gda.mta.product.dto.EditProductResponse;
import com.gda.mta.product.dto.ImageQcProcessedResponse;
import com.gda.mta.product.dto.ItemPickupPointRequest;
import com.gda.mta.product.dto.PickupPointCreateRequest;
import com.gda.mta.product.dto.ProductBusinessPartnerResponse;
import com.gda.mta.product.dto.ProductCollectionElement;
import com.gda.mta.product.dto.ProductCollectionResponse;
import com.gda.mta.product.dto.ProductCreationRequest;
import com.gda.mta.product.dto.ProductDetailCompleteResponse;
import com.gda.mta.product.dto.ProductFilterRequest;
import com.gda.mta.product.dto.ProductItemCreationRequest;
import com.gda.mta.product.dto.ProductL3UpdateRequest;
import com.gda.mta.product.dto.ProductVariantUpdateRequest;
import com.gda.mta.product.dto.RestrictedKeywordsByField;
import com.gda.mta.product.dto.RestrictedKeywordsByFieldAndActionType;
import com.gda.mta.product.dto.ValidateDuplicateProductRequest;
import com.gda.mta.product.dto.ValidateDuplicateProductResponse;
import com.gda.mta.product.dto.generator.ProductWfStateResponse;
import com.gda.mta.product.dto.generator.StuckProductResponse;
import com.gda.mta.product.dto.response.AgpSimpleQueryResponse;
import com.gda.mta.product.dto.response.AuditTrailListRequest;
import com.gda.mta.product.dto.response.AutoApprovalRuleDetailsDto;
import com.gda.mta.product.dto.response.BrandPredictionResponse;
import com.gda.mta.product.dto.response.BrandRestrictedModelsResponse;
import com.gda.mta.product.dto.response.CategoryModelPredictionResponse;
import com.gda.mta.product.dto.response.HitsResponse;
import com.gda.mta.product.dto.response.ImageQcEnableAndSyncResponse;
import com.gda.mta.product.dto.response.ImageQcPredictionResponse;
import com.gda.mta.product.dto.response.ImageQcResponse;
import com.gda.mta.product.dto.response.InProgressProductResponse;
import com.gda.mta.product.dto.response.InProgressProductResponsePageResponse;
import com.gda.mta.product.dto.response.InternalProductHistoryEventModel;
import com.gda.mta.product.dto.response.ItemsPriceStockImagesUpdateResponse;
import com.gda.mta.product.dto.response.KeywordRecommendationsResponse;
import com.gda.mta.product.dto.response.KeywordRestrictionModelsResponse;
import com.gda.mta.product.dto.response.ProductCodeAndNameDetails;
import com.gda.mta.product.dto.response.ProductFilterResponse;
import com.gda.mta.product.dto.response.RestrictedKeywordsByFieldResponse;
import com.gda.mta.product.dto.response.RestrictionModelsResponse;
import com.gdn.common.enums.ErrorCategory;
import com.gdn.common.exception.ApplicationException;
import com.gdn.common.exception.ApplicationRuntimeException;
import com.gdn.common.web.wrapper.response.GdnBaseRestResponse;
import com.gdn.common.web.wrapper.response.GdnRestListResponse;
import com.gdn.common.web.wrapper.response.GdnRestSingleResponse;
import com.gdn.common.web.wrapper.response.PageMetaData;
import com.gdn.micro.graphics.domain.event.model.BulkImageProcessResponse;
import com.gdn.micro.graphics.domain.event.model.ImageResponse;
import com.gdn.micro.graphics.domain.event.model.ScaleImageResponse;
import com.gdn.mta.domain.event.config.ApproveImageMessageConstants;
import com.gdn.mta.domain.event.config.DomainEventName;
import com.gdn.mta.domain.event.modal.AddDeleteVariantRetryPublishEventModel;
import com.gdn.mta.domain.event.modal.AddEditedProductToPDTEvent;
import com.gdn.mta.domain.event.modal.AddProductToVendorCombinedEventModel;
import com.gdn.mta.domain.event.modal.ApproveProductResponse;
import com.gdn.mta.domain.event.modal.AutoNeedRevisionDomainEvent;
import com.gdn.mta.domain.event.modal.ImageQcProcessedResponseDomainEvent;
import com.gdn.mta.domain.event.modal.ImageQcRequestDomainEvent;
import com.gdn.mta.domain.event.modal.ImageQcResponseDomainEvent;
import com.gdn.mta.domain.event.modal.PDTDimensionRefreshEventModel;
import com.gdn.mta.domain.event.modal.ProductActionRetryEvent;
import com.gdn.mta.domain.event.modal.ProductStatusDomainEvent;
import com.gdn.mta.domain.event.modal.ProductWipDeleteResponse;
import com.gdn.mta.domain.event.modal.ScreeningProductApprovalEvent;
import com.gdn.mta.domain.event.modal.SolrProductCollectionUpdateEvent;
import com.gdn.mta.domain.event.modal.SolrReviewProductCollectionDeleteEvent;
import com.gdn.mta.domain.event.modal.StuckProductEventPublishDto;
import com.gdn.mta.domain.event.modal.UserFeedbackImageQcListResponse;
import com.gdn.mta.product.commons.constant.RestrictedKeywordFieldNames;
import com.gdn.mta.product.config.ApplicationProperties;
import com.gdn.mta.product.entity.AutoApprovalRules;
import com.gdn.mta.product.entity.ItemFlagDetails;
import com.gdn.mta.product.entity.ProductBusinessPartner;
import com.gdn.mta.product.entity.ProductBusinessPartnerAttribute;
import com.gdn.mta.product.entity.ProductCollection;
import com.gdn.mta.product.entity.ProductFieldHistory;
import com.gdn.mta.product.entity.ProductHistory;
import com.gdn.mta.product.entity.ProductImagePrediction;
import com.gdn.mta.product.entity.ProductImageQcProcessingResponse;
import com.gdn.mta.product.entity.ProductItemBusinessPartner;
import com.gdn.mta.product.entity.ProductLevel3;
import com.gdn.mta.product.entity.ProductMigration;
import com.gdn.mta.product.entity.ProductSystemParameter;
import com.gdn.mta.product.entity.ProductWorkflow;
import com.gdn.mta.product.entity.UpdatedProductHistory;
import com.gdn.mta.product.entity.WorkflowStates;
import com.gdn.mta.product.enums.AddDeleteVariantStatus;
import com.gdn.mta.product.enums.ApiErrorCode;
import com.gdn.mta.product.enums.AutoApprovalType;
import com.gdn.mta.product.enums.BrandApprovalStatus;
import com.gdn.mta.product.enums.ProductStatus;
import com.gdn.mta.product.enums.TimeFilterType;
import com.gdn.mta.product.repository.BusinessPartnerRepository;
import com.gdn.mta.product.repository.CategoryRepository;
import com.gdn.mta.product.repository.ProductBusinessPartnerRepository;
import com.gdn.mta.product.repository.ProductCollectionRepository;
import com.gdn.mta.product.repository.ProductDistributionTaskRepositoryBean;
import com.gdn.mta.product.repository.ProductHistoryRepository;
import com.gdn.mta.product.repository.ProductItemBusinessPartnerRepository;
import com.gdn.mta.product.repository.ProductItemRepository;
import com.gdn.mta.product.repository.ProductRepository;
import com.gdn.mta.product.repository.ProductWorkflowRepository;
import com.gdn.mta.product.repository.SequenceRepository;
import com.gdn.mta.product.repository.SolrActiveProductCollectionRepository;
import com.gdn.mta.product.service.config.KafkaTopicProperties;
import com.gdn.mta.product.service.domainevent.publisher.ProductStatusPublisherService;
import com.gdn.mta.product.service.generator.GeneratorService;
import com.gdn.mta.product.service.solr.SolrReviewProductCollectionService;
import com.gdn.mta.product.util.CommonUtils;
import com.gdn.mta.product.util.ConverterUtil;
import com.gdn.mta.product.util.GdnBaseLookup;
import com.gdn.mta.product.util.ProductChangeUtil;
import com.gdn.mta.product.util.ProductWorkflowLookup;
import com.gdn.mta.product.valueobject.SimpleMasterProductUpdateRequestDTO;
import com.gdn.mta.product.valueobject.SolrCategoryCodeDTO;
import com.gdn.mta.product.valueobject.SolrProductCodeDTO;
import com.gdn.mta.product.valueobject.SolrProductCollectionDTO;
import com.gdn.partners.pbp.commons.constants.Constants;
import com.gdn.partners.pbp.commons.constants.EditedReviewTypeConstants;
import com.gdn.partners.pbp.commons.constants.SaveHistoryConstants;
import com.gdn.partners.pbp.commons.constants.SystemParameterConstants;
import com.gdn.partners.pbp.entity.mailEvent.CategoryChangeMailEvent;
import com.gdn.partners.pbp.entity.workflow.product.ProductWorkflowStatus;
import com.gdn.partners.pbp.model.productlevel3.ProductCollectionCountRequest;
import com.gdn.partners.pbp.model.productlevel3.ProductCollectionCountResponse;
import com.gdn.partners.pbp.model.productlevel3.ProductLevel3Inventory;
import com.gdn.partners.pbp.outbound.AGPQuery.AGPQueryFeign;
import com.gdn.partners.pbp.outbound.pickuppoint.PickupPointOutbound;
import com.gdn.partners.pbp.outbound.product.ProductOutbound;
import com.gdn.partners.pbp.outbound.product.feign.PCBFeign;
import com.gdn.partners.pbp.outbound.productAnalytics.ProductAnalyticsOutbound;
import com.gdn.partners.pbp.outbound.xProduct.XProductOutbound;
import com.gdn.partners.pbp.service.notification.ProductNotificationService;
import com.gdn.partners.pbp.service.productlevel3.ProductLevel3AggregatorService;
import com.gdn.partners.pbp.service.productlevel3.ProductLevel3Helper;
import com.gdn.partners.pbp.service.productlevel3.ProductLevel3InventoryService;
import com.gdn.partners.pbp.workflow.WorkflowProcessCode;
import com.gdn.partners.pbp.workflow.product.ProductWfService;
import com.gdn.partners.product.analytics.web.model.SellerDetailResponse;
import com.gdn.pbp.property.MandatoryParameterHelper;
import com.gdn.x.businesspartner.dto.CompanyDTO;
import com.gdn.x.businesspartner.dto.PickupPointResponse;
import com.gdn.x.businesspartner.dto.ProfileResponse;
import com.gdn.x.businesspartner.dto.ResponsiblePersonDTO;
import com.gdn.x.businesspartner.entity.Company;
import com.gdn.x.businesspartner.entity.LegalityOfCompany;
import com.gdn.x.businesspartner.entity.Profile;
import com.gdn.x.businesspartner.entity.ResponsiblePerson;
import com.gdn.x.businesspartner.entity.Taxation;
import com.gdn.x.mta.distributiontask.domain.event.model.PDTProductDomainEventModel;
import com.gdn.x.mta.distributiontask.model.type.ReviewType;
import com.gdn.x.mta.distributiontask.model.type.WorkflowState;
import com.gdn.x.mta.distributiontask.request.ProductRetryStatusUpdate;
import com.gdn.x.mta.distributiontask.response.ProductImageQcFeedbackResponse;
import com.gdn.x.product.enums.ChannelName;
import com.gdn.x.product.enums.ProductType;
import com.gdn.x.product.rest.web.model.dto.ItemViewConfigDTO;
import com.gdn.x.product.rest.web.model.dto.MasterDataItemDTO;
import com.gdn.x.product.rest.web.model.dto.PriceDTO;
import com.gdn.x.product.rest.web.model.dto.ProductSpecialAttributeDTO;
import com.gdn.x.product.rest.web.model.request.ItemViewConfigAndItemSkuRequest;
import com.gdn.x.product.rest.web.model.request.ItemViewConfigRequest;
import com.gdn.x.product.rest.web.model.request.ProductSkuAndProductCodeRequest;
import com.gdn.x.product.rest.web.model.response.BasicProductResponse;
import com.gdn.x.product.rest.web.model.response.DuplicateProductDetailsResponse;
import com.gdn.x.product.rest.web.model.response.ItemResponse;
import com.gdn.x.product.rest.web.model.response.ItemSkuPickupPointCodeResponse;
import com.gdn.x.product.rest.web.model.response.MinMaxItemPriceResponse;
import com.gdn.x.product.rest.web.model.response.PrdProductResponse;
import com.gdn.x.product.rest.web.model.response.ProductAndItemsResponse;
import com.gdn.x.product.rest.web.model.response.ProductL3Response;
import com.gdn.x.productcategorybase.AttributeType;
import com.gdn.x.productcategorybase.CatalogType;
import com.gdn.x.productcategorybase.domain.event.model.ImageDomainEventModel;
import com.gdn.x.productcategorybase.dto.ActivateImageRequest;
import com.gdn.x.productcategorybase.dto.ActivateImageResponse;
import com.gdn.x.productcategorybase.dto.Image;
import com.gdn.x.productcategorybase.dto.ProductActivateImageRequest;
import com.gdn.x.productcategorybase.dto.brand.ProductBrandValidationRequest;
import com.gdn.x.productcategorybase.dto.request.ProductRequest;
import com.gdn.x.productcategorybase.dto.request.solr.AttributeReqModel;
import com.gdn.x.productcategorybase.dto.response.AttributeHistoryResponse;
import com.gdn.x.productcategorybase.dto.response.AttributeResponse;
import com.gdn.x.productcategorybase.dto.response.BasicSizeChartDetailMapResponse;
import com.gdn.x.productcategorybase.dto.response.BasicSizeChartDetailResponse;
import com.gdn.x.productcategorybase.dto.response.CategoryDetailResponse;
import com.gdn.x.productcategorybase.dto.response.CategoryHierarchyResponse;
import com.gdn.x.productcategorybase.dto.response.CategoryResponse;
import com.gdn.x.productcategorybase.dto.response.CategoryRestrictedKeywordResponse;
import com.gdn.x.productcategorybase.dto.response.ProductAndItemImageRequest;
import com.gdn.x.productcategorybase.dto.response.ProductAttributeResponse;
import com.gdn.x.productcategorybase.dto.response.ProductCategoryResponse;
import com.gdn.x.productcategorybase.dto.response.ProductCodeResponse;
import com.gda.mta.product.dto.response.ProductAndBrandResponse;
import com.gdn.x.productcategorybase.dto.response.ProductDetailResponse;
import com.gdn.x.productcategorybase.dto.response.ProductItemDetailResponse;
import com.gdn.x.productcategorybase.dto.response.ProductItemResponse;
import com.gdn.x.productcategorybase.dto.response.ProductPredictionCategoryMappingResponse;
import com.gdn.x.productcategorybase.dto.response.ProductResponse;
import com.gdn.x.productcategorybase.dto.response.RestrictedKeywordsMappedToCategoryResponse;
import com.gdn.x.productcategorybase.dto.response.SimpleMasterProductUpdateResponse;
import com.gdn.x.productcategorybase.dto.response.SingleObjectResponse;
import com.gdn.x.productcategorybase.entity.Catalog;
import com.gdn.x.productcategorybase.entity.Category;
import com.gdn.x.productcategorybase.entity.Product;
import com.gdn.x.productcategorybase.entity.ProductCategory;
import com.gdn.x.productcategorybase.entity.ProductItem;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSet;

@SuppressWarnings("deprecation")
public class ProductServiceBeanTest {

  private static final String DEFAULT_STORE_ID = "10001";
  private static final String DEFAULT_USERNAME = "com.gdn.mta.developer";
  private static final String SYSTEM_REVIEW = "system_review";

  private static final Integer DEFAULT_PAGE = 0;
  private static final Integer DEFAULT_SIZE = 10;
  private static final Pageable DEFAULT_PAGEABLE = PageRequest.of(0, 10);
  private static final SimpleDateFormat DEFAULT_DATE_FORMAT = new SimpleDateFormat("yyyy-MM-dd");
  private static final VerificationMode AT_LEAST_ONE = Mockito.times(1);
  private static final VerificationMode AT_LEAST_TWO = Mockito.times(2);
  private static final VerificationMode AT_LEAST_NONE = Mockito.times(0);
  private static final String DEFAULT_PRODUCT_ID = "product-1";
  private static final String DEFAULT_SKU_CODE = "MTA-0000001-00001";
  private static final String PRODUCT_NAME = "product-name";
  private static final String UPC_CODE = "upc-code";
  private static final String FINAL_CATEGORY_ID = "final-category-id";
  private static final String DEFAULT_PRODUCT_CODE = "MTA-0000001";
  private static final String DEFAULT_PRODUCT_CODE_2 = "MTA-0000002";
  private static final String DEFAULT_CATEGORY = "category code";
  private static final String DEFAULT_PRODUCT_NAME = "product-name";
  private static final String DEFAULT_BRAND = null;
  private static final String DEFAULT_HASH_CODE = null;
  private static final String DEFAULT_FILENAME = null;
  private static final String DEFAULT_BUSINESS_PARTNER_CODE = "BLT-00001";
  private static final String DEFAULT_BUSINESS_PARTNER_NAME = "Blibli Testing";
  private static final String DEFAULT_GDN_SKU = "BLIBLI";
  private static final String DEFAULT_PRODUCT_DESCRIPTION = "desc";
  private static final String UNIQUE_SELLING_POINT = "unique selling point";
  private static final String KEYWORD = "product1";
  private static final String RESTRICTED_KEYWORD_ID = "restrictedKeywordId";
  private static final String KEYWORD_ID = "product1-id";
  private static final String NAME_WITH_PHONE_NUMBER = "NAME +628.173-4567--890NAME";
  private static final String RESTRICTED_KEYWORD = "keyword";
  private static final String MESSAGE = "message";
  private static final String DEFAULT_NOTE = "note";
  private static final String ACTIVITY = "actity";
  private static final String ACTIVE = "ACTIVE";
  private static final String IN_PROGRESS = "IN_PROGRESS";
  public static final String BP_CODE = "bp code";
  public static final String BP_ID = "bp id";
  public static final String BP_NAME = "bp name";
  public static final String IMAGE_REFRESH = "IMAGE_REFRESH";
  public static final String ATTR_CODE = "ATTR_CODE1";
  public static final String ATTR_ID = "ATTR_ID";
  public static final String ATTR_NAME = "attrName";
  public static final String ATTR_VALUE = "attrValue";
  public static final String TOPIC = "kafkaTopic";
  private static long COUNT_VALUE = 123l;
  private final String DEFAULT_CATEGORY_CODE = "CA-1234";
  private final String DEFAULT_CATEGORY_ID = "1234";
  private final String REQUEST_ID = "1234-45678";
  private static final String PRODUCT_CODE = "MTA-0001";
  private static final String SELLER_CODE = "SELLER_CODE";
  private static final String PRODUCT_CODE1 = "MTA-0002";
  private static final Long TIMESTAMP = System.currentTimeMillis();
  private static final String PRODUCT_ID = "productId";
  private static final String PRODUCT_BUSINESS_PARTNER_ID = "productBusinessPartnerId";
  private static final String STATE = "IN_VENDOR";
  private static final Integer RETRY_COUNT = 5;
  private static final Integer TOTAL_STUCK_PRODUCTS = 10;
  private static final int BAR_CODE_LENGHT = 17;
  private static final String STORE_ID = "storeId";
  private static final String CHANNEL_ID = "channelId";
  private static final String CLIENT_ID = "clientId";
  private static final String SIZE_CHART_CODE = "sizeChartCode";
  private static final String ID = "id";
  private static final String ID1 = "id1";
  private static final String BRAND = "brand";
  private static final Double LENGTH = 1.0;
  private static final Double WIDTH = 1.0;
  private static final Double HEIGHT = 1.0;
  private static final Double WEIGHT = 1.0;
  private static final Double SHIPPING_WEIGHT = 0.11;
  private static final Integer DANGEROUS_GOODS_LEVEL = 1;
  private static final int RETRY_TIME_SPAN = 5;
  private static final String ASSIGNED_BY = "assignedBy";
  private static final String ASSIGNED_TO = "assignedTo";
  private static final String ASSIGNED_TO_PREFIX = "NA";
  private static final String NOTES = "notes";
  private static final String FIELD = "field";
  private static final String OLD_VALUE = "oldValue";
  private static final String NEW_VALUE = "newValue";
  private static final String DEFAULT_BRAND_CODE = "BR-1234";
  private static final String DEFAULT_BRAND_NAME = "brandName";
  private static final String DEFAULT_BRAND_APPROVAL_STATUS = "APPROVED";
  private static final String CATEGORY_CODE = "CAT-0000001";
  private static final String CATEGORY_NAME = "Kategori 1";
  private static final String OFFICIAL_SELLERS = "OFFICIAL_SELLERS";
  private static final String PRODUCT_ITEM_NAME = "productItemName";
  private static final String PRODUCT_ITEM_ID = "productItemId";
  private static final String IMAGE_PATH = "imagePath";
  private static final String URL_PATH = "urlPath";
  private static final String URL_PATH_2 = "urlPath2";
  private static final String PRODUCT_ITEM_ID_1 = "productItemId1";
  private static final String BUSINESS_PARTNER_ID = "business-partner-1";
  private static final String STATE_IN_PROGRESS = "IN_PROGRESS";
  private static final String STATE_DRAFT = "DRAFT";
  private static final String STATE_DELETED = "DELETED";
  private static final String REVIEWER_NOTES = "REVIEWER_NOTES";
  private static final String NOTES_POST_LIVE =
      "Diubah : [{field: 'field', oldValue: oldValue, newValue: newValue}]{field: 'Post-Live', oldValue: false, newValue: true}";
  private static final String FORCE_REVIEW_NOTES = "force review notes";
  private static final String IMAGE_LOCATION_PATH_1 = "path1";
  private static final String IMAGE_LOCATION_PATH_2 = "path2";
  private static final String IMAGE_LOCATION_PATH_3 = "path3";
  private static final String IMAGE_LOCATION_PATH_4 = "path4";
  private static final String IMAGE_HASH_CODE_1 = "hashCode1";
  private static final String IMAGE_HASH_CODE_2 = "hashCode2";
  private static final String IMAGE_HASH_CODE_3 = "hashCode3";
  private static final String IMAGE_HASH_CODE_4 = "hashCode4";
  private static final String ITEM_SKU = "itemSku";
  private static final String ITEM_SKU_1 = "itemSku1";
  private static final String PICKUP_POINT_CODE = "pickupPointCode";
  private static final String MERCHANT_SKU = "merchantSku";
  private static final String MERCHANT_SKU_1 = "merchantSku1";
  private static final long TOTAL_RECORDS = 1;
  private static final String DEFAULT_PRODUCT_SKU = "BP1-00001-00001";
  private static final ImmutableList<String> NOT_IN_PROGRESS_STATE =
      ImmutableList.of("NEED_CORRECTION", "DRAFT");
  private static final ImmutableList<String> IN_PROGRESS_STATE =
      ImmutableList.of("DRAFT", "IN_PROGRESS", "NEED_CORRECTION");
  private static final String DEFAULT_SORT_TYPE = "desc";
  private static final String PRODUCT_SKU = "PRODUCT_SKU";
  private static final String BUSINESS_PARTNER_CODE = "BUSINESS_PARTNER_CODE";
  private static final String IMAGE_SOURCE_DIRECTORY = "/filestore/mta/images/source";
  private static final String PREDICTION_NAME_1 = "watermark";
  private static final String PREDICTION_DISPLAY_NAME_1 = "water mark present";
  private static final String PREDICTION_NAME_2 = "nsfw";
  private static final String PREDICTION_DISPLAY_NAME_2 = "nsfw present";
  private static final String PREDICTION_NAME_3 = "blur";
  private static final String PREDICTION_DISPLAY_NAME_3 = "blur present";
  private static final String PREDICTION_NAME_4 = "text";
  private static final String PREDICTION_DISPLAY_NAME_4 = "text present";
  private static final String PREDICTION_TEXT_NAME = "google_restricted";
  private static final String PREDICTION_TEXT_DISPLAY_NAME = "google restricted";
  private static final String PREDICTION_TEXT_DISPLAY_NAME_1 = "google restricted en";
  private static final String SELLER_TYPE = "gold";
  private static final List<String> ACTIVE_PREDICTIONS =
      Arrays.asList("watermark_predictions", "blur_predictions", "text_predictions", "nsfw_predictions");
  private static final String IMAGE_PREDICTION_RESPONSE_1 =
      "{\"timestamp\":1595003740556,\"productCode\":\"MTA-0000001\","
        + "\"images\":[{\"locationPath\":\"/filestore/mta/images/source/MTA-0451837"
        + "/nike_test_image_qc_full01_uedfzhqd.jpeg\","
        + "\"hashCode\":\"2246ef20d75fd39de86a15adb39fc74b\","
        + "\"predictions\":[{\"predictionType\":\"watermark_predictions\","
        + "\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},"
        + "{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,"
        + "\"confidence\":78},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\","
        + "\"present\":false,\"confidence\":22},{\"predictionType\":\"nsfw_predictions\","
        + "\"displayName\":\"Pornography\",\"present\":false,\"confidence\":4}],\"edited\":false,"
        + "\"markForDelete\":false},{\"locationPath\":\"/filestore/mta/images/source/MTA-0451837"
        + "/nike_test_image_qc_full02_gqm86hzf.jpeg\","
        + "\"hashCode\":\"d8ed7c1e732a350f9af0ffe0a2e28bca\","
        + "\"predictions\":[{\"predictionType\":\"watermark_predictions\","
        + "\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},"
        + "{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,\"confidence\":96},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\",\"present\":false,\"confidence\":5},{\"predictionType\":\"nsfw_predictions\",\"displayName\":\"Pornography\",\"present\":false,\"confidence\":0}],\"edited\":false,\"markForDelete\":false}],\"success\":true,\"errorMessage\":\"\",\"restrictionModels\":[],\"brandModels\":[],\"keywordRestrictionModels\":[],\"categoryModels\":[]}";
  private static final String IMAGE_PREDICTION_RESPONSE_OLD_DATA =
      "{\"timestamp\":1595003740556,\"productCode\":\"MTA-0000001\",\"images\":[{\"locationPath\":\"/filestore/mta/images/source/MTA-0451837/nike_test_image_qc_full01_uedfzhqd.jpeg\",\"hashCode\":\"2246ef20d75fd39de86a15adb39fc74b\",\"predictions\":[{\"predictionType\":\"watermark_predictions\",\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,\"confidence\":78},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\",\"present\":false,\"confidence\":22},{\"predictionType\":\"nsfw_predictions\",\"displayName\":\"Pornography\",\"present\":false,\"confidence\":4}]},{\"locationPath\":\"/filestore/mta/images/source/MTA-0451837/nike_test_image_qc_full02_gqm86hzf.jpeg\",\"hashCode\":\"d8ed7c1e732a350f9af0ffe0a2e28bca\",\"predictions\":[{\"predictionType\":\"watermark_predictions\",\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,\"confidence\":96},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\",\"present\":false,\"confidence\":5},{\"predictionType\":\"nsfw_predictions\",\"displayName\":\"Pornography\",\"present\":false,\"confidence\":0}]}],\"success\":true,\"errorMessage\":\"\"}";
  private static final String IMAGE_PREDICTION_RESPONSE_2 =
      "{\"timestamp\":1595003740556,\"productCode\":\"MTA-0000001\",\"images\":[{\"locationPath\":\"/filestore/mta/images/source/MTA-0451837/nike_test_image_qc_full01_uedfzhqd.jpeg\",\"hashCode\":\"2246ef20d75fd39de86a15adb39fc74b\",\"predictions\":[{\"predictionType\":\"watermark_predictions\",\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,\"confidence\":78},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\",\"present\":false,\"confidence\":22},{\"predictionType\":\"nsfw_predictions\",\"displayName\":\"Pornography\",\"present\":false,\"confidence\":4}],\"edited\":false},{\"locationPath\":\"/filestore/mta/images/source/MTA-0451837/nike_test_image_qc_full02_gqm86hzf.jpeg\",\"hashCode\":\"d8ed7c1e732a350f9af0ffe0a2e28bca\",\"predictions\":[{\"predictionType\":\"watermark_predictions\",\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,\"confidence\":96},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\",\"present\":false,\"confidence\":5},{\"predictionType\":\"nsfw_predictions\",\"displayName\":\"Pornography\",\"present\":false,\"confidence\":0}],\"edited\":false},{\"locationPath\":\"/filestore/mta/images/source/edited_true_sample.jpg\",\"hashCode\":\"d8ed7c1e732a350f9af0ffe0a2e28bca\",\"predictions\":[{\"predictionType\":\"watermark_predictions\",\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,\"confidence\":96},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\",\"present\":false,\"confidence\":5},{\"predictionType\":\"nsfw_predictions\",\"displayName\":\"Pornography\",\"present\":false,\"confidence\":0}],\"edited\":false},{\"locationPath\":\"/filestore/mta/images/source/edited_false_sample.jpg\",\"hashCode\":\"d8ed7c1e732a350f9af0ffe0a2e28bca\",\"predictions\":[{\"predictionType\":\"watermark_predictions\",\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,\"confidence\":96},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\",\"present\":false,\"confidence\":5},{\"predictionType\":\"nsfw_predictions\",\"displayName\":\"Pornography\",\"present\":false,\"confidence\":0}],\"edited\":false}],\"success\":true,\"errorMessage\":\"\"}";
  private static final String LOCATION_PATH_1 = "/96/MTA-0607981/edited_true_sample.jpg";
  private static final String LOCATION_PATH_WITH_SOURCE_1 = "/filestore/mta/images/source/edited_true_sample.jpg";
  private static final String LOCATION_PATH_2 = "/96/MTA-0607981/edited_false_sample.jpg";
  private static final String LOCATION_PATH_WITH_SOURCE_2 = "/filestore/mta/images/source/edited_false_sample.jpg";
  private static final String ATTRIBUTE_CODE = "ATTRIBUTE_CODE";
  private static final String ATTRIBUTE_VALUE = "ATTRIBUTE_VALUE";
  private static final String PDT_USER_FEEDBACK =
      "{\"userFeedback\":[{\"locationPath\":\"path1\",\"userPrediction\":[\"Blur\",\"Text\"]},{\"locationPath\":\"path2\",\"userPrediction\":[\"Blur\",\"Text\"]}]}";
  private static final String PDT_USER_FEEDBACK_1 =
      "{\"userFeedback\":[{\"locationPath\":\"path1\",\"userPrediction\":[\"Blur\",\"Text\"]}]}";
  private static final String EDITED_QC_RESPONSE =
      "{\"timestamp\":1595003740556,\"productCode\":\"MTA-0000001\",\"images\":[{\"locationPath\":\"/filestore/mta/images/source/MTA-0451837/nike_test_image_qc_full01_uedfzhqd.jpeg\",\"hashCode\":\"2246ef20d75fd39de86a15adb39fc74b\",\"predictions\":[{\"predictionType\":\"watermark_predictions\",\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,\"confidence\":78},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\",\"present\":false,\"confidence\":22},{\"predictionType\":\"nsfw_predictions\",\"displayName\":\"Pornography\",\"present\":false,\"confidence\":4}],\"edited\":false,\"markForDelete\":false},{\"locationPath\":\"/filestore/mta/images/source/MTA-0451837/nike_test_image_qc_full02_gqm86hzf.jpeg\",\"hashCode\":\"d8ed7c1e732a350f9af0ffe0a2e28bca\",\"predictions\":[{\"predictionType\":\"watermark_predictions\",\"displayName\":\"Watermark\",\"present\":false,\"confidence\":0},{\"predictionType\":\"blur_predictions\",\"displayName\":\"Blur\",\"present\":true,\"confidence\":96},{\"predictionType\":\"text_predictions\",\"displayName\":\"Text\",\"present\":false,\"confidence\":5},{\"predictionType\":\"nsfw_predictions\",\"displayName\":\"Pornography\",\"present\":false,\"confidence\":0}],\"edited\":false,\"markForDelete\":false},{\"locationPath\":\"path1\",\"hashCode\":\"hashCode1\",\"predictions\":[{\"predictionType\":\"watermark\",\"displayName\":\"water mark present\",\"present\":false,\"confidence\":60},{\"predictionType\":\"nsfw\",\"displayName\":\"nsfw present\",\"present\":false,\"confidence\":80}],\"edited\":false,\"markForDelete\":false},{\"locationPath\":\"path2\",\"hashCode\":\"hashCode2\",\"predictions\":[{\"predictionType\":\"watermark\",\"displayName\":\"water mark present\",\"present\":false,\"confidence\":60},{\"predictionType\":\"nsfw\",\"displayName\":\"nsfw present\",\"present\":false,\"confidence\":80}],\"edited\":false,\"markForDelete\":false}],\"success\":true,\"errorMessage\":\"\",\"restrictionModels\":[],\"brandModels\":[],\"keywordRestrictionModels\":[],\"categoryModels\":[]}";
  private static final String RESTRICTED_KEYWORDS_FIELD =
      "[{\"fieldIdentifier\" : \"PRODUCT_NAME\", \"keywords\" : [\"abc@gmail.com\"]}]";
  private static final String NEED_REVISION_CONFIG =
      "[{\"keyName\":\"Blur\",\"value\":\"58\",\"valueType\":\"int\",\"operator\":\"<=\"},{\"keyName\":\"Watermark\",\"value\":\"70\",\"valueType\":\"int\",\"operator\":\"<=\"},{\"keyName\":\"Text\",\"value\":\"0\",\"valueType\":\"int\",\"operator\":\"<=\"},{\"keyName\":\"Pornography\",\"value\":\"44\",\"valueType\":\"int\",\"operator\":\"<=\"},{\"keyName\":\"Other e-commerce/social media logos\",\"value\":\"44\",\"valueType\":\"int\",\"operator\":\"<=\"},{\"keyName\":\"Illegal drugs\",\"value\":\"44\",\"valueType\":\"int\",\"operator\":\"<=\"}]";
  private static final String WATERMARK = "Watermark";
  private static final String GCS_PATH_PREFIX = "prefix-path";
  private static final String GCS_COMPLETE_SOURCE_URL = "complete-soucre";
  private static final String REVIEW_TYPE = "CONTENT,IMAGE_REFRESH";
  private static final String REVIEW_TYPE_1 = "CONTENT";
  private static final String REVIEW_TYPE_2 = "IMAGE";
  private static final String PREORDER_TYPE = "DAYS";
  private static final String ATTRIBUTE_NAME = "attributeName";
  private static final Integer PREORDER_VALUE = 10;
  private static final Double MIN_PRICE = 1.0;
  private static final Double MAX_PRICE = 100.0;
  public static final String INVALID_DETECTION = "invalid-detection";
  public static final String NOT_SURE_DETECTION = "not-sure";

  private ProductDetailResponse savedProduct;
  private ProductBusinessPartner savedProductBusinessPartner;
  private Product savedMasterDataProduct;
  private ProductCollection productCollection;
  private Product product;
  private SolrProductCollectionUpdateEvent solrProductCollectionUpdateEvent;
  private ProductHistory productHistory;
  private Page<ProductBusinessPartner> productBusinessPartnerPage;
  private ProductItemResponse productItemResponse;
  private AttributeResponse attributeResponse;
  private ProductAttributeResponse productAttributeResponse;
  private Profile businessPartner;
  private ProfileResponse profileResponse;
  private CompanyDTO companyDTO;
  private ProductBusinessPartner productBusinessPartner;
  private List<ProductBusinessPartner> productBusinessPartners;
  private List<ProductWorkflow> savedProductWorkflows;
  private Page<ProductWorkflow> productWorkflowPage;
  private Pageable pageable;
  private Map<String, String> map = new HashMap();
  private Page<ProductCollection> productCollectionPage;
  private SimpleMasterProductUpdateRequestDTO simpleMasterProductUpdateRequestDTO;
  private ArgumentCaptor<String> businessPartnerCodeCaptor = ArgumentCaptor.forClass(String.class);
  private ArgumentCaptor<ProductAndItemImageRequest> productAndItemImageRequestArgumentCaptor =
      ArgumentCaptor.forClass(ProductAndItemImageRequest.class);
  private ArgumentCaptor<ProductActivateImageRequest> imageRequestArgumentCaptor =
      ArgumentCaptor.forClass(ProductActivateImageRequest.class);
  private BulkImageProcessResponse bulkImageProcessResponse;
  private ProductFilterRequest productFilterRequest = new ProductFilterRequest();
  private SolrProductCollectionDTO solrProductCollectionDTO = new SolrProductCollectionDTO();
  private ProductAndItemImageRequest productAndItemImageRequest;
  private DalamProductListRequest dalamProductListRequest;
  private ProductSystemParameter productSystemParameterEnable;
  private ProductSystemParameter productSystemCategoryParameter;
  private ProductSystemParameter productSystemParameterSync;
  private ProductSystemParameter productSystemParameterBrandTakeDownThreshold;
  private ImageQcResponseDomainEvent imageQcResponseDomainEvent;
  private UserFeedbackImageQcListResponse userFeedbackImageQcListResponse;
  private List<ImageQcResponse> imageQcResponseList;
  private ImageQcResponse imageQcResponse;
  private ImageQcPredictionResponse imageQcPredictionResponse;
  private ProductImagePrediction productImagePredictionWaterMark;
  private ProductImagePrediction productImagePredictionNsfw;
  private ProductImagePrediction textGoogleRestrictedKeyword;
  private ProductImagePrediction productImagePredictionText;
  private ProductImagePrediction productImagePredictionBlur;
  private ProductImageQcProcessingResponse productImageQcProcessingResponse;
  private ImageQcProcessedResponse imageQcProcessedResponse;
  private ItemFlagDetails itemFlagDetails;
  private Map<String, Long> imageCountMap;
  ObjectMapper mapper = new ObjectMapper();
  private ProductAndItemsResponse productAndItemsResponse = new ProductAndItemsResponse();
  private ItemResponse itemResponse = new ItemResponse();
  private ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
  private ItemViewConfigDTO itemViewConfigDTO = new ItemViewConfigDTO();
  private ProductSystemParameter productSystemParameter;
  private List<ProductCollection> productCollections;
  private Set<String> categoryIds;
  private ProductMigration productMigration;
  private ProductCollection oldProductCollection;
  private List<Image> imageList;
  private ProductImageQcFeedbackResponse productImageQcFeedbackResponse;
  private PDTProductDomainEventModel pdtProductDomainEventModel;
  private ProductDetailResponse productDetailResponse = new ProductDetailResponse();
  private CategoryResponse categoryResponse = new CategoryResponse();
  private ValidateDuplicateProductRequest validateDuplicateProductRequest = new ValidateDuplicateProductRequest();

  private ArgumentCaptor<ProductHistory> productHistoryCaptor = ArgumentCaptor.forClass(ProductHistory.class);
  private AutoApprovalTypeRequest autoApprovalTypeRequest;
  private SellerDetailResponse sellerDetailResponse;
  private AutoApprovalRules autoApprovalRules;
  private List<ProductBusinessPartner> productBusinessPartnerList = new ArrayList<>();
  private KeywordRestrictionModelsResponse keywordRestrictionModelsResponse = new KeywordRestrictionModelsResponse();
  private BasicProductResponse basicProductResponse = new BasicProductResponse();
  private AgpSimpleQueryResponse agpSimpleQuery;
  private RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
    new RestrictedKeywordsByFieldAndActionType();

  @Mock
  private PreOrderConfig preOrderConfig;

  @Mock
  private ProductRepository productRepository;

  @Mock
  private ProductPublisherService productPublisherService;

  @Mock
  private ProductItemRepository productItemRepository;

  @Mock
  private ProductBusinessPartnerRepository productBusinessPartnerRepository;

  @Mock
  private ProductItemBusinessPartnerRepository productItemBusinessPartnerRepository;

  @Mock
  private ProductWorkflowRepository productWorkflowRepository;

  @Mock
  private ProductHistoryRepository productHistoryRepository;

  @Mock
  private SequenceRepository sequenceRepository;

  @Mock
  private BusinessPartnerRepository businessPartnerRepository;

  @Mock
  private ProductCollectionRepository productCollectionRepository;

  @Mock
  private ProductChangeUtil productChangeUtil;

  @Mock
  private ProductLevel3Service productLevel3Service;

  @Mock
  private ProductWorkflowService productWorkflowService;

  @Mock
  private ProductGdnSkuGeneratorService productGdnSkuGeneratorService;

  @Mock
  private SolrActiveProductCollectionRepository solrActiveProductCollectionRepository;

  @Mock
  private SolrActiveProductCollectionService solrActiveProductCollectionService;

  @Mock
  private CategoryRepository categoryRepository;

  @Mock
  private ProductLevel3InventoryService productLevel3InventoryService;

  @Mock
  private ApplicationProperties applicationProperties;

  @InjectMocks
  private ProductServiceBean productServiceBean;

  @Mock
  private ProductNotificationService productNotificationService;

  @Mock
  private ProductStatusPublisherService productStatusPublisherService;

  @Mock
  private ProductWfService productWfService;

  @Mock
  private GeneratorService generatorService;

  @Mock
  private ProductSystemParameterService productSystemParameterService;

  @Mock
  private ProductLevel3V2Service productLevel3V2Service;

  @Mock
  private ProductImagePredictionService productImagePredictionService;

  @Mock
  private ProductImageQcProcessingResponseService productImageQcProcessingResponseService;

  @Mock
  private ProductLevel3AggregatorService productLevel3AggregatorService;

  @Mock
  private PCBFeign pcbFeign;

  @Mock
  private ItemService itemService;

  @Mock
  private XProductOutbound xProductOutbound;

  @Mock
  private UpdatedProductHistoryService updatedProductHistoryService;

  @Mock
  private ObjectMapper objectMapper;

  @Mock
  private ProductLevel3RetryService productLevel3RetryService;

  @Mock
  private ProductAnalyticsOutbound productAnalyticsOutbound;

  @Mock
  private FileStorageService fileStorageService;

  @Mock
  private KafkaTopicProperties kafkaTopicProperties;

  @Mock
  private ProductServiceWrapper productServiceWrapper;

  @Mock
  private AGPQueryFeign agpQueryFeign;

  @Mock
  private ProductAppealService productAppealService;

  @Captor
  private ArgumentCaptor<ProductCollection> productCollectionArgumentCaptor;

  @Captor
  private ArgumentCaptor<ProductHistory> productHistoryArgumentCaptor;

  @Captor
  private ArgumentCaptor<SolrProductCollectionDTO> solrProductCollectionDTOArgumentCaptor;

  @Captor
  private ArgumentCaptor<Page<ProductBusinessPartnerResponse>> productBusinessPartnerResponsePageArgumentCaptor;

  @Captor
  private ArgumentCaptor<List<ProductBusinessPartner>> productBusinessPartnerListCaptor;

  @Captor
  private ArgumentCaptor<ProductDetailResponse> productDetailResponseArgumentCaptor;

  @Captor
  private ArgumentCaptor<Page<ProductWorkflow>> productWorkflowPageCaptor;

  @Captor
  private ArgumentCaptor<ProductWorkflow> productWorkflowArgumentCaptor;

  @Captor
  private ArgumentCaptor<CategoryChangeMailEvent> categoryChangeMailEventArgumentCaptor;

  @Captor
  private ArgumentCaptor<List> listArgumentCaptor;

  @Captor
  private ArgumentCaptor<AddEditedProductToPDTEvent> addEditedProductToPDTEventArgumentCaptor;

  @Captor
  private ArgumentCaptor<AddProductToVendorCombinedEventModel> addProductToVendorCombinedEventModelArgumentCaptor;

  @Captor
  private ArgumentCaptor<AddDeleteVariantRetryPublishEventModel> addDeleteVariantRetryPublishEventArgumentCaptor;

  @Captor
  private ArgumentCaptor<List<UpdatedProductHistory>> logAuditTrailUpdatedProductListCaptor;

  @Captor
  private ArgumentCaptor<ImageQcProcessedResponseDomainEvent> imageQcProcessedResponseDomainEventArgumentCaptor;

  @Mock
  private ProductDistributionTaskRepositoryBean productDistributionTaskRepositoryBean;

  @Mock
  private SolrReviewProductCollectionService solrReviewProductCollectionService;

  @Mock
  private ProductMailEventService productMailEventService;

  @Mock
  private ProductOutbound productOutbound;

  @Mock
  private KafkaPublisher kafkaProducer;

  @Mock
  private ProductBusinessPartnerService productBusinessPartnerService;

  @Mock
  private AutoApprovalService autoApprovalService;

  @Mock
  private ProductLevel3Helper productLevel3Helper;

  @Mock
  private EmailNotificationService emailNotificationService;

  @Mock
  private MandatoryParameterHelper mandatoryParameterHelper;

  @Mock
  private PickupPointOutbound pickupPointOutbound;

  @Mock
  private DistributionInfoServiceBean distributionInfoServiceBean;

  @Mock
  private ProductDistributionService productDistributionService;

  @Mock
  private ProductMigrationWrapperService productMigrationWrapperService;

  @Captor
  private ArgumentCaptor<ItemViewConfigRequest> itemViewConfigRequestArgumentCaptor;

  @Captor
  private ArgumentCaptor<ProductImageQcProcessingResponse> productImageQcProcessingResponseArgumentCaptor;

  @Captor
  private ArgumentCaptor<ProductStatusDomainEvent> productStatusDomainEventArgumentCaptor;

  @Captor
  private ArgumentCaptor<List<ItemViewConfigAndItemSkuRequest>> itemViewConfigAndItemSkuRequestCaptor;

  @Captor
  private ArgumentCaptor<List<ItemViewConfigAndItemSkuRequest>> itemViewConfigAndItemSkuListRequestCaptor;

  @Captor
  private ArgumentCaptor<ProductBusinessPartner> productBusinessPartnerArgumentCaptor;

  @Captor
  private ArgumentCaptor<List<ProductLevel3Inventory>> argumentCaptorProductLevel3InventoryList;

  @Captor
  private ArgumentCaptor<AutoApprovalsDetailDto> autoApprovalsDetailDtoArgumentCaptor;

  @Captor
  private ArgumentCaptor<Map<String, List<ProductCollectionElement>>> businessPartnerCodeProductCollectionElementsMapCaptor;


/*
   * TEST MAP
   *
   * RETRY DELETE PRODUCT FUNCTION
   * 1. retry delete product with happy flow >> retryDeleteProduct
   * 2. retry delete product when product already deleted >> retryDeleteProductWithNullException
   * 3. retry delete product when get product list is empty >> retryDeleteProductWithNullProduct
   *
   */


  @AfterEach
  public void finalizeTest() throws Exception {
    Mockito.verifyNoMoreInteractions(getProductRepository());
    Mockito.verifyNoMoreInteractions(getProductBusinessPartnerRepository());
    Mockito.verifyNoMoreInteractions(getProductWorkflowRepository());
    Mockito.verifyNoMoreInteractions(getProductHistoryRepository());
    Mockito.verifyNoMoreInteractions(getSequenceRepository());
    Mockito.verifyNoMoreInteractions(getProductChangeUtil());
    Mockito.verifyNoMoreInteractions(getProductLevel3Service());
    Mockito.verifyNoMoreInteractions(getProductWorkflowService());
    Mockito.verifyNoMoreInteractions(this.categoryRepository);
    Mockito.verifyNoMoreInteractions(getProductGdnSkuGeneratorService());
    Mockito.verifyNoMoreInteractions(this.solrActiveProductCollectionRepository);
    Mockito.verifyNoMoreInteractions(getProductLevel3InventoryService());
    Mockito.verifyNoMoreInteractions(this.productNotificationService);
    Mockito.verifyNoMoreInteractions(this.productStatusPublisherService);
    Mockito.verifyNoMoreInteractions(this.generatorService);
    Mockito.verifyNoMoreInteractions(this.productDistributionTaskRepositoryBean);
    Mockito.verifyNoMoreInteractions(this.solrReviewProductCollectionService);
    Mockito.verifyNoMoreInteractions(this.productMailEventService);
    Mockito.verifyNoMoreInteractions(this.productLevel3AggregatorService);
    Mockito.verifyNoMoreInteractions(productOutbound);
    Mockito.verifyNoMoreInteractions(productSystemParameterService);
    Mockito.verifyNoMoreInteractions(productImagePredictionService);
    Mockito.verifyNoMoreInteractions(productImageQcProcessingResponseService);
    Mockito.verifyNoMoreInteractions(productBusinessPartnerService);
    Mockito.verifyNoMoreInteractions(itemService);
    Mockito.verifyNoMoreInteractions(updatedProductHistoryService);
    Mockito.verifyNoMoreInteractions(kafkaProducer);
    Mockito.verifyNoMoreInteractions(objectMapper);
    Mockito.verifyNoMoreInteractions(autoApprovalService);
    Mockito.verifyNoMoreInteractions(productAnalyticsOutbound);
    Mockito.verifyNoMoreInteractions(emailNotificationService);
    Mockito.verifyNoMoreInteractions(productDistributionService);
    Mockito.verifyNoMoreInteractions(kafkaTopicProperties);
    Mockito.verifyNoMoreInteractions(productAppealService, productMigrationWrapperService);
    Mockito.verifyNoMoreInteractions(distributionInfoServiceBean);
  }

  public ProductLevel3InventoryService getProductLevel3InventoryService() {
    return this.productLevel3InventoryService;
  }

  public void setProductLevel3InventoryService(ProductLevel3InventoryService productLevel3InventoryService) {
    this.productLevel3InventoryService = productLevel3InventoryService;
  }

  public BusinessPartnerRepository getBusinessPartnerRepository() {
    return this.businessPartnerRepository;
  }

  public ProductChangeUtil getProductChangeUtil() {
    return this.productChangeUtil;
  }

  public ProductLevel3Service getProductLevel3Service() {
    return this.productLevel3Service;
  }

  public void setProductLevel3Service(ProductLevel3Service productLevel3Service) {
    this.productLevel3Service = productLevel3Service;
  }

  public ProductWorkflowService getProductWorkflowService() {
    return this.productWorkflowService;
  }

  public void setProductWorkflowService(ProductWorkflowService productWorkflowService) {
    this.productWorkflowService = productWorkflowService;
  }

  public ProductGdnSkuGeneratorService getProductGdnSkuGeneratorService() {
    return this.productGdnSkuGeneratorService;
  }

  public void setProductGdnSkuGeneratorService(ProductGdnSkuGeneratorService productGdnSkuGeneratorService) {
    this.productGdnSkuGeneratorService = productGdnSkuGeneratorService;
  }

  private Product getProduct() {
    Product product =
        new Product.Builder().productCode(PRODUCT_CODE).name("Produk 1").length(1.0).width(1.0).height(1.0).weight(1.0)
            .shippingWeight(1.0).description("Deskripsi Produk 1".getBytes()).brand("Brand 1").storeId(DEFAULT_STORE_ID)
            .build();
    product.setId(UUID.randomUUID().toString());
    product.setCreatedBy(DEFAULT_USERNAME);
    product.setCreatedDate(Calendar.getInstance().getTime());
    product.setUpdatedBy(DEFAULT_USERNAME);
    product.setUpdatedDate(Calendar.getInstance().getTime());
    product.setSpecificationDetail("Spesifikasi Detail");
    return product;
  }

  private ProductBusinessPartner getProductBusinessPartner() {
    ProductBusinessPartner productBusinessPartner =
        new ProductBusinessPartner("business-partner-1", "product-1", "BP1-00001-00001",
            new ArrayList<ProductItemBusinessPartner>(), new ArrayList<ProductBusinessPartnerAttribute>(),
            DEFAULT_USERNAME, Calendar.getInstance().getTime(), DEFAULT_STORE_ID);
    productBusinessPartner.getProductItemBusinessPartners().add(
        new ProductItemBusinessPartner.Builder().productBusinessPartner(productBusinessPartner)
            .productItemId("product-item-1").productType(1).gdnProductItemSku("BP1-00001-00001-00001").price(10000.0)
            .salePrice(10000.0).saleStartDate(null).saleEndDate(null).stock(10).minimumStock(0)
            .pickupPointId("pickup-point-1").createdBy(DEFAULT_USERNAME).createdDate(Calendar.getInstance().getTime())
            .storeId(DEFAULT_STORE_ID).build());
    productBusinessPartner.getProductItemBusinessPartners().add(
        new ProductItemBusinessPartner.Builder().productBusinessPartner(productBusinessPartner)
            .productItemId("product-item-2").productType(1).gdnProductItemSku("BP1-00001-00001-00002").price(10000.0)
            .salePrice(10000.0).saleStartDate(null).saleEndDate(null).stock(10).minimumStock(0)
            .pickupPointId("pickup-point-1").createdBy(DEFAULT_USERNAME).createdDate(Calendar.getInstance().getTime())
            .storeId(DEFAULT_STORE_ID).build());
    for (ProductItemBusinessPartner productItemBusinessPartner : productBusinessPartner
        .getProductItemBusinessPartners()) {
      productItemBusinessPartner.setId(UUID.randomUUID().toString());
      productItemBusinessPartner.setUpdatedBy(DEFAULT_USERNAME);
      productItemBusinessPartner.setUpdatedDate(Calendar.getInstance().getTime());
      productItemBusinessPartner.setDisplay(true);
      productItemBusinessPartner.setBuyable(true);
    }
    productBusinessPartner.setId(UUID.randomUUID().toString());
    productBusinessPartner.setUpdatedBy(DEFAULT_USERNAME);
    productBusinessPartner.setUpdatedDate(Calendar.getInstance().getTime());
    return productBusinessPartner;
  }

  public ProductBusinessPartnerRepository getProductBusinessPartnerRepository() {
    return this.productBusinessPartnerRepository;
  }

  public ProductCollectionRepository getProductCollectionRepository() {
    return this.productCollectionRepository;
  }

  public ProductHistoryRepository getProductHistoryRepository() {
    return this.productHistoryRepository;
  }

  private ProductItem getProductItem() {
    Product product =
        new Product.Builder().productCode(null).name("Produk 1").length(1.0).width(1.0).height(1.0).weight(1.0)
            .shippingWeight(1.0).description("Deskripsi Produk 1".getBytes()).brand("Brand 1").storeId(DEFAULT_STORE_ID)
            .build();
    product.setId(UUID.randomUUID().toString());
    ProductItem productItem =
        new ProductItem(product, "0123456789012", UUID.randomUUID().toString(), "Produk 1 Item 1", null,
            DEFAULT_STORE_ID);
    return productItem;
  }

  public ProductItemRepository getProductItemRepository() {
    return this.productItemRepository;
  }

  public ProductRepository getProductRepository() {
    return this.productRepository;
  }

  public ProductServiceBean getProductServiceBean() {
    return this.productServiceBean;
  }

  public ProductWorkflowRepository getProductWorkflowRepository() {
    return this.productWorkflowRepository;
  }

  public SequenceRepository getSequenceRepository() {
    return this.sequenceRepository;
  }

  public ProductPublisherService getProductPublisherService() {
    return this.productPublisherService;
  }

  private ProductDetailResponse generateProductDetailResponse() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    Image image = new Image();
    image.setLocationPath(IMAGE_LOCATION_PATH_1);
    image.setHashCode(IMAGE_HASH_CODE_1);
    image.setOriginalImage(true);
    Image image1 = new Image();
    image1.setLocationPath(IMAGE_LOCATION_PATH_2);
    image1.setHashCode(IMAGE_HASH_CODE_2);
    image1.setOriginalImage(true);
    Image image2 = new Image();
    image2.setLocationPath(IMAGE_LOCATION_PATH_3);
    image2.setHashCode(IMAGE_HASH_CODE_3);
    image2.setOriginalImage(true);
    Image image3 = new Image();
    image3.setLocationPath(IMAGE_LOCATION_PATH_4);
    image3.setHashCode(IMAGE_HASH_CODE_4);
    image3.setOriginalImage(true);
    productData.setImages(Arrays.asList(image, image1, image2, image3));
    productData.setProductCode(PRODUCT_CODE);
    productData.setId(UUID.randomUUID().toString());
    productData.setStoreId(DEFAULT_STORE_ID);
    productData.setCreatedBy(DEFAULT_USERNAME);
    productData.setCreatedDate(Calendar.getInstance().getTime());
    productData.setUpdatedBy(DEFAULT_USERNAME);
    productData.setUpdatedDate(Calendar.getInstance().getTime());
    productData.setDescription("DESCRIPTION".getBytes());
    productData.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.getProductCategoryResponses().get(0).setMarkForDelete(true);
    productData.setProductItemResponses(new HashSet<ProductItemResponse>());
    productData.setProductAttributeResponses(new ArrayList<ProductAttributeResponse>());
    ProductItemResponse productItemData = new ProductItemResponse();
    productItemData.setId(UUID.randomUUID().toString());
    productItemData.getImages().add(new Image());
    productItemData.setSkuCode(productData.getProductCode() + UUID.randomUUID().toString());
    productItemData.setImages(Arrays.asList(image, image1, image2, image3));
    AttributeResponse attributeData = new AttributeResponse();
    attributeData.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    ProductAttributeResponse productAttributeData = new ProductAttributeResponse();
    productAttributeData.setAttribute(attributeData);
    productData.getProductItemResponses().add(productItemData);
    productData.getProductAttributeResponses().add(productAttributeData);
    productData.setVersion(1L);
    return productData;
  }

  @BeforeEach
  public void initializeTest() throws Exception {
    MockitoAnnotations.initMocks(this);
    this.savedProductBusinessPartner = getProductBusinessPartner();
    this.map.put("product-item-1", "master-product-item-1");
    this.map.put("product-item-2", "master-product-item-2");
    this.savedMasterDataProduct = getProduct();
    this.savedProduct = new ProductDetailResponse(new ProductResponse());
    this.savedProduct.setProductCode("MTA-" + UUID.randomUUID().toString());
    this.savedProduct.setId(UUID.randomUUID().toString());
    this.savedProduct.setStoreId(DEFAULT_STORE_ID);
    this.savedProduct.setCreatedBy(DEFAULT_USERNAME);
    this.savedProduct.setCreatedDate(Calendar.getInstance().getTime());
    this.savedProduct.setUpdatedBy(DEFAULT_USERNAME);
    this.savedProduct.setUpdatedDate(Calendar.getInstance().getTime());
    this.savedProduct.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    this.savedProduct.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    this.savedProduct.setProductItemResponses(new HashSet<ProductItemResponse>());
    this.savedProduct.setProductAttributeResponses(new ArrayList<ProductAttributeResponse>());
    this.savedProduct.setImages(new ArrayList<Image>());
    this.productAndItemImageRequest = new ProductAndItemImageRequest();
    this.bulkImageProcessResponse = new BulkImageProcessResponse();
    bulkImageProcessResponse.setStoreId(STORE_ID);
    bulkImageProcessResponse.setGroupCode(PRODUCT_CODE);
    ImageResponse imageResponse = new ImageResponse();
    imageResponse.setImagePathLocation(IMAGE_LOCATION_PATH_1);
    imageResponse.setHashCode(IMAGE_HASH_CODE_1);
    imageResponse.setSuccess(true);
    ImageResponse imageResponse1 = new ImageResponse();
    imageResponse1.setImagePathLocation(IMAGE_LOCATION_PATH_2);
    imageResponse1.setHashCode(IMAGE_HASH_CODE_2);
    imageResponse1.setSuccess(true);
    ImageResponse imageResponse2 = new ImageResponse();
    imageResponse2.setImagePathLocation(IMAGE_LOCATION_PATH_3);
    imageResponse2.setHashCode(IMAGE_HASH_CODE_3);
    imageResponse2.setSuccess(true);
    ImageResponse imageResponse3 = new ImageResponse();
    imageResponse3.setImagePathLocation(IMAGE_LOCATION_PATH_4);
    imageResponse3.setHashCode(IMAGE_HASH_CODE_4);
    imageResponse3.setSuccess(true);
    bulkImageProcessResponse
        .setImageResponses(Arrays.asList(imageResponse, imageResponse1, imageResponse2, imageResponse3));
    this.productItemResponse = new ProductItemResponse();
    this.productItemResponse.setId(UUID.randomUUID().toString());
    this.productItemResponse.setImages(new ArrayList<Image>());
    this.productItemResponse.getImages().add(new Image());

    this.attributeResponse = new AttributeResponse();
    this.attributeResponse.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());

    this.productAttributeResponse = new ProductAttributeResponse();
    this.productAttributeResponse.setAttribute(this.attributeResponse);

    this.savedProduct.getProductItemResponses().add(this.productItemResponse);
    this.savedProduct.getProductAttributeResponses().add(this.productAttributeResponse);
    this.savedProduct.getImages().add(new Image());

    businessPartner = new Profile();
    businessPartner.setBusinessPartnerCode("BP1-00001");
    businessPartner.setBusinessPartnerType("1");
    businessPartner.setCompany(new Company());
    businessPartner.setLegalityOfCompany(new LegalityOfCompany());
    businessPartner.setResponsiblePerson(new ResponsiblePerson());
    businessPartner.setPickupPoints(new ArrayList<>());
    businessPartner.setBankAccounts(new ArrayList<>());
    businessPartner.setPaymentAccounts(new ArrayList<>());
    businessPartner.setCategories(new ArrayList<>());
    businessPartner.setTaxation(new Taxation());
    businessPartner.setReasonStatus("reason-status");
    businessPartner.setReactivateCount(0);
    businessPartner.setAcceptedDatePKS(new Date());
    businessPartner.setRelationChanged(Boolean.FALSE);
    businessPartner.setCreatedBy(DEFAULT_USERNAME);
    businessPartner.setCreatedDate(Calendar.getInstance().getTime());
    businessPartner.setStoreId(DEFAULT_STORE_ID);
    this.businessPartner.setId("business-partner-1");

    this.productBusinessPartner = new ProductBusinessPartner("business-partner-1", "product-1", "BP1-00001-00001",
        new ArrayList<ProductItemBusinessPartner>(), new ArrayList<ProductBusinessPartnerAttribute>(), DEFAULT_USERNAME,
        Calendar.getInstance().getTime(), DEFAULT_STORE_ID);
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setProductItemId(PRODUCT_ITEM_ID);
    productItemBusinessPartner.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner.setMerchantSku(MERCHANT_SKU);
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setProductItemId(PRODUCT_ITEM_ID_1);
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner1.setMerchantSku(MERCHANT_SKU_1);
    productBusinessPartner.setProductItemBusinessPartners(Arrays.asList(productItemBusinessPartner, productItemBusinessPartner1));

    this.productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    this.productBusinessPartners.add(new ProductBusinessPartner("business-partner-1", "product-1", "BP1-00001-00001",
        new ArrayList<ProductItemBusinessPartner>(), new ArrayList<ProductBusinessPartnerAttribute>(), DEFAULT_USERNAME,
        Calendar.getInstance().getTime(), DEFAULT_STORE_ID));
    this.productBusinessPartners.get(0).setProductItemBusinessPartners(new ArrayList<ProductItemBusinessPartner>());
    this.productBusinessPartners.get(0)
        .setProductBusinessPartnerAttributes(new ArrayList<ProductBusinessPartnerAttribute>());
    this.productBusinessPartners.get(0).getProductItemBusinessPartners().add(new ProductItemBusinessPartner());
    this.productBusinessPartners.get(0).getProductItemBusinessPartners().get(0)
        .setProductItemId(this.productItemResponse.getId());
    this.productBusinessPartners.get(0).getProductItemBusinessPartners().get(0)
        .setGdnProductItemSku(DEFAULT_GDN_SKU);
    this.productBusinessPartners.get(0).getProductBusinessPartnerAttributes()
        .add(new ProductBusinessPartnerAttribute());

    this.productBusinessPartnerPage = new PageImpl<ProductBusinessPartner>(this.productBusinessPartners);

    this.savedProductWorkflows = new ArrayList<ProductWorkflow>();
    this.savedProductWorkflows.add(
        new ProductWorkflow(this.savedProduct.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
            ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, null, DEFAULT_USERNAME,
            Calendar.getInstance().getTime(), DEFAULT_STORE_ID));

    this.productWorkflowPage = new PageImpl<ProductWorkflow>(this.savedProductWorkflows);
    this.pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);

    this.productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);

    // Initialize return value when repository called
    productCollections = new ArrayList<ProductCollection>();
    productCollections.add(
        new ProductCollection(UUID.randomUUID().toString(), "MTA-0000001", "Produk 1", "Testing", "CAT-0000001",
            "Kategori 1", "BLT-00001", "Blibli Testing 1", false, false, "DRAFT", DEFAULT_USERNAME,
            Calendar.getInstance().getTime(), DEFAULT_STORE_ID));
    productCollections.get(0).setUpdatedDate(DEFAULT_DATE_FORMAT.parse("2016-01-20"));
    productCollections.get(0).setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productCollections.get(0).setBusinessPartnerName(DEFAULT_BUSINESS_PARTNER_NAME);
    productCollections.get(0).setBrandCode(DEFAULT_BRAND_CODE);
    productCollections.get(0).setReviewerNotes(REVIEWER_NOTES);
    productCollections.get(0).setBrandApprovalStatus(BrandApprovalStatus.valueOf(DEFAULT_BRAND_APPROVAL_STATUS));

    List<ProductCollection> productCollectionList = new ArrayList<>();
    this.productCollectionPage = new PageImpl<ProductCollection>(productCollectionList);

    Page<ProductCollection> productCollectionPage = new PageImpl<ProductCollection>(productCollections);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString()))
        .thenReturn(productCollections.get(0));
    Mockito.when(
        getProductCollectionRepository().findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString()))
        .thenReturn(productCollections.get(0));
    Mockito.when(getProductCollectionRepository().saveAndFlush((ProductCollection) Mockito.any()))
        .thenReturn(null);
    Mockito.when(getProductCollectionRepository().save((ProductCollection) Mockito.any())).thenReturn(null);

    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(
        new ProductHistory(DEFAULT_PRODUCT_ID, 0, "Draft", DEFAULT_USERNAME, Calendar.getInstance().getTime(),
            DEFAULT_STORE_ID));
    productHistories.add(
        new ProductHistory(DEFAULT_PRODUCT_ID, 1, "Review Konten", DEFAULT_USERNAME, Calendar.getInstance().getTime(),
            DEFAULT_STORE_ID));
    productHistories.add(
        new ProductHistory(DEFAULT_PRODUCT_ID, 2, "Review Gambar", DEFAULT_USERNAME, Calendar.getInstance().getTime(),
            DEFAULT_STORE_ID));
    Page<ProductHistory> productHistoriesPage = new PageImpl<ProductHistory>(productHistories);
    Mockito.when(getProductHistoryRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalseOrderByCreatedDateDesc(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID,
            DEFAULT_PAGEABLE)).thenReturn(productHistoriesPage);
    Mockito.when(getProductHistoryRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID))
        .thenReturn(productHistories);
    Mockito.when(getProductRepository().findProductItemsByProductId(Mockito.anyString()))
        .thenReturn(new ArrayList<ProductItemResponse>());
    Mockito.doNothing().when(this.productWorkflowService)
        .processImage(Mockito.anyString(), Mockito.anyString(), Mockito.anyBoolean());
    Mockito.doNothing().when(this.productWorkflowService).rejectProcessImage(Mockito.anyString(), Mockito.anyString());
    Mockito.when(this.productWorkflowService
        .approveImage(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE),
            Mockito.anyBoolean())).thenReturn(true);
    Mockito.when(this.productWorkflowService
        .approveImage(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE_2),
            Mockito.anyBoolean())).thenReturn(false);
    Mockito.doNothing().when(this.productRepository).updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.when(this.productWorkflowService
        .approveContent(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE),
            Mockito.anyBoolean())).thenReturn(true);
    Mockito.when(this.productWorkflowService
        .approveContent(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE_2),
            Mockito.anyBoolean())).thenReturn(false);
    Mockito.doNothing().when(this.productRepository).create((ProductRequest) Mockito.any());
    Mockito.doNothing().when(this.productWorkflowService).create(Mockito.anyString(), Mockito.anyString());
    Mockito.doNothing().when(this.productWorkflowService).submit(Mockito.anyString(), Mockito.anyString());
    Mockito.doNothing().when(this.productRepository).updateActivated(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.doNothing().when(this.productRepository).updateProductContent((ProductRequest) Mockito.any());
    Mockito.when(this.productHistoryRepository.save((ProductHistory) Mockito.any())).thenReturn(null);
    Mockito
        .when(this.productGdnSkuGeneratorService.convertToGeneratedGdnSkus(Mockito.any(ProductBusinessPartner.class)))
        .thenReturn(DEFAULT_SKU_CODE);
    Mockito.doNothing().when(this.productRepository).updateProductImage((ProductRequest) Mockito.any());
    Mockito.when(this.applicationProperties.getRowsProductCodeSolrSearch()).thenReturn("1000");
    Mockito.when(this.applicationProperties.getRowsCategoryCodeSolrSearch()).thenReturn("1000");
    simpleMasterProductUpdateRequestDTO = new SimpleMasterProductUpdateRequestDTO();
    simpleMasterProductUpdateRequestDTO.setProductCode(DEFAULT_PRODUCT_CODE);
    simpleMasterProductUpdateRequestDTO.setName(PRODUCT_NAME);
    simpleMasterProductUpdateRequestDTO.setBrand(BRAND);
    simpleMasterProductUpdateRequestDTO.setLength(LENGTH);
    simpleMasterProductUpdateRequestDTO.setWidth(WIDTH);
    simpleMasterProductUpdateRequestDTO.setHeight(HEIGHT);
    simpleMasterProductUpdateRequestDTO.setWeight(WEIGHT);
    simpleMasterProductUpdateRequestDTO.setDangerousGoodsLevel(DANGEROUS_GOODS_LEVEL);

    product = getProduct();
    product.setViewable(true);
    product.setActivated(true);
    solrProductCollectionUpdateEvent = new SolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, CATEGORY_NAME, 0), DEFAULT_STORE_ID));
    productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_EDIT,
        ProductWorkflowLookup.STATE_EDIT_DESCRIPTION, ProductWorkflowLookup.STATE_EDIT_DESCRIPTION,
        product.getUpdatedBy(), product.getUpdatedDate(), product.getStoreId());

    solrProductCollectionDTO.setBrand(BRAND);
    solrProductCollectionDTO.setCategoryName(CATEGORY_NAME);
    solrProductCollectionDTO.setProductName(PRODUCT_NAME);
    solrProductCollectionDTO.setProductCode(PRODUCT_CODE);

    profileResponse = new ProfileResponse();
    profileResponse.setBusinessPartnerCode(BP_CODE);
    companyDTO = new CompanyDTO();
    companyDTO.setInternationalFlag(Boolean.TRUE);
    profileResponse.setCompany(companyDTO);

    dalamProductListRequest = DalamProductListRequest.builder().storeId(STORE_ID).categoryCode(CATEGORY_CODE)
        .businessPartnerCode(BUSINESS_PARTNER_ID).keyword(KEYWORD).page(0).size(10).viewable(Boolean.FALSE)
        .activated(Boolean.FALSE).build();

    ReflectionTestUtils
        .setField(productServiceBean, "phoneNumberDetectionRegex", "^(?:\\s+|)((08|(?:(\\+|)628))\\d{9,11})$");
    ReflectionTestUtils.setField(productServiceBean, "imageSourceDirectory", IMAGE_SOURCE_DIRECTORY);
    ReflectionTestUtils.setField(productServiceBean, "mppAllowedSellers",
        Constants.CM_MERCHANT + Constants.COMMA + Constants.CC_MERCHANT);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", false);

    productSystemParameterEnable = new ProductSystemParameter();
    productSystemParameterEnable.setValue(String.valueOf(false));

    productSystemCategoryParameter = new ProductSystemParameter();
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);

    productSystemParameterSync = new ProductSystemParameter();
    productSystemParameterSync.setValue(String.valueOf(true));

    productSystemParameterBrandTakeDownThreshold= new ProductSystemParameter();
    productSystemParameterBrandTakeDownThreshold.setValue("10");

    imageQcResponseDomainEvent = new ImageQcResponseDomainEvent();
    imageQcResponseDomainEvent.setProductCode(DEFAULT_PRODUCT_CODE);
    imageQcResponseDomainEvent.setSuccess(true);

    imageQcResponseList = new ArrayList<>();
    imageQcResponse = new ImageQcResponse();
    List<ImageQcPredictionResponse> imageQcPredictionResponseList = new ArrayList<>();
    imageQcPredictionResponse = new ImageQcPredictionResponse();
    imageQcPredictionResponse.setPredictionType(PREDICTION_NAME_1);
    imageQcPredictionResponse.setDisplayName(PREDICTION_DISPLAY_NAME_1);
    imageQcPredictionResponse.setPresent(true);
    imageQcPredictionResponse.setConfidence(40);

    ImageQcPredictionResponse imageQcPredictionResponse1 = new ImageQcPredictionResponse();
    imageQcPredictionResponse1.setPredictionType(PREDICTION_NAME_2);
    imageQcPredictionResponse1.setDisplayName(PREDICTION_DISPLAY_NAME_2);
    imageQcPredictionResponse1.setPresent(true);
    imageQcPredictionResponse1.setConfidence(80);

    imageQcPredictionResponseList.add(imageQcPredictionResponse);
    imageQcPredictionResponseList.add(imageQcPredictionResponse1);

    imageQcResponse.setPredictions(imageQcPredictionResponseList);
    imageQcResponse.setHashCode(IMAGE_HASH_CODE_1);
    imageQcResponse.setLocationPath(IMAGE_LOCATION_PATH_1);

    ImageQcResponse imageQcResponse1 = new ImageQcResponse();
    imageQcResponse1.setLocationPath(IMAGE_LOCATION_PATH_2);
    imageQcResponse1.setHashCode(IMAGE_HASH_CODE_2);
    imageQcResponse1.setPredictions(imageQcPredictionResponseList);
    imageQcResponseList.add(imageQcResponse);
    imageQcResponseList.add(imageQcResponse1);

    imageQcResponseDomainEvent.setImages(imageQcResponseList);

    imageCountMap = new HashMap<>();
    imageCountMap.put(IMAGE_HASH_CODE_1, 1L);
    imageCountMap.put(IMAGE_HASH_CODE_2, 1L);

    productImagePredictionNsfw = new ProductImagePrediction();
    productImagePredictionWaterMark = new ProductImagePrediction();
    productImagePredictionNsfw.setPredictionType(PREDICTION_NAME_2);
    productImagePredictionNsfw.setDisplayName(PREDICTION_DISPLAY_NAME_2);
    productImagePredictionNsfw.setConfidenceThreshold(50);
    productImagePredictionNsfw.setPredictionWeightage(15);
    productImagePredictionNsfw.setForceReview(false);

    textGoogleRestrictedKeyword = new ProductImagePrediction();
    textGoogleRestrictedKeyword.setPredictionType(PREDICTION_TEXT_NAME);
    textGoogleRestrictedKeyword.setDisplayName(PREDICTION_TEXT_DISPLAY_NAME);
    textGoogleRestrictedKeyword.setDisplayNameIn(PREDICTION_TEXT_DISPLAY_NAME_1);
    textGoogleRestrictedKeyword.setTextConfidenceThreshold(50);
    textGoogleRestrictedKeyword.setPredictionWeightage(1);
    textGoogleRestrictedKeyword.setForceReview(false);

    productImagePredictionText = new ProductImagePrediction();
    productImagePredictionText.setPredictionType(PREDICTION_NAME_4);
    productImagePredictionText.setDisplayName(PREDICTION_DISPLAY_NAME_4);
    productImagePredictionText.setConfidenceThreshold(50);
    productImagePredictionText.setPredictionWeightage(20);
    productImagePredictionText.setForceReview(false);

    productImagePredictionBlur = new ProductImagePrediction();
    productImagePredictionBlur.setPredictionType(PREDICTION_NAME_3);
    productImagePredictionBlur.setDisplayName(PREDICTION_DISPLAY_NAME_3);
    productImagePredictionBlur.setConfidenceThreshold(50);
    productImagePredictionBlur.setPredictionWeightage(5);
    productImagePredictionBlur.setForceReview(false);

    productImagePredictionWaterMark.setForceReview(false);
    productImagePredictionWaterMark.setPredictionType(PREDICTION_NAME_1);
    productImagePredictionWaterMark.setDisplayName(PREDICTION_DISPLAY_NAME_1);
    productImagePredictionWaterMark.setConfidenceThreshold(50);
    productImagePredictionWaterMark.setPredictionWeightage(10);

    productImageQcProcessingResponse = new ProductImageQcProcessingResponse();
    productImageQcProcessingResponse.setProductCode(PRODUCT_CODE);
    productImageQcProcessingResponse.setForceReview(true);
    productImageQcProcessingResponse.setImageViolations(PREDICTION_DISPLAY_NAME_1);
    productImageQcProcessingResponse.setProductPredictionScore(10);
    productImageQcProcessingResponse.setImageQcResponse(IMAGE_PREDICTION_RESPONSE_1);

    itemViewConfigDTO.setDiscoverable(true);
    itemViewConfigDTO.setBuyable(false);
    itemResponse.setItemSku(ITEM_SKU);
    itemResponse.setItemViewConfigs(Collections.singleton(itemViewConfigDTO));
    productAndItemsResponse.setItems(Arrays.asList(itemResponse));

    imageQcProcessedResponse = new ImageQcProcessedResponse();
    imageQcProcessedResponse.setForceReview(true);

    itemFlagDetails = new ItemFlagDetails();
    itemFlagDetails.setBuyable(true);
    itemFlagDetails.setDisplayable(true);
    itemFlagDetails.setItemSku(ITEM_SKU);

    productSystemParameter = new ProductSystemParameter();
    productSystemParameter.setValue("1");
    productSystemParameter.setVariable(Constants.MINIMUM_PRICE);

    Mockito.doNothing().when(this.itemService).publishItemStatusEvent(DEFAULT_PRODUCT_CODE, ProductStatus.ACTIVE);

    categoryIds = new HashSet<>();
    categoryIds.add(ID);

    productMigration = new ProductMigration();
    productMigration.setProductCode(PRODUCT_CODE);
    productMigration.setGdnProductSku(PRODUCT_SKU);
    productMigration.setProductId(ID);
    productMigration.setMigratedProductId(ID1);
    productMigration.setMigratedProductCode(PRODUCT_CODE1);
    productMigration.setBusinessPartnerId(BUSINESS_PARTNER_ID);

    oldProductCollection = new ProductCollection();
    oldProductCollection.setProductId(ID);
    oldProductCollection.setBusinessPartnerCode(ID);
    oldProductCollection.setActivated(true);
    oldProductCollection.setViewable(true);

    Image image = new Image();
    image.setLocationPath(IMAGE_LOCATION_PATH_1);
    image.setHashCode(IMAGE_HASH_CODE_1);
    Image image1 = new Image();
    image1.setLocationPath(IMAGE_LOCATION_PATH_2);
    image1.setHashCode(IMAGE_HASH_CODE_2);
    Image image2 = new Image();
    image2.setLocationPath(IMAGE_LOCATION_PATH_3);
    image2.setHashCode(IMAGE_HASH_CODE_3);
    Image image3 = new Image();
    image3.setLocationPath(IMAGE_LOCATION_PATH_4);
    image3.setHashCode(IMAGE_HASH_CODE_4);
    imageList = Arrays.asList(image, image1, image2, image3);
    productImageQcFeedbackResponse = new ProductImageQcFeedbackResponse();
    productImageQcFeedbackResponse.setProductCode(PRODUCT_CODE);
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK);

    userFeedbackImageQcListResponse = new UserFeedbackImageQcListResponse();
    userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);

    pdtProductDomainEventModel = new PDTProductDomainEventModel();
    pdtProductDomainEventModel.setImages(new ArrayList<>());

    categoryResponse.setCategoryCode(CATEGORY_CODE);

    productDetailResponse.setImages(Arrays.asList(image));
    productDetailResponse.setDescription(new byte[1]);
    productDetailResponse.setCategoryCodes(Collections.singletonList(CATEGORY_CODE));

    autoApprovalTypeRequest =
      AutoApprovalTypeRequest.builder().categoryCode(CATEGORY_CODE).edited(false).reviewType(StringUtils.EMPTY).build();

    sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(OFFICIAL_SELLERS);
    sellerDetailResponse.setGoodSeller(true);

    autoApprovalRules = new AutoApprovalRules();
    autoApprovalRules.setRuleName(OFFICIAL_SELLERS);
    autoApprovalRules.setSequenceNumber(1);
    autoApprovalRules.setNeedRevisionEnabled(false);

    Mockito.when(objectMapper.writeValueAsString(Mockito.anyList())).thenReturn("[]");
    when(mandatoryParameterHelper.getStoreId()).thenReturn(STORE_ID);

    Mockito.when(productImagePredictionService.findByStoreIdAndMarkForDeleteFalse(STORE_ID)).thenReturn(Arrays
        .asList(ProductImagePrediction.builder().predictionType(ACTIVE_PREDICTIONS.get(0)).build(),
            ProductImagePrediction.builder().predictionType(ACTIVE_PREDICTIONS.get(1)).build(),
            ProductImagePrediction.builder().predictionType(ACTIVE_PREDICTIONS.get(2)).build(),
            ProductImagePrediction.builder().predictionType(ACTIVE_PREDICTIONS.get(3)).build()));

    validateDuplicateProductRequest.setByProductName(true);
    validateDuplicateProductRequest.setKeyword(PRODUCT_NAME);
    validateDuplicateProductRequest.setBySellerSku(true);

    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setProductName(PRODUCT_NAME);
    productBusinessPartner.setState(STATE);
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner.setId(ID);
    productBusinessPartnerList.add(productBusinessPartner);

    Mockito.doNothing().when(fileStorageService).editImageNameIfGcsEnabled(Mockito.any(ProductVariantUpdateRequest.class));

    keywordRestrictionModelsResponse = new KeywordRestrictionModelsResponse();
    KeywordRecommendationsResponse keywordRecommendationsResponse = new KeywordRecommendationsResponse();
    keywordRecommendationsResponse.setKeyword(KEYWORD);
    keywordRecommendationsResponse.setKeywordId(KEYWORD_ID);
    keywordRestrictionModelsResponse.setKeywordRecommendations(
        Collections.singletonList(keywordRecommendationsResponse));
    ReflectionTestUtils.setField(productServiceBean, "bpBopisRestrictionEnabled", Boolean.TRUE);

    Mockito.when(kafkaTopicProperties.getVendorCombinedEventNoPriority())
        .thenReturn(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT);
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(false);

  }

  public void setBusinessPartnerRepository(BusinessPartnerRepository businessPartnerRepository) {
    this.businessPartnerRepository = businessPartnerRepository;
  }

  public void setProductBusinessPartnerRepository(ProductBusinessPartnerRepository productBusinessPartnerRepository) {
    this.productBusinessPartnerRepository = productBusinessPartnerRepository;
  }

  public void setProductCollectionRepository(ProductCollectionRepository productCollectionRepository) {
    this.productCollectionRepository = productCollectionRepository;
  }

  public void setProductHistoryRepository(ProductHistoryRepository productHistoryRepository) {
    this.productHistoryRepository = productHistoryRepository;
  }

  public void setProductItemRepository(ProductItemRepository productItemRepository) {
    this.productItemRepository = productItemRepository;
  }

  public void setProductRepository(ProductRepository productRepository) {
    this.productRepository = productRepository;
  }

  public void setProductServiceBean(ProductServiceBean productServiceBean) {
    this.productServiceBean = productServiceBean;
  }

  public void setProductWorkflowRepository(ProductWorkflowRepository productWorkflowRepository) {
    this.productWorkflowRepository = productWorkflowRepository;
  }

  public void setSequenceRepository(SequenceRepository sequenceRepository) {
    this.sequenceRepository = sequenceRepository;
  }

  @Test
  public void testApprovedContent() throws Exception {
    Product product = getProduct();
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_APPROVED_CONTENT_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_CONTENT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(savedProductWorkflow);
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(productBusinessPartnerPage)).thenReturn(null);
    getProductServiceBean().approvedContent(DEFAULT_STORE_ID, product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(savedProductWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(productHistories);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, null, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getProductLevel3Service(), AT_LEAST_NONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).save(productBusinessPartner);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
  }

  @Test
  public void testApprovedContent_InventoryNull() throws Exception {
    Product product = getProduct();
    Catalog catalog = new Catalog("Master Katalog", null, CatalogType.MASTER_CATALOG, DEFAULT_STORE_ID);
    ProductCategory productCategory =
        new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Category 1", 0), DEFAULT_STORE_ID);
    productCategory.getCategory().setId(UUID.randomUUID().toString());
    productCategory.getCategory().setCatalog(catalog);
    product.getProductCategories().add(productCategory);

    ProductItem productItem1 = new ProductItem();
    productItem1.setId("product-item-1");
    ProductItem productItem2 = new ProductItem();
    productItem2.setId("product-item-2");

    product.getProductItems().add(productItem1);
    product.getProductItems().add(productItem2);

    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    productBusinessPartner.setProductItemBusinessPartners(null);

    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);

    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);

    businessPartner.setId(productBusinessPartner.getBusinessPartnerId());
    businessPartner.getCompany().setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BUSINESS_PARTNER);
    businessPartner.getCompany().setPurchaseTerm(GdnBaseLookup.PURCHASE_TERM_COMMISSION);

    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);

    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);

    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_APPROVED_CONTENT_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_CONTENT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, ProductWorkflowLookup.STATE_ACTIVE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);

    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(savedProductWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(productBusinessPartnerPage)).thenReturn(null);
    Mockito.when(getBusinessPartnerRepository().filterByCode(productBusinessPartner.getBusinessPartnerId()))
        .thenReturn(businessPartner);
    Mockito.doNothing().when(getProductLevel3Service())
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.when(getProductBusinessPartnerRepository().save(productBusinessPartner)).thenReturn(productBusinessPartner);

    getProductServiceBean().approvedContent(DEFAULT_STORE_ID, product);

    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(Mockito.any());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, null, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE)
        .filterByCode(productBusinessPartner.getBusinessPartnerId());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_ONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).save(productBusinessPartner);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
  }


  @Test
  public void testApprovedContent_ProductItemNull() throws Exception {
    Product product = getProduct();
    Catalog catalog = new Catalog("Master Katalog", null, CatalogType.MASTER_CATALOG, DEFAULT_STORE_ID);
    ProductCategory productCategory =
        new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Category 1", 0), DEFAULT_STORE_ID);
    productCategory.getCategory().setId(UUID.randomUUID().toString());
    productCategory.getCategory().setCatalog(catalog);
    product.getProductCategories().add(productCategory);

    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();

    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);

    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);

    businessPartner.setId(productBusinessPartner.getBusinessPartnerId());
    businessPartner.getCompany().setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BUSINESS_PARTNER);
    businessPartner.getCompany().setPurchaseTerm(GdnBaseLookup.PURCHASE_TERM_COMMISSION);

    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);

    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);

    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_APPROVED_CONTENT_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_CONTENT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, ProductWorkflowLookup.STATE_ACTIVE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);

    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(savedProductWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(productBusinessPartnerPage)).thenReturn(null);
    Mockito.when(getBusinessPartnerRepository().filterByCode(productBusinessPartner.getBusinessPartnerId()))
        .thenReturn(businessPartner);
    Mockito.doNothing().when(getProductLevel3Service())
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.when(getProductBusinessPartnerRepository().save(productBusinessPartner)).thenReturn(productBusinessPartner);

    getProductServiceBean().approvedContent(DEFAULT_STORE_ID, product);

    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(Mockito.anyList());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, null, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE)
        .filterByCode(productBusinessPartner.getBusinessPartnerId());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_ONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).save(productBusinessPartner);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
  }

  @Test
  public void testApprovedContentAndActivate() throws Exception {
    Product product = getProduct();
    Catalog catalog = new Catalog("Master Katalog", null, CatalogType.MASTER_CATALOG, DEFAULT_STORE_ID);
    ProductCategory productCategory =
        new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Category 1", 0), DEFAULT_STORE_ID);
    productCategory.getCategory().setId(UUID.randomUUID().toString());
    productCategory.getCategory().setCatalog(catalog);
    product.getProductCategories().add(productCategory);
    ProductItem productItem1 = new ProductItem();
    productItem1.setId("product-item-1");
    ProductItem productItem2 = new ProductItem();
    productItem2.setId("product-item-2");
    product.getProductItems().add(productItem1);
    product.getProductItems().add(productItem2);
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    businessPartner.setId(productBusinessPartner.getBusinessPartnerId());
    businessPartner.getCompany().setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BUSINESS_PARTNER);
    businessPartner.getCompany().setPurchaseTerm(GdnBaseLookup.PURCHASE_TERM_COMMISSION);
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_APPROVED_CONTENT_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_CONTENT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, ProductWorkflowLookup.STATE_ACTIVE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(true);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(savedProductWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(productBusinessPartnerPage)).thenReturn(null);
    Mockito.when(getBusinessPartnerRepository().filterByCode(productBusinessPartner.getBusinessPartnerId()))
        .thenReturn(businessPartner);
    Mockito.doNothing().when(getProductLevel3Service())
        .create(Mockito.anyString(), Mockito.any(), Mockito.any());
    Mockito.when(getProductBusinessPartnerRepository().save(productBusinessPartner)).thenReturn(productBusinessPartner);
    getProductServiceBean().approvedContent(DEFAULT_STORE_ID, product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(anyList());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, null, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE)
        .filterByCode(productBusinessPartner.getBusinessPartnerId());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_ONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductLevel3InventoryService(), AT_LEAST_ONE)
        .insertInventory(argumentCaptorProductLevel3InventoryList.capture());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).save(productBusinessPartner);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU, argumentCaptorProductLevel3InventoryList.getValue().get(0).getProductSku());
  }

  @Test
  public void testApprovedContentAndActivate_1() throws Exception {
    Product product = getProduct();
    Catalog catalog = new Catalog("Master Katalog", null, CatalogType.MASTER_CATALOG, DEFAULT_STORE_ID);
    ProductCategory productCategory =
        new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Category 1", 0), DEFAULT_STORE_ID);
    productCategory.getCategory().setId(UUID.randomUUID().toString());
    productCategory.getCategory().setCatalog(catalog);
    product.getProductCategories().add(productCategory);
    ProductItem productItem1 = new ProductItem();
    productItem1.setId("product-item-1");
    ProductItem productItem2 = new ProductItem();
    productItem2.setId("product-item-2");
    product.getProductItems().add(productItem1);
    product.getProductItems().add(productItem2);
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    businessPartner.setId(productBusinessPartner.getBusinessPartnerId());
    businessPartner.getCompany().setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BLIBLI);
    businessPartner.getCompany().setPurchaseTerm(GdnBaseLookup.PURCHASE_TERM_PURCHASE_ORDER);
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_APPROVED_CONTENT_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_CONTENT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, ProductWorkflowLookup.STATE_ACTIVE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(preOrderConfig.isPoQuotaFeatureSwitch()).thenReturn(true);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(savedProductWorkflow);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(productBusinessPartnerPage)).thenReturn(null);
    Mockito.when(getBusinessPartnerRepository().filterByCode(productBusinessPartner.getBusinessPartnerId()))
        .thenReturn(businessPartner);
    Mockito.doNothing().when(getProductLevel3Service())
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.when(getProductBusinessPartnerRepository().save(productBusinessPartner)).thenReturn(productBusinessPartner);
    getProductServiceBean().approvedContent(DEFAULT_STORE_ID, product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(productHistories);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, null, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE)
        .filterByCode(productBusinessPartner.getBusinessPartnerId());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_ONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductLevel3InventoryService(), AT_LEAST_ONE)
        .insertInventory(Mockito.anyList());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).save(productBusinessPartner);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
  }

  @Test
  public void testApprovedContentWithInvalidProductId() throws Exception {
    Product product = getProduct();
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_APPROVED_CONTENT_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_CONTENT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);
    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().approvedContent(DEFAULT_STORE_ID, product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationException) {
        ApplicationException applicationException = (ApplicationException) e;
        Assertions.assertEquals(ErrorCategory.DATA_NOT_FOUND, applicationException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(savedProductWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).update(product, null, false, true, false,
        new ArrayList<>(), new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(),
        new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_NONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).save(productBusinessPartner);
  }

  @Test
  public void testApprovedContentWithInvalidStateCheckpointOne() throws Exception {
    Product product = getProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    savedProductWorkflows.add(savedProductWorkflow);
    savedProductWorkflows.add(savedProductWorkflow);
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_APPROVED_CONTENT_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_CONTENT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    try {
      assertThrows(ApplicationRuntimeException.class, () -> {
        getProductServiceBean().approvedContent(DEFAULT_STORE_ID, product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationRuntimeException) {
        ApplicationRuntimeException applicationRuntimeException = (ApplicationRuntimeException) e;
        Assertions.assertEquals(ErrorCategory.INVALID_STATE, applicationRuntimeException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(savedProductWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).update(product, null, false, true, false,
        new ArrayList<>(), new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(),
        new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_NONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).save(productBusinessPartner);
  }

  @Test
  public void testApprovedContentWithInvalidStateCheckpointTwo() throws Exception {
    Product product = getProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_APPROVED_CONTENT_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_CONTENT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    try {
      assertThrows(ApplicationRuntimeException.class, () -> {
        getProductServiceBean().approvedContent(DEFAULT_STORE_ID, product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationRuntimeException) {
        ApplicationRuntimeException applicationRuntimeException = (ApplicationRuntimeException) e;
        Assertions.assertEquals(ErrorCategory.INVALID_STATE, applicationRuntimeException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(savedProductWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).update(product,null, false, true, false,
        new ArrayList<>(), new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(),
        new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_NONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).save(productBusinessPartner);

  }

  @Test
  public void testApprovedImage() throws Exception {
    Product product = getProduct();
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
            ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_APPROVED_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_IMAGE_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(savedProductWorkflow);
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(productBusinessPartnerPage)).thenReturn(null);
    getProductServiceBean().approvedImage(DEFAULT_STORE_ID, product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(savedProductWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(Mockito.anyList());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, null, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_NONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).save(productBusinessPartner);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(productBusinessPartnerPage);
  }

  @Test
  public void testApprovedImageAndActivate() throws Exception {
    Product product = getProduct();
    Catalog catalog = new Catalog("Master Katalog", null, CatalogType.MASTER_CATALOG, DEFAULT_STORE_ID);
    ProductCategory productCategory =
        new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Category 1", 0), DEFAULT_STORE_ID);
    productCategory.getCategory().setId(UUID.randomUUID().toString());
    productCategory.getCategory().setCatalog(catalog);
    product.getProductCategories().add(productCategory);
    ProductItem productItem1 = new ProductItem();
    productItem1.setId("product-item-1");
    ProductItem productItem2 = new ProductItem();
    productItem2.setId("product-item-2");
    product.getProductItems().add(productItem1);
    product.getProductItems().add(productItem2);
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    businessPartner.setId(productBusinessPartner.getBusinessPartnerId());
    businessPartner.getCompany().setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BLIBLI);
    businessPartner.getCompany().setPurchaseTerm(GdnBaseLookup.PURCHASE_TERM_COMMISSION);
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
            ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_APPROVED_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_IMAGE_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, ProductWorkflowLookup.STATE_ACTIVE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(savedProductWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(getProductHistoryRepository().saveAll(eq(productHistories))).thenReturn(productHistories);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(productBusinessPartnerPage)).thenReturn(null);
    Mockito.when(getBusinessPartnerRepository().filterByCode(productBusinessPartner.getBusinessPartnerId()))
        .thenReturn(businessPartner);
    Mockito.doNothing().when(getProductLevel3Service())
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.when(getProductBusinessPartnerRepository().save(productBusinessPartner)).thenReturn(productBusinessPartner);
    getProductServiceBean().approvedImage(DEFAULT_STORE_ID, product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(any(List.class));
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, null, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE)
        .filterByCode(productBusinessPartner.getBusinessPartnerId());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_ONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductLevel3InventoryService(), AT_LEAST_ONE)
        .insertInventory(Mockito.anyList());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).save(productBusinessPartner);
  }

  @Test
  public void testApprovedImage_InventoryNull() throws Exception {
    Product product = getProduct();
    Catalog catalog = new Catalog("Master Katalog", null, CatalogType.MASTER_CATALOG, DEFAULT_STORE_ID);
    ProductCategory productCategory =
        new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Category 1", 0), DEFAULT_STORE_ID);
    productCategory.getCategory().setId(UUID.randomUUID().toString());
    productCategory.getCategory().setCatalog(catalog);
    product.getProductCategories().add(productCategory);

    ProductItem productItem1 = new ProductItem();
    productItem1.setId("product-item-1");
    ProductItem productItem2 = new ProductItem();
    productItem2.setId("product-item-2");

    product.getProductItems().add(productItem1);
    product.getProductItems().add(productItem2);

    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    productBusinessPartner.setProductItemBusinessPartners(null);

    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    businessPartner.setId(productBusinessPartner.getBusinessPartnerId());
    businessPartner.getCompany().setInventoryFulfillment(GdnBaseLookup.INVENTORY_FULFILLMENT_BLIBLI);
    businessPartner.getCompany().setPurchaseTerm(GdnBaseLookup.PURCHASE_TERM_COMMISSION);
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
            ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_APPROVED_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_IMAGE_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_ACTIVE,
        ProductWorkflowLookup.STATE_ACTIVE_DESCRIPTION, ProductWorkflowLookup.STATE_ACTIVE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(savedProductWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(getProductHistoryRepository().saveAll(Mockito.anyList())).thenReturn(productHistories);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(productBusinessPartnerPage)).thenReturn(null);
    Mockito.when(getBusinessPartnerRepository().filterByCode(productBusinessPartner.getBusinessPartnerId()))
        .thenReturn(businessPartner);
    Mockito.doNothing().when(getProductLevel3Service())
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.when(getProductBusinessPartnerRepository().save(productBusinessPartner)).thenReturn(productBusinessPartner);

    getProductServiceBean().approvedImage(DEFAULT_STORE_ID, product);

    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(productHistories);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, null, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE)
        .filterByCode(productBusinessPartner.getBusinessPartnerId());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_ONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).save(productBusinessPartner);

  }

  @Test
  public void testApprovedImageWithInvalidProductId() throws Exception {
    Product product = getProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
            ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_APPROVED_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_IMAGE_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);
    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().approvedImage(DEFAULT_STORE_ID, product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationException) {
        ApplicationException applicationException = (ApplicationException) e;
        Assertions.assertEquals(ErrorCategory.DATA_NOT_FOUND, applicationException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(savedProductWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).update(product, null, false, true, false,
        new ArrayList<>(), new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(),
        new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_NONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).save(productBusinessPartner);
  }

  @Test
  public void testApprovedImageWithInvalidStateCheckpointOne() throws Exception {
    Product product = getProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
            ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    savedProductWorkflows.add(savedProductWorkflow);
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_APPROVED_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_IMAGE_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    try {
      assertThrows(ApplicationRuntimeException.class, () -> {
        getProductServiceBean().approvedImage(DEFAULT_STORE_ID, product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationRuntimeException) {

        ApplicationRuntimeException applicationRuntimeException = (ApplicationRuntimeException) e;
        Assertions.assertEquals(ErrorCategory.INVALID_STATE, applicationRuntimeException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(savedProductWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).update(product, null, false, true, false,
        new ArrayList<>(), new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(),
        new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_NONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).save(productBusinessPartner);
  }

  @Test
  public void getProductCollectionFromSolrTest() throws Exception {
    SolrProductCollectionDTO solrProductCollectionDTO =
        new SolrProductCollectionDTO.Builder().setId("id-1").setProductCode("prd-1").setProductId("pid-1")
            .setBrand("brand-1").setBusinessPartnerCode("bp-code-1").setBusinessPartnerName("bp-name-1")
            .setCreatedBy("viraj").setCreatedDate(Calendar.getInstance().getTime()).build();
    Page<SolrProductCollectionDTO> solrProductCollectionDTOPage =
        new PageImpl<>(Arrays.asList(solrProductCollectionDTO));
    Mockito.when(this.solrActiveProductCollectionRepository
        .getProductCollectionListFromSolrCollection(Mockito.any(), Mockito.any(), Mockito.any(),
            Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(solrProductCollectionDTOPage);
    Page<SolrProductCollectionDTO> solrProductCollectionDTOResponse = this.productServiceBean
        .getActiveProductCollectionFromSolr(DEFAULT_STORE_ID, KEYWORD, this.DEFAULT_CATEGORY_CODE, null,
            DEFAULT_SORT_TYPE, PageRequest.of(0, 10));
    Mockito.verify(this.solrActiveProductCollectionRepository)
        .getProductCollectionListFromSolrCollection(DEFAULT_STORE_ID, KEYWORD, DEFAULT_CATEGORY_CODE, null,
            DEFAULT_SORT_TYPE, PageRequest.of(0, 10));
    assertEquals(1, solrProductCollectionDTOResponse.getContent().size());
    Assertions.assertEquals(solrProductCollectionDTOResponse.getContent().get(0).getId(), "id-1");
  }

  @Test
  public void testGetProductCountByViewable() throws Exception {
    Mockito.when(this.solrActiveProductCollectionRepository.getProductCountByStoreId(Mockito.anyString()))
        .thenReturn(1);
    Integer productCount = this.productServiceBean.getProductCountByViewable(DEFAULT_STORE_ID, true);
    Mockito.verify(this.solrActiveProductCollectionRepository).getProductCountByStoreId(DEFAULT_STORE_ID);
    Assertions.assertEquals(1, productCount);
  }

  @Test
  public void testGetProductCountByViewableStoreIdNull() throws Exception {
    Mockito.when(this.solrActiveProductCollectionRepository.getProductCountByStoreId(Mockito.anyString()))
        .thenReturn(1);
    try {
      Integer productCount = this.productServiceBean.getProductCountByViewable(null, true);
    } catch (Exception e) {
      Assertions.assertTrue(e instanceof ApplicationRuntimeException);
      Assertions.assertTrue(e.getMessage().contains("null"));
    }
  }

  @Test
  public void testGetProductCountByViewableStoreIdEmpty() throws Exception {
    Mockito.when(this.solrActiveProductCollectionRepository.getProductCountByStoreId(Mockito.anyString()))
        .thenReturn(1);
    try {
      Integer productCount = this.productServiceBean.getProductCountByViewable("", true);
    } catch (Exception e) {
      Assertions.assertTrue(e instanceof ApplicationRuntimeException);
      Assertions.assertTrue(e.getMessage().contains("Incomplete required parameter data"));
    }
  }

  @Test
  public void testApprovedImageWithInvalidStateCheckpointTwo() throws Exception {
    Product product = getProduct();
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
            ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_APPROVED_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_APPROVED_IMAGE_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    try {
      assertThrows(ApplicationRuntimeException.class, () -> {
        getProductServiceBean().approvedImage(DEFAULT_STORE_ID, product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationRuntimeException) {
        ApplicationRuntimeException applicationRuntimeException = (ApplicationRuntimeException) e;
        Assertions.assertEquals(ErrorCategory.INVALID_STATE, applicationRuntimeException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(savedProductWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).update(product, null, false, true, false,
        new ArrayList<>(), new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(),
        new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (Pageable) Mockito.any());
    Mockito.verify(getProductLevel3Service(), AT_LEAST_NONE)
        .create(Mockito.anyString(), (Product) Mockito.any(), (ProductBusinessPartner) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).save(productBusinessPartner);
  }

  @Test
  public void testDelete() throws Exception {
    ProductDetailResponse product = getProductDetailResponse();
    Product product1 = getProduct();
    ResponsiblePerson responsiblePerson = new ResponsiblePerson();
    responsiblePerson.setEmail("email");
    businessPartner.setId("business-partner-1");
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(new ProductBusinessPartner("business-partner-1", "product-1", "BP1-00001-00001",
        new ArrayList<ProductItemBusinessPartner>(), new ArrayList<ProductBusinessPartnerAttribute>(), DEFAULT_USERNAME,
        Calendar.getInstance().getTime(), DEFAULT_STORE_ID));
    productBusinessPartners.get(0).setProductItemBusinessPartners(new ArrayList<ProductItemBusinessPartner>());
    productBusinessPartners.get(0)
        .setProductBusinessPartnerAttributes(new ArrayList<ProductBusinessPartnerAttribute>());
    productBusinessPartners.get(0).getProductItemBusinessPartners().add(new ProductItemBusinessPartner());
    productBusinessPartners.get(0).getProductItemBusinessPartners().get(0)
        .setProductItemId(product.getProductItemResponses().iterator().next().getId());
    productBusinessPartners.get(0).getProductBusinessPartnerAttributes().add(new ProductBusinessPartnerAttribute());
    Page<ProductBusinessPartner> page = new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    Mockito.when(getProductRepository().findDetailById(product.getId())).thenReturn(product);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any())).thenReturn(page);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(page)).thenReturn(productBusinessPartners);

    getProductServiceBean().delete(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findDetailById(product.getId());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(page);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).delete(product);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(emailNotificationService).sendEmailDeleteProductBusinessPartner(Mockito.eq(product),
        productBusinessPartnerResponsePageArgumentCaptor.capture(), Mockito.eq(null), Mockito.eq(null));
  }

  @Test
  public void testDelete_WithSendQueueException() throws Exception {
    ProductDetailResponse product = getProductDetailResponse();
    Product product1 = getProduct();
    ResponsiblePerson responsiblePerson = new ResponsiblePerson();
    responsiblePerson.setEmail("email");
    businessPartner.setId("business-partner-1");
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(new ProductBusinessPartner("business-partner-1", "product-1", "BP1-00001-00001",
        new ArrayList<ProductItemBusinessPartner>(), new ArrayList<ProductBusinessPartnerAttribute>(), DEFAULT_USERNAME,
        Calendar.getInstance().getTime(), DEFAULT_STORE_ID));
    productBusinessPartners.get(0).setProductItemBusinessPartners(new ArrayList<ProductItemBusinessPartner>());
    productBusinessPartners.get(0)
        .setProductBusinessPartnerAttributes(new ArrayList<ProductBusinessPartnerAttribute>());
    productBusinessPartners.get(0).getProductItemBusinessPartners().add(new ProductItemBusinessPartner());
    productBusinessPartners.get(0).getProductItemBusinessPartners().get(0)
        .setProductItemId(product.getProductItemResponses().iterator().next().getId());
    productBusinessPartners.get(0).getProductBusinessPartnerAttributes().add(new ProductBusinessPartnerAttribute());
    Page<ProductBusinessPartner> page = new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    Mockito.when(getProductRepository().findDetailById(product.getId())).thenReturn(product);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any())).thenReturn(page);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(page)).thenReturn(productBusinessPartners);
    Mockito.doThrow(RuntimeException.class).when(kafkaProducer)
        .send(Mockito.anyString(), Mockito.anyString(), Mockito.any(MessageEmailRequest.class));
    getProductServiceBean().delete(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findDetailById(product.getId());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(page);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).delete(product);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(emailNotificationService).sendEmailDeleteProductBusinessPartner(Mockito.eq(product),
        productBusinessPartnerResponsePageArgumentCaptor.capture(), Mockito.eq(null), Mockito.eq(null));
  }

  @Test
  public void testDeleteWithInvalidProductId() throws Exception {
    Product product = getProduct();
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(new ProductBusinessPartner("business-partner-1", "product-1", "BP1-00001-00001",
        new ArrayList<ProductItemBusinessPartner>(), new ArrayList<ProductBusinessPartnerAttribute>(), DEFAULT_USERNAME,
        Calendar.getInstance().getTime(), DEFAULT_STORE_ID));
    Page<ProductBusinessPartner> page = new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);
    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().delete(product.getId());
      });
    } catch (Exception e) {
      if (e instanceof ApplicationException) {

        ApplicationException applicationException = (ApplicationException) e;
        Assertions.assertEquals(ErrorCategory.DATA_NOT_FOUND, applicationException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findDetailById(product.getId());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(page);
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).update(product, null, false, true, false,
        new ArrayList<>(), new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(),
        new ProductL3Response(), EditProductResponse.builder().build());
  }

  @Test
  public void testDeleteProductWith3Parameters() throws Exception {
    Mockito.when(getProductRepository().findProductDetailByProductCode(this.savedProduct.getProductCode()))
        .thenReturn(this.savedProduct);
    Mockito.when(getProductRepository().findProductDetailByProductCode(this.savedProduct.getProductCode(), false))
        .thenReturn(this.savedProduct);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID),
            Mockito.eq(this.savedProduct.getId()), (PageRequest) Mockito.any()))
        .thenReturn(this.productBusinessPartnerPage);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(this.savedProduct.getStoreId(), this.savedProduct.getId(),
            this.pageable)).thenReturn(this.productWorkflowPage);
    Mockito.doNothing().when(getProductWorkflowRepository()).deleteAll(this.productWorkflowPage);
    Mockito.when(getProductWorkflowRepository().saveAndFlush((ProductWorkflow) Mockito.any())).thenReturn(null);
    Mockito.when(getProductHistoryRepository().saveAndFlush((ProductHistory) Mockito.any())).thenReturn(null);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(this.productBusinessPartnerPage))
        .thenReturn(this.productBusinessPartners);
    Mockito.doNothing().when(getProductRepository()).delete((ProductDetailResponse) Mockito.any());

    getProductServiceBean().delete(this.savedProduct.getProductCode(), "TEST", "state");

    Mockito.verify(getProductRepository(), AT_LEAST_ONE)
        .findProductDetailByProductCode(this.savedProduct.getProductCode());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID),
            Mockito.eq(this.savedProduct.getId()), (PageRequest) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(this.savedProduct.getStoreId(), this.savedProduct.getId(),
            this.pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).deleteAll(this.productWorkflowPage);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush((ProductWorkflow) Mockito.any());
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAndFlush((ProductHistory) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(this.productBusinessPartnerPage);
    Mockito.verify(emailNotificationService).sendEmailDeleteProductBusinessPartner(
        productDetailResponseArgumentCaptor.capture(),
        productBusinessPartnerResponsePageArgumentCaptor.capture(), Mockito.eq("TEST"), Mockito.eq(null));
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).delete((ProductDetailResponse) Mockito.any());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
  }

  @Test
  public void testDeleteProductWith4ParametersProductCollectionNull() throws Exception {
    try {
      Mockito.when(getProductRepository().findProductDetailByProductCode(this.savedProduct.getProductCode()))
          .thenReturn(this.savedProduct);
      Mockito.when(getProductBusinessPartnerRepository()
          .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID),
              Mockito.eq(this.savedProduct.getId()), (PageRequest) Mockito.any()))
          .thenReturn(this.productBusinessPartnerPage);
      Mockito.when(getProductBusinessPartnerRepository().saveAll(this.productBusinessPartnerPage))
          .thenReturn(this.productBusinessPartners);
      Mockito.when(getProductCollectionRepository()
          .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString())).thenReturn(null);
      Mockito.doNothing().when(getProductRepository()).delete((ProductDetailResponse) Mockito.any());

      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().delete(this.savedProduct.getProductCode(), PRODUCT_NAME, "TEST", "state");
      });
    } catch (ApplicationException Ae) {
      throw new ApplicationException(ErrorCategory.DATA_NOT_FOUND, "Product collection not found");
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE)
        .findProductDetailByProductCode(this.savedProduct.getProductCode());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID),
            Mockito.eq(this.savedProduct.getId()), (PageRequest) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(this.productBusinessPartnerPage);
    Mockito.verify(emailNotificationService).sendEmailDeleteProductBusinessPartner(
        productDetailResponseArgumentCaptor.capture(),
        productBusinessPartnerResponsePageArgumentCaptor.capture(), Mockito.eq("TEST"), Mockito.eq(PRODUCT_NAME));
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
  }


  @Test
  public void retryDeleteProductwithIDNull() throws Exception {
    assertThrows(ApplicationException.class, () -> {
      getProductServiceBean().retryDelete(null, DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, true);
    });
  }

  @Test
  public void retryDeleteProductwithStoreIDNull() throws Exception {
    assertThrows(ApplicationException.class, () -> {
      getProductServiceBean().retryDelete(DEFAULT_PRODUCT_ID, null, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, true);
    });
  }

  @Test
  public void retryDeleteProductwithProductCodeNull() throws Exception {
    assertThrows(ApplicationException.class, () -> {
      getProductServiceBean().retryDelete(DEFAULT_PRODUCT_ID, DEFAULT_STORE_ID, null, DEFAULT_PRODUCT_NAME, true);
    });
  }

  @Test
  public void retryDeleteProductwithIsMarkForDeleteNull() throws Exception {
    assertThrows(ApplicationException.class, () -> {
      getProductServiceBean()
          .retryDelete(DEFAULT_PRODUCT_ID, DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, null);
    });
  }


  @Test
  public void retryDeleteProduct() throws Exception {
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000)))
        .thenReturn(this.productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(this.productBusinessPartnerPage))
        .thenReturn(this.productBusinessPartners);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(this.productCollection);

    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10)))
        .thenReturn(this.productWorkflowPage);


    getProductServiceBean()
        .retryDelete(DEFAULT_PRODUCT_ID, DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, true);

    Mockito.verify(getProductBusinessPartnerRepository())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000));
    Mockito.verify(getProductBusinessPartnerRepository(), Mockito.atLeastOnce()).saveAll(this.productBusinessPartnerPage);
    Mockito.verify(getProductCollectionRepository(), Mockito.times(1))
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);

    Mockito.verify(getProductWorkflowRepository(), Mockito.atLeastOnce())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10));
    Mockito.verify(getProductWorkflowRepository(), Mockito.atLeastOnce()).deleteAll(any(Page.class));
    Mockito.verify(getProductWorkflowRepository(), Mockito.atLeastOnce()).saveAndFlush(any(ProductWorkflow.class));
    Mockito.verify(getProductHistoryRepository(), Mockito.atLeastOnce()).saveAndFlush(any(ProductHistory.class));
  }

  @Test
  public void retryDeleteProducMarkForDeleteFalse() throws Exception {
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000)))
        .thenReturn(this.productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(this.productBusinessPartnerPage))
        .thenReturn(this.productBusinessPartners);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(this.productCollection);

    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10)))
        .thenReturn(this.productWorkflowPage);
    this.productCollection.setMarkForDelete(false);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.anyString(), anyString()))
        .thenReturn(this.productCollection);

    getProductServiceBean()
        .retryDelete(DEFAULT_PRODUCT_ID, DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, false);

    Mockito.verify(getProductBusinessPartnerRepository())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000));
    Mockito.verify(getProductBusinessPartnerRepository(), Mockito.atLeastOnce()).saveAll(this.productBusinessPartnerPage);
    Mockito.verify(getProductCollectionRepository(), Mockito.times(1))
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);

    Mockito.verify(getProductWorkflowRepository(), Mockito.atLeastOnce())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10));
    Mockito.verify(getProductWorkflowRepository(), Mockito.atLeastOnce()).deleteAll(any(Page.class));
    Mockito.verify(getProductWorkflowRepository(), Mockito.atLeastOnce()).saveAndFlush(any(ProductWorkflow.class));
    Mockito.verify(getProductHistoryRepository(), Mockito.atLeastOnce()).saveAndFlush(any(ProductHistory.class));
  }


  @Test
  public void retryDeleteProducMarkForDeleteFalseActivatedAndViewable() throws Exception {
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000)))
        .thenReturn(this.productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(this.productBusinessPartnerPage))
        .thenReturn(this.productBusinessPartners);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(this.productCollection);

    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10)))
        .thenReturn(this.productWorkflowPage);
    this.productCollection.setMarkForDelete(true);
    this.productCollection.setActivated(true);
    this.productCollection.setViewable(true);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.anyString(), anyString()))
        .thenReturn(this.productCollection);

    getProductServiceBean()
        .retryDelete(DEFAULT_PRODUCT_ID, DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, true);

    Mockito.verify(getProductBusinessPartnerRepository())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000));
    Mockito.verify(getProductBusinessPartnerRepository(), Mockito.atLeastOnce()).saveAll(this.productBusinessPartnerPage);
    Mockito.verify(getProductCollectionRepository(), Mockito.times(1))
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);

    Mockito.verify(getProductWorkflowRepository(), Mockito.atLeastOnce())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10));
    Mockito.verify(getProductWorkflowRepository(), Mockito.atLeastOnce()).deleteAll(any(Page.class));
    Mockito.verify(getProductWorkflowRepository(), Mockito.atLeastOnce()).saveAndFlush(any(ProductWorkflow.class));
    Mockito.verify(getProductHistoryRepository(), Mockito.atLeastOnce()).saveAndFlush(any(ProductHistory.class));
    Mockito.verify(this.solrActiveProductCollectionService)
        .deleteSolrProductCollectionDocument(this.productCollection.getId());
  }

  @Test
  public void retryDeleteProductWithNullException() throws Exception {
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000)))
        .thenReturn(this.productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(this.productBusinessPartnerPage))
        .thenReturn(this.productBusinessPartners);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenThrow(RuntimeException.class);

    getProductServiceBean()
        .retryDelete(DEFAULT_PRODUCT_ID, DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, true);

    Mockito.verify(getProductBusinessPartnerRepository())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000));
    Mockito.verify(getProductCollectionRepository())
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(getProductBusinessPartnerRepository(), Mockito.atLeastOnce()).saveAll(this.productBusinessPartnerPage);
  }

  @Test
  public void retryDeleteProductWithNullProduct() throws Exception {
    this.productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    this.productBusinessPartnerPage = new PageImpl<ProductBusinessPartner>(this.productBusinessPartners);

    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000)))
        .thenReturn(this.productBusinessPartnerPage);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(this.productBusinessPartnerPage))
        .thenReturn(this.productBusinessPartners);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenThrow(NullPointerException.class);

    getProductServiceBean()
        .retryDelete(DEFAULT_PRODUCT_ID, DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, true);

    Mockito.verify(getProductBusinessPartnerRepository())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 1000));
    Mockito.verify(getProductCollectionRepository())
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(getProductBusinessPartnerRepository(), Mockito.never()).saveAll(this.productBusinessPartnerPage);
  }

  @Test
  public void deleteProductBusinessPartnerForPostLiveRejectionTest() throws Exception {
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10)))
        .thenReturn(this.productWorkflowPage);
    Mockito.doNothing().when(this.productLevel3AggregatorService)
        .delete(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyList());
    getProductServiceBean().deleteProductBusinessPartnerForPostLiveRejection(productBusinessPartners, productCollection, NOTES);
    Mockito.verify(productBusinessPartnerRepository).saveAll(productBusinessPartnerListCaptor.capture());
    Mockito.verify(productWorkflowRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10));
    Mockito.verify(productWorkflowRepository).deleteAll(productWorkflowPageCaptor.capture());
    Mockito.verify(productWorkflowRepository).saveAndFlush(productWorkflowArgumentCaptor.capture());
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productLevel3AggregatorService).delete(Mockito.eq(DEFAULT_STORE_ID), listArgumentCaptor.capture());
    assertEquals(ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION,
        productWorkflowPageCaptor.getAllValues().get(0).getContent().get(0).getDescription());
    Assertions.assertTrue(productBusinessPartnerListCaptor.getValue().get(0).isMarkForDelete());
    assertEquals(STATE_DELETED, productBusinessPartnerListCaptor.getValue().get(0).getState());
    assertEquals(4, productWorkflowArgumentCaptor.getValue().getState());
    assertEquals(NOTES, productWorkflowArgumentCaptor.getValue().getNotes());
    assertEquals(NOTES, productHistoryArgumentCaptor.getValue().getNotes());
    assertEquals(4, productHistoryArgumentCaptor.getValue().getState());
    assertEquals(DEFAULT_GDN_SKU, listArgumentCaptor.getValue().get(0));
  }

  @Test
  public void deleteProductBusinessPartnerForAppealedProductTest() throws Exception {
    productBusinessPartners.get(0).setAppealedProduct(true);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10)))
      .thenReturn(this.productWorkflowPage);
    Mockito.doNothing().when(this.productLevel3AggregatorService)
      .delete(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyList());
    getProductServiceBean().deleteProductBusinessPartnerForPostLiveRejection(productBusinessPartners, productCollection, NOTES);
    Mockito.verify(productBusinessPartnerRepository).saveAll(productBusinessPartnerListCaptor.capture());
    Mockito.verify(productWorkflowRepository)
      .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, PageRequest.of(0, 10));
    Mockito.verify(productWorkflowRepository).deleteAll(productWorkflowPageCaptor.capture());
    Mockito.verify(productWorkflowRepository).saveAndFlush(productWorkflowArgumentCaptor.capture());
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productLevel3AggregatorService).delete(Mockito.eq(DEFAULT_STORE_ID), listArgumentCaptor.capture());
    Mockito.verify(productAppealService).decrementCounterForProductAppeal(DEFAULT_STORE_ID, BP_CODE);
    assertEquals(ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION,
      productWorkflowPageCaptor.getAllValues().get(0).getContent().get(0).getDescription());
    Assertions.assertTrue(productBusinessPartnerListCaptor.getValue().get(0).isMarkForDelete());
    assertEquals(STATE_DELETED, productBusinessPartnerListCaptor.getValue().get(0).getState());
    assertEquals(4, productWorkflowArgumentCaptor.getValue().getState());
    assertEquals(NOTES, productWorkflowArgumentCaptor.getValue().getNotes());
    assertEquals(NOTES, productHistoryArgumentCaptor.getValue().getNotes());
    assertEquals(4, productHistoryArgumentCaptor.getValue().getState());
    assertEquals(DEFAULT_GDN_SKU, listArgumentCaptor.getValue().get(0));
  }


  @Test
  public void testDeleteWithoutProductBusinessPartners() throws Exception {
    ProductDetailResponse product = getProductDetailResponse();
    Page<ProductBusinessPartner> page = new PageImpl<ProductBusinessPartner>(new ArrayList<ProductBusinessPartner>());
    Mockito.when(getProductRepository().findDetailById(product.getId())).thenReturn(product);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any())).thenReturn(page);
    getProductServiceBean().delete(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findDetailById(product.getId());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(page);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).delete(product);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
  }

  @Test
  public void testDeleteWithoutProductBusinessPartnersWithActivatedAndViewable() throws Exception {
    ProductDetailResponse product = getProductDetailResponse();
    product.setActivated(true);
    product.setViewable(true);
    Page<ProductBusinessPartner> page = new PageImpl<ProductBusinessPartner>(new ArrayList<ProductBusinessPartner>());
    Mockito.when(getProductRepository().findDetailById(product.getId())).thenReturn(product);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any())).thenReturn(page);
    getProductServiceBean().delete(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findDetailById(product.getId());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(page);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).delete(product);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(this.solrActiveProductCollectionService).deleteSolrProductCollectionDocument(Mockito.any());
  }

  @Test
  public void testDeleteWithoutProductBusinessPartnersWithActivated() throws Exception {
    ProductDetailResponse product = getProductDetailResponse();
    product.setActivated(true);
    Page<ProductBusinessPartner> page = new PageImpl<ProductBusinessPartner>(new ArrayList<ProductBusinessPartner>());
    Mockito.when(getProductRepository().findDetailById(product.getId())).thenReturn(product);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any())).thenReturn(page);
    getProductServiceBean().delete(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findDetailById(product.getId());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            (PageRequest) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(page);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).delete(product);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
  }

  @Test
  public void testDeleteWithProductCode() throws Exception {
    ProductDetailResponse savedProduct = new ProductDetailResponse(new ProductResponse());
    savedProduct.setProductCode("MTA-" + UUID.randomUUID().toString());
    savedProduct.setId(UUID.randomUUID().toString());
    savedProduct.setStoreId(DEFAULT_STORE_ID);
    savedProduct.setCreatedBy(DEFAULT_USERNAME);
    savedProduct.setCreatedDate(Calendar.getInstance().getTime());
    savedProduct.setUpdatedBy(DEFAULT_USERNAME);
    savedProduct.setUpdatedDate(Calendar.getInstance().getTime());
    savedProduct.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    savedProduct.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    savedProduct.setProductItemResponses(new HashSet<ProductItemResponse>());
    savedProduct.setProductAttributeResponses(new ArrayList<ProductAttributeResponse>());
    savedProduct.setImages(new ArrayList<Image>());
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setId(UUID.randomUUID().toString());
    productItemResponse.setImages(new ArrayList<Image>());
    productItemResponse.getImages().add(new Image());
    AttributeResponse attributeResponse = new AttributeResponse();
    attributeResponse.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    ProductAttributeResponse productAttributeResponse = new ProductAttributeResponse();
    productAttributeResponse.setAttribute(attributeResponse);
    savedProduct.getProductItemResponses().add(productItemResponse);
    savedProduct.getProductAttributeResponses().add(productAttributeResponse);
    savedProduct.getImages().add(new Image());
    ResponsiblePerson responsiblePerson = new ResponsiblePerson();
    responsiblePerson.setEmail("email");
    businessPartner.setId("business-partner-1");
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(new ProductBusinessPartner("business-partner-1", "product-1", "BP1-00001-00001",
        new ArrayList<ProductItemBusinessPartner>(), new ArrayList<ProductBusinessPartnerAttribute>(), DEFAULT_USERNAME,
        Calendar.getInstance().getTime(), DEFAULT_STORE_ID));
    productBusinessPartners.get(0).setProductItemBusinessPartners(new ArrayList<ProductItemBusinessPartner>());
    productBusinessPartners.get(0)
        .setProductBusinessPartnerAttributes(new ArrayList<ProductBusinessPartnerAttribute>());
    productBusinessPartners.get(0).getProductItemBusinessPartners().add(new ProductItemBusinessPartner());
    productBusinessPartners.get(0).getProductItemBusinessPartners().get(0)
        .setProductItemId(productItemResponse.getId());
    productBusinessPartners.get(0).getProductBusinessPartnerAttributes().add(new ProductBusinessPartnerAttribute());
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(new ProductWorkflow(savedProduct.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, null, DEFAULT_USERNAME, Calendar.getInstance().getTime(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> productWorkflowPage = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findProductDetailByProductCode(savedProduct.getProductCode()))
        .thenReturn(savedProduct);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(savedProduct.getId()),
            (PageRequest) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(savedProduct.getStoreId(), savedProduct.getId(), pageable))
        .thenReturn(productWorkflowPage);
    Mockito.doNothing().when(getProductWorkflowRepository()).deleteAll(productWorkflowPage);
    Mockito.when(getProductWorkflowRepository().saveAndFlush((ProductWorkflow) Mockito.any())).thenReturn(null);
    Mockito.when(getProductHistoryRepository().saveAndFlush((ProductHistory) Mockito.any())).thenReturn(null);
    Mockito.when(getProductBusinessPartnerRepository().saveAll(productBusinessPartnerPage))
        .thenReturn(productBusinessPartners);
    Mockito.doNothing().when(getProductRepository()).delete((ProductDetailResponse) Mockito.any());

    getProductServiceBean().delete(savedProduct.getProductCode(), "TEST");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findProductDetailByProductCode(savedProduct.getProductCode());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(savedProduct.getId()),
            (PageRequest) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(savedProduct.getStoreId(), savedProduct.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).deleteAll(productWorkflowPage);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush((ProductWorkflow) Mockito.any());
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAndFlush((ProductHistory) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).delete((ProductDetailResponse) Mockito.any());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(emailNotificationService).sendEmailDeleteProductBusinessPartner(
        productDetailResponseArgumentCaptor.capture(),
        productBusinessPartnerResponsePageArgumentCaptor.capture(), Mockito.eq("TEST"), Mockito.eq(null));
  }

  @Test
  public void testDeleteWithProductCodeAndInvalidProductCode() throws Exception {
    ProductDetailResponse savedProduct = new ProductDetailResponse(new ProductResponse());
    savedProduct.setProductCode("MTA-" + UUID.randomUUID().toString());
    savedProduct.setId(UUID.randomUUID().toString());
    savedProduct.setStoreId(DEFAULT_STORE_ID);
    savedProduct.setCreatedBy(DEFAULT_USERNAME);
    savedProduct.setCreatedDate(Calendar.getInstance().getTime());
    savedProduct.setUpdatedBy(DEFAULT_USERNAME);
    savedProduct.setUpdatedDate(Calendar.getInstance().getTime());
    savedProduct.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    savedProduct.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    businessPartner.setId("business-partner-1");
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(new ProductBusinessPartner("business-partner-1", "product-1", "BP1-00001-00001",
        new ArrayList<ProductItemBusinessPartner>(), new ArrayList<ProductBusinessPartnerAttribute>(), DEFAULT_USERNAME,
        Calendar.getInstance().getTime(), DEFAULT_STORE_ID));
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(new ProductWorkflow(savedProduct.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, null, DEFAULT_USERNAME, Calendar.getInstance().getTime(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> productWorkflowPage = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findProductDetailByProductCode(savedProduct.getProductCode(), false))
        .thenReturn(null);
    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().delete(savedProduct.getProductCode(), "TEST");
      });
    } catch (Exception e) {
      if (e instanceof ApplicationException) {
              ApplicationException applicationException = (ApplicationException) e;
        Assertions.assertEquals(ErrorCategory.DATA_NOT_FOUND, applicationException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE)
        .findProductDetailByProductCode(savedProduct.getProductCode());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID),
            Mockito.eq(savedProduct.getId()), (PageRequest) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(savedProduct.getStoreId(), savedProduct.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).deleteAll(productWorkflowPage);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE)
        .saveAndFlush((ProductWorkflow) Mockito.any());
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAndFlush((ProductHistory) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).delete((ProductDetailResponse) Mockito.any());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_NONE).save((ProductCollection) Mockito.any());

  }

  @Test
  public void testDeleteWithProductCodeWithoutProductBusinessPartners() throws Exception {
    ProductDetailResponse savedProduct = new ProductDetailResponse(new ProductResponse());
    savedProduct.setProductCode("MTA-" + UUID.randomUUID().toString());
    savedProduct.setId(UUID.randomUUID().toString());
    savedProduct.setStoreId(DEFAULT_STORE_ID);
    savedProduct.setCreatedBy(DEFAULT_USERNAME);
    savedProduct.setCreatedDate(Calendar.getInstance().getTime());
    savedProduct.setUpdatedBy(DEFAULT_USERNAME);
    savedProduct.setUpdatedDate(Calendar.getInstance().getTime());
    savedProduct.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    savedProduct.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    businessPartner.setId("business-partner-1");
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(new ArrayList<ProductBusinessPartner>());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(new ProductWorkflow(savedProduct.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, null, DEFAULT_USERNAME, Calendar.getInstance().getTime(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> productWorkflowPage = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findProductDetailByProductCode(savedProduct.getProductCode()))
        .thenReturn(savedProduct);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(savedProduct.getId()),
            (PageRequest) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(savedProduct.getStoreId(), savedProduct.getId(), pageable))
        .thenReturn(productWorkflowPage);
    Mockito.doNothing().when(getProductWorkflowRepository()).deleteAll(productWorkflowPage);
    Mockito.when(getProductWorkflowRepository().saveAndFlush((ProductWorkflow) Mockito.any())).thenReturn(null);
    Mockito.when(getProductHistoryRepository().saveAndFlush((ProductHistory) Mockito.any())).thenReturn(null);
    Mockito.doNothing().when(getProductRepository()).delete((ProductDetailResponse) Mockito.any());
    getProductServiceBean().delete(savedProduct.getProductCode(), "TEST");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findProductDetailByProductCode(savedProduct.getProductCode());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(savedProduct.getId()),
            (PageRequest) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(savedProduct.getStoreId(), savedProduct.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).deleteAll(productWorkflowPage);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush((ProductWorkflow) Mockito.any());
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAndFlush((ProductHistory) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).delete((ProductDetailResponse) Mockito.any());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());

  }

  @Test
  public void testFindById() throws Exception {
    Product product = getProduct();
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    getProductServiceBean().findById(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
  }

  @Test
  public void testFindByKeywordAndViewable() throws Exception {
    ProductItem productItem = getProductItem();
    productItem.setViewable(true);
    List<ProductItem> productItems = new ArrayList<ProductItem>();
    productItems.add(productItem);
    Page<ProductItem> page = new PageImpl<ProductItem>(productItems);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(
        getProductItemRepository().findByStoreIdAndKeywordAndViewable(DEFAULT_STORE_ID, "Item 1", true, true, pageable))
        .thenReturn(page);
    getProductServiceBean().findByKeywordAndViewable(DEFAULT_STORE_ID, "Item 1", true, true, pageable);
    Mockito.verify(getProductItemRepository(), AT_LEAST_ONE)
        .findByStoreIdAndKeywordAndViewable(DEFAULT_STORE_ID, "Item 1", true, true, pageable);
  }

  @Test
  public void testFindByName() throws Exception {
    Product product = getProduct();
    List<Product> products = new ArrayList<Product>();
    products.add(product);
    Page<Product> page = new PageImpl<Product>(products);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findByStoreIdAndName(DEFAULT_STORE_ID, "Produk", pageable)).thenReturn(page);
    getProductServiceBean().findByName(DEFAULT_STORE_ID, "Produk", pageable);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findByStoreIdAndName(DEFAULT_STORE_ID, "Produk", pageable);
  }

  @Test
  public void testFindByNameAndViewableAndActivated() throws Exception {
    Product product = getProduct();
    product.setViewable(true);
    product.setActivated(true);
    List<Product> products = new ArrayList<Product>();
    products.add(product);
    Page<Product> page = new PageImpl<Product>(products);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository()
        .findByStoreIdAndNameAndViewableAndActivated(DEFAULT_STORE_ID, "Produk 1", true, true, pageable))
        .thenReturn(page);
    getProductServiceBean().findByNameAndViewableAndActivated(DEFAULT_STORE_ID, "Produk 1", true, true, pageable);
    Mockito.verify(getProductRepository())
        .findByStoreIdAndNameAndViewableAndActivated(DEFAULT_STORE_ID, "Produk 1", true, true, pageable);
  }

  @Test
  public void testFindByProductCode() throws Exception {
    String productCode = UUID.randomUUID().toString();
    Product product = getProduct();
    product.setProductCode(productCode);
    List<Product> products = new ArrayList<Product>();
    products.add(product);
    Page<Product> page = new PageImpl<Product>(products);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, productCode, pageable))
        .thenReturn(page);
    getProductServiceBean().findByProductCode(DEFAULT_STORE_ID, productCode, pageable);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, productCode, pageable);
  }

  @Test
  public void testFindByStoreId() throws Exception {
    Product product = getProduct();
    List<Product> products = new ArrayList<Product>();
    products.add(product);
    Page<Product> page = new PageImpl<Product>(products);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findByStoreId(DEFAULT_STORE_ID, pageable)).thenReturn(page);
    getProductServiceBean().findByStoreId(DEFAULT_STORE_ID, pageable);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findByStoreId(DEFAULT_STORE_ID, pageable);
  }

  @Test
  public void testFindByUpcCode() throws Exception {
    ProductItem productItem = getProductItem();
    List<ProductItem> productItems = new ArrayList<ProductItem>();
    productItems.add(productItem);
    Page<ProductItem> page = new PageImpl<ProductItem>(productItems);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductItemRepository().findByStoreIdAndUpcCode(DEFAULT_STORE_ID, "0123456789012", pageable))
        .thenReturn(page);
    getProductServiceBean().findByUpcCode(DEFAULT_STORE_ID, "0123456789012", pageable);
    Mockito.verify(getProductItemRepository(), AT_LEAST_ONE)
        .findByStoreIdAndUpcCode(DEFAULT_STORE_ID, "0123456789012", pageable);
  }

  @Test
  public void testFindByViewable() throws Exception {
    Product product = getProduct();
    List<Product> products = new ArrayList<Product>();
    products.add(product);
    Page<Product> page = new PageImpl<Product>(products);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findByStoreIdAndViewable(DEFAULT_STORE_ID, true, pageable)).thenReturn(page);
    getProductServiceBean().findByViewable(DEFAULT_STORE_ID, true, pageable);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findByStoreIdAndViewable(DEFAULT_STORE_ID, true, pageable);
  }

  @Test
  public void testFindByViewableAndActivated() throws Exception {
    Product product = getProduct();
    product.setViewable(true);
    product.setActivated(true);
    List<Product> products = new ArrayList<Product>();
    products.add(product);
    Page<Product> page = new PageImpl<Product>(products);
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findByStoreIdAndViewableAndActivated(DEFAULT_STORE_ID, true, true, pageable))
        .thenReturn(page);
    getProductServiceBean().findByViewableAndActivated(DEFAULT_STORE_ID, true, true, pageable);
    Mockito.verify(getProductRepository()).findByStoreIdAndViewableAndActivated(DEFAULT_STORE_ID, true, true, pageable);
  }

  @Test
  public void testFindProductDetailByProductCode_whenPVSwitchFalse() throws Exception {
    ProductDetailResponse savedProduct = new ProductDetailResponse(new ProductResponse());
    savedProduct.setProductCode("MTA-" + UUID.randomUUID().toString());
    savedProduct.setId(UUID.randomUUID().toString());
    savedProduct.setStoreId(DEFAULT_STORE_ID);
    savedProduct.setCreatedBy(DEFAULT_USERNAME);
    savedProduct.setCreatedDate(Calendar.getInstance().getTime());
    savedProduct.setUpdatedBy(DEFAULT_USERNAME);
    savedProduct.setUpdatedDate(Calendar.getInstance().getTime());
    savedProduct.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    savedProduct.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(getProductRepository().findProductDetailByProductCode(savedProduct.getProductCode(), false))
        .thenReturn(savedProduct);
    getProductServiceBean().findProductDetailByProductCode(savedProduct.getProductCode(), false);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE)
        .findProductDetailByProductCode(savedProduct.getProductCode(), false);
  }


  @Test
  public void testFindProductDetailByProductCode() throws Exception {
    ProductDetailResponse savedProduct = new ProductDetailResponse(new ProductResponse());
    savedProduct.setProductCode("MTA-" + UUID.randomUUID().toString());
    savedProduct.setId(UUID.randomUUID().toString());
    savedProduct.setStoreId(DEFAULT_STORE_ID);
    savedProduct.setCreatedBy(DEFAULT_USERNAME);
    savedProduct.setCreatedDate(Calendar.getInstance().getTime());
    savedProduct.setUpdatedBy(DEFAULT_USERNAME);
    savedProduct.setUpdatedDate(Calendar.getInstance().getTime());
    savedProduct.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    savedProduct.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    savedProduct.setViewable(true);
    Mockito.when(getProductRepository().findProductDetailByProductCode(savedProduct.getProductCode(), false))
        .thenReturn(savedProduct);
    getProductServiceBean().findProductDetailByProductCode(savedProduct.getProductCode(), false);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE)
        .findProductDetailByProductCode(savedProduct.getProductCode(), false);
  }

  @Test
  public void testFindProductDetailByProductCode_withIsViewableFalse() throws Exception {
    ProductDetailResponse savedProduct = new ProductDetailResponse(new ProductResponse());
    savedProduct.setProductCode("MTA-" + UUID.randomUUID().toString());
    savedProduct.setId(UUID.randomUUID().toString());
    savedProduct.setStoreId(DEFAULT_STORE_ID);
    savedProduct.setCreatedBy(DEFAULT_USERNAME);
    savedProduct.setCreatedDate(Calendar.getInstance().getTime());
    savedProduct.setUpdatedBy(DEFAULT_USERNAME);
    savedProduct.setUpdatedDate(Calendar.getInstance().getTime());
    savedProduct.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    savedProduct.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    savedProduct.setViewable(false);
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", true);
    Mockito.when(getProductRepository().findProductDetailByProductCode(savedProduct.getProductCode(), false))
        .thenReturn(savedProduct);
    ProductDetailResponse productDetailResponse =
        getProductServiceBean().findProductDetailByProductCode(savedProduct.getProductCode(), false);
    Mockito.verify(getProductRepository()).findProductDetailByProductCode(savedProduct.getProductCode(), false);
    Assertions.assertEquals(productDetailResponse, savedProduct);
  }

  @Test
  public void testFindProductBasicDetailsByStoreIdAndProductId() throws Exception {
    ProductResponse savedProduct = new ProductResponse();
    savedProduct.setProductCode("MTA-" + UUID.randomUUID().toString());
    savedProduct.setId(UUID.randomUUID().toString());
    savedProduct.setStoreId(DEFAULT_STORE_ID);
    savedProduct.setCreatedBy(DEFAULT_USERNAME);
    savedProduct.setCreatedDate(Calendar.getInstance().getTime());
    savedProduct.setUpdatedBy(DEFAULT_USERNAME);
    savedProduct.setUpdatedDate(Calendar.getInstance().getTime());
    Mockito.when(getProductRepository().findProductBasicDetailByProductCode(savedProduct.getProductCode()))
        .thenReturn(savedProduct);
    getProductServiceBean().findProductBasicDetailByProductCode(savedProduct.getProductCode());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE)
        .findProductBasicDetailByProductCode(savedProduct.getProductCode());
  }

  @Test
  public void getStuckProductCodeAndStateEditedEventToNoStatusUpdatePDTTestForException() throws Exception {
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.doThrow(RuntimeException.class).when(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    productCollection.setEdited(true);
    pdtProductDomainEventModel.setReviewType(ReviewType.IMAGE);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(
        productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID,
            DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean)
        .getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getEditedPublishProductCollection());
  }

  @Test
  public void publishImageQcProcessedResponseEventAutoNeedRevision2TestForException() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class)))
        .thenReturn(imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode()))
        .thenReturn(Collections.singletonList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class)))
        .thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.doThrow(RuntimeException.class).when(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            new AutoNeedRevisionAndForceReviewResponse(true, false, false, null), profileResponse,
            imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertNotNull(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getImageQcProcessedResponseDomainEvent()
        .getAutoNeedRevisionAndForceReviewResponse());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void testFindProductHistoryByStoreIdAndProductId() throws Exception {
    getProductServiceBean()
        .findProductHistoryByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID, DEFAULT_PAGEABLE);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalseOrderByCreatedDateDesc(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID,
            DEFAULT_PAGEABLE);
  }

  @Test
  public void testSave() throws Exception {
    Product product = getProduct();
    product.setProductCode("MTA-" + UUID.randomUUID().toString());
    List<Product> products = new ArrayList<Product>();
    products.add(product);
    Page<Product> savedProducts = new PageImpl<Product>(products);
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(productWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);
    Mockito.when(getSequenceRepository().findByCode("MTA")).thenReturn(Calendar.getInstance().getTimeInMillis());
    Mockito.doNothing().when(getProductRepository()).save(product, "INTERNAL");
    Mockito.when(getProductRepository()
        .findByStoreIdAndProductCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any())).thenReturn(savedProducts);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.when(getProductHistoryRepository().saveAndFlush(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(productWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAll(productWorkflows)).thenReturn(productWorkflows);
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    getProductServiceBean().save(product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getSequenceRepository(), AT_LEAST_ONE).findByCode("MTA");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).save(product, "INTERNAL");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAndFlush(productHistory);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(productWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(productHistories);
  }

  @Test
  public void testSaveCallback() throws Exception {
    Product product = getProduct();
    product.setProductCode("MTA-" + UUID.randomUUID().toString());
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(productWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.when(getProductHistoryRepository().saveAndFlush(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(productWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAll(productWorkflows)).thenReturn(productWorkflows);
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    getProductServiceBean().saveCallback(product);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAndFlush(productHistory);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(productWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(productHistories);
  }

  @Test
  public void testSaveCallbackWithInvalidStateCheckpointOne() throws Exception {
    Product product = getProduct();
    product.setProductCode("MTA-" + UUID.randomUUID().toString());
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(productWorkflow);
    savedProductWorkflows.add(productWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.when(getProductHistoryRepository().saveAndFlush(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    try {
      assertThrows(ApplicationRuntimeException.class, () -> {
        getProductServiceBean().saveCallback(product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationRuntimeException) {
        ApplicationRuntimeException applicationRuntimeException = (ApplicationRuntimeException) e;
        Assertions.assertEquals(ErrorCategory.INVALID_STATE, applicationRuntimeException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAndFlush(productHistory);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(productWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
  }

  @Test
  public void testSaveCallbackWithInvalidStateCheckpointTwo() throws Exception {
    Product product = getProduct();
    product.setProductCode("MTA-" + UUID.randomUUID().toString());
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.when(getProductHistoryRepository().saveAndFlush(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    try {
      assertThrows(ApplicationRuntimeException.class, () -> {
        getProductServiceBean().saveCallback(product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationRuntimeException) {
        ApplicationRuntimeException applicationRuntimeException = (ApplicationRuntimeException) e;
        Assertions.assertEquals(ErrorCategory.INVALID_STATE, applicationRuntimeException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAndFlush(productHistory);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(productWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
  }

  @Test
  public void testSaveProductCollection() throws Exception {
    Product product = getProduct();
    product.setProductCode("MTA-" + UUID.randomUUID().toString());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    ProductDetailResponse savedProduct = new ProductDetailResponse(new ProductResponse());
    savedProduct.setProductCode(product.getProductCode());
    savedProduct.setId(product.getId());
    savedProduct.setStoreId(product.getStoreId());
    savedProduct.setCreatedBy(product.getCreatedBy());
    savedProduct.setCreatedDate(product.getCreatedDate());
    savedProduct.setUpdatedBy(product.getUpdatedBy());
    savedProduct.setUpdatedDate(product.getUpdatedDate());
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(productWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);
    Mockito.when(getSequenceRepository().findByCode("MTA")).thenReturn(Calendar.getInstance().getTimeInMillis());
    Mockito.doNothing().when(getProductRepository()).save(product, "BLT-00001");
    Mockito.when(getProductRepository().findProductDetailByProductCode(Mockito.anyString())).thenReturn(savedProduct);
    Mockito.when(getProductCollectionRepository().saveAndFlush((ProductCollection) Mockito.any()))
        .thenReturn(null);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.when(getProductHistoryRepository().saveAndFlush(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), DEFAULT_PAGEABLE))
        .thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(productWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAll(productWorkflows)).thenReturn(productWorkflows);
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    getProductServiceBean().saveProductCollection("BLT-00001", "Blibli Testing", product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getSequenceRepository(), AT_LEAST_ONE).findByCode("MTA");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).save(product, "BLT-00001");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .saveAndFlush((ProductCollection) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAndFlush(productHistory);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), DEFAULT_PAGEABLE);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(productWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(productHistories);
  }

  @Test
  public void testSaveProductCollectionException() throws Exception {
    Product product = getProduct();
    product.setProductCode("MTA-" + UUID.randomUUID().toString());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    product.getProductCategories().forEach(productCategory -> productCategory.setMarkForDelete(true));
    ProductDetailResponse savedProduct = new ProductDetailResponse(new ProductResponse());
    savedProduct.setProductCode(product.getProductCode());
    savedProduct.setId(product.getId());
    savedProduct.setStoreId(product.getStoreId());
    savedProduct.setCreatedBy(product.getCreatedBy());
    savedProduct.setCreatedDate(product.getCreatedDate());
    savedProduct.setUpdatedBy(product.getUpdatedBy());
    savedProduct.setUpdatedDate(product.getUpdatedDate());
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(productWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);
    Mockito.when(getSequenceRepository().findByCode("MTA")).thenReturn(Calendar.getInstance().getTimeInMillis());
    Mockito.doNothing().when(getProductRepository()).save(product, "BLT-00001");
    Mockito.when(getProductRepository().findProductDetailByProductCode(Mockito.anyString())).thenReturn(savedProduct);
    Mockito.when(getProductCollectionRepository().saveAndFlush((ProductCollection) Mockito.any()))
        .thenReturn(null);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.when(getProductHistoryRepository().saveAndFlush(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), DEFAULT_PAGEABLE))
        .thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(productWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAll(productWorkflows)).thenReturn(productWorkflows);
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().saveProductCollection("BLT-00001", "Blibli Testing", product);
      });
    } finally {
      Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
      Mockito.verify(getSequenceRepository(), AT_LEAST_ONE).findByCode("MTA");
      Mockito.verify(getProductRepository(), AT_LEAST_ONE).save(product, "BLT-00001");
      Mockito.verify(getProductRepository(), AT_LEAST_ONE).findProductDetailByProductCode(Mockito.anyString());
    }
  }

  @Test
  public void testSaveProductCollection_1() throws Exception {
    Product product = getProduct();
    product.setProductCode("MTA-" + UUID.randomUUID().toString());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    ProductDetailResponse savedProduct = new ProductDetailResponse(new ProductResponse());
    savedProduct.setProductCode(product.getProductCode());
    savedProduct.setId(product.getId());
    savedProduct.setStoreId(product.getStoreId());
    savedProduct.setCreatedBy(product.getCreatedBy());
    savedProduct.setCreatedDate(product.getCreatedDate());
    savedProduct.setUpdatedBy(product.getUpdatedBy());
    savedProduct.setUpdatedDate(product.getUpdatedDate());
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(productWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);
    Mockito.when(getSequenceRepository().findByCode("MTA")).thenReturn(Calendar.getInstance().getTimeInMillis());
    Mockito.doNothing().when(getProductRepository()).save(product, "INTERNAL");
    Mockito.when(getProductRepository().findProductDetailByProductCode(Mockito.anyString())).thenReturn(savedProduct);
    Mockito.when(getProductCollectionRepository().saveAndFlush((ProductCollection) Mockito.any()))
        .thenReturn(null);
    Mockito.when(getProductWorkflowRepository().saveAndFlush(productWorkflow)).thenReturn(productWorkflow);
    Mockito.when(getProductHistoryRepository().saveAndFlush(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), DEFAULT_PAGEABLE))
        .thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(productWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAll(productWorkflows)).thenReturn(productWorkflows);
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    getProductServiceBean().saveProductCollection(null, null, product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getSequenceRepository(), AT_LEAST_ONE).findByCode("MTA");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).save(product, "INTERNAL");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .saveAndFlush((ProductCollection) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAndFlush(productHistory);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), DEFAULT_PAGEABLE);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(productWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(productHistories);

  }

  @Test
  public void testSaveProductCollectionWithExistingProduct() throws Exception {
    Product product = getProduct();
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().saveProductCollection("BLT-00001", "Blibli Testing", product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationException) {
        ApplicationException applicationException = (ApplicationException) e;
        Assertions.assertEquals(ErrorCategory.DATA_ACCESS, applicationException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).save(product, "INTERNAL");
    Mockito.verify(getProductRepository(), AT_LEAST_NONE)
        .findProductDetailByProductCode(Mockito.anyString(), Mockito.eq(false));
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_NONE)
        .saveAndFlush((ProductCollection) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAndFlush(productHistory);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), DEFAULT_PAGEABLE);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(productWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
  }

  @Test
  public void testSaveWithExistingProduct() throws Exception {
    Product product = getProduct();
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(productWorkflow);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().save(product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationException) {
        ApplicationException applicationException = (ApplicationException) e;
        Assertions.assertEquals(ErrorCategory.DATA_ACCESS, applicationException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).save(product, "INTERNAL");
    Mockito.verify(getProductRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAndFlush(productHistory);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(productWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
  }

  @Test
  public void testSaveWithInvalidProductCode() throws Exception {
    Product product = getProduct();
    product.setProductCode("MTA-" + UUID.randomUUID().toString());
    List<Product> products = new ArrayList<Product>();
    Page<Product> savedProducts = new PageImpl<Product>(products);
    ProductWorkflow productWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        product.getStoreId());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, ProductWorkflowLookup.STATE_CREATE_TO_DRAFT_NOTES,
        product.getCreatedBy(), product.getCreatedDate(), product.getStoreId());
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(productWorkflow);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);
    Mockito.when(getSequenceRepository().findByCode("MTA")).thenReturn(Calendar.getInstance().getTimeInMillis());
    Mockito.doNothing().when(getProductRepository()).save(product, "INTERNAL");
    Mockito.when(getProductRepository()
        .findByStoreIdAndProductCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any())).thenReturn(savedProducts);
    getProductServiceBean().save(product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getSequenceRepository(), AT_LEAST_ONE).findByCode("MTA");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).save(product, "INTERNAL");
    Mockito.verify(getProductRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAndFlush(productWorkflow);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAndFlush(productHistory);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(productWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
  }

  @Test
  public void testSubmit() throws Exception {
    Product product = getProduct();
    ProductWorkflow savedProductWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    Mockito.doNothing().when(getProductWorkflowRepository()).delete(savedProductWorkflow);
    Mockito.when(getProductWorkflowRepository().saveAll(productWorkflows)).thenReturn(productWorkflows);
    Mockito.when(getProductHistoryRepository().saveAll(productHistories)).thenReturn(productHistories);
    getProductServiceBean().submit(DEFAULT_STORE_ID, product);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).saveAll(productHistories);
  }

  @Test
  public void testSubmitWithInvalidProductId() throws Exception {
    Product product = getProduct();
    ProductWorkflow savedProductWorkflow = new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_DRAFT,
        ProductWorkflowLookup.STATE_DRAFT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);
    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().submit(DEFAULT_STORE_ID, product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationException) {
        ApplicationException applicationException = (ApplicationException) e;
        Assertions.assertEquals(ErrorCategory.DATA_NOT_FOUND, applicationException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
  }

  @Test
  public void testSubmitWithInvalidStateCheckpointOne() throws Exception {
    Product product = getProduct();
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    savedProductWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
        DEFAULT_STORE_ID));
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    try {
      assertThrows(ApplicationRuntimeException.class, () -> {
        getProductServiceBean().submit(DEFAULT_STORE_ID, product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationRuntimeException) {
        ApplicationRuntimeException applicationRuntimeException = (ApplicationRuntimeException) e;
        Assertions.assertEquals(ErrorCategory.INVALID_STATE, applicationRuntimeException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
  }

  @Test
  public void testSubmitWithInvalidStateCheckpointTwo() throws Exception {
    Product product = getProduct();
    ProductWorkflow savedProductWorkflow =
        new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
            ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getCreatedBy(), product.getCreatedDate(),
            DEFAULT_STORE_ID);
    List<ProductWorkflow> savedProductWorkflows = new ArrayList<ProductWorkflow>();
    savedProductWorkflows.add(savedProductWorkflow);
    Page<ProductWorkflow> page = new PageImpl<ProductWorkflow>(savedProductWorkflows);
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productWorkflows.add(new ProductWorkflow(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    List<ProductHistory> productHistories = new ArrayList<ProductHistory>();
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_CONTENT,
        ProductWorkflowLookup.STATE_REVIEW_CONTENT_DESCRIPTION,
        ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_CONTENT_NOTES, product.getUpdatedBy(), product.getUpdatedDate(),
        DEFAULT_STORE_ID));
    productHistories.add(new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_REVIEW_IMAGE,
        ProductWorkflowLookup.STATE_REVIEW_IMAGE_DESCRIPTION, ProductWorkflowLookup.STATE_DRAFT_TO_REVIEW_IMAGE_NOTES,
        product.getUpdatedBy(), product.getUpdatedDate(), DEFAULT_STORE_ID));
    Pageable pageable = PageRequest.of(DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable)).thenReturn(page);
    try {
      assertThrows(ApplicationRuntimeException.class, () -> {
        getProductServiceBean().submit(DEFAULT_STORE_ID, product);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationRuntimeException) {
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), pageable);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).delete(savedProductWorkflow);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_NONE).saveAll(productWorkflows);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_NONE).saveAll(productHistories);
  }

  @Test
  public void testUpdate() throws Exception {
    Product product = getProduct();
    product.setViewable(true);
    product.setActivated(true);
    SolrProductCollectionUpdateEvent solrProductCollectionUpdateEvent =
        new SolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(new ArrayList<ProductBusinessPartner>());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_EDIT,
        ProductWorkflowLookup.STATE_EDIT_DESCRIPTION, ProductWorkflowLookup.STATE_EDIT_DESCRIPTION,
        product.getUpdatedBy(), product.getUpdatedDate(), product.getStoreId());
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito
        .when(productStatusPublisherService.publishSolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO()))
        .
            thenReturn(solrProductCollectionUpdateEvent);

    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductHistoryRepository().save(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductChangeUtil().getProductDiff(product, product))
        .thenReturn(Collections.singletonList(new ProductFieldHistory(FIELD, OLD_VALUE, NEW_VALUE)));
    Mockito.when(getProductChangeUtil().getCategoryIds(product, product))
        .thenReturn(categoryIds);
    Mockito.when(productLevel3Service.isPristineCategory(ID)).thenReturn(false);
    getProductServiceBean().update(product, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductChangeUtil()).getCategoryIds(product, product);
    Mockito.verify(productLevel3Service).isPristineCategory(ID);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, false, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).save(productHistory);
    Mockito.verify(getProductChangeUtil(), AT_LEAST_ONE).getProductDiff(any(Product.class), any(Product.class));
    Mockito.verify(productStatusPublisherService)
        .publishSolrProductCollectionUpdateEvent(Mockito.any(SolrProductCollectionDTO.class));
  }

  @Test
  public void testUpdate_WithMarginExceededTrue() throws Exception {
    Product product = getProduct();
    product.setViewable(true);
    product.setActivated(true);
    SolrProductCollectionUpdateEvent solrProductCollectionUpdateEvent =
        new SolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(new ArrayList<ProductBusinessPartner>());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_EDIT,
        ProductWorkflowLookup.STATE_EDIT_DESCRIPTION, ProductWorkflowLookup.STATE_EDIT_DESCRIPTION,
        product.getUpdatedBy(), product.getUpdatedDate(), product.getStoreId());
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito
        .when(productStatusPublisherService.publishSolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO()))
        .thenReturn(solrProductCollectionUpdateEvent);

    Mockito.doNothing().when(this.productMailEventService).createAndSaveCategoryChangeMailEvent(any(), any());
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductHistoryRepository().save(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductChangeUtil().getProductDiff(product, product))
        .thenReturn(new ArrayList<>(Collections.singleton(new ProductFieldHistory(FIELD, OLD_VALUE, NEW_VALUE))));
    Mockito.when(getProductChangeUtil().getCategoryIds(product, product))
        .thenReturn(null);
    getProductServiceBean()
        .update(product, false, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS, true, false,
            StringUtils.EMPTY, false);
    Mockito.verify(this.productMailEventService)
        .createAndSaveCategoryChangeMailEvent(Mockito.any(), categoryChangeMailEventArgumentCaptor.capture());
    CategoryChangeMailEvent categoryChangeMailEvent = categoryChangeMailEventArgumentCaptor.getValue();
    assertEquals(CATEGORY_NAME, categoryChangeMailEvent.getExistingCategoryName());
    assertEquals(CATEGORY_CODE, categoryChangeMailEvent.getExistingCategoryCode());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, null, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductChangeUtil()).getCategoryIds(product, product);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(productBusinessPartnerPage);
    ArgumentCaptor<SolrProductCollectionDTO> solrProductCollectionDTOArgumentCaptor =
        ArgumentCaptor.forClass(SolrProductCollectionDTO.class);
    Mockito.verify(productStatusPublisherService)
        .publishSolrProductCollectionUpdateEvent(solrProductCollectionDTOArgumentCaptor.capture());
    SolrProductCollectionDTO solrProductCollectionDTO = solrProductCollectionDTOArgumentCaptor.getValue();
    assertEquals(CATEGORY_NAME, solrProductCollectionDTO.getCategoryName());
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).save(productHistory);
    Mockito.verify(getProductChangeUtil(), AT_LEAST_ONE).getProductDiff(Mockito.eq(product), Mockito.eq(product));
  }

  @Test
  public void testUpdateWithPostLiveTrue() throws Exception {
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito
        .when(productStatusPublisherService.publishSolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO()))
        .thenReturn(solrProductCollectionUpdateEvent);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), PageRequest.of(0, 1000)))
        .thenReturn(new PageImpl<>(new ArrayList<>()));
    Mockito.when(getProductHistoryRepository().save(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductChangeUtil().getProductDiff(product, product))
        .thenReturn(new ArrayList<>(Collections.singleton(new ProductFieldHistory(FIELD, OLD_VALUE, NEW_VALUE))));
    Mockito.when(getProductChangeUtil().getCategoryIds(product, product))
        .thenReturn(categoryIds);
    Mockito.when(productLevel3Service.isPristineCategory(ID)).thenReturn(true);
    getProductServiceBean().update(product, false, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS, true, true,
        StringUtils.EMPTY, false);
    Mockito.verify(this.productMailEventService)
        .createAndSaveCategoryChangeMailEvent(Mockito.any(), categoryChangeMailEventArgumentCaptor.capture());
    CategoryChangeMailEvent categoryChangeMailEvent = categoryChangeMailEventArgumentCaptor.getValue();
    assertEquals(CATEGORY_NAME, categoryChangeMailEvent.getExistingCategoryName());
    assertEquals(CATEGORY_CODE, categoryChangeMailEvent.getExistingCategoryCode());
    Mockito.verify(getProductRepository()).findOne(product.getId());
    Mockito.verify(getProductRepository()).update(product, true, false, true, false, new ArrayList<>(), new HashedMap(),
        new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductChangeUtil()).getCategoryIds(product, product);
    Mockito.verify(productLevel3Service).isPristineCategory(ID);
    Mockito.verify(getProductCollectionRepository())
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository()).save(productCollectionArgumentCaptor.capture());
    Mockito.verify(getProductBusinessPartnerRepository())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), PageRequest.of(0, 1000));
    ArgumentCaptor<SolrProductCollectionDTO> solrProductCollectionDTOArgumentCaptor =
        ArgumentCaptor.forClass(SolrProductCollectionDTO.class);
    Mockito.verify(productStatusPublisherService)
        .publishSolrProductCollectionUpdateEvent(solrProductCollectionDTOArgumentCaptor.capture());
    SolrProductCollectionDTO solrProductCollectionDTO = solrProductCollectionDTOArgumentCaptor.getValue();
    assertEquals(CATEGORY_NAME, solrProductCollectionDTO.getCategoryName());
    Mockito.verify(getProductHistoryRepository()).save(productHistoryArgumentCaptor.capture());
    Mockito.verify(getProductChangeUtil()).getProductDiff(Mockito.eq(product), Mockito.eq(product));
    Assertions.assertTrue(productHistoryArgumentCaptor.getValue().getNotes().contains(NOTES_POST_LIVE));
  }

  @Test
  public void testUpdateWithForcePostLiveTrue() throws Exception {
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito
        .when(productStatusPublisherService.publishSolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO()))
        .thenReturn(solrProductCollectionUpdateEvent);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), PageRequest.of(0, 1000)))
        .thenReturn(new PageImpl<>(new ArrayList<>()));
    Mockito.when(getProductHistoryRepository().save(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductChangeUtil().getProductDiff(product, product))
        .thenReturn(new ArrayList<>(Collections.singleton(new ProductFieldHistory(FIELD, OLD_VALUE, NEW_VALUE))));
    Mockito.when(getProductChangeUtil().getCategoryIds(product, product))
        .thenReturn(categoryIds);
    Mockito.when(productLevel3Service.isPristineCategory(ID)).thenReturn(false);
    getProductServiceBean().update(product, false, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS, true, true,
        FORCE_REVIEW_NOTES, false);
    Mockito.verify(this.productMailEventService)
        .createAndSaveCategoryChangeMailEvent(Mockito.any(), categoryChangeMailEventArgumentCaptor.capture());
    CategoryChangeMailEvent categoryChangeMailEvent = categoryChangeMailEventArgumentCaptor.getValue();
    assertEquals(CATEGORY_NAME, categoryChangeMailEvent.getExistingCategoryName());
    assertEquals(CATEGORY_CODE, categoryChangeMailEvent.getExistingCategoryCode());
    Mockito.verify(getProductRepository()).findOne(product.getId());
    Mockito.verify(getProductRepository()).update(product, false, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductChangeUtil()).getCategoryIds(product, product);
    Mockito.verify(productLevel3Service).isPristineCategory(ID);
    Mockito.verify(getProductCollectionRepository())
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository()).save(productCollectionArgumentCaptor.capture());
    Mockito.verify(getProductBusinessPartnerRepository())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getId(), PageRequest.of(0, 1000));
    ArgumentCaptor<SolrProductCollectionDTO> solrProductCollectionDTOArgumentCaptor =
        ArgumentCaptor.forClass(SolrProductCollectionDTO.class);
    Mockito.verify(productStatusPublisherService)
        .publishSolrProductCollectionUpdateEvent(solrProductCollectionDTOArgumentCaptor.capture());
    SolrProductCollectionDTO solrProductCollectionDTO = solrProductCollectionDTOArgumentCaptor.getValue();
    assertEquals(CATEGORY_NAME, solrProductCollectionDTO.getCategoryName());
    Mockito.verify(getProductHistoryRepository(), times(2)).save(productHistoryArgumentCaptor.capture());
    Mockito.verify(getProductChangeUtil()).getProductDiff(Mockito.eq(product), Mockito.eq(product));
    Assertions.assertTrue(productHistoryArgumentCaptor.getAllValues().get(0).getNotes().contains(NOTES_POST_LIVE));
    Assertions.assertTrue(productHistoryArgumentCaptor.getAllValues().get(1).getNotes().contains(FORCE_REVIEW_NOTES));
  }

  @Test
  public void testUpdateWithNoChangesInUpdate() throws Exception {
    Product product = getProduct();
    product.setViewable(true);
    product.setActivated(true);
    SolrProductCollectionUpdateEvent solrProductCollectionUpdateEvent =
        new SolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    Page<ProductBusinessPartner> productBusinessPartnerPage = new PageImpl<>(new ArrayList<>());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_EDIT,
        ProductWorkflowLookup.STATE_EDIT_DESCRIPTION, ProductWorkflowLookup.STATE_EDIT_DESCRIPTION,
        product.getUpdatedBy(), product.getUpdatedDate(), product.getStoreId());
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito
        .when(productStatusPublisherService.publishSolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO()))
        .thenReturn(solrProductCollectionUpdateEvent);
    Mockito.when(getProductChangeUtil().getCategoryIds(product, product))
        .thenReturn(categoryIds);
    Mockito.when(productLevel3Service.isPristineCategory(ID)).thenReturn(true);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductHistoryRepository().save(productHistory)).thenReturn(productHistory);
    getProductServiceBean().update(product, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, true, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductChangeUtil()).getCategoryIds(product, product);
    Mockito.verify(productLevel3Service).isPristineCategory(ID);
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getProductChangeUtil(), AT_LEAST_ONE).getProductDiff(any(Product.class), any(Product.class));
    Mockito.verify(productStatusPublisherService)
        .publishSolrProductCollectionUpdateEvent(Mockito.any(SolrProductCollectionDTO.class));
  }

  private SolrProductCollectionDTO generateSolrProductCollectionDTO() {
    SolrProductCollectionDTO solrProductCollectionDTO = new SolrProductCollectionDTO();
    solrProductCollectionDTO.setId(UUID.randomUUID().toString());
    solrProductCollectionDTO.setProductCode(DEFAULT_PRODUCT_CODE);
    solrProductCollectionDTO.setCategoryCode(DEFAULT_CATEGORY_CODE);
    return solrProductCollectionDTO;
  }

  @Test
  public void testUpdateWhenNotFound() throws Exception {
    Product product = getProduct();
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    product.setProductCode(DEFAULT_PRODUCT_CODE);
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(null);
    Mockito.when(getProductChangeUtil().getCategoryIds(product, product))
        .thenReturn(categoryIds);
    Mockito.when(productLevel3Service.isPristineCategory(ID)).thenReturn(false);
    try {
      assertThrows(Exception.class, () -> {
        getProductServiceBean().update(product, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS);
      });
    } catch (Exception e) {
      throw e;
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductChangeUtil(), AT_LEAST_ONE).getProductDiff(any(Product.class), any(Product.class));
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(DEFAULT_PRODUCT_CODE));
    Mockito.verify(getProductChangeUtil()).getCategoryIds(product, product);
    Mockito.verify(productLevel3Service).isPristineCategory(ID);
  }

  @Test
  public void testUpdateWithInvalidProductId() throws Exception {
    Product product = getProduct();
    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(null);

    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().update(product, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationException) {
        ApplicationException applicationException = (ApplicationException) e;
        Assertions.assertEquals(ErrorCategory.DATA_NOT_FOUND, applicationException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductRepository(), AT_LEAST_NONE).update(product, false, false, true, false,
        new ArrayList<>(), new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(),
        new ProductL3Response(), EditProductResponse.builder().build());
  }

  @Test
  public void testValidateBarcode() throws Exception {
    String barcode = "0123456789012";
    List<ProductItem> productItems = new ArrayList<ProductItem>();
    Page<ProductItem> page = new PageImpl<ProductItem>(productItems);
    Mockito.when(getProductItemRepository()
        .findByStoreIdAndUpcCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(barcode),
            (Pageable) Mockito.any())).thenReturn(page);
    Boolean result = getProductServiceBean().validateBarcode(DEFAULT_STORE_ID, barcode);
    Mockito.verify(getProductItemRepository(), AT_LEAST_ONE)
        .findByStoreIdAndUpcCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(barcode),
            (Pageable) Mockito.any());
    Assertions.assertEquals(true, result);
  }

  @Test
  public void testValidateBarcodeWithExistingUpcCode() throws Exception {
    String barcode = "0123456789012";
    List<ProductItem> productItems = new ArrayList<ProductItem>();
    productItems.add(getProductItem());
    Page<ProductItem> page = new PageImpl<ProductItem>(productItems);
    Mockito.when(getProductItemRepository()
        .findByStoreIdAndUpcCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(barcode),
            (Pageable) Mockito.any())).thenReturn(page);
    try {
      assertThrows(ApplicationException.class, () -> {
        getProductServiceBean().validateBarcode(DEFAULT_STORE_ID, barcode);
      });
    } catch (Exception e) {
      if (e instanceof ApplicationException) {
        Mockito.verify(getProductItemRepository(), AT_LEAST_ONE)
            .findByStoreIdAndUpcCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(barcode),
                (Pageable) Mockito.any());
        ApplicationException applicationException = (ApplicationException) e;
        Assertions.assertEquals(ErrorCategory.DATA_ACCESS, applicationException.getErrorCodes());
        throw e;
      } else {
        Assertions.assertFalse(true);
      }
    }
  }

  @Test
  public void testValidateBarcodeWithInvalidUpcCode() throws Exception {
    String barcode = "0123456789013";
    List<ProductItem> productItems = new ArrayList<ProductItem>();
    Page<ProductItem> page = new PageImpl<ProductItem>(productItems);
    Mockito.when(getProductItemRepository()
        .findByStoreIdAndUpcCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(barcode),
            (Pageable) Mockito.any())).thenReturn(page);
    Boolean result = getProductServiceBean().validateBarcode(DEFAULT_STORE_ID, barcode);
    Mockito.verify(getProductItemRepository(), AT_LEAST_ONE)
        .findByStoreIdAndUpcCodeExactMatch(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(barcode),
            (Pageable) Mockito.any());
    Assertions.assertEquals(false, result);
  }

  @Test
  public void checkProductWorkflowsAlreadyExistTest() throws Exception {
    Product product = getProduct();
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    productWorkflows.add(new ProductWorkflow());
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.eq(product.getId())))
        .thenReturn(productWorkflows);
    getProductServiceBean().checkProductWorkflowsAlreadyExist(product);
    Mockito.verify(getProductWorkflowRepository())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.eq(product.getId()));
  }

  @SuppressWarnings("unchecked")
  @Test
  public void checkProductWorkflowsAlreadyExistTestWithProductWorkflowIsEmpty() throws Exception {
    Product product = getProduct();
    List<ProductWorkflow> productWorkflows = new ArrayList<ProductWorkflow>();
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.eq(product.getId())))
        .thenReturn(productWorkflows);
    Mockito.when(getProductWorkflowRepository().saveAll((List<ProductWorkflow>) Mockito.any())).thenReturn(null);
    Mockito.doNothing().when(getProductWorkflowRepository()).flush();
    Mockito.when(getProductHistoryRepository().saveAll((List<ProductHistory>) Mockito.any())).thenReturn(null);
    Mockito.doNothing().when(getProductHistoryRepository()).flush();
    getProductServiceBean().checkProductWorkflowsAlreadyExist(product);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.eq(product.getId()));
    Mockito.verify(getProductWorkflowRepository()).saveAll((List<ProductWorkflow>) Mockito.any());
    Mockito.verify(getProductWorkflowRepository()).flush();
    Mockito.verify(getProductHistoryRepository()).saveAll((List<ProductHistory>) Mockito.any());
    Mockito.verify(getProductHistoryRepository()).flush();
  }

  @SuppressWarnings("unchecked")
  @Test
  public void checkProductWorkflowsAlreadyExistTestWithProductWorkflowIsNull() throws Exception {
    Product product = getProduct();
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.eq(product.getId())))
        .thenReturn(null);
    Mockito.when(getProductWorkflowRepository().saveAll((List<ProductWorkflow>) Mockito.any())).thenReturn(null);
    Mockito.doNothing().when(getProductWorkflowRepository()).flush();
    Mockito.when(getProductHistoryRepository().saveAll((List<ProductHistory>) Mockito.any())).thenReturn(null);
    Mockito.doNothing().when(getProductHistoryRepository()).flush();
    getProductServiceBean().checkProductWorkflowsAlreadyExist(product);
    Mockito.verify(getProductWorkflowRepository(), AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.eq(product.getId()));
    Mockito.verify(getProductWorkflowRepository()).saveAll((List<ProductWorkflow>) Mockito.any());
    Mockito.verify(getProductWorkflowRepository()).flush();
    Mockito.verify(getProductHistoryRepository()).saveAll((List<ProductHistory>) Mockito.any());
    Mockito.verify(getProductHistoryRepository()).flush();
  }

  @Test
  public void findProductItemByProductIdTest() throws Exception {
    getProductServiceBean().findProductItemByProductId(DEFAULT_PRODUCT_ID);
    Mockito.verify(getProductRepository()).findProductItemsByProductId(Mockito.anyString());
  }

  @Test
  public void findProductWorkflowsTest() throws Exception {
    Mockito.when(getProductWorkflowRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(new ArrayList<ProductWorkflow>());
    getProductServiceBean().findProductWorkflows(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID);
    Mockito.verify(getProductWorkflowRepository())
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
  }

  @Test
  public void generateBarcodeTest() throws Exception {
    Mockito.when(getProductItemRepository()
        .findByStoreIdAndUpcCodeExactMatch(Mockito.anyString(), Mockito.anyString(), (Pageable) Mockito.any()))
        .thenReturn(new PageImpl<ProductItem>(new ArrayList<ProductItem>()));
    getProductServiceBean().generateBarcode(DEFAULT_STORE_ID);
    Mockito.verify(getProductItemRepository())
        .findByStoreIdAndUpcCodeExactMatch(Mockito.anyString(), Mockito.anyString(), (Pageable) Mockito.any());
  }

  @Test
  public void generateShippingWeightTest() throws Exception {
    Product product = getProduct();
    Catalog masterCatalog = new Catalog();
    masterCatalog.setCatalogType(CatalogType.MASTER_CATALOG);
    Catalog salesCatalog = new Catalog();
    salesCatalog.setCatalogType(CatalogType.SALES_CATALOG);
    Category masterCategory = new Category();
    masterCategory.setLogisticAdjustment(100);
    masterCategory.setCatalog(masterCatalog);
    Category salesCategory = new Category();
    salesCategory.setLogisticAdjustment(100);
    salesCategory.setCatalog(salesCatalog);
    ProductCategory masterProductCategory = new ProductCategory();
    masterProductCategory.setCategory(masterCategory);
    ProductCategory salesProductCategory = new ProductCategory();
    salesProductCategory.setCategory(salesCategory);
    product.getProductCategories().add(masterProductCategory);
    product.getProductCategories().add(salesProductCategory);
    getProductServiceBean().generateShippingWeight(product);
  }

  @Test
  public void validateDuplicateProductProductNameTest() throws Exception {
    ProductCollection productCollection1 = new ProductCollection();
    productCollection1.setProductName(PRODUCT_NAME);
    productCollection1.setState(STATE);
    productCollection1.setProductId(PRODUCT_ID);
    List<ProductCollection> productCollectionList = new ArrayList<>();
    productCollectionList.add(productCollection1);

    ProductBusinessPartner productBusinessPartner1 = new ProductBusinessPartner();
    productBusinessPartner1.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner1.setState(STATE);
    productBusinessPartner1.setProductName(PRODUCT_NAME);
    List<ProductBusinessPartner> productBusinessPartnerList = new ArrayList<>();
    productBusinessPartnerList.add(productBusinessPartner1);

    Mockito.when(
            this.productCollectionRepository.findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(
                STORE_ID, validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(new ArrayList<>(productCollectionList));
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID,
        productCollectionList.get(0).getProductId())).thenReturn(productBusinessPartnerList);

    validateDuplicateProductRequest.setBySellerSku(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);

    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(STORE_ID,
            validateDuplicateProductRequest.getKeyword(), BP_CODE);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(STORE_ID, productCollectionList.get(0).getProductId());
    Assertions.assertEquals(PRODUCT_SKU, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(STATE, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(PRODUCT_NAME, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductProductNameCollectionListEmptyTest() throws Exception {
    ProductCollection productCollection1 = new ProductCollection();
    productCollection1.setProductName(PRODUCT_NAME);
    productCollection1.setState(STATE);
    productCollection1.setProductId(PRODUCT_ID);
    List<ProductCollection> productCollectionList = new ArrayList<>();
    productCollectionList.add(productCollection1);

    ProductBusinessPartner productBusinessPartner1 = new ProductBusinessPartner();
    productBusinessPartner1.setGdnProductSku(PRODUCT_SKU);
    List<ProductBusinessPartner> productBusinessPartnerList = new ArrayList<>();
    productBusinessPartnerList.add(productBusinessPartner1);

    Mockito.when(
            this.productCollectionRepository.findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(
                STORE_ID, validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(new ArrayList<>(new ArrayList<>()));

    validateDuplicateProductRequest.setBySellerSku(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);

    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(STORE_ID,
            validateDuplicateProductRequest.getKeyword(), BP_CODE);
  }

  @Test
  public void validateDuplicateProductProductNamePrdProductListEmptyTest() throws Exception {
    ProductCollection productCollection1 = new ProductCollection();
    productCollection1.setProductName(PRODUCT_NAME);
    productCollection1.setState(STATE);
    productCollection1.setProductId(PRODUCT_ID);
    List<ProductCollection> productCollectionList = new ArrayList<>();
    productCollectionList.add(productCollection1);

    ProductBusinessPartner productBusinessPartner1 = new ProductBusinessPartner();
    productBusinessPartner1.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner1.setMarkForDelete(true);
    List<ProductBusinessPartner> productBusinessPartnerList = new ArrayList<>();
    productBusinessPartnerList.add(productBusinessPartner1);

    ProductSkuAndProductCodeRequest productSkuAndProductCodeRequest = new ProductSkuAndProductCodeRequest();
    productSkuAndProductCodeRequest.setProductSku(PRODUCT_SKU);

    Mockito.when(
            this.productCollectionRepository.findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(
                STORE_ID, validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(new ArrayList<>(productCollectionList));
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID,
        productCollectionList.get(0).getProductId())).thenReturn(productBusinessPartnerList);
    Mockito.when(this.xProductOutbound.getPrdProductDetailByProductSkuOrProductCode(productSkuAndProductCodeRequest))
        .thenReturn(new ArrayList<>());

    validateDuplicateProductRequest.setBySellerSku(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);

    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(STORE_ID,
            validateDuplicateProductRequest.getKeyword(), BP_CODE);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(STORE_ID, productCollectionList.get(0).getProductId());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductProductNameSuspendedTest() throws Exception {
    ProductCollection productCollection1 = new ProductCollection();
    productCollection1.setProductName(PRODUCT_NAME);
    productCollection1.setState(STATE);
    productCollection1.setProductId(PRODUCT_ID);
    List<ProductCollection> productCollectionList = new ArrayList<>();
    productCollectionList.add(productCollection1);

    ProductBusinessPartner productBusinessPartner1 = new ProductBusinessPartner();
    productBusinessPartner1.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner1.setMarkForDelete(true);
    List<ProductBusinessPartner> productBusinessPartnerList = new ArrayList<>();
    productBusinessPartnerList.add(productBusinessPartner1);

    ProductSkuAndProductCodeRequest productSkuAndProductCodeRequest = new ProductSkuAndProductCodeRequest();
    productSkuAndProductCodeRequest.setProductSku(PRODUCT_SKU);

    PrdProductResponse prdProductResponse = new PrdProductResponse();
    prdProductResponse.setProductName(PRODUCT_NAME);
    prdProductResponse.setProductSku(PRODUCT_SKU);
    prdProductResponse.setSuspended(true);
    List<PrdProductResponse> prdProductResponseList = new ArrayList<>();
    prdProductResponseList.add(prdProductResponse);

    Mockito.when(
            this.productCollectionRepository.findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(
                STORE_ID, validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(new ArrayList<>(productCollectionList));
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID,
        productCollectionList.get(0).getProductId())).thenReturn(productBusinessPartnerList);
    Mockito.when(this.xProductOutbound.getPrdProductDetailByProductSkuOrProductCode(productSkuAndProductCodeRequest))
        .thenReturn(prdProductResponseList);

    validateDuplicateProductRequest.setBySellerSku(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);

    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(STORE_ID,
            validateDuplicateProductRequest.getKeyword(), BP_CODE);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(STORE_ID, productCollectionList.get(0).getProductId());
    Assertions.assertEquals(PRODUCT_SKU, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(com.gdn.x.product.enums.Constants.SUSPENDED, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(PRODUCT_NAME, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductProductNameArchivedTest() throws Exception {
    ProductCollection productCollection1 = new ProductCollection();
    productCollection1.setProductName(PRODUCT_NAME);
    productCollection1.setState(STATE);
    productCollection1.setProductId(PRODUCT_ID);
    List<ProductCollection> productCollectionList = new ArrayList<>();
    productCollectionList.add(productCollection1);

    ProductBusinessPartner productBusinessPartner1 = new ProductBusinessPartner();
    productBusinessPartner1.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner1.setMarkForDelete(true);
    List<ProductBusinessPartner> productBusinessPartnerList = new ArrayList<>();
    productBusinessPartnerList.add(productBusinessPartner1);

    ProductSkuAndProductCodeRequest productSkuAndProductCodeRequest = new ProductSkuAndProductCodeRequest();
    productSkuAndProductCodeRequest.setProductSku(PRODUCT_SKU);

    PrdProductResponse prdProductResponse = new PrdProductResponse();
    prdProductResponse.setProductName(PRODUCT_NAME);
    prdProductResponse.setProductSku(PRODUCT_SKU);
    prdProductResponse.setArchived(true);
    List<PrdProductResponse> prdProductResponseList = new ArrayList<>();
    prdProductResponseList.add(prdProductResponse);

    Mockito.when(
            this.productCollectionRepository.findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(
                STORE_ID, validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(new ArrayList<>(productCollectionList));
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID,
        productCollectionList.get(0).getProductId())).thenReturn(productBusinessPartnerList);
    Mockito.when(this.xProductOutbound.getPrdProductDetailByProductSkuOrProductCode(productSkuAndProductCodeRequest))
        .thenReturn(prdProductResponseList);

    validateDuplicateProductRequest.setBySellerSku(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);

    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(STORE_ID,
            validateDuplicateProductRequest.getKeyword(), BP_CODE);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(STORE_ID, productCollectionList.get(0).getProductId());
    Assertions.assertEquals(PRODUCT_SKU, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(com.gdn.x.product.enums.Constants.ARCHIVED, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(PRODUCT_NAME, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductProductNameActiveTest() throws Exception {
    ProductCollection productCollection1 = new ProductCollection();
    productCollection1.setProductName(PRODUCT_NAME);
    productCollection1.setState(STATE);
    productCollection1.setProductId(PRODUCT_ID);
    List<ProductCollection> productCollectionList = new ArrayList<>();
    productCollectionList.add(productCollection1);

    ProductBusinessPartner productBusinessPartner1 = new ProductBusinessPartner();
    productBusinessPartner1.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner1.setMarkForDelete(true);
    List<ProductBusinessPartner> productBusinessPartnerList = new ArrayList<>();
    productBusinessPartnerList.add(productBusinessPartner1);

    ProductSkuAndProductCodeRequest productSkuAndProductCodeRequest = new ProductSkuAndProductCodeRequest();
    productSkuAndProductCodeRequest.setProductSku(PRODUCT_SKU);

    PrdProductResponse prdProductResponse = new PrdProductResponse();
    prdProductResponse.setProductName(PRODUCT_NAME);
    prdProductResponse.setProductSku(PRODUCT_SKU);
    List<PrdProductResponse> prdProductResponseList = new ArrayList<>();
    prdProductResponseList.add(prdProductResponse);

    Mockito.when(
            this.productCollectionRepository.findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(
                STORE_ID, validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(new ArrayList<>(productCollectionList));
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID,
        productCollectionList.get(0).getProductId())).thenReturn(productBusinessPartnerList);
    Mockito.when(this.xProductOutbound.getPrdProductDetailByProductSkuOrProductCode(productSkuAndProductCodeRequest))
        .thenReturn(prdProductResponseList);

    validateDuplicateProductRequest.setBySellerSku(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);

    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(STORE_ID,
            validateDuplicateProductRequest.getKeyword(), BP_CODE);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(STORE_ID, productCollectionList.get(0).getProductId());
    Assertions.assertEquals(PRODUCT_SKU, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(com.gdn.x.product.enums.Constants.ACTIVE, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(PRODUCT_NAME, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductExceptionTest() throws Exception {
    validateDuplicateProductRequest.setBySellerSku(false);
    validateDuplicateProductRequest.setKeyword(StringUtils.EMPTY);
    assertThrows(ApplicationRuntimeException.class, () -> {
      this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);
    });
  }

  @Test
  public void validateDuplicateProductProductNameListEmptyTest() throws Exception {
    ProductCollection productCollection1 = new ProductCollection();
    productCollection1.setProductName(PRODUCT_NAME);
    productCollection1.setState(STATE);
    productCollection1.setProductId(PRODUCT_ID);
    List<ProductCollection> productCollectionList = new ArrayList<>();
    productCollectionList.add(productCollection1);

    Mockito.when(
            this.productCollectionRepository.findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(
                STORE_ID, validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(new ArrayList<>(productCollectionList));
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID,
        productCollectionList.get(0).getProductId())).thenReturn(new ArrayList<>());

    validateDuplicateProductRequest.setBySellerSku(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);

    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductNameAndBusinessPartnerCodeAndMarkForDeleteFalse(STORE_ID,
            validateDuplicateProductRequest.getKeyword(), BP_CODE);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(STORE_ID, productCollectionList.get(0).getProductId());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductSellerSkuTest() throws Exception {
    ProductBusinessPartner productBusinessPartner1 = new ProductBusinessPartner();
    productBusinessPartner1.setProductName(PRODUCT_NAME);
    productBusinessPartner1.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner1.setState(STATE);
    List<ProductBusinessPartner> productBusinessPartners1 = new ArrayList<>();
    productBusinessPartners1.add(productBusinessPartner1);
    List<String> bpId = new ArrayList<>();
    bpId.add(BP_ID);
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID,
        validateDuplicateProductRequest.getKeyword(), BP_CODE)).thenReturn(bpId);
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndId(STORE_ID, BP_ID))
        .thenReturn(productBusinessPartners1);
    productCollection.setProductName(PRODUCT_NAME);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductIds(eq(STORE_ID), Mockito.anyList()))
        .thenReturn(Arrays.asList(productCollection));
    validateDuplicateProductRequest.setByProductName(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);
    Mockito.verify(productBusinessPartnerRepository)
        .findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID, validateDuplicateProductRequest.getKeyword(),
            BP_CODE);
    Mockito.verify(this.productCollectionRepository).findByStoreIdAndProductIds(eq(STORE_ID), Mockito.anyList());
    Mockito.verify(this.productBusinessPartnerRepository).findByStoreIdAndId(STORE_ID, BP_ID);
    Assertions.assertEquals(PRODUCT_SKU, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(STATE, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(PRODUCT_NAME, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductSellerSkuProductCollectionListEmptyTest() throws Exception {
    ProductBusinessPartner productBusinessPartner1 = new ProductBusinessPartner();
    productBusinessPartner1.setProductName(PRODUCT_NAME);
    productBusinessPartner1.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner1.setState(STATE);
    List<ProductBusinessPartner> productBusinessPartners1 = new ArrayList<>();
    productBusinessPartners1.add(productBusinessPartner1);
    List<String> bpId = new ArrayList<>();
    bpId.add(BP_ID);
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID,
        validateDuplicateProductRequest.getKeyword(), BP_CODE)).thenReturn(bpId);
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndId(STORE_ID, BP_ID))
        .thenReturn(productBusinessPartners1);
    Mockito.when(this.productCollectionRepository.findByStoreIdAndProductIds(eq(STORE_ID), Mockito.anyList()))
        .thenReturn(new ArrayList());
    validateDuplicateProductRequest.setByProductName(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);
    Mockito.verify(productBusinessPartnerRepository)
        .findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID, validateDuplicateProductRequest.getKeyword(),
            BP_CODE);
    Mockito.verify(this.productCollectionRepository).findByStoreIdAndProductIds(eq(STORE_ID), Mockito.anyList());
    Mockito.verify(this.productBusinessPartnerRepository).findByStoreIdAndId(STORE_ID, BP_ID);
    Assertions.assertEquals(null, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductSellerSkuProductBusinessPartnerListEmptyTest() throws Exception {
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setProductBusinessPartnerId(ID);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    DuplicateProductDetailsResponse duplicateProductDetailsResponse = new DuplicateProductDetailsResponse();
    duplicateProductDetailsResponse.setProductName(PRODUCT_NAME);
    duplicateProductDetailsResponse.setProductSku(PRODUCT_SKU);
    duplicateProductDetailsResponse.setStatus(STATE);
    List<String> bpId = new ArrayList<>();
    bpId.add(BP_ID);
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID,
        validateDuplicateProductRequest.getKeyword(), BP_CODE)).thenReturn(bpId);
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndId(STORE_ID, BP_ID))
        .thenReturn(new ArrayList<>());
    Mockito.when(
            xProductOutbound.validateDuplicateProductBySellerSku(validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(duplicateProductDetailsResponse);
    validateDuplicateProductRequest.setByProductName(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);
    Mockito.verify(productBusinessPartnerRepository)
        .findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID, validateDuplicateProductRequest.getKeyword(),
            BP_CODE);
    Mockito.verify(this.productBusinessPartnerRepository).findByStoreIdAndId(STORE_ID, BP_ID);
    Mockito.verify(xProductOutbound)
        .validateDuplicateProductBySellerSku(validateDuplicateProductRequest.getKeyword(), BP_CODE);
    Assertions.assertEquals(PRODUCT_SKU, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(STATE, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(PRODUCT_NAME, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductSellerSkuProductBusinessPartnerIdListEmptyTest() throws Exception {
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setProductBusinessPartnerId(ID);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    DuplicateProductDetailsResponse duplicateProductDetailsResponse = new DuplicateProductDetailsResponse();
    duplicateProductDetailsResponse.setProductName(PRODUCT_NAME);
    duplicateProductDetailsResponse.setProductSku(PRODUCT_SKU);
    duplicateProductDetailsResponse.setStatus(STATE);
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID,
        validateDuplicateProductRequest.getKeyword(), BP_CODE)).thenReturn(new ArrayList<>());
    Mockito.when(
            xProductOutbound.validateDuplicateProductBySellerSku(validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(duplicateProductDetailsResponse);
    validateDuplicateProductRequest.setByProductName(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);
    Mockito.verify(productBusinessPartnerRepository)
        .findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID, validateDuplicateProductRequest.getKeyword(),
            BP_CODE);
    Mockito.verify(xProductOutbound)
        .validateDuplicateProductBySellerSku(validateDuplicateProductRequest.getKeyword(), BP_CODE);
    Assertions.assertEquals(PRODUCT_SKU, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(STATE, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(PRODUCT_NAME, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void validateDuplicateProductSellerSkuDuplicateProductResponseNullTest() throws Exception {
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    ProductItemBusinessPartner productItemBusinessPartner = new ProductItemBusinessPartner();
    productItemBusinessPartner.setProductBusinessPartnerId(ID);
    productItemBusinessPartnerList.add(productItemBusinessPartner);
    DuplicateProductDetailsResponse duplicateProductDetailsResponse = new DuplicateProductDetailsResponse();
    duplicateProductDetailsResponse.setProductName(PRODUCT_NAME);
    duplicateProductDetailsResponse.setProductSku(PRODUCT_SKU);
    duplicateProductDetailsResponse.setStatus(STATE);
    Mockito.when(this.productBusinessPartnerRepository.findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID,
        validateDuplicateProductRequest.getKeyword(), BP_CODE)).thenReturn(null);
    Mockito.when(
            xProductOutbound.validateDuplicateProductBySellerSku(validateDuplicateProductRequest.getKeyword(), BP_CODE))
        .thenReturn(null);
    validateDuplicateProductRequest.setByProductName(false);
    ValidateDuplicateProductResponse validateDuplicateProductResponse =
        this.productServiceBean.validateDuplicateProduct(STORE_ID, BP_CODE, validateDuplicateProductRequest);
    Mockito.verify(productBusinessPartnerRepository)
        .findByStoreIdAndMerchantSkuAndBusinessPartnerId(STORE_ID, validateDuplicateProductRequest.getKeyword(),
            BP_CODE);
    Mockito.verify(xProductOutbound)
        .validateDuplicateProductBySellerSku(validateDuplicateProductRequest.getKeyword(), BP_CODE);
    Assertions.assertEquals(null, validateDuplicateProductResponse.getProductSku());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getStatus());
    Assertions.assertEquals(null, validateDuplicateProductResponse.getProductName());
  }

  @Test
  public void testfindByStoreIdAndNameOrUpcCode() throws Exception {
    final List<ProductCodeResponse> productCodeResponseList = new ArrayList<>();
    productCodeResponseList.add(new ProductCodeResponse("product_code", "product_name"));
    final List<AttributeReqModel> attributeReqModelList = new ArrayList<>();
    attributeReqModelList.add(new AttributeReqModel("name", "value"));
    final Page<ProductCodeResponse> page = new PageImpl<ProductCodeResponse>(productCodeResponseList);
    Mockito.when(getProductItemRepository()
        .findByStoreIdAndNameOrUpcCode(DEFAULT_STORE_ID, PRODUCT_NAME, UPC_CODE, FINAL_CATEGORY_ID,
            attributeReqModelList, DEFAULT_PAGEABLE)).thenReturn(page);
    getProductServiceBean()
        .findByNameOrUpcCode(DEFAULT_STORE_ID, PRODUCT_NAME, UPC_CODE, FINAL_CATEGORY_ID, attributeReqModelList,
            DEFAULT_PAGEABLE);
    Mockito.verify(getProductItemRepository(), AT_LEAST_ONE)
        .findByStoreIdAndNameOrUpcCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(PRODUCT_NAME), Mockito.eq(UPC_CODE),
            Mockito.eq(FINAL_CATEGORY_ID), Mockito.eq(attributeReqModelList), Mockito.eq(DEFAULT_PAGEABLE));
  }

  public Page<ProductCollection> generateProductCollection() throws ParseException {
    List<ProductCollection> listProductCollection = new ArrayList<ProductCollection>();
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    productCollection.setBusinessPartnerName(DEFAULT_BUSINESS_PARTNER_NAME);
    listProductCollection.add(productCollection);
    Page<ProductCollection> productCollections =
        new PageImpl<ProductCollection>(listProductCollection, DEFAULT_PAGEABLE, listProductCollection.size());
    return productCollections;
  }

  @Test
  public void processImageTest() throws Exception {
    this.productServiceBean
        .processImage(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE, false);
    Mockito.verify(this.productWorkflowService)
        .processImage(Mockito.anyString(), Mockito.anyString(), Mockito.anyBoolean());
  }

  @Test
  public void rejectProcessImageTest() throws Exception {
    this.productServiceBean
        .rejectProcessImage(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE);
    Mockito.verify(this.productWorkflowService).rejectProcessImage(Mockito.anyString(), Mockito.anyString());
  }

  @SuppressWarnings("unchecked")
  @Test
  public void approveImageTest() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    productData.setProductCode("MTA-" + UUID.randomUUID().toString());
    productData.setId(UUID.randomUUID().toString());
    productData.setStoreId(DEFAULT_STORE_ID);
    productData.setCreatedBy(DEFAULT_USERNAME);
    productData.setCreatedDate(Calendar.getInstance().getTime());
    productData.setUpdatedBy(DEFAULT_USERNAME);
    productData.setUpdatedDate(Calendar.getInstance().getTime());
    productData.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.setProductItemResponses(new HashSet<ProductItemResponse>());
    productData.setProductAttributeResponses(new ArrayList<ProductAttributeResponse>());
    productData.setImages(new ArrayList<Image>());
    ProductItemResponse productItemData = new ProductItemResponse();
    productItemData.setId(UUID.randomUUID().toString());
    productItemData.setImages(new ArrayList<Image>());
    productItemData.getImages().add(new Image());
    productItemData.setSkuCode(productData.getProductCode() + UUID.randomUUID().toString());
    productItemData.setGeneratedItemName(PRODUCT_ITEM_NAME);
    AttributeResponse attributeData = new AttributeResponse();
    attributeData.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    ProductAttributeResponse productAttributeData = new ProductAttributeResponse();
    productAttributeData.setAttribute(attributeData);
    productData.getProductItemResponses().add(productItemData);
    productData.getProductAttributeResponses().add(productAttributeData);
    productData.getImages().add(new Image());
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productLevel3Service.create(Mockito.anyString(),
        (ProductDetailResponse) Mockito.any(), Mockito.any(ProductBusinessPartner.class),
        eq(true), Mockito.anyList())).thenReturn(true);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(this.productMailEventService.getCategoryChangeMailEvent(anyString(), anyString())).thenReturn(null);
    this.productServiceBean
        .approveImage(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE, false);
    Mockito.verify(this.productWorkflowService)
        .approveImage(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE),
            Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository).updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service, ProductServiceBeanTest.AT_LEAST_TWO).create(
        Mockito.anyString(), (ProductDetailResponse) Mockito.any(), Mockito.any(),
        eq(true), Mockito.anyList());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
    Mockito.verify(this.productNotificationService, Mockito.times(2))
        .sendProductActiveNotification(businessPartnerCodeCaptor.capture(), Mockito.anyString(), Mockito.any(), Mockito.anyBoolean());
    List<String> businessPartnerCodes = businessPartnerCodeCaptor.getAllValues();
    Assertions.assertTrue(businessPartnerCodes.contains(BUSINESS_PARTNER_ID));
    Mockito.verify(this.productMailEventService, times(2))
        .getCategoryChangeMailEvent(eq(DEFAULT_STORE_ID), anyString());
    Mockito.verify(productImageQcProcessingResponseService, times(2))
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, productData.getProductCode());
  }


  @Test
  public void approveImageNotifTest() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    productData.setProductCode("MTA-" + UUID.randomUUID().toString());
    productData.setId(UUID.randomUUID().toString());
    productData.setStoreId(DEFAULT_STORE_ID);
    productData.setCreatedBy(DEFAULT_USERNAME);
    productData.setCreatedDate(Calendar.getInstance().getTime());
    productData.setUpdatedBy(DEFAULT_USERNAME);
    productData.setUpdatedDate(Calendar.getInstance().getTime());
    productData.setProductCategoryResponses(new ArrayList<>());
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.setProductItemResponses(new HashSet<>());
    productData.setProductAttributeResponses(new ArrayList<>());
    productData.setImages(new ArrayList<Image>());
    ProductItemResponse productItemData = new ProductItemResponse();
    productItemData.setId(UUID.randomUUID().toString());
    productItemData.setImages(new ArrayList<Image>());
    productItemData.getImages().add(new Image());
    productItemData.setSkuCode(productData.getProductCode() + UUID.randomUUID().toString());
    productItemData.setGeneratedItemName(PRODUCT_ITEM_NAME);
    AttributeResponse attributeData = new AttributeResponse();
    attributeData.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    ProductAttributeResponse productAttributeData = new ProductAttributeResponse();
    productAttributeData.setAttribute(attributeData);
    productData.getProductItemResponses().add(productItemData);
    productData.getProductAttributeResponses().add(productAttributeData);
    productData.getImages().add(new Image());
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productLevel3Service.create(Mockito.anyString(),
        (ProductDetailResponse) Mockito.any(), Mockito.any(ProductBusinessPartner.class),
        eq(true), Mockito.anyList())).thenReturn(true);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    CategoryChangeMailEvent categoryChangeMailEvent = new CategoryChangeMailEvent();
    categoryChangeMailEvent.setNewCategoryCode(CATEGORY_CODE);
    Mockito.when(this.productMailEventService.getCategoryChangeMailEvent(anyString(), anyString())).thenReturn(categoryChangeMailEvent);
    this.productServiceBean
        .approveImage(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE, false);
    Mockito.verify(this.productWorkflowService)
        .approveImage(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE),
            Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository).updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service, ProductServiceBeanTest.AT_LEAST_TWO).create(
        Mockito.anyString(), Mockito.any(), Mockito.any(),
        eq(true), Mockito.anyList());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
    Mockito.verify(this.productNotificationService, Mockito.times(2))
        .sendProductActiveNotification(businessPartnerCodeCaptor.capture(), Mockito.any(CategoryChangeMailEvent.class),
            Mockito.anyString(), Mockito.anyBoolean());
    List<String> businessPartnerCodes = businessPartnerCodeCaptor.getAllValues();
    Assertions.assertTrue(businessPartnerCodes.contains(BUSINESS_PARTNER_ID));
    Mockito.verify(this.productMailEventService, times(2))
        .getCategoryChangeMailEvent(eq(DEFAULT_STORE_ID), anyString());
    Mockito.verify(productImageQcProcessingResponseService, times(2))
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, productData.getProductCode());
  }

  @Test
  public void setReviewPendingFlagToFalseTest() throws Exception{
    ProductCollection collection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, true, true,
            "DRAFT", DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse(
                "2016-01-01"), DEFAULT_STORE_ID);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE)).thenReturn(collection);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(solrProductCollectionDTOArgumentCaptor.capture());
    Mockito.when(pcbFeign.updateProductReviewPending(DEFAULT_STORE_ID, Constants.DEFAULT_CHANNEL_ID,
        Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME, DEFAULT_PRODUCT_CODE, true)).thenReturn(new GdnBaseRestResponse(REQUEST_ID));
    this.productServiceBean.setReviewPendingFlagToTrue(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(ProductServiceBeanTest.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(this.productCollectionRepository).save(collection);
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(pcbFeign).updateProductReviewPending(DEFAULT_STORE_ID, Constants.DEFAULT_CHANNEL_ID,
        Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,DEFAULT_PRODUCT_CODE, true);
  }

  @SuppressWarnings("unchecked")
  @Test
  public void approveImageWithExceptionTest() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    productData.setProductCode("MTA-" + UUID.randomUUID().toString());
    productData.setId(UUID.randomUUID().toString());
    productData.setStoreId(DEFAULT_STORE_ID);
    productData.setCreatedBy(DEFAULT_USERNAME);
    productData.setCreatedDate(Calendar.getInstance().getTime());
    productData.setUpdatedBy(DEFAULT_USERNAME);
    productData.setUpdatedDate(Calendar.getInstance().getTime());
    productData.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.setProductItemResponses(new HashSet<ProductItemResponse>());
    productData.setProductAttributeResponses(new ArrayList<ProductAttributeResponse>());
    productData.setImages(new ArrayList<Image>());
    ProductItemResponse productItemData = new ProductItemResponse();
    productItemData.setId(UUID.randomUUID().toString());
    productItemData.setImages(new ArrayList<Image>());
    productItemData.getImages().add(new Image());
    productItemData.setSkuCode(productData.getProductCode() + UUID.randomUUID().toString());
    productItemData.setGeneratedItemName(PRODUCT_ITEM_NAME);
    AttributeResponse attributeData = new AttributeResponse();
    attributeData.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    ProductAttributeResponse productAttributeData = new ProductAttributeResponse();
    productAttributeData.setAttribute(attributeData);
    productData.getProductItemResponses().add(productItemData);
    productData.getProductAttributeResponses().add(productAttributeData);
    productData.getImages().add(new Image());
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.doThrow(Exception.class).when(this.productLevel3Service).create(Mockito.anyString(),
        (ProductDetailResponse) Mockito.any(), Mockito.any(), eq(true),
        Mockito.anyList());
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    Mockito.when(this.productMailEventService.getCategoryChangeMailEvent(anyString(), anyString())).thenReturn(null);
    this.productServiceBean
        .approveImage(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE, false);
    Mockito.verify(this.productLevel3RetryService).upsertProductLevel3FailureLog(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU);
    Mockito.verify(this.productWorkflowService)
        .approveImage(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE),
            Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository).updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service).create(Mockito.anyString(),
        (ProductDetailResponse) Mockito.any(), Mockito.any(), eq(true),
        Mockito.anyList());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(this.productGdnSkuGeneratorService)
        .convertToGeneratedGdnSkus(Mockito.any(ProductBusinessPartner.class));
  }

  @SuppressWarnings("unchecked")
  @Test
  public void approveImageAndIsActiveFalseTest() throws Exception {
    this.productServiceBean
        .approveImage(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE_2, false);
    Mockito.verify(this.productWorkflowService)
        .approveImage(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE_2),
            Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository, ProductServiceBeanTest.AT_LEAST_NONE)
        .updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.verify(this.productRepository, ProductServiceBeanTest.AT_LEAST_NONE)
        .findProductDetailByProductCode(Mockito.anyString(), Mockito.eq(false));
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_NONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service, ProductServiceBeanTest.AT_LEAST_NONE).create(
        Mockito.anyString(), (ProductDetailResponse) Mockito.any(), Mockito.any(),
        eq(false), Mockito.anyList());
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_NONE)
        .save(Mockito.any(ProductBusinessPartner.class));
    Mockito.verify(this.productCollectionRepository, ProductServiceBeanTest.AT_LEAST_NONE)
        .save((ProductCollection) Mockito.any());
  }

  @Test
  public void updateProductImageNameTest() throws Exception {
    ActivateImageRequest request = new ActivateImageRequest(DEFAULT_PRODUCT_CODE, DEFAULT_HASH_CODE, DEFAULT_FILENAME);
    Mockito.when(getProductRepository().updateProductImageName(Mockito.any()))
        .thenReturn(new ActivateImageResponse());
    this.productServiceBean.updateProductImageName(request);
    Mockito.verify(getProductRepository(), Mockito.times(1)).updateProductImageName(Mockito.any());
  }

  @Test
  public void updateProductImagesNameTest() throws Exception {
    ProductActivateImageRequest request = new ProductActivateImageRequest(DEFAULT_PRODUCT_CODE, new HashSet<>());
    Mockito.when(productOutbound.updateProductImagesName(Mockito.any(), Mockito.eq(true)))
        .thenReturn(new ActivateImageResponse());
    this.productServiceBean.updateProductImagesName(request, true);
    Mockito.verify(productOutbound).updateProductImagesName(Mockito.any(), Mockito.eq(true));
  }

  @Test
  public void updateAndPublishPDT() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    ProductCollection productCollection1 =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE_2, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollections.add(productCollection);
    productCollections.add(productCollection1);
    productCollection.setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Product product = getProduct();
    List<ProductCategory> productCategories = new ArrayList<ProductCategory>();
    ProductCategory productCategory =
        new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori Code", "Kategori 1"), DEFAULT_STORE_ID);
    productCategories.add(productCategory);
    product.setProductCategories(productCategories);
    product.setProductCode(DEFAULT_PRODUCT_CODE);
    product.setStoreId(DEFAULT_STORE_ID);
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    productDetailResponse.setProductCode(product.getProductCode());
    productDetailResponse.setStoreId(DEFAULT_STORE_ID);
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductRepository().findOne(Mockito.anyString())).thenReturn(product);
    Mockito.when(getProductRepository().findProductDetailByProductCode(Mockito.anyString()))
        .thenReturn(productDetailResponse);
    Mockito.when(getProductPublisherService()
        .publish(Mockito.anyString(), Mockito.anyString(), Mockito.anyString(), Mockito.anyString(), Mockito.eq(false),
            Mockito.eq(false), Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.eq(productCollection.getPrioritySeller()),
          eq(false), Mockito.any(), any()))
        .thenReturn(new ScreeningProductApprovalEvent());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    productCollections.get(0).setPostLive(Boolean.TRUE);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getProductCode()))
        .thenReturn(productCollections.get(0));
    this.productServiceBean.publishToPDTByProductCode(DEFAULT_STORE_ID, product.getProductCode());
    Mockito.verify(getProductPublisherService())
        .publish(Mockito.eq(DEFAULT_PRODUCT_CODE), Mockito.eq(BP_CODE), Mockito.eq(BP_NAME), Mockito.any(),
            Mockito.eq(true), Mockito.eq(false), Mockito.eq(RESTRICTED_KEYWORDS_FIELD),
            Mockito.eq(productCollection.getPrioritySeller()), eq(false), Mockito.any(), any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
  }

  @Test
  public void updateAndPublishPDT_forTrustedSellers() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    ProductCollection productCollection =
      new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
        "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
        DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    ProductCollection productCollection1 =
      new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE_2, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
        "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
        DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollections.add(productCollection);
    productCollections.add(productCollection1);
    productCollection.setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Product product = getProduct();
    List<ProductCategory> productCategories = new ArrayList<ProductCategory>();
    ProductCategory productCategory =
      new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori Code", "Kategori 1"), DEFAULT_STORE_ID);
    productCategories.add(productCategory);
    product.setProductCategories(productCategories);
    product.setProductCode(DEFAULT_PRODUCT_CODE);
    product.setStoreId(DEFAULT_STORE_ID);
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    productDetailResponse.setProductCode(product.getProductCode());
    productDetailResponse.setStoreId(DEFAULT_STORE_ID);
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);
    Page<ProductBusinessPartner> productBusinessPartnerPage =
      new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    Mockito.when(getProductBusinessPartnerRepository()
      .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
        Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductRepository().findOne(Mockito.anyString())).thenReturn(product);
    Mockito.when(getProductRepository().findProductDetailByProductCode(Mockito.anyString()))
      .thenReturn(productDetailResponse);
    Mockito.when(getProductPublisherService()
        .publish(Mockito.anyString(), Mockito.anyString(), Mockito.anyString(), Mockito.anyString(), Mockito.eq(false),
          Mockito.eq(false), Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.eq(productCollection.getPrioritySeller()),
          eq(true), Mockito.any(), any()))
      .thenReturn(new ScreeningProductApprovalEvent());
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(true);
    productCollections.get(0).setPostLive(Boolean.TRUE);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getProductCode()))
      .thenReturn(productCollections.get(0));
    this.productServiceBean.publishToPDTByProductCode(DEFAULT_STORE_ID, product.getProductCode());
    Mockito.verify(getProductPublisherService())
      .publish(Mockito.eq(DEFAULT_PRODUCT_CODE), Mockito.eq(BP_CODE), Mockito.eq(BP_NAME), Mockito.anyString(),
        Mockito.eq(true), Mockito.eq(false), Mockito.eq(RESTRICTED_KEYWORDS_FIELD),
        Mockito.eq(productCollection.getPrioritySeller()), eq(true), Mockito.any(), Mockito.eq(productCollection));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
  }

  @Test
  public void publishToPDTByProductCodeRevised() throws Exception {
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollection.setResubmitCount(2);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    Mockito.when(getProductCollectionRepository()
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    this.productServiceBean.publishToPDTByProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productPublisherService).publishRevisedProductToPDT(
            ConverterUtil.toAddRevisedProductToPDTEvent(productCollection,
              Constants.DEFAULT_USERNAME, false, productBusinessPartner, false, null, false, 0));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
  }

  @Test
  public void publishToPDTByProductCodeRevised_forTrustedSellers() throws Exception {
    ProductCollection productCollection =
      new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
        "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
        DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollection.setResubmitCount(2);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(true);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    this.productServiceBean.publishToPDTByProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    ProductBusinessPartner productBusinessPartner = productBusinessPartnerService
        .findFirstByStoreIdAndProductId(productCollection.getStoreId(), productCollection.getProductId());
    Mockito.verify(productPublisherService).publishRevisedProductToPDT(
      ConverterUtil.toAddRevisedProductToPDTEvent(productCollection,
        Constants.DEFAULT_USERNAME, true, productBusinessPartner, false, null, false, 0));
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Mockito.verify(productBusinessPartnerService, times(2)).findFirstByStoreIdAndProductId(any(), any());
  }

  @Test
  public void publishToPDTByProductCodeRevisedWithourResubmitCount() throws Exception {
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollection.setNeedRevision(true);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    Mockito.when(getProductCollectionRepository()
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    this.productServiceBean.publishToPDTByProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(getProductPublisherService()).publishRevisedProductToPDT(
        ConverterUtil.toAddRevisedProductToPDTEvent(productCollection, Constants.DEFAULT_USERNAME
          , false, productBusinessPartner, false, null, false, 0));
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
  }

  @Test
  public void publishToPDTByProductCodeRevisedEdited() throws Exception {
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollection.setEdited(true);
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(null);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    Mockito.when(getProductCollectionRepository()
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    this.productServiceBean.publishToPDTByProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(kafkaProducer)
        .send(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT, productCollection.getProductCode(),
            AddProductToVendorCombinedEventModel.builder().addEditedProductToPDTEvent(
                ConverterUtil.toAddEditedProductToPDTEvent(DEFAULT_STORE_ID, productCollection.getReviewType(),
                    productCollection, new ArrayList<>(), profileResponse, productBusinessPartner, false, 0)).build());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
  }

  @Test
  public void updateAndPublishPDTError() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    ProductCollection productCollection1 =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE_2, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollections.add(productCollection);
    productCollections.add(productCollection1);
    productCollection.setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Product product = getProduct();
    List<ProductCategory> productCategories = new ArrayList<ProductCategory>();
    ProductCategory productCategory =
        new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori Code", "Kategori 1"), DEFAULT_STORE_ID);
    productCategories.add(productCategory);
    product.setProductCategories(productCategories);
    product.setProductCode(DEFAULT_PRODUCT_CODE);
    product.setStoreId(DEFAULT_STORE_ID);
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    productDetailResponse.setProductCode(product.getProductCode());
    productDetailResponse.setStoreId(DEFAULT_STORE_ID);
    ProductBusinessPartner productBusinessPartner = getProductBusinessPartner();
    List<ProductBusinessPartner> productBusinessPartners = new ArrayList<ProductBusinessPartner>();
    productBusinessPartners.add(productBusinessPartner);
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(productBusinessPartners);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.eq(product.getId()),
            Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductRepository().findOne(Mockito.anyString())).thenReturn(product);

    Mockito.doThrow(Exception.class).when(getProductRepository())
        .findProductDetailByProductCode(Mockito.anyString(), Mockito.eq(false));
    Mockito.when(getProductPublisherService()
        .publish(Mockito.anyString(), Mockito.anyString(), Mockito.anyString(), Mockito.anyString(), Mockito.eq(false),
            Mockito.eq(false), Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.eq(productCollection.getPrioritySeller()),
          eq(false), any(), any()))
        .thenReturn(new ScreeningProductApprovalEvent());
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, product.getProductCode()))
        .thenReturn(productCollections.get(0));
    this.productServiceBean.publishToPDTByProductCode(DEFAULT_STORE_ID, product.getProductCode());
    Mockito.verify(getProductPublisherService())
        .publish(Mockito.eq(DEFAULT_PRODUCT_CODE), Mockito.eq(BP_CODE), Mockito.eq(BP_NAME), Mockito.any(),
            Mockito.eq(false), Mockito.eq(false), Mockito.eq(RESTRICTED_KEYWORDS_FIELD),
            Mockito.eq(productCollection.getPrioritySeller()), eq(false), any(), any());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
  }

  @SuppressWarnings("unchecked")
  @Test
  public void approveContentTest() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    ProductItemResponse productItemData = getProductItemResponse(productData);
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productMailEventService.getCategoryChangeMailEvent(Mockito.any(), Mockito.any()))
        .thenReturn(null);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.any())).thenReturn(productData);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.any(), Mockito.any()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productLevel3Service.create(Mockito.any(),
        (ProductDetailResponse) Mockito.any(), Mockito.any(), eq(true),
        Mockito.anyList())).thenReturn(true);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    this.productServiceBean
        .approveContent(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE, false,
            false);
    Mockito.verify(this.productWorkflowService)
        .approveContent(Mockito.any(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE),
            Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.any());
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.any(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service, ProductServiceBeanTest.AT_LEAST_TWO).create(
        Mockito.any(), (ProductDetailResponse) Mockito.any(), Mockito.any(),
        eq(true), Mockito.anyList());
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .saveAll(Mockito.anyList());
    Mockito.verify(this.productRepository).updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
    Mockito.verify(this.productNotificationService, Mockito.times(2))
        .sendProductActiveNotification(businessPartnerCodeCaptor.capture(), Mockito.anyString(), Mockito.any(), Mockito.anyBoolean());
    List<String> businessPartnerCodes = businessPartnerCodeCaptor.getAllValues();
    Assertions.assertTrue(businessPartnerCodes.contains(BUSINESS_PARTNER_ID));
    Mockito.verify(this.productMailEventService, times(2))
        .getCategoryChangeMailEvent(eq(DEFAULT_STORE_ID), any());
    Mockito.verify(productImageQcProcessingResponseService, times(2))
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, productData.getProductCode());
  }

  @SuppressWarnings("unchecked")
  @Test
  public void approveContentWithoutGdnSkuTest() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    ProductItemResponse productItemData = getProductItemResponse(productData);
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    productBusinessPartnerData.setGdnProductSku(null);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productLevel3Service.create(Mockito.anyString(),
        (ProductDetailResponse) Mockito.any(), Mockito.any(), eq(true),
        Mockito.anyList())).thenReturn(true);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    this.productServiceBean
        .approveContent(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE, false,
            false);
    Mockito.verify(this.productWorkflowService)
        .approveContent(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE),
            Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service, ProductServiceBeanTest.AT_LEAST_TWO).create(
        Mockito.anyString(), (ProductDetailResponse) Mockito.any(), Mockito.any(),
        eq(true), Mockito.anyList());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .saveAll(productBusinessPartnerListCaptor.capture());
    Mockito.verify(this.productRepository).updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
    Mockito.verify(this.productGdnSkuGeneratorService, Mockito.times(productBusinessPartnerDatas.size()))
        .generateGdnSkuOnProduct(Mockito.any(ProductBusinessPartner.class), eq(false));
    Mockito.verify(this.productNotificationService, Mockito.times(2))
        .sendProductActiveNotification(businessPartnerCodeCaptor.capture(), (String) Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    List<String> businessPartnerCodes = businessPartnerCodeCaptor.getAllValues();
    Assertions.assertTrue(businessPartnerCodes.contains(BUSINESS_PARTNER_ID));
    Mockito.verify(this.productMailEventService, times(2))
        .getCategoryChangeMailEvent(eq(DEFAULT_STORE_ID), any());
    Mockito.verify(productImageQcProcessingResponseService, times(2))
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, productData.getProductCode());
    Assertions.assertEquals(ACTIVE, productBusinessPartnerListCaptor.getValue().get(0).getState());
  }

  @Test
  public void approveContentWithoutGdnSkuForceReviewTest() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    ProductItemResponse productItemData = getProductItemResponse(productData);
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    productBusinessPartnerData.setState(IN_PROGRESS);
    productBusinessPartnerData.setGdnProductSku(null);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productLevel3Service
        .create(Mockito.anyString(), Mockito.any(), Mockito.any(), eq(true), Mockito.anyList()))
        .thenReturn(true);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    productImageQcProcessingResponse.setForceReview(true);
    Mockito.when(productImageQcProcessingResponseService
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, productData.getProductCode()))
        .thenReturn(productImageQcProcessingResponse);
    this.productServiceBean
        .approveContent(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE, false,
            false);
    Mockito.verify(this.productWorkflowService)
        .approveContent(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE),
            Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service, ProductServiceBeanTest.AT_LEAST_TWO).create(
        Mockito.anyString(), Mockito.any(), Mockito.any(),
        eq(true), Mockito.anyList());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .saveAll(productBusinessPartnerListCaptor.capture());
    Mockito.verify(this.productRepository).updateViewable(Mockito.any(), Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
    Mockito.verify(this.productGdnSkuGeneratorService, Mockito.times(productBusinessPartnerDatas.size()))
        .generateGdnSkuOnProduct(Mockito.any(ProductBusinessPartner.class), eq(false));
    Mockito.verify(this.productNotificationService, Mockito.times(2))
        .sendProductActiveNotification(businessPartnerCodeCaptor.capture(), (String) Mockito.any(), Mockito.any(), Mockito.anyBoolean());
    List<String> businessPartnerCodes = businessPartnerCodeCaptor.getAllValues();
    Assertions.assertTrue(businessPartnerCodes.contains(BUSINESS_PARTNER_ID));
    Mockito.verify(this.productMailEventService, times(2))
        .getCategoryChangeMailEvent(eq(DEFAULT_STORE_ID), any());
    Mockito.verify(productImageQcProcessingResponseService, times(2))
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, productData.getProductCode());
    Assertions.assertEquals(IN_PROGRESS, productBusinessPartnerListCaptor.getValue().get(0).getState());
  }

  private ProductItemResponse getProductItemResponse(ProductDetailResponse productData) {
    productData.setProductCode("MTA-" + UUID.randomUUID().toString());
    productData.setId(UUID.randomUUID().toString());
    productData.setStoreId(DEFAULT_STORE_ID);
    productData.setCreatedBy(DEFAULT_USERNAME);
    productData.setCreatedDate(Calendar.getInstance().getTime());
    productData.setUpdatedBy(DEFAULT_USERNAME);
    productData.setUpdatedDate(Calendar.getInstance().getTime());
    productData.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.getProductCategoryResponses().get(0).setMarkForDelete(true);
    productData.setProductItemResponses(new HashSet<ProductItemResponse>());
    productData.setProductAttributeResponses(new ArrayList<ProductAttributeResponse>());
    productData.setImages(new ArrayList<Image>());
    ProductItemResponse productItemData = new ProductItemResponse();
    productItemData.setId(UUID.randomUUID().toString());
    productItemData.setImages(new ArrayList<Image>());
    productItemData.getImages().add(new Image());
    productItemData.setSkuCode(productData.getProductCode() + UUID.randomUUID().toString());
    productItemData.setGeneratedItemName(PRODUCT_ITEM_NAME);
    AttributeResponse attributeData = new AttributeResponse();
    attributeData.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    ProductAttributeResponse productAttributeData = new ProductAttributeResponse();
    productAttributeData.setAttribute(attributeData);
    productData.getProductItemResponses().add(productItemData);
    productData.getProductAttributeResponses().add(productAttributeData);
    productData.getImages().add(new Image());
    return productItemData;
  }

  @SuppressWarnings("unchecked")
  @Test
  public void approveContentWithExceptionTest() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    productData.setProductCode("MTA-" + UUID.randomUUID().toString());
    productData.setId(UUID.randomUUID().toString());
    productData.setStoreId(DEFAULT_STORE_ID);
    productData.setCreatedBy(DEFAULT_USERNAME);
    productData.setCreatedDate(Calendar.getInstance().getTime());
    productData.setUpdatedBy(DEFAULT_USERNAME);
    productData.setUpdatedDate(Calendar.getInstance().getTime());
    productData.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.setProductItemResponses(new HashSet<ProductItemResponse>());
    productData.setProductAttributeResponses(new ArrayList<ProductAttributeResponse>());
    productData.setImages(new ArrayList<Image>());
    ProductItemResponse productItemData = new ProductItemResponse();
    productItemData.setId(UUID.randomUUID().toString());
    productItemData.setImages(new ArrayList<Image>());
    productItemData.getImages().add(new Image());
    productItemData.setSkuCode(productData.getProductCode() + UUID.randomUUID().toString());
    productItemData.setGeneratedItemName(PRODUCT_ITEM_NAME);
    AttributeResponse attributeData = new AttributeResponse();
    attributeData.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    ProductAttributeResponse productAttributeData = new ProductAttributeResponse();
    productAttributeData.setAttribute(attributeData);
    productData.getProductItemResponses().add(productItemData);
    productData.getProductAttributeResponses().add(productAttributeData);
    productData.getImages().add(new Image());
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString(), Mockito.eq(false)))
        .thenReturn(productData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.doThrow(Exception.class).when(this.productLevel3Service).create(Mockito.anyString(),
        Mockito.any(ProductDetailResponse.class), Mockito.any(ProductBusinessPartner.class),
        eq(true), Mockito.anyList());
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    this.productServiceBean
        .approveContent(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE, false,
            false);
    Mockito.verify(this.productLevel3RetryService).upsertProductLevel3FailureLog(DEFAULT_STORE_ID, DEFAULT_PRODUCT_SKU);
    Mockito.verify(this.productWorkflowService)
        .approveContent(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE),
            Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service).create(Mockito.anyString(),
        (ProductDetailResponse) Mockito.any(), Mockito.any(), eq(true),
        Mockito.anyList());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(this.productBusinessPartnerRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .saveAll(Mockito.anyList());
    Mockito.verify(this.productRepository).updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
    Mockito.verify(this.productGdnSkuGeneratorService)
        .convertToGeneratedGdnSkus(Mockito.any(ProductBusinessPartner.class));
  }

  @SuppressWarnings("unchecked")
  @Test
  public void approveContentAndIsActiveFalseTest() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    productData.setProductCode("MTA-" + UUID.randomUUID().toString());
    productData.setId(UUID.randomUUID().toString());
    productData.setStoreId(DEFAULT_STORE_ID);
    productData.setCreatedBy(DEFAULT_USERNAME);
    productData.setCreatedDate(Calendar.getInstance().getTime());
    productData.setUpdatedBy(DEFAULT_USERNAME);
    productData.setUpdatedDate(Calendar.getInstance().getTime());
    productData.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.setProductItemResponses(new HashSet<ProductItemResponse>());
    productData.setProductAttributeResponses(new ArrayList<ProductAttributeResponse>());
    productData.setImages(new ArrayList<Image>());
    ProductItemResponse productItemData = new ProductItemResponse();
    productItemData.setId(UUID.randomUUID().toString());
    productItemData.setImages(new ArrayList<Image>());
    productItemData.getImages().add(new Image());
    productItemData.setSkuCode(productData.getProductCode() + UUID.randomUUID().toString());
    AttributeResponse attributeData = new AttributeResponse();
    attributeData.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    ProductAttributeResponse productAttributeData = new ProductAttributeResponse();
    productAttributeData.setAttribute(attributeData);
    productData.getProductItemResponses().add(productItemData);
    productData.getProductAttributeResponses().add(productAttributeData);
    productData.getImages().add(new Image());
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    this.productServiceBean
        .approveContent(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE_2, false,
            false);
    Mockito.verify(this.productWorkflowService)
        .approveContent(Mockito.anyString(), Mockito.eq(ProductServiceBeanTest.DEFAULT_PRODUCT_CODE_2),
            Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service, ProductServiceBeanTest.AT_LEAST_NONE).create(
        Mockito.anyString(), (ProductDetailResponse) Mockito.any(), Mockito.any(),
        eq(false), Mockito.anyList());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    Mockito.verify(this.productRepository, ProductServiceBeanTest.AT_LEAST_NONE)
        .updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
  }

  @Test
  public void approveDraftTest() throws Exception {
    this.productServiceBean
        .approveDraft(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE);
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
    Mockito.verify(this.productWorkflowService).submit(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productRepository).updateActivated(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.verify(this.itemService).publishItemStatusEvent(DEFAULT_PRODUCT_CODE, ProductStatus.ACTIVE);
  }

  @Test
  public void testNotifyMerchantOfRecentApprovedProductsOneMerchant() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    ProductCollection productCollection1 =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE_2, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollections.add(productCollection);
    productCollections.add(productCollection1);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true))
        .thenReturn(productCollections);
    List<ProfileResponse> profileResponseList = new ArrayList<>();
    ProfileResponse businessPartner = new ProfileResponse();
    ResponsiblePersonDTO responsiblePersonDTO = new ResponsiblePersonDTO();
    responsiblePersonDTO.setEmail("email");
    businessPartner.setResponsiblePerson(responsiblePersonDTO);
    businessPartner.setBusinessPartnerCode("bp code1");
    profileResponseList.add(businessPartner);
    Mockito.when(getBusinessPartnerRepository().filterDetailsByBusinessPartnerCodeList(Mockito.any()))
        .thenReturn(profileResponseList);
    getProductServiceBean().notifyMerchantOfRecentApprovedProducts(DEFAULT_DATE_FORMAT.parse("2016-01-19"),
        DEFAULT_DATE_FORMAT.parse("2016-01-26"));
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE).filterDetailsByBusinessPartnerCodeList(Mockito.any());
    Mockito.verify(emailNotificationService).sendEmailForProductLive(eq(STORE_ID), Mockito.eq(profileResponseList),
        businessPartnerCodeProductCollectionElementsMapCaptor.capture());
  }

  @Test
  public void testNotifyMerchantOfRecentApprovedProductsOneMerchantSendMailException() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    ProductCollection productCollection1 =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE_2, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollections.add(productCollection);
    productCollections.add(productCollection1);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true))
        .thenReturn(productCollections);
    List<ProfileResponse> profileResponseList = new ArrayList<>();
    ProfileResponse businessPartner = new ProfileResponse();
    ResponsiblePersonDTO responsiblePersonDTO = new ResponsiblePersonDTO();
    responsiblePersonDTO.setEmail("email");
    businessPartner.setResponsiblePerson(responsiblePersonDTO);
    businessPartner.setBusinessPartnerCode("bp code1");
    profileResponseList.add(businessPartner);
    Mockito.when(getBusinessPartnerRepository().filterDetailsByBusinessPartnerCodeList(Mockito.any()))
        .thenReturn(profileResponseList);
    getProductServiceBean().notifyMerchantOfRecentApprovedProducts(DEFAULT_DATE_FORMAT.parse("2016-01-19"),
        DEFAULT_DATE_FORMAT.parse("2016-01-26"));
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE).filterDetailsByBusinessPartnerCodeList(Mockito.any());
    Mockito.verify(emailNotificationService).sendEmailForProductLive(eq(STORE_ID), Mockito.eq(profileResponseList),
        businessPartnerCodeProductCollectionElementsMapCaptor.capture());
  }

  @Test
  public void testNotifyMerchantOfRecentApprovedProductsOneMerchantSendMailException_2() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    ProductCollection productCollection1 =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE_2, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollections.add(productCollection);
    productCollections.add(productCollection1);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true))
        .thenReturn(productCollections);
    List<ProfileResponse> profileResponseList = new ArrayList<>();
    ProfileResponse businessPartner = new ProfileResponse();
    ResponsiblePersonDTO responsiblePersonDTO = new ResponsiblePersonDTO();
    responsiblePersonDTO.setEmail("email");
    businessPartner.setResponsiblePerson(responsiblePersonDTO);
    businessPartner.setBusinessPartnerCode("bp code1");
    profileResponseList.add(businessPartner);
    Mockito.when(getBusinessPartnerRepository().filterDetailsByBusinessPartnerCodeList(Mockito.any()))
        .thenReturn(profileResponseList);
    Mockito.doThrow(RuntimeException.class).when(kafkaProducer)
        .send(Mockito.anyString(), Mockito.anyString(), Mockito.any(MessageEmailRequest.class));
    getProductServiceBean().notifyMerchantOfRecentApprovedProducts(DEFAULT_DATE_FORMAT.parse("2016-01-19"),
        DEFAULT_DATE_FORMAT.parse("2016-01-26"));
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE).filterDetailsByBusinessPartnerCodeList(Mockito.any());
    Mockito.verify(emailNotificationService).sendEmailForProductLive(eq(STORE_ID), Mockito.eq(profileResponseList),
        businessPartnerCodeProductCollectionElementsMapCaptor.capture());
  }

  @Test
  public void testNotifyMerchantOfRecentApprovedProductsTwoMerchant() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    ProductCollection productCollection =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    ProductCollection productCollection1 =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE_2, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", BP_CODE, BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollections.add(productCollection);
    productCollections.add(productCollection1);
    ProductCollection productCollection3 =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", "bp code1", BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    ProductCollection productCollection4 =
        new ProductCollection(DEFAULT_PRODUCT_ID, DEFAULT_PRODUCT_CODE_2, DEFAULT_PRODUCT_NAME, DEFAULT_BRAND,
            "category code", "category name", "bp code1", BP_NAME, false, false, "DRAFT",
            DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"), DEFAULT_STORE_ID);
    productCollections.add(productCollection3);
    productCollections.add(productCollection4);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true))
        .thenReturn(productCollections);
    List<ProfileResponse> profileResponseList = new ArrayList<>();
    ProfileResponse businessPartner = new ProfileResponse();
    ResponsiblePersonDTO responsiblePersonDTO = new ResponsiblePersonDTO();
    responsiblePersonDTO.setEmail("email");
    businessPartner.setResponsiblePerson(responsiblePersonDTO);
    businessPartner.setBusinessPartnerCode(BP_CODE);
    profileResponseList.add(businessPartner);
    ProfileResponse businessPartner1 = new ProfileResponse();
    businessPartner1.setResponsiblePerson(new ResponsiblePersonDTO());
    businessPartner1.setBusinessPartnerCode("bp code1");
    profileResponseList.add(businessPartner1);
    Mockito.when(getBusinessPartnerRepository().filterDetailsByBusinessPartnerCodeList(Mockito.any()))
        .thenReturn(profileResponseList);
    getProductServiceBean().notifyMerchantOfRecentApprovedProducts(DEFAULT_DATE_FORMAT.parse("2016-01-19"),
        DEFAULT_DATE_FORMAT.parse("2016-01-26"));
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_ONE).filterDetailsByBusinessPartnerCodeList(Mockito.any());
    Mockito.verify(emailNotificationService).sendEmailForProductLive(eq(STORE_ID), Mockito.eq(profileResponseList),
        businessPartnerCodeProductCollectionElementsMapCaptor.capture());
  }

  @Test
  public void testNotifyMerchantOfRecentApprovedProducts_whereBPCodesGreaterthanPartitionSize_success()
      throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    for (int i = 0; i < 180; i++) {
      productCollections.add(
          new ProductCollection(DEFAULT_PRODUCT_ID + i, DEFAULT_PRODUCT_CODE + i, DEFAULT_PRODUCT_NAME + i,
              DEFAULT_BRAND + i, "category code" + i, "category name" + i, BP_CODE + i, BP_NAME + i, false, false,
              "DRAFT", DEFAULT_DATE_FORMAT.parse("2016-01-01"), "test", DEFAULT_DATE_FORMAT.parse("2016-01-01"),
              DEFAULT_STORE_ID));
    }
    List<ProfileResponse> profileResponseList = new ArrayList<>();
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setResponsiblePerson(new ResponsiblePersonDTO());
    businessPartner.setBusinessPartnerCode(BP_CODE);
    profileResponseList.add(businessPartner);
    ProfileResponse businessPartner1 = new ProfileResponse();
    businessPartner1.setResponsiblePerson(new ResponsiblePersonDTO());
    businessPartner1.setBusinessPartnerCode("bp code1");
    profileResponseList.add(businessPartner1);

    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true))
        .thenReturn(productCollections);

    Mockito.when(getBusinessPartnerRepository().filterDetailsByBusinessPartnerCodeList(Mockito.any()))
        .thenReturn(profileResponseList);
    getProductServiceBean().notifyMerchantOfRecentApprovedProducts(DEFAULT_DATE_FORMAT.parse("2016-01-19"),
        DEFAULT_DATE_FORMAT.parse("2016-01-26"));
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndUpdatedDateBetweenAndActivatedAndViewableAndMarkForDeleteFalse(
            DEFAULT_DATE_FORMAT.parse("2016-01-19"), DEFAULT_DATE_FORMAT.parse("2016-01-26"), true, true);
    Mockito.verify(getBusinessPartnerRepository(), AT_LEAST_TWO).filterDetailsByBusinessPartnerCodeList(Mockito.any());
    Mockito.verify(emailNotificationService).sendEmailForProductLive(eq(STORE_ID),
        Mockito.eq(Arrays.asList(businessPartner, businessPartner1, businessPartner, businessPartner1)),
        businessPartnerCodeProductCollectionElementsMapCaptor.capture());
  }

  @SuppressWarnings("unchecked")
  @Test
  public void updateProductContentTest() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductItemResponse productItemData = null;
    for (ProductItemResponse productItemResponse : productData.getProductItemResponses()) {
      productItemData = productItemResponse;
    }
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    ProductRequest request = new ProductRequest();
    request.setStoreId(ProductServiceBeanTest.DEFAULT_STORE_ID);
    request.setDescription("DESCRIPTION".getBytes());
    request.setProductItems(new ArrayList<>());
    request.setProductAttributes(new ArrayList<>());
    request.setProductCode(PRODUCT_CODE);
    request.setBrand(BRAND);
    request.setBrandApprovalStatus(DEFAULT_BRAND_APPROVAL_STATUS);
    request.setBrandCode(DEFAULT_BRAND_CODE);
    this.productServiceBean.updateProductContent(request);
    Mockito.verify(this.productOutbound).updateProductContent(Mockito.any(), Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    Mockito.verify(this.productHistoryRepository).save((ProductHistory) Mockito.any());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    Assertions.assertEquals(DEFAULT_BRAND_CODE, productCollectionArgumentCaptor.getValue().getBrandCode());
    Assertions.assertEquals(DEFAULT_BRAND_APPROVAL_STATUS,
        productCollectionArgumentCaptor.getValue().getBrandApprovalStatus().name());
    Assertions.assertEquals(BRAND, productCollectionArgumentCaptor.getValue().getBrand());
    Assertions.assertFalse(productCollectionArgumentCaptor.getValue().isRestrictedKeywordsPresent());
  }

  @SuppressWarnings("unchecked")
  @Test
  public void updateProductContentTestReviewPendingFalse() throws Exception {
    productCollections.get(0).setAutoApprovalType(AutoApprovalType.NOT_ELIGIBLE);
    ProductDetailResponse productData = generateProductDetailResponse();
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString()))
        .thenReturn(productCollections.get(0));
    ProductItemResponse productItemData = null;
    for (ProductItemResponse productItemResponse : productData.getProductItemResponses()) {
      productItemData = productItemResponse;
    }
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    ProductRequest request = new ProductRequest();
    request.setStoreId(ProductServiceBeanTest.DEFAULT_STORE_ID);
    request.setDescription("DESCRIPTION".getBytes());
    request.setProductItems(new ArrayList<>());
    request.setProductAttributes(new ArrayList<>());
    request.setProductCode(PRODUCT_CODE);
    request.setBrand(BRAND);
    request.setBrandApprovalStatus(DEFAULT_BRAND_APPROVAL_STATUS);
    request.setBrandCode(DEFAULT_BRAND_CODE);
    request.setReviewPending(false);
    this.productServiceBean.updateProductContent(request);
    Mockito.verify(this.productOutbound).updateProductContent(Mockito.any(), Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    Mockito.verify(this.productHistoryRepository).save((ProductHistory) Mockito.any());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    Assertions.assertEquals(DEFAULT_BRAND_CODE, productCollectionArgumentCaptor.getValue().getBrandCode());
    Assertions.assertEquals(DEFAULT_BRAND_APPROVAL_STATUS,
        productCollectionArgumentCaptor.getValue().getBrandApprovalStatus().name());
    Assertions.assertEquals(BRAND, productCollectionArgumentCaptor.getValue().getBrand());
    Assertions.assertEquals(AutoApprovalType.NA, productCollectionArgumentCaptor.getValue().getAutoApprovalType());
    Assertions.assertFalse(productCollectionArgumentCaptor.getValue().isRestrictedKeywordsPresent());
  }

  @SuppressWarnings("unchecked")
  @Test
  public void updateProductContentTestReviewPendingTrue() throws Exception {
    productCollections.get(0).setAutoApprovalType(AutoApprovalType.NOT_ELIGIBLE);
    ProductDetailResponse productData = generateProductDetailResponse();
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString()))
        .thenReturn(productCollections.get(0));
    ProductItemResponse productItemData = null;
    for (ProductItemResponse productItemResponse : productData.getProductItemResponses()) {
      productItemData = productItemResponse;
    }
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    ProductRequest request = new ProductRequest();
    request.setStoreId(ProductServiceBeanTest.DEFAULT_STORE_ID);
    request.setDescription("DESCRIPTION".getBytes());
    request.setProductItems(new ArrayList<>());
    request.setProductAttributes(new ArrayList<>());
    request.setProductCode(PRODUCT_CODE);
    request.setBrand(BRAND);
    request.setBrandApprovalStatus(DEFAULT_BRAND_APPROVAL_STATUS);
    request.setBrandCode(DEFAULT_BRAND_CODE);
    request.setReviewPending(true);
    this.productServiceBean.updateProductContent(request);
    Mockito.verify(this.productOutbound).updateProductContent(Mockito.any(), Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    Mockito.verify(this.productHistoryRepository).save((ProductHistory) Mockito.any());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    Assertions.assertEquals(DEFAULT_BRAND_CODE, productCollectionArgumentCaptor.getValue().getBrandCode());
    Assertions.assertEquals(DEFAULT_BRAND_APPROVAL_STATUS,
        productCollectionArgumentCaptor.getValue().getBrandApprovalStatus().name());
    Assertions.assertEquals(BRAND, productCollectionArgumentCaptor.getValue().getBrand());
    Assertions.assertEquals(AutoApprovalType.NOT_ELIGIBLE, productCollectionArgumentCaptor.getValue().getAutoApprovalType());
  }

  @Test
  public void updateProductContentTestNoHistoryChanges() throws Exception {
    productCollections.get(0).setAutoApprovalType(AutoApprovalType.NOT_ELIGIBLE);
    ProductDetailResponse productData = generateProductDetailResponse();
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString()))
        .thenReturn(productCollections.get(0));
    ProductItemResponse productItemData = null;
    for (ProductItemResponse productItemResponse : productData.getProductItemResponses()) {
      productItemData = productItemResponse;
    }
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    ProductRequest request = new ProductRequest();
    request.setStoreId(ProductServiceBeanTest.DEFAULT_STORE_ID);
    request.setDescription("DESCRIPTION".getBytes());
    request.setProductItems(new ArrayList<>());
    request.setProductAttributes(new ArrayList<>());
    request.setProductCode(PRODUCT_CODE);
    request.setBrandApprovalStatus(DEFAULT_BRAND_APPROVAL_STATUS);
    request.setBrandCode(DEFAULT_BRAND_CODE);
    request.setReviewPending(true);
    this.productServiceBean.updateProductContent(request);
    Mockito.verify(this.productOutbound).updateProductContent(Mockito.any(), Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    Assertions.assertEquals(DEFAULT_BRAND_CODE, productCollectionArgumentCaptor.getValue().getBrandCode());
    Assertions.assertEquals(DEFAULT_BRAND_APPROVAL_STATUS,
        productCollectionArgumentCaptor.getValue().getBrandApprovalStatus().name());
    Assertions.assertEquals(AutoApprovalType.NOT_ELIGIBLE, productCollectionArgumentCaptor.getValue().getAutoApprovalType());
  }

  @SuppressWarnings("unchecked")
  @Test
  public void updateProductContent_2_Test() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    ProductItemResponse productItemData = null;
    for (ProductItemResponse productItemResponse : productData.getProductItemResponses()) {
      productItemData = productItemResponse;
    }
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    ProductRequest request = new ProductRequest();
    request.setStoreId(ProductServiceBeanTest.DEFAULT_STORE_ID);
    request.setProductCode(PRODUCT_CODE);
    this.productServiceBean.updateProductContent(request);
    Mockito.verify(this.productOutbound).updateProductContent(Mockito.any(), Mockito.anyBoolean());
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository, ProductServiceBeanTest.AT_LEAST_TWO)
        .findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productCollectionRepository).saveAndFlush((ProductCollection) Mockito.any());
    Mockito.verify(this.productHistoryRepository).save((ProductHistory) Mockito.any());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
  }

  @Test
  public void testUpdateWCSAndInventoryForMergedProduct_WithGenerateGdnSku_SuccessCreateToXProduct() throws Exception {
    this.savedProductBusinessPartner.setGdnProductSku(null);
    Mockito.when(this.productRepository.findProductDetailByProductCode(this.savedMasterDataProduct.getProductCode()))
        .thenReturn(this.savedProduct);
    Mockito.when(this.productBusinessPartnerRepository.findById(this.savedProductBusinessPartner.getId()))
        .thenReturn(Optional.of(this.savedProductBusinessPartner));
    this.productServiceBean
        .updateWCSAndInventoryForMergedProduct(this.savedMasterDataProduct, this.savedProductBusinessPartner, this.map);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(this.savedMasterDataProduct.getProductCode());
    Mockito.verify(this.productBusinessPartnerRepository).findById(this.savedProductBusinessPartner.getId());
    Mockito.verify(this.productGdnSkuGeneratorService).generateGdnSkuOnProduct(this.savedProductBusinessPartner, false);
    Mockito.verify(this.productLevel3Service).create(
        this.savedProductBusinessPartner.getBusinessPartnerId(), this.savedProduct,
        this.savedProductBusinessPartner, false, new ArrayList<>());
    Mockito.verify(this.productBusinessPartnerRepository).save(this.savedProductBusinessPartner);
  }

  @Test
  public void updateProductImageTest() throws Exception {
    ProductDetailResponse productData = generateProductDetailResponse();
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    ProductRequest request = new ProductRequest();
    request.setProductCode(PRODUCT_CODE);
    this.productServiceBean.updateProductImage(request);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productRepository).updateProductImage(Mockito.any());
    Mockito.verify(this.productHistoryRepository).save((ProductHistory) Mockito.any());
    Assertions.assertEquals(1L, request.getVersion(), 0);
  }

  @Test
  public void testUpdateWCSAndInventoryForMergedProduct_WithGenerateGdnSku_FailedCreateToXProduct() throws Exception {
    this.savedProductBusinessPartner.setGdnProductSku(null);
    Mockito.when(this.productRepository.findProductDetailByProductCode(this.savedMasterDataProduct.getProductCode()))
        .thenReturn(this.savedProduct);
    Mockito.when(this.productBusinessPartnerRepository.findById(this.savedProductBusinessPartner.getId()))
        .thenReturn(Optional.of(this.savedProductBusinessPartner));
    Mockito.doThrow(new ApplicationRuntimeException(ErrorCategory.UNSPECIFIED, "test doang kali"))
        .when(this.productLevel3Service)
        .create(this.savedProductBusinessPartner.getBusinessPartnerId(), this.savedProduct,
            this.savedProductBusinessPartner, false, new ArrayList<>());
    this.productServiceBean
        .updateWCSAndInventoryForMergedProduct(this.savedMasterDataProduct, this.savedProductBusinessPartner, this.map);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(this.savedMasterDataProduct.getProductCode());
    Mockito.verify(this.productBusinessPartnerRepository).findById(this.savedProductBusinessPartner.getId());
    Mockito.verify(this.productGdnSkuGeneratorService).generateGdnSkuOnProduct(this.savedProductBusinessPartner, false);
    Mockito.verify(this.productLevel3Service)
        .create(this.savedProductBusinessPartner.getBusinessPartnerId(), this.savedProduct,
            this.savedProductBusinessPartner, false, new ArrayList<>());
    Mockito.verify(this.productBusinessPartnerRepository).save(this.savedProductBusinessPartner);
  }

  @Test
  public void testUpdateWCSAndInventoryForMergedProduct_WithoutGenerateGdnSku() throws Exception {
    this.savedProductBusinessPartner.setGdnProductSku(DEFAULT_GDN_SKU);
    Mockito.when(this.productRepository.findProductDetailByProductCode(this.savedMasterDataProduct.getProductCode()))
        .thenReturn(this.savedProduct);
    Mockito.when(this.productBusinessPartnerRepository.findById(this.savedProductBusinessPartner.getId()))
        .thenReturn(Optional.of(this.savedProductBusinessPartner));
    this.productServiceBean
        .updateWCSAndInventoryForMergedProduct(this.savedMasterDataProduct, this.savedProductBusinessPartner, this.map);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(this.savedMasterDataProduct.getProductCode());
    Mockito.verify(this.productBusinessPartnerRepository).findById(this.savedProductBusinessPartner.getId());
    Mockito.verify(this.productLevel3Service)
        .create(this.savedProductBusinessPartner.getBusinessPartnerId(), this.savedProduct,
            this.savedProductBusinessPartner, false, new ArrayList<>());
    Mockito.verify(this.productBusinessPartnerRepository).save(this.savedProductBusinessPartner);
  }

  @Test
  public void validateCategory() throws Exception {
    ProfileResponse profileResp = new ProfileResponse();
    List<String> catList = new ArrayList<>();
    catList.add(this.DEFAULT_CATEGORY_CODE);
    profileResp.setCategories(catList);

    GdnRestSingleResponse<SingleObjectResponse> categoryParent =
        new GdnRestSingleResponse<SingleObjectResponse>(null, null, true,
            new SingleObjectResponse<>(this.DEFAULT_CATEGORY_CODE), this.REQUEST_ID);

    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString()))
        .thenReturn(profileResp);
    Mockito.when(this.categoryRepository
        .getFinalParentCategoryCached(Mockito.anyString(), Mockito.anyString(), Mockito.anyString()))
        .thenReturn(categoryParent);

    this.productServiceBean
        .validateCategory(this.REQUEST_ID, DEFAULT_USERNAME, DEFAULT_BUSINESS_PARTNER_CODE, this.DEFAULT_CATEGORY_ID);

    Mockito.verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.anyString());
    Mockito.verify(this.categoryRepository)
        .getFinalParentCategoryCached(Mockito.anyString(), Mockito.anyString(), Mockito.anyString());
  }

  @Test
  public void validateCategoryWhenBpRepoError() throws Exception {
    ProfileResponse profileResp = new ProfileResponse();
    List<String> catList = new ArrayList<>();
    profileResp.setCategories(catList);

    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString()))
        .thenReturn(profileResp);
    Mockito.when(this.categoryRepository
        .getFinalParentCategoryCached(Mockito.anyString(), Mockito.anyString(), Mockito.anyString())).thenReturn(null);

    try {
      assertThrows(Exception.class, () -> {
        this.productServiceBean
            .validateCategory(this.REQUEST_ID, DEFAULT_USERNAME, DEFAULT_BUSINESS_PARTNER_CODE, this.DEFAULT_CATEGORY_ID);
      });
    } catch (Exception e) {
      Mockito.verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.anyString());
      Mockito.verify(this.categoryRepository, Mockito.never())
          .getFinalParentCategoryCached(Mockito.anyString(), Mockito.anyString(), Mockito.anyString());

      throw e;
    }
  }

  @Test
  public void validateCategoryWhenInvalidCategory() throws Exception {
    ProfileResponse profileResp = new ProfileResponse();
    List<String> catList = new ArrayList<>();
    catList.add(this.DEFAULT_CATEGORY_CODE);
    profileResp.setCategories(catList);

    GdnRestSingleResponse<SingleObjectResponse> categoryParent =
        new GdnRestSingleResponse<SingleObjectResponse>(null, null, true,
            new SingleObjectResponse<>("Invalid category"), this.REQUEST_ID);

    Mockito.when(this.businessPartnerRepository.filterDetailByBusinessPartnerCode(Mockito.anyString()))
        .thenReturn(profileResp);
    Mockito.when(this.categoryRepository
        .getFinalParentCategoryCached(Mockito.anyString(), Mockito.anyString(), Mockito.anyString()))
        .thenReturn(categoryParent);

    try {
      assertThrows(Exception.class, () -> {
        this.productServiceBean
            .validateCategory(this.REQUEST_ID, DEFAULT_USERNAME, DEFAULT_BUSINESS_PARTNER_CODE, this.DEFAULT_CATEGORY_ID);
      });
    } catch (Exception e) {
      throw e;
    }
    Mockito.verify(this.businessPartnerRepository).filterDetailByBusinessPartnerCode(Mockito.anyString());
    Mockito.verify(this.categoryRepository)
        .getFinalParentCategoryCached(Mockito.anyString(), Mockito.anyString(), Mockito.anyString());
  }

  @Test
  public void getProductDetailsByProductCodesTest() throws Exception {
    this.productServiceBean.getProductDetailsByProductCodes("reqId", DEFAULT_USERNAME, new ArrayList<String>());
    Mockito.verify(this.productRepository)
        .getProductDetailsByProductCodes(Mockito.anyString(), Mockito.anyString(), Mockito.anyList());
  }

  @Test
  public void findByStoreIdAndProductItemNameAndCategoryIdTest() throws Exception {
    ProductItem productItem = getProductItem();
    List<ProductItem> productItemList = new ArrayList<ProductItem>();
    productItemList.add(productItem);
    Page<ProductItem> productItems =
        new PageImpl<ProductItem>(productItemList, DEFAULT_PAGEABLE, productItemList.size());
    Mockito.when(this.productItemRepository
        .findByStoreIdAndProductItemNameAndCategoryId(Mockito.anyString(), Mockito.anyString(), Mockito.anyString(),
            Mockito.any())).thenReturn(productItems);
    this.productServiceBean
        .findByProductItemNameAndCategoryId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_NAME, this.DEFAULT_CATEGORY_ID,
            DEFAULT_PAGEABLE);
    Mockito.verify(this.productItemRepository)
        .findByStoreIdAndProductItemNameAndCategoryId(Mockito.anyString(), Mockito.anyString(), Mockito.anyString(),
            Mockito.any());
  }

  @Test
  public void activateAndUpdateImageNameTest() throws Exception {
    ActivateImageRequest request = new ActivateImageRequest(DEFAULT_PRODUCT_CODE, DEFAULT_HASH_CODE, DEFAULT_FILENAME);
    Mockito.doNothing().when(this.productRepository).activateAndUpdateImageName(Mockito.any());
    this.productServiceBean.activateAndUpdateImageName(request);
    Mockito.verify(this.productRepository).activateAndUpdateImageName(Mockito.any());
  }

  @Test
  public void isProductImagesActivatedTest() throws Exception {
    Mockito.when(this.productRepository.isProductImagesActivated(Mockito.anyString()))
        .thenReturn(new ActivateImageResponse());
    this.productServiceBean.isProductImagesActivated(DEFAULT_SKU_CODE);
    Mockito.verify(this.productRepository).isProductImagesActivated(Mockito.anyString());
  }

  @Test
  public void testGetters() {
    assertNotNull(this.productWorkflowService);
  }

  @Test
  public void createProductLevel3TestOk() throws Exception {
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    ProductItemResponse itemResponse = new ProductItemResponse();
    itemResponse.setGeneratedItemName(PRODUCT_NAME);
    itemResponse.setId(PRODUCT_ID);
    Set<ProductItemResponse> itemResponses = new HashSet<>();
    itemResponses.add(itemResponse);
    productDetailResponse.setProductItemResponses(itemResponses);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_NAME)).thenReturn(productDetailResponse);
    this.productServiceBean.createProductLevel3(PRODUCT_NAME, false);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_NAME);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(any(), any());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.any());
  }

  @Test
  public void createProductLevel3TestOkSkipNotificationTrue() throws Exception {
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    ProductItemResponse itemResponse = new ProductItemResponse();
    itemResponse.setGeneratedItemName(PRODUCT_NAME);
    itemResponse.setId(PRODUCT_ID);
    Set<ProductItemResponse> itemResponses = new HashSet<>();
    itemResponses.add(itemResponse);
    productDetailResponse.setProductItemResponses(itemResponses);
    Mockito.when(
        this.productBusinessPartnerRepository.findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.any(),
            Mockito.any())).thenReturn(productBusinessPartners);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_NAME)).thenReturn(productDetailResponse);
    this.productServiceBean.createProductLevel3(PRODUCT_NAME, true);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_NAME);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(any(), any());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    Mockito.verify(this.productLevel3Service)
        .create(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.anyBoolean(), Mockito.anyList());
    Mockito.verify(productImageQcProcessingResponseService)
        .findByStoreIdAndProductCode(Mockito.any(), Mockito.any());
  }

  Page<SolrProductCollectionDTO> generateSolrProductCollection() {
    List<SolrProductCollectionDTO> list = new ArrayList<>();
    SolrProductCollectionDTO solrProductCollectionDTO = new SolrProductCollectionDTO();
    solrProductCollectionDTO.setCategoryCode("12345");
    list.add(solrProductCollectionDTO);
    return new PageImpl<SolrProductCollectionDTO>(list);
  }

  private List<CategoryHierarchyResponse> generateCategoryHierarchy() throws Exception {
    List<CategoryHierarchyResponse> categoryHierarchyResponses = new ArrayList<>();
    CategoryHierarchyResponse categoryHierarchyResponse = new CategoryHierarchyResponse();
    categoryHierarchyResponse.setCategoryCode("category1");
    categoryHierarchyResponses.add(categoryHierarchyResponse);
    return categoryHierarchyResponses;
  }

  private ProductResponse generateProductResponse() {
    ProductResponse savedProduct = new ProductResponse();
    savedProduct.setProductCode(PRODUCT_CODE);
    savedProduct.setId(UUID.randomUUID().toString());
    savedProduct.setStoreId(DEFAULT_STORE_ID);
    savedProduct.setCreatedBy(DEFAULT_USERNAME);
    savedProduct.setCreatedDate(Calendar.getInstance().getTime());
    savedProduct.setUpdatedBy(DEFAULT_USERNAME);
    savedProduct.setUpdatedDate(Calendar.getInstance().getTime());
    return savedProduct;
  }

  @Test
  public void getCategoryHierarchyByProductNameOrProductCodeTest() throws Exception {
    Set<SolrCategoryCodeDTO> categoryCodes = new LinkedHashSet<>();
    categoryCodes.add(new SolrCategoryCodeDTO("category1", 2));
    categoryCodes.add(new SolrCategoryCodeDTO("category2", 5));
    Mockito.when(this.solrActiveProductCollectionRepository
        .getCategoryCodesSolrByKeyword(Mockito.anyString(), Mockito.any(), Mockito.eq(null))).thenReturn(categoryCodes);
    Mockito.when(this.categoryRepository.findHierarchyByCategoryCodes(Mockito.any()))
        .thenReturn(generateCategoryHierarchy());
    this.productServiceBean.getCategoryHierarchyByProductNameOrProductCode(DEFAULT_STORE_ID, "test",
        PageRequest.of(0, 1), null);
    Mockito.verify(this.solrActiveProductCollectionRepository)
        .getCategoryCodesSolrByKeyword(Mockito.anyString(), Mockito.any(), Mockito.eq(null));
    Mockito.verify(this.categoryRepository).findHierarchyByCategoryCodes(Mockito.any());
  }

  @Test
  public void getCategoryHierarchyByProductNameOrProductCodeTest_EmptyImput() throws Exception {
    this.productServiceBean
        .getCategoryHierarchyByProductNameOrProductCode(DEFAULT_STORE_ID, null, PageRequest.of(0,
          1), null);

    Mockito.verify(this.solrActiveProductCollectionRepository, Mockito.never())
        .getCategoryCodesSolrByKeyword(Mockito.anyString(), Mockito.anyInt(), Mockito.anyString());
  }

  private List<ProductItemDetailResponse> generateProductItemDetailResponse() throws Exception {
    List<ProductItemDetailResponse> productList = new ArrayList<>();
    ProductItemDetailResponse productItem = new ProductItemDetailResponse();
    productItem.setProductResponse(new ProductResponse());
    productItem.getProductResponse().setProductCode("product-1");
    productItem.setSkuCode("product-1-1");
    productList.add(productItem);
    return productList;
  }

  private List<ProductItemDetailResponse> generateProductItemDetail2Response() throws Exception {
    List<ProductItemDetailResponse> productList = new ArrayList<>();
    ProductItemDetailResponse productItem = new ProductItemDetailResponse();
    productItem.setProductResponse(new ProductResponse());
    productItem.getProductResponse().setProductCode("product-1");
    productItem.setSkuCode("product-1-1");
    ProductItemDetailResponse productItem2 = new ProductItemDetailResponse();
    productItem2.setProductResponse(new ProductResponse());
    productItem2.getProductResponse().setProductCode("product-2");
    productItem2.setSkuCode("product-2-1");
    productList.add(productItem2);
    return productList;
  }

  @Test
  public void getProductItemByProductNameAndCategoryCodeTest() throws Exception {
    SolrProductCodeDTO solrProductCodeDTO = new SolrProductCodeDTO();
    solrProductCodeDTO.setProductCodes(new LinkedHashSet<>());
    solrProductCodeDTO.getProductCodes().add("product-1");
    solrProductCodeDTO.setTotalCount(10L);
    Mockito.when(this.solrActiveProductCollectionRepository
        .getProductCodesFromSolrByKeywordAndCategoryCode(Mockito.anyString(), Mockito.anyString(), Mockito.any()))
        .thenReturn(solrProductCodeDTO);
    Mockito.when(this.productRepository.getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean()))
        .thenReturn(generateProductItemDetailResponse());
    this.productServiceBean
        .getProductItemByKeywordAndCategoryCode("product", "15820", PageRequest.of(0, 1), true);
    Mockito.verify(this.solrActiveProductCollectionRepository)
        .getProductCodesFromSolrByKeywordAndCategoryCode(Mockito.anyString(), Mockito.anyString(), Mockito.any());
    Mockito.verify(this.productRepository).getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(),
        Mockito.anyBoolean());
  }

  @Test
  public void getProductItemByProductNameAndCategoryCodeTest_EmptyInput() throws Exception {
    assertThrows(Exception.class, () -> {
      this.productServiceBean
          .getProductItemByKeywordAndCategoryCode(null, null, PageRequest.of(0, 1), true);
    });
  }

  @Test
  public void getProductItemByProductNameAndCategoryCodeTest_EmptyInput_2() throws Exception {
    assertThrows(Exception.class, () -> {
      this.productServiceBean
          .getProductItemByKeywordAndCategoryCode("product", null, PageRequest.of(0, 1), true);
    });
  }

  @Test
  public void getProductItemByProductNameAndCategoryCodeTest_EmptyInput_3() throws Exception {
    assertThrows(Exception.class, () -> {
      this.productServiceBean
          .getProductItemByKeywordAndCategoryCode(null, "15820", PageRequest.of(0, 1), true);
    });
  }

  @Test
  public void getProductItemDetailByKeywordAndCategoryCodeTest() throws Exception {
    SolrProductCodeDTO solrProductCodeDTO = new SolrProductCodeDTO();
    solrProductCodeDTO.setProductCodes(new LinkedHashSet<>());
    solrProductCodeDTO.getProductCodes().add("product-1");
    solrProductCodeDTO.setTotalCount(10L);

    List<String> categoryCodes = new ArrayList<String>();
    categoryCodes.add(this.DEFAULT_CATEGORY_CODE);

    Mockito.when(this.solrActiveProductCollectionRepository
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any()))
        .thenReturn(solrProductCodeDTO);
    Mockito.when(this.productRepository.getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean()))
        .thenReturn(generateProductItemDetailResponse());

    this.productServiceBean
        .getProductItemDetailByKeywordAndCategoryCodes("product", categoryCodes, PageRequest.of(0, 1),
            true);

    Mockito.verify(this.solrActiveProductCollectionRepository)
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any());
    Mockito.verify(this.productRepository).getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(),
        Mockito.anyBoolean());
  }

  @Test
  public void getProductItemDetailByKeywordAndCategoryCodeNullProductDetail() throws Exception {
    SolrProductCodeDTO solrProductCodeDTO = new SolrProductCodeDTO();
    solrProductCodeDTO.setProductCodes(new LinkedHashSet<>());
    solrProductCodeDTO.getProductCodes().add("product-1");
    solrProductCodeDTO.setTotalCount(10L);

    List<String> categoryCodes = new ArrayList<String>();
    categoryCodes.add(this.DEFAULT_CATEGORY_CODE);

    Mockito.when(this.solrActiveProductCollectionRepository
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any()))
        .thenReturn(solrProductCodeDTO);
    Mockito.when(this.productRepository.getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean()))
        .thenReturn(null);

    this.productServiceBean
        .getProductItemDetailByKeywordAndCategoryCodes("product", categoryCodes, PageRequest.of(0, 1),
            true);

    Mockito.verify(this.solrActiveProductCollectionRepository)
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any());
    Mockito.verify(this.productRepository).getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(),
        Mockito.anyBoolean());
  }

  @Test
  public void getProductItemDetailByKeywordAndCategoryCodeEmptySolrResp() throws Exception {
    SolrProductCodeDTO solrProductCodeDTO = new SolrProductCodeDTO();
    solrProductCodeDTO.setProductCodes(new LinkedHashSet<>());
    solrProductCodeDTO.setTotalCount(10L);

    List<String> categoryCodes = new ArrayList<String>();
    categoryCodes.add(this.DEFAULT_CATEGORY_CODE);

    Mockito.when(this.solrActiveProductCollectionRepository
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any()))
        .thenReturn(solrProductCodeDTO);

    this.productServiceBean
        .getProductItemDetailByKeywordAndCategoryCodes("product", categoryCodes, PageRequest.of(0, 1),
            true);

    Mockito.verify(this.solrActiveProductCollectionRepository)
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any());
  }

  @Test
  public void getProductItemDetailByKeywordAndCategoryCodesWithNullSolrTotalCountTest() throws Exception {
    SolrProductCodeDTO solrProductCodeDTO = new SolrProductCodeDTO();
    solrProductCodeDTO.setProductCodes(new LinkedHashSet<>());
    solrProductCodeDTO.getProductCodes().add("product-1");
    solrProductCodeDTO.setTotalCount(null);

    List<String> categoryCodes = new ArrayList<String>();
    categoryCodes.add(this.DEFAULT_CATEGORY_CODE);

    Mockito.when(this.solrActiveProductCollectionRepository
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any()))
        .thenReturn(solrProductCodeDTO);
    Mockito.when(this.productRepository.getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean()))
        .thenReturn(generateProductItemDetailResponse());

    this.productServiceBean
        .getProductItemDetailByKeywordAndCategoryCodes("product", categoryCodes, PageRequest.of(0, 1),
            true);

    Mockito.verify(this.solrActiveProductCollectionRepository)
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any());
    Mockito.verify(this.productRepository).getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(),
        Mockito.anyBoolean());
  }

  @Test
  public void getProductItemDetailByKeywordAndCategoryCodesSolrTotalCountLowerThanProductItemDetailListTest()
      throws Exception {
    SolrProductCodeDTO solrProductCodeDTO = new SolrProductCodeDTO();
    solrProductCodeDTO.setProductCodes(new LinkedHashSet<>());
    solrProductCodeDTO.getProductCodes().add("product-1");
    solrProductCodeDTO.setTotalCount(1L);

    List<String> categoryCodes = new ArrayList<String>();
    categoryCodes.add(this.DEFAULT_CATEGORY_CODE);

    Mockito.when(this.solrActiveProductCollectionRepository
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any()))
        .thenReturn(solrProductCodeDTO);
    Mockito.when(this.productRepository.getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(), Mockito.anyBoolean()))
        .thenReturn(generateProductItemDetail2Response());

    this.productServiceBean
        .getProductItemDetailByKeywordAndCategoryCodes("product", categoryCodes, PageRequest.of(0, 1),
            true);

    Mockito.verify(this.solrActiveProductCollectionRepository)
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any());
    Mockito.verify(this.productRepository).getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(),
        Mockito.anyBoolean());
  }

  @Test
  public void getProductItemDetailByKeywordAndCategoryCodeEmptyKeyword() throws Exception {
    assertThrows(Exception.class, () -> {
      this.productServiceBean
          .getProductItemDetailByKeywordAndCategoryCodes(null, new ArrayList<>(), PageRequest.of(0, 1),
              true);
    });
  }

  @Test
  public void getProductItemDetailByKeywordAndEmptyKeyword() throws Exception {
    SolrProductCodeDTO solrProductCodeDTO = new SolrProductCodeDTO();
    solrProductCodeDTO.setProductCodes(new LinkedHashSet<>());
    solrProductCodeDTO.getProductCodes().add("product-1");
    solrProductCodeDTO.setTotalCount(1L);
    Mockito.when(this.solrActiveProductCollectionRepository
            .findProductCodesByKeywordAndCategoryCodes(Mockito.any(), Mockito.any(), Mockito.any()))
        .thenReturn(solrProductCodeDTO);
    Mockito.when(this.productRepository.getProductItemByListOfProductCode(Mockito.any(), Mockito.anyBoolean(), Mockito.anyBoolean()))
        .thenReturn(generateProductItemDetail2Response());
    this.productServiceBean
        .getProductItemDetailByKeywordAndCategoryCodes("product", null, PageRequest.of(0, 1), true);
    Mockito.verify(this.solrActiveProductCollectionRepository)
        .findProductCodesByKeywordAndCategoryCodes(Mockito.any(), Mockito.any(), Mockito.any());
    Mockito.verify(this.productRepository).getProductItemByListOfProductCode(Mockito.any(), Mockito.anyBoolean(), Mockito.anyBoolean());
  }

  @Test
  public void testUpdateRejectedProduct_whenSuccess() throws Exception {
    this.productServiceBean.updateRejectedProduct(new ProductRequest());
    Mockito.verify(this.productRepository).updateRejectedProduct(Mockito.any(ProductRequest.class));
  }

  @Test
  public void testUpdateRejectedProduct_whenFail() throws Exception {
    Mockito.doThrow(new Exception()).when(this.productRepository)
        .updateRejectedProduct(Mockito.any(ProductRequest.class));
    try {
      this.productServiceBean.updateRejectedProduct(new ProductRequest());
    } catch (Exception e) {
      Mockito.verify(this.productRepository).updateRejectedProduct(Mockito.any(ProductRequest.class));
    }
  }

  @Test
  public void clearMasterProductCacheTest() throws Exception {
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString()))
        .thenReturn(generateProductDetailResponse());
    Mockito.doNothing().when(this.productRepository).clearMasterProductCache(Mockito.anyString(), Mockito.anyString());

    this.productServiceBean.clearMasterProductCache(DEFAULT_PRODUCT_CODE);

    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productRepository).clearMasterProductCache(Mockito.anyString(), Mockito.anyString());
  }

  @Test
  public void clearMasterProductCacheSyncTest() throws Exception {
    Mockito.doNothing().when(this.productRepository).clearMasterProductCacheSync(PRODUCT_ID, PRODUCT_CODE);
    this.productServiceBean.clearMasterProductCacheSync(PRODUCT_ID, PRODUCT_CODE);
    Mockito.verify(this.productRepository).clearMasterProductCacheSync(PRODUCT_ID, PRODUCT_CODE);
  }

  @Test
  public void clearMasterProductCacheExceptionTest() throws Exception {
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(null);
    try {
      assertThrows(Exception.class, () -> {
        this.productServiceBean.clearMasterProductCache(DEFAULT_PRODUCT_CODE);
      });
    } catch (Exception e) {
      throw e;
    }
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
  }

  @Test
  public void publishImageQcProcessedResponseEventAutoNeedRevisionTestForNull() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class)))
        .thenReturn(imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode()))
        .thenReturn(Collections.singletonList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class)))
        .thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(null);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            new AutoNeedRevisionAndForceReviewResponse(true, false, false, null), profileResponse,
            imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertNotNull(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getImageQcProcessedResponseDomainEvent()
        .getAutoNeedRevisionAndForceReviewResponse());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void getStuckProductCodeAndStateEditedEventToNoStatusUpdatePDTTestForNull() throws Exception {
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(null);
    productCollection.setEdited(true);
    pdtProductDomainEventModel.setReviewType(ReviewType.IMAGE);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(
        productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID,
            DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean)
        .getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
     Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getEditedPublishProductCollection());
  }

  @Test
  public void findProductItemByKeywordAndCategoryCodesTest() throws Exception {
    SolrProductCodeDTO solrProductCodeDTO = new SolrProductCodeDTO();
    solrProductCodeDTO.setTotalCount(1L);
    Mockito.when(this.solrActiveProductCollectionRepository
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any()))
        .thenReturn(solrProductCodeDTO);
    Mockito.when(this.productRepository.getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(),
        Mockito.anyBoolean())).thenReturn(generateProductItemDetailResponse());
    this.productServiceBean.findProductItemByKeywordAndCategoryCodes(ProductServiceBeanTest.KEYWORD, new ArrayList<>(),
        PageRequest.of(0, 1), true);
    Mockito.verify(this.solrActiveProductCollectionRepository)
        .findProductCodesByKeywordAndCategoryCodes(Mockito.anyString(), Mockito.anyList(), Mockito.any());
    Mockito.verify(this.productRepository).getProductItemByListOfProductCode(Mockito.anyList(), Mockito.anyBoolean(),
        Mockito.anyBoolean());
  }

  @Test
  public void getActiveProductCodesTest() throws Exception {
    List<String> productCodes = new ArrayList<>();
    productCodes.add(PRODUCT_CODE);
    Pageable pageable = PageRequest.of(0, 10);
    Mockito.when(this.solrActiveProductCollectionRepository
        .getProductCodesListFromSolr(DEFAULT_STORE_ID, "apple", DEFAULT_CATEGORY_CODE, true, DEFAULT_SORT_TYPE,
            pageable)).thenReturn(productCodes);
    List<String> productCodesActual = this.productServiceBean
        .getActiveProductCodesFromSolr(DEFAULT_STORE_ID, "apple", DEFAULT_CATEGORY_CODE, true, DEFAULT_SORT_TYPE,
            pageable);
    Mockito.verify(this.solrActiveProductCollectionRepository)
        .getProductCodesListFromSolr(DEFAULT_STORE_ID, "apple", DEFAULT_CATEGORY_CODE, true, DEFAULT_SORT_TYPE,
            pageable);
    Assertions.assertTrue(productCodesActual.size() == 1);
    Assertions.assertTrue(productCodesActual.get(0) == PRODUCT_CODE);
  }

  @Test
  public void countProductCollectionBySpecifiedDateRangeFromSolrTest() throws Exception {
    ProductCollectionCountRequest request = getProductCollectionCountRequest();
    request.setActivated(true);
    ProductCollectionCountResponse result =
        new ProductCollectionCountResponse(COUNT_VALUE, COUNT_VALUE, COUNT_VALUE, COUNT_VALUE, COUNT_VALUE);
    Mockito.when(solrReviewProductCollectionService
        .getInReviewProducts(DEFAULT_STORE_ID, StringUtils.EMPTY, DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_CATEGORY_CODE))
        .thenReturn(result);

    ProductCollectionCountResponse response =
        this.productServiceBean.countProductCollectionBySpecifiedDateRange(request);
    Mockito.verify(this.solrReviewProductCollectionService)
        .getInReviewProducts(DEFAULT_STORE_ID, StringUtils.EMPTY, DEFAULT_BUSINESS_PARTNER_CODE, DEFAULT_CATEGORY_CODE);

    Assertions.assertEquals(COUNT_VALUE, response.getToday());
    Assertions.assertEquals(COUNT_VALUE, response.getYesterday());
    Assertions.assertEquals(COUNT_VALUE, response.getThreeUntilFiveDaysAgo());
    Assertions.assertEquals(COUNT_VALUE, response.getTwoDaysAgo());
    Assertions.assertEquals(COUNT_VALUE, response.getMoreThan5Days());
  }

  private ProductCollectionCountRequest getProductCollectionCountRequest() {
    ProductCollectionCountRequest request = new ProductCollectionCountRequest();
    request.setStoreId(DEFAULT_STORE_ID);
    request.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    request.setCategoryCode(this.DEFAULT_CATEGORY_CODE);
    request.setActivated(false);
    request.setViewable(false);
    request.setKeyword(StringUtils.EMPTY);
    return request;
  }

  @Test
  public void saveProductHistory_valid_success() throws Exception {
    ProductHistory request = new ProductHistory();
    request.setStoreId(DEFAULT_STORE_ID);
    this.productServiceBean.saveProductHistory(DEFAULT_PRODUCT_CODE, request);
    Mockito.verify(this.productHistoryRepository, Mockito.times(1)).saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
  }

  @Test
  public void saveProductHistoryTest() throws Exception {
    this.productServiceBean
        .saveProductHistory(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, DEFAULT_USERNAME, ACTIVITY, DEFAULT_NOTE);
    Mockito.verify(this.productHistoryRepository).saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito.verify(getProductCollectionRepository())
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID),
            Mockito.eq(DEFAULT_PRODUCT_CODE));
  }

  @Test
  public void saveProductHistoryExceptionTest() throws Exception {
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID),
            Mockito.eq(DEFAULT_PRODUCT_CODE))).thenThrow(new RuntimeException());
    this.productServiceBean
        .saveProductHistory(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, DEFAULT_USERNAME, ACTIVITY, DEFAULT_NOTE);
    Mockito.verify(getProductCollectionRepository())
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID),
            Mockito.eq(DEFAULT_PRODUCT_CODE));
  }

  @Test
  public void publishProductDetailsEventTest() throws Exception {
    ProductResponse productResponse = generateProductResponse();
    String productCode = productResponse.getProductCode();
    Mockito.when(this.productRepository.findProductBasicDetailByProductCode(productCode)).thenReturn(productResponse);
    ApproveProductResponse approveProductResponse =
        this.productServiceBean.publishProductDetailsEvent(productCode, MESSAGE);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.PRODUCT_APPROVE_IMAGE_RESPONSE), Mockito.any(), Mockito.any());
    Mockito.verify(this.productRepository).findProductBasicDetailByProductCode(productCode);
    Assertions.assertSame(productResponse, approveProductResponse.getProductResponse());

  }

  @Test
  public void publishProductDetailsEventWithEmptyMessageTest() throws Exception {
    String productCode = null;
    ApproveProductResponse approveProductResponse = this.productServiceBean
        .publishProductDetailsEvent(productCode, ApproveImageMessageConstants.EMPTY_MESSAGE_RECEIVED);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.PRODUCT_APPROVE_IMAGE_RESPONSE), Mockito.any(), Mockito.any());
    Assertions.assertEquals(productCode, approveProductResponse.getProductResponse().getProductCode());
  }

  @Test
  public void publishProductWipDeleteEventTest() throws Exception {
    ProductWipDeleteResponse productWipDeleteResponse =
        this.productServiceBean.publishProductWipDeleteEvent(DEFAULT_PRODUCT_CODE, DEFAULT_USERNAME, DEFAULT_NOTE);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.PRODUCT_DELETE_EVENT_REQUEST), Mockito.any(), Mockito.any());
    assertNotNull(productWipDeleteResponse);
    Assertions.assertEquals(productWipDeleteResponse.getProductCode(), DEFAULT_PRODUCT_CODE);
    Assertions.assertEquals(productWipDeleteResponse.getUpdatedBy(), DEFAULT_USERNAME);
    Assertions.assertEquals(productWipDeleteResponse.getNotes(), DEFAULT_NOTE);
  }

  @Test
  public void findDetailByIdTest() throws Exception {
    ProductDetailResponse response = new ProductDetailResponse();
    Mockito.when(getProductRepository().findDetailById("id")).thenReturn(response);
    ProductDetailResponse result = getProductServiceBean().findDetailById("id");
    Mockito.verify(getProductRepository()).findDetailById("id");
    Assertions.assertEquals(response, result);
  }

  @Test
  public void findDetailByIdTest_whenException() throws Exception {
    Mockito.when(getProductRepository().findDetailById("id")).thenThrow(new ApplicationException());
    try {
      assertThrows(Exception.class, () -> {
        ProductDetailResponse result = getProductServiceBean().findDetailById("id");
      });
    } catch (Exception e) {
      throw new ApplicationException();
    }
    Mockito.verify(getProductRepository()).findDetailById("id");
  }

  private ProductDetailResponse getProductDetailResponse() {
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    productDetailResponse.setStoreId(DEFAULT_STORE_ID);
    productDetailResponse.setProductCode(PRODUCT_CODE);
    productDetailResponse.setName("Produk 1");
    productDetailResponse.setImages(Arrays.asList(new Image()));
    productDetailResponse.setId(PRODUCT_ID);
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setImages(Arrays.asList(new Image()));
    Set<ProductItemResponse> productItemResponses = new HashSet<>();
    productItemResponses.add(productItemResponse);
    productDetailResponse.setProductItemResponses(productItemResponses);
    ProductAttributeResponse productAttributeResponse = new ProductAttributeResponse();
    productAttributeResponse.setAttribute(new AttributeResponse());
    productDetailResponse.setProductAttributeResponses(Arrays.asList(productAttributeResponse));
    ProductCategoryResponse productCategoryResponse = new ProductCategoryResponse();
    productCategoryResponse.setCategory(new CategoryResponse());
    productDetailResponse.setProductCategoryResponses(Arrays.asList(productCategoryResponse));
    return productDetailResponse;
  }

  private ProductWorkflowStatus generateProductWorkflowStatus() throws Exception {
    ProductWorkflowStatus productWorkflowStatus = new ProductWorkflowStatus();
    productWorkflowStatus.getStates().add("PROCESS_IMAGE");
    return productWorkflowStatus;
  }

  @Test
  public void getProductCollectionsWithUpdatedFlagsTest() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    productCollections.add(
        new ProductCollection(UUID.randomUUID().toString(), "MTA-0000001", "Produk 1", "Testing", "CAT-0000001",
            "Kategori 1", "BLT-00001", "Blibli Testing", true, true, "DRAFT", ProductServiceBeanTest.DEFAULT_USERNAME,
            Calendar.getInstance().getTime(), ProductServiceBeanTest.DEFAULT_STORE_ID));
    Page<ProductCollection> productCollectionPage = new PageImpl<ProductCollection>(productCollections);
    ProductWorkflowStatus productWorkflowStatus = generateProductWorkflowStatus();
    productWorkflowStatus.getStates().clear();
    productWorkflowStatus.getStates().add("CONTENT_APPROVED");
    productWorkflowStatus.getStates().add("IMAGE_APPROVED");
    productWorkflowStatus.setProductCode("MTA-0000001");

    doReturn(Arrays.asList(productWorkflowStatus)).when(productWfService)
        .getProductWorkFlowByProductCodes(Arrays.asList("MTA-0000001"));
    List<ProductCollectionResponse> productCollectionResponseList =
        productServiceBean.getProductCollectionsWithUpdatedFlags(DEFAULT_STORE_ID, productCollectionPage);
    Mockito.verify(this.productWfService).getProductWorkFlowByProductCodes(Mockito.eq(Arrays.asList("MTA-0000001")));
    Assertions.assertEquals(productCollections.get(0).getState(), productCollectionResponseList.get(0).getState());
  }


  @Test
  public void getProductCollectionsWithUpdatedFlagsTest_whenProductInactive() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    productCollections.add(
        new ProductCollection(UUID.randomUUID().toString(), "MTA-0000001", "Produk 1", "Testing", "CAT-0000001",
            "Kategori 1", "BLT-00001", "Blibli Testing", true, true, "DRAFT", ProductServiceBeanTest.DEFAULT_USERNAME,
            Calendar.getInstance().getTime(), ProductServiceBeanTest.DEFAULT_STORE_ID));
    Page<ProductCollection> productCollectionPage = new PageImpl<ProductCollection>(productCollections);
    ProductWorkflowStatus productWorkflowStatus = generateProductWorkflowStatus();
    productWorkflowStatus.setProductCode("MTA-0000001");

    doReturn(Arrays.asList(productWorkflowStatus)).when(productWfService)
        .getProductWorkFlowByProductCodes(Arrays.asList("MTA-0000001"));
    List<ProductCollectionResponse> productCollectionResponseList =
        productServiceBean.getProductCollectionsWithUpdatedFlags(DEFAULT_STORE_ID, productCollectionPage);
    Mockito.verify(this.productWfService).getProductWorkFlowByProductCodes(Mockito.eq(Arrays.asList("MTA-0000001")));
    Assertions.assertEquals(productCollectionResponseList.get(0).getState(), productCollectionResponseList.get(0).getState());
    Assertions.assertEquals(false, productCollectionResponseList.get(0).isContentApproved());
    Assertions.assertEquals(false, productCollectionResponseList.get(0).isImageApproved());
    Assertions.assertEquals(true, productCollectionResponseList.get(0).isProcessImage());
  }

  @Test
  public void getProductsByProductCodesInAndActivatedTrueAndViewableTrueTest() throws Exception {
    List<ProductCollection> productCollections = new ArrayList<ProductCollection>();
    productCollections.add(
        new ProductCollection(UUID.randomUUID().toString(), "MTA-0000001", "Produk 1", "Testing", "CAT-0000001",
            "Kategori 1", "BLT-00001", "Blibli Testing", true, true, "DRAFT", ProductServiceBeanTest.DEFAULT_USERNAME,
            Calendar.getInstance().getTime(), ProductServiceBeanTest.DEFAULT_STORE_ID));
    List<String> productCodes = Arrays.asList("MTA-0000001");
    Mockito.when(productCollectionRepository
        .findByProductCodeInAndStoreIdAndActivatedTrueAndViewableTrueAndMarkForDeleteFalse(productCodes,
            DEFAULT_STORE_ID)).thenReturn(productCollections);
    List<ProductCollectionResponse> productCollectionResponses = this.productServiceBean
        .getProductsByProductCodesInAndActivatedTrueAndViewableTrue(DEFAULT_STORE_ID, productCollections);
    Mockito.verify(productCollectionRepository)
        .findByProductCodeInAndStoreIdAndActivatedTrueAndViewableTrueAndMarkForDeleteFalse(productCodes,
            DEFAULT_STORE_ID);
    Assertions.assertNotNull(productCollectionResponses);
    Assertions.assertEquals(productCollectionResponses.size(), 1);
  }

  @Test
  public void updateForBulkTest() throws Exception {
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString()))
        .thenReturn(profileResponse);
    when(productRepository.updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO))
        .thenReturn(simpleMasterProductUpdateResponse);
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(SHIPPING_WEIGHT);
    when(productBusinessPartnerService.getProductTypeBasedOnProductId(productCollection.getProductId())).thenReturn(1);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    assertNotNull(response);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO);
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(productCollection.getProductId());
    assertEquals(SHIPPING_WEIGHT, simpleMasterProductUpdateRequestDTO.getShippingWeight());
    assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
    assertTrue(response.getUpdateSuccess());
  }

  @Test
  public void updateForBulkWithShippingWeightZeroTest() throws Exception {
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(0.0);
    when(productBusinessPartnerService.getProductTypeBasedOnProductId(productCollection.getProductId())).thenReturn(1);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    assertNotNull(response);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(productCollection.getProductId());
    assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
    assertFalse(response.getUpdateSuccess());
    assertEquals(ErrorMessages.INVALID_DIMENSIONS, response.getReasonOfFailure());
  }

  @Test
  public void updateForBulkWithShippingWeightZeroBigProductTest() throws Exception {
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(0.0);
    when(productBusinessPartnerService.getProductTypeBasedOnProductId(productCollection.getProductId())).thenReturn(2);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    assertNotNull(response);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(productCollection.getProductId());
    assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
    assertFalse(response.getUpdateSuccess());
    assertEquals(ErrorMessages.INVALID_DIMENSIONS, response.getReasonOfFailure());
  }

  @Test
  public void updateForBulkWithShippingWeightZeroBhopisProductTest() throws Exception {
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    when(productRepository.updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO))
        .thenReturn(simpleMasterProductUpdateResponse);
    profileResponse.getCompany().setMerchantType(Constants.TD_MERCHANT);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString()))
        .thenReturn(profileResponse);
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(0.0);
    when(productBusinessPartnerService.getProductTypeBasedOnProductId(productCollection.getProductId())).thenReturn(3);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(productCollection.getProductId());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO);
  }

  @Test
  public void updateForBulkWithShippingWeightZeroForInternalProductsTest() throws Exception {
    productCollection.setBusinessPartnerCode(Constants.INTERNAL);
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(0.0);
    when(productRepository.updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO))
        .thenReturn(simpleMasterProductUpdateResponse);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    assertNotNull(response);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO);
    assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
    assertTrue(response.getUpdateSuccess());
  }

  @Test
  public void updateForBulkWithShippingWeightMoreThan50TDMerchantTest() throws Exception {
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(51.0);
    when(productRepository.updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO))
        .thenReturn(simpleMasterProductUpdateResponse);
    profileResponse.getCompany().setMerchantType(Constants.TD_MERCHANT);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString()))
        .thenReturn(profileResponse);
    when(productBusinessPartnerService.getProductTypeBasedOnProductId(productCollection.getProductId())).thenReturn(1);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(productCollection.getProductId());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO);
  }

  @Test
  public void updateForBulkWithShippingWeightMoreThan50CCMerchantTest() throws Exception {
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(51.0);
    when(productRepository.updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO))
        .thenReturn(simpleMasterProductUpdateResponse);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString()))
        .thenReturn(profileResponse);
    when(productBusinessPartnerService.getProductTypeBasedOnProductId(productCollection.getProductId())).thenReturn(1);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(productCollection.getProductId());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO);
  }

  @Test
  public void updateForBulkTestNoChangeInProductCollection() throws Exception {
    simpleMasterProductUpdateRequestDTO.setName(DEFAULT_PRODUCT_NAME);
    simpleMasterProductUpdateRequestDTO.setBrand(DEFAULT_BRAND);
    Product product = new Product();
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString()))
        .thenReturn(profileResponse);
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(SHIPPING_WEIGHT);
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    when(productRepository.updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO))
        .thenReturn(simpleMasterProductUpdateResponse);
    when(productBusinessPartnerService.getProductTypeBasedOnProductId(productCollection.getProductId())).thenReturn(1);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    assertNotNull(response);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO);
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(productCollection.getProductId());
    assertEquals(SHIPPING_WEIGHT, simpleMasterProductUpdateRequestDTO.getShippingWeight());
    assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
    assertTrue(response.getUpdateSuccess());
  }

  @Test
  public void updateForBulkTestThrowExceptionInShipppingWeightCalculation() throws Exception {
    when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    doThrow(Exception.class).when(generatorService)
        .generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString());
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    assertNotNull(response);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    assertFalse(response.getUpdateSuccess());
    assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
  }

  @Test
  public void getStuckProductCodeAndStateTest() throws Exception {
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.IN_REVIEW);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getVendorApprovalProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateNotFoundInPDTTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "unsetViewableFlagInPCB", true);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.IN_REVIEW);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doThrow(Exception.class).when(productDistributionTaskRepositoryBean)
        .getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Mockito.verify(productWfService).deleteAllExistingWorkFlowAndCreateNewState(productCollection.getStoreId(),
        productCollection.getProductCode(), WorkflowStates.IN_VENDOR.getValue());
    Mockito.verify(productRepository).updateViewable(productCollection.getProductCode(), false);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Assertions.assertNotNull(stuckProductEventPublishDto.getProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateNoUpdateInPDTTest() throws Exception {
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    pdtProductDomainEventModel.setReviewType(ReviewType.CONTENT);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productDistributionTaskRepositoryBean)
        .productRetryStatusUpdate(pdtProductDomainEventModel.getProductCode(),
            ProductRetryStatusUpdate.builder().state(WorkflowState.IN_REVIEW.name()).markForDelete(false)
                .reviewType(pdtProductDomainEventModel.getReviewType().name())
                .revised(pdtProductDomainEventModel.isRevised()).edited(pdtProductDomainEventModel.isEdited()).build());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getVendorApprovalProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateNoUpdateReviewTypeNullInPDTTest() throws Exception {
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    pdtProductDomainEventModel.setReviewType(null);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productDistributionTaskRepositoryBean)
        .productRetryStatusUpdate(pdtProductDomainEventModel.getProductCode(),
            ProductRetryStatusUpdate.builder().state(WorkflowState.IN_REVIEW.name()).markForDelete(false)
                .reviewType(ReviewType.CONTENT.name())
                .revised(pdtProductDomainEventModel.isRevised()).edited(pdtProductDomainEventModel.isEdited()).build());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getVendorApprovalProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateProductNotPresentInPDTTest() throws Exception {
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(null);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Assertions.assertNotNull(stuckProductEventPublishDto.getProductCollection());
  }

  public void getStuckProductCodeAndStateProductNotPresentInPDT_forTrustedSellersTest() throws Exception {
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    StuckProductResponse stuckProductResponseList =
      new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(true);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
      .thenReturn(null);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
      .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(this.productWfService).getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN);
    Mockito.verify(productPublisherService)
      .publish(productCollection.getProductCode(), productCollection.getBusinessPartnerCode(),
        productCollection.getBusinessPartnerName(), productCollection.getUpdatedBy(),
        productCollection.isPostLive(), productCollection.isRestrictedKeywordsPresent(), null,
        productCollection.getPrioritySeller(), true, any(), null);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
      Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
      productCollection.getProductCode());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
  }

  @Test
  public void getStuckProductCodeAndStateProductNotPresentInPDTEditedTest() throws Exception {
    productCollection.setEdited(true);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(null);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateProductNotPresentInPDTRevisedTest() throws Exception {
    productCollection.setNeedRevision(true);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(null);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Assertions.assertNotNull(stuckProductEventPublishDto.getProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateProductNotPresentInPDTRevised_forTrustedSellersTest() throws Exception {
    productCollection.setNeedRevision(true);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    StuckProductResponse stuckProductResponseList =
      new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollection);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(true);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
      .thenReturn(null);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
      Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
      productCollection.getProductCode());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Assertions.assertNotNull(stuckProductEventPublishDto.getProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateProductNotPresentInMFDPDTTest() throws Exception {
    pdtProductDomainEventModel.setMarkForDelete(true);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Assertions.assertNotNull(stuckProductEventPublishDto.getProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateNullTest() throws Exception {
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    productCollection.setPostLive(true);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
            .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(new PDTProductDomainEventModel());
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
        Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
  }

  @Test
  public void getStuckProductCodeAndStateScreeningProductExceptionTest() throws Exception {
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    productCollection.setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(null);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    Mockito.doThrow(Exception.class).when(productPublisherService)
        .publish(productCollection.getProductCode(), productCollection.getBusinessPartnerCode(),
            productCollection.getBusinessPartnerName(), productCollection.getUpdatedBy(),
            productCollection.isPostLive(), productCollection.isRestrictedKeywordsPresent(), RESTRICTED_KEYWORDS_FIELD,
            productCollection.getPrioritySeller(), false, productCollection.getProductId(), null);
    try {
      StuckProductEventPublishDto stuckProductEventPublishDto =
          productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    } catch (Exception e) {
    } finally {
      Mockito.verify(productCollectionRepository)
          .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
      verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
      Mockito.verify(productDistributionTaskRepositoryBean).getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
          Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
      Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
          productCollection.getProductCode());
    }
  }

  @Test
  public void getStuckProductCodeAndStateEditedEventToPDTTest() throws Exception {
    productCollection.setEdited(true);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(
        productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID,
            DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean)
        .getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productDistributionTaskRepositoryBean)
        .productRetryStatusUpdate(pdtProductDomainEventModel.getProductCode(),
            ProductRetryStatusUpdate.builder().state(WorkflowState.IN_REVIEW.name()).markForDelete(false)
                .reviewType(ReviewType.CONTENT.name()).revised(pdtProductDomainEventModel.isRevised())
                .edited(pdtProductDomainEventModel.isEdited()).build());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getEditedPublishProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateEditedEventToNoStatusUpdatePDTTest() throws Exception {
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    productCollection.setEdited(true);
    pdtProductDomainEventModel.setReviewType(ReviewType.IMAGE);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(
        productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID,
            DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean)
        .getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getEditedPublishProductCollection());
  }

  @Test
  public void getStuckProductCodeAndStateRevisedEventToPDTTest() throws Exception {
    productCollection.setNeedRevision(true);
    pdtProductDomainEventModel.setProductCode(PRODUCT_CODE);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    pdtProductDomainEventModel.setReviewType(ReviewType.CONTENT);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(
        productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID,
            DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean)
        .getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(productDistributionTaskRepositoryBean).productRetryStatusUpdate(PRODUCT_CODE, ProductRetryStatusUpdate.builder().state(WorkflowState.NEED_CORRECTION.name()).markForDelete(true)
        .reviewType(pdtProductDomainEventModel.getReviewType().name())
        .revised(pdtProductDomainEventModel.isRevised()).edited(pdtProductDomainEventModel.isEdited())
        .build());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getAddRevisedProductToPDTEvent());
  }

  @Test
  public void getStuckProductCodeAndStateRevisedEventReviewTypeNullToPDTTest() throws Exception {
    productCollection.setNeedRevision(true);
    pdtProductDomainEventModel.setProductCode(PRODUCT_CODE);
    pdtProductDomainEventModel.setState(WorkflowState.PASSED);
    pdtProductDomainEventModel.setReviewType(null);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(
        productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID,
            DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean)
        .getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(productDistributionTaskRepositoryBean).productRetryStatusUpdate(PRODUCT_CODE, ProductRetryStatusUpdate.builder().state(WorkflowState.NEED_CORRECTION.name()).markForDelete(true)
        .reviewType(ReviewType.CONTENT.name())
        .revised(pdtProductDomainEventModel.isRevised()).edited(pdtProductDomainEventModel.isEdited())
        .build());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getAddRevisedProductToPDTEvent());
  }

  @Test
  public void getStuckProductCodeAndStateRevisedEventNoStatusUpdateToPDTTest() throws Exception {
    productCollection.setNeedRevision(true);
    pdtProductDomainEventModel.setProductCode(PRODUCT_CODE);
    pdtProductDomainEventModel.setState(WorkflowState.NEED_CORRECTION);
    pdtProductDomainEventModel.setReviewType(ReviewType.CONTENT);
    List<ProductWfStateResponse> productWfStateResponseList = new ArrayList<>();
    getProductWfResponse(productWfStateResponseList);
    StuckProductResponse stuckProductResponseList =
        new StuckProductResponse(productWfStateResponseList, TOTAL_STUCK_PRODUCTS, productWfStateResponseList);
    Mockito.when(
        productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID,
            DEFAULT_PRODUCT_CODE)).thenReturn(productCollection);
    Mockito.when(productDistributionTaskRepositoryBean.getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID,
            Constants.DEFAULT_USERNAME, stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode()))
        .thenReturn(pdtProductDomainEventModel);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    Mockito.when(productWfService.getStuckProducts(RETRY_COUNT, RETRY_TIME_SPAN)).thenReturn(stuckProductResponseList);
    StuckProductEventPublishDto stuckProductEventPublishDto =
        productServiceBean.getPDTEventDomainModel(productWfStateResponseList.get(0));
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean)
        .getPDTDomainModelResponseByCode(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            stuckProductResponseList.getProductWfStateResponseList().get(0).getProductCode());
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(productOutbound).clearProductCacheSyncByProductIdAndProductCode(productCollection.getProductId(),
        productCollection.getProductCode());
    Assertions.assertNotNull(stuckProductEventPublishDto.getAddRevisedProductToPDTEvent());
  }

  private void getProductWfResponse(List<ProductWfStateResponse> productWfStateResponseList) {
    ProductWfStateResponse productWfStateResponse = new ProductWfStateResponse();
    productWfStateResponse.setProductCode(DEFAULT_PRODUCT_CODE);
    productWfStateResponse.setState(STATE);
    productWfStateResponseList.add(productWfStateResponse);
  }

  @Test
  public void getProductsByStoreIdAndActivatedAndViewableTest() {
    Pageable pageable = PageRequest.of(0, 100);
    productServiceBean.getProductsByStoreIdAndActivatedAndViewable(STORE_ID, false, false, pageable);
    verify(productCollectionRepository)
        .findByStoreIdAndActivatedAndViewableAndMarkForDeleteFalseAndStateAndImageResizedTrueOrderByProductCodeAsc(
            STORE_ID, false, false, WorkflowStates.DRAFT.getValue(), pageable);
  }

  @Test
  public void getProductsByStoreIdAndActivatedAndReviewPendingTest() {
    Mockito.when(productCollectionRepository
        .findByStoreIdAndActivatedAndReviewPendingAndMarkForDeleteFalseAndImageResizedTrueOrderByProductCodeAsc(
            STORE_ID, true, true, pageable)).thenReturn(null);
    Pageable pageable = PageRequest.of(0, 100);
    productServiceBean.getProductsByStoreIdAndActivatedAndReviewPending(STORE_ID, true, true, pageable);
    verify(productCollectionRepository)
        .findByStoreIdAndActivatedAndReviewPendingAndMarkForDeleteFalseAndImageResizedTrueOrderByProductCodeAsc(
            STORE_ID, true, true, pageable);
  }

  @Test
  public void getProductsByStoreIdAndActivatedAndViewableAndUpdatedDateBetweenTest() {
    Date startDate = new Date();
    Date endDate = new Date();
    Pageable pageable = PageRequest.of(0, 100);
    productServiceBean.getProductsByStoreIdAndUpdatedDateBetween(STORE_ID, startDate, endDate, pageable);
    verify(productCollectionRepository)
        .findByStoreIdAndImageResizedTrueAndUpdatedDateBetweenOrderByProductCodeAsc(STORE_ID, startDate, endDate,
            pageable);
  }

  @Test
  public void assignProductsTest() {
    when(productCollectionRepository
        .updateAssignmentStatus(STORE_ID, Collections.singletonList(PRODUCT_CODE), ASSIGNED_TO, ASSIGNED_BY))
        .thenReturn(1);
    productServiceBean.assignProducts(STORE_ID, Collections.singletonList(PRODUCT_CODE), ASSIGNED_TO, ASSIGNED_BY);
    verify(productCollectionRepository)
        .updateAssignmentStatus(STORE_ID, Collections.singletonList(PRODUCT_CODE), ASSIGNED_TO, ASSIGNED_BY);
  }

  @Test
  public void assignProductsExceptionTest() {
    when(productCollectionRepository
        .updateAssignmentStatus(STORE_ID, Collections.singletonList(PRODUCT_CODE), ASSIGNED_TO, ASSIGNED_BY))
        .thenReturn(0);
    try {
      productServiceBean.assignProducts(STORE_ID, Collections.singletonList(PRODUCT_CODE), ASSIGNED_TO, ASSIGNED_BY);
    } catch (ApplicationRuntimeException e) {
    } finally {
      verify(productCollectionRepository)
          .updateAssignmentStatus(STORE_ID, Collections.singletonList(PRODUCT_CODE), ASSIGNED_TO, ASSIGNED_BY);
    }
  }

  @Test
  public void unAssignProductsExceptionTest() {
    when(productCollectionRepository
        .updateAssignmentStatus(STORE_ID, Collections.singletonList(PRODUCT_CODE), ASSIGNED_TO_PREFIX, ASSIGNED_BY))
        .thenReturn(0);
    try {
      productServiceBean
          .assignProducts(STORE_ID, Collections.singletonList(PRODUCT_CODE), ASSIGNED_TO_PREFIX, ASSIGNED_BY);
    } catch (ApplicationRuntimeException e) {
    } finally {
      verify(productCollectionRepository)
          .updateAssignmentStatus(STORE_ID, Collections.singletonList(PRODUCT_CODE), ASSIGNED_TO_PREFIX, ASSIGNED_BY);
    }
  }

  @Test
  public void setBrandCodeAndBrandApprovalStatusTest() {
    productServiceBean.setBrandCodeAndBrandApprovalStatus(DEFAULT_STORE_ID, savedProduct);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, savedProduct.getProductCode());
  }

  @Test
  public void checkAndUpdateSolrTest() throws Exception {
    productCollection.setActivated(Boolean.TRUE);
    productCollection.setViewable(Boolean.TRUE);
    productCollection.setProductCode(DEFAULT_PRODUCT_CODE);
    productCollection.setProductId(DEFAULT_PRODUCT_ID);
    when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Product product = new Product();
    when(productChangeUtil.getChangedProductFields(product, simpleMasterProductUpdateRequestDTO))
        .thenReturn(new ArrayList<>());
    when(productCollectionRepository.save(Mockito.any(ProductCollection.class))).thenReturn(productCollection);
    productServiceBean
        .checkAndUpdateSolr(DEFAULT_STORE_ID, simpleMasterProductUpdateRequestDTO, product, productCollection);
    verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    assertEquals(DEFAULT_PRODUCT_CODE, productCollectionArgumentCaptor.getValue().getProductCode());
    assertEquals(BRAND, productCollectionArgumentCaptor.getValue().getBrand());
    assertEquals(PRODUCT_NAME, productCollectionArgumentCaptor.getValue().getProductName());
    verify(productChangeUtil).getChangedProductFields(product, simpleMasterProductUpdateRequestDTO);
  }

  @Test
  public void checkAndUpdateSolrNameNonNullTest() throws Exception {
    productCollection.setActivated(Boolean.TRUE);
    productCollection.setViewable(Boolean.TRUE);
    productCollection.setProductCode(DEFAULT_PRODUCT_CODE);
    productCollection.setProductId(DEFAULT_PRODUCT_ID);
    when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Product product = new Product();
    when(productChangeUtil.getChangedProductFields(product, simpleMasterProductUpdateRequestDTO))
        .thenReturn(new ArrayList<>());
    when(productCollectionRepository.save(Mockito.any(ProductCollection.class))).thenReturn(productCollection);
    simpleMasterProductUpdateRequestDTO.setName(NAME_WITH_PHONE_NUMBER);
    productServiceBean
        .checkAndUpdateSolr(DEFAULT_STORE_ID, simpleMasterProductUpdateRequestDTO, product, productCollection);
    verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    assertEquals(DEFAULT_PRODUCT_CODE, productCollectionArgumentCaptor.getValue().getProductCode());
    assertEquals(BRAND, productCollectionArgumentCaptor.getValue().getBrand());
    verify(productChangeUtil).getChangedProductFields(product, simpleMasterProductUpdateRequestDTO);
  }

  @Test
  public void checkAndUpdateSolrNameNullTest() throws Exception {
    productCollection.setActivated(Boolean.TRUE);
    productCollection.setViewable(Boolean.TRUE);
    productCollection.setProductCode(DEFAULT_PRODUCT_CODE);
    productCollection.setProductId(DEFAULT_PRODUCT_ID);
    when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Product product = new Product();
    when(productChangeUtil.getChangedProductFields(product, simpleMasterProductUpdateRequestDTO))
        .thenReturn(new ArrayList<>());
    when(productCollectionRepository.save(Mockito.any(ProductCollection.class))).thenReturn(productCollection);
    simpleMasterProductUpdateRequestDTO.setName(null);
    productServiceBean
        .checkAndUpdateSolr(DEFAULT_STORE_ID, simpleMasterProductUpdateRequestDTO, product, productCollection);
    verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    assertEquals(DEFAULT_PRODUCT_CODE, productCollectionArgumentCaptor.getValue().getProductCode());
    assertEquals(BRAND, productCollectionArgumentCaptor.getValue().getBrand());
    verify(productChangeUtil).getChangedProductFields(product, simpleMasterProductUpdateRequestDTO);
  }

  @Test
  public void checkAndUpdateSolrNoChangeTest() throws Exception {
    productCollection.setActivated(Boolean.TRUE);
    productCollection.setViewable(Boolean.TRUE);
    productCollection.setProductCode(DEFAULT_PRODUCT_CODE);
    productCollection.setProductId(DEFAULT_PRODUCT_ID);
    productCollection.setBrand("brand");
    when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Product product = new Product();
    when(productChangeUtil.getChangedProductFields(product, simpleMasterProductUpdateRequestDTO))
        .thenReturn(new ArrayList<>());
    when(productCollectionRepository.save(Mockito.any(ProductCollection.class))).thenReturn(productCollection);
    productServiceBean
        .checkAndUpdateSolr(DEFAULT_STORE_ID, simpleMasterProductUpdateRequestDTO, product, productCollection);
    verify(productChangeUtil).getChangedProductFields(product, simpleMasterProductUpdateRequestDTO);
  }

  @Test
  public void checkAndUpdateSolrWithHistoryUpdateTest() throws Exception {
    productCollection.setActivated(Boolean.TRUE);
    productCollection.setViewable(Boolean.TRUE);
    productCollection.setProductCode(DEFAULT_PRODUCT_CODE);
    productCollection.setProductId(DEFAULT_PRODUCT_ID);
    when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productCollection);
    Product product = new Product();
    when(productChangeUtil.getChangedProductFields(product, simpleMasterProductUpdateRequestDTO))
        .thenReturn(Collections.singletonList(new ProductFieldHistory(FIELD, OLD_VALUE, NEW_VALUE)));
    when(productCollectionRepository.save(Mockito.any(ProductCollection.class))).thenReturn(productCollection);
    productServiceBean
        .checkAndUpdateSolr(DEFAULT_STORE_ID, simpleMasterProductUpdateRequestDTO, product, productCollection);
    verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    assertEquals(DEFAULT_PRODUCT_CODE, productCollectionArgumentCaptor.getValue().getProductCode());
    assertEquals(BRAND, productCollectionArgumentCaptor.getValue().getBrand());
    assertEquals(PRODUCT_NAME, productCollectionArgumentCaptor.getValue().getProductName());
    verify(productChangeUtil).getChangedProductFields(product, simpleMasterProductUpdateRequestDTO);
    verify(productHistoryRepository).save(productHistoryCaptor.capture());
    assertTrue(productHistoryCaptor.getValue().getNotes()
        .contains(Collections.singletonList(new ProductFieldHistory(FIELD, OLD_VALUE, NEW_VALUE)).toString()));
  }


  @Test
  public void setBrandCodeAndBrandApprovalStatusReviewerNotesTest() {
    productServiceBean.setBrandCodeAndBrandApprovalStatus(DEFAULT_STORE_ID, savedProduct);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, savedProduct.getProductCode());
    Assertions.assertEquals(savedProduct.getReviewerNotes(), REVIEWER_NOTES);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImage() throws Exception {
    ProductCollection productCollectionResponse = productCollection;
    productCollectionResponse.setPostLive(true);
    Mockito.when(productCollectionRepository.saveAndFlush(productCollection)).thenReturn(productCollectionResponse);
    ProductCollection response =
        productServiceBean.updateImagePathsAndFlagAfterResizingImage(productAndItemImageRequest, productCollection,
            true);
    verify(this.productRepository).updateProductAndItemImages(productAndItemImageRequest);
    Assertions.assertTrue(response.isImageResized());
    Assertions.assertTrue(response.isPostLive());
  }

  @Test
  public void updateEditedImagePathsAndFlagAfterResizingImage() throws Exception {
    ProductCollection productCollectionResponse = productCollection;
    Mockito.when(productCollectionRepository.saveAndFlush(productCollection)).thenReturn(productCollectionResponse);
    productServiceBean.updateEditedImagePathsAndFlagAfterResizingImage(productAndItemImageRequest, productCollection,
            true, false);
    verify(this.productOutbound).updateProductAndItemImagesByProductCode(false, productAndItemImageRequest);
    verify(this.productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isImageResized());
  }

  @Test
  public void updateSolrOrPublishEvent() throws Exception {
    productCollection.setState(STATE_DRAFT);
    productServiceBean.updateSolrOrPublishEvent(productCollection, false);
    verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Assertions.assertEquals(STATE_DRAFT, productCollectionArgumentCaptor.getValue().getState());
  }

  @Test
  public void updateSolrOrPublishEventFlow3() throws Exception {
    productCollection.setState(STATE_IN_PROGRESS);
    productCollection.setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    productServiceBean.updateSolrOrPublishEvent(productCollection, false);
    verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(productPublisherService)
        .publish(productCollection.getProductCode(), productCollection.getBusinessPartnerCode(),
            productCollection.getBusinessPartnerName(), productCollection.getUpdatedBy(),
            productCollection.isPostLive(), productCollection.isRestrictedKeywordsPresent(),
            RESTRICTED_KEYWORDS_FIELD, productCollection.getPrioritySeller(), false,
            productCollection.getProductId(), productCollection);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailure() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE,
        productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertEquals(productCollectionArgumentCaptor.getValue().isImageResized(), true);
    Assertions.assertEquals(true, status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureFlow3() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_IN_PROGRESS);
    productCollection.setPostLive(true);
    productCollection.setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    Mockito.when(getProductPublisherService()
        .publish(productCollection.getProductCode(), productCollection.getBusinessPartnerCode(),
            productCollection.getBusinessPartnerName(), productCollection.getUpdatedBy(),
            productCollection.isPostLive(), productCollection.isRestrictedKeywordsPresent(), RESTRICTED_KEYWORDS_FIELD,
            productCollection.getPrioritySeller(), false, productCollection.getProductId(), productCollection))
        .thenReturn(new ScreeningProductApprovalEvent());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    Mockito.verify(productPublisherService)
        .publish(productCollection.getProductCode(), productCollection.getBusinessPartnerCode(),
            productCollection.getBusinessPartnerName(), productCollection.getUpdatedBy(),
            productCollection.isPostLive(), productCollection.isRestrictedKeywordsPresent(),
            productCollection.getRestrictedKeywordsDetected(), productCollection.getPrioritySeller(),
          false, productCollection.getProductId(), productCollection);
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE,
        productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertEquals(true, status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureFlow3_forTrustedSellers() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
      .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
      .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_IN_PROGRESS);
    productCollection.setPostLive(true);
    productCollection.setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
      .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
      .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
      .thenReturn(productCollection);
    when(productLevel3Helper
      .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
      .thenReturn(new ArrayList<>());
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
      .saveAndFlush(Mockito.any(ProductCollection.class));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(true);
    Mockito.when(getProductPublisherService()
        .publish(productCollection.getProductCode(), productCollection.getBusinessPartnerCode(),
          productCollection.getBusinessPartnerName(), productCollection.getUpdatedBy(),
          productCollection.isPostLive(), productCollection.isRestrictedKeywordsPresent(), RESTRICTED_KEYWORDS_FIELD,
          productCollection.getPrioritySeller(), false, productCollection.getProductId(), productCollection))
      .thenReturn(new ScreeningProductApprovalEvent());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
      .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    Mockito.verify(productPublisherService)
      .publish(productCollection.getProductCode(), productCollection.getBusinessPartnerCode(),
        productCollection.getBusinessPartnerName(), productCollection.getUpdatedBy(),
        productCollection.isPostLive(), productCollection.isRestrictedKeywordsPresent(),
        productCollection.getRestrictedKeywordsDetected(), productCollection.getPrioritySeller(),
        true, productCollection.getProductId(), productCollection);
    verify(productLevel3Helper)
      .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(solrReviewProductCollectionService)
      .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
      productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
        .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
      .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE,
      productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertEquals(true, status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureFlow3AlreadyResized() throws Exception {
    productCollection.setImageResized(true);
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_IN_PROGRESS);
    productCollection.setPostLive(true);
    productCollection.setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(false);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.when(getProductPublisherService()
        .publish(productCollection.getProductCode(), productCollection.getBusinessPartnerCode(),
            productCollection.getBusinessPartnerName(), productCollection.getUpdatedBy(),
            productCollection.isPostLive(), productCollection.isRestrictedKeywordsPresent(),
            RESTRICTED_KEYWORDS_FIELD, productCollection.getPrioritySeller(), false, productCollection.getProductId(),
            null))
        .thenReturn(new ScreeningProductApprovalEvent());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureExceptionTest() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doThrow(Exception.class).when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_IN_PROGRESS);
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Assertions.assertEquals(false, status);
  }

  @Test
  public void getDraftProductsTest() {
    productServiceBean.getDraftProducts(STORE_ID, pageable);
    verify(productCollectionRepository)
        .findByStoreIdAndStateInAndMarkForDeleteFalseOrderByProductCode(Mockito.eq(STORE_ID),
            listArgumentCaptor.capture(), Mockito.eq(pageable));
    Assertions.assertEquals(1, listArgumentCaptor.getValue().size());
    Assertions.assertEquals(STATE_DRAFT, listArgumentCaptor.getValue().get(0));
  }

  @Test
  public void getDraftProductsStoreIdNullTest() {
    assertThrows(ApplicationRuntimeException.class, () -> {
      productServiceBean.getDraftProducts(null, pageable);
    });
  }

  @Test
  public void updateProductCollectionAsPostLiveTrueTest() throws Exception {
    productServiceBean.updateProductCollectionPostLiveFlag(productCollection, true);
    verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Assertions.assertEquals(productCollection.getProductCode(),
        productCollectionArgumentCaptor.getAllValues().get(0).getProductCode());
    Assertions.assertEquals(productCollection.getProductCode(),
        productCollectionArgumentCaptor.getAllValues().get(1).getProductCode());
    Assertions.assertTrue(productCollectionArgumentCaptor.getAllValues().get(0).isPostLive());
    Assertions.assertTrue(productCollectionArgumentCaptor.getAllValues().get(1).isPostLive());
  }

  @Test
  public void updateProductCollectionAsPreLiveTrueTest() throws Exception {
    productServiceBean.updateProductCollectionPostLiveFlag(productCollection, false);
    verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Assertions.assertEquals(productCollection.getProductCode(),
        productCollectionArgumentCaptor.getAllValues().get(0).getProductCode());
    Assertions.assertEquals(productCollection.getProductCode(),
        productCollectionArgumentCaptor.getAllValues().get(1).getProductCode());
    Assertions.assertFalse(productCollectionArgumentCaptor.getAllValues().get(0).isPostLive());
    Assertions.assertFalse(productCollectionArgumentCaptor.getAllValues().get(1).isPostLive());
  }

  private ProductDetailResponse getProductDetailResponseWithImages() {
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    productDetailResponse.setProductCode(PRODUCT_CODE);
    productDetailResponse.setName(PRODUCT_NAME);
    productDetailResponse.setUniqueSellingPoint(UNIQUE_SELLING_POINT);
    productDetailResponse.setDescription(DEFAULT_PRODUCT_DESCRIPTION.getBytes());
    productDetailResponse.setCategoryCodes(Collections.singletonList(CATEGORY_CODE));
    Image image = new Image();
    image.setLocationPath(IMAGE_LOCATION_PATH_1);
    image.setHashCode(IMAGE_HASH_CODE_1);
    image.setOriginalImage(true);
    Image image1 = new Image();
    image1.setLocationPath(IMAGE_LOCATION_PATH_2);
    image1.setHashCode(IMAGE_HASH_CODE_2);
    image1.setOriginalImage(true);
    Image image2 = new Image();
    image2.setLocationPath(IMAGE_LOCATION_PATH_3);
    image2.setHashCode(IMAGE_HASH_CODE_3);
    image2.setOriginalImage(true);
    Image image3 = new Image();
    image3.setLocationPath(IMAGE_LOCATION_PATH_4);
    image3.setHashCode(IMAGE_HASH_CODE_4);
    image3.setOriginalImage(true);
    productDetailResponse.setImages(Arrays.asList(image, image1, image2, image3));
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setId(PRODUCT_ITEM_ID);
    productItemResponse.setGeneratedItemName(PRODUCT_ITEM_NAME);
    productItemResponse.setImages(Arrays.asList(image, image1));
    ProductItemResponse productItemResponse1 = new ProductItemResponse();
    productItemResponse1.setId(PRODUCT_ITEM_ID_1);
    productItemResponse1.setGeneratedItemName(PRODUCT_ITEM_NAME);
    productItemResponse1.setImages(Arrays.asList(image2, image1));
    productDetailResponse
        .setProductItemResponses(new HashSet<>(Arrays.asList(productItemResponse, productItemResponse1)));
    return productDetailResponse;
  }

  @Test
  public void getProductListFilterTest() throws Exception {
    Mockito.when(this.solrActiveProductCollectionRepository
        .getProductCollectionListForFilterRequest(STORE_ID, productFilterRequest, pageable))
        .thenReturn(new PageImpl<>(Arrays.asList(solrProductCollectionDTO), pageable, TOTAL_RECORDS));
    Page<ProductFilterResponse> productFilterResponsePage =
        this.productServiceBean.getProductListFilter(STORE_ID, productFilterRequest, DEFAULT_PAGE, DEFAULT_SIZE);
    Mockito.verify(this.solrActiveProductCollectionRepository)
        .getProductCollectionListForFilterRequest(STORE_ID, productFilterRequest, pageable);
    Assertions.assertEquals(PRODUCT_CODE, productFilterResponsePage.getContent().get(0).getProductCode());
    Assertions.assertEquals(PRODUCT_NAME, productFilterResponsePage.getContent().get(0).getProductName());
    Assertions.assertEquals(BRAND, productFilterResponsePage.getContent().get(0).getBrandName());
    Assertions.assertEquals(CATEGORY_NAME, productFilterResponsePage.getContent().get(0).getCategoryName());
  }

  @Test
  public void updateProductAsPostLiveTrueTest() throws Exception {
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    productServiceBean.updateProductAsPostLiveTrue(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    Mockito.verify(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    Assertions.assertEquals(productCollection.getProductCode(), productCollectionArgumentCaptor.getValue().getProductCode());
  }

  @Test
  public void updateBuyableAndDiscoverableFlagAndSendMailOnMarginChangeTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "cncForWarehouseFeatureSwitch", true);
    List<String> itemSkus = Arrays.asList(ITEM_SKU);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerRepository.getAllItemSkusByProductId(productCollection.getProductId()))
        .thenReturn(itemSkus);
    Mockito.doNothing().when(productLevel3Service)
        .updateItemViewConfig(Mockito.any(ItemViewConfigRequest.class), eq(ITEM_SKU), eq(StringUtils.EMPTY));
    Mockito.doNothing().when(productMailEventService)
        .createAndSaveCategoryChangeMailEvent(eq(productCollection), Mockito.any(CategoryChangeMailEvent.class));
    this.productServiceBean
        .updateBuyableAndDiscoverableFlagAndSendMailOnMarginChange(STORE_ID, CATEGORY_CODE, CATEGORY_NAME, PRODUCT_CODE,
            true, StringUtils.EMPTY);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productBusinessPartnerRepository).getAllItemSkusByProductId(productCollection.getProductId());
    Mockito.verify(productLevel3Service, times(2))
        .updateItemViewConfig(itemViewConfigRequestArgumentCaptor.capture(), eq(ITEM_SKU), eq(StringUtils.EMPTY));
    Mockito.verify(productMailEventService)
        .createAndSaveCategoryChangeMailEvent(productCollectionArgumentCaptor.capture(),
            categoryChangeMailEventArgumentCaptor.capture());
    Assertions.assertEquals(ChannelName.CNC.name(), itemViewConfigRequestArgumentCaptor.getValue().getChannel());
    Assertions.assertEquals(false, itemViewConfigRequestArgumentCaptor.getValue().isBuyable());
    Assertions.assertEquals(false, itemViewConfigRequestArgumentCaptor.getValue().isDiscoverable());
    Assertions.assertEquals(CATEGORY_CODE, categoryChangeMailEventArgumentCaptor.getValue().getExistingCategoryCode());
    Assertions.assertEquals(CATEGORY_NAME, categoryChangeMailEventArgumentCaptor.getValue().getExistingCategoryName());
  }

  @Test
  public void updateBuyableAndDiscoverableFlagAndSendMailOnMarginChangeCnc1pSwitchOffTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "cncForWarehouseFeatureSwitch", false);
    List<String> itemSkus = Arrays.asList(ITEM_SKU);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerRepository.getAllItemSkusByProductId(productCollection.getProductId()))
        .thenReturn(itemSkus);
    Mockito.doNothing().when(productLevel3Service)
        .updateItemViewConfig(Mockito.any(ItemViewConfigRequest.class), eq(ITEM_SKU), eq(StringUtils.EMPTY));
    Mockito.doNothing().when(productMailEventService)
        .createAndSaveCategoryChangeMailEvent(eq(productCollection), Mockito.any(CategoryChangeMailEvent.class));
    this.productServiceBean
        .updateBuyableAndDiscoverableFlagAndSendMailOnMarginChange(STORE_ID, CATEGORY_CODE, CATEGORY_NAME, PRODUCT_CODE,
            true, StringUtils.EMPTY);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productBusinessPartnerRepository).getAllItemSkusByProductId(productCollection.getProductId());
    Mockito.verify(productLevel3Service)
        .updateItemViewConfig(itemViewConfigRequestArgumentCaptor.capture(), eq(ITEM_SKU), eq(StringUtils.EMPTY));
    Mockito.verify(productMailEventService)
        .createAndSaveCategoryChangeMailEvent(productCollectionArgumentCaptor.capture(),
            categoryChangeMailEventArgumentCaptor.capture());
    Assertions.assertEquals(ChannelName.DEFAULT.name(), itemViewConfigRequestArgumentCaptor.getValue().getChannel());
    Assertions.assertEquals(false, itemViewConfigRequestArgumentCaptor.getValue().isBuyable());
    Assertions.assertEquals(false, itemViewConfigRequestArgumentCaptor.getValue().isDiscoverable());
    Assertions.assertEquals(CATEGORY_CODE, categoryChangeMailEventArgumentCaptor.getValue().getExistingCategoryCode());
    Assertions.assertEquals(CATEGORY_NAME, categoryChangeMailEventArgumentCaptor.getValue().getExistingCategoryName());
  }

  @Test
  public void updateBuyableAndDiscoverableFlagAndSendMailOnMarginChangePreliveTest() throws Exception {
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(1).when(productBusinessPartnerRepository)
        .markItemsAsUnBuyableAndUnViewable(productCollection.getProductId());
    Mockito.doNothing().when(productMailEventService)
        .createAndSaveCategoryChangeMailEvent(eq(productCollection), Mockito.any(CategoryChangeMailEvent.class));
    this.productServiceBean
        .updateBuyableAndDiscoverableFlagAndSendMailOnMarginChange(STORE_ID, CATEGORY_CODE, CATEGORY_NAME, PRODUCT_CODE,
            false, StringUtils.EMPTY);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productBusinessPartnerRepository)
        .markItemsAsUnBuyableAndUnViewable(productCollection.getProductId());
    Mockito.verify(productMailEventService)
        .createAndSaveCategoryChangeMailEvent(productCollectionArgumentCaptor.capture(),
            categoryChangeMailEventArgumentCaptor.capture());
    Assertions.assertEquals(CATEGORY_CODE, categoryChangeMailEventArgumentCaptor.getValue().getExistingCategoryCode());
    Assertions.assertEquals(CATEGORY_NAME, categoryChangeMailEventArgumentCaptor.getValue().getExistingCategoryName());
  }

  @Test
  public void updatePostLiveStatusTest() {
    ProductCollection productCollectionResponse = productCollection;
    productCollectionResponse.setPostLive(true);
    Mockito.when(productCollectionRepository.saveAndFlush(productCollection)).thenReturn(productCollectionResponse);
    ProductCollection response = productServiceBean.updatePostLiveStatus(this.productCollection, true);
    verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    assertTrue(productCollectionArgumentCaptor.getValue().isPostLive());
    assertTrue(response.isPostLive());
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureNotification() throws Exception {
    List<String> keywordList = Arrays.asList(KEYWORD, DEFAULT_PRODUCT_DESCRIPTION);
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(Arrays.asList(new RestrictedKeywordsByField()));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BP_CODE))
        .thenReturn(profileResponse);
    Mockito.doNothing().when(productNotificationService)
        .sendNotificationForProductWithRestrictedKeyword(BP_CODE, PRODUCT_NAME, true);
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(BP_CODE);
    Mockito.verify(productNotificationService)
        .sendNotificationForProductWithRestrictedKeyword(BP_CODE, PRODUCT_NAME, true);
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE,
        productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isImageResized());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isRestrictedKeywordsPresent());
    Assertions.assertTrue(status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureUSPCheckNotification() throws Exception {
    List<String> keywordList = Arrays.asList(KEYWORD, UNIQUE_SELLING_POINT, NOTES);
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(Arrays.asList(new RestrictedKeywordsByField()));
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BP_CODE))
        .thenReturn(profileResponse);
    Mockito.doNothing().when(productNotificationService)
        .sendNotificationForProductWithRestrictedKeyword(BP_CODE, PRODUCT_NAME, true);
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
     verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(BP_CODE);
    Mockito.verify(productNotificationService)
        .sendNotificationForProductWithRestrictedKeyword(BP_CODE, PRODUCT_NAME, true);
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE,
        productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isImageResized());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isRestrictedKeywordsPresent());
    Assertions.assertTrue(status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureNoKeywordTest() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE,
        productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isImageResized());
    Assertions.assertFalse(productCollectionArgumentCaptor.getValue().isRestrictedKeywordsPresent());
    Assertions.assertTrue( status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImagePostLiveNotification() throws Exception {
    List<String> keywordList = Arrays.asList(KEYWORD, UNIQUE_SELLING_POINT, NOTES);
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(false);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(Arrays.asList(new RestrictedKeywordsByField()));
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isImageResized());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isRestrictedKeywordsPresent());
    Assertions.assertTrue(status);
  }

  @Test
  public void findProductsForDalamProcessTest() throws Exception {
    Mockito.when(this.solrReviewProductCollectionService.findProductsForDalamProcess(dalamProductListRequest, pageable))
        .thenReturn(this.productCollectionPage);
    Page<ProductCollection> result = this.productServiceBean.findProductsForDalamProcess(dalamProductListRequest);
    Mockito.verify(this.solrReviewProductCollectionService)
        .findProductsForDalamProcess(dalamProductListRequest, pageable);
  }

  @Test
  public void findProductsForDalamProcessExceptionTest() throws Exception {
    Mockito.when(this.solrReviewProductCollectionService.findProductsForDalamProcess(dalamProductListRequest, pageable))
        .thenThrow(IOException.class);
    Exception exception = new Exception();
    try {
      productServiceBean.findProductsForDalamProcess(dalamProductListRequest);
    } catch (Exception e) {
      exception = e;
    } finally {
      Mockito.verify(this.solrReviewProductCollectionService)
          .findProductsForDalamProcess(dalamProductListRequest, pageable);
      Assertions.assertTrue(exception instanceof IOException);
    }
  }

  @Test
  public void findProductsForDalamProcessInBetweenAgeTest() throws Exception {
    Mockito.when(this.solrReviewProductCollectionService.findProductsForDalamProcess(dalamProductListRequest, pageable))
        .thenReturn(this.productCollectionPage);
    Page<ProductCollection> result =
        this.productServiceBean.findProductsForDalamProcessInBetweenAge(dalamProductListRequest);
    Mockito.verify(this.solrReviewProductCollectionService)
        .findProductsForDalamProcess(dalamProductListRequest, pageable);
  }

  @Test
  public void findProductsForDalamProcessInBetweenAgeTestException() throws Exception {
    dalamProductListRequest.setActivated(Boolean.TRUE);
    dalamProductListRequest.setTimeFilterType(TimeFilterType.TODAY.getTimeFilterType());
    Mockito.when(this.solrReviewProductCollectionService.findProductsForDalamProcess(dalamProductListRequest, pageable))
        .thenThrow(IOException.class);
    Exception exception = new Exception();
    try{
      productServiceBean.findProductsForDalamProcessInBetweenAge(dalamProductListRequest);
    } catch (Exception e){
      exception = e;
    }
    finally {
      Mockito.verify(this.solrReviewProductCollectionService)
          .findProductsForDalamProcess(dalamProductListRequest, pageable);
      Assertions.assertTrue(exception instanceof IOException);
    }
  }

  @Test
  public void findProductsForDalamProcessAgeLessThenTest() throws Exception {
    Mockito.when(this.solrReviewProductCollectionService.findProductsForDalamProcess(dalamProductListRequest, pageable))
        .thenReturn(this.productCollectionPage);
    Page<ProductCollection> result =
        this.productServiceBean.findProductsForDalamProcessAgeLessThen(dalamProductListRequest);
    Mockito.verify(this.solrReviewProductCollectionService)
        .findProductsForDalamProcess(dalamProductListRequest, pageable);
  }

  @Test
  public void findProductsForDalamProcessAgeLessThenExceptionTest() throws Exception {
    dalamProductListRequest.setActivated(Boolean.TRUE);
    dalamProductListRequest.setTimeFilterType(TimeFilterType.FIVE_DAYS_AGO.getTimeFilterType());
    Mockito.when(this.solrReviewProductCollectionService.findProductsForDalamProcess(dalamProductListRequest, pageable))
        .thenThrow(IOException.class);
    Exception exception = new Exception();
    try {
      productServiceBean.findProductsForDalamProcessAgeLessThen(dalamProductListRequest);
    } catch (Exception e) {
      exception = e;
    } finally {
      Mockito.verify(this.solrReviewProductCollectionService)
          .findProductsForDalamProcess(dalamProductListRequest, pageable);
      Assertions.assertTrue(exception instanceof IOException);
    }
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailurePhoneNumberCheckNotification() throws Exception {
    List<String> keywordList = Arrays.asList(KEYWORD, NOTES);
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    productDetailResponse.setName(NAME_WITH_PHONE_NUMBER);
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BP_CODE)).thenReturn(profileResponse);
    Mockito.doNothing().when(productNotificationService)
        .sendNotificationForProductWithRestrictedKeyword(BP_CODE, PRODUCT_NAME, true);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(Arrays.asList(new RestrictedKeywordsByField()));
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(BP_CODE);
    Mockito.verify(productNotificationService)
        .sendNotificationForProductWithRestrictedKeyword(BP_CODE, PRODUCT_NAME, true);
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE,
        productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isImageResized());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isRestrictedKeywordsPresent());
    Assertions.assertTrue(status);
  }

  @Test
  public void publishImageQcEventTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enablePriceUpdateInImageQcRequest", true);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    List<ProductBusinessPartner> bp =new ArrayList<>();
    ProductBusinessPartner businessPartner1 = new ProductBusinessPartner();
    businessPartner1.setProductId(PRODUCT_ID);
    businessPartner1.setId(ID);
    businessPartner1.setBusinessPartnerId(BUSINESS_PARTNER_ID);
    bp.add(businessPartner1);
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setSalePrice(55.44);
    productItemBusinessPartner1.setId(ID);
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner2.setSalePrice(20.44);
    productItemBusinessPartnerList.addAll(Arrays.asList(
        productItemBusinessPartner1,productItemBusinessPartner2));
    productDetailResponse.getImages().get(0).setOriginalImage(false);
    productDetailResponse.getImages().get(1).setOriginalImage(false);
    Mockito.when(fileStorageService.getImagePathPrefix()).thenReturn(GCS_PATH_PREFIX);
    Mockito.when(fileStorageService.getCompleteSourceUrlPrefix()).thenReturn(GCS_COMPLETE_SOURCE_URL);
    bp.get(0).setBusinessPartnerId(SELLER_CODE);
    Mockito.when(productBusinessPartnerService.findByStoreIdAndProductId(productDetailResponse.getStoreId(), productDetailResponse.getId())).thenReturn(bp);
    Mockito.when(productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalse(productDetailResponse.getStoreId(),
        ID)).thenReturn(productItemBusinessPartnerList);
    ImageQcRequestDomainEvent imageQcRequestDomainEvent =
        productServiceBean.publishImageQcEvent(bulkImageProcessResponse, productDetailResponse,
            new RestrictedKeywordsByFieldAndActionType());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Mockito.verify(fileStorageService).getImagePathPrefix();
    Mockito.verify(fileStorageService).getCompleteSourceUrlPrefix();
    Assertions.assertEquals(PRODUCT_CODE, imageQcRequestDomainEvent.getProductCode());
    Mockito.verify(productBusinessPartnerService).findByStoreIdAndProductId(productDetailResponse.getStoreId()
        , productDetailResponse.getId());
    Mockito.when( productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalse(anyString(),
        anyString())).thenReturn(productItemBusinessPartnerList);
    Assertions.assertEquals(4, imageQcRequestDomainEvent.getImages().size());
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().startsWith(IMAGE_SOURCE_DIRECTORY));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().contains(IMAGE_LOCATION_PATH_1));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(1).getLocationPath().contains(IMAGE_LOCATION_PATH_2));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(2).getLocationPath().contains(IMAGE_LOCATION_PATH_3));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(3).getLocationPath().contains(IMAGE_LOCATION_PATH_4));
    Assertions.assertEquals(SELLER_CODE, imageQcRequestDomainEvent.getSellerCode());
  }

  @Test
  public void publishImageQcEventWithNoPriceDetailsTest() throws Exception {
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    List<ProductBusinessPartner> bp =new ArrayList<>();
    ProductBusinessPartner businessPartner1 = new ProductBusinessPartner();
    businessPartner1.setProductId(PRODUCT_ID);
    businessPartner1.setId(ID);
    businessPartner1.setBusinessPartnerId(BUSINESS_PARTNER_ID);
    bp.add(businessPartner1);
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setSalePrice(55.44);
    productItemBusinessPartner1.setId(ID);
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner2.setSalePrice(20.44);
    productItemBusinessPartnerList.addAll(Arrays.asList(
        productItemBusinessPartner1,productItemBusinessPartner2));
    productDetailResponse.getImages().get(0).setOriginalImage(false);
    productDetailResponse.getImages().get(1).setOriginalImage(false);
    Mockito.when(fileStorageService.getImagePathPrefix()).thenReturn(GCS_PATH_PREFIX);
    Mockito.when(fileStorageService.getCompleteSourceUrlPrefix()).thenReturn(GCS_COMPLETE_SOURCE_URL);
    Mockito.when(productBusinessPartnerService.findByStoreIdAndProductId(productDetailResponse.getStoreId(), productDetailResponse.getId())).thenReturn(bp);
    Mockito.when(productItemBusinessPartnerRepository.findByStoreIdAndProductItemIdAndMarkForDeleteFalse(productDetailResponse.getStoreId(),
        ID)).thenReturn(productItemBusinessPartnerList);
    ImageQcRequestDomainEvent imageQcRequestDomainEvent =
        productServiceBean.publishImageQcEvent(bulkImageProcessResponse, productDetailResponse,
            new RestrictedKeywordsByFieldAndActionType());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Mockito.verify(fileStorageService).getImagePathPrefix();
    Mockito.verify(fileStorageService).getCompleteSourceUrlPrefix();
    Assertions.assertEquals(PRODUCT_CODE, imageQcRequestDomainEvent.getProductCode());
    Assertions.assertEquals(4, imageQcRequestDomainEvent.getImages().size());
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().startsWith(IMAGE_SOURCE_DIRECTORY));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().contains(IMAGE_LOCATION_PATH_1));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(1).getLocationPath().contains(IMAGE_LOCATION_PATH_2));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(2).getLocationPath().contains(IMAGE_LOCATION_PATH_3));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(3).getLocationPath().contains(IMAGE_LOCATION_PATH_4));
  }

  @Test
  public void publishImageQcEventForEditedImagesTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enablePriceUpdateInImageQcRequest", true);
    Mockito.when(fileStorageService.getImagePathPrefix()).thenReturn(GCS_PATH_PREFIX);
    Mockito.when(fileStorageService.getCompleteSourceUrlPrefix()).thenReturn(GCS_COMPLETE_SOURCE_URL);
    Mockito.when(xProductOutbound.getMinAndMaxOfferPrice(anyString()))
        .thenReturn(new MinMaxItemPriceResponse(MIN_PRICE, MAX_PRICE, PRODUCT_SKU));
    ImageQcRequestDomainEvent imageQcRequestDomainEvent =
        productServiceBean.publishImageQcEventForEditedImages(PRODUCT_CODE, imageList, productDetailResponse,false,
            new RestrictedKeywordsByFieldAndActionType(), BUSINESS_PARTNER_CODE);
    Mockito.verify(fileStorageService).getImagePathPrefix();
    Mockito.verify(fileStorageService).getCompleteSourceUrlPrefix();
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Assertions.assertEquals(PRODUCT_CODE, imageQcRequestDomainEvent.getProductCode());
    Assertions.assertEquals(4, imageQcRequestDomainEvent.getImages().size());
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().startsWith(IMAGE_SOURCE_DIRECTORY));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().contains(IMAGE_LOCATION_PATH_1));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(1).getLocationPath().contains(IMAGE_LOCATION_PATH_2));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(2).getLocationPath().contains(IMAGE_LOCATION_PATH_3));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(3).getLocationPath().contains(IMAGE_LOCATION_PATH_4));
    Mockito.verify(xProductOutbound).getMinAndMaxOfferPrice(anyString());
    Assertions.assertEquals(MIN_PRICE, imageQcRequestDomainEvent.getMinPrice());
    Assertions.assertEquals(MAX_PRICE, imageQcRequestDomainEvent.getMaxPrice());
  }

  @Test
  public void publishImageQcEventForEditedImagesTestWhenIsRevisedMinMaxPriceUpdate() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enablePriceUpdateInImageQcRequest", true);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    List<ProductBusinessPartner> bp =new ArrayList<>();
    ProductBusinessPartner businessPartner1 = new ProductBusinessPartner();
    businessPartner1.setProductId(PRODUCT_ID);
    businessPartner1.setId(ID);
    businessPartner1.setBusinessPartnerId(BUSINESS_PARTNER_ID);
    bp.add(businessPartner1);
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setSalePrice(55.44);
    productItemBusinessPartner1.setId(ID);
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner2.setSalePrice(20.44);
    productItemBusinessPartnerList.addAll(Arrays.asList(
        productItemBusinessPartner1,productItemBusinessPartner2));
    Mockito.when(fileStorageService.getImagePathPrefix()).thenReturn(GCS_PATH_PREFIX);
    Mockito.when(fileStorageService.getCompleteSourceUrlPrefix()).thenReturn(GCS_COMPLETE_SOURCE_URL);
   Mockito.when(productBusinessPartnerService.findByStoreIdAndProductId(anyString(), anyString())).thenReturn(bp);
    Mockito.when( productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalse(anyString(),
        anyString())).thenReturn(productItemBusinessPartnerList);
    ImageQcRequestDomainEvent imageQcRequestDomainEvent =
        productServiceBean.publishImageQcEventForEditedImages(PRODUCT_CODE, imageList, productDetailResponse,true,
            new RestrictedKeywordsByFieldAndActionType(), BUSINESS_PARTNER_CODE);
    Mockito.verify(fileStorageService).getImagePathPrefix();
    Mockito.verify(fileStorageService).getCompleteSourceUrlPrefix();
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Assertions.assertEquals(PRODUCT_CODE, imageQcRequestDomainEvent.getProductCode());
    Assertions.assertEquals(4, imageQcRequestDomainEvent.getImages().size());
    verify(productBusinessPartnerService).findByStoreIdAndProductId(anyString(),anyString());
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().startsWith(IMAGE_SOURCE_DIRECTORY));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().contains(IMAGE_LOCATION_PATH_1));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(1).getLocationPath().contains(IMAGE_LOCATION_PATH_2));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(2).getLocationPath().contains(IMAGE_LOCATION_PATH_3));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(3).getLocationPath().contains(IMAGE_LOCATION_PATH_4));
  }

  @Test
  public void publishImageQcEventForEditedImagesTestWhenIsRevisedMinMaxPriceUpdateForNull() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enablePriceUpdateInImageQcRequest", true);
    ProductDetailResponse productDetailResponse = generateProductDetailResponse();
    List<ProductBusinessPartner> bp =new ArrayList<>();
    ProductBusinessPartner businessPartner1 = new ProductBusinessPartner();
    businessPartner1.setProductId(PRODUCT_ID);
    businessPartner1.setId(ID);
    businessPartner1.setBusinessPartnerId(BUSINESS_PARTNER_ID);
    bp.add(businessPartner1);
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setSalePrice(55.44);
    productItemBusinessPartner1.setId(ID);
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner2.setSalePrice(20.44);
    productItemBusinessPartnerList.addAll(Arrays.asList(
        productItemBusinessPartner1,productItemBusinessPartner2));
    Mockito.when(fileStorageService.getImagePathPrefix()).thenReturn(GCS_PATH_PREFIX);
    Mockito.when(fileStorageService.getCompleteSourceUrlPrefix()).thenReturn(GCS_COMPLETE_SOURCE_URL);
    Mockito.when(productBusinessPartnerService.findByStoreIdAndProductId(anyString(), anyString())).thenReturn(null);
    Mockito.when( productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalse(anyString(),
        anyString())).thenReturn(productItemBusinessPartnerList);
    ImageQcRequestDomainEvent imageQcRequestDomainEvent =
        productServiceBean.publishImageQcEventForEditedImages(PRODUCT_CODE, imageList, productDetailResponse,true,
            new RestrictedKeywordsByFieldAndActionType(), BUSINESS_PARTNER_CODE);
    Mockito.verify(fileStorageService).getImagePathPrefix();
    Mockito.verify(fileStorageService).getCompleteSourceUrlPrefix();
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Assertions.assertEquals(PRODUCT_CODE, imageQcRequestDomainEvent.getProductCode());
    Assertions.assertEquals(4, imageQcRequestDomainEvent.getImages().size());
    verify(productBusinessPartnerService).findByStoreIdAndProductId(anyString(),anyString());
    Assertions
        .assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().startsWith(IMAGE_SOURCE_DIRECTORY));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(0).getLocationPath().contains(IMAGE_LOCATION_PATH_1));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(1).getLocationPath().contains(IMAGE_LOCATION_PATH_2));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(2).getLocationPath().contains(IMAGE_LOCATION_PATH_3));
    Assertions.assertTrue(imageQcRequestDomainEvent.getImages().get(3).getLocationPath().contains(IMAGE_LOCATION_PATH_4));
  }

  @Test
  public void publishImageQcEventForEditedImagesEmptyImagesTest()  {
    ReflectionTestUtils.setField(getProductServiceBean(), "enablePriceUpdateInImageQcRequest", true);
    Mockito.when(xProductOutbound.getMinAndMaxOfferPrice(anyString())).thenReturn(new
        MinMaxItemPriceResponse(MIN_PRICE, MAX_PRICE, PRODUCT_SKU));
    ImageQcRequestDomainEvent imageQcRequestDomainEvent =
        productServiceBean.publishImageQcEventForEditedImages(PRODUCT_CODE, new ArrayList<>(), productDetailResponse,false,
            new RestrictedKeywordsByFieldAndActionType(), BUSINESS_PARTNER_CODE);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Mockito.verify(xProductOutbound).getMinAndMaxOfferPrice(anyString());
    Assertions.assertEquals(PRODUCT_CODE, imageQcRequestDomainEvent.getProductCode());
    Assertions.assertEquals(0, imageQcRequestDomainEvent.getImages().size());
    Assertions.assertEquals(productDetailResponse.getName(), imageQcRequestDomainEvent.getProductName());
    Assertions.assertEquals(MIN_PRICE, imageQcRequestDomainEvent.getMinPrice());
    Assertions.assertEquals(MAX_PRICE, imageQcRequestDomainEvent.getMaxPrice());
  }

  @Test
  public void publishImageQcEventForEditedImagesEmptyImagesWithNoPriceDetailsTest()  {
    Mockito.when(xProductOutbound.getMinAndMaxOfferPrice(anyString())).thenReturn(new
        MinMaxItemPriceResponse(MIN_PRICE, MAX_PRICE, PRODUCT_SKU));
    ImageQcRequestDomainEvent imageQcRequestDomainEvent =
        productServiceBean.publishImageQcEventForEditedImages(PRODUCT_CODE, new ArrayList<>(), productDetailResponse,false,
            new RestrictedKeywordsByFieldAndActionType(), BUSINESS_PARTNER_CODE);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Assertions.assertEquals(PRODUCT_CODE, imageQcRequestDomainEvent.getProductCode());
    Assertions.assertEquals(0, imageQcRequestDomainEvent.getImages().size());
    Assertions.assertEquals(productDetailResponse.getName(), imageQcRequestDomainEvent.getProductName());
    Assertions.assertNull(imageQcRequestDomainEvent.getMinPrice());
    Assertions.assertNull(imageQcRequestDomainEvent.getMaxPrice());
  }

  @Test
  public void checkImageQcSwitchTest() {
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    ImageQcEnableAndSyncResponse response =
        productServiceBean.getImageQcStatus(STORE_ID, PRODUCT_CODE, StringUtils.EMPTY);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Assertions.assertFalse(response.isEnable());
    Assertions.assertFalse(response.isSync());
  }

  @Test
  public void checkImageQcSwitchCategoryTest() {
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(CATEGORY_CODE);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    ImageQcEnableAndSyncResponse response =
        productServiceBean.getImageQcStatus(STORE_ID, PRODUCT_CODE, CATEGORY_CODE);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    Assertions.assertTrue(response.isEnable());
    Assertions.assertTrue(response.isSync());
  }

  @Test
  public void checkImageQcSwitchMultiCategoryTest() {
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(CATEGORY_CODE.concat(Constants.COMMA).concat(PRODUCT_CODE));
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    ImageQcEnableAndSyncResponse response =
        productServiceBean.getImageQcStatus(STORE_ID, PRODUCT_CODE, CATEGORY_CODE);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    Assertions.assertTrue(response.isEnable());
    Assertions.assertTrue(response.isSync());
  }

  @Test
  public void checkImageQcCategoryDisabledTest() {
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(PRODUCT_CODE);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    ImageQcEnableAndSyncResponse response =
        productServiceBean.getImageQcStatus(STORE_ID, PRODUCT_CODE, CATEGORY_CODE);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    Assertions.assertFalse(response.isEnable());
    Assertions.assertFalse(response.isSync());
  }

  @Test
  public void checkImageQcAsyncTest() {
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemParameterSync.setValue(String.valueOf(false));
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    ImageQcEnableAndSyncResponse response =
        productServiceBean.getImageQcStatus(STORE_ID, PRODUCT_CODE, StringUtils.EMPTY);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    Assertions.assertTrue(response.isEnable());
    Assertions.assertFalse(response.isSync());
  }

  @Test
  public void checkImageQcSwitchTrueTest() {
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    ImageQcEnableAndSyncResponse response =
        productServiceBean.getImageQcStatus(STORE_ID, PRODUCT_CODE, StringUtils.EMPTY);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    Assertions.assertTrue(response.isEnable());
    Assertions.assertTrue(response.isSync());
  }

  @Test
  public void checkImageQcSwitchExceptionTest() {
    doThrow(RuntimeException.class).when(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    ImageQcEnableAndSyncResponse response = productServiceBean.getImageQcStatus(STORE_ID, PRODUCT_CODE, StringUtils.EMPTY);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Assertions.assertFalse(response.isEnable());
    Assertions.assertFalse(response.isSync());
  }

  @Test
  public void processImageQcResponseTest() throws JsonProcessingException {
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          true, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseImageEmptyTest() throws JsonProcessingException {
    imageQcResponseDomainEvent.setImages(new ArrayList<>());
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
            true, null);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
  }

  @Test
  public void processImageQcResponsePredictionsEmptyTest() throws JsonProcessingException {
    imageQcResponseDomainEvent.getImages().get(0).setPredictions(new ArrayList<>());
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
            true, null);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
  }

  @Test
  public void processImageQcResponseBrandPredictionTest() throws Exception {
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(PREDICTION_NAME_4);
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
    verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), null,
            productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseBrandPrediction2Test() throws Exception {
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
    BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
    brandPredictionResponse.setBrand(BRAND);
    brandPredictionResponse.setConfidence(1);
      brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
    verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), null,
            productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
  }

  @Test
  public void processImageQcResponseBrandPredictionTakeDownTest() throws Exception {
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
    BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
    brandPredictionResponse.setBrand(BRAND);
    brandPredictionResponse.setConfidence(70);
    brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
    verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
            productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseBrandPredictionTakeDownTestForTrustedSellers() throws Exception {
    productImagePredictionWaterMark.setRelaxTrustedSeller(true);
    ReflectionTestUtils.setField(productServiceBean, "enable21PlusModel", true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
      .thenReturn(productSystemParameterBrandTakeDownThreshold);
    this.profileResponse.setTrustedSeller(true);
    this.businessPartner.setTrustedSeller(true);
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
    BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
    brandPredictionResponse.setBrand(BRAND);
    brandPredictionResponse.setConfidence(70);
    brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
      .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
        false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
    verify(productRepository).takeDownProductBasedOnBrand(
      new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
        productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseBrandTakeDownPostLiveTest() throws Exception {
    productCollection.setPostLive(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
    when(productRepository.takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
            productCollection.getBusinessPartnerCode(), productCollection.getProductCode()))).thenReturn(true);
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
    BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
    brandPredictionResponse.setBrand(BRAND);
    brandPredictionResponse.setConfidence(70);
    brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
    verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
            productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2 + Constants.COMMA + Constants.SUSPICIOUS_BRAND,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseBrandTakeDownPreLiveTest() throws Exception {
    productCollection.setPostLive(false);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
      .thenReturn(productSystemParameterBrandTakeDownThreshold);
    when(productRepository.takeDownProductBasedOnBrand(
      new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
        productCollection.getBusinessPartnerCode(), DEFAULT_PRODUCT_CODE))).thenReturn(true);
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
    BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
    brandPredictionResponse.setBrand(BRAND);
    brandPredictionResponse.setConfidence(70);
    brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
      .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
        false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
    verify(productRepository).takeDownProductBasedOnBrand(
      new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
        productCollection.getBusinessPartnerCode(), DEFAULT_PRODUCT_CODE));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2 + Constants.COMMA + Constants.SUSPICIOUS_BRAND,
      captorValue.getImageViolations());
  }

  @Test
  public void processImageQcResponseBrandTakeDownPostLive_test() throws Exception {
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
    when(productRepository.takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
            productCollection.getBusinessPartnerCode(), DEFAULT_PRODUCT_CODE))).thenReturn(true);
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
    BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
    brandPredictionResponse.setBrand(BRAND);
    brandPredictionResponse.setConfidence(70);
    brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
    verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
            productCollection.getBusinessPartnerCode(), DEFAULT_PRODUCT_CODE));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2 + Constants.COMMA + Constants.SUSPICIOUS_BRAND,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseSuccessFalseTest() {
    imageQcResponseDomainEvent.setSuccess(false);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
  }

  @Test
  public void processImageQcResponseSendProductToReviewTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseSendProductToReviewAndAutoNeedRevisonTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(10);
    productImagePredictionWaterMark.setConfidenceThreshold(10);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertTrue(response.isAutoNeedRevision());
    Assertions.assertTrue(response.getPredictionTypeSet().contains(PREDICTION_NAME_1));
    Assertions.assertEquals(1, response.getPredictionTypeSet().size());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseSendProductToReviewAndAutoNeedRevisonCompareCategoryTest() throws Exception {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(10);
    productImagePredictionWaterMark.setConfidenceThreshold(10);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    productImagePredictionNsfw.setCompareCategory(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productRepository).getPredictionListByCategoryCode(
        productDetailResponse.getCategoryCodes().get(productDetailResponse.getCategoryCodes().size() - 1));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertTrue(response.isAutoNeedRevision());
    Assertions.assertTrue(response.getPredictionTypeSet().contains(PREDICTION_NAME_1));
    Assertions.assertEquals(1, response.getPredictionTypeSet().size());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseSendProductToReviewAndAutoNeedRevisonCompareCategory2Test() throws Exception {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(10);
    productImagePredictionWaterMark.setId(ID);
    productImagePredictionWaterMark.setConfidenceThreshold(10);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    productImagePredictionNsfw.setCompareCategory(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productRepository.getPredictionListByCategoryCode(
        productDetailResponse.getCategoryCodes().get(productDetailResponse.getCategoryCodes().size() - 1)))
        .thenReturn(Collections.singletonList(new ProductPredictionCategoryMappingResponse(ID)));
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productRepository).getPredictionListByCategoryCode(
        productDetailResponse.getCategoryCodes().get(productDetailResponse.getCategoryCodes().size() - 1));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    Assertions.assertEquals(0, response.getPredictionTypeSet().size());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseSendProductToReviewAndAutoNeedRevison2ndTimeTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(10);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(10);
    productImagePredictionWaterMark.setConfidenceThreshold(10);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    productCollection.setAutoNeedRevision(true);
    productCollection.setPostLive(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    Assertions.assertTrue(response.getPredictionTypeSet().contains(PREDICTION_NAME_2));
    Assertions.assertEquals(1, response.getPredictionTypeSet().size());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseSendProductToReviewTestWithMFDTrue() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setMarkForDelete(true);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseSendProductToReviewPreliveTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponsePostLiveAsyncTest() throws JsonProcessingException {
    productSystemParameterSync.setValue(String.valueOf(false));
    productImagePredictionNsfw.setForceReview(true);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    productCollection.setPostLive(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertFalse(response.isSendProductToReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnEmptyKeywordsTest() throws JsonProcessingException {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
        Collections.singletonList(KEYWORD_ID));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseNotEmptyTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "categoryPredictionEnabled", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
        Collections.singletonList(KEYWORD_ID))).thenReturn(
        Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(1);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
        restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
        Collections.singletonList(KEYWORD_ID));
    verify(productLevel3Helper).getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType);
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseCategoryChangeTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "categoryPredictionEnabled", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryModelPredictionResponse categoryModelPredictionResponse =
      new CategoryModelPredictionResponse();
    categoryModelPredictionResponse.setMismatchCombined(true);
    categoryModelPredictionResponse.setPredictionType(Constants.CATEGORY_MISMATCH_PREDICTION_TYPE);
    imageQcResponseDomainEvent.setCategoryModels(
      Collections.singletonList(categoryModelPredictionResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    categoryRestrictedKeywordResponse.setAction(0);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
      Collections.singletonList(KEYWORD_ID))).thenReturn(
      Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setAction(0);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(0);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
      Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
      restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
      productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
        productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
      Collections.singletonList(KEYWORD_ID));
    verify(productLevel3Helper).getResultantActionType(restrictedKeywordToActionTypeMap,
      Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType);
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseCategoryMismatchFalseTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "categoryPredictionEnabled", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryModelPredictionResponse categoryModelPredictionResponse =
      new CategoryModelPredictionResponse();
    categoryModelPredictionResponse.setMismatchCombined(false);
    categoryModelPredictionResponse.setPredictionType(Constants.CATEGORY_MISMATCH_PREDICTION_TYPE);
    imageQcResponseDomainEvent.setCategoryModels(
      Collections.singletonList(categoryModelPredictionResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    categoryRestrictedKeywordResponse.setAction(0);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
      Collections.singletonList(KEYWORD_ID))).thenReturn(
      Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setAction(0);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(0);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
      Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
      restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
      productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
        productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
      Collections.singletonList(KEYWORD_ID));
    verify(productLevel3Helper).getResultantActionType(restrictedKeywordToActionTypeMap,
      Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType);
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseCategoryMismatchTrueAndTakeDownTest()
    throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest",
      true);
    ReflectionTestUtils.setField(getProductServiceBean(), "categoryPredictionEnabled", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID,
      PREDICTION_NAME_1)).thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID,
      PREDICTION_NAME_2)).thenReturn(productImagePredictionNsfw);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(
      Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryModelPredictionResponse categoryModelPredictionResponse =
      new CategoryModelPredictionResponse();
    categoryModelPredictionResponse.setMismatchCombined(true);
    categoryModelPredictionResponse.setPredictionType(Constants.CATEGORY_MISMATCH_PREDICTION_TYPE);
    imageQcResponseDomainEvent.setCategoryModels(
      Collections.singletonList(categoryModelPredictionResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse =
      new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    categoryRestrictedKeywordResponse.setAction(1);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(
      productCollection.getCategoryCode(), Collections.singletonList(KEYWORD_ID))).thenReturn(
      Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap =
      new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse =
      new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(
      RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setAction(1);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(1);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
      Collections.singletonList(restrictedKeywordsByField),
      restrictedKeywordsByFieldAndActionType)).thenReturn(
      restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
      productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
        productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID,
      PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID,
      PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(
      productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService).findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
      Collections.singletonList(KEYWORD_ID));
    verify(productLevel3Helper).getResultantActionType(restrictedKeywordToActionTypeMap,
      Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType);
    ProductImageQcProcessingResponse captorValue =
      productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(Constants.CATEGORY_MISMATCH, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent),
      captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseCategoryPredictionTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "categoryPredictionEnabled", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryModelPredictionResponse categoryModelPredictionResponse =
      new CategoryModelPredictionResponse();
    categoryModelPredictionResponse.setMismatchCombined(true);
    categoryModelPredictionResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
    imageQcResponseDomainEvent.setCategoryModels(
      Collections.singletonList(categoryModelPredictionResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    categoryRestrictedKeywordResponse.setAction(0);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
      Collections.singletonList(KEYWORD_ID))).thenReturn(
      Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setAction(0);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(0);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
      Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
      restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
      productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
        productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
      Collections.singletonList(KEYWORD_ID));
    verify(productLevel3Helper).getResultantActionType(restrictedKeywordToActionTypeMap,
      Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType);
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "skipDefinitiveAction", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    agpSimpleQuery =
      AgpSimpleQueryResponse.builder().hits(HitsResponse.builder().total(0).max_score(10.0).build())
        .build();
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
        Collections.singletonList(KEYWORD_ID))).thenReturn(
        Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(3);
    restrictedKeywordsByFieldAndActionTypeResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
        restrictedKeywordsByFieldAndActionTypeResponse);
    when(productBusinessPartnerService.findFirstByStoreIdAndProductId(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_ID)).thenReturn(productBusinessPartner);
    Mockito.when(agpQueryFeign.findNumberOfOrder(DEFAULT_PRODUCT_SKU, String.valueOf(0), String.valueOf(0),
      Constants.AGP_ITEM_STATUS)).thenReturn(agpSimpleQuery);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
        Collections.singletonList(KEYWORD_ID));
    verify(productLevel3Helper).getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType);
    verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_ID);
    verify(agpQueryFeign).findNumberOfOrder(DEFAULT_PRODUCT_SKU, String.valueOf(0),
      String.valueOf(0), Constants.AGP_ITEM_STATUS);
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchEmptyResponse() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    keywordRestrictionModelsResponse.setKeywordRecommendations(new ArrayList<>());
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
        Collections.singletonList(KEYWORD_ID))).thenReturn(
        Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(2);
    restrictedKeywordsByFieldAndActionTypeResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
        restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseTest2() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
        Collections.singletonList(KEYWORD_ID))).thenReturn(
        Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(1);
    restrictedKeywordsByFieldAndActionTypeResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
        restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
        Collections.singletonList(KEYWORD_ID));
    verify(productLevel3Helper).getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType);
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseNotDsTest2() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(null);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
        Collections.singletonList(KEYWORD_ID))).thenReturn(
        Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(1);
    restrictedKeywordsByFieldAndActionTypeResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
        restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
        Collections.singletonList(KEYWORD_ID));
    verify(productLevel3Helper).getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType);
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseInValidExceptionTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "restrictedKeywordNotSureEnabled", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    keywordRestrictionModelsResponse.getKeywordRecommendations().get(0)
      .setRecommendation(NOT_SURE_DETECTION);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
        Collections.singletonList(KEYWORD_ID))).thenReturn(
        Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setAction(1);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(1);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
        restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
        Collections.singletonList(KEYWORD_ID));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseTwoImageViolationTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNoImageViolationDsModelSwitchOnResponseInValidException1Test() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "skipDefinitiveAction", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "restrictedKeywordNotSureEnabled", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    keywordRestrictionModelsResponse.getKeywordRecommendations().get(0).setRecommendation(INVALID_DETECTION);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setAction(1);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
        Collections.singletonList(KEYWORD_ID))).thenReturn(
        Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setAction(0);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(0);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(0);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
        Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
        restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
        Collections.singletonList(KEYWORD_ID));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevisionTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertTrue(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevisionSellerSpecificEmptyTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertTrue(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevisionSellerSpecificErrorTest() throws IOException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
    when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
    verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertTrue(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevisionSellerSpecificEnabledRuleNullTest() throws IOException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
    when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
    when(objectMapper.readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class)))
        .thenReturn(mapper.readValue(NEED_REVISION_CONFIG, new TypeReference<List<AutoApprovalRuleDetailsDto>>() {
        }));
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
    verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertTrue(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevisionSellerSpecificFalseTest() throws IOException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productImagePredictionWaterMark.setDisplayName(WATERMARK);
    productSystemParameterEnable.setValue(String.valueOf(true));
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
    when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
    when(objectMapper.readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class)))
        .thenReturn(mapper.readValue(NEED_REVISION_CONFIG, new TypeReference<List<AutoApprovalRuleDetailsDto>>() {
        }));
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
    verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(WATERMARK + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertTrue(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevisionSellerSpecific1Test() throws IOException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productImagePredictionWaterMark.setDisplayName(WATERMARK);
    productSystemParameterEnable.setValue(String.valueOf(true));
    autoApprovalRules.setNeedRevisionEnabled(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
    when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
    when(objectMapper.readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class)))
        .thenReturn(mapper.readValue(NEED_REVISION_CONFIG, new TypeReference<List<AutoApprovalRuleDetailsDto>>() {
        }));
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
    verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(WATERMARK + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevisionSellerSpecificTrueTest() throws IOException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productImagePredictionWaterMark.setDisplayName(WATERMARK);
    productSystemParameterEnable.setValue(String.valueOf(true));
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(71);
    autoApprovalRules.setNeedRevisionEnabled(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
    when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
    when(objectMapper.readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class)))
        .thenReturn(mapper.readValue(NEED_REVISION_CONFIG, new TypeReference<List<AutoApprovalRuleDetailsDto>>() {
        }));
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
    verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(WATERMARK + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertTrue(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevision2ndTimeTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productCollection.setAutoNeedRevision(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevisionMFDTrueTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setMarkForDelete(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseAutoNeedRevisionThresholdTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(90);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseTwoImageViolationMultipleItemsTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    imageCountMap.replace(IMAGE_HASH_CODE_1, 2L);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(75, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseTwoImageViolationImageQcOffTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(false);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(false));
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterEnable);
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertFalse(response.isSendProductToReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseTwoImageViolationCategorySwitchTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(30);
    productImagePredictionWaterMark.setForceReview(true);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemParameterSync.setValue(String.valueOf(false));
    productCollection.setPostLive(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertFalse(response.isSendProductToReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseNewPredictionInResponseTest() {
    productImagePredictionWaterMark.setForceReview(false);
    productImagePredictionWaterMark.setConfidenceThreshold(20);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(1).setPredictionType(PREDICTION_NAME_3);
    imageQcResponseDomainEvent.getImages().get(1).getPredictions().get(1).setPredictionType(PREDICTION_NAME_3);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_3))
        .thenReturn(productImagePredictionNsfw);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_3);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(35, captorValue.getProductPredictionScore());
    Assertions.assertFalse(captorValue.isForceReview());
  }



    @Test
    public void processImageQcResponseTest_forTrustedSellers() throws JsonProcessingException {
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          false, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseBrandPredictionTest_forTrustedSellers() throws Exception {
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
      BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
      brandRestrictedModelsResponse.setPredictionType(PREDICTION_NAME_4);
      imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
      AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
      verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), null,
          productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseBrandPrediction2Test_forTrustedSellers() throws Exception {
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
      BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
      brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
      BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
      brandPredictionResponse.setBrand(BRAND);
      brandPredictionResponse.setConfidence(1);
      brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
      imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
      AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
      verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), null,
          productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore(), 0);
    }

  @Test
  public void processImageQcResponseCategoryTakeDownTest_forTrustedSellers() throws Exception {
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
      .thenReturn(productSystemParameterBrandTakeDownThreshold);
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
    BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
    brandPredictionResponse.setBrand(BRAND);
    brandPredictionResponse.setConfidence(1);
    brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
      .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
        true, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
    verify(productRepository).takeDownProductBasedOnBrand(
      new ProductBrandValidationRequest(productCollection.getBrandCode(), null,
        productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    Assertions.assertNull(captorValue.getPredictedBrand());
  }

    @Test
    public void processImageQcResponseBrandPredictionTakeDownTest_forTrustedSellers() throws Exception {
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
      BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
      brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
      BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
      brandPredictionResponse.setBrand(BRAND);
      brandPredictionResponse.setConfidence(70);
      brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
      imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
      AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
      verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
          productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseBrandTakeDownPreLiveTest_forTrustedSellers() throws Exception {
    productCollection.setPostLive(true);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
      when(productRepository.takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
          productCollection.getBusinessPartnerCode(), DEFAULT_PRODUCT_CODE))).thenReturn(true);
      BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
      brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
      BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
      brandPredictionResponse.setBrand(BRAND);
      brandPredictionResponse.setConfidence(70);
      brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
      imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
      AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
      verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
          productCollection.getBusinessPartnerCode(), DEFAULT_PRODUCT_CODE));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2 + Constants.COMMA + Constants.SUSPICIOUS_BRAND,
        captorValue.getImageViolations());
      Assertions.assertTrue(captorValue.isForceReview());
      Assertions.assertTrue(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseBrandTakeDownPostLiveTest_forTrustedSellers() throws Exception {
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      this.profileResponse.setTrustedSeller(true);
      this.businessPartner.setTrustedSeller(true);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD))
        .thenReturn(productSystemParameterBrandTakeDownThreshold);
      when(productRepository.takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
          productCollection.getBusinessPartnerCode(), productCollection.getProductCode()))).thenReturn(true);
      BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
      brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
      BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
      brandPredictionResponse.setBrand(BRAND);
      brandPredictionResponse.setConfidence(70);
      brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
      imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
      productCollection.setPostLive(true);
      AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
      verify(productRepository).takeDownProductBasedOnBrand(
        new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
          productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2 + Constants.COMMA + Constants.SUSPICIOUS_BRAND,
        captorValue.getImageViolations());
      Assertions.assertTrue(captorValue.isForceReview());
      Assertions.assertTrue(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseSuccessFalseTest_forTrustedSellers() {
      imageQcResponseDomainEvent.setSuccess(false);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
    }

    @Test
    public void processImageQcResponseSendProductToReviewTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      this.profileResponse.setTrustedSeller(true);
      this.businessPartner.setTrustedSeller(true);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      productCollection.setPostLive(true);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseSendProductToReviewAndAutoNeedRevisonTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(10);
      productImagePredictionWaterMark.setConfidenceThreshold(10);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertTrue(response.getPredictionTypeSet().contains(PREDICTION_NAME_1));
      Assertions.assertEquals(1, response.getPredictionTypeSet().size());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseSendProductToReviewAndAutoNeedRevisonCompareCategoryTest_forTrustedSellers() throws Exception {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(10);
      productImagePredictionWaterMark.setConfidenceThreshold(10);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
      productImagePredictionNsfw.setCompareCategory(true);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(productRepository).getPredictionListByCategoryCode(
        productDetailResponse.getCategoryCodes().get(productDetailResponse.getCategoryCodes().size() - 1));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertTrue(response.getPredictionTypeSet().contains(PREDICTION_NAME_1));
      Assertions.assertEquals(1, response.getPredictionTypeSet().size());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseSendProductToReviewAndAutoNeedRevisonCompareCategory2Test_forTrustedSellers() throws Exception {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(10);
      productImagePredictionWaterMark.setId(ID);
      productImagePredictionWaterMark.setConfidenceThreshold(10);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
      productImagePredictionNsfw.setCompareCategory(true);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productRepository.getPredictionListByCategoryCode(
        productDetailResponse.getCategoryCodes().get(productDetailResponse.getCategoryCodes().size() - 1)))
        .thenReturn(Collections.singletonList(new ProductPredictionCategoryMappingResponse(ID)));
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(productRepository).getPredictionListByCategoryCode(
        productDetailResponse.getCategoryCodes().get(productDetailResponse.getCategoryCodes().size() - 1));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(0, response.getPredictionTypeSet().size());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseSendProductToReviewAndAutoNeedRevison2ndTimeTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(10);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(10);
      productImagePredictionWaterMark.setConfidenceThreshold(10);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
      productCollection.setAutoNeedRevision(true);
      productCollection.setPostLive(true);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertTrue(response.getPredictionTypeSet().contains(PREDICTION_NAME_2));
      Assertions.assertEquals(1, response.getPredictionTypeSet().size());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

  @Test
  public void processImageQcResponseSendProductToReviewAndAutoNeedRevisonWithBrand_forTrustedSellers()
    throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "enable21PlusModel", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(10);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(10);
    productImagePredictionWaterMark.setConfidenceThreshold(10);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    productCollection.setAutoNeedRevision(true);
    productCollection.setPostLive(true);
    when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
      SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD)).thenReturn(
      productSystemParameterBrandTakeDownThreshold);
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(Constants.PROTECTED_BRAND_PREDICTION_TYPE);
    BrandPredictionResponse brandPredictionResponse = new BrandPredictionResponse();
    brandPredictionResponse.setBrand(BRAND);
    brandPredictionResponse.setConfidence(70);
    brandRestrictedModelsResponse.setPredictions(Collections.singletonList(brandPredictionResponse));
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    productCollection.setPostLive(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
      .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
      .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
      .thenReturn(productSystemCategoryParameter);
    AutoNeedRevisionAndForceReviewResponse response =
      productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
        productCollection, productDetailResponse, true, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    verify(productRepository).takeDownProductBasedOnBrand(
      new ProductBrandValidationRequest(productCollection.getBrandCode(), BRAND,
        productCollection.getBusinessPartnerCode(), productCollection.getProductCode()));
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
      captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    Assertions.assertTrue(response.getPredictionTypeSet().contains(PREDICTION_NAME_2));
    Assertions.assertEquals(1, response.getPredictionTypeSet().size());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.BRAND_TAKE_DOWN_THRESHOLD);
  }

    @Test
    public void processImageQcResponseSendProductToReviewTestWithMFDTrue_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setMarkForDelete(true);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseSendProductToReviewPreliveTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponsePostLiveAsyncTest_forTrustedSellers() throws JsonProcessingException {
      productSystemParameterSync.setValue(String.valueOf(false));
      productImagePredictionNsfw.setForceReview(true);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
      productCollection.setPostLive(true);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(30, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isSendProductToReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseNoImageViolationTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(90);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(0, captorValue.getProductPredictionScore());
      Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseTwoImageViolationTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      productCollection.setPostLive(true);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevisionTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevisionSellerSpecificEmptyTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevisionSellerSpecificErrorTest_forTrustedSellers() throws IOException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
      when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
      verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevisionSellerSpecificEnabledRuleNullTest_forTrustedSellers() throws IOException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
      when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
      when(objectMapper.readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class)))
        .thenReturn(mapper.readValue(NEED_REVISION_CONFIG, new TypeReference<List<AutoApprovalRuleDetailsDto>>() {
        }));
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
      verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevisionSellerSpecificFalseTest_forTrustedSellers() throws IOException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productImagePredictionWaterMark.setDisplayName(WATERMARK);
      productSystemParameterEnable.setValue(String.valueOf(true));
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
      when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
      when(objectMapper.readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class)))
        .thenReturn(mapper.readValue(NEED_REVISION_CONFIG, new TypeReference<List<AutoApprovalRuleDetailsDto>>() {
        }));
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
      verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(WATERMARK + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevisionSellerSpecific1Test_forTrustedSellers() throws IOException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productImagePredictionWaterMark.setDisplayName(WATERMARK);
      productSystemParameterEnable.setValue(String.valueOf(true));
      autoApprovalRules.setNeedRevisionEnabled(true);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
      when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
      when(objectMapper.readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class)))
        .thenReturn(mapper.readValue(NEED_REVISION_CONFIG, new TypeReference<List<AutoApprovalRuleDetailsDto>>() {
        }));
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
      verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(WATERMARK + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevisionSellerSpecificTrueTest_forTrustedSellers() throws IOException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productImagePredictionWaterMark.setDisplayName(WATERMARK);
      productSystemParameterEnable.setValue(String.valueOf(true));
      imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(71);
      autoApprovalRules.setNeedRevisionEnabled(true);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productAnalyticsOutbound.getSellerDetail(productCollection.getBusinessPartnerCode()))
        .thenReturn(sellerDetailResponse);
      when(autoApprovalService.findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS)).thenReturn(autoApprovalRules);
      when(objectMapper.readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class)))
        .thenReturn(mapper.readValue(NEED_REVISION_CONFIG, new TypeReference<List<AutoApprovalRuleDetailsDto>>() {
        }));
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      verify(autoApprovalService).findByStoreIdAndRuleName(STORE_ID, OFFICIAL_SELLERS);
      verify(objectMapper).readValue(eq(autoApprovalRules.getNeedRevisionConfig()), Mockito.any(TypeReference.class));
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(WATERMARK + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevision2ndTimeTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productCollection.setAutoNeedRevision(true);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevisionMFDTrueTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(31);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setMarkForDelete(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      productCollection.setPostLive(true);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseAutoNeedRevisionThresholdTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setNeedRevisionEnabled(true);
      productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(90);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      productCollection.setPostLive(true);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertFalse(response.isAutoNeedRevision());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseTwoImageViolationMultipleItemsTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      imageCountMap.replace(IMAGE_HASH_CODE_1, 2L);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      productCollection.setPostLive(true);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(75, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseTwoImageViolationImageQcOffTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(false);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(false));
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterEnable);
      productCollection.setPostLive(true);
      AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
          true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isSendProductToReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseTwoImageViolationCategorySwitchTest_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productImagePredictionNsfw.setConfidenceThreshold(30);
      productImagePredictionWaterMark.setForceReview(true);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemParameterSync.setValue(String.valueOf(false));
      productCollection.setPostLive(true);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(50, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isSendProductToReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

    @Test
    public void processImageQcResponseNewPredictionInResponseTest_forTrustedSellers() {
      productImagePredictionWaterMark.setForceReview(false);
      productImagePredictionWaterMark.setConfidenceThreshold(20);
      imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(1).setPredictionType(PREDICTION_NAME_3);
      imageQcResponseDomainEvent.getImages().get(1).getPredictions().get(1).setPredictionType(PREDICTION_NAME_3);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_3))
        .thenReturn(productImagePredictionNsfw);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_3);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(35, captorValue.getProductPredictionScore());
      Assertions.assertFalse(captorValue.isForceReview());
    }

    @Test
    public void processImageQcResponseTextPrediction1Test_forTrustedSellers() throws JsonProcessingException {
      productImagePredictionNsfw.setForceReview(true);
      productSystemParameterEnable.setValue(String.valueOf(true));
      productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
      when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_TEXT_NAME)).thenReturn(
          textGoogleRestrictedKeyword);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
      when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
      RestrictionModelsResponse restrictionModelsResponse = new RestrictionModelsResponse();
      restrictionModelsResponse.setPredictionType(PREDICTION_TEXT_NAME);
      ImageQcPredictionResponse imageQcPredictionResponse = new ImageQcPredictionResponse();
      imageQcPredictionResponse.setConfidence(70);
      restrictionModelsResponse.setPredictions(Collections.singletonList(imageQcPredictionResponse));
      imageQcResponseDomainEvent.setRestrictionModels(Collections.singletonList(restrictionModelsResponse));
      productCollection.setPostLive(true);
      AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
          productCollection, productDetailResponse, true, null);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
      verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_TEXT_NAME);
      verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
      verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
      verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
      ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
      Assertions.assertEquals("google restricted", captorValue.getTextViolations());
      Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
      Assertions.assertEquals(31, captorValue.getProductPredictionScore());
      Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
      Assertions.assertFalse(captorValue.isForceReview());
      Assertions.assertFalse(response.isForceReview());
      Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
    }

  @Test
  public void publishImageQcProcessedResponseEventTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
      imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Arrays.asList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            new AutoNeedRevisionAndForceReviewResponse(), profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getTextViolations());
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventSkipAllActionsTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(sellerDetailResponse);
    AutoNeedRevisionAndForceReviewResponse autoNeedRevisionAndForceReviewResponse =
        new AutoNeedRevisionAndForceReviewResponse();
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    autoNeedRevisionAndForceReviewResponse.setRestrictedKeywordsByFieldAndActionType(
        restrictedKeywordsByFieldAndActionType);
    ImageQcProcessedResponseDomainEvent response =
        productServiceBean.publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection,
            productDetailResponse, autoNeedRevisionAndForceReviewResponse, profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getTextViolations());
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventSkipAllActionsBrandTakeDownTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(sellerDetailResponse);
    AutoNeedRevisionAndForceReviewResponse autoNeedRevisionAndForceReviewResponse =
        new AutoNeedRevisionAndForceReviewResponse();
    autoNeedRevisionAndForceReviewResponse.setBrandTakeDown(true);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    autoNeedRevisionAndForceReviewResponse.setRestrictedKeywordsByFieldAndActionType(
        restrictedKeywordsByFieldAndActionType);
    ImageQcProcessedResponseDomainEvent response =
        productServiceBean.publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection,
            productDetailResponse, autoNeedRevisionAndForceReviewResponse, profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getTextViolations());
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventSkipAllActionsCategoryTakeDownTest()
    throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(true);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID,
      PRODUCT_CODE)).thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(
      ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(),
      eq(ImageQcResponseDomainEvent.class))).thenReturn(imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID,
      PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(
      productCollection.getCategoryCode())).thenReturn(Arrays.asList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
      .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(
      Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
      .thenReturn(sellerDetailResponse);
    AutoNeedRevisionAndForceReviewResponse autoNeedRevisionAndForceReviewResponse =
      new AutoNeedRevisionAndForceReviewResponse();
    autoNeedRevisionAndForceReviewResponse.setCategoryTakeDown(true);
    autoNeedRevisionAndForceReviewResponse.setBrandTakeDown(true);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    autoNeedRevisionAndForceReviewResponse.setRestrictedKeywordsByFieldAndActionType(
      restrictedKeywordsByFieldAndActionType);
    profileResponse.setTrustedSeller(true);
    ImageQcProcessedResponseDomainEvent response =
      productServiceBean.publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE,
        productCollection, productDetailResponse, autoNeedRevisionAndForceReviewResponse,
        profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService)
      .findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
      .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
        addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertTrue(
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .getImageQcProcessedResponseDomainEvent().getTextViolations());
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventSkipAllActionsBrandTakeDownFalseTest()
    throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(true);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID,
      PRODUCT_CODE)).thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(
      ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(),
      eq(ImageQcResponseDomainEvent.class))).thenReturn(imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID,
      PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(
      productCollection.getCategoryCode())).thenReturn(Arrays.asList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
      .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(
      Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
      .thenReturn(sellerDetailResponse);
    AutoNeedRevisionAndForceReviewResponse autoNeedRevisionAndForceReviewResponse =
      new AutoNeedRevisionAndForceReviewResponse();
    autoNeedRevisionAndForceReviewResponse.setBrandTakeDown(false);
    autoNeedRevisionAndForceReviewResponse.setCategoryTakeDown(true);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    autoNeedRevisionAndForceReviewResponse.setRestrictedKeywordsByFieldAndActionType(
      restrictedKeywordsByFieldAndActionType);
    profileResponse.setTrustedSeller(true);
    ImageQcProcessedResponseDomainEvent response =
      productServiceBean.publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE,
        productCollection, productDetailResponse, autoNeedRevisionAndForceReviewResponse,
        profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService)
      .findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
      .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
        addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertTrue(
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .getImageQcProcessedResponseDomainEvent().getTextViolations());
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }


  @Test
  public void publishImageQcProcessedResponseEventAutoRejectActionTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(sellerDetailResponse);
    AutoNeedRevisionAndForceReviewResponse autoNeedRevisionAndForceReviewResponse =
        new AutoNeedRevisionAndForceReviewResponse();
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(3);
    autoNeedRevisionAndForceReviewResponse.setRestrictedKeywordsByFieldAndActionType(
        restrictedKeywordsByFieldAndActionType);
    ImageQcProcessedResponseDomainEvent response =
        productServiceBean.publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection,
            productDetailResponse, autoNeedRevisionAndForceReviewResponse, profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaProducer).send(DomainEventName.ADD_PRODUCT_TO_PDT_RETRY, PRODUCT_CODE,
        new ProductActionRetryEvent(Constants.DEFAULT_STORE_ID, PRODUCT_CODE, Constants.PDT_AUTO_REJECTION,
            autoNeedRevisionAndForceReviewResponse.getRestrictedKeywordsByFieldAndActionType().getMessage()));
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getTextViolations());

    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventCategoryChangeTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(sellerDetailResponse);
    AutoNeedRevisionAndForceReviewResponse autoNeedRevisionAndForceReviewResponse =
        new AutoNeedRevisionAndForceReviewResponse();
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(0);
    restrictedKeywordsByFieldAndActionType.setDestinationCategory(CATEGORY_CODE);
    autoNeedRevisionAndForceReviewResponse.setRestrictedKeywordsByFieldAndActionType(
        restrictedKeywordsByFieldAndActionType);
    ImageQcProcessedResponseDomainEvent response =
        productServiceBean.publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection,
            productDetailResponse, autoNeedRevisionAndForceReviewResponse, profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getTextViolations());
    Assertions.assertEquals(CATEGORY_CODE,
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getCategoryCode());
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventContentNeedRevisionTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(sellerDetailResponse);
    AutoNeedRevisionAndForceReviewResponse autoNeedRevisionAndForceReviewResponse =
        new AutoNeedRevisionAndForceReviewResponse();
    autoNeedRevisionAndForceReviewResponse.setAutoNeedRevision(true);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
        new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(2);
    restrictedKeywordsByFieldAndActionType.setMessage(CATEGORY_CODE);
    autoNeedRevisionAndForceReviewResponse.setRestrictedKeywordsByFieldAndActionType(
        restrictedKeywordsByFieldAndActionType);
    ImageQcProcessedResponseDomainEvent response =
        productServiceBean.publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection,
            productDetailResponse, autoNeedRevisionAndForceReviewResponse, profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getTextViolations());
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .getImageQcProcessedResponseDomainEvent().getAutoNeedRevisionAndForceReviewResponse().isContentNeedRevision());
    Assertions.assertEquals(CATEGORY_CODE,
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getAutoNeedRevisionAndForceReviewResponse().getNotes());
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventTestWithViolations() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setImageViolations(PREDICTION_DISPLAY_NAME_1);
    productImageQcProcessingResponse.setForceReview(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
      .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
      imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    ImageQcProcessedResponseDomainEvent response = productServiceBean
      .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
        new AutoNeedRevisionAndForceReviewResponse(), profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
      .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
        addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
      .isOnlyImageQcDataUpdate());
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertFalse(response.isForceReview());
  }

  @Test
  public void publishImageQcProcessedResponseEventTest_forTrsutedSeller() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(true);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
      .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
      imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    profileResponse.setTrustedSeller(true);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
      .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
        new AutoNeedRevisionAndForceReviewResponse(), profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
      .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
        addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
      .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .getImageQcProcessedResponseDomainEvent().getTextViolations());
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventTestForTrsutedSellerAndBrandTakeDown() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(true);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    profileResponse.setTrustedSeller(true);
    AutoNeedRevisionAndForceReviewResponse autoNeedRevisionAndForceReviewResponse =
        new AutoNeedRevisionAndForceReviewResponse();
    autoNeedRevisionAndForceReviewResponse.setBrandTakeDown(true);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            autoNeedRevisionAndForceReviewResponse, profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getTextViolations());
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventTestForTrsutedSellerAndBrandTakeDown1() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setTextViolations(ACTIVE_PREDICTIONS.get(0));
    productImageQcProcessingResponse.setForceReview(true);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    profileResponse.setTrustedSeller(true);
    AutoNeedRevisionAndForceReviewResponse autoNeedRevisionAndForceReviewResponse =
        new AutoNeedRevisionAndForceReviewResponse();
    autoNeedRevisionAndForceReviewResponse.setBrandTakeDown(false);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            autoNeedRevisionAndForceReviewResponse, profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
        .isOnlyImageQcDataUpdate());
    Assertions.assertEquals(ACTIVE_PREDICTIONS.get(0),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
            .getImageQcProcessedResponseDomainEvent().getTextViolations());
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventTest_forTrsutedSellerWithRestrictedKeyword() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productImageQcProcessingResponse.setForceReview(false);
    this.productCollection.setRestrictedKeywordsPresent(true);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
      .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
      imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Arrays.asList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    profileResponse.setTrustedSeller(true);
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
      .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
        new AutoNeedRevisionAndForceReviewResponse(), profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
      .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(PRODUCT_CODE),
        addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Assertions.assertTrue(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent()
      .isOnlyImageQcDataUpdate());
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
  }


  @Test
  public void processImageQcResponseTextPredictionTest() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_TEXT_NAME))
        .thenReturn(textGoogleRestrictedKeyword);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    RestrictionModelsResponse restrictionModelsResponse = new RestrictionModelsResponse();
    restrictionModelsResponse.setPredictionType(PREDICTION_TEXT_NAME);
    ImageQcPredictionResponse imageQcPredictionResponse = new ImageQcPredictionResponse();
    imageQcPredictionResponse.setConfidence(70);
    restrictionModelsResponse.setPredictions(Collections.singletonList(imageQcPredictionResponse));
    imageQcResponseDomainEvent.setRestrictionModels(Collections.singletonList(restrictionModelsResponse));
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_TEXT_NAME);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(31, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertEquals(PREDICTION_TEXT_DISPLAY_NAME, captorValue.getTextViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseTextPredictionTest_productImagePredictionDirtyCheckingFixEnabled()
      throws JsonProcessingException {
    ReflectionTestUtils.setField(productServiceBean, "productImagePredictionDirtyCheckingFixEnabled", true);
    productImagePredictionNsfw.setForceReview(true);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_TEXT_NAME))
        .thenReturn(textGoogleRestrictedKeyword);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    RestrictionModelsResponse restrictionModelsResponse = new RestrictionModelsResponse();
    restrictionModelsResponse.setPredictionType(PREDICTION_TEXT_NAME);
    ImageQcPredictionResponse imageQcPredictionResponse = new ImageQcPredictionResponse();
    imageQcPredictionResponse.setConfidence(70);
    restrictionModelsResponse.setPredictions(Collections.singletonList(imageQcPredictionResponse));
    imageQcResponseDomainEvent.setRestrictionModels(Collections.singletonList(restrictionModelsResponse));
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_TEXT_NAME);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(31, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertEquals(PREDICTION_TEXT_DISPLAY_NAME, captorValue.getTextViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseTextPrediction2Test() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_TEXT_NAME))
        .thenReturn(textGoogleRestrictedKeyword);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    RestrictionModelsResponse restrictionModelsResponse = new RestrictionModelsResponse();
    restrictionModelsResponse.setPredictionType(PREDICTION_TEXT_NAME);
    ImageQcPredictionResponse imageQcPredictionResponse = new ImageQcPredictionResponse();
    imageQcPredictionResponse.setConfidence(49);
    restrictionModelsResponse.setPredictions(Collections.singletonList(imageQcPredictionResponse));
    imageQcResponseDomainEvent.setRestrictionModels(Collections.singletonList(restrictionModelsResponse));
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_TEXT_NAME);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void processImageQcResponseTextPrediction1Test() throws JsonProcessingException {
    productImagePredictionNsfw.setForceReview(true);
    productSystemParameterEnable.setValue(String.valueOf(true));
    productSystemCategoryParameter.setValue(SystemParameterConstants.CATEGORY_CODE_ALL);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    when(productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    RestrictionModelsResponse restrictionModelsResponse = new RestrictionModelsResponse();
    restrictionModelsResponse.setPredictionType(PREDICTION_TEXT_NAME);
    ImageQcPredictionResponse imageQcPredictionResponse = new ImageQcPredictionResponse();
    imageQcPredictionResponse.setConfidence(70);
    restrictionModelsResponse.setPredictions(Collections.singletonList(imageQcPredictionResponse));
    imageQcResponseDomainEvent.setRestrictionModels(Collections.singletonList(restrictionModelsResponse));
    productCollection.setPostLive(true);
    AutoNeedRevisionAndForceReviewResponse response =
        productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
            productCollection, productDetailResponse, false, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_TEXT_NAME);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void publishImageQcProcessedResponseEventNeedRevisionTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(true);
    productCollection.setNeedRevision(true);
    productCollection.setEdited(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode()))
        .thenReturn(Collections.singletonList(categoryResponse));
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            new AutoNeedRevisionAndForceReviewResponse(), profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
    Assertions.assertEquals(1, autoApprovalsDetailDtoArgumentCaptor.getValue().getImageQcConfidenceDetails().size());
  }

  @Test
  public void publishImageQcProcessedResponseEventNeedRevisionEditedTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productCollection.setNeedRevision(true);
    productCollection.setEdited(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode()))
        .thenReturn(Collections.singletonList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(sellerDetailResponse);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            new AutoNeedRevisionAndForceReviewResponse(), profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture());
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
    Assertions.assertEquals(1, autoApprovalsDetailDtoArgumentCaptor.getValue().getImageQcConfidenceDetails().size());
  }

  @Test
  public void publishImageQcProcessedResponseEventNeedRevisionEditedImagQcMFDTrueTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    productCollection.setNeedRevision(true);
    productCollection.setEdited(false);
    imageQcResponseDomainEvent.getImages().get(0).setMarkForDelete(true);
    imageQcResponseDomainEvent.getImages().get(1).setMarkForDelete(true);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode()))
        .thenReturn(Collections.singletonList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            new AutoNeedRevisionAndForceReviewResponse(), profileResponse, imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture());
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertEquals(10, response.getProductPredictionScore());
    Assertions.assertEquals(0, autoApprovalsDetailDtoArgumentCaptor.getValue().getImageQcConfidenceDetails().size());
  }

  @Test
  public void publishImageQcProcessedResponseEventAutoNeedRevisionTest() throws Exception {
    productCollection.setAutoNeedRevision(true);
    productDetailResponse.getImages().get(0).setEdited(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class)))
        .thenReturn(imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode()))
        .thenReturn(Collections.singletonList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class)))
        .thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            new AutoNeedRevisionAndForceReviewResponse(true, false, false, null), profileResponse,
            imageQcResponseDomainEvent);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertNull(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getImageQcProcessedResponseDomainEvent()
        .getAutoNeedRevisionAndForceReviewResponse());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void publishImageQcProcessedResponseEventAutoNeedRevision2Test() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(productImagePredictionService.getListOfActivePredictionTypes(STORE_ID)).thenReturn(ACTIVE_PREDICTIONS);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class)))
        .thenReturn(imageQcResponseDomainEvent);
    when(this.productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode()))
        .thenReturn(Collections.singletonList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class)))
        .thenReturn(AutoApprovalType.CONTENT_AND_IMAGE);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    ImageQcProcessedResponseDomainEvent response = productServiceBean
        .publishImageQcProcessedResponseEvent(STORE_ID, PRODUCT_CODE, productCollection, productDetailResponse,
            new AutoNeedRevisionAndForceReviewResponse(true, false, false, null), profileResponse,
            imageQcResponseDomainEvent);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImagePredictionService).getListOfActivePredictionTypes(STORE_ID);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.any(),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1, response.getImageViolations());
    Assertions.assertEquals(IMAGE_PREDICTION_RESPONSE_1, response.getImageQcResponse());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertNotNull(addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getImageQcProcessedResponseDomainEvent()
        .getAutoNeedRevisionAndForceReviewResponse());
    Assertions.assertEquals(10, response.getProductPredictionScore());
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureWithProductStatusSwitch() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "ranchIntegrationEnabled", true);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    productBusinessPartner.getProductItemBusinessPartners().stream()
        .forEach(productItemBusinessPartner1 -> productItemBusinessPartner1.setDistribution(true));
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID);
    Mockito.verify(productPublisherService)
        .publishProductStatusDomainEvent(productStatusDomainEventArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE, productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertEquals(productCollectionArgumentCaptor.getValue().isImageResized(), true);
    Assertions.assertEquals(2, productStatusDomainEventArgumentCaptor.getValue().getProduct().getProductItems().size());
    Assertions.assertTrue(status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureWithProductStatusSwitch2() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "ranchIntegrationEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    productBusinessPartner.getProductItemBusinessPartners().stream()
        .forEach(productItemBusinessPartner1 -> productItemBusinessPartner1.setDistribution(true));
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID);
    Mockito.verify(productPublisherService)
        .publishProductStatusDomainEvent(productStatusDomainEventArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE, productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertEquals(productCollectionArgumentCaptor.getValue().isImageResized(), true);
    Assertions.assertEquals(2, productStatusDomainEventArgumentCaptor.getValue().getProduct().getProductItems().size());
    Assertions.assertTrue(status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureWithProductStatusSwitch3() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "ranchIntegrationEnabled", true);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID);
    Mockito.verify(productPublisherService)
        .publishProductStatusDomainEvent(productStatusDomainEventArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE, productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertEquals(productCollectionArgumentCaptor.getValue().isImageResized(), true);
    Assertions.assertEquals(2, productStatusDomainEventArgumentCaptor.getValue().getProduct().getProductItems().size());
    Assertions.assertTrue(status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingDistributionProductWithProductStatusSwitch() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "ranchIntegrationEnabled", true);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    productBusinessPartner.getProductItemBusinessPartners().get(0).setDistribution(true);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID);
    Mockito.verify(productPublisherService)
        .publishProductStatusDomainEvent(productStatusDomainEventArgumentCaptor.capture());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE, productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertEquals(productCollectionArgumentCaptor.getValue().isImageResized(), true);
    Assertions.assertEquals(2, productStatusDomainEventArgumentCaptor.getValue().getProduct().getProductItems().size());
    Assertions.assertTrue(status);
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailureWithProductStatusSwitchWithInternalBPCode() throws Exception {
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    productCollection.setBusinessPartnerCode("INTERNAL");
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, DEFAULT_PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(productPublisherService)
        .publishProductStatusDomainEvent(productStatusDomainEventArgumentCaptor.capture());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE, productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isImageResized());
    Assertions.assertEquals(2, productStatusDomainEventArgumentCaptor.getValue().getProduct().getProductItems().size());
    Assertions.assertNull(
        productStatusDomainEventArgumentCaptor.getValue().getProduct().getProductItems().get(0).getProductItemSku());
    Assertions.assertTrue(status);
  }

  @Test
  public void isForceReviewTest() {
    productImageQcProcessingResponse.setForceReview(true);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    boolean response = productServiceBean.isForceReview(STORE_ID, PRODUCT_CODE);
    verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    assertTrue(response);
  }

  @Test
  public void checkIfProductWasTakeDownNullTest() throws Exception {
    productServiceBean.checkIfProductWasTakeDown(getProductDetailResponse(), PRODUCT_ID);
    verify(productImagePredictionService)
        .findProductImagePredictionResponseByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
  }

  @Test
  public void checkIfProductWasTakeDownTest() throws Exception {
    when(productImagePredictionService
        .findProductImagePredictionResponseByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(imageQcProcessedResponse);
    when(productBusinessPartnerService.getAllItemSkusViewConfigByProductId(PRODUCT_ID)).thenReturn(
        Collections.singletonList(itemFlagDetails));
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(Constants.DEFAULT_STORE_ID, PRODUCT_ID)).thenReturn(Arrays.asList(productBusinessPartner));
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    productServiceBean.checkIfProductWasTakeDown(getProductDetailResponse(), PRODUCT_ID);
    verify(productImagePredictionService)
        .findProductImagePredictionResponseByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    verify(xProductOutbound)
        .updateItemViewConfigAndForceReview(eq(false), itemViewConfigAndItemSkuListRequestCaptor.capture(), eq(false));
    verify(productBusinessPartnerService).getAllItemSkusViewConfigByProductId(PRODUCT_ID);
    verify(productBusinessPartnerRepository).findByStoreIdAndProductId(Constants.DEFAULT_STORE_ID, PRODUCT_ID);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    Assertions.assertEquals(ITEM_SKU, itemViewConfigAndItemSkuListRequestCaptor.getValue().get(0).getItemSku());
    Assertions.assertTrue(itemViewConfigAndItemSkuListRequestCaptor.getValue().get(0).isBuyable());
    Assertions.assertTrue(itemViewConfigAndItemSkuListRequestCaptor.getValue().get(0).isDiscoverable());
  }

  @Test
  public void checkIfProductWasTakeDown_cncSwitchOnTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "cncForWarehouseFeatureSwitch", true);
    when(productImagePredictionService
        .findProductImagePredictionResponseByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(imageQcProcessedResponse);
    when(productBusinessPartnerService.getAllItemSkusViewConfigByProductId(PRODUCT_ID)).thenReturn(
        Collections.singletonList(itemFlagDetails));
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(Constants.DEFAULT_STORE_ID, PRODUCT_ID)).thenReturn(Arrays.asList(productBusinessPartner));
    when(productBusinessPartnerRepository.save(productBusinessPartnerArgumentCaptor.capture())).thenReturn(productBusinessPartner);
    productServiceBean.checkIfProductWasTakeDown(getProductDetailResponse(), PRODUCT_ID);
    verify(productImagePredictionService)
        .findProductImagePredictionResponseByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    verify(xProductOutbound)
        .updateItemViewConfigAndForceReview(eq(false), itemViewConfigAndItemSkuListRequestCaptor.capture(), eq(false));
    verify(productBusinessPartnerService).getAllItemSkusViewConfigByProductId(PRODUCT_ID);
    verify(productBusinessPartnerRepository).findByStoreIdAndProductId(Constants.DEFAULT_STORE_ID, PRODUCT_ID);
    verify(productBusinessPartnerRepository).save(productBusinessPartnerArgumentCaptor.getValue());
    Assertions.assertEquals(ITEM_SKU, itemViewConfigAndItemSkuListRequestCaptor.getValue().get(0).getItemSku());
    Assertions.assertEquals(2, itemViewConfigAndItemSkuListRequestCaptor.getValue().size());
    Assertions.assertTrue(itemViewConfigAndItemSkuListRequestCaptor.getValue().get(0).isBuyable());
    Assertions.assertTrue(itemViewConfigAndItemSkuListRequestCaptor.getValue().get(0).isDiscoverable());
    Assertions.assertEquals(Constants.DEFAULT, itemViewConfigAndItemSkuListRequestCaptor.getValue().get(0).getChannel());
    Assertions.assertFalse(itemViewConfigAndItemSkuListRequestCaptor.getValue().get(1).isBuyable());
    Assertions.assertFalse(itemViewConfigAndItemSkuListRequestCaptor.getValue().get(1).isDiscoverable());
    Assertions.assertEquals(Constants.CNC_CHANNEL, itemViewConfigAndItemSkuListRequestCaptor.getValue().get(1).getChannel());
  }

  @Test
  public void updateImagePathsAndFlagAfterResizingImageFailure_imageQcEnableAndSyncResponseEnabled() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enablePriceUpdateInImageQcRequest", true);
    productSystemParameterEnable.setValue(String.valueOf(Boolean.TRUE));
    productSystemParameterSync.setValue(String.valueOf(Boolean.FALSE));
    List<ProductBusinessPartner> bp =new ArrayList<>();
    ProductBusinessPartner businessPartner1 = new ProductBusinessPartner();
    businessPartner1.setProductId(PRODUCT_ID);
    businessPartner1.setId(ID);
    businessPartner1.setBusinessPartnerId(BUSINESS_PARTNER_ID);
    bp.add(businessPartner1);
    List<ProductItemBusinessPartner> productItemBusinessPartnerList = new ArrayList<>();
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setSalePrice(55.44);
    productItemBusinessPartner1.setId(ID);
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner2.setSalePrice(20.44);
    productItemBusinessPartnerList.addAll(Arrays.asList(
        productItemBusinessPartner1,productItemBusinessPartner2));
    Mockito.when(productBusinessPartnerService.findByStoreIdAndProductId(productDetailResponse.getStoreId(), productDetailResponse.getId())).thenReturn(bp);
    Mockito.when( productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalse(anyString(),
        anyString())).thenReturn(productItemBusinessPartnerList);
    ProductDetailResponse productDetailResponse = getProductDetailResponseWithImages();
    ReflectionTestUtils.setField(getProductServiceBean(), "isProductVisibilityEnabled", false);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false))
        .thenReturn(productDetailResponse);
    Mockito.doNothing().when(productRepository)
        .updateProductAndItemImages(Mockito.any(ProductAndItemImageRequest.class));
    Mockito.when(this.productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED))
        .thenReturn(productSystemParameterEnable);
    Mockito.when(this.productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST))
        .thenReturn(productSystemCategoryParameter);
    Mockito.when(this.productSystemParameterService
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC))
        .thenReturn(productSystemParameterSync);
    productCollection.setState(STATE_DRAFT);
    productCollection.setPostLive(true);
    Mockito.doReturn(new ProductHistory()).when(this.productHistoryRepository)
        .saveAndFlush(Mockito.any(ProductHistory.class));
    Mockito
        .when(this.productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(fileStorageService.getImagePathPrefix()).thenReturn(GCS_PATH_PREFIX);
    Mockito.when(fileStorageService.getCompleteSourceUrlPrefix()).thenReturn(GCS_COMPLETE_SOURCE_URL);
    Mockito.doReturn(productCollection).when(this.productCollectionRepository)
        .saveAndFlush(Mockito.any(ProductCollection.class));
    Mockito.doNothing().when(solrReviewProductCollectionService).addProductToReviewProductCollection(productCollection);
    when(productLevel3Helper
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString()))
        .thenReturn(new ArrayList<>());
    boolean status = this.productServiceBean.updateImagePathsAndFlagOnResizingImageFailure(bulkImageProcessResponse);
    Mockito.verify(productBusinessPartnerService).findByStoreIdAndProductId(productDetailResponse.getStoreId()
        , productDetailResponse.getId());
    Mockito.verify(productItemBusinessPartnerRepository).findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalse(
        productDetailResponse.getStoreId(), ID);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productRepository).updateProductAndItemImages(productAndItemImageRequestArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Mockito.verify(productHistoryRepository).saveAndFlush(productHistoryArgumentCaptor.capture());
    Mockito.verify(productCollectionRepository).saveAndFlush(productCollectionArgumentCaptor.capture());
    verify(productLevel3Helper)
        .getRestrictedKeywordsInProductDetails(Mockito.any(ProductDetailResponse.class), Mockito.anyString());
    Mockito.verify(solrReviewProductCollectionService)
        .addProductToReviewProductCollection(productCollectionArgumentCaptor.capture());
    Mockito.verify(this.productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    Mockito.verify(this.productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_CATEGORY_LIST);
    Mockito.verify(this.productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_SYNC);
    Mockito.verify(objectMapper).writeValueAsString(Mockito.anyList());
    Assertions.assertEquals(0,
        productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream().filter(Image::getOriginalImage)
            .count());
    Assertions.assertEquals(4, productAndItemImageRequestArgumentCaptor.getValue().getProductImages().stream()
        .filter(image -> !image.getOriginalImage()).count());
    Assertions.assertEquals(SaveHistoryConstants.REVIEW_CONFIG_CHANGE,
        productHistoryArgumentCaptor.getValue().getDescription());
    Assertions.assertTrue(productCollectionArgumentCaptor.getValue().isImageResized());
    Assertions.assertTrue(status);
    Assertions.assertEquals(1, productCollection.getImageQcState());
  }

  @Test
  public void getMinimumPriceTest() {
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(STORE_ID, Constants.MINIMUM_PRICE))
        .thenReturn(productSystemParameter);
    Integer response = this.productServiceBean.getMinimumPrice(STORE_ID);
    Mockito.verify(productSystemParameterService).findByStoreIdAndVariable(STORE_ID, Constants.MINIMUM_PRICE);
    Assertions.assertEquals(1, response);
  }

  @Test
  public void checkIfMPPIsAllowedTest() throws Exception {
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertFalse(response);
  }

  @Test
  public void checkIfMPPIsAllowed1Test() {
    productServiceBean.checkIfMPPIsAllowed(new ProfileResponse());
  }

  @Test
  public void checkIfMPPIsAllowedCompanyNullTest() throws Exception {
    profileResponse.setCompany(null);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BUSINESS_PARTNER_ID))
        .thenReturn(profileResponse);
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertFalse(response);
  }

  @Test
  public void checkIfMPPIsAllowedSellerTypeInvalidTest() throws Exception {
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.setMultiDefaultAddressFlag(true);
    profileResponse.getCompany().setMerchantType(BUSINESS_PARTNER_ID);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BUSINESS_PARTNER_ID))
        .thenReturn(profileResponse);
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertFalse(response);
  }

  @Test
  public void checkIfMPPIsAllowedCncFalseTest() throws Exception {
    profileResponse.getCompany().setCncActivated(false);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BUSINESS_PARTNER_ID))
        .thenReturn(profileResponse);
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertFalse(response);
  }

  @Test
  public void checkIfMPPIsAllowedCncTrueTest() throws Exception {
    profileResponse.getCompany().setCncActivated(true);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BUSINESS_PARTNER_ID))
        .thenReturn(profileResponse);
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertTrue(response);
  }

  @Test
  public void checkIfMPPIsAllowedMppNullTest() throws Exception {
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.setMultiDefaultAddressFlag(null);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BUSINESS_PARTNER_ID))
        .thenReturn(profileResponse);
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertFalse(response);
  }

  @Test
  public void checkIfMPPIsAllowedMppFalseTest() throws Exception {
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.setMultiDefaultAddressFlag(false);
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertFalse(response);
  }

  @Test
  public void checkIfMPPIsAllowedMppTrueTest() throws Exception {
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.getCompany().setMerchantType(Constants.TD_MERCHANT);
    profileResponse.setMultiDefaultAddressFlag(true);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BUSINESS_PARTNER_ID))
        .thenReturn(profileResponse);
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertFalse(response);
  }

  @Test
  public void checkIfMPPIsAllowedTrueTest() throws Exception {
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.setMultiDefaultAddressFlag(true);
    profileResponse.getCompany().setMerchantType(Constants.CM_MERCHANT);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BUSINESS_PARTNER_ID))
        .thenReturn(profileResponse);
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertTrue(response);
  }

  @Test
  public void checkIfMPPIsAllowedTrueCMSellerTest() throws Exception {
    profileResponse.getCompany().setCncActivated(false);
    profileResponse.setMultiDefaultAddressFlag(true);
    profileResponse.getCompany().setMerchantType(Constants.CC_MERCHANT);
    Mockito.when(businessPartnerRepository.filterDetailByBusinessPartnerCode(BUSINESS_PARTNER_ID))
        .thenReturn(profileResponse);
    boolean response = productServiceBean.checkIfMPPIsAllowed(STORE_ID, BUSINESS_PARTNER_ID, profileResponse);
    Assertions.assertTrue(response);
  }

  @Test
  public void getMinimumPriceWithNullTest() {
    Mockito.when(this.productSystemParameterService.findByStoreIdAndVariable(STORE_ID, Constants.MINIMUM_PRICE))
        .thenReturn(null);
    Integer response = this.productServiceBean.getMinimumPrice(STORE_ID);
    Mockito.verify(productSystemParameterService).findByStoreIdAndVariable(STORE_ID, Constants.MINIMUM_PRICE);
    Assertions.assertNull(response);
  }

  @Test
  public void saveHistoryForUrlImageTest() throws Exception {
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE))
        .thenReturn(this.savedProduct);
    GdnRestListResponse<ItemSkuPickupPointCodeResponse> itemPickupPointCodeByItemSkus = new GdnRestListResponse<>();
    List<ItemSkuPickupPointCodeResponse> itemSkuPickupPointList = new ArrayList<>();
    ItemSkuPickupPointCodeResponse itemSkuPickupPointCodeResponse = new ItemSkuPickupPointCodeResponse();
    itemSkuPickupPointCodeResponse.setItemSku(ITEM_SKU);
    itemSkuPickupPointCodeResponse.setPickupPointCode(PICKUP_POINT_CODE);
    itemPickupPointCodeByItemSkus.setContent(itemSkuPickupPointList);
    Mockito.when(this.xProductOutbound.getItemPickupPointCodeByItemSkus(Mockito.any()))
        .thenReturn(itemPickupPointCodeByItemSkus);

    productServiceBean.saveHistoryForUrlImage(PRODUCT_CODE,
        Collections.singletonList(new ItemFlagDetails(ITEM_SKU, PICKUP_POINT_CODE, false, false, false, false, PRODUCT_ITEM_ID)), new ProductCreationRequest());
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE);
    Mockito.verify(updatedProductHistoryService).createAudit(new ArrayList<>(), false);
  }

  @Test
  public void saveHistoryForUrlImageExceptionTest() throws Exception {
    Mockito.doThrow(ApplicationRuntimeException.class).when(productRepository)
        .findProductDetailByProductCode(PRODUCT_CODE);
    productServiceBean.saveHistoryForUrlImage(PRODUCT_CODE,
        Collections.singletonList(new ItemFlagDetails(ITEM_SKU, PICKUP_POINT_CODE, false, false, false, false, PRODUCT_ITEM_ID)),
        new ProductCreationRequest());
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE);
  }

  @Test
  public void saveHistoryForUrlImageTest1() throws Exception {
    ProductCreationRequest productCreationRequest = getProductCreationRequest();
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE))
        .thenReturn(this.savedProduct);
    GdnRestListResponse<ItemSkuPickupPointCodeResponse> itemPickupPointCodeByItemSkus = new GdnRestListResponse<>();
    List<ItemSkuPickupPointCodeResponse> itemSkuPickupPointList = new ArrayList<>();
    ItemSkuPickupPointCodeResponse itemSkuPickupPointCodeResponse = new ItemSkuPickupPointCodeResponse();
    itemSkuPickupPointCodeResponse.setItemSku(ITEM_SKU);
    itemSkuPickupPointCodeResponse.setPickupPointCode(PICKUP_POINT_CODE);
    itemPickupPointCodeByItemSkus.setContent(itemSkuPickupPointList);
    Mockito.when(this.xProductOutbound.getItemPickupPointCodeByItemSkus(Mockito.any()))
        .thenReturn(itemPickupPointCodeByItemSkus);
    productServiceBean.saveHistoryForUrlImage(PRODUCT_CODE,
        Collections.singletonList(new ItemFlagDetails(ITEM_SKU, PICKUP_POINT_CODE, false, false, false, false, PRODUCT_ITEM_ID)), productCreationRequest);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE);
    Mockito.verify(updatedProductHistoryService)
        .createAudit(logAuditTrailUpdatedProductListCaptor.capture(), Mockito.eq(false));
    Assertions.assertEquals(ITEM_SKU, logAuditTrailUpdatedProductListCaptor.getValue().get(0).getGdnSku());
    Assertions.assertEquals(SaveHistoryConstants.IMAGE_LINK,
        logAuditTrailUpdatedProductListCaptor.getValue().get(0).getActivity());
    Assertions.assertEquals(URL_PATH,
        logAuditTrailUpdatedProductListCaptor.getValue().get(0).getNewValues());
    Assertions.assertTrue(StringUtils.isBlank(logAuditTrailUpdatedProductListCaptor.getValue().get(0).getOldValues()));
  }

  @Test
  public void saveHistoryForUrlImageTestWithEventSwitchOn() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "productHistoryUpdateThroughEvent", true);
    ProductCreationRequest productCreationRequest = getProductCreationRequest();
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE))
        .thenReturn(this.savedProduct);
    GdnRestListResponse<ItemSkuPickupPointCodeResponse> itemPickupPointCodeByItemSkus = new GdnRestListResponse<>();
    List<ItemSkuPickupPointCodeResponse> itemSkuPickupPointList = new ArrayList<>();
    ItemSkuPickupPointCodeResponse itemSkuPickupPointCodeResponse = new ItemSkuPickupPointCodeResponse();
    itemSkuPickupPointCodeResponse.setItemSku(ITEM_SKU);
    itemSkuPickupPointCodeResponse.setPickupPointCode(PICKUP_POINT_CODE);
    itemPickupPointCodeByItemSkus.setContent(itemSkuPickupPointList);
    Mockito.when(this.xProductOutbound.getItemPickupPointCodeByItemSkus(Mockito.any()))
        .thenReturn(itemPickupPointCodeByItemSkus);
    productServiceBean.saveHistoryForUrlImage(PRODUCT_CODE,
        Collections.singletonList(new ItemFlagDetails(ITEM_SKU, PICKUP_POINT_CODE, false, false, false, false, PRODUCT_ITEM_ID)), productCreationRequest);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE);
    Mockito.verify(kafkaProducer).send(anyString(),any(), any(AuditTrailListRequest.class));
  }

  @Test
  public void saveHistoryForUrlImageTest2() throws Exception {
    ProductCreationRequest productCreationRequest = getProductCreationRequest();
    Image image = set2Images(productCreationRequest);
    savedProduct.getProductItemResponses().iterator().next().getImages().add(image);
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE))
        .thenReturn(this.savedProduct);
    GdnRestListResponse<ItemSkuPickupPointCodeResponse> itemPickupPointCodeByItemSkus = new GdnRestListResponse<>();
    List<ItemSkuPickupPointCodeResponse> itemSkuPickupPointList = new ArrayList<>();
    ItemSkuPickupPointCodeResponse itemSkuPickupPointCodeResponse = new ItemSkuPickupPointCodeResponse();
    itemSkuPickupPointCodeResponse.setItemSku(ITEM_SKU);
    itemSkuPickupPointCodeResponse.setPickupPointCode(PICKUP_POINT_CODE);
    itemPickupPointCodeByItemSkus.setContent(itemSkuPickupPointList);
    Mockito.when(this.xProductOutbound.getItemPickupPointCodeByItemSkus(Mockito.any()))
        .thenReturn(itemPickupPointCodeByItemSkus);
    productServiceBean.saveHistoryForUrlImage(PRODUCT_CODE,
        Collections.singletonList(new ItemFlagDetails(ITEM_SKU, PICKUP_POINT_CODE, false, false, false, false, PRODUCT_ITEM_ID)), productCreationRequest);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE);
    Mockito.verify(updatedProductHistoryService).createAudit(logAuditTrailUpdatedProductListCaptor.capture(), Mockito.eq(false));
    Assertions.assertEquals(ITEM_SKU, logAuditTrailUpdatedProductListCaptor.getValue().get(0).getGdnSku());
    Assertions.assertEquals(SaveHistoryConstants.IMAGE_LINK,
        logAuditTrailUpdatedProductListCaptor.getValue().get(0).getActivity());
    Assertions.assertEquals(URL_PATH.concat(Constants.COMMA).concat(URL_PATH_2),
        logAuditTrailUpdatedProductListCaptor.getValue().get(0).getNewValues());
    Assertions.assertTrue(StringUtils.isBlank(logAuditTrailUpdatedProductListCaptor.getValue().get(0).getOldValues()));
  }

  private Image set2Images(ProductCreationRequest productCreationRequest) {
    Image image = new Image();
    image.setLocationPath(IMAGE_LOCATION_PATH_2);
    List<Image> images = new ArrayList<>();
    Image image1 = new Image();
    image1.setLocationPath(IMAGE_LOCATION_PATH_2);
    image1.setUrlPath(URL_PATH_2);
    images.add(productCreationRequest.getImages().get(0));
    images.add(image1);
    productCreationRequest.setImages(images);
    return image;
  }

  private ProductCreationRequest getProductCreationRequest() {
    savedProduct.getProductItemResponses().iterator().next().setId(PRODUCT_ITEM_ID);
    savedProduct.getProductItemResponses().iterator().next().getImages().get(0).setLocationPath(IMAGE_PATH);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    Image image = new Image();
    Set<String> url = new HashSet<>();
    url.add(URL_PATH);
    image.setLocationPath(IMAGE_PATH);
    image.setUrlPath(URL_PATH);
    productCreationRequest.setImages(Collections.singletonList(image));
    UpdatedProductHistory updatedProductHistory = new UpdatedProductHistory();
    updatedProductHistory.setGdnSku(ITEM_SKU);
    return productCreationRequest;
  }

  @Test
  public void approveImageSkipReviewTrueTest() throws Exception {
    ProductDetailResponse productData = new ProductDetailResponse(new ProductResponse());
    productData.setProductCode("MTA-" + UUID.randomUUID().toString());
    productData.setId(UUID.randomUUID().toString());
    productData.setStoreId(DEFAULT_STORE_ID);
    productData.setCreatedBy(DEFAULT_USERNAME);
    productData.setCreatedDate(Calendar.getInstance().getTime());
    productData.setUpdatedBy(DEFAULT_USERNAME);
    productData.setUpdatedDate(Calendar.getInstance().getTime());
    productData.setProductCategoryResponses(new ArrayList<ProductCategoryResponse>());
    productData.getProductCategoryResponses()
        .add(new ProductCategoryResponse(new CategoryResponse(), DEFAULT_STORE_ID));
    productData.setProductItemResponses(new HashSet<ProductItemResponse>());
    productData.setProductAttributeResponses(new ArrayList<ProductAttributeResponse>());
    productData.setImages(new ArrayList<Image>());
    ProductItemResponse productItemData = new ProductItemResponse();
    productItemData.setId(UUID.randomUUID().toString());
    productItemData.setImages(new ArrayList<Image>());
    productItemData.getImages().add(new Image());
    productItemData.setSkuCode(productData.getProductCode() + UUID.randomUUID().toString());
    productItemData.setGeneratedItemName(PRODUCT_ITEM_NAME);
    AttributeResponse attributeData = new AttributeResponse();
    attributeData.setAttributeType(AttributeType.DESCRIPTIVE_ATTRIBUTE.name());
    ProductAttributeResponse productAttributeData = new ProductAttributeResponse();
    productAttributeData.setAttribute(attributeData);
    productData.getProductItemResponses().add(productItemData);
    productData.getProductAttributeResponses().add(productAttributeData);
    productData.getImages().add(new Image());
    ProductBusinessPartner productBusinessPartnerData = getProductBusinessPartner();
    productBusinessPartnerData.getProductItemBusinessPartners().get(0).setProductItemId(productItemData.getId());
    productBusinessPartnerData.getProductItemBusinessPartners().remove(1);
    List<ProductBusinessPartner> productBusinessPartnerDatas = new ArrayList<ProductBusinessPartner>();
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productBusinessPartnerDatas.add(productBusinessPartnerData);
    productCollections.get(0).setSkipReview(true);
    Mockito.when(getProductCollectionRepository()
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString()))
        .thenReturn(productCollections.get(0));
    Mockito.when(this.productRepository.findProductDetailByProductCode(Mockito.anyString())).thenReturn(productData);
    Mockito.when(this.productBusinessPartnerRepository
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString()))
        .thenReturn(productBusinessPartnerDatas);
    Mockito.when(this.productLevel3Service.create(Mockito.anyString(),
        (ProductDetailResponse) Mockito.any(), Mockito.any(ProductBusinessPartner.class),
        eq(true), Mockito.anyList())).thenReturn(true);
    Mockito.when(this.productBusinessPartnerRepository.saveAll(Mockito.anyList()))
        .thenReturn(null);
    Mockito.doNothing().when(this.solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any());
    Mockito.when(this.productMailEventService.getCategoryChangeMailEvent(anyString(), anyString())).thenReturn(null);
    this.productServiceBean
        .approveImage(ProductServiceBeanTest.DEFAULT_STORE_ID, ProductServiceBeanTest.DEFAULT_PRODUCT_CODE, false);
    Mockito.verify(this.productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Mockito.eq(ProductServiceBeanTest.DEFAULT_STORE_ID),
            Mockito.anyString());
    Mockito.verify(this.productRepository).updateViewable(Mockito.anyString(), Mockito.anyBoolean());
    Mockito.verify(this.productRepository).findProductDetailByProductCode(Mockito.anyString());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.anyString(), Mockito.anyString());
    Mockito.verify(this.productLevel3Service, ProductServiceBeanTest.AT_LEAST_TWO).create(
        Mockito.anyString(), (ProductDetailResponse) Mockito.any(), Mockito.any(),
        eq(true), Mockito.anyList());
    Mockito.verify(this.productBusinessPartnerRepository).saveAll(Mockito.anyList());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(this.productCollectionRepository).save((ProductCollection) Mockito.any());
    Mockito.verify(this.productNotificationService, Mockito.times(2))
        .sendProductActiveNotification(businessPartnerCodeCaptor.capture(), Mockito.anyString(), Mockito.any(), Mockito.anyBoolean());
    List<String> businessPartnerCodes = businessPartnerCodeCaptor.getAllValues();
    Assertions.assertTrue(businessPartnerCodes.contains(BUSINESS_PARTNER_ID));
    Mockito.verify(this.productMailEventService, times(2))
        .getCategoryChangeMailEvent(eq(DEFAULT_STORE_ID), anyString());
    Mockito.verify(pcbFeign).updateProductReviewPending(DEFAULT_STORE_ID, Constants.DEFAULT_CHANNEL_ID,
        Constants.DEFAULT_CLIENT_ID, Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,DEFAULT_PRODUCT_CODE, false);
    Mockito.verify(productImageQcProcessingResponseService, times(2))
        .findByStoreIdAndProductCode(DEFAULT_STORE_ID, productData.getProductCode());
  }

  @Test
  public void saveMasterProductMigrationHistoryTest() {
    productMigration.setSyncStatus(true);
    Mockito.when(productHistoryRepository.save(Mockito.any(ProductHistory.class))).thenReturn(new ProductHistory());
    productServiceBean.saveMasterProductMigrationHistory(productMigration);
    Mockito.verify(productHistoryRepository).save(productHistoryCaptor.capture());
    Assertions.assertTrue(productHistoryCaptor.getValue().getNotes().contains(productMigration.getProductCode()));
  }

  @Test
  public void saveMasterProductMigrationHistoryUnsyncProductTest() throws Exception {
    Mockito.when(productHistoryRepository.save(Mockito.any(ProductHistory.class))).thenReturn(new ProductHistory());
    Mockito.when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(productMigration.getGdnProductSku()))
        .thenReturn(Arrays.asList(ITEM_SKU));
    Mockito.doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3AuditForMigration(productMigration.getBusinessPartnerId(), ITEM_SKU);
    productServiceBean.saveMasterProductMigrationHistory(productMigration);
    Mockito.verify(productHistoryRepository).save(productHistoryCaptor.capture());
    Mockito.verify(productBusinessPartnerRepository)
        .findListOfItemSkusbyProductSku(productMigration.getGdnProductSku());
    Mockito.verify(updatedProductHistoryService).saveUpdateProductLevel3AuditForMigration(productMigration.getBusinessPartnerId(), ITEM_SKU);
    Assertions.assertTrue(productHistoryCaptor.getValue().getNotes().contains(productMigration.getProductCode()));
  }

  @Test
  public void saveMasterProductMigrationHistoryUnsyncProductExceptionTest() throws Exception {
    Mockito.when(productHistoryRepository.save(Mockito.any(ProductHistory.class))).thenReturn(new ProductHistory());
    Mockito.doThrow(new PersistenceException())
        .when(productBusinessPartnerRepository).findListOfItemSkusbyProductSku(productMigration.getGdnProductSku());
    productServiceBean.saveMasterProductMigrationHistory(productMigration);
    Mockito.verify(productHistoryRepository).save(productHistoryCaptor.capture());
    Mockito.verify(productBusinessPartnerRepository)
        .findListOfItemSkusbyProductSku(productMigration.getGdnProductSku());
    Assertions.assertTrue(productHistoryCaptor.getValue().getNotes().contains(productMigration.getProductCode()));
  }

  @Test
  public void saveMasterProductMigrationHistoryUnsyncProductNoItemSkuTest() throws Exception {
    Mockito.when(productHistoryRepository.save(Mockito.any(ProductHistory.class))).thenReturn(new ProductHistory());
    Mockito.when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(productMigration.getGdnProductSku()))
        .thenReturn(Arrays.asList());
//    Mockito.doNothing().when(updatedProductHistoryService)
//        .saveUpdateProductLevel3Audit(productMigration.getBusinessPartnerId(), ITEM_SKU,
//            UpdateProductActivity.SYNC_CONTENT.getDesc(), "false", "true");
    productServiceBean.saveMasterProductMigrationHistory(productMigration);
    Mockito.verify(productHistoryRepository).save(productHistoryCaptor.capture());
    Mockito.verify(productBusinessPartnerRepository)
        .findListOfItemSkusbyProductSku(productMigration.getGdnProductSku());
//    Mockito.verify(updatedProductHistoryService, times(0)).saveUpdateProductLevel3Audit(productMigration.getBusinessPartnerId(), ITEM_SKU,
//        UpdateProductActivity.SYNC_CONTENT.getDesc(), "false", "true");
    Assertions.assertTrue(productHistoryCaptor.getValue().getNotes().contains(productMigration.getProductCode()));
  }

  @Test
  public void saveMasterProductMigrationHistoryTestEmptyProductSku() throws Exception{
    productMigration.setProductCode(null);
    Mockito.when(productHistoryRepository.save(Mockito.any(ProductHistory.class))).thenReturn(new ProductHistory());
    Mockito.when(productBusinessPartnerRepository.findListOfItemSkusbyProductSku(productMigration.getGdnProductSku()))
        .thenReturn(Arrays.asList(ITEM_SKU));
    Mockito.doNothing().when(updatedProductHistoryService)
        .saveUpdateProductLevel3AuditForMigration(productMigration.getBusinessPartnerId(), ITEM_SKU);
    productServiceBean.saveMasterProductMigrationHistory(productMigration);
    Mockito.verify(productHistoryRepository).save(productHistoryCaptor.capture());
    Mockito.verify(productBusinessPartnerRepository)
        .findListOfItemSkusbyProductSku(productMigration.getGdnProductSku());
    Mockito.verify(updatedProductHistoryService).saveUpdateProductLevel3AuditForMigration(productMigration.getBusinessPartnerId(), ITEM_SKU);
    assertEquals("New product code created", productHistoryCaptor.getValue().getNotes());
  }


  @Test
  public void updateProductCollectionForMigratedProductTest() throws Exception {
    Mockito.when(productCollectionRepository
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID,
            productMigration.getProductCode())).thenReturn(oldProductCollection);
    Mockito.doNothing().when(productBusinessPartnerRepository)
        .updateProductIdForMigration(productMigration.getMigratedProductId(), productMigration.getProductId(),
            productMigration.getGdnProductSku());
    Mockito.when(productCollectionRepository.save(Mockito.any(ProductCollection.class)))
        .thenReturn(oldProductCollection);
    Mockito.doNothing().when(solrActiveProductCollectionRepository)
        .addSolrProductCollectionDocument(Mockito.any(SolrProductCollectionDTO.class));
    productServiceBean.updateProductCollectionForMigratedProduct(productMigration, null);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(Constants.DEFAULT_STORE_ID,
            productMigration.getProductCode());
    Mockito.verify(productBusinessPartnerRepository)
        .updateProductIdForMigration(productMigration.getMigratedProductId(), productMigration.getProductId(),
            productMigration.getGdnProductSku());
    Mockito.verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Assertions.assertEquals(PRODUCT_CODE1, productCollectionArgumentCaptor.getValue().getProductCode());
  }

  @Test
  public void updateReviewTypeTest() {
    productCollection.setReviewType(REVIEW_TYPE);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    productServiceBean.updateReviewType(STORE_ID, PRODUCT_CODE, REVIEW_TYPE_1);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    Assertions.assertEquals(
        IMAGE_REFRESH, productCollectionArgumentCaptor.getValue().getReviewType());
  }

  @Test
  public void updateReviewTypeNullTest() {
    productCollection.setReviewType(REVIEW_TYPE);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    productServiceBean.updateReviewType(STORE_ID, PRODUCT_CODE, null);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    Assertions.assertNull(productCollectionArgumentCaptor.getValue().getReviewType());
  }

  @Test
  public void updateReviewTypePCNullTest() {
    try {
      productCollection.setReviewType(REVIEW_TYPE);
      Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(null);
      productServiceBean.updateReviewType(STORE_ID, PRODUCT_CODE, REVIEW_TYPE_1);
    } catch (ApplicationRuntimeException e) {
    } finally {
      Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    }
  }

  @Test
  public void updateReviewTypeEmptyTest() {
    productCollection.setReviewType(REVIEW_TYPE_1);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    productServiceBean.updateReviewType(STORE_ID, PRODUCT_CODE, REVIEW_TYPE_1);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    Assertions.assertNull( productCollectionArgumentCaptor.getValue().getReviewType());
  }

  @Test
  public void updateReviewTypeImageTest() {
    productCollection.setReviewType(REVIEW_TYPE);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    productServiceBean.updateReviewType(STORE_ID, PRODUCT_CODE, REVIEW_TYPE_2);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    Assertions.assertEquals(REVIEW_TYPE_1, productCollectionArgumentCaptor.getValue().getReviewType());
  }

  @Test
  public void updateReviewTypeNoChangeTest() {
    productCollection.setReviewType(null);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    productServiceBean.updateReviewType(STORE_ID, PRODUCT_CODE, REVIEW_TYPE_2);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
  }

  @Test
  public void isProductActivationNeeded() throws Exception {
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
        .thenReturn(new ArrayList<>());
    String activationNeeded = productServiceBean.isProductActivationNeeded(STORE_ID, PRODUCT_ID);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(STORE_ID, PRODUCT_ID);
    Assertions.assertEquals(activationNeeded, StringUtils.EMPTY);
  }

  @Test
  public void isProductActivationNeededTrueTest() throws Exception {
    productBusinessPartner.setMarkForDelete(false);
    productBusinessPartner.setState(IN_PROGRESS);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    String activationNeeded = productServiceBean.isProductActivationNeeded(STORE_ID, PRODUCT_ID);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(STORE_ID, PRODUCT_ID);
    Assertions.assertEquals(productBusinessPartner.getGdnProductSku(), activationNeeded);
  }

  @Test
  public void isProductActivationNeededMoreThan1CodesTest() throws Exception {
    try {
      productBusinessPartner.setMarkForDelete(false);
      productBusinessPartner.setState(IN_PROGRESS);
      Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
          .thenReturn(Arrays.asList(productBusinessPartner, productBusinessPartner));
      assertThrows(ApplicationRuntimeException.class, () -> {
        productServiceBean.isProductActivationNeeded(STORE_ID, PRODUCT_ID);
      });
    } finally {
      Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(STORE_ID, PRODUCT_ID);
    }
  }

  @Test
  public void isProductActivationNeededTrueForceReviewTrueTest() throws Exception {
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    basicProductResponse.setProductSku(PRODUCT_SKU);
    basicProductResponse.setMarkForDelete(true);
    basicProductResponse.setForceReview(true);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.when(xProductOutbound.getBasicProductInfo(PRODUCT_SKU)).thenReturn(basicProductResponse);
    String productSku = productServiceBean.isProductActivationNeeded(STORE_ID, PRODUCT_ID);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(STORE_ID, PRODUCT_ID);
    Mockito.verify(xProductOutbound).getBasicProductInfo(PRODUCT_SKU);
    Assertions.assertEquals(PRODUCT_SKU, productSku);
  }

  @Test
  public void isProductActivationNeededTrueMfdFalseTest() throws Exception {
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    basicProductResponse.setProductSku(PRODUCT_SKU);
    basicProductResponse.setMarkForDelete(false);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.when(xProductOutbound.getBasicProductInfo(PRODUCT_SKU)).thenReturn(basicProductResponse);
    String productSku = productServiceBean.isProductActivationNeeded(STORE_ID, PRODUCT_ID);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(STORE_ID, PRODUCT_ID);
    Mockito.verify(xProductOutbound).getBasicProductInfo(PRODUCT_SKU);
    Assertions.assertEquals(productSku, StringUtils.EMPTY);
  }

  @Test
  public void isProductActivationNeededTrueForceReviewFalseTest() throws Exception {
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    basicProductResponse.setProductSku(PRODUCT_SKU);
    basicProductResponse.setMarkForDelete(true);
    basicProductResponse.setForceReview(false);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.when(xProductOutbound.getBasicProductInfo(PRODUCT_SKU)).thenReturn(basicProductResponse);
    String productSku = productServiceBean.isProductActivationNeeded(STORE_ID, PRODUCT_ID);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(STORE_ID, PRODUCT_ID);
    Mockito.verify(xProductOutbound).getBasicProductInfo(PRODUCT_SKU);
    Assertions.assertEquals(productSku, StringUtils.EMPTY);
  }

  @Test
  public void isProductActivationNeededTrueEmptyStringTest() throws Exception {
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.when(xProductOutbound.getBasicProductInfo(PRODUCT_SKU)).thenThrow(RuntimeException.class);
    String productSku = productServiceBean.isProductActivationNeeded(STORE_ID, PRODUCT_ID);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(STORE_ID, PRODUCT_ID);
    Mockito.verify(xProductOutbound).getBasicProductInfo(PRODUCT_SKU);
    Assertions.assertEquals(productSku, StringUtils.EMPTY);
  }

  @Test
  public void updateReviewTypeWithEmptyReviewTypeTest() {
    productCollection.setReviewType(null);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(productCollection);
    productServiceBean.updateReviewType(STORE_ID, PRODUCT_CODE, REVIEW_TYPE_1);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
  }


  @Test
  public void updateProductCollectionForMigratedProductEmptyProductCodeTest() throws Exception {
    productMigration.setProductCode(StringUtils.EMPTY);
    ProductAndItemsResponse productAndItemsResponse = getProductAndItemsResponse();
    Mockito.when(productRepository
        .getAllProductDetailsByProductCodes(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            Arrays.asList(productMigration.getMigratedProductCode()))).thenReturn(
        new GdnRestListResponse<>(Arrays.asList(savedProduct), new PageMetaData(), Constants.DEFAULT_REQUEST_ID));
    Mockito.when(productBusinessPartnerRepository.save(any(ProductBusinessPartner.class)))
        .thenReturn(new ProductBusinessPartner());
    Mockito.when(productCollectionRepository.save(Mockito.any(ProductCollection.class)))
        .thenReturn(oldProductCollection);
    Mockito.when(productOutbound.getAttributeDetailByAttributeCode(ATTRIBUTE_CODE)).thenReturn(new AttributeResponse());
    Mockito.doNothing().when(productBusinessPartnerRepository)
        .updateProductIdForMigration(productMigration.getMigratedProductId(), productMigration.getProductId(),
            productMigration.getGdnProductSku());
    productServiceBean.updateProductCollectionForMigratedProduct(productMigration, productAndItemsResponse);
    Mockito.verify(productBusinessPartnerRepository).save(any(ProductBusinessPartner.class));
    Mockito.verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    Mockito.verify(productRepository)
        .getAllProductDetailsByProductCodes(Constants.DEFAULT_REQUEST_ID, Constants.DEFAULT_USERNAME,
            Arrays.asList(productMigration.getMigratedProductCode()));
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE),Mockito.any(),Mockito.any());
    Mockito.verify(productOutbound).getAttributeDetailByAttributeCode(ATTRIBUTE_CODE);
    Assertions.assertEquals(PRODUCT_CODE1, productCollectionArgumentCaptor.getValue().getProductCode());
  }

  private ProductAndItemsResponse getProductAndItemsResponse() {
    ProductAndItemsResponse productAndItemsResponse = new ProductAndItemsResponse();
    com.gdn.x.product.rest.web.model.response.ProductResponse productResponse = new com.gdn.x.product.rest.web.model.response.ProductResponse();
    productResponse.setProductType(ProductType.REGULAR);
    ItemResponse itemResponse = new ItemResponse();
    PriceDTO price = new PriceDTO();
    Set<PriceDTO> prices = new HashSet<>();
    prices.add(price);
    itemResponse.setPrice(prices);
    MasterDataItemDTO masterDataItem = new MasterDataItemDTO();
    itemResponse.setItemViewConfigs(ImmutableSet.of(new ItemViewConfigDTO()));
    itemResponse.setMasterDataItem(masterDataItem);
    productAndItemsResponse.setItems(Arrays.asList(itemResponse));
    List<ProductSpecialAttributeDTO> productSpecialAttributes = new ArrayList<>();
    ProductSpecialAttributeDTO productSpecialAttributeDTO = new ProductSpecialAttributeDTO(ATTRIBUTE_CODE, ATTRIBUTE_VALUE);
    productResponse.setProductSpecialAttributes(Arrays.asList(productSpecialAttributeDTO));
    productAndItemsResponse.setProduct(productResponse);
    return productAndItemsResponse;
  }

  @Test
  public void publishAddEditedProductToPDTEventTest() throws Exception {
    SellerDetailResponse sellerDetailResponse = new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE))
        .thenReturn(sellerDetailResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    productCollection.setPostLive(true);
    AddEditedProductToPDTEvent response = productServiceBean
        .publishAddEditedProductToPDTEvent(STORE_ID, EditedReviewTypeConstants.IMAGE_EDIT, productCollection, null);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), Mockito.eq(DEFAULT_PRODUCT_CODE),
            Mockito.any());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertTrue(response.isPostLive());
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
    Assertions.assertEquals(EditedReviewTypeConstants.IMAGE_EDIT, response.getReviewTypes());
  }

  @Test
  public void getProductImageQcProcessingResponseTest() {
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(new ProductImageQcProcessingResponse());
    productServiceBean.getProductImageQcProcessingResponse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
  }

  @Test
  public void getImageQcResponseFromPDTTest() {
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, PRODUCT_CODE))
        .thenReturn(new ProductImageQcFeedbackResponse());
    productServiceBean.getImageQcResponseFromPDT(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productDistributionTaskRepositoryBean).getProductImageQcFeedback(STORE_ID, PRODUCT_CODE);
  }

  @Test
  public void updateImageQcResponseTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "overrideForceReview", true);
    productCollection.setPostLive(true);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, this.imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseCategoryChangeTestTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    productCollection.setPostLive(true);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
      mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
      .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
      mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
      .thenReturn(userFeedbackImageQcListResponse);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    CategoryRestrictedKeywordResponse categoryRestrictedKeywordResponse = new CategoryRestrictedKeywordResponse();
    categoryRestrictedKeywordResponse.setKeyword(KEYWORD);
    categoryRestrictedKeywordResponse.setValidateByDs(true);
    categoryRestrictedKeywordResponse.setRestrictedKeywordId(KEYWORD_ID);
    categoryRestrictedKeywordResponse.setId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    categoryRestrictedKeywordResponse.setAction(0);
    when(getProductRepository().getCategoryRestrictedKeywordDetailList(productCollection.getCategoryCode(),
      Collections.singletonList(KEYWORD_ID))).thenReturn(
      Collections.singletonList(categoryRestrictedKeywordResponse));
    Map<String, RestrictedKeywordsMappedToCategoryResponse> restrictedKeywordToActionTypeMap = new HashMap<>();
    RestrictedKeywordsMappedToCategoryResponse restrictedKeywordsMappedToCategoryResponse = new RestrictedKeywordsMappedToCategoryResponse();
    restrictedKeywordsMappedToCategoryResponse.setKeyword(KEYWORD);
    restrictedKeywordsMappedToCategoryResponse.setKeywordId(KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setCategoryRestrictedKeywordId(RESTRICTED_KEYWORD_ID + KEYWORD_ID);
    restrictedKeywordsMappedToCategoryResponse.setAction(0);
    restrictedKeywordToActionTypeMap.put(KEYWORD, restrictedKeywordsMappedToCategoryResponse);
    RestrictedKeywordsByField restrictedKeywordsByField = new RestrictedKeywordsByField();
    restrictedKeywordsByField.setKeywords(Collections.singletonList(KEYWORD));
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionTypeResponse =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionTypeResponse.setAction(0);
    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType =
      new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(-1);
    when(productLevel3Helper.getResultantActionType(restrictedKeywordToActionTypeMap,
      Collections.singletonList(restrictedKeywordsByField), restrictedKeywordsByFieldAndActionType)).thenReturn(
      restrictedKeywordsByFieldAndActionTypeResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
      .updateImageQcResponse(STORE_ID, this.imageQcResponseDomainEvent, productImageQcProcessingResponse,
        productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
        productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
      .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
      .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
      Collections.singletonList(KEYWORD_ID));
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
      mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }



  @Test
  public void updateImageQcResponseTest_forTrustedSeller() throws Exception {
    productCollection.setPostLive(true);
    profileResponse.setTrustedSeller(true);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
      mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
      .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
      mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
      .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
      .updateImageQcResponse(STORE_ID, this.imageQcResponseDomainEvent, productImageQcProcessingResponse,
        productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
        productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
      .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
      .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(30, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
      mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }


  @Test
  public void updateImageQcResponseInReviewTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "overrideForceReview", true);
    productCollection.setReviewPending(true);
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK_1);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(60, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2 + Constants.COMMA + PREDICTION_DISPLAY_NAME_1,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseInReviewPDTResponseNullTest() throws Exception {
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK_1);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(null);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, null, pdtProductDomainEventModel, productDetailResponse,
          profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(60, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseInReviewPDTUserFeedbackNullTest() throws Exception {
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK_1);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    productImageQcFeedbackResponse.setUserFeedback(null);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(60, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseScoreChangeTest() throws Exception {
    productCollection.setPostLive(true);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseScoreChangeTakeDownTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "overrideForceReview", true);
    productImagePredictionNsfw.setForceReview(true);
    productCollection.setPostLive(true);
    productCollection.setReviewPending(true);
    productImageQcProcessingResponse.setForceReview(false);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2 + Constants.COMMA + PREDICTION_DISPLAY_NAME_1,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseAutoNeedRevisionTest() throws Exception {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(30);
    productCollection.setPostLive(true);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertFalse(response.isSendProductToReview());
    Assertions.assertTrue(response.isAutoNeedRevision());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseAutoNeedRevisionMFDTrueTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "overrideForceReview", true);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(30);
    productImagePredictionWaterMark.setMarkForDelete(true);
    productCollection.setPostLive(true);
    productCollection.setReviewPending(true);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2 + Constants.COMMA + PREDICTION_DISPLAY_NAME_1,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseAutoNeedRevisionThresholdTest() throws Exception {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionWaterMark.setNeedRevisionEnabled(true);
    productImagePredictionWaterMark.setNeedRevisionConfidenceThreshold(80);
    productCollection.setPostLive(true);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertTrue(captorValue.isForceReview());
    Assertions.assertTrue(response.isForceReview());
    Assertions.assertFalse(response.isAutoNeedRevision());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseScoreChangeTakeDownPreliveTest() throws Exception {
    productImagePredictionNsfw.setForceReview(true);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(60, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseScoreChangeTakeDownPrelive_forTrustedSellersTest() throws Exception {
    productImagePredictionNsfw.setForceReview(true);
    profileResponse.setTrustedSeller(true);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
      mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
      .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
      mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
      .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
      .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
        productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
        productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
      .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(60, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
      captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
      mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }


  @Test
  public void updateImageQcResponseTakeDownPredictionMFDTrueTest() throws Exception {
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setMarkForDelete(true);
    productCollection.setPostLive(true);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseCurrentPredictionsEmptyTest() throws Exception {
    CompanyDTO companyDTO = new CompanyDTO();
    companyDTO.setMerchantType(Constants.TD_MERCHANT);
    profileResponse.setCompany(companyDTO);
    ReflectionTestUtils.setField(productServiceBean, "skipDefinitiveAction", true);
    ReflectionTestUtils.setField(productServiceBean, "merchantTypeToSkipBrandModelCheck", "TD,TC");
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK_1);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    productImageQcProcessingResponse.setProductPredictionScore(0);
    productImageQcProcessingResponse.setImageViolations(null);
    productCollection.setPostLive(true);
    profileResponse.setTrustedSeller(false);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper).readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper).readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseCurrentPredictionsEmptyTest_productImagePredictionDirtyCheckingFixEnabledTrue()
      throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "productImagePredictionDirtyCheckingFixEnabled", true);
    ReflectionTestUtils.setField(productServiceBean, "enable21PlusModel", true);
    CompanyDTO companyDTO = new CompanyDTO();
    companyDTO.setMerchantType(Constants.TD_MERCHANT);
    profileResponse.setCompany(companyDTO);
    ReflectionTestUtils.setField(productServiceBean, "skipDefinitiveAction", true);
    ReflectionTestUtils.setField(productServiceBean, "merchantTypeToSkipBrandModelCheck", "TD,TC");
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK_1);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    productImageQcProcessingResponse.setProductPredictionScore(0);
    productImageQcProcessingResponse.setImageViolations(null);
    productCollection.setPostLive(true);
    profileResponse.setTrustedSeller(false);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
            objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
            objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper).readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper).readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseCurrentPredictionsEmpty_ForTrustedSellersTest() throws Exception {
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK_1);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    productImageQcProcessingResponse.setProductPredictionScore(0);
    productImageQcProcessingResponse.setImageViolations(null);
    productCollection.setPostLive(true);
    profileResponse.setTrustedSeller(true);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
      mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
      .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
      mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
      .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
      .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
        productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
        productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper).readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper).readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(50, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
      captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
      mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseEmptyTest() throws Exception {
    productCollection.setPostLive(true);
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK_1);
    productImagePredictionWaterMark.setConfidenceThreshold(100);
    productImagePredictionNsfw.setConfidenceThreshold(100);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    productImageQcProcessingResponse.setProductPredictionScore(0);
    productImageQcProcessingResponse.setImageViolations(null);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
    Assertions.assertEquals(EDITED_QC_RESPONSE, captorValue.getImageQcResponse());
  }

  @Test
  public void takeDownOrActivateProductByProductCodeTest() throws Exception {
    Mockito.when(productBusinessPartnerService.getProductSkusByProductCode(PRODUCT_CODE))
        .thenReturn(Collections.singletonList(MERCHANT_SKU));
    productServiceBean.takeDownOrActivateProductByProductCode(STORE_ID, PRODUCT_CODE, true);
    Mockito.verify(productLevel3Service).takeDownOrReactivateProduct(STORE_ID, MERCHANT_SKU, true, null, null);
    Mockito.verify(productBusinessPartnerService).getProductSkusByProductCode(PRODUCT_CODE);
  }

  @Test
  public void updateImageQcResponseInReviewEditedImageTest() throws Exception {
    productCollection.setPostLive(true);
    productImageQcProcessingResponse.setImageQcResponse(IMAGE_PREDICTION_RESPONSE_2);
    ImageDomainEventModel imageDomainEventModel = new ImageDomainEventModel();
    imageDomainEventModel.setLocationPath(LOCATION_PATH_1);
    pdtProductDomainEventModel.setImages(Collections.singletonList(imageDomainEventModel));
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK_1);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(60, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    for (ImageQcResponse imageQcResponse : storedImageQcResponseInDb.getImages()) {
      if (LOCATION_PATH_WITH_SOURCE_1.equals(imageQcResponse.getLocationPath())) {
        Assertions.assertTrue(imageQcResponse.isEdited());
      }
      if (LOCATION_PATH_WITH_SOURCE_2.equals(imageQcResponse.getLocationPath())) {
        Assertions.assertFalse(imageQcResponse.isEdited());
      }
    }
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void updateImageQcResponseInReviewEditedImageTest1() throws Exception {
    productCollection.setPostLive(true);
    productImageQcProcessingResponse.setImageQcResponse(IMAGE_PREDICTION_RESPONSE_2);
    productImageQcFeedbackResponse.setUserFeedback(PDT_USER_FEEDBACK_1);
    imageQcResponseDomainEvent.getImages().get(0).getPredictions().get(0).setConfidence(60);
    ProductImageQcProcessingResponse productImageQcProcessingResponseVerify = new ProductImageQcProcessingResponse();
    BeanUtils.copyProperties(productImageQcProcessingResponse, productImageQcProcessingResponseVerify);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    Mockito.when(productDistributionTaskRepositoryBean.getProductImageQcFeedback(STORE_ID, DEFAULT_PRODUCT_CODE))
        .thenReturn(productImageQcFeedbackResponse);
    ImageQcResponseDomainEvent qcResponseDomainEvent =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(qcResponseDomainEvent);
    UserFeedbackImageQcListResponse userFeedbackImageQcListResponse =
        mapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    Mockito.when(
        objectMapper.readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class))
        .thenReturn(userFeedbackImageQcListResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .updateImageQcResponse(STORE_ID, imageQcResponseDomainEvent, productImageQcProcessingResponse,
            productCollection, imageCountMap, productImageQcFeedbackResponse, pdtProductDomainEventModel,
            productDetailResponse, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(objectMapper)
        .readValue(productImageQcProcessingResponseVerify.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    verify(objectMapper)
        .readValue(productImageQcFeedbackResponse.getUserFeedback(), UserFeedbackImageQcListResponse.class);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(60, captorValue.getProductPredictionScore());
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_1 + Constants.COMMA + PREDICTION_DISPLAY_NAME_2,
        captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    ImageQcResponseDomainEvent storedImageQcResponseInDb =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    for (ImageQcResponse imageQcResponse : storedImageQcResponseInDb.getImages()) {
      if (LOCATION_PATH_1.equals(imageQcResponse.getLocationPath())) {
        Assertions.assertFalse(imageQcResponse.isEdited());
      }
      if (LOCATION_PATH_2.equals(imageQcResponse.getLocationPath())) {
        Assertions.assertFalse(imageQcResponse.isEdited());
      }
    }
    Assertions.assertEquals(mapper.writeValueAsString(storedImageQcResponseInDb), captorValue.getImageQcResponse());
  }

  @Test
  public void publishEditedProductTest() throws Exception {
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    profileResponse.setTrustedSeller(false);
    productServiceBean.publishEditedProduct(STORE_ID, PRODUCT_CODE, EditedReviewTypeConstants.IMAGE_EDIT);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaProducer)
        .send(eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(productCollection.getProductCode()),
            addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(productCollection.getProductCode(),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getProductCode());
    Assertions.assertEquals(EditedReviewTypeConstants.IMAGE_EDIT,
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getReviewTypes());
    Assertions.assertEquals(productCollection.getBusinessPartnerCode(),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getMerchantCode());
    Assertions.assertEquals(productCollection.getBusinessPartnerName(),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getMerchantName());
    Assertions.assertEquals(productCollection.isPostLive(),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().isPostLive());
    Assertions.assertEquals(productCollection.isRestrictedKeywordsPresent(),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().isRestrictedKeywordsPresent());
    Assertions.assertEquals(productCollection.getUpdatedBy(),
        addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getUpdatedBy());
    Assertions.assertEquals(profileResponse.isTrustedSeller(),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().isTrustedSeller());
  }

  @Test
  public void publishEditedProduct_forTrustedSellersTest() throws Exception {
    SellerDetailResponse sellerDetailResponse=new SellerDetailResponse();
    sellerDetailResponse.setSellerType(SELLER_TYPE);
    productCollection.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(productAnalyticsOutbound.getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE)).thenReturn(sellerDetailResponse);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
      .thenReturn(productCollection);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString())).thenReturn(profileResponse);
    profileResponse.setTrustedSeller(true);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
        .thenReturn(new ProductBusinessPartner());
    productServiceBean.publishEditedProduct(STORE_ID, PRODUCT_CODE, EditedReviewTypeConstants.IMAGE_EDIT);
    Mockito.verify(productCollectionRepository)
      .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    verify(businessPartnerRepository).filterDetailByBusinessPartnerCode(anyString());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.verify(kafkaProducer)
      .send(eq(DomainEventName.ADD_PRODUCT_TO_VENDOR_COMBINED_EVENT), eq(productCollection.getProductCode()),
        addProductToVendorCombinedEventModelArgumentCaptor.capture());
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Assertions.assertEquals(productCollection.getProductCode(),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getProductCode());
    Assertions.assertEquals(EditedReviewTypeConstants.IMAGE_EDIT,
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getReviewTypes());
    Assertions.assertEquals(productCollection.getBusinessPartnerCode(),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getMerchantCode());
    Assertions.assertEquals(productCollection.getBusinessPartnerName(),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getMerchantName());
    Assertions.assertEquals(productCollection.isPostLive(),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().isPostLive());
    Assertions.assertEquals(productCollection.isRestrictedKeywordsPresent(),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().isRestrictedKeywordsPresent());
    Assertions.assertEquals(productCollection.getUpdatedBy(),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().getUpdatedBy());
    Assertions.assertEquals(profileResponse.isTrustedSeller(),
      addProductToVendorCombinedEventModelArgumentCaptor.getValue().getAddEditedProductToPDTEvent().isTrustedSeller());
  }

  @Test
  public void findProductDetailWithPreOrderByProductCodeTest() throws Exception {
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            BUSINESS_PARTNER_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
  }

  @Test
  public void findProductDetailWithRestrictedKeywordsTest() throws Exception {
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    productCollections.get(0).setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    Mockito.when(objectMapper.readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class)))
        .thenReturn(new ObjectMapper()
            .readValue(RESTRICTED_KEYWORDS_FIELD, new TypeReference<List<RestrictedKeywordsByFieldResponse>>() {
            }));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            BUSINESS_PARTNER_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(objectMapper).readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class));
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
    Assertions.assertEquals(RestrictedKeywordFieldNames.PRODUCT_NAME.name(),
        response.getRestrictedKeywordsDetected().get(0).getFieldIdentifier());
    Assertions.assertEquals("abc@gmail.com", response.getRestrictedKeywordsDetected().get(0).getKeywords().get(0));
  }

  @Test
  public void findProductDetailWithRestrictedKeywordsSizeChartSwitchOnTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "sizeChartAdditionForProduct", true);
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    productCollections.get(0).setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    Mockito.when(objectMapper.readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class)))
        .thenReturn(new ObjectMapper()
            .readValue(RESTRICTED_KEYWORDS_FIELD, new TypeReference<List<RestrictedKeywordsByFieldResponse>>() {
            }));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            BUSINESS_PARTNER_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(objectMapper).readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class));
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
    Assertions.assertEquals(RestrictedKeywordFieldNames.PRODUCT_NAME.name(),
        response.getRestrictedKeywordsDetected().get(0).getFieldIdentifier());
    Assertions.assertEquals("abc@gmail.com", response.getRestrictedKeywordsDetected().get(0).getKeywords().get(0));
  }

  @Test
  public void findProductDetailWithRestrictedKeywordsSizeChartSwitchOnSizeChartCOdeExceptionTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "sizeChartAdditionForProduct", true);
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    productBusinessPartners.get(0).setSizeChartCode(SIZE_CHART_CODE);
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    productCollections.get(0).setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    Mockito.when(objectMapper.readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class)))
        .thenReturn(new ObjectMapper()
            .readValue(RESTRICTED_KEYWORDS_FIELD, new TypeReference<List<RestrictedKeywordsByFieldResponse>>() {
            }));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            BUSINESS_PARTNER_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(objectMapper).readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class));
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
    Assertions.assertEquals(RestrictedKeywordFieldNames.PRODUCT_NAME.name(),
        response.getRestrictedKeywordsDetected().get(0).getFieldIdentifier());
    Assertions.assertEquals("abc@gmail.com", response.getRestrictedKeywordsDetected().get(0).getKeywords().get(0));
  }

  @Test
  public void findProductDetailWithRestrictedKeywordsSizeChartSwitchOnSizeChartCOdeTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "sizeChartAdditionForProduct", true);
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    productBusinessPartners.get(0).setSizeChartCode(SIZE_CHART_CODE);
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    productCollections.get(0).setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    Mockito.when(objectMapper.readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class)))
        .thenReturn(new ObjectMapper()
            .readValue(RESTRICTED_KEYWORDS_FIELD, new TypeReference<List<RestrictedKeywordsByFieldResponse>>() {
            }));
    BasicSizeChartDetailMapResponse basicSizeChartDetailMapResponse = new BasicSizeChartDetailMapResponse();
    BasicSizeChartDetailResponse basicSizeChartDetailResponse = new BasicSizeChartDetailResponse();
    basicSizeChartDetailResponse.setSizeChartName(SIZE_CHART_CODE);
    basicSizeChartDetailResponse.setBusinessPartnerCode(BUSINESS_PARTNER_CODE);
    basicSizeChartDetailMapResponse.setBasicSizeChartDetailResponseMap(
        Map.of(SIZE_CHART_CODE, basicSizeChartDetailResponse));
    Mockito.when(pcbFeign.getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList()))
        .thenReturn(new GdnRestSingleResponse(null, null, true, basicSizeChartDetailMapResponse, null));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            BUSINESS_PARTNER_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(pcbFeign).getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(objectMapper).readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class));
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
    Assertions.assertEquals(RestrictedKeywordFieldNames.PRODUCT_NAME.name(),
        response.getRestrictedKeywordsDetected().get(0).getFieldIdentifier());
    Assertions.assertEquals("abc@gmail.com", response.getRestrictedKeywordsDetected().get(0).getKeywords().get(0));
  }

  @Test
  public void findProductDetailWithRestrictedKeywordsSizeChartSwitchOnBusinessPartnerCodeNotEqualTest()
      throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "sizeChartAdditionForProduct", true);
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    productBusinessPartners.get(0).setSizeChartCode(SIZE_CHART_CODE);
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    productCollections.get(0).setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    Mockito.when(objectMapper.readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class)))
        .thenReturn(new ObjectMapper()
            .readValue(RESTRICTED_KEYWORDS_FIELD, new TypeReference<List<RestrictedKeywordsByFieldResponse>>() {
            }));
    BasicSizeChartDetailMapResponse basicSizeChartDetailMapResponse = new BasicSizeChartDetailMapResponse();
    BasicSizeChartDetailResponse basicSizeChartDetailResponse = new BasicSizeChartDetailResponse();
    basicSizeChartDetailResponse.setSizeChartName(SIZE_CHART_CODE);
    basicSizeChartDetailResponse.setBusinessPartnerCode(BUSINESS_PARTNER_CODE);
    basicSizeChartDetailMapResponse.setBasicSizeChartDetailResponseMap(
        Map.of(SIZE_CHART_CODE, basicSizeChartDetailResponse));
    Mockito.when(pcbFeign.getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList()))
        .thenReturn(new GdnRestSingleResponse(null, null, true, basicSizeChartDetailMapResponse, null));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            PRODUCT_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(pcbFeign).getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(objectMapper).readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class));
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
    Assertions.assertEquals(RestrictedKeywordFieldNames.PRODUCT_NAME.name(),
        response.getRestrictedKeywordsDetected().get(0).getFieldIdentifier());
    Assertions.assertEquals("abc@gmail.com", response.getRestrictedKeywordsDetected().get(0).getKeywords().get(0));
  }

  @Test
  public void findProductDetailWithRestrictedKeywordsSizeChartSwitchOnBusinessPartnerCodeInternalTest()
      throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "sizeChartAdditionForProduct", true);
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    productBusinessPartners.get(0).setSizeChartCode(SIZE_CHART_CODE);
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    productCollections.get(0).setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    Mockito.when(objectMapper.readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class)))
        .thenReturn(new ObjectMapper()
            .readValue(RESTRICTED_KEYWORDS_FIELD, new TypeReference<List<RestrictedKeywordsByFieldResponse>>() {
            }));
    BasicSizeChartDetailMapResponse basicSizeChartDetailMapResponse = new BasicSizeChartDetailMapResponse();
    BasicSizeChartDetailResponse basicSizeChartDetailResponse = new BasicSizeChartDetailResponse();
    basicSizeChartDetailResponse.setSizeChartName(SIZE_CHART_CODE);
    basicSizeChartDetailResponse.setBusinessPartnerCode(Constants.INTERNAL);
    basicSizeChartDetailMapResponse.setBasicSizeChartDetailResponseMap(
        Map.of(SIZE_CHART_CODE, basicSizeChartDetailResponse));
    Mockito.when(pcbFeign.getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList()))
        .thenReturn(new GdnRestSingleResponse(null, null, true, basicSizeChartDetailMapResponse, null));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            PRODUCT_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(pcbFeign).getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(objectMapper).readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class));
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
    Assertions.assertEquals(RestrictedKeywordFieldNames.PRODUCT_NAME.name(),
        response.getRestrictedKeywordsDetected().get(0).getFieldIdentifier());
    Assertions.assertEquals("abc@gmail.com", response.getRestrictedKeywordsDetected().get(0).getKeywords().get(0));
  }

  @Test
  public void findProductDetailWithRestrictedKeywordsSizeChartSwitchOnSuccessFalseTest()
      throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "sizeChartAdditionForProduct", true);
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    productBusinessPartners.get(0).setSizeChartCode(SIZE_CHART_CODE);
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    productCollections.get(0).setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    Mockito.when(objectMapper.readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class)))
        .thenReturn(new ObjectMapper()
            .readValue(RESTRICTED_KEYWORDS_FIELD, new TypeReference<List<RestrictedKeywordsByFieldResponse>>() {
            }));
    BasicSizeChartDetailMapResponse basicSizeChartDetailMapResponse = new BasicSizeChartDetailMapResponse();
    BasicSizeChartDetailResponse basicSizeChartDetailResponse = new BasicSizeChartDetailResponse();
    basicSizeChartDetailResponse.setSizeChartName(SIZE_CHART_CODE);
    basicSizeChartDetailResponse.setBusinessPartnerCode(Constants.INTERNAL);
    basicSizeChartDetailMapResponse.setBasicSizeChartDetailResponseMap(
        Map.of(SIZE_CHART_CODE, basicSizeChartDetailResponse));
    Mockito.when(pcbFeign.getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList()))
        .thenReturn(new GdnRestSingleResponse(null, null, false, basicSizeChartDetailMapResponse, null));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            PRODUCT_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(pcbFeign).getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(objectMapper).readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class));
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
    Assertions.assertEquals(RestrictedKeywordFieldNames.PRODUCT_NAME.name(),
        response.getRestrictedKeywordsDetected().get(0).getFieldIdentifier());
    Assertions.assertEquals("abc@gmail.com", response.getRestrictedKeywordsDetected().get(0).getKeywords().get(0));
  }

  @Test
  public void findProductDetailWithRestrictedKeywordsSizeChartSwitchOnBusinessPartnerEmptyTest()
      throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "sizeChartAdditionForProduct", true);
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    productBusinessPartners.get(0).setSizeChartCode(SIZE_CHART_CODE);
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    productCollections.get(0).setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    Mockito.when(objectMapper.readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class)))
        .thenReturn(new ObjectMapper()
            .readValue(RESTRICTED_KEYWORDS_FIELD, new TypeReference<List<RestrictedKeywordsByFieldResponse>>() {
            }));
    BasicSizeChartDetailMapResponse basicSizeChartDetailMapResponse = new BasicSizeChartDetailMapResponse();
    BasicSizeChartDetailResponse basicSizeChartDetailResponse = new BasicSizeChartDetailResponse();
    basicSizeChartDetailResponse.setSizeChartName(SIZE_CHART_CODE);
    basicSizeChartDetailResponse.setBusinessPartnerCode(Constants.INTERNAL);
    basicSizeChartDetailMapResponse.setBasicSizeChartDetailResponseMap(
        Map.of(SIZE_CHART_CODE, basicSizeChartDetailResponse));
    Mockito.when(pcbFeign.getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList()))
        .thenReturn(new GdnRestSingleResponse(null, null, false, basicSizeChartDetailMapResponse, null));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            StringUtils.EMPTY);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(pcbFeign).getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(objectMapper).readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class));
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
    Assertions.assertEquals(RestrictedKeywordFieldNames.PRODUCT_NAME.name(),
        response.getRestrictedKeywordsDetected().get(0).getFieldIdentifier());
    Assertions.assertEquals("abc@gmail.com", response.getRestrictedKeywordsDetected().get(0).getKeywords().get(0));
  }

  @Test
  public void findProductDetailWithRestrictedKeywordsSizeChartSwitchOnSuccessTrueValueNullTest()
      throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "sizeChartAdditionForProduct", true);
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    productBusinessPartners.get(0).setSizeChartCode(SIZE_CHART_CODE);
    savedProduct.setProductCode(PRODUCT_CODE);
    productCollections.get(0).setState("NEED_CORRECTION");
    productCollections.get(0).setRestrictedKeywordsDetected(RESTRICTED_KEYWORDS_FIELD);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    Mockito.when(objectMapper.readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class)))
        .thenReturn(new ObjectMapper()
            .readValue(RESTRICTED_KEYWORDS_FIELD, new TypeReference<List<RestrictedKeywordsByFieldResponse>>() {
            }));
    BasicSizeChartDetailMapResponse basicSizeChartDetailMapResponse = new BasicSizeChartDetailMapResponse();
    BasicSizeChartDetailResponse basicSizeChartDetailResponse = new BasicSizeChartDetailResponse();
    basicSizeChartDetailResponse.setSizeChartName(SIZE_CHART_CODE);
    basicSizeChartDetailResponse.setBusinessPartnerCode(Constants.INTERNAL);
    basicSizeChartDetailMapResponse.setBasicSizeChartDetailResponseMap(
        Map.of(SIZE_CHART_CODE, basicSizeChartDetailResponse));
    Mockito.when(pcbFeign.getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList()))
        .thenReturn(new GdnRestSingleResponse(null, null, true, null, null));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            PRODUCT_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(pcbFeign).getSizeChartBasicDetailBySizeChartCode(anyString(), any(), any(), any(), any(), anyList());
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(objectMapper).readValue(Mockito.eq(RESTRICTED_KEYWORDS_FIELD), Mockito.any(TypeReference.class));
    Assertions.assertTrue(response.getPreOrder().getIsPreOrder());
    Assertions.assertEquals(PREORDER_TYPE, response.getPreOrder().getPreOrderType());
    Assertions.assertEquals(PREORDER_VALUE, response.getPreOrder().getPreOrderValue());
    Assertions.assertTrue(response.isRevised());
    Assertions.assertEquals(RestrictedKeywordFieldNames.PRODUCT_NAME.name(),
        response.getRestrictedKeywordsDetected().get(0).getFieldIdentifier());
    Assertions.assertEquals("abc@gmail.com", response.getRestrictedKeywordsDetected().get(0).getKeywords().get(0));
  }

  @Test
  public void findProductDetailWithPreOrderByProductCodeNullTest() throws Exception {
    savedProduct.setProductCode(PRODUCT_CODE);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(productBusinessPartners);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            BUSINESS_PARTNER_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Assertions.assertNull(response.getPreOrder());
  }

  @Test
  public void findProductDetailWithPreOrderByProductCodeWithPreOrderResponseNullTest() throws Exception {
    productBusinessPartners.get(0).setPreOrder(true);
    productBusinessPartners.get(0).setPreOrderType(PREORDER_TYPE);
    productBusinessPartners.get(0).setPreOrderValue(PREORDER_VALUE);
    productBusinessPartners.get(0).setPreOrderDate(new Date());
    savedProduct.setProductCode(PRODUCT_CODE);
    Mockito.when(this.productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(savedProduct);
    when(productBusinessPartnerRepository.findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId()))
        .thenReturn(null);
    Mockito.when(getProductCollectionRepository().findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollections.get(0));
    ProductDetailCompleteResponse response =
        this.productServiceBean.findProductDetailWithPreOrderByProductCode(DEFAULT_STORE_ID, PRODUCT_CODE, false,
            BUSINESS_PARTNER_CODE);
    Mockito.verify(this.productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(this.productBusinessPartnerRepository)
        .findByStoreIdAndProductId(DEFAULT_STORE_ID, savedProduct.getId());
    Mockito.verify(getProductCollectionRepository()).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Assertions.assertNull(response.getPreOrder());
  }

  @Test
  public void updateForceReviewFlagAfterVendorApprovalNullTest() throws IOException {
    productServiceBean.updateImageQcDataAfterVendorApproval(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCodeDb(STORE_ID, PRODUCT_CODE);
  }

  @Test
  public void updateForceReviewFlagAfterVendorApprovalQcEmptyTest() throws IOException {
    productImageQcProcessingResponse.setImageQcResponse(null);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCodeDb(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    productServiceBean.updateImageQcDataAfterVendorApproval(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCodeDb(STORE_ID, PRODUCT_CODE);
  }


  @Test
  public void updateForceReviewFlagAfterVendorApprovalOldDataTest() throws IOException {
    productImageQcProcessingResponse.setForceReview(true);
    productImageQcProcessingResponse.setImageQcResponse(IMAGE_PREDICTION_RESPONSE_OLD_DATA);
    Mockito.when(productImageQcProcessingResponseService.findByStoreIdAndProductCodeDb(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    ImageQcResponseDomainEvent imageQcResponseDomainEvent1 = getImageQcResponseDomainEvent();
    Mockito.when(objectMapper.writeValueAsString(imageQcResponseDomainEvent1))
        .thenReturn(mapper.writeValueAsString(imageQcResponseDomainEvent1));
    productServiceBean.updateImageQcDataAfterVendorApproval(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCodeDb(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productImageQcProcessingResponseService)
        .save(productImageQcProcessingResponseArgumentCaptor.capture());
    Mockito.verify(objectMapper).readValue(IMAGE_PREDICTION_RESPONSE_OLD_DATA, ImageQcResponseDomainEvent.class);
    Mockito.verify(objectMapper).writeValueAsString(imageQcResponseDomainEvent1);
    Assertions.assertFalse(productImageQcProcessingResponseArgumentCaptor.getValue().isForceReview());
    ImageQcResponseDomainEvent imageQcResponseDomainEvent = mapper
        .readValue(productImageQcProcessingResponseArgumentCaptor.getValue().getImageQcResponse(),
            ImageQcResponseDomainEvent.class);
    for (ImageQcResponse imageQcResponse : imageQcResponseDomainEvent.getImages()) {
      assertTrue(imageQcResponse.isMarkForDelete());
      assertFalse(imageQcResponse.isEdited());
    }
  }

  private ImageQcResponseDomainEvent getImageQcResponseDomainEvent() throws IOException {
    ImageQcResponseDomainEvent imageQcResponseDomainEvent1 =
        mapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class);
    Mockito.when(
        objectMapper.readValue(productImageQcProcessingResponse.getImageQcResponse(), ImageQcResponseDomainEvent.class))
        .thenReturn(imageQcResponseDomainEvent1);
    for (ImageQcResponse imageQcResponse : imageQcResponseDomainEvent1.getImages()) {
      imageQcResponse.setMarkForDelete(true);
      imageQcResponse.setEdited(false);
    }
    return imageQcResponseDomainEvent1;
  }

  @Test
  public void updateActiveImagesAndGetActivateImageResponseTest() throws Exception {
    productServiceBean
        .updateActiveImagesAndGetActivateImageResponse(PRODUCT_CODE, Arrays.asList(new ScaleImageResponse()));
    Mockito.verify(productOutbound).updateProductImagesName(imageRequestArgumentCaptor.capture(), eq(false));
    assertEquals(PRODUCT_CODE, imageRequestArgumentCaptor.getValue().getProductCode());
  }

  @Test
  public void findAutoApprovalTypeByRequestTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
      .thenReturn(productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
      imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertFalse(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void findAutoApprovalTypeByRequestOverrideRestrictedKeywordTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "overrideRestrictedKeywordsFlagByDsResponse", true);
    keywordRestrictionModelsResponse.getKeywordRecommendations().get(0).setRecommendation(INVALID_DETECTION);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    productImageQcProcessingResponse.setImageViolations(
      Constants.CATEGORY_MISMATCH.concat(Constants.COMMA).concat(Constants.WATERMARK));
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(
        productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    productCollection.setRestrictedKeywordsPresent(true);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertFalse(productCollection.isRestrictedKeywordsPresent());
    Assertions.assertFalse(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void findAutoApprovalTypeByRequestOverrideRestrictedKeywordBrandTakeDownTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "overrideRestrictedKeywordsFlagByDsResponse", true);
    keywordRestrictionModelsResponse.getKeywordRecommendations().get(0).setRecommendation(INVALID_DETECTION);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(
        productDetailResponse);
    productImageQcProcessingResponse.setForceReview(true);
    productImageQcProcessingResponse.setPredictedBrand(BRAND);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    productCollection.setRestrictedKeywordsPresent(true);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertFalse(productCollection.isRestrictedKeywordsPresent());
    Assertions.assertFalse(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void findAutoApprovalTypeByRequestOverrideRestrictedKeywordBrandTakeDown2Test() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "overrideRestrictedKeywordsFlagByDsResponse", true);
    keywordRestrictionModelsResponse.getKeywordRecommendations().get(0).setRecommendation(INVALID_DETECTION);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(
        productDetailResponse);
    productImageQcProcessingResponse.setForceReview(false);
    productImageQcProcessingResponse.setPredictedBrand(BRAND);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
        productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    productCollection.setRestrictedKeywordsPresent(true);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertFalse(productCollection.isRestrictedKeywordsPresent());
    Assertions.assertFalse(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void findAutoApprovalTypeByRequestValidateTextAndImageViolationTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "autoApprovalContentImageViolation", true);
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertTrue(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void findAutoApprovalTypeByRequestValidateTextViolationTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "autoApprovalContentImageViolation", true);
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    productImageQcProcessingResponse.setTextViolations(PREDICTION_TEXT_NAME);
    productImageQcProcessingResponse.setImageViolations(null);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertTrue(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void findAutoApprovalTypeByRequestValidateImageViolationTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "autoApprovalContentImageViolation", true);
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    productImageQcProcessingResponse.setTextViolations(null);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertTrue(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void findAutoApprovalTypeByRequestValidateRestrictedKeywordTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "autoApprovalContentImageViolation", true);
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    productImageQcProcessingResponse.setTextViolations(null);
    productImageQcProcessingResponse.setImageViolations(null);
    productCollection.setRestrictedKeywordsPresent(true);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertTrue(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void findAutoApprovalTypeByRequestValidateNoViolationTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "autoApprovalContentImageViolation", true);
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    productImageQcProcessingResponse.setTextViolations(null);
    productImageQcProcessingResponse.setImageViolations(null);
    productCollection.setRestrictedKeywordsPresent(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertFalse(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void findAutoApprovalTypeByRequest_forTrustedSellerTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(true);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
      .thenReturn(productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
      imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
  }


  @Test
  public void findAutoApprovalTypeByRequestFilteredTest() throws Exception {
    profileResponse.setTrustedSeller(false);
    Mockito.when(productImagePredictionService.findByStoreIdAndMarkForDeleteFalse(STORE_ID)).thenReturn(Arrays.asList(
        ProductImagePrediction.builder().predictionType(PREDICTION_NAME_1).predictionConsidered(true).build(),
        ProductImagePrediction.builder().predictionType(ACTIVE_PREDICTIONS.get(2)).build(),
        ProductImagePrediction.builder().predictionType(ACTIVE_PREDICTIONS.get(3)).build()));
    productDetailResponse.getImages().get(0).setEdited(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
        imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
        Collections.singletonList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
        AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture());
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertEquals(PREDICTION_NAME_1,
        autoApprovalsDetailDtoArgumentCaptor.getValue().getImageQcConfidenceDetails().get(0)
            .getImageQcConfidenceDtoList().get(0).getPredictionType());
    Assertions.assertEquals(1,
        autoApprovalsDetailDtoArgumentCaptor.getValue().getImageQcConfidenceDetails().get(0)
            .getImageQcConfidenceDtoList().size());
  }

  @Test
  public void findAutoApprovalTypeByRequestFiltered_forTrustedSellersTest() throws Exception {
    profileResponse.setTrustedSeller(true);
    Mockito.when(productImagePredictionService.findByStoreIdAndMarkForDeleteFalse(STORE_ID)).thenReturn(Arrays.asList(
      ProductImagePrediction.builder().predictionType(PREDICTION_NAME_1).predictionConsidered(true).build(),
      ProductImagePrediction.builder().predictionType(ACTIVE_PREDICTIONS.get(2)).build(),
      ProductImagePrediction.builder().predictionType(ACTIVE_PREDICTIONS.get(3)).build()));
    productDetailResponse.getImages().get(0).setEdited(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
      .thenReturn(productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
      imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Collections.singletonList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture());
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertEquals(PREDICTION_NAME_1,
      autoApprovalsDetailDtoArgumentCaptor.getValue().getImageQcConfidenceDetails().get(0)
        .getImageQcConfidenceDtoList().get(0).getPredictionType());
    Assertions.assertEquals(1,
      autoApprovalsDetailDtoArgumentCaptor.getValue().getImageQcConfidenceDetails().get(0)
        .getImageQcConfidenceDtoList().size());
  }


  @Test
  public void findAutoApprovalTypeByRequest_QCResponseNullTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true))
        .thenReturn(productDetailResponse);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(null);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    Assertions.assertEquals(AutoApprovalType.NA, response);
  }

  @Test
  public void findAutoApprovalTypeByRequest_contentOnlyTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    autoApprovalTypeRequest.setReviewType(Constants.CONTENT_AUTO_APPROVAL_CHECK);
    profileResponse.setTrustedSeller(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
  }

  @Test
  public void findAutoApprovalTypeByRequest_contentOnly_forTrustedSellersTest() throws Exception {
    productDetailResponse.getImages().get(0).setEdited(false);
    autoApprovalTypeRequest.setReviewType(Constants.CONTENT_AUTO_APPROVAL_CHECK);
    productCollection.setRestrictedKeywordsPresent(true);
    profileResponse.setTrustedSeller(true);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(productDetailResponse);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class))).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    AutoApprovalType response =
        productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
            autoApprovalTypeRequest, profileResponse, productCollection);
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
  }

  @Test
  public void saveProductCollectionTest() {
    productServiceBean.saveProductCollection(productCollection);
    Mockito.verify(productCollectionRepository).save(productCollection);
  }

  @Test
  public void removeProductFromPDTTest() throws Exception {
    productServiceBean.removeProductFromPDT(PRODUCT_CODE);
    Mockito.verify(productDistributionService)
        .removeProductFromPDT(Mockito.anyString(), Mockito.anyString(), Mockito.any());
  }

  @Test
  public void deleteFromReviewProductCollectionTest() {
    productServiceBean.deleteFromReviewProductCollection(Collections.singletonList(PRODUCT_ID));
    SolrReviewProductCollectionDeleteEvent solrReviewProductCollectionDeleteEvent =
        new SolrReviewProductCollectionDeleteEvent();
    solrReviewProductCollectionDeleteEvent.setIds(Collections.singletonList(PRODUCT_ID));
    Mockito.verify(kafkaProducer)
        .send(DomainEventName.SOLR_DELETE_REVIEW_PRODUCT_REQUEST, solrReviewProductCollectionDeleteEvent);
  }

  @Test
  public void checkIfProductExistsInPDTTest() {
    productServiceBean.checkIfProductExistsInPDT(PRODUCT_CODE, true);
    Mockito.verify(productDistributionTaskRepositoryBean).checkIfProductExistsInPDT(PRODUCT_CODE, true);
  }

  @Test
  public void addProductToReviewCollectionTest() throws Exception {
    productServiceBean.addProductToReviewCollection(productCollection);
    Mockito.verify(solrReviewProductCollectionService)
        .publishKafkaEventToAddProductToReviewProductCollection(productCollection);
  }

  @Test
  public void updateAutoApprovalTypeByProductCode() throws Exception {
    productServiceBean.updateAutoApprovalTypeByProductCode(productCollection.getAutoApprovalType(),
        productCollection.getProductCode());
    Mockito.verify(productCollectionRepository)
        .updateAutoApprovalTypeByProductCode(productCollection.getAutoApprovalType(),
            productCollection.getProductCode());
  }

  @Test
  public void findInProgressProductsByMerchantCodeTest() {
    Mockito.when(
      productBusinessPartnerService.findByStoreIdAndBusinessPartnerIdAndStateAndMarkForDeleteFalse(
        STORE_ID, BP_CODE, IN_PROGRESS_STATE)).thenReturn(
      Collections.singletonList(new InProgressProductResponse(DEFAULT_PRODUCT_SKU, STATE)));
    InProgressProductResponsePageResponse response =
        productServiceBean.findInProgressProductsByMerchantCode(STORE_ID, BP_CODE, 0, 10);
    Mockito.verify(productBusinessPartnerService)
      .findByStoreIdAndBusinessPartnerIdAndStateAndMarkForDeleteFalse(STORE_ID, BP_CODE,
        IN_PROGRESS_STATE);
    Assertions.assertEquals(DEFAULT_PRODUCT_SKU,
      response.getInProgressProductResponses().get(0).getProductSku());
  }

  @Test
  public void publishAutoNeedRevisionEventTest() {
    productServiceBean.publishAutoNeedRevisionEvent(Constants.DEFAULT_STORE_ID, PRODUCT_CODE,
        Collections.singleton(PREDICTION_NAME_1), false, StringUtils.EMPTY);
    AutoNeedRevisionDomainEvent autoNeedRevisionDomainEvent =
        new AutoNeedRevisionDomainEvent(Constants.DEFAULT_STORE_ID, PRODUCT_CODE,
            Collections.singletonList(PREDICTION_NAME_1));
    autoNeedRevisionDomainEvent.setNotes(StringUtils.EMPTY);
    Mockito.verify(kafkaProducer).send(DomainEventName.PRODUCT_AUTO_NEED_REVISION_EVENT, PRODUCT_CODE,
        autoNeedRevisionDomainEvent);
  }

  @Test
  public void publishProductActionRetryEventTest() {
    productServiceBean.publishProductActionRetryEvent(
        new ProductActionRetryEvent(Constants.DEFAULT_STORE_ID, PRODUCT_CODE, null, null));
    Mockito.verify(kafkaProducer).send(DomainEventName.ADD_PRODUCT_TO_PDT_RETRY, PRODUCT_CODE,
        new ProductActionRetryEvent(Constants.DEFAULT_STORE_ID, PRODUCT_CODE, null, null));
  }


  @Test
  public void getProductStatusEmptyTest() {
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(null);
    String productStatus = productServiceBean.getProductStatus(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Assertions.assertEquals(StringUtils.EMPTY, productStatus);
  }

  @Test
  public void getProductStatusNotEmptyTest() {
    productCollection.setState("ACTIVE");
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    String productStatus = productServiceBean.getProductStatus(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Assertions.assertEquals(productCollection.getState(), productStatus);
  }

  @Test
  public void publishDimensionRefreshEventForReviewPendingProductsReviewPendingTrueTest() {
    productCollection.setReviewPending(true);
    when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    when(productPublisherService.publishProductDimensionRefreshEvent(Mockito.any(PDTDimensionRefreshEventModel.class)))
        .thenReturn(new PDTDimensionRefreshEventModel());
    productServiceBean
        .publishDimensionRefreshEventForReviewPendingProducts(STORE_ID, PRODUCT_CODE, new DimensionRefreshRequest());
    verify(productCollectionRepository).findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    verify(productPublisherService)
        .publishProductDimensionRefreshEvent(Mockito.any(PDTDimensionRefreshEventModel.class));
  }

  @Test
  public void publishDimensionRefreshEventForReviewPendingNullTest() {
    when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(null);
    productServiceBean
        .publishDimensionRefreshEventForReviewPendingProducts(STORE_ID, PRODUCT_CODE, new DimensionRefreshRequest());
    verify(productCollectionRepository).findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
  }

  @Test
  public void publishDimensionRefreshEventForReviewPendingProductsReviewPendingFalseTest() {
    productCollection.setReviewPending(false);
    when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    productServiceBean
        .publishDimensionRefreshEventForReviewPendingProducts(STORE_ID, PRODUCT_CODE, new DimensionRefreshRequest());
    verify(productCollectionRepository).findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
  }

  @Test
  public void testUpdateDimensionForReviewPendingProduct() throws Exception {
    ProductItem productItem = new ProductItem();
    productItem.setActivated(true);
    Product product = getProduct();
    product.setViewable(true);
    product.setActivated(true);
    product.setProductItems(Arrays.asList(productItem));
    SolrProductCollectionUpdateEvent solrProductCollectionUpdateEvent =
        new SolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(new ArrayList<ProductBusinessPartner>());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_EDIT,
        ProductWorkflowLookup.STATE_EDIT_DESCRIPTION, ProductWorkflowLookup.STATE_EDIT_DESCRIPTION,
        product.getUpdatedBy(), product.getUpdatedDate(), product.getStoreId());
    productCollections.get(0).setReviewPending(true);

    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito
        .when(productStatusPublisherService.publishSolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO()))
        .thenReturn(solrProductCollectionUpdateEvent);

    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductHistoryRepository().save(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductChangeUtil().getProductDiff(product, product))
        .thenReturn(Collections.singletonList(new ProductFieldHistory(FIELD, OLD_VALUE, NEW_VALUE)));
    Mockito.when(getProductChangeUtil().getCategoryIds(product, product))
        .thenReturn(categoryIds);
    Mockito.when(productLevel3Service.isPristineCategory(ID)).thenReturn(false);
    Mockito.when(productChangeUtil.isDimensionFieldsChanged(Mockito.anyList()))
        .thenReturn(true);
    Mockito
        .when(productBusinessPartnerService.getProductTypeBasedOnProductId(productCollections.get(0).getProductId()))
        .thenReturn(1);

    getProductServiceBean().update(product, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS);

    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductChangeUtil()).getCategoryIds(product, product);
    Mockito.verify(productLevel3Service).isPristineCategory(ID);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, false, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).save(productHistory);
    Mockito.verify(getProductChangeUtil(), AT_LEAST_ONE).getProductDiff(any(Product.class), any(Product.class));
    Mockito.verify(productStatusPublisherService)
        .publishSolrProductCollectionUpdateEvent(Mockito.any(SolrProductCollectionDTO.class));
    Mockito.verify(productChangeUtil).isDimensionFieldsChanged(Mockito.anyList());
  }

  @Test
  public void testUpdateDimensionForReviewPendingProductFalse() throws Exception {
    ProductItem productItem = new ProductItem();
    productItem.setActivated(true);
    Product product = getProduct();
    product.setViewable(true);
    product.setActivated(true);
    product.setProductItems(Arrays.asList(productItem));
    SolrProductCollectionUpdateEvent solrProductCollectionUpdateEvent =
        new SolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(new ArrayList<ProductBusinessPartner>());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_EDIT,
        ProductWorkflowLookup.STATE_EDIT_DESCRIPTION, ProductWorkflowLookup.STATE_EDIT_DESCRIPTION,
        product.getUpdatedBy(), product.getUpdatedDate(), product.getStoreId());
    productCollections.get(0).setReviewPending(false);

    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito
        .when(productStatusPublisherService.publishSolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO()))
        .thenReturn(solrProductCollectionUpdateEvent);

    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductHistoryRepository().save(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductChangeUtil().getProductDiff(product, product))
        .thenReturn(Collections.singletonList(new ProductFieldHistory(FIELD, OLD_VALUE, NEW_VALUE)));
    Mockito.when(getProductChangeUtil().getCategoryIds(product, product))
        .thenReturn(categoryIds);
    Mockito.when(productLevel3Service.isPristineCategory(ID)).thenReturn(false);

    getProductServiceBean().update(product, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS);

    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductChangeUtil()).getCategoryIds(product, product);
    Mockito.verify(productLevel3Service).isPristineCategory(ID);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, false, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).save(productHistory);
    Mockito.verify(getProductChangeUtil(), AT_LEAST_ONE).getProductDiff(any(Product.class), any(Product.class));
    Mockito.verify(productStatusPublisherService)
        .publishSolrProductCollectionUpdateEvent(Mockito.any(SolrProductCollectionDTO.class));
  }

  @Test
  public void testUpdateDimensionForReviewPendingProductTrue() throws Exception {
    ProductItem productItem = new ProductItem();
    productItem.setActivated(true);
    Product product = getProduct();
    product.setViewable(true);
    product.setActivated(true);
    product.setProductItems(Arrays.asList(productItem));
    SolrProductCollectionUpdateEvent solrProductCollectionUpdateEvent =
        new SolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO());
    product.getProductCategories()
        .add(new ProductCategory(product, new Category(DEFAULT_STORE_ID, "Kategori 1", 0), DEFAULT_STORE_ID));
    Page<ProductBusinessPartner> productBusinessPartnerPage =
        new PageImpl<ProductBusinessPartner>(new ArrayList<ProductBusinessPartner>());
    ProductHistory productHistory = new ProductHistory(product.getId(), ProductWorkflowLookup.STATE_EDIT,
        ProductWorkflowLookup.STATE_EDIT_DESCRIPTION, ProductWorkflowLookup.STATE_EDIT_DESCRIPTION,
        product.getUpdatedBy(), product.getUpdatedDate(), product.getStoreId());
    productCollections.get(0).setReviewPending(true);

    Mockito.when(getProductRepository().findOne(product.getId())).thenReturn(product);
    Mockito
        .when(productStatusPublisherService.publishSolrProductCollectionUpdateEvent(generateSolrProductCollectionDTO()))
        .thenReturn(solrProductCollectionUpdateEvent);

    Mockito.when(getProductBusinessPartnerRepository()
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any())).thenReturn(productBusinessPartnerPage);
    Mockito.when(getProductHistoryRepository().save(productHistory)).thenReturn(productHistory);
    Mockito.when(getProductChangeUtil().getProductDiff(product, product))
        .thenReturn(Collections.singletonList(new ProductFieldHistory(FIELD, OLD_VALUE, NEW_VALUE)));
    Mockito.when(getProductChangeUtil().getCategoryIds(product, product))
        .thenReturn(categoryIds);
    Mockito.when(productLevel3Service.isPristineCategory(ID)).thenReturn(false);
    Mockito.when(productChangeUtil.isDimensionFieldsChanged(Mockito.anyList()))
        .thenReturn(false);

    getProductServiceBean().update(product, NOTES, DEFAULT_BRAND_CODE, DEFAULT_BRAND_APPROVAL_STATUS);

    Mockito.verify(getProductRepository(), AT_LEAST_ONE).findOne(product.getId());
    Mockito.verify(getProductChangeUtil()).getCategoryIds(product, product);
    Mockito.verify(productLevel3Service).isPristineCategory(ID);
    Mockito.verify(getProductRepository(), AT_LEAST_ONE).update(product, false, false, true, false, new ArrayList<>(),
        new HashedMap(), new ArrayList<>(), false, false, new ArrayList<>(), new ProductL3Response(), EditProductResponse.builder().build());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductCode(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString());
    Mockito.verify(getProductCollectionRepository(), AT_LEAST_ONE).save((ProductCollection) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_ONE)
        .findByStoreIdAndProductIdAndMarkForDeleteFalse(Mockito.eq(DEFAULT_STORE_ID), Mockito.anyString(),
            (Pageable) Mockito.any());
    Mockito.verify(getProductBusinessPartnerRepository(), AT_LEAST_NONE).saveAll(productBusinessPartnerPage);
    Mockito.verify(getProductHistoryRepository(), AT_LEAST_ONE).save(productHistory);
    Mockito.verify(getProductChangeUtil(), AT_LEAST_ONE).getProductDiff(any(Product.class), any(Product.class));
    Mockito.verify(productStatusPublisherService)
        .publishSolrProductCollectionUpdateEvent(Mockito.any(SolrProductCollectionDTO.class));
    Mockito.verify(productChangeUtil).isDimensionFieldsChanged(Mockito.anyList());
  }

  @Test
  public void updateForBulkDimensionUpdateTest() throws Exception {
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    simpleMasterProductUpdateResponse.setDimensionOrDgLevelUpdated(true);
    productCollection.setReviewPending(true);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString()))
        .thenReturn(profileResponse);
    when(productRepository.updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO))
        .thenReturn(simpleMasterProductUpdateResponse);
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(SHIPPING_WEIGHT);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    assertNotNull(response);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO);
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(Mockito.anyString());
    assertEquals(SHIPPING_WEIGHT, simpleMasterProductUpdateRequestDTO.getShippingWeight());
    assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
    assertTrue(response.getUpdateSuccess());
  }

  @Test
  public void updateForBulkReviewPendingTrueTest() throws Exception {
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    simpleMasterProductUpdateResponse.setDimensionOrDgLevelUpdated(false);
    productCollection.setReviewPending(true);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString()))
        .thenReturn(profileResponse);
    when(productRepository.updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO))
        .thenReturn(simpleMasterProductUpdateResponse);
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(SHIPPING_WEIGHT);
    when(productBusinessPartnerService.getProductTypeBasedOnProductId(Mockito.anyString())).thenReturn(1);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    assertNotNull(response);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(Mockito.anyString());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO);
    assertEquals(SHIPPING_WEIGHT, simpleMasterProductUpdateRequestDTO.getShippingWeight());
    assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
    assertTrue(response.getUpdateSuccess());
  }

  @Test
  public void updateForBulkReviewPendingFalseTest() throws Exception {
    SimpleMasterProductUpdateResponse simpleMasterProductUpdateResponse =
        new SimpleMasterProductUpdateResponse.Builder().productCode(DEFAULT_PRODUCT_CODE).updateSuccess(Boolean.TRUE)
            .build();
    simpleMasterProductUpdateResponse.setDimensionOrDgLevelUpdated(true);
    productCollection.setReviewPending(false);
    when(businessPartnerRepository.filterDetailByBusinessPartnerCode(anyString()))
        .thenReturn(profileResponse);
    when(productRepository.updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO))
        .thenReturn(simpleMasterProductUpdateResponse);
    when(generatorService.generateShippingWeight(anyDouble(), anyDouble(), anyDouble(), anyDouble(), anyString()))
        .thenReturn(SHIPPING_WEIGHT);
    when(productBusinessPartnerService.getProductTypeBasedOnProductId(Mockito.anyString())).thenReturn(1);
    SimpleMasterProductUpdateResponse response =
        productServiceBean.updateForBulk(simpleMasterProductUpdateRequestDTO, STORE_ID, productCollection);
    assertNotNull(response);
    verify(generatorService).generateShippingWeight(LENGTH, WIDTH, HEIGHT, WEIGHT, productCollection.getCategoryCode());
    verify(productBusinessPartnerService).getProductTypeBasedOnProductId(Mockito.anyString());
    verify(productRepository).updateSimpleMasterProduct(simpleMasterProductUpdateRequestDTO);
    assertEquals(SHIPPING_WEIGHT, simpleMasterProductUpdateRequestDTO.getShippingWeight());
    assertEquals(DEFAULT_PRODUCT_CODE, response.getProductCode());
    assertTrue(response.getUpdateSuccess());
  }

  @Test
  public void fetchCogsValueByMaterialCodeTest() {
    productServiceBean.fetchCogsValueByMaterialCode(DEFAULT_STORE_ID, ITEM_SKU);
    verify(productLevel3Service).fetchCogsValueByMaterialCode(ITEM_SKU);
  }

  @Test
  public void processImageQcForBacklogProductsTest() {
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    String response = productServiceBean.processImageQcForBacklogProducts(STORE_ID, imageQcResponseDomainEvent);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    Assertions.assertEquals(PREDICTION_DISPLAY_NAME_2, response);
  }

  @Test
  public void processImageQcForBacklogProductsMarkForDeleteTest() {
    productImagePredictionNsfw.setMarkForDelete(true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
        .thenReturn(productImagePredictionNsfw);
    String response = productServiceBean.processImageQcForBacklogProducts(STORE_ID, imageQcResponseDomainEvent);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    Assertions.assertEquals(StringUtils.EMPTY, response);
  }

  @Test
  public void processImageQcForBacklogProductsMarkForDeleteNullTest() {
    productImagePredictionNsfw.setMarkForDelete(true);

    String response = productServiceBean.processImageQcForBacklogProducts(STORE_ID, imageQcResponseDomainEvent);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    Assertions.assertEquals(StringUtils.EMPTY, response);
  }

  @Test
  public void updatePbpProductWorkflowStateTest() {
    this.productServiceBean.updatePbpProductWorkflowState(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE,
      STATE);
    Mockito.verify(this.productWfService)
      .deleteAllExistingWorkFlowAndCreateNewState(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE, STATE);
  }

  @Test
  public void editPriceStockVariantsInfoTest() throws Exception {
    ProductLevel3 productLevel3 = new ProductLevel3();
    productLevel3.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    productServiceBean.editPriceStockVariantsInfo(STORE_ID, productLevel3, new ProductVariantUpdateRequest(),
        new EditProductResponse(), true);
    Mockito.verify(productLevel3Service)
        .editProductItemsPriceStockImagesL5(STORE_ID, BUSINESS_PARTNER_ID, new ProductVariantUpdateRequest(),
            new EditProductResponse(), productLevel3, true);
  }

  @Test
  public void editPriceStockVariantsInfoPublishImageQcFalseTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enablePriceUpdateInImageQcRequest", true);
    ProductLevel3 productLevel3 = new ProductLevel3();
    productLevel3.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse = new ItemsPriceStockImagesUpdateResponse();
    itemsPriceStockImagesUpdateResponse.setNewImagesAdded(false);
    EditProductResponse editProductResponse = new EditProductResponse();
    editProductResponse.setPublishImageQcForContentChange(true);
    Mockito.when(productLevel3Service
        .editProductItemsPriceStockImagesL5(STORE_ID, productLevel3.getBusinessPartnerCode(),
            new ProductVariantUpdateRequest(), editProductResponse, productLevel3,
          true)).thenReturn(itemsPriceStockImagesUpdateResponse);
    Mockito.when(xProductOutbound.getMinAndMaxOfferPrice(any())).thenReturn(new MinMaxItemPriceResponse());
    productServiceBean.editPriceStockVariantsInfo(STORE_ID, productLevel3, new ProductVariantUpdateRequest(),
        editProductResponse, true);
    Mockito.verify(productLevel3Service)
        .editProductItemsPriceStockImagesL5(STORE_ID, BUSINESS_PARTNER_ID, new ProductVariantUpdateRequest(),
            editProductResponse, productLevel3, true);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Mockito.verify(xProductOutbound).getMinAndMaxOfferPrice(any());
  }

  @Test
  public void editPriceStockVariantsInfoPublishImageQcFalsePostTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "enablePriceUpdateInImageQcRequest", true);
    ProductLevel3 productLevel3 = new ProductLevel3();
    productLevel3.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse = new ItemsPriceStockImagesUpdateResponse();
    itemsPriceStockImagesUpdateResponse.setNewImagesAdded(false);
    EditProductResponse editProductResponse = new EditProductResponse();
    editProductResponse.setCategoryResponses(Arrays.asList(new CategoryResponse()));
    editProductResponse.setPublishImageQcForContentChange(true);
    Mockito.when(
        productLevel3Service.editProductItemsPriceStockImagesL5(STORE_ID, productLevel3.getBusinessPartnerCode(),
            new ProductVariantUpdateRequest(), editProductResponse, productLevel3, true)).thenReturn(itemsPriceStockImagesUpdateResponse);
    Mockito.when(xProductOutbound.getMinAndMaxOfferPrice(any())).thenReturn(new MinMaxItemPriceResponse());
    productServiceBean.editPriceStockVariantsInfo(STORE_ID, productLevel3, new ProductVariantUpdateRequest(),
        editProductResponse, true);
    Mockito.verify(productLevel3Service)
        .editProductItemsPriceStockImagesL5(STORE_ID, BUSINESS_PARTNER_ID, new ProductVariantUpdateRequest(),
            editProductResponse, productLevel3, true);
    Mockito.verify(kafkaProducer)
        .send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(), Mockito.any());
    Mockito.verify(xProductOutbound).getMinAndMaxOfferPrice(any());
  }

  @Test
  public void editPriceStockVariantsInfoPublishImageQcTest() throws Exception {
    ProductLevel3 productLevel3 = new ProductLevel3();
    productLevel3.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ItemsPriceStockImagesUpdateResponse itemsPriceStockImagesUpdateResponse = new ItemsPriceStockImagesUpdateResponse();
    itemsPriceStockImagesUpdateResponse.setNewImagesAdded(true);
    EditProductResponse editProductResponse = new EditProductResponse();
    editProductResponse.setPublishImageQcForContentChange(true);
    Mockito.when(productLevel3Service
        .editProductItemsPriceStockImagesL5(STORE_ID, productLevel3.getBusinessPartnerCode(),
            new ProductVariantUpdateRequest(), editProductResponse, productLevel3,
          true)).thenReturn(itemsPriceStockImagesUpdateResponse);
    productServiceBean.editPriceStockVariantsInfo(STORE_ID, productLevel3, new ProductVariantUpdateRequest(),
        editProductResponse, true);
    Mockito.verify(productLevel3Service)
        .editProductItemsPriceStockImagesL5(STORE_ID, BUSINESS_PARTNER_ID, new ProductVariantUpdateRequest(),
            editProductResponse, productLevel3, true);
  }

  @Test
  public void publishImageQcBacklogRequestEventTest() {
    productServiceBean.publishImageQcBacklogRequestEvent(imageQcResponseDomainEvent);
    Mockito.verify(kafkaProducer).send(DomainEventName.IMAGE_QC_PREDICTION_BACKLOG_REQUEST, imageQcResponseDomainEvent.getProductCode(),
        imageQcResponseDomainEvent);
  }

  @Test
  public void deleteProductInSolrProductCollectionByIdsTest() throws Exception {
    List<String> ids = new ArrayList<>();
    ids.add(ID);
    this.productServiceBean.deleteProductInSolrProductCollectionByIds(ids);
    SolrProductCollectionUpdateEvent response =
        CommonUtils.getSolrProductCollectionUpdateEvent(ID);
    Mockito.verify(kafkaProducer)
        .send(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE, ID, response);
  }

  @Test
  public void deleteProductInSolrProductCollectionByIdsExceptionTest() throws Exception {
    List<String> ids = new ArrayList<>();
    ids.add(ID);
    Mockito.doThrow(ApplicationRuntimeException.class).when(kafkaProducer)
        .send(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE, ID, solrProductCollectionUpdateEvent);
    this.productServiceBean.deleteProductInSolrProductCollectionByIds(ids);
    SolrProductCollectionUpdateEvent response =
        CommonUtils.getSolrProductCollectionUpdateEvent(ID);
    Mockito.verify(kafkaProducer)
        .send(DomainEventName.SOLR_PRODUCT_COLLECTION_UPDATE, ID, response);
  }

  @Test
  public void deleteProductInSolrProductCollectionByIdsListEmptyTest() throws Exception {
    List<String> ids = new ArrayList<>();
    assertThrows(ApplicationRuntimeException.class, () -> {
      this.productServiceBean.deleteProductInSolrProductCollectionByIds(ids);
    });
  }

  @Test
  public void deleteProductInSolrProductCollectionByIdsEmptyTest() throws Exception {
    List<String> ids = new ArrayList<>();
    ids.add(StringUtils.EMPTY);
    this.productServiceBean.deleteProductInSolrProductCollectionByIds(ids);
  }

  @Test
  public void saveProductCollectionForUPCTest() {
    Mockito.when(productCollectionRepository.save(productCollection)).thenReturn(productCollection);
    this.productServiceBean.saveProductCollectionForUPC(productCollection);
    Mockito.verify(productCollectionRepository).save(productCollection);
  }

  @Test
  public void validatePickupPointsValidateFalseTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", false);
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, new ProductCreationRequest(), new ProfileResponse(),
        new HashMap<>());
  }

  @Test
  public void validatePickupPointsBpCodeNullTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "ranchIntegrationEnabled", true);
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, new ProductCreationRequest(), new ProfileResponse(),
        new HashMap<>());
  }

  @Test
  public void validatePickupPointsBpCodeInternalTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(Constants.INTERNAL);
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, new ProfileResponse(),
        new HashMap<>());
  }

  @Test
  public void validatePickupPointsBpCodeNotInternalTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, new ProfileResponse(),
            new HashMap<>());
      });
    } finally {
      Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, new ArrayList<>());
    }
  }

  @Test
  public void validatePickupPointsPPCodeNotEmptyTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
        new HashMap<>());
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
  }

  @Test
  public void validatePickupPointsPPCodeNotEmptyWaitingDeletionTrueTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "setWaitingDeletionForDeletePickupPoint", true);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
        new HashMap<>());
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
  }

  @Test
  public void validatePickupPointsFbbTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
        new HashMap<>());
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
  }

  @Test
  public void validatePickupPointsRanchTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "ranchIntegrationEnabled", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    Set<String> set = new HashSet<>();
    set.add(DEFAULT_BUSINESS_PARTNER_CODE);
    ReflectionTestUtils.setField(productServiceBean, "distributionSellerList", set);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
        new HashMap<>());
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
  }

  @Test
  public void validatePickupPointsRanchSellerSkuTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "ranchIntegrationEnabled", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    Set<String> set = new HashSet<>();
    set.add(DEFAULT_BUSINESS_PARTNER_CODE);
    ReflectionTestUtils.setField(productServiceBean, "distributionSellerList", set);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    productItemCreationRequest.setMerchantSku(MERCHANT_SKU);
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(
        Arrays.asList(productItemCreationRequest, new ProductItemCreationRequest()));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
        new HashMap<>());
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
    Mockito.verify(productOutbound).getOmniChannelSkuToItemCode(productCreationRequest.getBusinessPartnerCode(),
        new ArrayList<>(Collections.singleton(MERCHANT_SKU)));
    Mockito.verify(distributionInfoServiceBean).validateDuplicateOmniChannelSku(Mockito.anyMap(),
        Mockito.anyMap(), eq(productItemCreationRequest.getMerchantSku()), eq(StringUtils.EMPTY));
  }

  @Test
  public void validatePickupPointsRanchSellerSkuWithDistributionPPCodeTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "ranchIntegrationEnabled", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    Set<String> set = new HashSet<>();
    set.add(DEFAULT_BUSINESS_PARTNER_CODE);
    ReflectionTestUtils.setField(productServiceBean, "distributionSellerList", set);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Map<String, String> distributionInfoRequest = new HashMap<>();
    distributionInfoRequest.put(PRODUCT_CODE, PRODUCT_ID);
    productCreationRequest.setDistributionInfoRequest(distributionInfoRequest);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    DistributionItemRequest distributionItemRequest = new DistributionItemRequest();
    distributionItemRequest.setOmniChannelSku(PRODUCT_SKU);
    productItemCreationRequest.setDistributionItemInfoRequest(distributionItemRequest);
    DimensionAndUomRequest dimensionAndUomRequest = new DimensionAndUomRequest();
    dimensionAndUomRequest.setUomType(PRODUCT_ID);
    productItemCreationRequest.setDimensionsAndUOMRequest(Collections.singletonList(dimensionAndUomRequest));
    productItemCreationRequest.setMerchantSku(MERCHANT_SKU);
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    Map<String, Object> stringObjectMap = new HashMap<>();
    stringObjectMap.put(Constants.DISTRIBUTION_FLAG_KEY, Boolean.TRUE);
    pickupPointResponse.setFlags(stringObjectMap);
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
        new HashMap<>());
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
    Mockito.verify(distributionInfoServiceBean)
        .validateDistributionInfoUpdateRequest(Mockito.any(), Mockito.any(), Mockito.any());
    Mockito.verify(productOutbound).getOmniChannelSkuToItemCode(productCreationRequest.getBusinessPartnerCode(),
        new ArrayList<>(Collections.singleton(MERCHANT_SKU)));
    Assertions.assertNotNull(restrictedKeywordsByFieldAndActionType);
  }

  @Test
  public void validatePickupPointsRanchSellerSkuWithDistributionInfoNullCodeTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "ranchIntegrationEnabled", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    Set<String> set = new HashSet<>();
    set.add(DEFAULT_BUSINESS_PARTNER_CODE);
    ReflectionTestUtils.setField(productServiceBean, "distributionSellerList", set);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    DistributionItemRequest distributionItemRequest = new DistributionItemRequest();
    distributionItemRequest.setOmniChannelSku(PRODUCT_SKU);
    productItemCreationRequest.setDistributionItemInfoRequest(distributionItemRequest);
    DimensionAndUomRequest dimensionAndUomRequest = new DimensionAndUomRequest();
    dimensionAndUomRequest.setUomType(PRODUCT_ID);
    productItemCreationRequest.setDimensionsAndUOMRequest(Collections.singletonList(dimensionAndUomRequest));
    productItemCreationRequest.setMerchantSku(MERCHANT_SKU);
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    Map<String, Object> stringObjectMap = new HashMap<>();
    stringObjectMap.put(Constants.DISTRIBUTION_FLAG_KEY, Boolean.TRUE);
    pickupPointResponse.setFlags(stringObjectMap);
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    Assertions.assertThrows(ApiGenericException.class, () -> {
      productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
          new HashMap<>());
    });
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
    Assertions.assertNotNull(restrictedKeywordsByFieldAndActionType);
  }

  @Test
  public void validatePickupPointsRanchSellerSkuWithDistributionItemInfoNullCodeTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "ranchIntegrationEnabled", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    Set<String> set = new HashSet<>();
    set.add(DEFAULT_BUSINESS_PARTNER_CODE);
    ReflectionTestUtils.setField(productServiceBean, "distributionSellerList", set);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Map<String, String> distributionInfoRequest = new HashMap<>();
    distributionInfoRequest.put(PRODUCT_CODE, PRODUCT_ID);
    productCreationRequest.setDistributionInfoRequest(distributionInfoRequest);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    DimensionAndUomRequest dimensionAndUomRequest = new DimensionAndUomRequest();
    dimensionAndUomRequest.setUomType(PRODUCT_ID);
    productItemCreationRequest.setDimensionsAndUOMRequest(Collections.singletonList(dimensionAndUomRequest));
    productItemCreationRequest.setMerchantSku(MERCHANT_SKU);
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    Map<String, Object> stringObjectMap = new HashMap<>();
    stringObjectMap.put(Constants.DISTRIBUTION_FLAG_KEY, Boolean.TRUE);
    pickupPointResponse.setFlags(stringObjectMap);
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    Assertions.assertThrows(ApiGenericException.class, () -> {
      productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
          new HashMap<>());
    });
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
    Assertions.assertNotNull(restrictedKeywordsByFieldAndActionType);
  }

  @Test
  public void validatePickupPointsRanchSellerSkuWithDistributionItemUomInfoNullCodeTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "ranchIntegrationEnabled", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    Set<String> set = new HashSet<>();
    set.add(DEFAULT_BUSINESS_PARTNER_CODE);
    ReflectionTestUtils.setField(productServiceBean, "distributionSellerList", set);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Map<String, String> distributionInfoRequest = new HashMap<>();
    distributionInfoRequest.put(PRODUCT_CODE, PRODUCT_ID);
    productCreationRequest.setDistributionInfoRequest(distributionInfoRequest);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    DistributionItemRequest distributionItemRequest = new DistributionItemRequest();
    distributionItemRequest.setOmniChannelSku(PRODUCT_SKU);
    productItemCreationRequest.setDistributionItemInfoRequest(distributionItemRequest);
    productItemCreationRequest.setMerchantSku(MERCHANT_SKU);
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    Map<String, Object> stringObjectMap = new HashMap<>();
    stringObjectMap.put(Constants.DISTRIBUTION_FLAG_KEY, Boolean.TRUE);
    pickupPointResponse.setFlags(stringObjectMap);
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    Assertions.assertThrows(ApiGenericException.class, () -> {
      productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
          new HashMap<>());
    });
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
    Assertions.assertNotNull(restrictedKeywordsByFieldAndActionType);
  }

  @Test
  public void validatePickupPointsRanchSellerSkuWithDistributionItemInfoNullTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "ranchIntegrationEnabled", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    Set<String> set = new HashSet<>();
    set.add(DEFAULT_BUSINESS_PARTNER_CODE);
    ReflectionTestUtils.setField(productServiceBean, "distributionSellerList", set);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Map<String, String> distributionInfoRequest = new HashMap<>();
    distributionInfoRequest.put(PRODUCT_CODE, PRODUCT_ID);
    productCreationRequest.setDistributionInfoRequest(distributionInfoRequest);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    DimensionAndUomRequest dimensionAndUomRequest = new DimensionAndUomRequest();
    dimensionAndUomRequest.setUomType(PRODUCT_ID);
    productItemCreationRequest.setDimensionsAndUOMRequest(Collections.singletonList(dimensionAndUomRequest));
    productItemCreationRequest.setMerchantSku(MERCHANT_SKU);
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    Map<String, Object> stringObjectMap = new HashMap<>();
    stringObjectMap.put(Constants.DISTRIBUTION_FLAG_KEY, Boolean.TRUE);
    pickupPointResponse.setFlags(stringObjectMap);
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    Assertions.assertThrows(ApiGenericException.class, () -> {
      productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
          new HashMap<>());
    });
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
    Assertions.assertNotNull(restrictedKeywordsByFieldAndActionType);
  }

  @Test
  public void validatePickupPointsRanchSwitchOffTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "ranchIntegrationEnabled", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    Set<String> set = new HashSet<>();
    set.add(PRODUCT_CODE);
    ReflectionTestUtils.setField(productServiceBean, "distributionSellerList", set);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
        new HashMap<>());
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
  }

  @Test
  public void validatePickupPointsFbbMoreThan1FbbTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    ProfileResponse businessPartner = new ProfileResponse();
    businessPartner.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Arrays.asList(pickupPointCreateRequest, pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setFbbActivated(true);
    pickupPointResponse.setBusinessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, businessPartner,
            new HashMap<>());
      });
    } finally {
      Mockito.verify(pickupPointOutbound)
          .getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
    }
  }

  @Test
  public void validatePickupPointsPickupFbbTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", false);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    pickupPointCreateRequest.setFbbActivated(true);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setFbbActivated(true);
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setFbbActivated(true);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, profileResponse,
        new HashMap<>());
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
  }

  @Test
  public void validatePickupPointsPickupFbb2Test() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", false);
    ReflectionTestUtils.setField(productServiceBean, "validateCreateRequestForFbb", true);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setCode(PICKUP_POINT_CODE);
    pickupPointResponse.setFbbActivated(true);
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setFbbActivated(true);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, profileResponse,
        new HashMap<>());
    Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
    Assertions.assertTrue(productCreationRequest.getProductItemRequests().get(0).getPickupPoints().get(0).isFbbActivated());
  }

  @Test
  public void validatePickupPointsPPCodeArchivedTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    productItemCreationRequest.setPickupPoints(Collections.singletonList(pickupPointCreateRequest));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setArchived(true);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, new ProfileResponse(),
            new HashMap<>());
      });
    } finally {
      Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Collections.singletonList(PICKUP_POINT_CODE));
    }
  }

  @Test
  public void validatePickupPointsSizeMismatchTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "validatePickupPoints", true);
    ProductCreationRequest productCreationRequest = new ProductCreationRequest();
    productCreationRequest.setBusinessPartnerCode(BUSINESS_PARTNER_ID);
    ProductItemCreationRequest productItemCreationRequest = new ProductItemCreationRequest();
    PickupPointCreateRequest pickupPointCreateRequest = new PickupPointCreateRequest();
    pickupPointCreateRequest.setPickupPointId(PICKUP_POINT_CODE);
    PickupPointCreateRequest pickupPointCreateRequest1 = new PickupPointCreateRequest();
    pickupPointCreateRequest1.setPickupPointId(REQUEST_ID);
    productItemCreationRequest.setPickupPoints(Arrays.asList(pickupPointCreateRequest, pickupPointCreateRequest1));
    productCreationRequest.setProductItemRequests(Collections.singletonList(productItemCreationRequest));
    PickupPointResponse pickupPointResponse = new PickupPointResponse();
    pickupPointResponse.setArchived(true);
    Mockito.when(pickupPointOutbound.getByPickupPointCodes(REQUEST_ID, Arrays.asList(PICKUP_POINT_CODE, REQUEST_ID)))
        .thenReturn(Collections.singletonList(pickupPointResponse));
    try {
      Assertions.assertThrows(ApplicationRuntimeException.class, () -> {
        productServiceBean.validatePickupPointsAndFbb(REQUEST_ID, productCreationRequest, new ProfileResponse(),
            new HashMap<>());
      });
    } finally {
      Mockito.verify(pickupPointOutbound).getByPickupPointCodes(REQUEST_ID, Arrays.asList(PICKUP_POINT_CODE, REQUEST_ID));
    }
  }

  @Test
  public void publishProductStatusEventByProductCodeTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    productDetailResponse.setProductItemResponses(new HashSet<>());
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(productDetailResponse);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, productCollection.getProductId()))
        .thenReturn(Arrays.asList(productBusinessPartner));
    productServiceBean.publishProductStatusEventByProductCode(PRODUCT_CODE, ProductStatus.ACTIVE, null);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(productCollection.getStoreId(),
            productCollection.getProductId());
  }

  @Test
  public void publishProductStatusEventByProductCodeNeedRevisionWithReasonTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    productDetailResponse.setProductItemResponses(new HashSet<>());
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(productDetailResponse);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, productCollection.getProductId()))
        .thenReturn(Arrays.asList(productBusinessPartner));
    productServiceBean.publishProductStatusEventByProductCode(PRODUCT_CODE, ProductStatus.NEED_CORRECTION, NOTES);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(productCollection.getStoreId(),
        productCollection.getProductId());
  }

  @Test
  public void publishProductStatusEventByProductCodeNeedRevisionTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    productDetailResponse.setProductItemResponses(new HashSet<>());
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(productDetailResponse);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, productCollection.getProductId()))
        .thenReturn(Arrays.asList(productBusinessPartner));
    productServiceBean.publishProductStatusEventByProductCode(PRODUCT_CODE, ProductStatus.NEED_CORRECTION, null);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(productCollection.getStoreId(),
        productCollection.getProductId());
    Mockito.verify(productHistoryRepository).findTop1ByStoreIdAndProductIdAndMarkForDeleteFalseAndDescriptionOrderByCreatedDateDesc(
        productCollection.getStoreId(), productCollection.getProductId(), WorkflowProcessCode.RETURN_FOR_CORRECTION.getDesc());
  }

  @Test
  public void publishProductStatusEventByProductCodeNeedRevisionRanchTest() throws Exception {
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "ranchIntegrationEnabled", true);
    productDetailResponse.setProductItemResponses(new HashSet<>());
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(productDetailResponse);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE))
        .thenReturn(productCollection);
    productBusinessPartner.getProductItemBusinessPartners().get(0).setDistribution(true);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, productCollection.getProductId()))
        .thenReturn(Arrays.asList(productBusinessPartner));
    productServiceBean.publishProductStatusEventByProductCode(PRODUCT_CODE, ProductStatus.NEED_CORRECTION, null);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(productCollection.getStoreId(),
        productCollection.getProductId());
    Mockito.verify(productHistoryRepository).findTop1ByStoreIdAndProductIdAndMarkForDeleteFalseAndDescriptionOrderByCreatedDateDesc(
        productCollection.getStoreId(), productCollection.getProductId(), WorkflowProcessCode.RETURN_FOR_CORRECTION.getDesc());
  }

  @Test
  public void publishProductStatusEventByProductCodeNeedRevisionWithHistoryUpdateTest() throws Exception {
    productHistory.setNotes(NOTES);
    ReflectionTestUtils.setField(getProductServiceBean(), "productStatusEventEnabled", true);
    productDetailResponse.setProductItemResponses(new HashSet<>());
    Mockito.when(productRepository.findProductDetailByProductCode(PRODUCT_CODE, false)).thenReturn(productDetailResponse);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE))
        .thenReturn(productCollection);
    Mockito.when(productBusinessPartnerRepository.findByStoreIdAndProductId(STORE_ID, productCollection.getProductId()))
        .thenReturn(Arrays.asList(productBusinessPartner));
    Mockito.when(productHistoryRepository.findTop1ByStoreIdAndProductIdAndMarkForDeleteFalseAndDescriptionOrderByCreatedDateDesc(productCollection.getStoreId(),
        productCollection.getProductId(), WorkflowProcessCode.RETURN_FOR_CORRECTION.getDesc())).thenReturn(productHistory);
    productServiceBean.publishProductStatusEventByProductCode(PRODUCT_CODE, ProductStatus.NEED_CORRECTION, null);
    Mockito.verify(productRepository).findProductDetailByProductCode(PRODUCT_CODE, false);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(productDetailResponse.getStoreId(), PRODUCT_CODE);
    Mockito.verify(productBusinessPartnerRepository).findByStoreIdAndProductId(productCollection.getStoreId(),
        productCollection.getProductId());
    Mockito.verify(productHistoryRepository).findTop1ByStoreIdAndProductIdAndMarkForDeleteFalseAndDescriptionOrderByCreatedDateDesc(
        productCollection.getStoreId(), productCollection.getProductId(), WorkflowProcessCode.RETURN_FOR_CORRECTION.getDesc());
  }

  @Test
  public void getProductCollectionByProductSkuTest() {
    Mockito.when(productCollectionRepository.findProductByGdnSku(PRODUCT_SKU)).thenReturn(productCollection);
    productServiceBean.getProductCollectionByProductSku(PRODUCT_SKU);
    Mockito.verify(productCollectionRepository).findProductByGdnSku(PRODUCT_SKU);
  }
  @Test
  public void fetchProductsToSyncTest() {
    Date startDate = new Date();
    Date endDate = new Date();

    Mockito.when(productCollectionRepository
      .findByStoreIdAndUpdatedDateBetweenAndMarkForDeleteFalse(STORE_ID, startDate, endDate))
      .thenReturn(Arrays.asList(productCollection));
    List<ProductCollection> list =
      productServiceBean.fetchProductsToSync(STORE_ID, startDate, endDate);
    Mockito.verify(productCollectionRepository)
      .findByStoreIdAndUpdatedDateBetweenAndMarkForDeleteFalse(STORE_ID, startDate, endDate);
    Assertions.assertNotNull(list);
  }

  @Test
  public void fetchActiveProductsToSyncTest() {
    Date startDate = new Date();
    Date endDate = new Date();
    Mockito.when(
            productCollectionRepository.findByStoreIdAndStateAndReviewPendingFalseAndUpdatedDateBetweenAndMarkForDeleteFalse(
                STORE_ID, WorkflowStates.ACTIVE.getValue(), startDate, endDate, pageable))
        .thenReturn(productCollectionPage);
    Page<ProductCollection> productCollectionPage1 =
        productServiceBean.fetchActiveProductsToSync(STORE_ID, startDate, endDate, pageable);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndStateAndReviewPendingFalseAndUpdatedDateBetweenAndMarkForDeleteFalse(STORE_ID,
            WorkflowStates.ACTIVE.getValue(), startDate, endDate, pageable);
    Assertions.assertEquals(productCollectionPage1, productCollectionPage);
  }

  @Test
  public void fetchPreLiveProductsToSyncTest() {
    Date date = new Date();
    productServiceBean.fetchPreLiveProductsToSync(STORE_ID, IN_PROGRESS, false, false, 0, date, date, pageable);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndStateAndPostLiveAndEditedAndResubmitCountAndImageResizedTrueAndUpdatedDateBetweenAndMarkForDeleteFalse(
            STORE_ID, IN_PROGRESS, false, false, 0, date, date, pageable);
  }

  @Test
  public void updateHistoryOnAttributeAutoFillTest() {
    AttributeHistoryResponse attributeHistoryResponse = new AttributeHistoryResponse(ATTRIBUTE_NAME, ATTRIBUTE_VALUE);
    Mockito.when(productHistoryRepository.save(productHistoryArgumentCaptor.capture())).thenReturn(productHistory);
    productServiceBean.updateHistoryOnAttributeAutoFill(DEFAULT_STORE_ID, PRODUCT_ID,
        Arrays.asList(attributeHistoryResponse));
    Mockito.verify(productHistoryRepository).save(productHistoryArgumentCaptor.getValue());
  }

  @Test
  public void reindexActiveProductCollectionByStoreIdAndProductCodeTest() {
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE))
        .thenReturn(productCollection);
    productServiceBean.reindexActiveProductCollectionByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).findByStoreIdAndProductCode(DEFAULT_STORE_ID, PRODUCT_CODE);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductType1() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.TRUE);
    profileResponse.setBopisFlag(Boolean.FALSE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(1, profileResponse);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductTypeNullAndProfileNotNull() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.TRUE);
    profileResponse.setBopisFlag(Boolean.FALSE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(null, profileResponse);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductTypeNotNullAndProfileNull() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.TRUE);
    profileResponse.setBopisFlag(Boolean.FALSE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(1, null);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductType2AndBPTrueBopisFalse() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.TRUE);
    profileResponse.setBopisFlag(Boolean.FALSE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(2, profileResponse);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductType2AndBPFalseBopisTrue() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.FALSE);
    profileResponse.setBopisFlag(Boolean.TRUE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(2, profileResponse);
    Assertions.assertNotNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductType2AndBPTrueBopisTrue() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.TRUE);
    profileResponse.setBopisFlag(Boolean.TRUE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(2, profileResponse);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductType2AndBPFalseBopisFalse() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.FALSE);
    profileResponse.setBopisFlag(Boolean.FALSE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(2, profileResponse);
    Assertions.assertNotNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductType3AndBPTrueBopisFalse() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.TRUE);
    profileResponse.setBopisFlag(Boolean.FALSE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(3, profileResponse);
    Assertions.assertNotNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductType3AndBPFalseBopisTrue() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.FALSE);
    profileResponse.setBopisFlag(Boolean.TRUE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(3, profileResponse);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductType3AndBPTrueBopisTrue() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.TRUE);
    profileResponse.setBopisFlag(Boolean.TRUE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(3, profileResponse);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithProductType3AndBPFalseBopisFalse() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.FALSE);
    profileResponse.setBopisFlag(Boolean.FALSE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(3, profileResponse);
    Assertions.assertNotNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithBopisFlagNull() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.TRUE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(3, profileResponse);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityTestWithBPFlagNull() {
    profileResponse = new ProfileResponse();
    profileResponse.setBopisFlag(Boolean.TRUE);
    ApiErrorCode apiErrorCode = productServiceBean.checkBpBopisEligibility(2, profileResponse);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void publishImageQcEventForContentEditTest() {
    ReflectionTestUtils.setField(productServiceBean, "enablePriceUpdateInImageQcRequest", false);
    productServiceBean.publishImageQcEventForContentEdit(new ArrayList<>(), new RestrictedKeywordsByFieldAndActionType(), new ProductLevel3(), true);
    verify(kafkaProducer).send(Mockito.eq(DomainEventName.IMAGE_QC_PREDICTION_REQUEST), Mockito.any(),
        Mockito.any(ImageQcRequestDomainEvent.class));
  }

  @Test
  public void checkProductLimitExceededTest() throws Exception {
    ProductSystemParameter productSystemParameter = new ProductSystemParameter();
    productSystemParameter.setVariable(Constants.PRODUCT_LIMIT_SYSTEM_PARAMETER);
    productSystemParameter.setValue("45");
    Mockito.when(productSystemParameterService
        .findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.PRODUCT_LIMIT_SYSTEM_PARAMETER))
        .thenReturn(productSystemParameter);
    Mockito.when(productLevel3V2Service.getProductCount(DEFAULT_STORE_ID, BUSINESS_PARTNER_CODE, true)).thenReturn(20L);
    ApiErrorCode apiErrorCode = productServiceBean.checkProductLimitExceeded(BUSINESS_PARTNER_CODE, DEFAULT_STORE_ID);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.PRODUCT_LIMIT_SYSTEM_PARAMETER);
    Mockito.verify(productLevel3V2Service).getProductCount(DEFAULT_STORE_ID, BUSINESS_PARTNER_CODE, true);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkProductLimitExceededNullSystemParameterTest() throws Exception {
    Mockito.when(productSystemParameterService
        .findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.PRODUCT_LIMIT_SYSTEM_PARAMETER)).thenReturn(null);
    Mockito.when(productLevel3V2Service.getProductCount(DEFAULT_STORE_ID, BUSINESS_PARTNER_CODE, true)).thenReturn(20L);
    ApiErrorCode apiErrorCode = productServiceBean.checkProductLimitExceeded(BUSINESS_PARTNER_CODE, DEFAULT_STORE_ID);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.PRODUCT_LIMIT_SYSTEM_PARAMETER);
    Mockito.verify(productLevel3V2Service).getProductCount(DEFAULT_STORE_ID, BUSINESS_PARTNER_CODE, true);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void checkProductLimitExceededTest2() throws Exception {
    ProductSystemParameter productSystemParameter = new ProductSystemParameter();
    productSystemParameter.setVariable(Constants.PRODUCT_LIMIT_SYSTEM_PARAMETER);
    productSystemParameter.setValue("19");
    Mockito.when(productSystemParameterService
        .findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.PRODUCT_LIMIT_SYSTEM_PARAMETER))
        .thenReturn(productSystemParameter);
    Mockito.when(productLevel3V2Service.getProductCount(DEFAULT_STORE_ID, BUSINESS_PARTNER_CODE, true)).thenReturn(20L);
    ApiErrorCode apiErrorCode = productServiceBean.checkProductLimitExceeded(BUSINESS_PARTNER_CODE, DEFAULT_STORE_ID);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(DEFAULT_STORE_ID, Constants.PRODUCT_LIMIT_SYSTEM_PARAMETER);
    Mockito.verify(productLevel3V2Service).getProductCount(DEFAULT_STORE_ID, BUSINESS_PARTNER_CODE, true);
    Assertions.assertNotNull(apiErrorCode);
  }

  @Test
  public void validateSkipDefinitiveActionForSalesSkuTest() throws Exception {
    InternalProductHistoryEventModel eventModel = new InternalProductHistoryEventModel();
    eventModel.setProductCode(DEFAULT_PRODUCT_CODE);
    eventModel.setNotes(Constants.SKIP_DEFINITIVE_DESCRIPTION);
    eventModel.setActivity(Constants.SKIP_DEFINITIVE_ACTIVITY);
    eventModel.setUsername(Constants.SYSTEM);
    eventModel.setStoreId("10001");
    productCollection.setProductId(PRODUCT_ID);
    agpSimpleQuery =
      AgpSimpleQueryResponse.builder().hits(HitsResponse.builder().total(10).max_score(10.0).build())
        .build();

    Mockito.when(agpQueryFeign.findNumberOfOrder(DEFAULT_PRODUCT_SKU, String.valueOf(0), String.valueOf(0),
      Constants.AGP_ITEM_STATUS)).thenReturn(agpSimpleQuery);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
      .thenReturn(productBusinessPartner);

    productServiceBean.validateSkipDefinitiveAction(STORE_ID, productCollection,
      restrictedKeywordsByFieldAndActionType);

    Mockito.verify(agpQueryFeign)
      .findNumberOfOrder(DEFAULT_PRODUCT_SKU, String.valueOf(0), String.valueOf(0),
        Constants.AGP_ITEM_STATUS);
    Mockito.verify(productBusinessPartnerService)
      .findFirstByStoreIdAndProductId(STORE_ID, PRODUCT_ID);
    verify(kafkaProducer).send(DomainEventName.PRODUCT_INTERNAL_HISTORY_SAVE, DEFAULT_PRODUCT_CODE,
      eventModel);
  }
  @Test
  public void validateSkipDefinitiveActionForNoSalesSkuTest() throws Exception {
    productCollection.setProductId(PRODUCT_ID);
    agpSimpleQuery =
      AgpSimpleQueryResponse.builder().hits(HitsResponse.builder().total(0).max_score(10.0).build())
        .build();

    Mockito.when(agpQueryFeign.findNumberOfOrder(DEFAULT_PRODUCT_SKU, String.valueOf(0), String.valueOf(0),
      Constants.AGP_ITEM_STATUS)).thenReturn(agpSimpleQuery);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
      .thenReturn(productBusinessPartner);

    productServiceBean.validateSkipDefinitiveAction(STORE_ID, productCollection,
      restrictedKeywordsByFieldAndActionType);

    Mockito.verify(agpQueryFeign)
      .findNumberOfOrder(DEFAULT_PRODUCT_SKU, String.valueOf(0), String.valueOf(0),
        Constants.AGP_ITEM_STATUS);
    Mockito.verify(productBusinessPartnerService)
      .findFirstByStoreIdAndProductId(STORE_ID, PRODUCT_ID);
  }

  @Test
  public void validateSkipDefinitiveActionExceptionSkuTest() throws Exception {
    productCollection.setProductId(PRODUCT_ID);
    agpSimpleQuery =
      AgpSimpleQueryResponse.builder().hits(HitsResponse.builder().total(0).max_score(10.0).build())
        .build();

    Mockito.when(agpQueryFeign.findNumberOfOrder(DEFAULT_PRODUCT_SKU, String.valueOf(0), String.valueOf(0),
      Constants.AGP_ITEM_STATUS)).thenThrow(RuntimeException.class);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(STORE_ID, PRODUCT_ID))
      .thenReturn(productBusinessPartner);

    productServiceBean.validateSkipDefinitiveAction(STORE_ID, productCollection,
      restrictedKeywordsByFieldAndActionType);

    Mockito.verify(agpQueryFeign)
      .findNumberOfOrder(DEFAULT_PRODUCT_SKU, String.valueOf(0), String.valueOf(0),
        Constants.AGP_ITEM_STATUS);
    Mockito.verify(productBusinessPartnerService)
      .findFirstByStoreIdAndProductId(STORE_ID, PRODUCT_ID);

  }

  @Test
  public void deleteProductCollectionByStoreIdAndProductCodeTest() {
    productServiceBean.deleteProductCollectionByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).deleteByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
  }

  @Test
  public void findProductsByAddDeleteVariantByPendingStatusProductCodeNotEmptyTest() throws Exception {
    when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID,
        PRODUCT_CODE)).thenReturn(productCollection);
    GdnRestListResponse<ProductDetailResponse> productDetailResponseGdnRestListResponse = new GdnRestListResponse<>();
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setNewlyAddedItem(true);
    productDetailResponse.setProductItemResponses(Collections.singleton(productItemResponse));
    productDetailResponseGdnRestListResponse.setContent(Collections.singletonList(productDetailResponse));
    when(productRepository.getProductDetailsByProductCodes(REQUEST_ID, DEFAULT_USERNAME,
        Collections.singletonList(PRODUCT_CODE))).thenReturn(productDetailResponseGdnRestListResponse);
    List<String> productCodes = productServiceBean.findProductsByAddDeleteVariantByPendingStatus(STORE_ID, PRODUCT_CODE,REQUEST_ID,DEFAULT_USERNAME);
    AddDeleteVariantRetryPublishEventModel
        addDeleteVariantRetryPublishEvent = new AddDeleteVariantRetryPublishEventModel();
    addDeleteVariantRetryPublishEvent.setProductCode(PRODUCT_CODE);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
        Mockito.verify(productRepository).getProductDetailsByProductCodes(REQUEST_ID, DEFAULT_USERNAME,
        Collections.singletonList(PRODUCT_CODE));
    Assertions.assertEquals(productCollectionArgumentCaptor.getValue().getAddDeleteVariantStatus(),
        AddDeleteVariantStatus.PUBLISHED);
  }

  @Test
  public void findProductsByAddDeleteVariantByPendingStatusProductCollecitonNulkEmptyTest() throws Exception {
    when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID,
        PRODUCT_CODE)).thenReturn(null);
    GdnRestListResponse<ProductDetailResponse> productDetailResponseGdnRestListResponse = new GdnRestListResponse<>();
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setNewlyAddedItem(true);
    productDetailResponse.setProductItemResponses(Collections.singleton(productItemResponse));
    productDetailResponseGdnRestListResponse.setContent(Collections.singletonList(productDetailResponse));
    when(productRepository.getProductDetailsByProductCodes(REQUEST_ID, DEFAULT_USERNAME,
        Collections.singletonList(PRODUCT_CODE))).thenReturn(productDetailResponseGdnRestListResponse);
    List<String> productCodes = productServiceBean.findProductsByAddDeleteVariantByPendingStatus(STORE_ID, PRODUCT_CODE,REQUEST_ID,DEFAULT_USERNAME);
       Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productRepository).getProductDetailsByProductCodes(REQUEST_ID, DEFAULT_USERNAME,
        Collections.singletonList(PRODUCT_CODE));
    Assertions.assertEquals(Collections.emptyList(), productCodes);
  }

  @Test
  public void findProductsByAddDeleteVariantByPendingStatusProductCodeEmptyTest() throws Exception {
    ProductSystemParameter productSystemParameter1 = new ProductSystemParameter();
    productSystemParameter1.setValue("1");
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
            SystemParameterConstants.FETCH_ADD_DELETE_VARIANT_PENDING_STATUS_BATCH_SIZE))
        .thenReturn(productSystemParameter1);
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.FETCH_ADD_DELETE_VARIANT_PENDING_STATUS_IN_HOURS)).thenReturn(productSystemParameter1);
    int pageNumber = 0;
    int pageSize = 1;
    PageRequest pageRequest = PageRequest.of(pageNumber, pageSize);
    Page<ProductCollection> productCollectionList = new PageImpl<>(Arrays.asList(productCollection));
    Mockito.when(productCollectionRepository.findByAddDeleteVariantStatusAndMarkForDeleteFalseAndCreatedDateBefore(
            Mockito.eq(AddDeleteVariantStatus.PENDING), Mockito.any(), Mockito.eq(pageRequest)))
        .thenReturn(productCollectionList);
    List<String> productCodes =
        productServiceBean.findProductsByAddDeleteVariantByPendingStatus(STORE_ID, null, REQUEST_ID, DEFAULT_USERNAME);
    AddDeleteVariantRetryPublishEventModel addDeleteVariantRetryPublishEvent =
        new AddDeleteVariantRetryPublishEventModel();
    addDeleteVariantRetryPublishEvent.setProductCode(PRODUCT_CODE);
    Mockito.verify(productSystemParameterService).findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.FETCH_ADD_DELETE_VARIANT_PENDING_STATUS_BATCH_SIZE);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.FETCH_ADD_DELETE_VARIANT_PENDING_STATUS_IN_HOURS);
    Mockito.verify(productCollectionRepository).saveAll(productCollectionList.getContent());
    Assertions.assertEquals(Collections.singletonList("MTA-0000001"), productCodes);
  }

  @Test
  public void findProductsByAddDeleteVariantByPendingStatusProductCodenullProductCollectionEmptyTest()
      throws Exception {
    ProductSystemParameter productSystemParameter1 = new ProductSystemParameter();
    productSystemParameter1.setValue("1");
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
            SystemParameterConstants.FETCH_ADD_DELETE_VARIANT_PENDING_STATUS_BATCH_SIZE))
        .thenReturn(productSystemParameter1);
    int pageNumber = 0;
    int pageSize = 1;
    PageRequest pageRequest = PageRequest.of(pageNumber, pageSize);
    Page<ProductCollection> productCollectionList = new PageImpl<>(new ArrayList<>());
    Mockito.when(productSystemParameterService.findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.FETCH_ADD_DELETE_VARIANT_PENDING_STATUS_IN_HOURS)).thenReturn(productSystemParameter1);
    Mockito.when(productCollectionRepository.findByAddDeleteVariantStatusAndMarkForDeleteFalseAndCreatedDateBefore(
            Mockito.eq(AddDeleteVariantStatus.PENDING), Mockito.any(), Mockito.eq(pageRequest)))
        .thenReturn(productCollectionList);
    List<String> productCodes = productServiceBean.findProductsByAddDeleteVariantByPendingStatus(STORE_ID, null,REQUEST_ID,DEFAULT_USERNAME);
    AddDeleteVariantRetryPublishEventModel
        addDeleteVariantRetryPublishEvent = new AddDeleteVariantRetryPublishEventModel();
    addDeleteVariantRetryPublishEvent.setProductCode(PRODUCT_CODE);
    Mockito.verify(productSystemParameterService).findByStoreIdAndVariable(STORE_ID,
        SystemParameterConstants.FETCH_ADD_DELETE_VARIANT_PENDING_STATUS_BATCH_SIZE);
    Mockito.verify(productSystemParameterService)
        .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.FETCH_ADD_DELETE_VARIANT_PENDING_STATUS_IN_HOURS);
    Assertions.assertEquals(Collections.emptyList(), productCodes);
  }

  @Test
  public void findProductsByAddDeleteVariantByPendingStatusProductCodeNotEmptyNewlyAddedfalseTest() throws Exception {
    when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID,
        PRODUCT_CODE)).thenReturn(productCollection);
    GdnRestListResponse<ProductDetailResponse> productDetailResponseGdnRestListResponse = new GdnRestListResponse<>();
    ProductDetailResponse productDetailResponse = new ProductDetailResponse();
    ProductItemResponse productItemResponse = new ProductItemResponse();
    productItemResponse.setNewlyAddedItem(false);
    productDetailResponse.setProductItemResponses(Collections.singleton(productItemResponse));
    productDetailResponseGdnRestListResponse.setContent(Collections.singletonList(productDetailResponse));
    when(productRepository.getProductDetailsByProductCodes(REQUEST_ID, DEFAULT_USERNAME,
        Collections.singletonList(PRODUCT_CODE))).thenReturn(productDetailResponseGdnRestListResponse);
    List<String> productCodes = productServiceBean.findProductsByAddDeleteVariantByPendingStatus(STORE_ID, PRODUCT_CODE,REQUEST_ID,DEFAULT_USERNAME);
    AddDeleteVariantRetryPublishEventModel
        addDeleteVariantRetryPublishEvent = new AddDeleteVariantRetryPublishEventModel();
    addDeleteVariantRetryPublishEvent.setProductCode(PRODUCT_CODE);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID, PRODUCT_CODE);
    Mockito.verify(productRepository).getProductDetailsByProductCodes(REQUEST_ID, DEFAULT_USERNAME,
        Collections.singletonList(PRODUCT_CODE));
    Assertions.assertEquals(Collections.emptyList(), productCodes);
  }

  @Test
  public void updateAddDeleteVariantStatusTest() throws Exception {
    productServiceBean.updateAddDeleteVariantStatus(PRODUCT_CODE, AddDeleteVariantStatus.SUCCESS);
    verify(productCollectionRepository).updateAddDeleteVariantStatus(PRODUCT_CODE, AddDeleteVariantStatus.SUCCESS);
  }

  @Test
  public void updateAddDeleteVariantStatusForListenerTest() {
    Mockito.when(mandatoryParameterHelper.getStoreId()).thenReturn(STORE_ID);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(
        mandatoryParameterHelper.getStoreId(), PRODUCT_CODE)).thenReturn(productCollection);
    productServiceBean.updateAddDeleteVariantStatusForListener(PRODUCT_CODE, AddDeleteVariantStatus.IN_PROGRESS);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(mandatoryParameterHelper.getStoreId(), PRODUCT_CODE);
    Mockito.verify(productCollectionRepository).save(productCollectionArgumentCaptor.capture());
    Assertions.assertEquals(productCollection, productCollectionArgumentCaptor.getValue());
    Assertions.assertEquals(AddDeleteVariantStatus.IN_PROGRESS,
        productCollectionArgumentCaptor.getValue().getAddDeleteVariantStatus());
  }

  @Test
  public void updateAddDeleteVariantStatusProductCollectionEmptyTest() {
    Mockito.when(mandatoryParameterHelper.getStoreId()).thenReturn(STORE_ID);
    Mockito.when(productCollectionRepository.findByProductCodeInAndStoreIdAndMarkForDeleteFalse(
        Collections.singletonList(PRODUCT_CODE), mandatoryParameterHelper.getStoreId())).thenReturn(null);
    ProductCollection productCollectionList =
        productServiceBean.updateAddDeleteVariantStatusForListener(PRODUCT_CODE, AddDeleteVariantStatus.IN_PROGRESS);
    Mockito.verify(productCollectionRepository)
        .findByStoreIdAndProductCodeAndMarkForDeleteFalse(mandatoryParameterHelper.getStoreId(), PRODUCT_CODE);
    Assertions.assertNull(productCollectionList);
  }

  @Test
  public void validateSizeChartTest() {
    Mockito.when(
            pcbFeign.validateSizeChartCode(STORE_ID, CHANNEL_ID, CLIENT_ID, REQUEST_ID, DEFAULT_USERNAME, SIZE_CHART_CODE))
        .thenReturn(new GdnBaseRestResponse(true));
    Mockito.when(mandatoryParameterHelper.getChannelId()).thenReturn(CHANNEL_ID);
    Mockito.when(mandatoryParameterHelper.getClientId()).thenReturn(CLIENT_ID);
    Mockito.when(mandatoryParameterHelper.getRequestId()).thenReturn(REQUEST_ID);
    Mockito.when(mandatoryParameterHelper.getUsername()).thenReturn(DEFAULT_USERNAME);
    Mockito.when(mandatoryParameterHelper.getStoreId()).thenReturn(STORE_ID);
    ApiErrorCode apiErrorCode = productServiceBean.validateSizeChart(SIZE_CHART_CODE, STORE_ID);
    Assertions.assertNull(apiErrorCode);
  }

  @Test
  public void validateSizeChartTest_Failure() {
    Mockito.when(
            pcbFeign.validateSizeChartCode(STORE_ID, CHANNEL_ID, CLIENT_ID, REQUEST_ID, DEFAULT_USERNAME, SIZE_CHART_CODE))
        .thenReturn(new GdnBaseRestResponse(ApiErrorCode.SIZE_CHART_CODE_INVALID.getDesc(),
            ApiErrorCode.SIZE_CHART_CODE_INVALID.getCode(), false, REQUEST_ID));
    Mockito.when(mandatoryParameterHelper.getChannelId()).thenReturn(CHANNEL_ID);
    Mockito.when(mandatoryParameterHelper.getClientId()).thenReturn(CLIENT_ID);
    Mockito.when(mandatoryParameterHelper.getRequestId()).thenReturn(REQUEST_ID);
    Mockito.when(mandatoryParameterHelper.getUsername()).thenReturn(DEFAULT_USERNAME);
    Mockito.when(mandatoryParameterHelper.getStoreId()).thenReturn(STORE_ID);
    ApiErrorCode apiErrorCode = productServiceBean.validateSizeChart(SIZE_CHART_CODE, STORE_ID);
    Assertions.assertNotNull(apiErrorCode);
    Assertions.assertEquals(ApiErrorCode.SIZE_CHART_CODE_INVALID.getDesc(), apiErrorCode.getDesc());
  }

  @Test
  public void checkBpBopisEligibilityCategoryConfig() {
    profileResponse = new ProfileResponse();
    profileResponse.setBigProductFlag(Boolean.FALSE);
    profileResponse.setBopisFlag(Boolean.FALSE);
    ApiErrorCode apiErrorCode =
        productServiceBean.checkBpBopisEligibility(3, profileResponse, new CategoryDetailResponse(),
            new ProductL3UpdateRequest(), true);
    Assertions.assertNotNull(apiErrorCode);
  }

  @Test
  public void checkBpBopisEligibilityCategoryConfig_2() {
    ReflectionTestUtils.setField(productServiceBean, "bopisUnsupportedMerchantTypes", "CM");
    CompanyDTO companyDTO = new CompanyDTO();
    companyDTO.setMerchantType("CM");
    ProfileResponse profileResponse = new ProfileResponse();
    profileResponse.setCompany(companyDTO);
    profileResponse.setBigProductFlag(Boolean.FALSE);
    profileResponse.setBopisFlag(Boolean.TRUE);

    CategoryDetailResponse categoryDetailResponse = new CategoryDetailResponse();
    categoryDetailResponse.setBopisEligible(false);

    ItemPickupPointRequest itemPickupPointRequest = new ItemPickupPointRequest();
    itemPickupPointRequest.setCncActive(true);
    ProductL3UpdateRequest productL3UpdateRequest = new ProductL3UpdateRequest();
    productL3UpdateRequest.setAddPickupPoints(Arrays.asList(itemPickupPointRequest));

    ReflectionTestUtils.setField(productServiceBean, "bopisCNCRestrictionEnabled", false);
    ApiErrorCode apiErrorCode =
        productServiceBean.checkBpBopisEligibility(3, profileResponse, categoryDetailResponse, productL3UpdateRequest,
            true);

    ReflectionTestUtils.setField(productServiceBean, "bopisCNCRestrictionEnabled", true);
    apiErrorCode =
        productServiceBean.checkBpBopisEligibility(3, profileResponse, categoryDetailResponse, productL3UpdateRequest,
            true);

    apiErrorCode =
        productServiceBean.checkBpBopisEligibility(3, null, categoryDetailResponse, productL3UpdateRequest, true);

    apiErrorCode = productServiceBean.checkBpBopisEligibility(null, profileResponse, categoryDetailResponse,
        productL3UpdateRequest, true);

    apiErrorCode = productServiceBean.checkBpBopisEligibility(2, profileResponse, categoryDetailResponse,
        productL3UpdateRequest, true);

    apiErrorCode =
        productServiceBean.checkBpBopisEligibility(3, profileResponse, categoryDetailResponse, productL3UpdateRequest,
            true);

    apiErrorCode = productServiceBean.checkBpBopisEligibility(3, profileResponse, categoryDetailResponse,
        new ProductL3UpdateRequest(), true);

    apiErrorCode =
        productServiceBean.checkBpBopisEligibility(3, profileResponse, categoryDetailResponse, productL3UpdateRequest,
            false);

    categoryDetailResponse.setBopisEligible(true);
    apiErrorCode =
        productServiceBean.checkBpBopisEligibility(3, profileResponse, categoryDetailResponse, productL3UpdateRequest,
            true);

    categoryDetailResponse.setBopisEligible(false);
    companyDTO.setMerchantType("TD");
    apiErrorCode =
        productServiceBean.checkBpBopisEligibility(3, profileResponse, categoryDetailResponse, productL3UpdateRequest,
            true);
  }
  @Test
  public void migrateProductAndL5DetailsByProductSkuTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "l4FetchSizeForMigration", 1);
    ProductAndL5MigrationRequest productAndL5MigrationRequest = ProductAndL5MigrationRequest.builder()
      .productSku(PRODUCT_SKU)
      .productType(com.gdn.mta.product.enums.ProductType.BIG_PRODUCT)
      .build();
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner2.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner1.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);
    productItemBusinessPartner2.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);
    List<ProductItemBusinessPartner> productItemBusinessPartners = new ArrayList<>();
    productItemBusinessPartners.add(productItemBusinessPartner1);
    Page<ProductItemBusinessPartner> productItemBusinessPartnerPage = new PageImpl<>(productItemBusinessPartners);
    Mockito.when(
        productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
          Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, PageRequest.of(0, 1)))
      .thenReturn(productItemBusinessPartnerPage);
    productServiceBean.migrateProductAndL5DetailsByProductSku(
      Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, productAndL5MigrationRequest,
      Constants.DEFAULT_USERNAME, false, false);
    Mockito.verify(productItemBusinessPartnerRepository).findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
      Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, PageRequest.of(0, 1));
    Mockito.verify(productItemBusinessPartnerRepository).saveAll(productItemBusinessPartners);
  }

  @Test
  public void migrateProductAndL5DetailsByProductSkuWithNullStoreIDTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "l4FetchSizeForMigration", 1);
    ProductAndL5MigrationRequest productAndL5MigrationRequest = ProductAndL5MigrationRequest.builder()
      .productSku(PRODUCT_SKU)
      .productType(com.gdn.mta.product.enums.ProductType.BIG_PRODUCT)
      .build();
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner2.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner1.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);
    productItemBusinessPartner2.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);
    List<ProductItemBusinessPartner> productItemBusinessPartners = new ArrayList<>();
    productItemBusinessPartners.add(productItemBusinessPartner1);
    Page<ProductItemBusinessPartner> productItemBusinessPartnerPage = new PageImpl<>(productItemBusinessPartners);
    Mockito.when(
        productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
          Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, PageRequest.of(0, 1)))
      .thenReturn(productItemBusinessPartnerPage);
    assertThrows(ApplicationRuntimeException.class, () -> {
      productServiceBean.migrateProductAndL5DetailsByProductSku(
          null, PRODUCT_BUSINESS_PARTNER_ID, productAndL5MigrationRequest,
          Constants.DEFAULT_USERNAME, false, false);
    });
  }

  @Test
  public void migrateProductAndL5DetailsByProductSkuWithNullProductBusinessPartnerIdTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "l4FetchSizeForMigration", 1);
    ProductAndL5MigrationRequest productAndL5MigrationRequest = ProductAndL5MigrationRequest.builder()
      .productSku(PRODUCT_SKU)
      .productType(com.gdn.mta.product.enums.ProductType.BIG_PRODUCT)
      .build();
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner2.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner1.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);
    productItemBusinessPartner2.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);
    List<ProductItemBusinessPartner> productItemBusinessPartners = new ArrayList<>();
    productItemBusinessPartners.add(productItemBusinessPartner1);
    Page<ProductItemBusinessPartner> productItemBusinessPartnerPage = new PageImpl<>(productItemBusinessPartners);
    Mockito.when(
        productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
          Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, PageRequest.of(0, 1)))
      .thenReturn(productItemBusinessPartnerPage);
    assertThrows(ApplicationRuntimeException.class, () -> {
      productServiceBean.migrateProductAndL5DetailsByProductSku(
          Constants.STORE_ID, null, productAndL5MigrationRequest,
          Constants.DEFAULT_USERNAME, false, false);
    });
  }

  @Test
  public void migrateProductAndL5DetailsByProductSkuWithMultiplePagesTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "l4FetchSizeForMigration", 1);
    ProductAndL5MigrationRequest productAndL5MigrationRequest = ProductAndL5MigrationRequest.builder()
      .productSku(PRODUCT_SKU)
      .productType(com.gdn.mta.product.enums.ProductType.BIG_PRODUCT)
      .build();
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner2.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner1.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);
    productItemBusinessPartner2.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);

    List<ProductItemBusinessPartner> productItemBusinessPartnersPage1 = Collections.singletonList(productItemBusinessPartner1);
    Page<ProductItemBusinessPartner> productItemBusinessPartnerPage1 = new PageImpl<>(productItemBusinessPartnersPage1, PageRequest.of(0, 1), 2);

    List<ProductItemBusinessPartner> productItemBusinessPartnersPage2 = Collections.singletonList(productItemBusinessPartner2);
    Page<ProductItemBusinessPartner> productItemBusinessPartnerPage2 = new PageImpl<>(productItemBusinessPartnersPage2, PageRequest.of(1, 1), 2);
    Mockito.when(
        productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
          Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, PageRequest.of(0, 1)))
      .thenReturn(productItemBusinessPartnerPage1);

    Mockito.when(
        productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
          Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, PageRequest.of(1, 1)))
      .thenReturn(productItemBusinessPartnerPage2);
    productServiceBean.migrateProductAndL5DetailsByProductSku(
      Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, productAndL5MigrationRequest,
      Constants.DEFAULT_USERNAME, false, false);
    Mockito.verify(productItemBusinessPartnerRepository).findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
      Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, PageRequest.of(0, 1));
    Mockito.verify(productItemBusinessPartnerRepository).findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
      Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, PageRequest.of(1, 1));
    Mockito.verify(productItemBusinessPartnerRepository, Mockito.times(2)).saveAll(Mockito.anyList());
  }

  @Test
  public void takeActionsOnCategoryChangeFromVendor_whenActiveProductsEmptyAndMarginExceeded() throws Exception {
    boolean eligibleForShippingMigration = false;
    boolean marginExceeded = true;

    ProductCollection productCollectionEntity = new ProductCollection();
    productCollectionEntity.setProductId(PRODUCT_ID);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollectionEntity);

    List<String> productSkus = Collections.emptyList();
    Mockito.when(productBusinessPartnerRepository.getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE))
      .thenReturn(productSkus);
    productServiceBean.takeActionsOnCategoryChangeFromVendor(
      DEFAULT_STORE_ID, CATEGORY_CODE, CATEGORY_NAME, DEFAULT_PRODUCT_CODE,
      eligibleForShippingMigration, marginExceeded);
    Mockito.verify(productMailEventService).createAndSaveCategoryChangeMailEvent(
      Mockito.any(ProductCollection.class), Mockito.any(CategoryChangeMailEvent.class));
    Mockito.verify(productBusinessPartnerRepository).getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void takeActionsOnCategoryChangeFromVendor_whenActiveProductsEmptyAndShippingMigration()
    throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "l4FetchSizeForMigration", 1);
    boolean eligibleForShippingMigration = true;
    boolean marginExceeded = false;
    ProductCollection productEntity = new ProductCollection();
    productEntity.setProductId(PRODUCT_ID);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productEntity);
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setState(Constants.ACTIVE);
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner.setProductId(PRODUCT_ID);
    Mockito.when(productBusinessPartnerService.findFirstByProductSku(PRODUCT_SKU)).thenReturn(productBusinessPartner);
    com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest request =
      new com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest();
    request.setProductSku(PRODUCT_SKU);
    request.setBuyable(false);
    request.setDiscoverable(false);
    request.setL5Updated(true);
    request.setProductType(ProductType.REGULAR);
    request.setDimensionsMissing(true);
    List<String> productSkus = Collections.singletonList(PRODUCT_SKU);
    Mockito.when(productBusinessPartnerRepository.getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE))
      .thenReturn(productSkus);
    productServiceBean.takeActionsOnCategoryChangeFromVendor(DEFAULT_STORE_ID, CATEGORY_CODE,
      CATEGORY_NAME, DEFAULT_PRODUCT_CODE, eligibleForShippingMigration, marginExceeded);
    Mockito.verify(productBusinessPartnerService).findFirstByProductSku(PRODUCT_SKU);
    Mockito.verify(xProductOutbound).migrateProductAndL5DetailByProductSku(request,
      Constants.DEFAULT_STORE_ID, SYSTEM_REVIEW);
    Mockito.verify(productBusinessPartnerRepository).getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE);

  }

  @Test
  public void takeActionsOnCategoryChangeFromVendor_whenActiveProductsExistAndMarginExceeded() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "l4FetchSizeForMigration", 1);
    boolean eligibleForShippingMigration = false;
    boolean marginExceeded = true;
    ProductCollection productCollectionEntity = new ProductCollection();
    productCollectionEntity.setProductId(PRODUCT_ID);
    productCollectionEntity.setProductCode(DEFAULT_PRODUCT_CODE);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID, DEFAULT_PRODUCT_CODE))
      .thenReturn(productCollectionEntity);
    List<String> productSkus = List.of(PRODUCT_SKU);
    Mockito.when(productBusinessPartnerRepository.getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE))
      .thenReturn(productSkus);
    ProductItemBusinessPartner productItemBusinessPartner1 = new ProductItemBusinessPartner();
    ProductItemBusinessPartner productItemBusinessPartner2 = new ProductItemBusinessPartner();
    productItemBusinessPartner1.setGdnProductItemSku(ITEM_SKU);
    productItemBusinessPartner2.setGdnProductItemSku(ITEM_SKU_1);
    productItemBusinessPartner1.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);
    productItemBusinessPartner2.setProductBusinessPartnerId(PRODUCT_BUSINESS_PARTNER_ID);
    List<ProductItemBusinessPartner> productItemBusinessPartners = new ArrayList<>();
    productItemBusinessPartners.add(productItemBusinessPartner1);
    Page<ProductItemBusinessPartner> productItemBusinessPartnerPage = new PageImpl<>(productItemBusinessPartners);
    Mockito.when(
        productItemBusinessPartnerRepository.findByStoreIdAndProductBusinessPartnerIdAndMarkForDeleteFalseOrderByGdnProductItemSku(
          Constants.DEFAULT_STORE_ID, PRODUCT_BUSINESS_PARTNER_ID, PageRequest.of(0, 1)))
      .thenReturn(productItemBusinessPartnerPage);
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setState(Constants.IN_PROGRESS_STATE);
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner.setProductId(PRODUCT_ID);
    productBusinessPartner.setId(PRODUCT_BUSINESS_PARTNER_ID);
    Mockito.when(productBusinessPartnerService.findFirstByProductSku(PRODUCT_SKU)).thenReturn(productBusinessPartner);
    com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest request =
      new com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest();
    request.setProductSku(PRODUCT_SKU);
    request.setBuyable(false);
    request.setDiscoverable(false);
    request.setL5Updated(true);
    request.setProductType(null);
    productServiceBean.takeActionsOnCategoryChangeFromVendor(
      DEFAULT_STORE_ID, CATEGORY_CODE, CATEGORY_NAME, DEFAULT_PRODUCT_CODE,
      eligibleForShippingMigration, marginExceeded);
    Mockito.verify(productMailEventService).createAndSaveCategoryChangeMailEvent(
      Mockito.any(ProductCollection.class), Mockito.any(CategoryChangeMailEvent.class));
    Mockito.verify(productBusinessPartnerRepository).getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void takeActionsOnCategoryChangeFromVendor_whenActiveProductsExistAndShippingMigration() throws Exception {
    boolean eligibleForShippingMigration = true;
    boolean marginExceeded = false;
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setState(Constants.ACTIVE);
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner.setProductId(PRODUCT_ID);
    Mockito.when(productBusinessPartnerService.findFirstByProductSku(PRODUCT_SKU)).thenReturn(productBusinessPartner);
    com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest request =
      new com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest();
    request.setProductSku(PRODUCT_SKU);
    request.setBuyable(false);
    request.setDiscoverable(false);
    request.setL5Updated(true);
    request.setProductType(ProductType.REGULAR);
    ProductCollection collection = new ProductCollection();
    collection.setProductId(PRODUCT_ID);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE)).thenReturn(collection);

    List<String> productSkus = List.of(PRODUCT_SKU);
    Mockito.when(productBusinessPartnerRepository.getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE))
      .thenReturn(productSkus);
    productServiceBean.takeActionsOnCategoryChangeFromVendor(DEFAULT_STORE_ID, CATEGORY_CODE,
      CATEGORY_NAME, DEFAULT_PRODUCT_CODE, eligibleForShippingMigration, marginExceeded);
    Mockito.verify(productBusinessPartnerService).findFirstByProductSku(PRODUCT_SKU);
    Mockito.verify(productBusinessPartnerRepository).getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void takeActionsOnCategoryChangeFromVendor_whenBothMarginExceededAndShippingMigration() throws Exception {
    boolean eligibleForShippingMigration = true;
    boolean marginExceeded = true;
    ProductAndL5MigrationRequest productAndL5MigrationRequest = new ProductAndL5MigrationRequest();
    productAndL5MigrationRequest.setProductSku(PRODUCT_SKU);
    productAndL5MigrationRequest.setBuyable(false);
    productAndL5MigrationRequest.setDiscoverable(false);
    productAndL5MigrationRequest.setL5Updated(true);
    productAndL5MigrationRequest.setProductType(com.gdn.mta.product.enums.ProductType.REGULAR);
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setState(PRODUCT_NAME);
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner.setProductId(PRODUCT_ID);
    Mockito.when(productBusinessPartnerService.findFirstByProductSku(PRODUCT_SKU)).thenReturn(productBusinessPartner);
    ProductCollection productEntity = new ProductCollection();
    productEntity.setProductId(PRODUCT_ID);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productEntity);

    List<String> productSkus = List.of(PRODUCT_SKU);
    Mockito.when(productBusinessPartnerRepository.getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE))
      .thenReturn(productSkus);
    productServiceBean.takeActionsOnCategoryChangeFromVendor(DEFAULT_STORE_ID, CATEGORY_CODE,
      CATEGORY_NAME, DEFAULT_PRODUCT_CODE, eligibleForShippingMigration, marginExceeded);
    Mockito.verify(productBusinessPartnerService).findFirstByProductSku(PRODUCT_SKU);

    Mockito.verify(productBusinessPartnerRepository).getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE);
    Mockito.verify(productMailEventService).createAndSaveCategoryChangeMailEvent(
      Mockito.any(ProductCollection.class), Mockito.any(CategoryChangeMailEvent.class));
  }

  @Test
  public void takeActionsOnCategoryChangeFromVendor_whenBothMarginExceededAndShippingMigrationAreFalse() throws Exception {
    boolean eligibleForShippingMigration = false;
    boolean marginExceeded = false;
    ProductAndL5MigrationRequest productAndL5MigrationRequest = new ProductAndL5MigrationRequest();
    productAndL5MigrationRequest.setProductSku(PRODUCT_SKU);
    productAndL5MigrationRequest.setBuyable(false);
    productAndL5MigrationRequest.setDiscoverable(false);
    productAndL5MigrationRequest.setL5Updated(true);
    productAndL5MigrationRequest.setProductType(com.gdn.mta.product.enums.ProductType.REGULAR);
    ProductCollection productEntity = new ProductCollection();
    productEntity.setProductId(PRODUCT_ID);
    Mockito.when(productCollectionRepository.findByStoreIdAndProductCode(DEFAULT_STORE_ID,
      DEFAULT_PRODUCT_CODE)).thenReturn(productEntity);

    List<String> productSkus = List.of(PRODUCT_SKU);
    Mockito.when(productBusinessPartnerRepository.getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE))
      .thenReturn(productSkus);
    productServiceBean.takeActionsOnCategoryChangeFromVendor(DEFAULT_STORE_ID, CATEGORY_CODE,
      CATEGORY_NAME, DEFAULT_PRODUCT_CODE, eligibleForShippingMigration, marginExceeded);
    Mockito.verify(productBusinessPartnerRepository).getGdnSkuByProductCode(DEFAULT_PRODUCT_CODE);
  }

  @Test
  public void takeActionsOnCategoryChangeFromInternal_whenCategoryChangedAndEligibleForShippingMigrationAndBOPIS()
    throws Exception {
    ReflectionTestUtils.setField(productServiceBean,
      "bopisCategoryActionOnVendorCategoryChangeSwitch", false);
    Product product = new Product();
    product.setProductCode(PRODUCT_CODE);
    ProductAndL5MigrationRequest productAndL5MigrationRequest = new ProductAndL5MigrationRequest();
    productAndL5MigrationRequest.setProductSku(PRODUCT_SKU);
    productAndL5MigrationRequest.setBuyable(false);
    productAndL5MigrationRequest.setDiscoverable(false);
    productAndL5MigrationRequest.setL5Updated(true);
    productAndL5MigrationRequest.setProductType(com.gdn.mta.product.enums.ProductType.REGULAR);
    ProductCategory category = new ProductCategory();
    category.setCategory(new Category());
    category.getCategory().setBopisEligible(false);
    product.setProductCategories(List.of(category));

    Set<String> changedField = Set.of(ProductChangeUtil.CATEGORY);
    List<String> productSkus = List.of(PRODUCT_SKU);

    BasicProductResponse productResponse = new BasicProductResponse();
    productResponse.setProductSku(PRODUCT_SKU);
    productResponse.setProductType(ProductType.BOPIS);
    productResponse.setMarkForDelete(false);
    productResponse.setArchived(false);

    Mockito.when(productBusinessPartnerService.getProductSkusByProductCode(PRODUCT_CODE))
      .thenReturn(productSkus);
    Mockito.when(xProductOutbound.getBasicProductInfoV2(PRODUCT_SKU))
      .thenReturn(productResponse);

    productServiceBean.takeActionsOnCategoryChangeFromInternal(product, changedField, PRODUCT_ID);
    verifyNoInteractions(productOutbound, productBusinessPartnerService);
  }

  @Test
  public void takeActionsOnCategoryChangeFromInternal_whenCategoryChangedAndEligibleForShippingMigrationAndBOPISSwitchOn()
    throws Exception {
    ReflectionTestUtils.setField(productServiceBean,
      "bopisCategoryActionOnVendorCategoryChangeSwitch", true);
    Product product = new Product();
    product.setProductCode(PRODUCT_CODE);
    ProductAndL5MigrationRequest productAndL5MigrationRequest = new ProductAndL5MigrationRequest();
    productAndL5MigrationRequest.setProductSku(PRODUCT_SKU);
    productAndL5MigrationRequest.setBuyable(false);
    productAndL5MigrationRequest.setDiscoverable(false);
    productAndL5MigrationRequest.setL5Updated(true);
    productAndL5MigrationRequest.setProductType(com.gdn.mta.product.enums.ProductType.REGULAR);
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setState(Constants.ACTIVE);
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner.setProductId(PRODUCT_ID);
    productBusinessPartner.setId(PRODUCT_ID);
    ProductCategory category = new ProductCategory();
    category.setCategory(new Category());
    category.getCategory().setBopisEligible(false);
    product.setProductCategories(List.of(category));
    Set<String> changedField = Set.of(ProductChangeUtil.CATEGORY);
    List<String> productSkus = List.of(PRODUCT_SKU);
    BasicProductResponse productResponse = new BasicProductResponse();
    productResponse.setProductSku(PRODUCT_SKU);
    productResponse.setProductType(ProductType.BOPIS);
    productResponse.setMarkForDelete(false);
    productResponse.setArchived(false);
    Mockito.when(productBusinessPartnerService.getProductSkusByProductCode(PRODUCT_CODE))
      .thenReturn(productSkus);
    Mockito.when(productBusinessPartnerService.findFirstByProductSku(PRODUCT_SKU)).thenReturn(productBusinessPartner);
    Mockito.when(xProductOutbound.getBasicProductInfoV2(PRODUCT_SKU))
      .thenReturn(productResponse);

    productServiceBean.takeActionsOnCategoryChangeFromInternal(product, changedField, DEFAULT_STORE_ID);
    Mockito.verify(productBusinessPartnerService).findFirstByProductSku(PRODUCT_SKU);
    verify(productBusinessPartnerService).getProductSkusByProductCode(PRODUCT_CODE);
  }

  @Test
  public void takeActionsOnCategoryChangeFromInternaEligibleForShippingMigrationAndBOPISSwitchOnDimensionsAdded()
    throws Exception {
    ReflectionTestUtils.setField(productServiceBean,
      "bopisCategoryActionOnVendorCategoryChangeSwitch", true);
    Product product = new Product();
    product.setLength(1.0);
    product.setWeight(1.0);
    product.setHeight(3.0);
    product.setShippingWeight(5.0);
    product.setProductCode(PRODUCT_CODE);
    ProductCategory category = new ProductCategory();
    category.setCategory(new Category());
    category.getCategory().setBopisEligible(false);
    product.setProductCategories(List.of(category));
    Set<String> changedField = Set.of(ProductChangeUtil.CATEGORY);
    List<String> productSkus = List.of(PRODUCT_SKU);
    BasicProductResponse productResponse = new BasicProductResponse();
    productResponse.setProductSku(PRODUCT_SKU);
    productResponse.setProductType(ProductType.BOPIS);
    productResponse.setMarkForDelete(false);
    productResponse.setArchived(false);
    Mockito.when(productBusinessPartnerService.getProductSkusByProductCode(PRODUCT_CODE))
      .thenReturn(productSkus);
    Mockito.when(xProductOutbound.getBasicProductInfoV2(PRODUCT_SKU))
      .thenReturn(productResponse);

    productServiceBean.takeActionsOnCategoryChangeFromInternal(product, changedField, DEFAULT_STORE_ID);
    verifyNoMoreInteractions(xProductOutbound, productBusinessPartnerService);
  }

  @Test
  public void takeActionsOnCategoryChangeFromInternal_EligibleForShippingMigrationInActiveAndBOPISSwitchOn()
    throws Exception {
    ReflectionTestUtils.setField(productServiceBean,
      "bopisCategoryActionOnVendorCategoryChangeSwitch", true);
    Product product = new Product();
    product.setProductCode(PRODUCT_CODE);
    ProductCategory category = new ProductCategory();
    category.setCategory(new Category());
    category.getCategory().setBopisEligible(false);
    product.setProductCategories(List.of(category));
    Set<String> changedField = Set.of(ProductChangeUtil.CATEGORY);
    List<String> productSkus = List.of(PRODUCT_SKU);
    BasicProductResponse productResponse = new BasicProductResponse();
    productResponse.setProductSku(PRODUCT_SKU);
    productResponse.setProductType(ProductType.BOPIS);
    productResponse.setMarkForDelete(true);
    productResponse.setArchived(false);
    com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest
      productAndL5MigrationRequest = new com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest();
    productAndL5MigrationRequest.setProductSku(PRODUCT_SKU);
    productAndL5MigrationRequest.setBuyable(false);
    productAndL5MigrationRequest.setDiscoverable(false);
    productAndL5MigrationRequest.setL5Updated(true);
    productAndL5MigrationRequest.setProductType(ProductType.REGULAR);
    productAndL5MigrationRequest.setDimensionsMissing(true);
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setState(Constants.ACTIVE);
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner.setProductId(PRODUCT_ID);
    Mockito.when(productBusinessPartnerService.findFirstByProductSku(PRODUCT_SKU)).thenReturn(productBusinessPartner);
    Mockito.when(productBusinessPartnerService.getProductSkusByProductCode(PRODUCT_CODE))
      .thenReturn(productSkus);
    Mockito.when(xProductOutbound.getBasicProductInfoV2(PRODUCT_SKU))
      .thenReturn(productResponse);

    productServiceBean.takeActionsOnCategoryChangeFromInternal(product, changedField, DEFAULT_STORE_ID);
    Mockito.verify(productBusinessPartnerService).findFirstByProductSku(PRODUCT_SKU);
    Mockito.verify(xProductOutbound).migrateProductAndL5DetailByProductSku(productAndL5MigrationRequest,
      Constants.DEFAULT_STORE_ID, SYSTEM_REVIEW);
    verify(productBusinessPartnerService).getProductSkusByProductCode(PRODUCT_CODE);
  }
  @Test
  public void takeActionsOnCategoryChangeFromInternal_whenCategoryChangedAndEligibleForShippingMigrationAndNonBOPIS()
    throws Exception {
    ReflectionTestUtils.setField(productServiceBean,
      "bopisCategoryActionOnVendorCategoryChangeSwitch", true);
    Product product = new Product();
    product.setProductCode(PRODUCT_CODE);
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setState(Constants.IN_PROGRESS_STATE);
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    productBusinessPartner.setProductId(PRODUCT_ID);
    productBusinessPartner.setId(PRODUCT_ID);
    Mockito.when(productBusinessPartnerService.findFirstByProductSku(PRODUCT_SKU)).thenReturn(productBusinessPartner);
    com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest request =
      new com.gdn.x.product.rest.web.model.request.ProductAndL5MigrationRequest();
    ProductCategory category = new ProductCategory();
    category.setCategory(new Category());
    category.getCategory().setBopisEligible(false);
    product.setProductCategories(List.of(category));

    Set<String> changedField = Set.of(ProductChangeUtil.CATEGORY);
    List<String> productSkus = List.of(PRODUCT_SKU);

    BasicProductResponse productResponse = new BasicProductResponse();
    productResponse.setProductSku(PRODUCT_SKU);
    productResponse.setProductType(ProductType.REGULAR);
    productResponse.setMarkForDelete(false);
    productResponse.setArchived(false);

    Mockito.when(productBusinessPartnerService.getProductSkusByProductCode(PRODUCT_CODE))
      .thenReturn(productSkus);
    Mockito.when(xProductOutbound.getBasicProductInfoV2(PRODUCT_SKU))
      .thenReturn(productResponse);
    productServiceBean.takeActionsOnCategoryChangeFromInternal(product, changedField, PRODUCT_ID);
    verify(productBusinessPartnerService).getProductSkusByProductCode(PRODUCT_CODE);

  }

  @Test
  public void takeActionsOnCategoryChangeFromInternal_whenCategoryNotChanged() throws Exception {
    ReflectionTestUtils.setField(productServiceBean,
      "bopisCategoryActionOnVendorCategoryChangeSwitch", true);
    Product product = new Product();
    product.setProductCode(PRODUCT_CODE);

    Set<String> changedField = Set.of(PRODUCT_NAME);
    productServiceBean.takeActionsOnCategoryChangeFromInternal(product, changedField, PRODUCT_ID);
    Mockito.verifyNoInteractions(xProductOutbound);
    Mockito.verifyNoInteractions(productBusinessPartnerService);
  }

  @Test
  public void takeActionsOnCategoryChangeFromInternal_whenCategoryChangedButNotEligibleForShippingMigration()
    throws Exception {
    ReflectionTestUtils.setField(productServiceBean,
      "bopisCategoryActionOnVendorCategoryChangeSwitch", true);
    Product product = new Product();
    product.setProductCode(PRODUCT_CODE);

    ProductCategory category = new ProductCategory();
    category.setCategory(new Category());
    category.getCategory().setBopisEligible(true); // Eligible for BOPIS
    product.setProductCategories(List.of(category));

    Set<String> changedField = Set.of(ProductChangeUtil.CATEGORY);

    productServiceBean.takeActionsOnCategoryChangeFromInternal(product, changedField, PRODUCT_ID);
    Mockito.verifyNoInteractions(xProductOutbound);
    Mockito.verifyNoInteractions(productBusinessPartnerService);
  }

  @Test
  public void getDistinctBusinessPartnerCodesForNeedRevisionProductStoreIdNullTest() throws Exception {
    assertThrows(ApplicationRuntimeException.class, () -> {
      productServiceBean.getDistinctBusinessPartnerCodesForNeedRevisionProduct(null ,null, pageable);
    });
  }

  @Test
  public void getDistinctBusinessPartnerCodesForNeedRevisionProductRequestNullTest() throws Exception {
    assertThrows(ApplicationRuntimeException.class, () -> {
      productServiceBean.getDistinctBusinessPartnerCodesForNeedRevisionProduct(STORE_ID ,null, pageable);
    });
  }

  @Test
  public void getDistinctBusinessPartnerCodesForNeedRevisionProductStateNullTest() throws Exception {
    assertThrows(ApplicationRuntimeException.class, () -> {
      productServiceBean.getDistinctBusinessPartnerCodesForNeedRevisionProduct(STORE_ID,
          new NeedRevisionProductsRequest(), pageable);
    });
  }

  @Test
  public void getDistinctBusinessPartnerCodesForNeedRevisionProductStartDateNullTest() throws Exception {
    NeedRevisionProductsRequest needRevisionProductsRequest = new NeedRevisionProductsRequest();
    needRevisionProductsRequest.setState(STATE);
    assertThrows(ApplicationRuntimeException.class, () -> {
      productServiceBean.getDistinctBusinessPartnerCodesForNeedRevisionProduct(STORE_ID,
          needRevisionProductsRequest, pageable);
    });
  }

  @Test
  public void getDistinctBusinessPartnerCodesForNeedRevisionProductEndDateNullTest() throws Exception {
    NeedRevisionProductsRequest needRevisionProductsRequest = new NeedRevisionProductsRequest();
    needRevisionProductsRequest.setState(STATE);
    needRevisionProductsRequest.setStartUpdatedDate(new Date());
    assertThrows(ApplicationRuntimeException.class, () -> {
      productServiceBean.getDistinctBusinessPartnerCodesForNeedRevisionProduct(STORE_ID,
          needRevisionProductsRequest, pageable);
    });
  }

  @Test
  public void getDistinctBusinessPartnerCodesForNeedRevisionProductTest() {
    NeedRevisionProductsRequest needRevisionProductsRequest = new NeedRevisionProductsRequest();
    needRevisionProductsRequest.setState(STATE);
    needRevisionProductsRequest.setStartUpdatedDate(new Date());
    needRevisionProductsRequest.setEndUpdatedDate(new Date());
    productServiceBean.getDistinctBusinessPartnerCodesForNeedRevisionProduct(STORE_ID, needRevisionProductsRequest, pageable);
    verify(productBusinessPartnerRepository).findDistinctBusinessPartnerCodesByStateAndUpdatedStepDate(anyString(),
        anyString(), any(), any(), any());
  }


  @Test
  public void testFetchProductsByBusinessPartnerCodeForLastXDays_Success() {
    String storeId = "store-123";
    String businessPartnerCode = "partner-789";
    int fetchNRProductsFromLastXDays = 7;
    ReflectionTestUtils.setField(productServiceBean,"fetchNRProductsFromLastXDays",7);
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.DAY_OF_YEAR, -fetchNRProductsFromLastXDays);
    Page<ProductCodeAndNameDetails> mockResponse = new PageImpl<>(
        Arrays.asList(new ProductCodeAndNameDetails(PRODUCT_CODE, "Product 1"),
            new ProductCodeAndNameDetails("code2", "Product 2")));
    Mockito.when(
        productCollectionRepository.findNeedRevisionProductsDetailsByBusinessPartnerCodeUpdatedDate(Mockito.anyString(),
            Mockito.any(), Mockito.any())).thenReturn(mockResponse);
    Page<ProductCodeAndNameDetails> result =
        productServiceBean.fetchProductsByBusinessPartnerCodeForLastXDays(storeId, businessPartnerCode, pageable);
    Assertions.assertNotNull(result);
    Mockito.verify(productCollectionRepository, times(1))
        .findNeedRevisionProductsDetailsByBusinessPartnerCodeUpdatedDate(Mockito.any(), Mockito.any(), Mockito.any());
  }

  @Test
  public void processImageQcResponseSkipForBrandModelTest() throws JsonProcessingException {
    BrandRestrictedModelsResponse brandRestrictedModelsResponse = new BrandRestrictedModelsResponse();
    brandRestrictedModelsResponse.setPredictionType(PREDICTION_NAME_4);
    imageQcResponseDomainEvent.setBrandModels(Collections.singletonList(brandRestrictedModelsResponse));
    CompanyDTO companyDTO = new CompanyDTO();
    companyDTO.setMerchantType(Constants.TD_MERCHANT);
    profileResponse.setCompany(companyDTO);
    ReflectionTestUtils.setField(productServiceBean, "merchantTypeToSkipBrandModelCheck",
      Constants.TD_MERCHANT);
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);
    AutoNeedRevisionAndForceReviewResponse response =
      productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
        productCollection, productDetailResponse, false, profileResponse);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void shouldPopulateAttributeWhenProductInProgressTest() {
    productBusinessPartner.setState("IN_PROGRESS");
    when(productBusinessPartnerService.findByProductCode("PROD123")).thenReturn(List.of(productBusinessPartner));
    productServiceBean.populateProductBusinessPartnerAttribute("PROD123", "ATTR_CODE", "ATTR_ID", "VALUE", false, "name");
    verify(productBusinessPartnerRepository, times(1)).save(productBusinessPartner);
    verify(productBusinessPartnerService).findByProductCode(any());
  }

  @Test
  public void shouldPopulateAttributeWhenProductNeedsCorrectionTest() {
    productBusinessPartner.setState("NEED_CORRECTION");
    when(productBusinessPartnerService.findByProductCode("PROD123")).thenReturn(List.of(productBusinessPartner));
    productServiceBean.populateProductBusinessPartnerAttribute("PROD123", "ATTR_CODE", "ATTR_ID", "VALUE", false, "name");
    verify(productBusinessPartnerRepository, times(1)).save(productBusinessPartner);
    verify(productBusinessPartnerService).findByProductCode(any());
  }

  @Test
  public void shouldPopulateAttributeWhenProductNeedsCorrectionDuplicateAttributeTest() {
    ProductBusinessPartnerAttribute productBusinessPartnerAttribute = new ProductBusinessPartnerAttribute();
    productBusinessPartnerAttribute.setAttributeId("ATTR_ID");
    productBusinessPartner.getProductBusinessPartnerAttributes().add(productBusinessPartnerAttribute);
    productBusinessPartner.setState("NEED_CORRECTION");
    when(productBusinessPartnerService.findByProductCode("PROD123")).thenReturn(List.of(productBusinessPartner));
    productServiceBean.populateProductBusinessPartnerAttribute("PROD123", "ATTR_CODE", "ATTR_ID", "VALUE", false, "name");
    verify(productBusinessPartnerService).findByProductCode(any());
  }


  @Test
  public void testPopulateProductBusinessPartnerAttribute_ProductNotFound() {
    when(productBusinessPartnerService.findByProductCode(anyString()))
      .thenReturn(Collections.emptyList());

    Exception exception = assertThrows(ApplicationRuntimeException.class, () -> {
      productServiceBean.populateProductBusinessPartnerAttribute(PRODUCT_CODE, ATTR_CODE,
        ProductServiceBeanTest.ATTR_ID,
        ATTR_VALUE, false,
        ATTR_NAME);
    });
    assertTrue(exception.getMessage().contains(ErrorMessages.PRODUCT_NOT_FOUND));
    verify(productBusinessPartnerService).findByProductCode(PRODUCT_CODE);

  }

  @Test
  public void testPopulateProductBusinessPartnerAttribute_ValidScenario() {
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    XProdAttributeMigrationEventModel expectedEvent =
      XProdAttributeMigrationEventModel.builder().attributeCode(ATTR_CODE)
        .attributeName(ATTR_NAME).attributeValue(ATTR_VALUE).productSku(PRODUCT_SKU)
        .productCode(PRODUCT_CODE).build();
    when(productBusinessPartnerService.findByProductCode(anyString())).thenReturn(
      Collections.singletonList(productBusinessPartner));
    when(xProductOutbound.getBasicProductInfoV2(anyString())).thenReturn(new BasicProductResponse());
    when(kafkaTopicProperties.getXProductAttributeMigrationEvent()).thenReturn(TOPIC);

    productServiceBean.populateProductBusinessPartnerAttribute(PRODUCT_CODE, ATTR_CODE,
      ProductServiceBeanTest.ATTR_ID,
      ATTR_VALUE, false, ATTR_NAME);
    ArgumentCaptor<XProdAttributeMigrationEventModel> eventCaptor =
      ArgumentCaptor.forClass(XProdAttributeMigrationEventModel.class);
    verify(kafkaProducer, times(1)).send(eq(TOPIC), eventCaptor.capture());
    assertEquals(expectedEvent, eventCaptor.getValue());
    verify(kafkaTopicProperties).getXProductAttributeMigrationEvent();
    verify(productBusinessPartnerService).findByProductCode(PRODUCT_CODE);
  }

  @Test
  public void testPopulateProductBusinessPartnerAttribute_SkuValidationFails() throws Exception {
    ProductBusinessPartner productBusinessPartner = new ProductBusinessPartner();
    productBusinessPartner.setGdnProductSku(PRODUCT_SKU);
    when(productBusinessPartnerService.findByProductCode(anyString())).thenReturn(
      Collections.singletonList(productBusinessPartner));
    when(xProductOutbound.getBasicProductInfo(anyString())).thenReturn(null);

    productServiceBean.populateProductBusinessPartnerAttribute(PRODUCT_CODE, ATTR_CODE,
      ProductServiceBeanTest.ATTR_ID,
      ATTR_VALUE, false, ATTR_NAME);
    verify(productBusinessPartnerService).findByProductCode(PRODUCT_CODE);
    verify(productBusinessPartnerRepository).save(productBusinessPartner);
  }

  @Test
  public void testPopulateProductBusinessPartnerAttribute_PartialSuccess() throws Exception {
    ProductBusinessPartner productBusinessPartner1 = new ProductBusinessPartner();
    productBusinessPartner1.setGdnProductSku(PRODUCT_ID);

    ProductBusinessPartner productBusinessPartner2 = new ProductBusinessPartner();
    productBusinessPartner2.setGdnProductSku(PRODUCT_SKU);

    XProdAttributeMigrationEventModel expectedEvent =
      XProdAttributeMigrationEventModel.builder().attributeCode(ATTR_CODE)
        .attributeName(ATTR_NAME).attributeValue(ATTR_VALUE).productSku(PRODUCT_SKU)
        .productCode(PRODUCT_CODE).build();

    when(productBusinessPartnerService.findByProductCode(PRODUCT_CODE)).thenReturn(
      Arrays.asList(productBusinessPartner1, productBusinessPartner2));
    when(xProductOutbound.getBasicProductInfoV2(PRODUCT_SKU)).thenReturn(new BasicProductResponse());
    when(xProductOutbound.getBasicProductInfoV2(PRODUCT_ID)).thenReturn(null);
    when(kafkaTopicProperties.getXProductAttributeMigrationEvent()).thenReturn(TOPIC);

    productServiceBean.populateProductBusinessPartnerAttribute(PRODUCT_CODE, ATTR_CODE, ATTR_ID,
      ATTR_VALUE, false, ATTR_NAME);
    ArgumentCaptor<XProdAttributeMigrationEventModel> eventCaptor =
      ArgumentCaptor.forClass(XProdAttributeMigrationEventModel.class);
    verify(kafkaProducer, times(1)).send(eq(TOPIC), eventCaptor.capture());
    assertEquals(expectedEvent, eventCaptor.getValue());
    verify(productBusinessPartnerRepository, times(1)).save(productBusinessPartner2);
    verify(productBusinessPartnerService).findByProductCode(PRODUCT_CODE);
    verify(kafkaTopicProperties).getXProductAttributeMigrationEvent();
    verifyNoMoreInteractions(kafkaProducer);
  }

  @Test
  public void updateStatusInPCBForBackFillAttributes_ShouldCallFeignClient_WhenSuccess() {
    String productCode = "P12345";
    String updatedStatus = "COMPLETED";
    String errorMessage = null;
    GdnBaseRestResponse baseRestResponse = new GdnBaseRestResponse();
    baseRestResponse.setSuccess(true);
    when(mandatoryParameterHelper.getStoreId()).thenReturn("store-001");
    when(mandatoryParameterHelper.getRequestId()).thenReturn("req-123");
    when(pcbFeign.updateProductMigrationStatus(anyString(), anyString(), any()))
        .thenReturn(baseRestResponse);
    productServiceBean.updateStatusInPCBForBackFillAttributes(productCode, updatedStatus, errorMessage);
    verify(pcbFeign).updateProductMigrationStatus(anyString(), anyString(), any());
  }

  @Test
  public void updateStatusInPCBForBackFillAttributes_ShouldLogError_WhenFeignCallFails() {
    String productCode = "P67890";
    String updatedStatus = "FAILED";
    String errorMessage = "Some error";
    GdnBaseRestResponse baseRestResponse = new GdnBaseRestResponse();
    baseRestResponse.setSuccess(false);
    when(mandatoryParameterHelper.getStoreId()).thenReturn("store-002");
    when(mandatoryParameterHelper.getRequestId()).thenReturn("req-456");
    when(pcbFeign.updateProductMigrationStatus(anyString(), anyString(), any()))
        .thenReturn(baseRestResponse);
    productServiceBean.updateStatusInPCBForBackFillAttributes(productCode, updatedStatus, errorMessage);
    verify(pcbFeign).updateProductMigrationStatus(anyString(), anyString(), any());
  }

  @Test
  public void testProcessImageQcResponseWithKeywordResetOnMultipleDestinationCategoriesEnabled() throws Exception {
    // Setup test configuration
    ReflectionTestUtils.setField(getProductServiceBean(), "enableKeywordsActionInImageQcRequest", true);
    ReflectionTestUtils.setField(getProductServiceBean(), "keywordResetOnMultipleDestinationCategoriesEnabled", true);

    // Setup image QC predictions
    productImagePredictionNsfw.setForceReview(true);
    productImagePredictionNsfw.setConfidenceThreshold(90);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
      .thenReturn(productImagePredictionWaterMark);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2))
      .thenReturn(productImagePredictionNsfw);

    // Setup keyword recommendations with multiple keywords
    KeywordRecommendationsResponse keywordRec1 = new KeywordRecommendationsResponse();
    keywordRec1.setKeywordId(KEYWORD_ID);
    keywordRec1.setRecommendation("VALID_DETECTION");

    KeywordRecommendationsResponse keywordRec2 = new KeywordRecommendationsResponse();
    keywordRec2.setKeywordId(KEYWORD_ID);
    keywordRec2.setRecommendation("VALID_DETECTION");

    keywordRestrictionModelsResponse.setKeywordRecommendations(Arrays.asList(keywordRec1, keywordRec2));
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));

    // Setup category restricted keyword responses with different destination categories
    CategoryRestrictedKeywordResponse response1 = new CategoryRestrictedKeywordResponse();
    response1.setKeyword(RESTRICTED_KEYWORD);
    response1.setValidateByDs(true);
    response1.setRestrictedKeywordId(KEYWORD_ID);
    response1.setId(RESTRICTED_KEYWORD_ID + "1");
    response1.setAction(RestrictedKeywordActionType.CHANGE_CATEGORY_AND_AUTO_APPROVE.getRestrictedKeywordActionType());
    response1.setDestinationCategory(CATEGORY_CODE);

    CategoryRestrictedKeywordResponse response2 = new CategoryRestrictedKeywordResponse();
    response2.setKeyword(RESTRICTED_KEYWORD);
    response2.setValidateByDs(true);
    response2.setRestrictedKeywordId(KEYWORD_ID);
    response2.setId(RESTRICTED_KEYWORD_ID + "2");
    response2.setAction(RestrictedKeywordActionType.CHANGE_CATEGORY_AND_AUTO_APPROVE.getRestrictedKeywordActionType());
    response2.setDestinationCategory(CATEGORY_NAME);

    when(getProductRepository().getCategoryRestrictedKeywordDetailList(
      productCollection.getCategoryCode(), Arrays.asList(RESTRICTED_KEYWORD)))
      .thenReturn(Arrays.asList(response1, response2));

    // Execute the method
    AutoNeedRevisionAndForceReviewResponse response =
      productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap,
        productCollection, productDetailResponse, false, null);

    // Verify results
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_2);
    verify(productImageQcProcessingResponseService).save(productImageQcProcessingResponseArgumentCaptor.capture());
    verify(productSystemParameterService)
      .findByStoreIdAndVariable(STORE_ID, SystemParameterConstants.PRODUCT_IMAGE_QC_ENABLED);
    verify(productAnalyticsOutbound).getSellerDetail(productCollection.getBusinessPartnerCode());
    verify(getProductRepository()).getCategoryRestrictedKeywordDetailList(DEFAULT_CATEGORY,
      Collections.singletonList(KEYWORD_ID));
    ProductImageQcProcessingResponse captorValue = productImageQcProcessingResponseArgumentCaptor.getValue();
    Assertions.assertEquals(DEFAULT_PRODUCT_CODE, captorValue.getProductCode());
    Assertions.assertEquals(0, captorValue.getProductPredictionScore());
    Assertions.assertEquals(StringUtils.EMPTY, captorValue.getImageViolations());
    Assertions.assertFalse(captorValue.isForceReview());
    Assertions.assertFalse(response.isForceReview());
    Assertions.assertEquals(mapper.writeValueAsString(imageQcResponseDomainEvent), captorValue.getImageQcResponse());
  }

  @Test
  public void findAutoApprovalTypeByRequestNoTakeDownTest() throws Exception {
    ReflectionTestUtils.setField(productServiceBean, "overrideRestrictedKeywordsFlagByDsResponse", true);
    keywordRestrictionModelsResponse.getKeywordRecommendations().get(0).setRecommendation(INVALID_DETECTION);
    imageQcResponseDomainEvent.setKeywordRestrictionModels(Collections.singletonList(keywordRestrictionModelsResponse));
    productDetailResponse.getImages().get(0).setEdited(false);
    profileResponse.setTrustedSeller(false);
    when(this.productOutbound.getProductDetailByProductCode(PRODUCT_CODE, false, true)).thenReturn(
      productDetailResponse);
    productImageQcProcessingResponse.setForceReview(true);
    productImageQcProcessingResponse.setPredictedBrand(StringUtils.EMPTY);
    productImageQcProcessingResponse.setTextViolations(StringUtils.EMPTY);
    when(productImageQcProcessingResponseService.findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE)).thenReturn(
      productImageQcProcessingResponse);
    when(this.objectMapper.readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class))).thenReturn(
      imageQcResponseDomainEvent);
    when(this.categoryRepository.findHierarchyByCategoryCode(productCollection.getCategoryCode())).thenReturn(
      Arrays.asList(categoryResponse));
    when(this.autoApprovalService.verifyAutoApprovalRules(autoApprovalsDetailDtoArgumentCaptor.capture())).thenReturn(
      AutoApprovalType.CONTENT_AND_IMAGE);
    productCollection.setRestrictedKeywordsPresent(true);
    AutoApprovalType response =
      productServiceBean.findAutoApprovalTypeByRequest(STORE_ID, DEFAULT_USERNAME, PRODUCT_CODE,
        autoApprovalTypeRequest, profileResponse, productCollection);
    Mockito.verify(productImageQcProcessingResponseService).findByStoreIdAndProductCode(STORE_ID, PRODUCT_CODE);
    verify(this.objectMapper).readValue(Mockito.anyString(), eq(ImageQcResponseDomainEvent.class));
    verify(this.categoryRepository).findHierarchyByCategoryCode(productCollection.getCategoryCode());
    verify(this.autoApprovalService).verifyAutoApprovalRules(Mockito.any(AutoApprovalsDetailDto.class));
    verify(this.productOutbound).getProductDetailByProductCode(PRODUCT_CODE, false, true);
    verify(productImagePredictionService).findByStoreIdAndMarkForDeleteFalse(STORE_ID);
    Assertions.assertEquals(AutoApprovalType.CONTENT_AND_IMAGE, response);
    Assertions.assertFalse(productCollection.isRestrictedKeywordsPresent());
    Assertions.assertFalse(autoApprovalsDetailDtoArgumentCaptor.getValue().isRestrictedKeywordPresent());
  }

  @Test
  public void verifyAutoApprovalRulesTest() throws Exception {
    AutoApprovalType autoApprovalType = productServiceBean.verifyAutoApprovalRules(new AutoApprovalsDetailDto());
    Mockito.verify(autoApprovalService).verifyAutoApprovalRules(new AutoApprovalsDetailDto());
    Assertions.assertTrue(Objects.isNull(autoApprovalType));
  }

//  @Test
//  public void testCheckActiveOrderDataToSkipRestrictedKeywordAction_NoActiveOrder() {
//    ProductMasterDataEditRequest productMasterDataEditRequest = new ProductMasterDataEditRequest();
//    productMasterDataEditRequest.setProductCode(PRODUCT_CODE);
//    productMasterDataEditRequest.setProductSku(PRODUCT_SKU);
//
//    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
//    restrictedKeywordsByFieldAndActionType.setAction(RestrictedKeywordActionType.AUTO_NEED_REVISION.getRestrictedKeywordActionType());
//
//    AgpSimpleQueryResponse agpSimpleQueryResponse = new AgpSimpleQueryResponse();
//    agpSimpleQueryResponse.setHits(new HitsResponse());
//    agpSimpleQueryResponse.getHits().setTotal(0L);
//
//    when(agpQueryFeign.findNumberOfOrderByProductSkuList(anyString(), anyString())).thenReturn(agpSimpleQueryResponse);
//
//    productServiceBean.checkActiveOrderDataToSkipRestrictedKeywordAction(productMasterDataEditRequest, restrictedKeywordsByFieldAndActionType);
//
//    assertEquals(RestrictedKeywordActionType.NEED_CORRECTION.getCode(), restrictedKeywordsByFieldAndActionType.getActionType());
//    verify(agpQueryFeign, times(1)).getOrdersByProductCode(PRODUCT_CODE, PRODUCT_SKU);
//  }

  @Test
  public void testCheckActiveOrderDataToSkipRestrictedKeywordAction_ActiveOrderExists() {
    ProductMasterDataEditRequest productMasterDataEditRequest = new ProductMasterDataEditRequest();
    productMasterDataEditRequest.setProductCode(PRODUCT_CODE);
    productMasterDataEditRequest.setProductSku(PRODUCT_SKU);

    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(RestrictedKeywordActionType.AUTO_NEED_REVISION.getRestrictedKeywordActionType());

    AgpSimpleQueryResponse agpSimpleQueryResponse = new AgpSimpleQueryResponse();
    HitsResponse hitsResponse = new HitsResponse();
    hitsResponse.setTotal(1);
    agpSimpleQueryResponse.setHits(hitsResponse);

    when(agpQueryFeign.findNumberOfOrder(PRODUCT_SKU, "0", "0", Constants.AGP_ITEM_STATUS)).thenReturn(agpSimpleQueryResponse);

    productServiceBean.checkActiveOrderDataToSkipRestrictedKeywordAction(productMasterDataEditRequest, restrictedKeywordsByFieldAndActionType);
    verify(agpQueryFeign, times(1)).findNumberOfOrder(PRODUCT_SKU, "0", "0",
      Constants.AGP_ITEM_STATUS);
    verify(kafkaProducer).send(eq(DomainEventName.PRODUCT_INTERNAL_HISTORY_SAVE),
      eq(PRODUCT_CODE), any());
  }

  @Test
  public void testCheckActiveOrderDataToSkipRestrictedKeywordAction_NullResponse() {
    ProductMasterDataEditRequest productMasterDataEditRequest = new ProductMasterDataEditRequest();
    productMasterDataEditRequest.setProductCode(PRODUCT_CODE);
    productMasterDataEditRequest.setProductSku(PRODUCT_SKU);

    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(RestrictedKeywordActionType.AUTO_NEED_REVISION.getRestrictedKeywordActionType());

    AgpSimpleQueryResponse agpSimpleQueryResponse = new AgpSimpleQueryResponse();
    HitsResponse hitsResponse = new HitsResponse();
    hitsResponse.setTotal(1);
    agpSimpleQueryResponse.setHits(hitsResponse);

    when(agpQueryFeign.findNumberOfOrder(PRODUCT_SKU, "0", "0", Constants.AGP_ITEM_STATUS)).thenReturn(null);

    productServiceBean.checkActiveOrderDataToSkipRestrictedKeywordAction(productMasterDataEditRequest, restrictedKeywordsByFieldAndActionType);
    verify(agpQueryFeign, times(1)).findNumberOfOrder(PRODUCT_SKU, "0", "0",
      Constants.AGP_ITEM_STATUS);
  }

  @Test
  public void testCheckActiveOrderDataToSkipRestrictedKeywordAction_ActionTypeAlreadySkipAllActions() {
    ProductMasterDataEditRequest productMasterDataEditRequest = new ProductMasterDataEditRequest();
    productMasterDataEditRequest.setProductCode(PRODUCT_CODE);
    productMasterDataEditRequest.setProductSku(PRODUCT_SKU);

    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(RestrictedKeywordActionType.AUTO_REJECT.getRestrictedKeywordActionType());

    AgpSimpleQueryResponse agpSimpleQueryResponse = new AgpSimpleQueryResponse();
    HitsResponse hitsResponse = new HitsResponse();
    hitsResponse.setTotal(1);
    agpSimpleQueryResponse.setHits(hitsResponse);

    when(agpQueryFeign.findNumberOfOrder(PRODUCT_SKU, "0", "0", Constants.AGP_ITEM_STATUS)).thenReturn(agpSimpleQueryResponse);

    productServiceBean.checkActiveOrderDataToSkipRestrictedKeywordAction(productMasterDataEditRequest, restrictedKeywordsByFieldAndActionType);

    verify(agpQueryFeign, times(1)).findNumberOfOrder(PRODUCT_SKU, "0", "0",
      Constants.AGP_ITEM_STATUS);
    verify(kafkaProducer).send(eq(DomainEventName.PRODUCT_INTERNAL_HISTORY_SAVE),
      eq(PRODUCT_CODE), any());
  }

  @Test
  public void testCheckActiveOrderDataToSkipRestrictedKeywordAction_ActionTypeTakedownProduct() {
    ProductMasterDataEditRequest productMasterDataEditRequest = new ProductMasterDataEditRequest();
    productMasterDataEditRequest.setProductCode(PRODUCT_CODE);
    productMasterDataEditRequest.setProductSku(PRODUCT_SKU);

    RestrictedKeywordsByFieldAndActionType restrictedKeywordsByFieldAndActionType = new RestrictedKeywordsByFieldAndActionType();
    restrictedKeywordsByFieldAndActionType.setAction(RestrictedKeywordActionType.CHANGE_CATEGORY_AND_AUTO_APPROVE.getRestrictedKeywordActionType());

    AgpSimpleQueryResponse agpSimpleQueryResponse = new AgpSimpleQueryResponse();
    HitsResponse hitsResponse = new HitsResponse();
    hitsResponse.setTotal(0);
    agpSimpleQueryResponse.setHits(hitsResponse);

    when(agpQueryFeign.findNumberOfOrder(PRODUCT_SKU, "0", "0", Constants.AGP_ITEM_STATUS)).thenReturn(agpSimpleQueryResponse);

    productServiceBean.checkActiveOrderDataToSkipRestrictedKeywordAction(productMasterDataEditRequest, restrictedKeywordsByFieldAndActionType);
    verify(agpQueryFeign, times(1)).findNumberOfOrder(PRODUCT_SKU, "0", "0",
      Constants.AGP_ITEM_STATUS);
  }

  // Test cases for performMasterDataUpdate method
  
  @Test
  public void testPerformMasterDataUpdate_WithEligibleChanges_ShouldUpdateSuccessfully() throws Exception {
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(
        L3InfoUpdateChangeType.SIZE_CHART_UPDATE,
        L3InfoUpdateChangeType.DESCRIPTION_UPDATE,
        L3InfoUpdateChangeType.DIMENSIONS_UPDATE
    ));
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse(Constants.POST_LIVE_REVIEW_TYPE))
    );
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    masterProductEditDTO.setSaveInternalHistory(true);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateDimensionsAtL3(request, true);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
    verify(productLevel3Service).publishInternalProductHistoryEvent(
        masterProductEditDTO.getProductCollection(), request.getUpdatedBy());
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
        request.getProductName(), masterProductEditDTO.getProductCollection(), 
        masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(anyString(), anyString(),
      anyString(), anyBoolean(), anyBoolean(), anyString());
  }

  @Test
  public void testPerformMasterDataUpdate_WithIneligibleChanges_ShouldSkipPCBUpdate() throws Exception {
    // Given
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.INSTORE_UPDATE));
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse(Constants.PRE_LIVE))
    );
    masterProductEditDTO.setSaveInternalHistory(false);
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    verify(productOutbound, Mockito.never()).updateProductMasterDataInPCB(anyString(), anyString(),
      anyString(), any(), any());
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
        request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), false, false,
        StringUtils.EMPTY);
    verify(productLevel3Service, Mockito.never()).publishInternalProductHistoryEvent(any(), any());
  }

  @Test
  public void testPerformMasterDataUpdate_WithCommonImageUpdate_ShouldSetImageRequests() throws Exception {
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.COMMON_IMAGE_UPDATE));

    List<ProductLevel3SummaryDetailsImageRequest> imageRequests = List.of(createProductL3CommonImageRequest());
    request.setProductLevel3SummaryDetailsImageRequests(imageRequests);
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse(Constants.POST_LIVE_REVIEW_TYPE))
    );
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    String storeId = DEFAULT_STORE_ID;
    String requestId = REQUEST_ID;
    String username = DEFAULT_USERNAME;
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, storeId, requestId, username);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
      request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), false, false,
        StringUtils.EMPTY);
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    verify(productOutbound).updateProductMasterDataInPCB(storeId, requestId, username, request, masterProductEditDTO);
  }

  @Test
  public void testPerformMasterDataUpdate_WithDimensionsUpdate_ShouldUpdateDimensions() throws Exception {
    // Given
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.DIMENSIONS_UPDATE));
    request.setLength(10.5);
    request.setWidth(5.0);
    request.setHeight(3.0);
    request.setWeight(2.5);
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse(Constants.PRE_LIVE_REVIEW_TYPE))
    );
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
      request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), false, false,
        StringUtils.EMPTY);
    verify(productLevel3Service).updateDimensionsAtL3(request, true);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
  }

  @Test
  public void testPerformMasterDataUpdate_WithYouTubeUrlUpdate_ShouldProcessSuccessfully() throws Exception {
    // Given
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.YOUTUBE_URL_UPDATE));
    request.setUrl("https://youtube.com/watch?v=test123");
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse(Constants.POST_LIVE_REVIEW_TYPE))
    );
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
      request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), false, false,
        StringUtils.EMPTY);
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
  }

  @Test
  public void testPerformMasterDataUpdate_WithVideoUpdate_ShouldProcessSuccessfully() throws Exception {
    // Given
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.VIDEO_UPDATE));
    
    VideoAddEditRequest videoRequest = new VideoAddEditRequest();
    videoRequest.setVideoUrl("https://example.com/video.mp4");
    request.setVideoAddEditRequest(videoRequest);
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse(Constants.PRE_LIVE_REVIEW_TYPE))
    );
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
      request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), false, false,
        StringUtils.EMPTY);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
  }

  @Test
  public void testPerformMasterDataUpdate_WithProductNameUpdate_ShouldProcessSuccessfully() throws Exception {
    // Given
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.PRODUCT_NAME_UPDATE));
    request.setProductName("Updated Product Name");
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse("Post-Live"))
    );
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      request.getProductName(), masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    verify(productBusinessPartnerService).updateProductMasterData(
      request.getProductSku(), request.getProductName(), request.getCategoryCode(),
      request.getCategoryName(), request.getSizeChartCode(), request.getUpdatedBy(), false,
        StringUtils.EMPTY);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
  }

  @Test
  public void testPerformMasterDataUpdate_WithMultipleChangeTypes_ShouldProcessAll() throws Exception {
    // Given
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(
        L3InfoUpdateChangeType.SIZE_CHART_UPDATE,
        L3InfoUpdateChangeType.DESCRIPTION_UPDATE,
        L3InfoUpdateChangeType.DIMENSIONS_UPDATE,
        L3InfoUpdateChangeType.COMMON_IMAGE_UPDATE,
        L3InfoUpdateChangeType.YOUTUBE_URL_UPDATE,
        L3InfoUpdateChangeType.VIDEO_UPDATE,
        L3InfoUpdateChangeType.PRODUCT_NAME_UPDATE
    ));
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse("Post-Live"))
    );
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    masterProductEditDTO.setSaveInternalHistory(true);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateDimensionsAtL3(request, true);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
    verify(productBusinessPartnerService).updateProductMasterData(
        request.getProductSku(), request.getProductName(), request.getCategoryCode(), 
        request.getCategoryName(), request.getSizeChartCode(), request.getUpdatedBy(), true,
        StringUtils.EMPTY);
    verify(productLevel3Service).publishInternalProductHistoryEvent(
        masterProductEditDTO.getProductCollection(), request.getUpdatedBy());
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
  }

  @Test
  public void testPerformMasterDataUpdate_WithPreLiveConfiguration_ShouldUpdateSizeChartOnly() throws Exception {
    // Given
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.SIZE_CHART_UPDATE));
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse(Constants.PRE_LIVE_REVIEW_TYPE))
    );
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
        request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), true, false,
        StringUtils.EMPTY);
    verify(productBusinessPartnerService, Mockito.never()).updateProductMasterData(anyString(),
      anyString(), anyString(), anyString(), anyString(), anyString(), Mockito.anyBoolean(),
        Mockito.eq(StringUtils.EMPTY));
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);

  }

  @Test
  public void testPerformMasterDataUpdate_WithContentChangedFlag_ShouldSetImageQcFlags() throws Exception {
    // Given
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.DESCRIPTION_UPDATE));
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setContentChanged(true);
    masterProductEditDTO.setTakenDownProduct(false);
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO,DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
    Assertions.assertTrue(masterProductEditDTO.isPublishImageQcForContentChange());
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
      request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), false, false,
        StringUtils.EMPTY);
  }

  @Test
  public void testPerformMasterDataUpdate_WithTakenDownProduct_ShouldNotPublishImageQc() throws Exception {
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.DESCRIPTION_UPDATE));
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setContentChanged(true);
    masterProductEditDTO.setTakenDownProduct(true);
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO,DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      request.getProductName(), masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
      request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), false, false,
        StringUtils.EMPTY);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
    Assertions.assertFalse(masterProductEditDTO.isPublishImageQcForContentChange());
  }

  @Test
  public void testPerformMasterDataUpdate_WithException_ShouldPropagateException() throws Exception {
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.DIMENSIONS_UPDATE));
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    
    doThrow(new RuntimeException("Test exception")).when(productLevel3Service)
        .updateDimensionsAtL3(any(), Mockito.anyBoolean());
    try {
      assertThrows(RuntimeException.class, () -> {
        productServiceBean.performMasterDataUpdate(request, masterProductEditDTO, DEFAULT_STORE_ID,
          REQUEST_ID, DEFAULT_USERNAME);
      });
    }
    catch (Exception e){
      Assertions.assertNotNull(e.getMessage());
    }
    verify(productLevel3Service).updateDimensionsAtL3(any(), anyBoolean());
  }


  @Test
  public void testPerformMasterDataUpdate_WithEmptyChangeTypes_ShouldSkipEligibleOperations() throws Exception {
    // Given
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of());
    
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
        List.of(createConfigurationStatusResponse(Constants.PRE_LIVE_REVIEW_TYPE))
    );
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
        request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    verify(productOutbound, Mockito.never()).updateProductMasterDataInPCB(anyString(), anyString(),
      anyString(), any(), any());
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      DEFAULT_PRODUCT_NAME, masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
        request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), false, false,
        StringUtils.EMPTY);
  }

  // Helper methods for creating test data

  private ProductMasterDataEditRequest createProductMasterDataEditRequest() {
    ProductMasterDataEditRequest productMasterDataEditRequest =
      ProductMasterDataEditRequest.builder().productCode(DEFAULT_PRODUCT_CODE)
        .productSku(DEFAULT_PRODUCT_SKU).businessPartnerCode(DEFAULT_BUSINESS_PARTNER_CODE)
        .productName(DEFAULT_PRODUCT_NAME).description("Test product description")
        .productType(ProductType.BIG_PRODUCT.getCode())
        .url("https://youtube.com/test").categoryCode(DEFAULT_CATEGORY_CODE)
        .categoryName(CATEGORY_NAME).sizeChartCode(SIZE_CHART_CODE).length(LENGTH).width(WIDTH)
        .height(HEIGHT).weight(WEIGHT).shippingWeight(SHIPPING_WEIGHT).productLevel3SummaryDetailsImageRequests(Collections.emptyList())
        .masterDataEditChangeTypes(EnumSet.noneOf(L3InfoUpdateChangeType.class)).build();
    productMasterDataEditRequest.setUpdatedBy(DEFAULT_USERNAME);
    return productMasterDataEditRequest;
  }

  private MasterProductEditDTO createMasterProductEditDTO() {
    ProductCollection productCollection = new ProductCollection();
    productCollection.setId(UUID.randomUUID().toString());
    productCollection.setProductCode(DEFAULT_PRODUCT_CODE);
    ConfigurationStatusResponse configurationStatusResponse =
      ConfigurationStatusResponse.builder().categoryCode(CATEGORY_CODE).reviewConfig(Constants.POST_LIVE_REVIEW_TYPE)
        .merchantCode(BUSINESS_PARTNER_CODE).build();
    return MasterProductEditDTO.builder()
        .productCollection(productCollection)
        .configurationStatusResponseList(Collections.singletonList(configurationStatusResponse))
        .reviewTypeList(new ArrayList<>())
        .restrictedKeywordsByFieldList(new ArrayList<>())
        .categoryResponses(new ArrayList<>())
        .vendorErrorFields(new HashSet<>())
        .productImageEditRequestList(new ArrayList<>())
        .contentChanged(false)
        .postLive(false)
        .saveInternalHistory(false)
        .autoApprovalEligible(false)
        .takenDownProduct(false)
        .publishImageQcForContentChange(false)
        .autoCategoryChange(false)
        .build();
  }

  private ConfigurationStatusResponse createConfigurationStatusResponse(String reviewConfig) {
    ConfigurationStatusResponse response = new ConfigurationStatusResponse();
    response.setReviewConfig(reviewConfig);
    return response;
  }

  private ProductLevel3SummaryDetailsImageRequest createProductL3CommonImageRequest() {
    ProductLevel3SummaryDetailsImageRequest request = new ProductLevel3SummaryDetailsImageRequest();
    request.setLocationPath(IMAGE_LOCATION_PATH_1);
    return request;
  }

  @Test
  public void testPerformMasterDataUpdate_WithTakenDownProduct_xProductUpdate() throws Exception {
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(L3InfoUpdateChangeType.DESCRIPTION_UPDATE));
    request.setProductType(1);
    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setContentChanged(true);
    masterProductEditDTO.setTakenDownProduct(false);
    masterProductEditDTO.setPostLive(true);
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
      request, masterProductEditDTO,DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    verify(productLevel3Service).updateDimensionsAtL3(request, false);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      request.getProductName(), masterProductEditDTO.getProductCollection(), masterProductEditDTO.getReviewTypeList(),
      masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(
      request.getProductSku(), request.getSizeChartCode(), request.getUpdatedBy(), false, false,
        StringUtils.EMPTY);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
    verify(xProductOutbound).updateProductMasterDataInfo(anyString(), any());
  }

  @Test
  public void testPerformMasterDataUpdate_WithEligibleChanges_ForReviewPendingProduct() throws Exception {
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(
      L3InfoUpdateChangeType.SIZE_CHART_UPDATE,
      L3InfoUpdateChangeType.DESCRIPTION_UPDATE,
      L3InfoUpdateChangeType.DIMENSIONS_UPDATE
    ));

    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
      List.of(createConfigurationStatusResponse(Constants.POST_LIVE_REVIEW_TYPE))
    );
    masterProductEditDTO.setAction(1);
    productCollection.setProductId(PRODUCT_ID);
    masterProductEditDTO.setProductCollection(productCollection);
    masterProductEditDTO.setContentType(EditedReviewTypeConstants.CONTENT_REFRESH);
    masterProductEditDTO.setSaveInternalHistory(true);
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
      .thenReturn(new ProductBusinessPartner());
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
      request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateDimensionsAtL3(request, true);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
    verify(productLevel3Service).publishInternalProductHistoryEvent(
      masterProductEditDTO.getProductCollection(), request.getUpdatedBy());
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      request.getProductName(), masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(anyString(), anyString(),
      anyString(), anyBoolean(), anyBoolean(), anyString());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    verify(kafkaProducer).send(any(), any(), any());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail("bp code");
  }

  @Test
  public void testPerformMasterDataUpdate_WithEligibleChanges_ForReviewPendingProductWithNoRepublish() throws Exception {
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(
      L3InfoUpdateChangeType.SIZE_CHART_UPDATE,
      L3InfoUpdateChangeType.DESCRIPTION_UPDATE,
      L3InfoUpdateChangeType.DIMENSIONS_UPDATE
    ));

    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
      List.of(createConfigurationStatusResponse(Constants.POST_LIVE_REVIEW_TYPE))
    );
    productCollection.setProductId(PRODUCT_ID);
    masterProductEditDTO.setAction(3);
    masterProductEditDTO.setProductCollection(productCollection);
    masterProductEditDTO.setContentType(EditedReviewTypeConstants.CONTENT_REFRESH);
    masterProductEditDTO.setSaveInternalHistory(true);
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
      .thenReturn(new ProductBusinessPartner());
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
      request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateDimensionsAtL3(request, true);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
    verify(productLevel3Service).publishInternalProductHistoryEvent(
      masterProductEditDTO.getProductCollection(), request.getUpdatedBy());
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      request.getProductName(), masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(anyString(), anyString(),
      anyString(), anyBoolean(), anyBoolean(), anyString());
  }

  @Test
  public void testPerformMasterDataUpdate_ForReviewPendingProduct() throws Exception {
    ProductMasterDataEditRequest request = createProductMasterDataEditRequest();
    request.setMasterDataEditChangeTypes(Set.of(
      L3InfoUpdateChangeType.SIZE_CHART_UPDATE,
      L3InfoUpdateChangeType.DESCRIPTION_UPDATE,
      L3InfoUpdateChangeType.DIMENSIONS_UPDATE
    ));

    MasterProductEditDTO masterProductEditDTO = createMasterProductEditDTO();
    masterProductEditDTO.setConfigurationStatusResponseList(
      List.of(createConfigurationStatusResponse(Constants.POST_LIVE_REVIEW_TYPE))
    );
    masterProductEditDTO.setAction(1);
    productCollection.setProductId(PRODUCT_ID);
    productCollection.setReviewPending(true);
    masterProductEditDTO.setProductCollection(productCollection);
    masterProductEditDTO.setContentType(EditedReviewTypeConstants.CONTENT_REFRESH);
    masterProductEditDTO.setSaveInternalHistory(true);
    GdnRestSingleResponse<ProductL3Response> xproductResponse = new GdnRestSingleResponse<>();
    xproductResponse.setValue(new ProductL3Response());
    Mockito.when(xProductOutbound.getProductDetailsByProductSku(DEFAULT_PRODUCT_SKU)).thenReturn(xproductResponse);
    Mockito.when(productBusinessPartnerService.findFirstByStoreIdAndProductId(any(), any()))
      .thenReturn(new ProductBusinessPartner());
    ApiErrorCode result = productServiceBean.performMasterDataUpdate(
      request, masterProductEditDTO, DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME);
    Assertions.assertNull(result);
    verify(productLevel3Service).updateDimensionsAtL3(request, true);
    verify(productOutbound).updateProductMasterDataInPCB(DEFAULT_STORE_ID, REQUEST_ID, DEFAULT_USERNAME, request, masterProductEditDTO);
    verify(productLevel3Service).publishInternalProductHistoryEvent(
      masterProductEditDTO.getProductCollection(), request.getUpdatedBy());
    verify(productLevel3Service).updateProductCollectionAndSolrAndPublishHistoryEvent(
      request.getProductName(), masterProductEditDTO.getProductCollection(),
      masterProductEditDTO.getReviewTypeList(), masterProductEditDTO, StringUtils.EMPTY);
    verify(productBusinessPartnerService).updateSizeChartDetailsAndBrandDetails(anyString(), anyString(),
      anyString(), anyBoolean(), anyBoolean(), anyString());
    Mockito.verify(kafkaTopicProperties).getVendorCombinedEventNoPriority();
    Mockito.verify(productBusinessPartnerService).findFirstByStoreIdAndProductId(any(), any());
    verify(kafkaProducer).send(any(), any(), any());
    Mockito.verify(productAnalyticsOutbound).getSellerDetail("bp code");
  }

  // ===============================
  // Tests for getProductsByBrandName method
  // ===============================

  @Test
  public void getProductsByBrandName_Success_WithProducts() throws Exception {
    // Given
    String storeId = "TEST_STORE";
    String brandName = "TestBrand";
    PageRequest pageable = PageRequest.of(0, 10);
    
    // Create ProductCodeResponse data
    ProductCodeResponse productCodeResponse1 = new ProductCodeResponse();
    productCodeResponse1.setId("PRODUCT_ID_1");
    productCodeResponse1.setProductCode("PRODUCT_CODE_1");
    
    ProductCodeResponse productCodeResponse2 = new ProductCodeResponse();
    productCodeResponse2.setId("PRODUCT_ID_2");
    productCodeResponse2.setProductCode("PRODUCT_CODE_2");
    
    List<ProductCodeResponse> productCodeResponseList = Arrays.asList(productCodeResponse1, productCodeResponse2);
    Page<ProductCodeResponse> pcbResponsePage = new PageImpl<>(productCodeResponseList, pageable, 2);
    
    // Create ProductBusinessPartner data
    ProductBusinessPartner pbp1 = new ProductBusinessPartner();
    pbp1.setBusinessPartnerId("BP_001");
    
    ProductBusinessPartner pbp2 = new ProductBusinessPartner();
    pbp2.setBusinessPartnerId("BP_002");
    
    List<ProductBusinessPartner> businessPartners1 = Arrays.asList(pbp1);
    List<ProductBusinessPartner> businessPartners2 = Arrays.asList(pbp2);
    
    // Mock repository calls
    when(productRepository.getProductsByBrandName(brandName, pageable)).thenReturn(pcbResponsePage);
    when(productBusinessPartnerService.findByStoreIdAndProductId(storeId, "PRODUCT_ID_1"))
        .thenReturn(businessPartners1);
    when(productBusinessPartnerService.findByStoreIdAndProductId(storeId, "PRODUCT_ID_2"))
        .thenReturn(businessPartners2);
    
    // When
    Page<ProductAndBrandResponse> result = productServiceBean.getProductsByBrandName(storeId, brandName, pageable);
    
    // Then
    assertNotNull(result);
    assertEquals(2, result.getTotalElements());
    assertEquals(2, result.getContent().size());
    
    ProductAndBrandResponse response1 = result.getContent().get(0);
    assertEquals("PRODUCT_ID_1", response1.getProductId());
    assertEquals("PRODUCT_CODE_1", response1.getProductCode());
    assertEquals(brandName, response1.getBrandName());
    assertTrue(response1.getBusinessPartnerCodes().contains("BP_001"));
    
    ProductAndBrandResponse response2 = result.getContent().get(1);
    assertEquals("PRODUCT_ID_2", response2.getProductId());
    assertEquals("PRODUCT_CODE_2", response2.getProductCode());
    assertEquals(brandName, response2.getBrandName());
    assertTrue(response2.getBusinessPartnerCodes().contains("BP_002"));
    
    // Verify mock interactions
    verify(productRepository).getProductsByBrandName(brandName, pageable);
    verify(productBusinessPartnerService).findByStoreIdAndProductId(storeId, "PRODUCT_ID_1");
    verify(productBusinessPartnerService).findByStoreIdAndProductId(storeId, "PRODUCT_ID_2");
  }

  @Test
  public void getProductsByBrandName_Success_NoProducts() throws Exception {
    // Given
    String storeId = "TEST_STORE";
    String brandName = "NonExistentBrand";
    PageRequest pageable = PageRequest.of(0, 10);
    
    Page<ProductCodeResponse> emptyPcbResponsePage = new PageImpl<>(Collections.emptyList(), pageable, 0);
    
    // Mock repository call
    when(productRepository.getProductsByBrandName(brandName, pageable)).thenReturn(emptyPcbResponsePage);
    
    // When
    Page<ProductAndBrandResponse> result = productServiceBean.getProductsByBrandName(storeId, brandName, pageable);
    
    // Then
    assertNotNull(result);
    assertEquals(0, result.getTotalElements());
    assertTrue(result.getContent().isEmpty());
    
    // Verify mock interactions
    verify(productRepository).getProductsByBrandName(brandName, pageable);
    verifyNoMoreInteractions(productBusinessPartnerService); // Should not be called when no products
  }

  @Test
  public void getProductsByBrandName_Failure_RepositoryException() throws Exception {
    // Given
    String storeId = "TEST_STORE";
    String brandName = "TestBrand";
    PageRequest pageable = PageRequest.of(0, 10);
    
    // Mock repository to throw exception
    when(productRepository.getProductsByBrandName(brandName, pageable))
        .thenThrow(new RuntimeException("Database connection failed"));
    
    // When & Then
    RuntimeException exception = assertThrows(
        RuntimeException.class,
        () -> productServiceBean.getProductsByBrandName(storeId, brandName, pageable)
    );
    
    assertEquals("Database connection failed", exception.getMessage());
    
    // Verify mock interactions
    verify(productRepository).getProductsByBrandName(brandName, pageable);
    verifyNoMoreInteractions(productBusinessPartnerService); // Should not be called when exception occurs
  }

  @Test
  public void updateBrandDataTest_success() {
    productCollection.setBrandCode(DEFAULT_BRAND_CODE+"5");
    productCollection.setBrand(DEFAULT_BRAND_NAME+"5");
    when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID,
        PRODUCT_CODE)).thenReturn(productCollection);
    when(productCollectionRepository.save(productCollection)).thenReturn(productCollection);
    Pair<ProductCollection, String> response = productServiceBean.updateBrandData(STORE_ID,
        ProductBrandUpdateRequest.builder().productCode(PRODUCT_CODE)
            .newBrandCode(DEFAULT_BRAND_CODE).oldBrandName(DEFAULT_BRAND_NAME)
            .newBrandName(DEFAULT_BRAND_NAME + "5").build(), null);
    Assertions.assertEquals(response.getLeft().getBrandCode(), DEFAULT_BRAND_CODE);
    Assertions.assertEquals(response.getLeft().getBrand(), DEFAULT_BRAND_NAME+"5");
    verify(productCollectionRepository).findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID,
        PRODUCT_CODE);
    verify(productBusinessPartnerService).updateBrand(any(), anyString());
  }

  @Test
  public void updateBrandDataTest_successIsOnlyBrandNameUpdateTrue() {
    productCollection.setBrandCode(DEFAULT_BRAND_CODE+"5");
    productCollection.setBrand(DEFAULT_BRAND_NAME+"5");
    when(productCollectionRepository.findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID,
        PRODUCT_CODE)).thenReturn(productCollection);
    when(productCollectionRepository.save(productCollection)).thenReturn(productCollection);
    Pair<ProductCollection, String> response = productServiceBean.updateBrandData(STORE_ID,
        ProductBrandUpdateRequest.builder().productCode(PRODUCT_CODE)
            .oldBrandCode(DEFAULT_BRAND_CODE).oldBrandName(DEFAULT_BRAND_NAME + "5")
            .newBrandName(DEFAULT_BRAND_NAME).onlyBrandNameUpdate(true).build(), null);
    Assertions.assertEquals(response.getLeft().getBrandCode(), DEFAULT_BRAND_CODE+"5");
    Assertions.assertEquals(response.getLeft().getBrand(), DEFAULT_BRAND_NAME);
    verify(productCollectionRepository).findByStoreIdAndProductCodeAndMarkForDeleteFalse(STORE_ID,
        PRODUCT_CODE);
    verify(productBusinessPartnerService).updateBrand(null, DEFAULT_BRAND_NAME);
  }

  @Test
  public void processImageQcResponseTest_exception() throws JsonProcessingException {
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenThrow(new ApplicationRuntimeException());
    AutoNeedRevisionAndForceReviewResponse response = productServiceBean
        .processImageQcResponse(STORE_ID, imageQcResponseDomainEvent, imageCountMap, productCollection, productDetailResponse,
            true, null);
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
  }

  @Test
  public void processImageQcResponseTest_exceptionThrowExceptionOnImageQcFailureTrue() throws JsonProcessingException {
    ReflectionTestUtils.setField(productServiceBean,"throwExceptionOnImageQcFailure", true);
    when(productImagePredictionService.findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1))
        .thenThrow(new ApplicationRuntimeException());
    try {
      AutoNeedRevisionAndForceReviewResponse response =
          productServiceBean.processImageQcResponse(STORE_ID, imageQcResponseDomainEvent,
              imageCountMap, productCollection, productDetailResponse, true, null);
    } catch (Exception ex){
      Assertions.assertNotNull(ex);
    }
    verify(productImagePredictionService).findByStoreIdAndPredictionType(STORE_ID, PREDICTION_NAME_1);
  }

  @Test
  public void testMasterProductEditDTOBrandChanged() {
    // Given
    MasterProductEditDTO masterProductEditDTO = new MasterProductEditDTO();
    boolean brandChanged = true;

    // When
    masterProductEditDTO.setBrandChanged(brandChanged);

    // Then
    Assertions.assertTrue(masterProductEditDTO.isBrandChanged());
  }

  @Test
  public void testAddEditedProductToPDTEventBrandFields() {
    // Given
    AddEditedProductToPDTEvent event = new AddEditedProductToPDTEvent();
    String brand = "Test Brand";
    String brandCode = "BRAND001";

    // When
    event.setBrand(brand);
    event.setBrandCode(brandCode);

    // Then
    Assertions.assertEquals(brand, event.getBrand());
    Assertions.assertEquals(brandCode, event.getBrandCode());
  }
}
